<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- (c) The University of Glasgow, 1997-2006</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE BangPatterns, CPP, MagicHash, UnboxedTuples,
    GeneralizedNewtypeDeriving #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# OPTIONS_GHC -O -funbox-strict-fields #-}</span><span>
</span><a name="line-6"></a><span class="hs-comment">-- We always optimise this, otherwise performance of a non-optimised</span><span>
</span><a name="line-7"></a><span class="hs-comment">-- compiler is severely affected</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-10"></a><span class="hs-comment">-- There are two principal string types used internally by GHC:</span><span>
</span><a name="line-11"></a><span class="hs-comment">--</span><span>
</span><a name="line-12"></a><span class="hs-comment">-- ['FastString']</span><span>
</span><a name="line-13"></a><span class="hs-comment">--</span><span>
</span><a name="line-14"></a><span class="hs-comment">--   * A compact, hash-consed, representation of character strings.</span><span>
</span><a name="line-15"></a><span class="hs-comment">--   * Comparison is O(1), and you can get a 'Unique.Unique' from them.</span><span>
</span><a name="line-16"></a><span class="hs-comment">--   * Generated by 'fsLit'.</span><span>
</span><a name="line-17"></a><span class="hs-comment">--   * Turn into 'Outputable.SDoc' with 'Outputable.ftext'.</span><span>
</span><a name="line-18"></a><span class="hs-comment">--</span><span>
</span><a name="line-19"></a><span class="hs-comment">-- ['LitString']</span><span>
</span><a name="line-20"></a><span class="hs-comment">--</span><span>
</span><a name="line-21"></a><span class="hs-comment">--   * Just a wrapper for the @Addr#@ of a C string (@Ptr CChar@).</span><span>
</span><a name="line-22"></a><span class="hs-comment">--   * Practically no operations.</span><span>
</span><a name="line-23"></a><span class="hs-comment">--   * Outputing them is fast.</span><span>
</span><a name="line-24"></a><span class="hs-comment">--   * Generated by 'sLit'.</span><span>
</span><a name="line-25"></a><span class="hs-comment">--   * Turn into 'Outputable.SDoc' with 'Outputable.ptext'</span><span>
</span><a name="line-26"></a><span class="hs-comment">--   * Requires manual memory management.</span><span>
</span><a name="line-27"></a><span class="hs-comment">--     Improper use may lead to memory leaks or dangling pointers.</span><span>
</span><a name="line-28"></a><span class="hs-comment">--   * It assumes Latin-1 as the encoding, therefore it cannot represent</span><span>
</span><a name="line-29"></a><span class="hs-comment">--     arbitrary Unicode strings.</span><span>
</span><a name="line-30"></a><span class="hs-comment">--</span><span>
</span><a name="line-31"></a><span class="hs-comment">-- Use 'LitString' unless you want the facilities of 'FastString'.</span><span>
</span><a name="line-32"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">FastString</span><span>
</span><a name="line-33"></a><span>       </span><span class="hs-special">(</span><span>
</span><a name="line-34"></a><span>        </span><span class="hs-comment">-- * ByteString</span><span>
</span><a name="line-35"></a><span>        </span><a href="FastString.html#fastStringToByteString"><span class="hs-identifier hs-var">fastStringToByteString</span></a><span class="hs-special">,</span><span>
</span><a name="line-36"></a><span>        </span><a href="FastString.html#mkFastStringByteString"><span class="hs-identifier hs-var">mkFastStringByteString</span></a><span class="hs-special">,</span><span>
</span><a name="line-37"></a><span>        </span><a href="FastString.html#fastZStringToByteString"><span class="hs-identifier hs-var">fastZStringToByteString</span></a><span class="hs-special">,</span><span>
</span><a name="line-38"></a><span>        </span><a href="FastString.html#unsafeMkByteString"><span class="hs-identifier hs-var">unsafeMkByteString</span></a><span class="hs-special">,</span><span>
</span><a name="line-39"></a><span>        </span><a href="FastString.html#hashByteString"><span class="hs-identifier hs-var">hashByteString</span></a><span class="hs-special">,</span><span>
</span><a name="line-40"></a><span>
</span><a name="line-41"></a><span>        </span><span class="hs-comment">-- * FastZString</span><span>
</span><a name="line-42"></a><span>        </span><a href="FastString.html#FastZString"><span class="hs-identifier hs-type">FastZString</span></a><span class="hs-special">,</span><span>
</span><a name="line-43"></a><span>        </span><a href="FastString.html#hPutFZS"><span class="hs-identifier hs-var">hPutFZS</span></a><span class="hs-special">,</span><span>
</span><a name="line-44"></a><span>        </span><a href="FastString.html#zString"><span class="hs-identifier hs-var">zString</span></a><span class="hs-special">,</span><span>
</span><a name="line-45"></a><span>        </span><a href="FastString.html#lengthFZS"><span class="hs-identifier hs-var">lengthFZS</span></a><span class="hs-special">,</span><span>
</span><a name="line-46"></a><span>
</span><a name="line-47"></a><span>        </span><span class="hs-comment">-- * FastStrings</span><span>
</span><a name="line-48"></a><span>        </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>     </span><span class="hs-comment">-- not abstract, for now.</span><span>
</span><a name="line-49"></a><span>
</span><a name="line-50"></a><span>        </span><span class="hs-comment">-- ** Construction</span><span>
</span><a name="line-51"></a><span>        </span><a href="FastString.html#fsLit"><span class="hs-identifier hs-var">fsLit</span></a><span class="hs-special">,</span><span>
</span><a name="line-52"></a><span>        </span><a href="FastString.html#mkFastString"><span class="hs-identifier hs-var">mkFastString</span></a><span class="hs-special">,</span><span>
</span><a name="line-53"></a><span>        </span><a href="FastString.html#mkFastStringBytes"><span class="hs-identifier hs-var">mkFastStringBytes</span></a><span class="hs-special">,</span><span>
</span><a name="line-54"></a><span>        </span><a href="FastString.html#mkFastStringByteList"><span class="hs-identifier hs-var">mkFastStringByteList</span></a><span class="hs-special">,</span><span>
</span><a name="line-55"></a><span>        </span><a href="FastString.html#mkFastStringForeignPtr"><span class="hs-identifier hs-var">mkFastStringForeignPtr</span></a><span class="hs-special">,</span><span>
</span><a name="line-56"></a><span>        </span><a href="FastString.html#mkFastString%23"><span class="hs-identifier hs-var">mkFastString</span><span class="hs-operator hs-var">#</span></a><span class="hs-special">,</span><span>
</span><a name="line-57"></a><span>
</span><a name="line-58"></a><span>        </span><span class="hs-comment">-- ** Deconstruction</span><span>
</span><a name="line-59"></a><span>        </span><a href="FastString.html#unpackFS"><span class="hs-identifier hs-var">unpackFS</span></a><span class="hs-special">,</span><span>           </span><span class="hs-comment">-- :: FastString -&gt; String</span><span>
</span><a name="line-60"></a><span>        </span><a href="FastString.html#bytesFS"><span class="hs-identifier hs-var">bytesFS</span></a><span class="hs-special">,</span><span>            </span><span class="hs-comment">-- :: FastString -&gt; [Word8]</span><span>
</span><a name="line-61"></a><span>
</span><a name="line-62"></a><span>        </span><span class="hs-comment">-- ** Encoding</span><span>
</span><a name="line-63"></a><span>        </span><a href="FastString.html#zEncodeFS"><span class="hs-identifier hs-var">zEncodeFS</span></a><span class="hs-special">,</span><span>
</span><a name="line-64"></a><span>
</span><a name="line-65"></a><span>        </span><span class="hs-comment">-- ** Operations</span><span>
</span><a name="line-66"></a><span>        </span><a href="FastString.html#uniqueOfFS"><span class="hs-identifier hs-var">uniqueOfFS</span></a><span class="hs-special">,</span><span>
</span><a name="line-67"></a><span>        </span><a href="FastString.html#lengthFS"><span class="hs-identifier hs-var">lengthFS</span></a><span class="hs-special">,</span><span>
</span><a name="line-68"></a><span>        </span><a href="FastString.html#nullFS"><span class="hs-identifier hs-var">nullFS</span></a><span class="hs-special">,</span><span>
</span><a name="line-69"></a><span>        </span><a href="FastString.html#appendFS"><span class="hs-identifier hs-var">appendFS</span></a><span class="hs-special">,</span><span>
</span><a name="line-70"></a><span>        </span><a href="FastString.html#headFS"><span class="hs-identifier hs-var">headFS</span></a><span class="hs-special">,</span><span>
</span><a name="line-71"></a><span>        </span><a href="FastString.html#tailFS"><span class="hs-identifier hs-var">tailFS</span></a><span class="hs-special">,</span><span>
</span><a name="line-72"></a><span>        </span><a href="FastString.html#concatFS"><span class="hs-identifier hs-var">concatFS</span></a><span class="hs-special">,</span><span>
</span><a name="line-73"></a><span>        </span><a href="FastString.html#consFS"><span class="hs-identifier hs-var">consFS</span></a><span class="hs-special">,</span><span>
</span><a name="line-74"></a><span>        </span><a href="FastString.html#nilFS"><span class="hs-identifier hs-var">nilFS</span></a><span class="hs-special">,</span><span>
</span><a name="line-75"></a><span>
</span><a name="line-76"></a><span>        </span><span class="hs-comment">-- ** Outputing</span><span>
</span><a name="line-77"></a><span>        </span><a href="FastString.html#hPutFS"><span class="hs-identifier hs-var">hPutFS</span></a><span class="hs-special">,</span><span>
</span><a name="line-78"></a><span>
</span><a name="line-79"></a><span>        </span><span class="hs-comment">-- ** Internal</span><span>
</span><a name="line-80"></a><span>        </span><a href="FastString.html#getFastStringTable"><span class="hs-identifier hs-var">getFastStringTable</span></a><span class="hs-special">,</span><span>
</span><a name="line-81"></a><span>        </span><a href="FastString.html#hasZEncoding"><span class="hs-identifier hs-var">hasZEncoding</span></a><span class="hs-special">,</span><span>
</span><a name="line-82"></a><span>
</span><a name="line-83"></a><span>        </span><span class="hs-comment">-- * LitStrings</span><span>
</span><a name="line-84"></a><span>        </span><a href="FastString.html#LitString"><span class="hs-identifier hs-type">LitString</span></a><span class="hs-special">,</span><span>
</span><a name="line-85"></a><span>
</span><a name="line-86"></a><span>        </span><span class="hs-comment">-- ** Construction</span><span>
</span><a name="line-87"></a><span>        </span><a href="FastString.html#sLit"><span class="hs-identifier hs-var">sLit</span></a><span class="hs-special">,</span><span>
</span><a name="line-88"></a><span>        </span><a href="FastString.html#mkLitString%23"><span class="hs-identifier hs-var">mkLitString</span><span class="hs-operator hs-var">#</span></a><span class="hs-special">,</span><span>
</span><a name="line-89"></a><span>        </span><a href="FastString.html#mkLitString"><span class="hs-identifier hs-var">mkLitString</span></a><span class="hs-special">,</span><span>
</span><a name="line-90"></a><span>
</span><a name="line-91"></a><span>        </span><span class="hs-comment">-- ** Deconstruction</span><span>
</span><a name="line-92"></a><span>        </span><a href="FastString.html#unpackLitString"><span class="hs-identifier hs-var">unpackLitString</span></a><span class="hs-special">,</span><span>
</span><a name="line-93"></a><span>
</span><a name="line-94"></a><span>        </span><span class="hs-comment">-- ** Operations</span><span>
</span><a name="line-95"></a><span>        </span><a href="FastString.html#lengthLS"><span class="hs-identifier hs-var">lengthLS</span></a><span>
</span><a name="line-96"></a><span>       </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-97"></a><span>
</span><a name="line-98"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;</span><span>
</span><a name="line-99"></a><span>
</span><a name="line-100"></a><span class="hs-keyword">import</span><span> </span><a href="Encoding.html"><span class="hs-identifier">Encoding</span></a><span>
</span><a name="line-101"></a><span class="hs-keyword">import</span><span> </span><a href="FastFunctions.html"><span class="hs-identifier">FastFunctions</span></a><span>
</span><a name="line-102"></a><span class="hs-keyword">import</span><span> </span><a href="Panic.html"><span class="hs-identifier">Panic</span></a><span>
</span><a name="line-103"></a><span class="hs-keyword">import</span><span> </span><a href="Util.html"><span class="hs-identifier">Util</span></a><span>
</span><a name="line-104"></a><span>
</span><a name="line-105"></a><span class="hs-keyword">import</span><span> </span><a href="../deepseq-1.4.3.0/src/%{MODULE/./-}.html#%{NAME}/Control.DeepSeq.html"><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">DeepSeq</span></a><span>
</span><a name="line-106"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html"><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span></a><span>
</span><a name="line-107"></a><span class="hs-keyword">import</span><span> </span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span></a><span> </span><span class="hs-special">(</span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.Internal.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a><span class="hs-special">)</span><span>
</span><a name="line-108"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span></a><span>          </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BS</span><span>
</span><a name="line-109"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.Char8.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span><span class="hs-operator">.</span><span class="hs-identifier">Char8</span></a><span>    </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BSC</span><span>
</span><a name="line-110"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.Internal.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BS</span><span>
</span><a name="line-111"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.Unsafe.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span><span class="hs-operator">.</span><span class="hs-identifier">Unsafe</span></a><span>   </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BS</span><span>
</span><a name="line-112"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Foreign.C.html"><span class="hs-identifier">Foreign</span><span class="hs-operator">.</span><span class="hs-identifier">C</span></a><span>
</span><a name="line-113"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Exts.html"><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">Exts</span></a><span>
</span><a name="line-114"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/System.IO.html"><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">IO</span></a><span>
</span><a name="line-115"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/System.IO.Unsafe.html"><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">IO</span><span class="hs-operator">.</span><span class="hs-identifier">Unsafe</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IO.Unsafe.html#unsafePerformIO"><span class="hs-identifier hs-var">unsafePerformIO</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-116"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Data.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Data</span></a><span>
</span><a name="line-117"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.IORef.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">IORef</span></a><span>       </span><span class="hs-special">(</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IORef.html#IORef"><span class="hs-identifier hs-type">IORef</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.IORef.html#atomicModifyIORef%27"><span class="hs-identifier hs-var">atomicModifyIORef'</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-118"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Maybe</span></a><span>       </span><span class="hs-special">(</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#isJust"><span class="hs-identifier hs-var">isJust</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-119"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Char.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Char</span></a><span>
</span><a name="line-120"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.List.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span></a><span>        </span><span class="hs-special">(</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.OldList.html#elemIndex"><span class="hs-identifier hs-var">elemIndex</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-121"></a><span>
</span><a name="line-122"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IO.html"><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">IO</span></a><span>           </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">IO</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IO.Unsafe.html#unsafeDupablePerformIO"><span class="hs-identifier hs-var">unsafeDupablePerformIO</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-123"></a><span>
</span><a name="line-124"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Foreign.html"><span class="hs-identifier">Foreign</span></a><span>
</span><a name="line-125"></a><span>
</span><a name="line-126"></a><span class="hs-cpp">#if STAGE &gt;= 2</span><span>
</span><a name="line-127"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Conc.Sync.html"><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">Conc</span><span class="hs-operator">.</span><span class="hs-identifier">Sync</span></a><span>    </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Conc.Sync.html#sharedCAF"><span class="hs-identifier hs-var">sharedCAF</span></a><span class="hs-special">)</span><span>
</span><a name="line-128"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-129"></a><span>
</span><a name="line-130"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html"><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">Base</span></a><span>         </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">unpackCString</span><span class="hs-operator hs-var">#</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-131"></a><span>
</span><a name="line-132"></a><span class="hs-cpp">#define hASH_TBL_SIZE          4091</span><span>
</span><a name="line-133"></a><span class="hs-cpp">#define hASH_TBL_SIZE_UNBOXED  4091#</span><span>
</span><a name="line-134"></a><span>
</span><a name="line-135"></a><span>
</span><a name="line-136"></a><span class="hs-identifier">fastStringToByteString</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.Internal.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a><span>
</span><a name="line-137"></a><a name="fastStringToByteString"><a href="FastString.html#fastStringToByteString"><span class="hs-identifier">fastStringToByteString</span></a></a><span> </span><a name="local-6989586621679082030"><a href="#local-6989586621679082030"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">fs_bs</span><span> </span><a href="#local-6989586621679082030"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-138"></a><span>
</span><a name="line-139"></a><span class="hs-identifier">fastZStringToByteString</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#FastZString"><span class="hs-identifier hs-type">FastZString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.Internal.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a><span>
</span><a name="line-140"></a><a name="fastZStringToByteString"><a href="FastString.html#fastZStringToByteString"><span class="hs-identifier">fastZStringToByteString</span></a></a><span> </span><span class="hs-special">(</span><a href="FastString.html#FastZString"><span class="hs-identifier hs-var">FastZString</span></a><span> </span><a name="local-6989586621679082031"><a href="#local-6989586621679082031"><span class="hs-identifier">bs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679082031"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-141"></a><span>
</span><a name="line-142"></a><span class="hs-comment">-- This will drop information if any character &gt; '\xFF'</span><span>
</span><a name="line-143"></a><span class="hs-identifier">unsafeMkByteString</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.Internal.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a><span>
</span><a name="line-144"></a><a name="unsafeMkByteString"><a href="FastString.html#unsafeMkByteString"><span class="hs-identifier">unsafeMkByteString</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.Char8.html#pack"><span class="hs-identifier hs-var">BSC</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">pack</span></a><span>
</span><a name="line-145"></a><span>
</span><a name="line-146"></a><span class="hs-identifier">hashByteString</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.Internal.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-147"></a><a name="hashByteString"><a href="FastString.html#hashByteString"><span class="hs-identifier">hashByteString</span></a></a><span> </span><a name="local-6989586621679082032"><a href="#local-6989586621679082032"><span class="hs-identifier">bs</span></a></a><span>
</span><a name="line-148"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="FastFunctions.html#inlinePerformIO"><span class="hs-identifier hs-var">inlinePerformIO</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.Unsafe.html#unsafeUseAsCStringLen"><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">unsafeUseAsCStringLen</span></a><span> </span><a href="#local-6989586621679082032"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679082033"><a href="#local-6989586621679082033"><span class="hs-identifier">ptr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679082034"><a href="#local-6989586621679082034"><span class="hs-identifier">len</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-149"></a><span>      </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="FastString.html#hashStr"><span class="hs-identifier hs-var">hashStr</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Ptr.html#castPtr"><span class="hs-identifier hs-var">castPtr</span></a><span> </span><a href="#local-6989586621679082033"><span class="hs-identifier hs-var">ptr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679082034"><span class="hs-identifier hs-var">len</span></a><span>
</span><a name="line-150"></a><span>
</span><a name="line-151"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-152"></a><span>
</span><a name="line-153"></a><span class="hs-keyword">newtype</span><span> </span><a name="FastZString"><a href="FastString.html#FastZString"><span class="hs-identifier">FastZString</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="FastZString"><a href="FastString.html#FastZString"><span class="hs-identifier">FastZString</span></a></a><span> </span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.Internal.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a><span>
</span><a name="line-154"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><a href="../deepseq-1.4.3.0/src/%{MODULE/./-}.html#%{NAME}/Control.DeepSeq.html#NFData"><span class="hs-identifier hs-type">NFData</span></a><span>
</span><a name="line-155"></a><span>
</span><a name="line-156"></a><span class="hs-identifier">hPutFZS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IO.Handle.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#FastZString"><span class="hs-identifier hs-type">FastZString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-157"></a><a name="hPutFZS"><a href="FastString.html#hPutFZS"><span class="hs-identifier">hPutFZS</span></a></a><span> </span><a name="local-6989586621679082035"><a href="#local-6989586621679082035"><span class="hs-identifier">handle</span></a></a><span> </span><span class="hs-special">(</span><a href="FastString.html#FastZString"><span class="hs-identifier hs-var">FastZString</span></a><span> </span><a name="local-6989586621679082036"><a href="#local-6989586621679082036"><span class="hs-identifier">bs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.html#hPut"><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">hPut</span></a><span> </span><a href="#local-6989586621679082035"><span class="hs-identifier hs-var">handle</span></a><span> </span><a href="#local-6989586621679082036"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-158"></a><span>
</span><a name="line-159"></a><span class="hs-identifier">zString</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#FastZString"><span class="hs-identifier hs-type">FastZString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span>
</span><a name="line-160"></a><a name="zString"><a href="FastString.html#zString"><span class="hs-identifier">zString</span></a></a><span> </span><span class="hs-special">(</span><a href="FastString.html#FastZString"><span class="hs-identifier hs-var">FastZString</span></a><span> </span><a name="local-6989586621679082037"><a href="#local-6989586621679082037"><span class="hs-identifier">bs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-161"></a><span>    </span><a href="FastFunctions.html#inlinePerformIO"><span class="hs-identifier hs-var">inlinePerformIO</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.Unsafe.html#unsafeUseAsCStringLen"><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">unsafeUseAsCStringLen</span></a><span> </span><a href="#local-6989586621679082037"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Foreign.C.String.html#peekCAStringLen"><span class="hs-identifier hs-var">peekCAStringLen</span></a><span>
</span><a name="line-162"></a><span>
</span><a name="line-163"></a><span class="hs-identifier">lengthFZS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#FastZString"><span class="hs-identifier hs-type">FastZString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-164"></a><a name="lengthFZS"><a href="FastString.html#lengthFZS"><span class="hs-identifier">lengthFZS</span></a></a><span> </span><span class="hs-special">(</span><a href="FastString.html#FastZString"><span class="hs-identifier hs-var">FastZString</span></a><span> </span><a name="local-6989586621679082038"><a href="#local-6989586621679082038"><span class="hs-identifier">bs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.html#length"><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">length</span></a><span> </span><a href="#local-6989586621679082038"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-165"></a><span>
</span><a name="line-166"></a><span class="hs-identifier">mkFastZStringString</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#FastZString"><span class="hs-identifier hs-type">FastZString</span></a><span>
</span><a name="line-167"></a><a name="mkFastZStringString"><a href="FastString.html#mkFastZStringString"><span class="hs-identifier">mkFastZStringString</span></a></a><span> </span><a name="local-6989586621679082039"><a href="#local-6989586621679082039"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#FastZString"><span class="hs-identifier hs-var">FastZString</span></a><span> </span><span class="hs-special">(</span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.Char8.html#pack"><span class="hs-identifier hs-var">BSC</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">pack</span></a><span> </span><a href="#local-6989586621679082039"><span class="hs-identifier hs-var">str</span></a><span class="hs-special">)</span><span>
</span><a name="line-168"></a><span>
</span><a name="line-169"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-170"></a><span>
</span><a name="line-171"></a><span class="hs-comment">{-|
A 'FastString' is an array of bytes, hashed to support fast O(1)
comparison.  It is also associated with a character encoding, so that
we know how to convert a 'FastString' to the local encoding, or to the
Z-encoding used by the compiler internally.

'FastString's support a memoized conversion to the Z-encoding via zEncodeFS.
-}</span><span>
</span><a name="line-179"></a><span>
</span><a name="line-180"></a><span class="hs-keyword">data</span><span> </span><a name="FastString"><a href="FastString.html#FastString"><span class="hs-identifier">FastString</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="FastString"><a href="FastString.html#FastString"><span class="hs-identifier">FastString</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-181"></a><span>      </span><a name="uniq"><a href="FastString.html#uniq"><span class="hs-identifier">uniq</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK #-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- unique id</span><span>
</span><a name="line-182"></a><span>      </span><a name="n_chars"><a href="FastString.html#n_chars"><span class="hs-identifier">n_chars</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK #-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- number of chars</span><span>
</span><a name="line-183"></a><span>      </span><a name="fs_bs"><a href="FastString.html#fs_bs"><span class="hs-identifier">fs_bs</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK #-}</span><span> </span><span class="hs-glyph">!</span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.Internal.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a><span class="hs-special">,</span><span>
</span><a name="line-184"></a><span>      </span><a name="fs_ref"><a href="FastString.html#fs_ref"><span class="hs-identifier">fs_ref</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK #-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IORef.html#IORef"><span class="hs-identifier hs-type">IORef</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="FastString.html#FastZString"><span class="hs-identifier hs-type">FastZString</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-185"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-186"></a><span>
</span><a name="line-187"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Eq</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-188"></a><span>  </span><a name="local-6989586621679081814"><a href="#local-6989586621679081814"><span class="hs-identifier">f1</span></a></a><span> </span><a name="local-3458764513820541095"><span class="hs-operator">==</span></a><span> </span><a name="local-6989586621679081815"><a href="#local-6989586621679081815"><span class="hs-identifier">f2</span></a></a><span>  </span><span class="hs-glyph">=</span><span>  </span><span class="hs-identifier">uniq</span><span> </span><a href="#local-6989586621679081814"><span class="hs-identifier hs-var">f1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">uniq</span><span> </span><a href="#local-6989586621679081815"><span class="hs-identifier hs-var">f2</span></a><span>
</span><a name="line-189"></a><span>
</span><a name="line-190"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-191"></a><span>    </span><span class="hs-comment">-- Compares lexicographically, not by unique</span><span>
</span><a name="line-192"></a><span>    </span><a name="local-6989586621679081800"><a href="#local-6989586621679081800"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-8214565720323790980"><span class="hs-operator">&lt;=</span></a><span> </span><a name="local-6989586621679081801"><a href="#local-6989586621679081801"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="FastString.html#cmpFS"><span class="hs-identifier hs-var">cmpFS</span></a><span> </span><a href="#local-6989586621679081800"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679081801"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier hs-var">LT</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">;</span><span>  </span><span class="hs-identifier hs-var">EQ</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">;</span><span>  </span><span class="hs-identifier hs-var">GT</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-193"></a><span>    </span><a name="local-6989586621679081802"><a href="#local-6989586621679081802"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-8214565720323790984"><span class="hs-operator">&lt;</span></a><span>  </span><a name="local-6989586621679081803"><a href="#local-6989586621679081803"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="FastString.html#cmpFS"><span class="hs-identifier hs-var">cmpFS</span></a><span> </span><a href="#local-6989586621679081802"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679081803"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier hs-var">LT</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">;</span><span>  </span><span class="hs-identifier hs-var">EQ</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">GT</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-194"></a><span>    </span><a name="local-6989586621679081804"><a href="#local-6989586621679081804"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-3458764513820541096"><span class="hs-operator">&gt;=</span></a><span> </span><a name="local-6989586621679081805"><a href="#local-6989586621679081805"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="FastString.html#cmpFS"><span class="hs-identifier hs-var">cmpFS</span></a><span> </span><a href="#local-6989586621679081804"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679081805"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier hs-var">LT</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">EQ</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">;</span><span>  </span><span class="hs-identifier hs-var">GT</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-195"></a><span>    </span><a name="local-6989586621679081806"><a href="#local-6989586621679081806"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-8214565720323790985"><span class="hs-operator">&gt;</span></a><span>  </span><a name="local-6989586621679081807"><a href="#local-6989586621679081807"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="FastString.html#cmpFS"><span class="hs-identifier hs-var">cmpFS</span></a><span> </span><a href="#local-6989586621679081806"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679081807"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier hs-var">LT</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">EQ</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">GT</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-196"></a><span>    </span><a name="local-8214565720323790986"><span class="hs-identifier">max</span></a><span> </span><a name="local-6989586621679081808"><a href="#local-6989586621679081808"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621679081809"><a href="#local-6989586621679081809"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679081808"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><a href="#local-6989586621679081809"><span class="hs-identifier hs-var">y</span></a><span>    </span><span class="hs-glyph">=</span><span>  </span><a href="#local-6989586621679081808"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-197"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span>  </span><a href="#local-6989586621679081809"><span class="hs-identifier hs-var">y</span></a><span>
</span><a name="line-198"></a><span>    </span><a name="local-8214565720323790987"><span class="hs-identifier">min</span></a><span> </span><a name="local-6989586621679081810"><a href="#local-6989586621679081810"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621679081811"><a href="#local-6989586621679081811"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679081810"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><a href="#local-6989586621679081811"><span class="hs-identifier hs-var">y</span></a><span>    </span><span class="hs-glyph">=</span><span>  </span><a href="#local-6989586621679081810"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-199"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span>  </span><a href="#local-6989586621679081811"><span class="hs-identifier hs-var">y</span></a><span>
</span><a name="line-200"></a><span>    </span><a name="local-8214565720323790979"><span class="hs-identifier">compare</span></a><span> </span><a name="local-6989586621679081812"><a href="#local-6989586621679081812"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679081813"><a href="#local-6989586621679081813"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#cmpFS"><span class="hs-identifier hs-var">cmpFS</span></a><span> </span><a href="#local-6989586621679081812"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679081813"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-201"></a><span>
</span><a name="line-202"></a><span class="hs-keyword">instance</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.String.html#IsString"><span class="hs-identifier hs-type">IsString</span></a><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-203"></a><span>    </span><a name="local-3458764513820541114"><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.String.html#fromString"><span class="hs-identifier">fromString</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#fsLit"><span class="hs-identifier hs-var">fsLit</span></a><span>
</span><a name="line-204"></a><span>
</span><a name="line-205"></a><span class="hs-keyword">instance</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Monoid"><span class="hs-identifier hs-type">Monoid</span></a><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-206"></a><span>    </span><a name="local-3458764513820541483"><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#mempty"><span class="hs-identifier">mempty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#nilFS"><span class="hs-identifier hs-var">nilFS</span></a><span>
</span><a name="line-207"></a><span>    </span><a name="local-3458764513820541484"><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#mappend"><span class="hs-identifier">mappend</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#appendFS"><span class="hs-identifier hs-var">appendFS</span></a><span>
</span><a name="line-208"></a><span>    </span><a name="local-3458764513820541485"><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#mconcat"><span class="hs-identifier">mconcat</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#concatFS"><span class="hs-identifier hs-var">concatFS</span></a><span>
</span><a name="line-209"></a><span>
</span><a name="line-210"></a><span class="hs-keyword">instance</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-211"></a><span>   </span><a name="local-8214565720323790843"><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Show.html#show"><span class="hs-identifier">show</span></a></a><span> </span><a name="local-6989586621679081799"><a href="#local-6989586621679081799"><span class="hs-identifier">fs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a><span> </span><span class="hs-special">(</span><a href="FastString.html#unpackFS"><span class="hs-identifier hs-var">unpackFS</span></a><span> </span><a href="#local-6989586621679081799"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">)</span><span>
</span><a name="line-212"></a><span>
</span><a name="line-213"></a><span class="hs-keyword">instance</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Data.html#Data"><span class="hs-identifier hs-type">Data</span></a><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-214"></a><span>  </span><span class="hs-comment">-- don't traverse?</span><span>
</span><a name="line-215"></a><span>  </span><a name="local-8214565720323787366"><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Data.html#toConstr"><span class="hs-identifier">toConstr</span></a></a><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#abstractConstr"><span class="hs-identifier hs-var">abstractConstr</span></a><span> </span><span class="hs-string">&quot;FastString&quot;</span><span>
</span><a name="line-216"></a><span>  </span><a name="local-8214565720323787367"><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Data.html#gunfold"><span class="hs-identifier">gunfold</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Err.html#error"><span class="hs-identifier hs-var">error</span></a><span> </span><span class="hs-string">&quot;gunfold&quot;</span><span>
</span><a name="line-217"></a><span>  </span><a name="local-8214565720323787365"><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Data.html#dataTypeOf"><span class="hs-identifier">dataTypeOf</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Data.html#mkNoRepType"><span class="hs-identifier hs-var">mkNoRepType</span></a><span> </span><span class="hs-string">&quot;FastString&quot;</span><span>
</span><a name="line-218"></a><span>
</span><a name="line-219"></a><span class="hs-identifier">cmpFS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Ordering</span><span>
</span><a name="line-220"></a><a name="cmpFS"><a href="FastString.html#cmpFS"><span class="hs-identifier">cmpFS</span></a></a><span> </span><a name="local-6989586621679082040"><a href="#local-6989586621679082040"><span class="hs-identifier">f1</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="FastString.html#FastString"><span class="hs-identifier hs-var">FastString</span></a><span> </span><a name="local-6989586621679082041"><a href="#local-6989586621679082041"><span class="hs-identifier">u1</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679082042"><a href="#local-6989586621679082042"><span class="hs-identifier">f2</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="FastString.html#FastString"><span class="hs-identifier hs-var">FastString</span></a><span> </span><a name="local-6989586621679082043"><a href="#local-6989586621679082043"><span class="hs-identifier">u2</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-221"></a><span>  </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679082041"><span class="hs-identifier hs-var">u1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679082043"><span class="hs-identifier hs-var">u2</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">EQ</span><span> </span><span class="hs-keyword">else</span><span>
</span><a name="line-222"></a><span>  </span><span class="hs-identifier hs-var">compare</span><span> </span><span class="hs-special">(</span><a href="FastString.html#fastStringToByteString"><span class="hs-identifier hs-var">fastStringToByteString</span></a><span> </span><a href="#local-6989586621679082040"><span class="hs-identifier hs-var">f1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="FastString.html#fastStringToByteString"><span class="hs-identifier hs-var">fastStringToByteString</span></a><span> </span><a href="#local-6989586621679082042"><span class="hs-identifier hs-var">f2</span></a><span class="hs-special">)</span><span>
</span><a name="line-223"></a><span>
</span><a name="line-224"></a><span class="hs-identifier">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ccall</span><span> </span><span class="hs-identifier">unsafe</span><span> </span><span class="hs-string">&quot;ghc_memcmp&quot;</span><span>
</span><a name="line-225"></a><span>  </span><span class="hs-identifier">memcmp</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="#local-6989586621679082398"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="#local-6989586621679082399"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-226"></a><span>
</span><a name="line-227"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-228"></a><span class="hs-comment">-- Construction</span><span>
</span><a name="line-229"></a><span>
</span><a name="line-230"></a><span class="hs-comment">{-
Internally, the compiler will maintain a fast string symbol table, providing
sharing and fast comparison. Creation of new @FastString@s then covertly does a
lookup, re-using the @FastString@ if there was a hit.

The design of the FastString hash table allows for lockless concurrent reads
and updates to multiple buckets with low synchronization overhead.

See Note [Updating the FastString table] on how it's updated.
-}</span><span>
</span><a name="line-240"></a><span class="hs-keyword">data</span><span> </span><a name="FastStringTable"><a href="FastString.html#FastStringTable"><span class="hs-identifier">FastStringTable</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-241"></a><span> </span><a name="FastStringTable"><a href="FastString.html#FastStringTable"><span class="hs-identifier">FastStringTable</span></a></a><span>
</span><a name="line-242"></a><span>    </span><span class="hs-pragma">{-# UNPACK #-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IORef.html#IORef"><span class="hs-identifier hs-type">IORef</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- the unique ID counter shared with all buckets</span><span>
</span><a name="line-243"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MutableArray</span><span class="hs-operator hs-type">#</span><span> </span><span class="hs-identifier hs-type">RealWorld</span><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IORef.html#IORef"><span class="hs-identifier hs-type">IORef</span></a><span> </span><span class="hs-special">[</span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- the array of mutable buckets</span><span>
</span><a name="line-244"></a><span>
</span><a name="line-245"></a><span class="hs-identifier">string_table</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#FastStringTable"><span class="hs-identifier hs-type">FastStringTable</span></a><span>
</span><a name="line-246"></a><span class="hs-pragma">{-# NOINLINE string_table #-}</span><span>
</span><a name="line-247"></a><a name="string_table"><a href="FastString.html#string_table"><span class="hs-identifier">string_table</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IO.Unsafe.html#unsafePerformIO"><span class="hs-identifier hs-var">unsafePerformIO</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-248"></a><span>  </span><a name="local-6989586621679082044"><a href="#local-6989586621679082044"><span class="hs-identifier">uid</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a><span> </span><span class="hs-number">603979776</span><span> </span><span class="hs-comment">-- ord '$' * 0x01000000</span><span>
</span><a name="line-249"></a><span>  </span><a name="local-6989586621679082048"><a href="#local-6989586621679082048"><span class="hs-identifier">tab</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">IO</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679082045"><a href="#local-6989586621679082045"><span class="hs-identifier">s1</span><span class="hs-operator">#</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">newArray</span><span class="hs-operator hs-var">#</span><span> </span><span class="hs-identifier">hASH_TBL_SIZE_UNBOXED</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">panic</span><span> </span><span class="hs-string">&quot;string_table&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">s1</span><span class="hs-operator">#</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-250"></a><span>                          </span><span class="hs-special">(</span><span class="hs-operator">#</span><span> </span><a name="local-6989586621679082046"><a href="#local-6989586621679082046"><span class="hs-identifier">s2</span><span class="hs-operator">#</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679082047"><a href="#local-6989586621679082047"><span class="hs-identifier">arr</span><span class="hs-operator">#</span></a></a><span> </span><span class="hs-operator">#</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-251"></a><span>                              </span><span class="hs-special">(</span><span class="hs-operator">#</span><span> </span><a href="#local-6989586621679082046"><span class="hs-identifier hs-var">s2</span><span class="hs-operator hs-var">#</span></a><span class="hs-special">,</span><span> </span><a href="FastString.html#FastStringTable"><span class="hs-identifier hs-var">FastStringTable</span></a><span> </span><a href="#local-6989586621679082044"><span class="hs-identifier hs-var">uid</span></a><span> </span><a href="#local-6989586621679082047"><span class="hs-identifier hs-var">arr</span><span class="hs-operator hs-var">#</span></a><span> </span><span class="hs-operator">#</span><span class="hs-special">)</span><span>
</span><a name="line-252"></a><span>  </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#forM_"><span class="hs-identifier hs-var">forM_</span></a><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-glyph">..</span><span> </span><span class="hs-identifier">hASH_TBL_SIZE</span><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">]</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">i</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-253"></a><span>     </span><a name="local-6989586621679082050"><a href="#local-6989586621679082050"><span class="hs-identifier">bucket</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-254"></a><span>     </span><a href="FastString.html#updTbl"><span class="hs-identifier hs-var">updTbl</span></a><span> </span><a href="#local-6989586621679082048"><span class="hs-identifier hs-var">tab</span></a><span> </span><a href="#local-6989586621679082049"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="#local-6989586621679082050"><span class="hs-identifier hs-var">bucket</span></a><span>
</span><a name="line-255"></a><span>
</span><a name="line-256"></a><span>  </span><span class="hs-comment">-- use the support wired into the RTS to share this CAF among all images of</span><span>
</span><a name="line-257"></a><span>  </span><span class="hs-comment">-- libHSghc</span><span>
</span><a name="line-258"></a><span class="hs-cpp">#if STAGE &lt; 2</span><span>
</span><a name="line-259"></a><span>  </span><span class="hs-identifier">return</span><span> </span><span class="hs-identifier">tab</span><span>
</span><a name="line-260"></a><span class="hs-cpp">#else</span><span>
</span><a name="line-261"></a><span>  </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Conc.Sync.html#sharedCAF"><span class="hs-identifier hs-var">sharedCAF</span></a><span> </span><a href="#local-6989586621679082048"><span class="hs-identifier hs-var">tab</span></a><span> </span><a href="FastString.html#getOrSetLibHSghcFastStringTable"><span class="hs-identifier hs-var">getOrSetLibHSghcFastStringTable</span></a><span>
</span><a name="line-262"></a><span>
</span><a name="line-263"></a><span class="hs-comment">-- from the RTS; thus we cannot use this mechanism when STAGE&lt;2; the previous</span><span>
</span><a name="line-264"></a><span class="hs-comment">-- RTS might not have this symbol</span><span>
</span><a name="line-265"></a><span class="hs-identifier">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ccall</span><span> </span><span class="hs-identifier">unsafe</span><span> </span><span class="hs-string">&quot;getOrSetLibHSghcFastStringTable&quot;</span><span>
</span><a name="line-266"></a><span>  </span><span class="hs-identifier">getOrSetLibHSghcFastStringTable</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="#local-6989586621679082397"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="#local-6989586621679082397"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-267"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-268"></a><span>
</span><a name="line-269"></a><span class="hs-comment">{-

We include the FastString table in the `sharedCAF` mechanism because we'd like
FastStrings created by a Core plugin to have the same uniques as corresponding
strings created by the host compiler itself.  For example, this allows plugins
to lookup known names (eg `mkTcOcc &quot;MySpecialType&quot;`) in the GlobalRdrEnv or
even re-invoke the parser.

In particular, the following little sanity test was failing in a plugin
prototyping safe newtype-coercions: GHC.NT.Type.NT was imported, but could not
be looked up /by the plugin/.

   let rdrName = mkModuleName &quot;GHC.NT.Type&quot; `mkRdrQual` mkTcOcc &quot;NT&quot;
   putMsgS $ showSDoc dflags $ ppr $ lookupGRE_RdrName rdrName $ mg_rdr_env guts

`mkTcOcc` involves the lookup (or creation) of a FastString.  Since the
plugin's FastString.string_table is empty, constructing the RdrName also
allocates new uniques for the FastStrings &quot;GHC.NT.Type&quot; and &quot;NT&quot;.  These
uniques are almost certainly unequal to the ones that the host compiler
originally assigned to those FastStrings.  Thus the lookup fails since the
domain of the GlobalRdrEnv is affected by the RdrName's OccName's FastString's
unique.

Maintaining synchronization of the two instances of this global is rather
difficult because of the uses of `unsafePerformIO` in this module.  Not
synchronizing them risks breaking the rather major invariant that two
FastStrings with the same unique have the same string. Thus we use the
lower-level `sharedCAF` mechanism that relies on Globals.c.

-}</span><span>
</span><a name="line-299"></a><span>
</span><a name="line-300"></a><span class="hs-identifier">lookupTbl</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#FastStringTable"><span class="hs-identifier hs-type">FastStringTable</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IORef.html#IORef"><span class="hs-identifier hs-type">IORef</span></a><span> </span><span class="hs-special">[</span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-301"></a><a name="lookupTbl"><a href="FastString.html#lookupTbl"><span class="hs-identifier">lookupTbl</span></a></a><span> </span><span class="hs-special">(</span><a href="FastString.html#FastStringTable"><span class="hs-identifier hs-var">FastStringTable</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679082051"><a href="#local-6989586621679082051"><span class="hs-identifier">arr</span><span class="hs-operator">#</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">I</span><span class="hs-operator hs-var">#</span><span> </span><a name="local-6989586621679082052"><a href="#local-6989586621679082052"><span class="hs-identifier">i</span><span class="hs-operator">#</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-302"></a><span>  </span><span class="hs-identifier hs-var">IO</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621679082053"><a href="#local-6989586621679082053"><span class="hs-identifier">s</span><span class="hs-operator">#</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">readArray</span><span class="hs-operator hs-var">#</span><span> </span><a href="#local-6989586621679082051"><span class="hs-identifier hs-var">arr</span><span class="hs-operator hs-var">#</span></a><span> </span><a href="#local-6989586621679082052"><span class="hs-identifier hs-var">i</span><span class="hs-operator hs-var">#</span></a><span> </span><a href="#local-6989586621679082053"><span class="hs-identifier hs-var">s</span><span class="hs-operator hs-var">#</span></a><span>
</span><a name="line-303"></a><span>
</span><a name="line-304"></a><span class="hs-identifier">updTbl</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#FastStringTable"><span class="hs-identifier hs-type">FastStringTable</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IORef.html#IORef"><span class="hs-identifier hs-type">IORef</span></a><span> </span><span class="hs-special">[</span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-305"></a><a name="updTbl"><a href="FastString.html#updTbl"><span class="hs-identifier">updTbl</span></a></a><span> </span><span class="hs-special">(</span><a href="FastString.html#FastStringTable"><span class="hs-identifier hs-var">FastStringTable</span></a><span> </span><a name="local-6989586621679082054"><a href="#local-6989586621679082054"><span class="hs-identifier">_uid</span></a></a><span> </span><a name="local-6989586621679082055"><a href="#local-6989586621679082055"><span class="hs-identifier">arr</span><span class="hs-operator">#</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">I</span><span class="hs-operator hs-var">#</span><span> </span><a name="local-6989586621679082056"><a href="#local-6989586621679082056"><span class="hs-identifier">i</span><span class="hs-operator">#</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679082057"><a href="#local-6989586621679082057"><span class="hs-identifier">ls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-306"></a><span>  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IO</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621679082058"><a href="#local-6989586621679082058"><span class="hs-identifier">s</span><span class="hs-operator">#</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">writeArray</span><span class="hs-operator hs-var">#</span><span> </span><a href="#local-6989586621679082055"><span class="hs-identifier hs-var">arr</span><span class="hs-operator hs-var">#</span></a><span> </span><a href="#local-6989586621679082056"><span class="hs-identifier hs-var">i</span><span class="hs-operator hs-var">#</span></a><span> </span><a href="#local-6989586621679082057"><span class="hs-identifier hs-var">ls</span></a><span> </span><a href="#local-6989586621679082058"><span class="hs-identifier hs-var">s</span><span class="hs-operator hs-var">#</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679082059"><a href="#local-6989586621679082059"><span class="hs-identifier">s2</span><span class="hs-operator">#</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-operator">#</span><span> </span><a href="#local-6989586621679082059"><span class="hs-identifier hs-var">s2</span><span class="hs-operator hs-var">#</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-operator">#</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-307"></a><span>
</span><a name="line-308"></a><span class="hs-identifier">mkFastString</span><span class="hs-operator">#</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Addr</span><span class="hs-operator hs-type">#</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>
</span><a name="line-309"></a><a name="mkFastString%23"><a href="FastString.html#mkFastString%23"><span class="hs-identifier">mkFastString</span><span class="hs-operator">#</span></a></a><span> </span><a name="local-6989586621679082060"><a href="#local-6989586621679082060"><span class="hs-identifier">a</span><span class="hs-operator">#</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#mkFastStringBytes"><span class="hs-identifier hs-var">mkFastStringBytes</span></a><span> </span><a href="#local-6989586621679082061"><span class="hs-identifier hs-var">ptr</span></a><span> </span><span class="hs-special">(</span><a href="FastString.html#ptrStrLength"><span class="hs-identifier hs-var">ptrStrLength</span></a><span> </span><a href="#local-6989586621679082061"><span class="hs-identifier hs-var">ptr</span></a><span class="hs-special">)</span><span>
</span><a name="line-310"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679082061"><a href="#local-6989586621679082061"><span class="hs-identifier">ptr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-var">Ptr</span></a><span> </span><a href="#local-6989586621679082060"><span class="hs-identifier hs-var">a</span><span class="hs-operator hs-var">#</span></a><span>
</span><a name="line-311"></a><span>
</span><a name="line-312"></a><span class="hs-comment">{- Note [Updating the FastString table]

The procedure goes like this:

1. Read the relevant bucket and perform a look up of the string.
2. If it exists, return it.
3. Otherwise grab a unique ID, create a new FastString and atomically attempt
   to update the relevant bucket with this FastString:

   * Double check that the string is not in the bucket. Another thread may have
     inserted it while we were creating our string.
   * Return the existing FastString if it exists. The one we preemptively
     created will get GCed.
   * Otherwise, insert and return the string we created.
-}</span><span>
</span><a name="line-327"></a><span>
</span><a name="line-328"></a><span class="hs-comment">{- Note [Double-checking the bucket]

It is not necessary to check the entire bucket the second time. We only have to
check the strings that are new to the bucket since the last time we read it.
-}</span><span>
</span><a name="line-333"></a><span>
</span><a name="line-334"></a><span class="hs-identifier">mkFastStringWith</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>
</span><a name="line-335"></a><a name="mkFastStringWith"><a href="FastString.html#mkFastStringWith"><span class="hs-identifier">mkFastStringWith</span></a></a><span> </span><a name="local-6989586621679082062"><a href="#local-6989586621679082062"><span class="hs-identifier">mk_fs</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679082063"><a href="#local-6989586621679082063"><span class="hs-identifier">ptr</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679082064"><a href="#local-6989586621679082064"><span class="hs-identifier">len</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-336"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679082069"><a href="#local-6989586621679082069"><span class="hs-identifier">hash</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#hashStr"><span class="hs-identifier hs-var">hashStr</span></a><span> </span><a href="#local-6989586621679082063"><span class="hs-identifier hs-var">ptr</span></a><span> </span><a href="#local-6989586621679082064"><span class="hs-identifier hs-var">len</span></a><span>
</span><a name="line-337"></a><span>    </span><a name="local-6989586621679082070"><a href="#local-6989586621679082070"><span class="hs-identifier">bucket</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FastString.html#lookupTbl"><span class="hs-identifier hs-var">lookupTbl</span></a><span> </span><a href="FastString.html#string_table"><span class="hs-identifier hs-var">string_table</span></a><span> </span><a href="#local-6989586621679082069"><span class="hs-identifier hs-var">hash</span></a><span>
</span><a name="line-338"></a><span>    </span><a name="local-6989586621679082071"><a href="#local-6989586621679082071"><span class="hs-identifier">ls1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span> </span><a href="#local-6989586621679082070"><span class="hs-identifier hs-var">bucket</span></a><span>
</span><a name="line-339"></a><span>    </span><a name="local-6989586621679082072"><a href="#local-6989586621679082072"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FastString.html#bucket_match"><span class="hs-identifier hs-var">bucket_match</span></a><span> </span><a href="#local-6989586621679082071"><span class="hs-identifier hs-var">ls1</span></a><span> </span><a href="#local-6989586621679082064"><span class="hs-identifier hs-var">len</span></a><span> </span><a href="#local-6989586621679082063"><span class="hs-identifier hs-var">ptr</span></a><span>
</span><a name="line-340"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679082072"><span class="hs-identifier hs-var">res</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-341"></a><span>        </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679082073"><a href="#local-6989586621679082073"><span class="hs-identifier">v</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679082073"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-342"></a><span>        </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-343"></a><span>            </span><a name="local-6989586621679082074"><a href="#local-6989586621679082074"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679082067"><span class="hs-identifier hs-var">get_uid</span></a><span>
</span><a name="line-344"></a><span>            </span><a name="local-6989586621679082075"><a href="#local-6989586621679082075"><span class="hs-identifier">new_fs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679082062"><span class="hs-identifier hs-var">mk_fs</span></a><span> </span><a href="#local-6989586621679082074"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-345"></a><span>
</span><a name="line-346"></a><span>            </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.IORef.html#atomicModifyIORef%27"><span class="hs-identifier hs-var">atomicModifyIORef'</span></a><span> </span><a href="#local-6989586621679082070"><span class="hs-identifier hs-var">bucket</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679082076"><a href="#local-6989586621679082076"><span class="hs-identifier">ls2</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-347"></a><span>                </span><span class="hs-comment">-- Note [Double-checking the bucket]</span><span>
</span><a name="line-348"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679082077"><a href="#local-6989586621679082077"><span class="hs-identifier">delta_ls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679082071"><span class="hs-identifier hs-var">ls1</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-349"></a><span>                        </span><span class="hs-special">[</span><span class="hs-special">]</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679082076"><span class="hs-identifier hs-var">ls2</span></a><span>
</span><a name="line-350"></a><span>                        </span><a name="local-6989586621679082078"><a href="#local-6989586621679082078"><span class="hs-identifier">l</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679082078"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">`</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.OldList.html#elemIndex"><span class="hs-identifier hs-var">elemIndex</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679082076"><span class="hs-identifier hs-var">ls2</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-351"></a><span>                            </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Panic.html#panic"><span class="hs-identifier hs-var">panic</span></a><span> </span><span class="hs-string">&quot;mkFastStringWith&quot;</span><span>
</span><a name="line-352"></a><span>                            </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679082079"><a href="#local-6989586621679082079"><span class="hs-identifier">idx</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#take"><span class="hs-identifier hs-var">take</span></a><span> </span><a href="#local-6989586621679082079"><span class="hs-identifier hs-var">idx</span></a><span> </span><a href="#local-6989586621679082076"><span class="hs-identifier hs-var">ls2</span></a><span>
</span><a name="line-353"></a><span>
</span><a name="line-354"></a><span>                </span><span class="hs-comment">-- NB: Might as well use inlinePerformIO, since the call to</span><span>
</span><a name="line-355"></a><span>                </span><span class="hs-comment">-- bucket_match doesn't perform any IO that could be floated</span><span>
</span><a name="line-356"></a><span>                </span><span class="hs-comment">-- out of this closure or erroneously duplicated.</span><span>
</span><a name="line-357"></a><span>                </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="FastFunctions.html#inlinePerformIO"><span class="hs-identifier hs-var">inlinePerformIO</span></a><span> </span><span class="hs-special">(</span><a href="FastString.html#bucket_match"><span class="hs-identifier hs-var">bucket_match</span></a><span> </span><a href="#local-6989586621679082077"><span class="hs-identifier hs-var">delta_ls</span></a><span> </span><a href="#local-6989586621679082064"><span class="hs-identifier hs-var">len</span></a><span> </span><a href="#local-6989586621679082063"><span class="hs-identifier hs-var">ptr</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-358"></a><span>                    </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679082075"><span class="hs-identifier hs-var">new_fs</span></a><span class="hs-glyph">:</span><a href="#local-6989586621679082076"><span class="hs-identifier hs-var">ls2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679082075"><span class="hs-identifier hs-var">new_fs</span></a><span class="hs-special">)</span><span>
</span><a name="line-359"></a><span>                    </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679082080"><a href="#local-6989586621679082080"><span class="hs-identifier">fs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679082076"><span class="hs-identifier hs-var">ls2</span></a><span class="hs-special">,</span><a href="#local-6989586621679082080"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">)</span><span>
</span><a name="line-360"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-361"></a><span>    </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="FastString.html#FastStringTable"><span class="hs-identifier hs-var">FastStringTable</span></a><span> </span><a name="local-6989586621679082065"><a href="#local-6989586621679082065"><span class="hs-identifier">uid</span></a></a><span> </span><a name="local-6989586621679082066"><a href="#local-6989586621679082066"><span class="hs-identifier">_arr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#string_table"><span class="hs-identifier hs-var">string_table</span></a><span>
</span><a name="line-362"></a><span>
</span><a name="line-363"></a><span>    </span><a name="local-6989586621679082067"><a href="#local-6989586621679082067"><span class="hs-identifier">get_uid</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.IORef.html#atomicModifyIORef%27"><span class="hs-identifier hs-var">atomicModifyIORef'</span></a><span> </span><a href="#local-6989586621679082065"><span class="hs-identifier hs-var">uid</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679082068"><a href="#local-6989586621679082068"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679082068"><span class="hs-identifier hs-var">n</span></a><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a><span class="hs-number">1</span><span class="hs-special">,</span><a href="#local-6989586621679082068"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-364"></a><span>
</span><a name="line-365"></a><span class="hs-identifier">mkFastStringBytes</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>
</span><a name="line-366"></a><a name="mkFastStringBytes"><a href="FastString.html#mkFastStringBytes"><span class="hs-identifier">mkFastStringBytes</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679082081"><a href="#local-6989586621679082081"><span class="hs-identifier">ptr</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679082082"><a href="#local-6989586621679082082"><span class="hs-identifier">len</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-367"></a><span>    </span><span class="hs-comment">-- NB: Might as well use unsafeDupablePerformIO, since mkFastStringWith is</span><span>
</span><a name="line-368"></a><span>    </span><span class="hs-comment">-- idempotent.</span><span>
</span><a name="line-369"></a><span>    </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IO.Unsafe.html#unsafeDupablePerformIO"><span class="hs-identifier hs-var">unsafeDupablePerformIO</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-370"></a><span>        </span><a href="FastString.html#mkFastStringWith"><span class="hs-identifier hs-var">mkFastStringWith</span></a><span> </span><span class="hs-special">(</span><a href="FastString.html#copyNewFastString"><span class="hs-identifier hs-var">copyNewFastString</span></a><span> </span><a href="#local-6989586621679082081"><span class="hs-identifier hs-var">ptr</span></a><span> </span><a href="#local-6989586621679082082"><span class="hs-identifier hs-var">len</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679082081"><span class="hs-identifier hs-var">ptr</span></a><span> </span><a href="#local-6989586621679082082"><span class="hs-identifier hs-var">len</span></a><span>
</span><a name="line-371"></a><span>
</span><a name="line-372"></a><span class="hs-comment">-- | Create a 'FastString' from an existing 'ForeignPtr'; the difference</span><span>
</span><a name="line-373"></a><span class="hs-comment">-- between this and 'mkFastStringBytes' is that we don't have to copy</span><span>
</span><a name="line-374"></a><span class="hs-comment">-- the bytes if the string is new to the table.</span><span>
</span><a name="line-375"></a><span class="hs-identifier">mkFastStringForeignPtr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-type">ForeignPtr</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>
</span><a name="line-376"></a><a name="mkFastStringForeignPtr"><a href="FastString.html#mkFastStringForeignPtr"><span class="hs-identifier">mkFastStringForeignPtr</span></a></a><span> </span><a name="local-6989586621679082083"><a href="#local-6989586621679082083"><span class="hs-identifier">ptr</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679082084"><a href="#local-6989586621679082084"><span class="hs-identifier">fp</span></a></a><span> </span><a name="local-6989586621679082085"><a href="#local-6989586621679082085"><span class="hs-identifier">len</span></a></a><span>
</span><a name="line-377"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#mkFastStringWith"><span class="hs-identifier hs-var">mkFastStringWith</span></a><span> </span><span class="hs-special">(</span><a href="FastString.html#mkNewFastString"><span class="hs-identifier hs-var">mkNewFastString</span></a><span> </span><a href="#local-6989586621679082084"><span class="hs-identifier hs-var">fp</span></a><span> </span><a href="#local-6989586621679082083"><span class="hs-identifier hs-var">ptr</span></a><span> </span><a href="#local-6989586621679082085"><span class="hs-identifier hs-var">len</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679082083"><span class="hs-identifier hs-var">ptr</span></a><span> </span><a href="#local-6989586621679082085"><span class="hs-identifier hs-var">len</span></a><span>
</span><a name="line-378"></a><span>
</span><a name="line-379"></a><span class="hs-comment">-- | Create a 'FastString' from an existing 'ForeignPtr'; the difference</span><span>
</span><a name="line-380"></a><span class="hs-comment">-- between this and 'mkFastStringBytes' is that we don't have to copy</span><span>
</span><a name="line-381"></a><span class="hs-comment">-- the bytes if the string is new to the table.</span><span>
</span><a name="line-382"></a><span class="hs-identifier">mkFastStringByteString</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.Internal.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>
</span><a name="line-383"></a><a name="mkFastStringByteString"><a href="FastString.html#mkFastStringByteString"><span class="hs-identifier">mkFastStringByteString</span></a></a><span> </span><a name="local-6989586621679082086"><a href="#local-6989586621679082086"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-384"></a><span>    </span><a href="FastFunctions.html#inlinePerformIO"><span class="hs-identifier hs-var">inlinePerformIO</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-385"></a><span>      </span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.Unsafe.html#unsafeUseAsCStringLen"><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">unsafeUseAsCStringLen</span></a><span> </span><a href="#local-6989586621679082086"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679082087"><a href="#local-6989586621679082087"><span class="hs-identifier">ptr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679082088"><a href="#local-6989586621679082088"><span class="hs-identifier">len</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-386"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679082089"><a href="#local-6989586621679082089"><span class="hs-identifier">ptr'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Ptr.html#castPtr"><span class="hs-identifier hs-var">castPtr</span></a><span> </span><a href="#local-6989586621679082087"><span class="hs-identifier hs-var">ptr</span></a><span>
</span><a name="line-387"></a><span>        </span><a href="FastString.html#mkFastStringWith"><span class="hs-identifier hs-var">mkFastStringWith</span></a><span> </span><span class="hs-special">(</span><a href="FastString.html#mkNewFastStringByteString"><span class="hs-identifier hs-var">mkNewFastStringByteString</span></a><span> </span><a href="#local-6989586621679082086"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="#local-6989586621679082089"><span class="hs-identifier hs-var">ptr'</span></a><span> </span><a href="#local-6989586621679082088"><span class="hs-identifier hs-var">len</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679082089"><span class="hs-identifier hs-var">ptr'</span></a><span> </span><a href="#local-6989586621679082088"><span class="hs-identifier hs-var">len</span></a><span>
</span><a name="line-388"></a><span>
</span><a name="line-389"></a><span class="hs-comment">-- | Creates a UTF-8 encoded 'FastString' from a 'String'</span><span>
</span><a name="line-390"></a><span class="hs-identifier">mkFastString</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>
</span><a name="line-391"></a><a name="mkFastString"><a href="FastString.html#mkFastString"><span class="hs-identifier">mkFastString</span></a></a><span> </span><a name="local-6989586621679082090"><a href="#local-6989586621679082090"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-392"></a><span>  </span><a href="FastFunctions.html#inlinePerformIO"><span class="hs-identifier hs-var">inlinePerformIO</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-393"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679082091"><a href="#local-6989586621679082091"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Encoding.html#utf8EncodedLength"><span class="hs-identifier hs-var">utf8EncodedLength</span></a><span> </span><a href="#local-6989586621679082090"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-394"></a><span>    </span><a name="local-6989586621679082092"><a href="#local-6989586621679082092"><span class="hs-identifier">buf</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.ForeignPtr.html#mallocForeignPtrBytes"><span class="hs-identifier hs-var">mallocForeignPtrBytes</span></a><span> </span><a href="#local-6989586621679082091"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-395"></a><span>    </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Foreign.ForeignPtr.Imp.html#withForeignPtr"><span class="hs-identifier hs-var">withForeignPtr</span></a><span> </span><a href="#local-6989586621679082092"><span class="hs-identifier hs-var">buf</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679082124"><a href="#local-6989586621679082124"><span class="hs-identifier">ptr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-396"></a><span>      </span><a href="Encoding.html#utf8EncodeString"><span class="hs-identifier hs-var">utf8EncodeString</span></a><span> </span><a href="#local-6989586621679082124"><span class="hs-identifier hs-var">ptr</span></a><span> </span><a href="#local-6989586621679082090"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-397"></a><span>      </span><a href="FastString.html#mkFastStringForeignPtr"><span class="hs-identifier hs-var">mkFastStringForeignPtr</span></a><span> </span><a href="#local-6989586621679082124"><span class="hs-identifier hs-var">ptr</span></a><span> </span><a href="#local-6989586621679082092"><span class="hs-identifier hs-var">buf</span></a><span> </span><a href="#local-6989586621679082091"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-398"></a><span>
</span><a name="line-399"></a><span class="hs-comment">-- | Creates a 'FastString' from a UTF-8 encoded @[Word8]@</span><span>
</span><a name="line-400"></a><span class="hs-identifier">mkFastStringByteList</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>
</span><a name="line-401"></a><a name="mkFastStringByteList"><a href="FastString.html#mkFastStringByteList"><span class="hs-identifier">mkFastStringByteList</span></a></a><span> </span><a name="local-6989586621679082125"><a href="#local-6989586621679082125"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-402"></a><span>  </span><a href="FastFunctions.html#inlinePerformIO"><span class="hs-identifier hs-var">inlinePerformIO</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-403"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679082126"><a href="#local-6989586621679082126"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">Prelude</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">length</span></a><span> </span><a href="#local-6989586621679082125"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-404"></a><span>    </span><a name="local-6989586621679082127"><a href="#local-6989586621679082127"><span class="hs-identifier">buf</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.ForeignPtr.html#mallocForeignPtrBytes"><span class="hs-identifier hs-var">mallocForeignPtrBytes</span></a><span> </span><a href="#local-6989586621679082126"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-405"></a><span>    </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Foreign.ForeignPtr.Imp.html#withForeignPtr"><span class="hs-identifier hs-var">withForeignPtr</span></a><span> </span><a href="#local-6989586621679082127"><span class="hs-identifier hs-var">buf</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679082128"><a href="#local-6989586621679082128"><span class="hs-identifier">ptr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-406"></a><span>      </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Foreign.Marshal.Array.html#pokeArray"><span class="hs-identifier hs-var">pokeArray</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Ptr.html#castPtr"><span class="hs-identifier hs-var">castPtr</span></a><span> </span><a href="#local-6989586621679082128"><span class="hs-identifier hs-var">ptr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679082125"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-407"></a><span>      </span><a href="FastString.html#mkFastStringForeignPtr"><span class="hs-identifier hs-var">mkFastStringForeignPtr</span></a><span> </span><a href="#local-6989586621679082128"><span class="hs-identifier hs-var">ptr</span></a><span> </span><a href="#local-6989586621679082127"><span class="hs-identifier hs-var">buf</span></a><span> </span><a href="#local-6989586621679082126"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-408"></a><span>
</span><a name="line-409"></a><span class="hs-comment">-- | Creates a Z-encoded 'FastString' from a 'String'</span><span>
</span><a name="line-410"></a><span class="hs-identifier">mkZFastString</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#FastZString"><span class="hs-identifier hs-type">FastZString</span></a><span>
</span><a name="line-411"></a><a name="mkZFastString"><a href="FastString.html#mkZFastString"><span class="hs-identifier">mkZFastString</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#mkFastZStringString"><span class="hs-identifier hs-var">mkFastZStringString</span></a><span>
</span><a name="line-412"></a><span>
</span><a name="line-413"></a><span class="hs-identifier">bucket_match</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span class="hs-special">)</span><span>
</span><a name="line-414"></a><a name="bucket_match"><a href="FastString.html#bucket_match"><span class="hs-identifier">bucket_match</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-415"></a><span class="hs-identifier">bucket_match</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679082203"><a href="#local-6989586621679082203"><span class="hs-identifier">v</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="FastString.html#FastString"><span class="hs-identifier hs-var">FastString</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679082204"><a href="#local-6989586621679082204"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-glyph">:</span><a name="local-6989586621679082205"><a href="#local-6989586621679082205"><span class="hs-identifier">ls</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679082206"><a href="#local-6989586621679082206"><span class="hs-identifier">len</span></a></a><span> </span><a name="local-6989586621679082207"><a href="#local-6989586621679082207"><span class="hs-identifier">ptr</span></a></a><span>
</span><a name="line-416"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679082206"><span class="hs-identifier hs-var">len</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.html#length"><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">length</span></a><span> </span><a href="#local-6989586621679082204"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-417"></a><span>         </span><a name="local-6989586621679082209"><a href="#local-6989586621679082209"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.Unsafe.html#unsafeUseAsCString"><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">unsafeUseAsCString</span></a><span> </span><a href="#local-6989586621679082204"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679082208"><a href="#local-6989586621679082208"><span class="hs-identifier">buf</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-418"></a><span>             </span><a href="FastString.html#cmpStringPrefix"><span class="hs-identifier hs-var">cmpStringPrefix</span></a><span> </span><a href="#local-6989586621679082207"><span class="hs-identifier hs-var">ptr</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Ptr.html#castPtr"><span class="hs-identifier hs-var">castPtr</span></a><span> </span><a href="#local-6989586621679082208"><span class="hs-identifier hs-var">buf</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679082206"><span class="hs-identifier hs-var">len</span></a><span>
</span><a name="line-419"></a><span>         </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679082209"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-6989586621679082203"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-420"></a><span>              </span><span class="hs-keyword">else</span><span> </span><a href="FastString.html#bucket_match"><span class="hs-identifier hs-var">bucket_match</span></a><span> </span><a href="#local-6989586621679082205"><span class="hs-identifier hs-var">ls</span></a><span> </span><a href="#local-6989586621679082206"><span class="hs-identifier hs-var">len</span></a><span> </span><a href="#local-6989586621679082207"><span class="hs-identifier hs-var">ptr</span></a><span>
</span><a name="line-421"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-422"></a><span>         </span><a href="FastString.html#bucket_match"><span class="hs-identifier hs-var">bucket_match</span></a><span> </span><a href="#local-6989586621679082205"><span class="hs-identifier hs-var">ls</span></a><span> </span><a href="#local-6989586621679082206"><span class="hs-identifier hs-var">len</span></a><span> </span><a href="#local-6989586621679082207"><span class="hs-identifier hs-var">ptr</span></a><span>
</span><a name="line-423"></a><span>
</span><a name="line-424"></a><span class="hs-identifier">mkNewFastString</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-type">ForeignPtr</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-425"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>
</span><a name="line-426"></a><a name="mkNewFastString"><a href="FastString.html#mkNewFastString"><span class="hs-identifier">mkNewFastString</span></a></a><span> </span><a name="local-6989586621679082210"><a href="#local-6989586621679082210"><span class="hs-identifier">fp</span></a></a><span> </span><a name="local-6989586621679082211"><a href="#local-6989586621679082211"><span class="hs-identifier">ptr</span></a></a><span> </span><a name="local-6989586621679082212"><a href="#local-6989586621679082212"><span class="hs-identifier">len</span></a></a><span> </span><a name="local-6989586621679082213"><a href="#local-6989586621679082213"><span class="hs-identifier">uid</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-427"></a><span>  </span><a name="local-6989586621679082214"><a href="#local-6989586621679082214"><span class="hs-identifier">ref</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-428"></a><span>  </span><a name="local-6989586621679082215"><a href="#local-6989586621679082215"><span class="hs-identifier">n_chars</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Encoding.html#countUTF8Chars"><span class="hs-identifier hs-var">countUTF8Chars</span></a><span> </span><a href="#local-6989586621679082211"><span class="hs-identifier hs-var">ptr</span></a><span> </span><a href="#local-6989586621679082212"><span class="hs-identifier hs-var">len</span></a><span>
</span><a name="line-429"></a><span>  </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="FastString.html#FastString"><span class="hs-identifier hs-var">FastString</span></a><span> </span><a href="#local-6989586621679082213"><span class="hs-identifier hs-var">uid</span></a><span> </span><a href="#local-6989586621679082215"><span class="hs-identifier hs-var">n_chars</span></a><span> </span><span class="hs-special">(</span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.Internal.html#fromForeignPtr"><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromForeignPtr</span></a><span> </span><a href="#local-6989586621679082210"><span class="hs-identifier hs-var">fp</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621679082212"><span class="hs-identifier hs-var">len</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679082214"><span class="hs-identifier hs-var">ref</span></a><span class="hs-special">)</span><span>
</span><a name="line-430"></a><span>
</span><a name="line-431"></a><span class="hs-identifier">mkNewFastStringByteString</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.Internal.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-432"></a><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>
</span><a name="line-433"></a><a name="mkNewFastStringByteString"><a href="FastString.html#mkNewFastStringByteString"><span class="hs-identifier">mkNewFastStringByteString</span></a></a><span> </span><a name="local-6989586621679082216"><a href="#local-6989586621679082216"><span class="hs-identifier">bs</span></a></a><span> </span><a name="local-6989586621679082217"><a href="#local-6989586621679082217"><span class="hs-identifier">ptr</span></a></a><span> </span><a name="local-6989586621679082218"><a href="#local-6989586621679082218"><span class="hs-identifier">len</span></a></a><span> </span><a name="local-6989586621679082219"><a href="#local-6989586621679082219"><span class="hs-identifier">uid</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-434"></a><span>  </span><a name="local-6989586621679082220"><a href="#local-6989586621679082220"><span class="hs-identifier">ref</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-435"></a><span>  </span><a name="local-6989586621679082221"><a href="#local-6989586621679082221"><span class="hs-identifier">n_chars</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Encoding.html#countUTF8Chars"><span class="hs-identifier hs-var">countUTF8Chars</span></a><span> </span><a href="#local-6989586621679082217"><span class="hs-identifier hs-var">ptr</span></a><span> </span><a href="#local-6989586621679082218"><span class="hs-identifier hs-var">len</span></a><span>
</span><a name="line-436"></a><span>  </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="FastString.html#FastString"><span class="hs-identifier hs-var">FastString</span></a><span> </span><a href="#local-6989586621679082219"><span class="hs-identifier hs-var">uid</span></a><span> </span><a href="#local-6989586621679082221"><span class="hs-identifier hs-var">n_chars</span></a><span> </span><a href="#local-6989586621679082216"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="#local-6989586621679082220"><span class="hs-identifier hs-var">ref</span></a><span class="hs-special">)</span><span>
</span><a name="line-437"></a><span>
</span><a name="line-438"></a><span class="hs-identifier">copyNewFastString</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>
</span><a name="line-439"></a><a name="copyNewFastString"><a href="FastString.html#copyNewFastString"><span class="hs-identifier">copyNewFastString</span></a></a><span> </span><a name="local-6989586621679082222"><a href="#local-6989586621679082222"><span class="hs-identifier">ptr</span></a></a><span> </span><a name="local-6989586621679082223"><a href="#local-6989586621679082223"><span class="hs-identifier">len</span></a></a><span> </span><a name="local-6989586621679082224"><a href="#local-6989586621679082224"><span class="hs-identifier">uid</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-440"></a><span>  </span><a name="local-6989586621679082225"><a href="#local-6989586621679082225"><span class="hs-identifier">fp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FastString.html#copyBytesToForeignPtr"><span class="hs-identifier hs-var">copyBytesToForeignPtr</span></a><span> </span><a href="#local-6989586621679082222"><span class="hs-identifier hs-var">ptr</span></a><span> </span><a href="#local-6989586621679082223"><span class="hs-identifier hs-var">len</span></a><span>
</span><a name="line-441"></a><span>  </span><a name="local-6989586621679082226"><a href="#local-6989586621679082226"><span class="hs-identifier">ref</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-442"></a><span>  </span><a name="local-6989586621679082227"><a href="#local-6989586621679082227"><span class="hs-identifier">n_chars</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Encoding.html#countUTF8Chars"><span class="hs-identifier hs-var">countUTF8Chars</span></a><span> </span><a href="#local-6989586621679082222"><span class="hs-identifier hs-var">ptr</span></a><span> </span><a href="#local-6989586621679082223"><span class="hs-identifier hs-var">len</span></a><span>
</span><a name="line-443"></a><span>  </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="FastString.html#FastString"><span class="hs-identifier hs-var">FastString</span></a><span> </span><a href="#local-6989586621679082224"><span class="hs-identifier hs-var">uid</span></a><span> </span><a href="#local-6989586621679082227"><span class="hs-identifier hs-var">n_chars</span></a><span> </span><span class="hs-special">(</span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.Internal.html#fromForeignPtr"><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromForeignPtr</span></a><span> </span><a href="#local-6989586621679082225"><span class="hs-identifier hs-var">fp</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621679082223"><span class="hs-identifier hs-var">len</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679082226"><span class="hs-identifier hs-var">ref</span></a><span class="hs-special">)</span><span>
</span><a name="line-444"></a><span>
</span><a name="line-445"></a><span class="hs-identifier">copyBytesToForeignPtr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.ForeignPtr.html#ForeignPtr"><span class="hs-identifier hs-type">ForeignPtr</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a><span class="hs-special">)</span><span>
</span><a name="line-446"></a><a name="copyBytesToForeignPtr"><a href="FastString.html#copyBytesToForeignPtr"><span class="hs-identifier">copyBytesToForeignPtr</span></a></a><span> </span><a name="local-6989586621679082228"><a href="#local-6989586621679082228"><span class="hs-identifier">ptr</span></a></a><span> </span><a name="local-6989586621679082229"><a href="#local-6989586621679082229"><span class="hs-identifier">len</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-447"></a><span>  </span><a name="local-6989586621679082230"><a href="#local-6989586621679082230"><span class="hs-identifier">fp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.ForeignPtr.html#mallocForeignPtrBytes"><span class="hs-identifier hs-var">mallocForeignPtrBytes</span></a><span> </span><a href="#local-6989586621679082229"><span class="hs-identifier hs-var">len</span></a><span>
</span><a name="line-448"></a><span>  </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Foreign.ForeignPtr.Imp.html#withForeignPtr"><span class="hs-identifier hs-var">withForeignPtr</span></a><span> </span><a href="#local-6989586621679082230"><span class="hs-identifier hs-var">fp</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679082231"><a href="#local-6989586621679082231"><span class="hs-identifier">ptr'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Foreign.Marshal.Utils.html#copyBytes"><span class="hs-identifier hs-var">copyBytes</span></a><span> </span><a href="#local-6989586621679082231"><span class="hs-identifier hs-var">ptr'</span></a><span> </span><a href="#local-6989586621679082228"><span class="hs-identifier hs-var">ptr</span></a><span> </span><a href="#local-6989586621679082229"><span class="hs-identifier hs-var">len</span></a><span>
</span><a name="line-449"></a><span>  </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679082230"><span class="hs-identifier hs-var">fp</span></a><span>
</span><a name="line-450"></a><span>
</span><a name="line-451"></a><span class="hs-identifier">cmpStringPrefix</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-452"></a><a name="cmpStringPrefix"><a href="FastString.html#cmpStringPrefix"><span class="hs-identifier">cmpStringPrefix</span></a></a><span> </span><a name="local-6989586621679082277"><a href="#local-6989586621679082277"><span class="hs-identifier">ptr1</span></a></a><span> </span><a name="local-6989586621679082278"><a href="#local-6989586621679082278"><span class="hs-identifier">ptr2</span></a></a><span> </span><a name="local-6989586621679082279"><a href="#local-6989586621679082279"><span class="hs-identifier">len</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-453"></a><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679082280"><a href="#local-6989586621679082280"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FastString.html#memcmp"><span class="hs-identifier hs-var">memcmp</span></a><span> </span><a href="#local-6989586621679082277"><span class="hs-identifier hs-var">ptr1</span></a><span> </span><a href="#local-6989586621679082278"><span class="hs-identifier hs-var">ptr2</span></a><span> </span><a href="#local-6989586621679082279"><span class="hs-identifier hs-var">len</span></a><span>
</span><a name="line-454"></a><span>    </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679082280"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-455"></a><span>
</span><a name="line-456"></a><span>
</span><a name="line-457"></a><span class="hs-identifier">hashStr</span><span>  </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-458"></a><span> </span><span class="hs-comment">-- use the Addr to produce a hash value between 0 &amp; m (inclusive)</span><span>
</span><a name="line-459"></a><a name="hashStr"><a href="FastString.html#hashStr"><span class="hs-identifier">hashStr</span></a></a><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-var">Ptr</span></a><span> </span><a name="local-6989586621679082281"><a href="#local-6989586621679082281"><span class="hs-identifier">a</span><span class="hs-operator">#</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">I</span><span class="hs-operator hs-var">#</span><span> </span><a name="local-6989586621679082282"><a href="#local-6989586621679082282"><span class="hs-identifier">len</span><span class="hs-operator">#</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679082283"><span class="hs-identifier hs-var">loop</span></a><span> </span><span class="hs-number">0</span><span class="hs-operator">#</span><span> </span><span class="hs-number">0</span><span class="hs-operator">#</span><span>
</span><a name="line-460"></a><span>   </span><span class="hs-keyword">where</span><span>
</span><a name="line-461"></a><span>    </span><a name="local-6989586621679082283"><a href="#local-6989586621679082283"><span class="hs-identifier">loop</span></a></a><span> </span><a name="local-6989586621679082284"><a href="#local-6989586621679082284"><span class="hs-identifier">h</span></a></a><span> </span><a name="local-6989586621679082285"><a href="#local-6989586621679082285"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isTrue</span><span class="hs-operator hs-var">#</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679082285"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">==#</span><span> </span><a href="#local-6989586621679082282"><span class="hs-identifier hs-var">len</span><span class="hs-operator hs-var">#</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">I</span><span class="hs-operator hs-var">#</span><span> </span><a href="#local-6989586621679082284"><span class="hs-identifier hs-var">h</span></a><span>
</span><a name="line-462"></a><span>             </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679082283"><span class="hs-identifier hs-var">loop</span></a><span> </span><a href="#local-6989586621679082287"><span class="hs-identifier hs-var">h2</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679082285"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">+#</span><span> </span><span class="hs-number">1</span><span class="hs-operator">#</span><span class="hs-special">)</span><span>
</span><a name="line-463"></a><span>          </span><span class="hs-keyword">where</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679082286"><a href="#local-6989586621679082286"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ord</span><span class="hs-operator hs-var">#</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">indexCharOffAddr</span><span class="hs-operator hs-var">#</span><span> </span><a href="#local-6989586621679082281"><span class="hs-identifier hs-var">a</span><span class="hs-operator hs-var">#</span></a><span> </span><a href="#local-6989586621679082285"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-464"></a><span>                </span><span class="hs-glyph">!</span><a name="local-6989586621679082287"><a href="#local-6989586621679082287"><span class="hs-identifier">h2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679082286"><span class="hs-identifier hs-var">c</span></a><span> </span><span class="hs-operator hs-var">+#</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679082284"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-operator hs-var">*#</span><span> </span><span class="hs-number">128</span><span class="hs-operator">#</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">remInt</span><span class="hs-operator hs-var">#</span><span class="hs-special">`</span><span>
</span><a name="line-465"></a><span>                      </span><span class="hs-identifier">hASH_TBL_SIZE</span><span class="hs-operator">#</span><span>
</span><a name="line-466"></a><span>
</span><a name="line-467"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-468"></a><span class="hs-comment">-- Operations</span><span>
</span><a name="line-469"></a><span>
</span><a name="line-470"></a><span class="hs-comment">-- | Returns the length of the 'FastString' in characters</span><span>
</span><a name="line-471"></a><span class="hs-identifier">lengthFS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-472"></a><a name="lengthFS"><a href="FastString.html#lengthFS"><span class="hs-identifier">lengthFS</span></a></a><span> </span><a name="local-6989586621679082288"><a href="#local-6989586621679082288"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">n_chars</span><span> </span><a href="#local-6989586621679082288"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-473"></a><span>
</span><a name="line-474"></a><span class="hs-comment">-- | Returns @True@ if this 'FastString' is not Z-encoded but already has</span><span>
</span><a name="line-475"></a><span class="hs-comment">-- a Z-encoding cached (used in producing stats).</span><span>
</span><a name="line-476"></a><span class="hs-identifier">hasZEncoding</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-477"></a><a name="hasZEncoding"><a href="FastString.html#hasZEncoding"><span class="hs-identifier">hasZEncoding</span></a></a><span> </span><span class="hs-special">(</span><a href="FastString.html#FastString"><span class="hs-identifier hs-var">FastString</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679082289"><a href="#local-6989586621679082289"><span class="hs-identifier">ref</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-478"></a><span>      </span><a href="FastFunctions.html#inlinePerformIO"><span class="hs-identifier hs-var">inlinePerformIO</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-479"></a><span>        </span><a name="local-6989586621679082290"><a href="#local-6989586621679082290"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span> </span><a href="#local-6989586621679082289"><span class="hs-identifier hs-var">ref</span></a><span>
</span><a name="line-480"></a><span>        </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#isJust"><span class="hs-identifier hs-var">isJust</span></a><span> </span><a href="#local-6989586621679082290"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-481"></a><span>
</span><a name="line-482"></a><span class="hs-comment">-- | Returns @True@ if the 'FastString' is empty</span><span>
</span><a name="line-483"></a><span class="hs-identifier">nullFS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-484"></a><a name="nullFS"><a href="FastString.html#nullFS"><span class="hs-identifier">nullFS</span></a></a><span> </span><a name="local-6989586621679082291"><a href="#local-6989586621679082291"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.html#null"><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">null</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fs_bs</span><span> </span><a href="#local-6989586621679082291"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span>
</span><a name="line-485"></a><span>
</span><a name="line-486"></a><span class="hs-comment">-- | Unpacks and decodes the FastString</span><span>
</span><a name="line-487"></a><span class="hs-identifier">unpackFS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span>
</span><a name="line-488"></a><a name="unpackFS"><a href="FastString.html#unpackFS"><span class="hs-identifier">unpackFS</span></a></a><span> </span><span class="hs-special">(</span><a href="FastString.html#FastString"><span class="hs-identifier hs-var">FastString</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679082292"><a href="#local-6989586621679082292"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-489"></a><span>  </span><a href="FastFunctions.html#inlinePerformIO"><span class="hs-identifier hs-var">inlinePerformIO</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.Unsafe.html#unsafeUseAsCStringLen"><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">unsafeUseAsCStringLen</span></a><span> </span><a href="#local-6989586621679082292"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679082293"><a href="#local-6989586621679082293"><span class="hs-identifier">ptr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679082294"><a href="#local-6989586621679082294"><span class="hs-identifier">len</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-490"></a><span>        </span><a href="Encoding.html#utf8DecodeString"><span class="hs-identifier hs-var">utf8DecodeString</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Ptr.html#castPtr"><span class="hs-identifier hs-var">castPtr</span></a><span> </span><a href="#local-6989586621679082293"><span class="hs-identifier hs-var">ptr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679082294"><span class="hs-identifier hs-var">len</span></a><span>
</span><a name="line-491"></a><span>
</span><a name="line-492"></a><span class="hs-comment">-- | Gives the UTF-8 encoded bytes corresponding to a 'FastString'</span><span>
</span><a name="line-493"></a><span class="hs-identifier">bytesFS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a><span class="hs-special">]</span><span>
</span><a name="line-494"></a><a name="bytesFS"><a href="FastString.html#bytesFS"><span class="hs-identifier">bytesFS</span></a></a><span> </span><a name="local-6989586621679082295"><a href="#local-6989586621679082295"><span class="hs-identifier">fs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.html#unpack"><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">unpack</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="FastString.html#fastStringToByteString"><span class="hs-identifier hs-var">fastStringToByteString</span></a><span> </span><a href="#local-6989586621679082295"><span class="hs-identifier hs-var">fs</span></a><span>
</span><a name="line-495"></a><span>
</span><a name="line-496"></a><span class="hs-comment">-- | Returns a Z-encoded version of a 'FastString'.  This might be the</span><span>
</span><a name="line-497"></a><span class="hs-comment">-- original, if it was already Z-encoded.  The first time this</span><span>
</span><a name="line-498"></a><span class="hs-comment">-- function is applied to a particular 'FastString', the results are</span><span>
</span><a name="line-499"></a><span class="hs-comment">-- memoized.</span><span>
</span><a name="line-500"></a><span class="hs-comment">--</span><span>
</span><a name="line-501"></a><span class="hs-identifier">zEncodeFS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#FastZString"><span class="hs-identifier hs-type">FastZString</span></a><span>
</span><a name="line-502"></a><a name="zEncodeFS"><a href="FastString.html#zEncodeFS"><span class="hs-identifier">zEncodeFS</span></a></a><span> </span><a name="local-6989586621679082296"><a href="#local-6989586621679082296"><span class="hs-identifier">fs</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="FastString.html#FastString"><span class="hs-identifier hs-var">FastString</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679082297"><a href="#local-6989586621679082297"><span class="hs-identifier">ref</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-503"></a><span>      </span><a href="FastFunctions.html#inlinePerformIO"><span class="hs-identifier hs-var">inlinePerformIO</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-504"></a><span>        </span><a name="local-6989586621679082298"><a href="#local-6989586621679082298"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span> </span><a href="#local-6989586621679082297"><span class="hs-identifier hs-var">ref</span></a><span>
</span><a name="line-505"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679082298"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-506"></a><span>          </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679082299"><a href="#local-6989586621679082299"><span class="hs-identifier">zfs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679082299"><span class="hs-identifier hs-var">zfs</span></a><span>
</span><a name="line-507"></a><span>          </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-508"></a><span>            </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.IORef.html#atomicModifyIORef%27"><span class="hs-identifier hs-var">atomicModifyIORef'</span></a><span> </span><a href="#local-6989586621679082297"><span class="hs-identifier hs-var">ref</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679082300"><a href="#local-6989586621679082300"><span class="hs-identifier">m'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679082300"><span class="hs-identifier hs-var">m'</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-509"></a><span>              </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679082301"><a href="#local-6989586621679082301"><span class="hs-identifier">zfs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#mkZFastString"><span class="hs-identifier hs-var">mkZFastString</span></a><span> </span><span class="hs-special">(</span><a href="Encoding.html#zEncodeString"><span class="hs-identifier hs-var">zEncodeString</span></a><span> </span><span class="hs-special">(</span><a href="FastString.html#unpackFS"><span class="hs-identifier hs-var">unpackFS</span></a><span> </span><a href="#local-6989586621679082296"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-510"></a><span>                          </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-6989586621679082301"><span class="hs-identifier hs-var">zfs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679082301"><span class="hs-identifier hs-var">zfs</span></a><span class="hs-special">)</span><span>
</span><a name="line-511"></a><span>              </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679082302"><a href="#local-6989586621679082302"><span class="hs-identifier">zfs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679082300"><span class="hs-identifier hs-var">m'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679082302"><span class="hs-identifier hs-var">zfs</span></a><span class="hs-special">)</span><span>
</span><a name="line-512"></a><span>
</span><a name="line-513"></a><span class="hs-identifier">appendFS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>
</span><a name="line-514"></a><a name="appendFS"><a href="FastString.html#appendFS"><span class="hs-identifier">appendFS</span></a></a><span> </span><a name="local-6989586621679082303"><a href="#local-6989586621679082303"><span class="hs-identifier">fs1</span></a></a><span> </span><a name="local-6989586621679082304"><a href="#local-6989586621679082304"><span class="hs-identifier">fs2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#mkFastStringByteString"><span class="hs-identifier hs-var">mkFastStringByteString</span></a><span>
</span><a name="line-515"></a><span>                 </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.html#append"><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">append</span></a><span> </span><span class="hs-special">(</span><a href="FastString.html#fastStringToByteString"><span class="hs-identifier hs-var">fastStringToByteString</span></a><span> </span><a href="#local-6989586621679082303"><span class="hs-identifier hs-var">fs1</span></a><span class="hs-special">)</span><span>
</span><a name="line-516"></a><span>                             </span><span class="hs-special">(</span><a href="FastString.html#fastStringToByteString"><span class="hs-identifier hs-var">fastStringToByteString</span></a><span> </span><a href="#local-6989586621679082304"><span class="hs-identifier hs-var">fs2</span></a><span class="hs-special">)</span><span>
</span><a name="line-517"></a><span>
</span><a name="line-518"></a><span class="hs-identifier">concatFS</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>
</span><a name="line-519"></a><a name="concatFS"><a href="FastString.html#concatFS"><span class="hs-identifier">concatFS</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#mkFastStringByteString"><span class="hs-identifier hs-var">mkFastStringByteString</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.html#concat"><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">concat</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-identifier">fs_bs</span><span>
</span><a name="line-520"></a><span>
</span><a name="line-521"></a><span class="hs-identifier">headFS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Char</span><span>
</span><a name="line-522"></a><a name="headFS"><a href="FastString.html#headFS"><span class="hs-identifier">headFS</span></a></a><span> </span><span class="hs-special">(</span><a href="FastString.html#FastString"><span class="hs-identifier hs-var">FastString</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Panic.html#panic"><span class="hs-identifier hs-var">panic</span></a><span> </span><span class="hs-string">&quot;headFS: Empty FastString&quot;</span><span>
</span><a name="line-523"></a><span class="hs-identifier">headFS</span><span> </span><span class="hs-special">(</span><a href="FastString.html#FastString"><span class="hs-identifier hs-var">FastString</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679082305"><a href="#local-6989586621679082305"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-524"></a><span>  </span><a href="FastFunctions.html#inlinePerformIO"><span class="hs-identifier hs-var">inlinePerformIO</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.Unsafe.html#unsafeUseAsCString"><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">unsafeUseAsCString</span></a><span> </span><a href="#local-6989586621679082305"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679082306"><a href="#local-6989586621679082306"><span class="hs-identifier">ptr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-525"></a><span>         </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a><span> </span><span class="hs-special">(</span><a href="Encoding.html#utf8DecodeChar"><span class="hs-identifier hs-var">utf8DecodeChar</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Ptr.html#castPtr"><span class="hs-identifier hs-var">castPtr</span></a><span> </span><a href="#local-6989586621679082306"><span class="hs-identifier hs-var">ptr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-526"></a><span>
</span><a name="line-527"></a><span class="hs-identifier">tailFS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>
</span><a name="line-528"></a><a name="tailFS"><a href="FastString.html#tailFS"><span class="hs-identifier">tailFS</span></a></a><span> </span><span class="hs-special">(</span><a href="FastString.html#FastString"><span class="hs-identifier hs-var">FastString</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Panic.html#panic"><span class="hs-identifier hs-var">panic</span></a><span> </span><span class="hs-string">&quot;tailFS: Empty FastString&quot;</span><span>
</span><a name="line-529"></a><span class="hs-identifier">tailFS</span><span> </span><span class="hs-special">(</span><a href="FastString.html#FastString"><span class="hs-identifier hs-var">FastString</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679082307"><a href="#local-6989586621679082307"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-530"></a><span>    </span><a href="FastFunctions.html#inlinePerformIO"><span class="hs-identifier hs-var">inlinePerformIO</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.Unsafe.html#unsafeUseAsCString"><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">unsafeUseAsCString</span></a><span> </span><a href="#local-6989586621679082307"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679082308"><a href="#local-6989586621679082308"><span class="hs-identifier">ptr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-531"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679082309"><a href="#local-6989586621679082309"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Encoding.html#utf8DecodeChar"><span class="hs-identifier hs-var">utf8DecodeChar</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Ptr.html#castPtr"><span class="hs-identifier hs-var">castPtr</span></a><span> </span><a href="#local-6989586621679082308"><span class="hs-identifier hs-var">ptr</span></a><span class="hs-special">)</span><span>
</span><a name="line-532"></a><span>       </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24%21"><span class="hs-operator hs-var">$!</span></a><span> </span><a href="FastString.html#mkFastStringByteString"><span class="hs-identifier hs-var">mkFastStringByteString</span></a><span> </span><span class="hs-special">(</span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.html#drop"><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">drop</span></a><span> </span><a href="#local-6989586621679082309"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621679082307"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span>
</span><a name="line-533"></a><span>
</span><a name="line-534"></a><span class="hs-identifier">consFS</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Char</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>
</span><a name="line-535"></a><a name="consFS"><a href="FastString.html#consFS"><span class="hs-identifier">consFS</span></a></a><span> </span><a name="local-6989586621679082310"><a href="#local-6989586621679082310"><span class="hs-identifier">c</span></a></a><span> </span><a name="local-6989586621679082311"><a href="#local-6989586621679082311"><span class="hs-identifier">fs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#mkFastString"><span class="hs-identifier hs-var">mkFastString</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679082310"><span class="hs-identifier hs-var">c</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="FastString.html#unpackFS"><span class="hs-identifier hs-var">unpackFS</span></a><span> </span><a href="#local-6989586621679082311"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">)</span><span>
</span><a name="line-536"></a><span>
</span><a name="line-537"></a><span class="hs-identifier">uniqueOfFS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-538"></a><a name="uniqueOfFS"><a href="FastString.html#uniqueOfFS"><span class="hs-identifier">uniqueOfFS</span></a></a><span> </span><span class="hs-special">(</span><a href="FastString.html#FastString"><span class="hs-identifier hs-var">FastString</span></a><span> </span><a name="local-6989586621679082312"><a href="#local-6989586621679082312"><span class="hs-identifier">u</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679082312"><span class="hs-identifier hs-var">u</span></a><span>
</span><a name="line-539"></a><span>
</span><a name="line-540"></a><span class="hs-identifier">nilFS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>
</span><a name="line-541"></a><a name="nilFS"><a href="FastString.html#nilFS"><span class="hs-identifier">nilFS</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#mkFastString"><span class="hs-identifier hs-var">mkFastString</span></a><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-542"></a><span>
</span><a name="line-543"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-544"></a><span class="hs-comment">-- Stats</span><span>
</span><a name="line-545"></a><span>
</span><a name="line-546"></a><span class="hs-identifier">getFastStringTable</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-547"></a><a name="getFastStringTable"><a href="FastString.html#getFastStringTable"><span class="hs-identifier">getFastStringTable</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-548"></a><span>  </span><a name="local-6989586621679082315"><a href="#local-6989586621679082315"><span class="hs-identifier">buckets</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#forM"><span class="hs-identifier hs-var">forM</span></a><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-glyph">..</span><span> </span><span class="hs-identifier">hASH_TBL_SIZE</span><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">]</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">idx</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-549"></a><span>    </span><a name="local-6989586621679082314"><a href="#local-6989586621679082314"><span class="hs-identifier">bucket</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FastString.html#lookupTbl"><span class="hs-identifier hs-var">lookupTbl</span></a><span> </span><a href="FastString.html#string_table"><span class="hs-identifier hs-var">string_table</span></a><span> </span><a href="#local-6989586621679082313"><span class="hs-identifier hs-var">idx</span></a><span>
</span><a name="line-550"></a><span>    </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span> </span><a href="#local-6989586621679082314"><span class="hs-identifier hs-var">bucket</span></a><span>
</span><a name="line-551"></a><span>  </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679082315"><span class="hs-identifier hs-var">buckets</span></a><span>
</span><a name="line-552"></a><span>
</span><a name="line-553"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-554"></a><span class="hs-comment">-- Outputting 'FastString's</span><span>
</span><a name="line-555"></a><span>
</span><a name="line-556"></a><span class="hs-comment">-- |Outputs a 'FastString' with /no decoding at all/, that is, you</span><span>
</span><a name="line-557"></a><span class="hs-comment">-- get the actual bytes in the 'FastString' written to the 'Handle'.</span><span>
</span><a name="line-558"></a><span class="hs-identifier">hPutFS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IO.Handle.Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-559"></a><a name="hPutFS"><a href="FastString.html#hPutFS"><span class="hs-identifier">hPutFS</span></a></a><span> </span><a name="local-6989586621679082316"><a href="#local-6989586621679082316"><span class="hs-identifier">handle</span></a></a><span> </span><a name="local-6989586621679082317"><a href="#local-6989586621679082317"><span class="hs-identifier">fs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../bytestring-0.10.8.2/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.html#hPut"><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">hPut</span></a><span> </span><a href="#local-6989586621679082316"><span class="hs-identifier hs-var">handle</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="FastString.html#fastStringToByteString"><span class="hs-identifier hs-var">fastStringToByteString</span></a><span> </span><a href="#local-6989586621679082317"><span class="hs-identifier hs-var">fs</span></a><span>
</span><a name="line-560"></a><span>
</span><a name="line-561"></a><span class="hs-comment">-- ToDo: we'll probably want an hPutFSLocal, or something, to output</span><span>
</span><a name="line-562"></a><span class="hs-comment">-- in the current locale's encoding (for error messages and suchlike).</span><span>
</span><a name="line-563"></a><span>
</span><a name="line-564"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-565"></a><span class="hs-comment">-- LitStrings, here for convenience only.</span><span>
</span><a name="line-566"></a><span>
</span><a name="line-567"></a><span class="hs-comment">-- | A 'LitString' is a pointer to some null-terminated array of bytes.</span><span>
</span><a name="line-568"></a><span class="hs-keyword">type</span><span> </span><a name="LitString"><a href="FastString.html#LitString"><span class="hs-identifier">LitString</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a><span>
</span><a name="line-569"></a><span class="hs-comment">--Why do we recalculate length every time it's requested?</span><span>
</span><a name="line-570"></a><span class="hs-comment">--If it's commonly needed, we should perhaps have</span><span>
</span><a name="line-571"></a><span class="hs-comment">--data LitString = LitString {-#UNPACK#-}!Addr# {-#UNPACK#-}!Int#</span><span>
</span><a name="line-572"></a><span>
</span><a name="line-573"></a><span class="hs-comment">-- | Wrap an unboxed address into a 'LitString'.</span><span>
</span><a name="line-574"></a><span class="hs-identifier">mkLitString</span><span class="hs-operator">#</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Addr</span><span class="hs-operator hs-type">#</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#LitString"><span class="hs-identifier hs-type">LitString</span></a><span>
</span><a name="line-575"></a><a name="mkLitString%23"><a href="FastString.html#mkLitString%23"><span class="hs-identifier">mkLitString</span><span class="hs-operator">#</span></a></a><span> </span><a name="local-6989586621679082318"><a href="#local-6989586621679082318"><span class="hs-identifier">a</span><span class="hs-operator">#</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-var">Ptr</span></a><span> </span><a href="#local-6989586621679082318"><span class="hs-identifier hs-var">a</span><span class="hs-operator hs-var">#</span></a><span>
</span><a name="line-576"></a><span>
</span><a name="line-577"></a><span class="hs-comment">-- | Encode a 'String' into a newly allocated 'LitString' using Latin-1</span><span>
</span><a name="line-578"></a><span class="hs-comment">-- encoding.  The original string must not contain non-Latin-1 characters</span><span>
</span><a name="line-579"></a><span class="hs-comment">-- (above codepoint @0xff@).</span><span>
</span><a name="line-580"></a><span class="hs-pragma">{-# INLINE mkLitString #-}</span><span>
</span><a name="line-581"></a><span class="hs-identifier">mkLitString</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#LitString"><span class="hs-identifier hs-type">LitString</span></a><span>
</span><a name="line-582"></a><a name="mkLitString"><a href="FastString.html#mkLitString"><span class="hs-identifier">mkLitString</span></a></a><span> </span><a name="local-6989586621679082319"><a href="#local-6989586621679082319"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-583"></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IO.Unsafe.html#unsafePerformIO"><span class="hs-identifier hs-var">unsafePerformIO</span></a><span> </span><span class="hs-special">(</span><span class="hs-keyword">do</span><span>
</span><a name="line-584"></a><span>   </span><a name="local-6989586621679082371"><a href="#local-6989586621679082371"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Foreign.Marshal.Alloc.html#mallocBytes"><span class="hs-identifier hs-var">mallocBytes</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><a href="#local-6989586621679082319"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-585"></a><span>   </span><span class="hs-keyword">let</span><span>
</span><a name="line-586"></a><span>     </span><span class="hs-identifier">loop</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-587"></a><span>     </span><a name="local-6989586621679082372"><a href="#local-6989586621679082372"><span class="hs-identifier">loop</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679082373"><a href="#local-6989586621679082373"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Foreign.Storable.html#pokeByteOff"><span class="hs-identifier hs-var">pokeByteOff</span></a><span> </span><a href="#local-6989586621679082371"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679082373"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a><span class="hs-special">)</span><span>
</span><a name="line-588"></a><span>     </span><span class="hs-identifier">loop</span><span> </span><a name="local-6989586621679082374"><a href="#local-6989586621679082374"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679082375"><a href="#local-6989586621679082375"><span class="hs-identifier">c</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679082376"><a href="#local-6989586621679082376"><span class="hs-identifier">cs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-589"></a><span>        </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Foreign.Storable.html#pokeByteOff"><span class="hs-identifier hs-var">pokeByteOff</span></a><span> </span><a href="#local-6989586621679082371"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679082374"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#ord"><span class="hs-identifier hs-var">ord</span></a><span> </span><a href="#local-6989586621679082375"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a><span class="hs-special">)</span><span>
</span><a name="line-590"></a><span>        </span><a href="#local-6989586621679082372"><span class="hs-identifier hs-var">loop</span></a><span> </span><span class="hs-special">(</span><span class="hs-number">1</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a><a href="#local-6989586621679082374"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679082376"><span class="hs-identifier hs-var">cs</span></a><span>
</span><a name="line-591"></a><span>   </span><a href="#local-6989586621679082372"><span class="hs-identifier hs-var">loop</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621679082319"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-592"></a><span>   </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679082371"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-593"></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-594"></a><span>
</span><a name="line-595"></a><span class="hs-comment">-- | Decode a 'LitString' back into a 'String' using Latin-1 encoding.</span><span>
</span><a name="line-596"></a><span class="hs-comment">-- This does not free the memory associated with 'LitString'.</span><span>
</span><a name="line-597"></a><span class="hs-identifier">unpackLitString</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#LitString"><span class="hs-identifier hs-type">LitString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span>
</span><a name="line-598"></a><a name="unpackLitString"><a href="FastString.html#unpackLitString"><span class="hs-identifier">unpackLitString</span></a></a><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-var">Ptr</span></a><span> </span><a name="local-6989586621679082377"><a href="#local-6989586621679082377"><span class="hs-identifier">p</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unpackCString</span><span class="hs-operator hs-var">#</span><span> </span><a href="#local-6989586621679082377"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-599"></a><span>
</span><a name="line-600"></a><span class="hs-comment">-- | Compute the length of a 'LitString', which must necessarily be</span><span>
</span><a name="line-601"></a><span class="hs-comment">-- null-terminated.</span><span>
</span><a name="line-602"></a><span class="hs-identifier">lengthLS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#LitString"><span class="hs-identifier hs-type">LitString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-603"></a><a name="lengthLS"><a href="FastString.html#lengthLS"><span class="hs-identifier">lengthLS</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#ptrStrLength"><span class="hs-identifier hs-var">ptrStrLength</span></a><span>
</span><a name="line-604"></a><span>
</span><a name="line-605"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-606"></a><span class="hs-comment">-- under the carpet</span><span>
</span><a name="line-607"></a><span>
</span><a name="line-608"></a><span class="hs-identifier">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ccall</span><span> </span><span class="hs-identifier">unsafe</span><span> </span><span class="hs-string">&quot;ghc_strlen&quot;</span><span>
</span><a name="line-609"></a><span>  </span><span class="hs-identifier">ptrStrLength</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-610"></a><span>
</span><a name="line-611"></a><span class="hs-pragma">{-# NOINLINE sLit #-}</span><span>
</span><a name="line-612"></a><span class="hs-identifier">sLit</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#LitString"><span class="hs-identifier hs-type">LitString</span></a><span>
</span><a name="line-613"></a><a name="sLit"><a href="FastString.html#sLit"><span class="hs-identifier">sLit</span></a></a><span> </span><a name="local-6989586621679082393"><a href="#local-6989586621679082393"><span class="hs-identifier">x</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#mkLitString"><span class="hs-identifier hs-var">mkLitString</span></a><span> </span><a href="#local-6989586621679082393"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-614"></a><span>
</span><a name="line-615"></a><span class="hs-pragma">{-# NOINLINE fsLit #-}</span><span>
</span><a name="line-616"></a><span class="hs-identifier">fsLit</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>
</span><a name="line-617"></a><a name="fsLit"><a href="FastString.html#fsLit"><span class="hs-identifier">fsLit</span></a></a><span> </span><a name="local-6989586621679082394"><a href="#local-6989586621679082394"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#mkFastString"><span class="hs-identifier hs-var">mkFastString</span></a><span> </span><a href="#local-6989586621679082394"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-618"></a><span>
</span><a name="line-619"></a><span class="hs-pragma">{-# RULES &quot;slit&quot;
    forall x . sLit  (unpackCString# x) = mkLitString#  x #-}</span><span>
</span><a name="line-621"></a><span class="hs-pragma">{-# RULES &quot;fslit&quot;
    forall x . fsLit (unpackCString# x) = mkFastString# x #-}</span><span>
</span><a name="line-623"></a></pre></body></html>