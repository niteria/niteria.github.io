<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-comment">{-|
Note [CSE for Stg]
~~~~~~~~~~~~~~~~~~
This module implements a simple common subexpression elimination pass for STG.
This is useful because there are expressions that we want to common up (because
they are operational equivalent), but that we cannot common up in Core, because
their types differ.
This was original reported as #9291.

There are two types of common code occurrences that we aim for, see
note [Case 1: CSEing allocated closures] and
note [Case 2: CSEing case binders] below.


Note [Case 1: CSEing allocated closures]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The fist kind of CSE opportunity we aim for is generated by this Haskell code:

    bar :: a -&gt; (Either Int a, Either Bool a)
    bar x = (Right x, Right x)

which produces this Core:

    bar :: forall a. a -&gt; (Either Int a, Either Bool a)
    bar @a x = (Right @Int @a x, Right @Bool @a x)

where the two components of the tuple are differnt terms, and cannot be
commoned up (easily). On the STG level we have

    bar [x] = let c1 = Right [x]
                  c2 = Right [x]
              in (c1,c2)

and now it is obvious that we can write

    bar [x] = let c1 = Right [x]
              in (c1,c1)

instead.


Note [Case 2: CSEing case binders]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The second kind of CSE opportunity we aim for is more interesting, and
came up in #9291 and #5344: The Haskell code

    foo :: Either Int a -&gt; Either Bool a
    foo (Right x) = Right x
    foo _         = Left False

produces this Core

    foo :: forall a. Either Int a -&gt; Either Bool a
    foo @a e = case e of b { Left n -&gt; &#8230;
                           , Right x -&gt; Right @Bool @a x }

where we cannot CSE `Right @Bool @a x` with the case binder `b` as they have
different types. But in STG we have

    foo [e] = case e of b { Left [n] -&gt; &#8230;
                          , Right [x] -&gt; Right [x] }

and nothing stops us from transforming that to

    foo [e] = case e of b { Left [n] -&gt; &#8230;
                          , Right [x] -&gt; b}

-}</span><span>
</span><a name="line-71"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">StgCse</span><span> </span><span class="hs-special">(</span><a href="StgCse.html#stgCse"><span class="hs-identifier hs-var">stgCse</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-72"></a><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span> </span><a href="DataCon.html"><span class="hs-identifier">DataCon</span></a><span>
</span><a name="line-74"></a><span class="hs-keyword">import</span><span> </span><a href="Id.html"><span class="hs-identifier">Id</span></a><span>
</span><a name="line-75"></a><span class="hs-keyword">import</span><span> </span><a href="StgSyn.html"><span class="hs-identifier">StgSyn</span></a><span>
</span><a name="line-76"></a><span class="hs-keyword">import</span><span> </span><a href="Outputable.html"><span class="hs-identifier">Outputable</span></a><span>
</span><a name="line-77"></a><span class="hs-keyword">import</span><span> </span><a href="VarEnv.html"><span class="hs-identifier">VarEnv</span></a><span>
</span><a name="line-78"></a><span class="hs-keyword">import</span><span> </span><a href="CoreSyn.html"><span class="hs-identifier">CoreSyn</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-79"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.List.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapAccumL"><span class="hs-identifier hs-var">mapAccumL</span></a><span class="hs-special">)</span><span>
</span><a name="line-80"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Maybe</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#fromMaybe"><span class="hs-identifier hs-var">fromMaybe</span></a><span class="hs-special">)</span><span>
</span><a name="line-81"></a><span class="hs-keyword">import</span><span> </span><a href="TrieMap.html"><span class="hs-identifier">TrieMap</span></a><span>
</span><a name="line-82"></a><span class="hs-keyword">import</span><span> </span><a href="NameEnv.html"><span class="hs-identifier">NameEnv</span></a><span>
</span><a name="line-83"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html"><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span></a><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html#%3E%3D%3E"><span class="hs-operator hs-var">&gt;=&gt;</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-84"></a><span>
</span><a name="line-85"></a><span class="hs-comment">--------------</span><span>
</span><a name="line-86"></a><span class="hs-comment">-- The Trie --</span><span>
</span><a name="line-87"></a><span class="hs-comment">--------------</span><span>
</span><a name="line-88"></a><span>
</span><a name="line-89"></a><span class="hs-comment">-- A lookup trie for data constructor applications, i.e.</span><span>
</span><a name="line-90"></a><span class="hs-comment">-- keys of type `(DataCon, [StgArg])`, following the patterns in TrieMap.</span><span>
</span><a name="line-91"></a><span>
</span><a name="line-92"></a><span class="hs-keyword">data</span><span> </span><a name="StgArgMap"><a href="StgCse.html#StgArgMap"><span class="hs-identifier">StgArgMap</span></a></a><span> </span><a name="local-6989586621679377402"><a href="#local-6989586621679377402"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="SAM"><a href="StgCse.html#SAM"><span class="hs-identifier">SAM</span></a></a><span>
</span><a name="line-93"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="sam_var"><a href="StgCse.html#sam_var"><span class="hs-identifier">sam_var</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#DVarEnv"><span class="hs-identifier hs-type">DVarEnv</span></a><span> </span><a href="#local-6989586621679377402"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-94"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="sam_lit"><a href="StgCse.html#sam_lit"><span class="hs-identifier">sam_lit</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="TrieMap.html#LiteralMap"><span class="hs-identifier hs-type">LiteralMap</span></a><span> </span><a href="#local-6989586621679377402"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-95"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-96"></a><span>
</span><a name="line-97"></a><span class="hs-keyword">instance</span><span> </span><a href="TrieMap.html#TrieMap"><span class="hs-identifier hs-type">TrieMap</span></a><span> </span><a href="StgCse.html#StgArgMap"><span class="hs-identifier hs-type">StgArgMap</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-98"></a><span>    </span><span class="hs-keyword">type</span><span> </span><span class="hs-identifier">Key</span><span> </span><a href="StgCse.html#StgArgMap"><span class="hs-identifier hs-type">StgArgMap</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgArg"><span class="hs-identifier hs-type">StgArg</span></a><span>
</span><a name="line-99"></a><span>    </span><a name="local-8214565720324100893"><a href="TrieMap.html#emptyTM"><span class="hs-identifier">emptyTM</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#SAM"><span class="hs-identifier hs-var">SAM</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sam_var</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TrieMap.html#emptyTM"><span class="hs-identifier hs-var">emptyTM</span></a><span>
</span><a name="line-100"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sam_lit</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TrieMap.html#emptyTM"><span class="hs-identifier hs-var">emptyTM</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-101"></a><span>    </span><a name="local-8214565720324100894"><a href="TrieMap.html#lookupTM"><span class="hs-identifier">lookupTM</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgVarArg"><span class="hs-identifier hs-var">StgVarArg</span></a><span> </span><a name="local-6989586621679377411"><a href="#local-6989586621679377411"><span class="hs-identifier">var</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">sam_var</span><span> </span><a href="TrieMap.html#%3E.%3E"><span class="hs-operator hs-var">&gt;.&gt;</span></a><span> </span><a href="TrieMap.html#lkDFreeVar"><span class="hs-identifier hs-var">lkDFreeVar</span></a><span> </span><a href="#local-6989586621679377411"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-102"></a><span>    </span><span class="hs-identifier">lookupTM</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgLitArg"><span class="hs-identifier hs-var">StgLitArg</span></a><span> </span><a name="local-6989586621679377412"><a href="#local-6989586621679377412"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">sam_lit</span><span> </span><a href="TrieMap.html#%3E.%3E"><span class="hs-operator hs-var">&gt;.&gt;</span></a><span> </span><a href="TrieMap.html#lookupTM"><span class="hs-identifier hs-var">lookupTM</span></a><span> </span><a href="#local-6989586621679377412"><span class="hs-identifier hs-var">lit</span></a><span>
</span><a name="line-103"></a><span>    </span><a name="local-8214565720324100895"><a href="TrieMap.html#alterTM"><span class="hs-identifier">alterTM</span></a></a><span>  </span><span class="hs-special">(</span><a href="StgSyn.html#StgVarArg"><span class="hs-identifier hs-var">StgVarArg</span></a><span> </span><a name="local-6989586621679377413"><a href="#local-6989586621679377413"><span class="hs-identifier">var</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679377414"><a href="#local-6989586621679377414"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679377415"><a href="#local-6989586621679377415"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679377415"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sam_var</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">sam_var</span><span> </span><a href="#local-6989586621679377415"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="TrieMap.html#%7C%3E"><span class="hs-operator hs-var">|&gt;</span></a><span> </span><a href="TrieMap.html#xtDFreeVar"><span class="hs-identifier hs-var">xtDFreeVar</span></a><span> </span><a href="#local-6989586621679377413"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621679377414"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-104"></a><span>    </span><span class="hs-identifier">alterTM</span><span>  </span><span class="hs-special">(</span><a href="StgSyn.html#StgLitArg"><span class="hs-identifier hs-var">StgLitArg</span></a><span> </span><a name="local-6989586621679377416"><a href="#local-6989586621679377416"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679377417"><a href="#local-6989586621679377417"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679377418"><a href="#local-6989586621679377418"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679377418"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sam_lit</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">sam_lit</span><span> </span><a href="#local-6989586621679377418"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="TrieMap.html#%7C%3E"><span class="hs-operator hs-var">|&gt;</span></a><span> </span><a href="TrieMap.html#alterTM"><span class="hs-identifier hs-var">alterTM</span></a><span> </span><a href="#local-6989586621679377416"><span class="hs-identifier hs-var">lit</span></a><span> </span><a href="#local-6989586621679377417"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-105"></a><span>    </span><a name="local-8214565720324100897"><a href="TrieMap.html#foldTM"><span class="hs-identifier">foldTM</span></a></a><span> </span><a name="local-6989586621679377419"><a href="#local-6989586621679377419"><span class="hs-identifier">k</span></a></a><span> </span><a name="local-6989586621679377420"><a href="#local-6989586621679377420"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TrieMap.html#foldTM"><span class="hs-identifier hs-var">foldTM</span></a><span> </span><a href="#local-6989586621679377419"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">sam_var</span><span> </span><a href="#local-6989586621679377420"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="TrieMap.html#foldTM"><span class="hs-identifier hs-var">foldTM</span></a><span> </span><a href="#local-6989586621679377419"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">sam_lit</span><span> </span><a href="#local-6989586621679377420"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-106"></a><span>    </span><a name="local-8214565720324100896"><a href="TrieMap.html#mapTM"><span class="hs-identifier">mapTM</span></a></a><span> </span><a name="local-6989586621679377421"><a href="#local-6989586621679377421"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="StgCse.html#SAM"><span class="hs-identifier hs-var">SAM</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">sam_var</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679377422"><a href="#local-6989586621679377422"><span class="hs-identifier">varm</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sam_lit</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679377423"><a href="#local-6989586621679377423"><span class="hs-identifier">litm</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-107"></a><span>        </span><a href="StgCse.html#SAM"><span class="hs-identifier hs-var">SAM</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sam_var</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TrieMap.html#mapTM"><span class="hs-identifier hs-var">mapTM</span></a><span> </span><a href="#local-6989586621679377421"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679377422"><span class="hs-identifier hs-var">varm</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sam_lit</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TrieMap.html#mapTM"><span class="hs-identifier hs-var">mapTM</span></a><span> </span><a href="#local-6989586621679377421"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679377423"><span class="hs-identifier hs-var">litm</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-108"></a><span>
</span><a name="line-109"></a><span class="hs-keyword">newtype</span><span> </span><a name="ConAppMap"><a href="StgCse.html#ConAppMap"><span class="hs-identifier">ConAppMap</span></a></a><span> </span><a name="local-6989586621679377401"><a href="#local-6989586621679377401"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="CAM"><a href="StgCse.html#CAM"><span class="hs-identifier">CAM</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="un_cam"><a href="StgCse.html#un_cam"><span class="hs-identifier">un_cam</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="NameEnv.html#DNameEnv"><span class="hs-identifier hs-type">DNameEnv</span></a><span> </span><span class="hs-special">(</span><a href="TrieMap.html#ListMap"><span class="hs-identifier hs-type">ListMap</span></a><span> </span><a href="StgCse.html#StgArgMap"><span class="hs-identifier hs-type">StgArgMap</span></a><span> </span><a href="#local-6989586621679377401"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-110"></a><span>
</span><a name="line-111"></a><span class="hs-keyword">instance</span><span> </span><a href="TrieMap.html#TrieMap"><span class="hs-identifier hs-type">TrieMap</span></a><span> </span><a href="StgCse.html#ConAppMap"><span class="hs-identifier hs-type">ConAppMap</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-112"></a><span>    </span><span class="hs-keyword">type</span><span> </span><span class="hs-identifier">Key</span><span> </span><a href="StgCse.html#ConAppMap"><span class="hs-identifier hs-type">ConAppMap</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgArg"><span class="hs-identifier hs-type">StgArg</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-113"></a><span>    </span><a name="local-8214565720324100893"><a href="TrieMap.html#emptyTM"><span class="hs-identifier">emptyTM</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#CAM"><span class="hs-identifier hs-var">CAM</span></a><span> </span><a href="TrieMap.html#emptyTM"><span class="hs-identifier hs-var">emptyTM</span></a><span>
</span><a name="line-114"></a><span>    </span><a name="local-8214565720324100894"><a href="TrieMap.html#lookupTM"><span class="hs-identifier">lookupTM</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679377403"><a href="#local-6989586621679377403"><span class="hs-identifier">dataCon</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679377404"><a href="#local-6989586621679377404"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">un_cam</span><span> </span><a href="TrieMap.html#%3E.%3E"><span class="hs-operator hs-var">&gt;.&gt;</span></a><span> </span><a href="TrieMap.html#lkDNamed"><span class="hs-identifier hs-var">lkDNamed</span></a><span> </span><a href="#local-6989586621679377403"><span class="hs-identifier hs-var">dataCon</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html#%3E%3D%3E"><span class="hs-operator hs-var">&gt;=&gt;</span></a><span> </span><a href="TrieMap.html#lookupTM"><span class="hs-identifier hs-var">lookupTM</span></a><span> </span><a href="#local-6989586621679377404"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-115"></a><span>    </span><a name="local-8214565720324100895"><a href="TrieMap.html#alterTM"><span class="hs-identifier">alterTM</span></a></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679377405"><a href="#local-6989586621679377405"><span class="hs-identifier">dataCon</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679377406"><a href="#local-6989586621679377406"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679377407"><a href="#local-6989586621679377407"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679377408"><a href="#local-6989586621679377408"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-116"></a><span>        </span><a href="#local-6989586621679377408"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">un_cam</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">un_cam</span><span> </span><a href="#local-6989586621679377408"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="TrieMap.html#%7C%3E"><span class="hs-operator hs-var">|&gt;</span></a><span> </span><a href="TrieMap.html#xtDNamed"><span class="hs-identifier hs-var">xtDNamed</span></a><span> </span><a href="#local-6989586621679377405"><span class="hs-identifier hs-var">dataCon</span></a><span> </span><a href="TrieMap.html#%7C%3E%3E"><span class="hs-operator hs-var">|&gt;&gt;</span></a><span> </span><a href="TrieMap.html#alterTM"><span class="hs-identifier hs-var">alterTM</span></a><span> </span><a href="#local-6989586621679377406"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621679377407"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-117"></a><span>    </span><a name="local-8214565720324100897"><a href="TrieMap.html#foldTM"><span class="hs-identifier">foldTM</span></a></a><span> </span><a name="local-6989586621679377409"><a href="#local-6989586621679377409"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">un_cam</span><span> </span><a href="TrieMap.html#%3E.%3E"><span class="hs-operator hs-var">&gt;.&gt;</span></a><span> </span><a href="TrieMap.html#foldTM"><span class="hs-identifier hs-var">foldTM</span></a><span> </span><span class="hs-special">(</span><a href="TrieMap.html#foldTM"><span class="hs-identifier hs-var">foldTM</span></a><span> </span><a href="#local-6989586621679377409"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">)</span><span>
</span><a name="line-118"></a><span>    </span><a name="local-8214565720324100896"><a href="TrieMap.html#mapTM"><span class="hs-identifier">mapTM</span></a></a><span> </span><a name="local-6989586621679377410"><a href="#local-6989586621679377410"><span class="hs-identifier">f</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">un_cam</span><span> </span><a href="TrieMap.html#%3E.%3E"><span class="hs-operator hs-var">&gt;.&gt;</span></a><span> </span><a href="TrieMap.html#mapTM"><span class="hs-identifier hs-var">mapTM</span></a><span> </span><span class="hs-special">(</span><a href="TrieMap.html#mapTM"><span class="hs-identifier hs-var">mapTM</span></a><span> </span><a href="#local-6989586621679377410"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span> </span><a href="TrieMap.html#%3E.%3E"><span class="hs-operator hs-var">&gt;.&gt;</span></a><span> </span><a href="StgCse.html#CAM"><span class="hs-identifier hs-var">CAM</span></a><span>
</span><a name="line-119"></a><span>
</span><a name="line-120"></a><span class="hs-comment">-----------------</span><span>
</span><a name="line-121"></a><span class="hs-comment">-- The CSE Env --</span><span>
</span><a name="line-122"></a><span class="hs-comment">-----------------</span><span>
</span><a name="line-123"></a><span>
</span><a name="line-124"></a><span class="hs-comment">-- | The CSE environment. See note [CseEnv Example]</span><span>
</span><a name="line-125"></a><span class="hs-keyword">data</span><span> </span><a name="CseEnv"><a href="StgCse.html#CseEnv"><span class="hs-identifier">CseEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="CseEnv"><a href="StgCse.html#CseEnv"><span class="hs-identifier">CseEnv</span></a></a><span>
</span><a name="line-126"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="ce_conAppMap"><a href="StgCse.html#ce_conAppMap"><span class="hs-identifier">ce_conAppMap</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCse.html#ConAppMap"><span class="hs-identifier hs-type">ConAppMap</span></a><span> </span><a href="Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a><span>
</span><a name="line-127"></a><span>        </span><span class="hs-comment">-- ^ The main component of the environment is the trie that maps</span><span>
</span><a name="line-128"></a><span>        </span><span class="hs-comment">--   data constructor applications (with their `OutId` arguments)</span><span>
</span><a name="line-129"></a><span>        </span><span class="hs-comment">--   to an in-scope name that can be used instead.</span><span>
</span><a name="line-130"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="ce_renaming"><a href="StgCse.html#ce_renaming"><span class="hs-identifier">ce_renaming</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#IdEnv"><span class="hs-identifier hs-type">IdEnv</span></a><span> </span><a href="Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a><span>
</span><a name="line-131"></a><span>        </span><span class="hs-comment">-- ^ CSE is simple to implement (and reason about) when there is no</span><span>
</span><a name="line-132"></a><span>        </span><span class="hs-comment">--   shadowing. Unfortunately, we have to cope with shadowing</span><span>
</span><a name="line-133"></a><span>        </span><span class="hs-comment">--   (see Note [Shadowing]). So we morally do a separate renaming pass</span><span>
</span><a name="line-134"></a><span>        </span><span class="hs-comment">--   before CSE, and practically do both passes in one traversal of the tree.</span><span>
</span><a name="line-135"></a><span>        </span><span class="hs-comment">--   It still causes less confusion to keep the renaming substitution</span><span>
</span><a name="line-136"></a><span>        </span><span class="hs-comment">--   and the substitutions due to CSE separate.</span><span>
</span><a name="line-137"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="ce_subst"><a href="StgCse.html#ce_subst"><span class="hs-identifier">ce_subst</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#IdEnv"><span class="hs-identifier hs-type">IdEnv</span></a><span> </span><a href="Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a><span>
</span><a name="line-138"></a><span>        </span><span class="hs-comment">-- ^ This substitution contains CSE-specific entries. The domain are</span><span>
</span><a name="line-139"></a><span>        </span><span class="hs-comment">--   OutIds, so ce_renaming has to be applied first.</span><span>
</span><a name="line-140"></a><span>        </span><span class="hs-comment">--   It has an entry x &#8614; y when a let-binding `let x = Con y` is</span><span>
</span><a name="line-141"></a><span>        </span><span class="hs-comment">--   removed because `let y = Con z` is in scope.</span><span>
</span><a name="line-142"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-143"></a><span>        </span><span class="hs-comment">--   Both substitutions are applied to data constructor arguments</span><span>
</span><a name="line-144"></a><span>        </span><span class="hs-comment">--   before these are looked up in the conAppMap.</span><span>
</span><a name="line-145"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="ce_in_scope"><a href="StgCse.html#ce_in_scope"><span class="hs-identifier">ce_in_scope</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a><span>
</span><a name="line-146"></a><span>        </span><span class="hs-comment">-- ^ The third component is an in-scope set, to rename away any</span><span>
</span><a name="line-147"></a><span>        </span><span class="hs-comment">--   shadowing binders</span><span>
</span><a name="line-148"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-149"></a><span>
</span><a name="line-150"></a><span class="hs-comment">{-|
Note [CseEnv Example]
~~~~~~~~~~~~~~~~~~~~~
The following tables shows how the CseEnvironment changes as code is traversed,
as well as the changes to that code.

  InExpr                                    OutExpr
     conAppMap                   renaming   subst          in_scope
  &#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;
  -- empty                       {}         {}             {}
  case &#8230; as a of {Con x y -&gt;                case &#8230; as a of {Con x y -&gt;
  -- Con x y &#8614; a                 {}         {}             {a,x,y}
  let b = Con x y                           (removed)
  -- Con x y &#8614; a                 {}         b&#8614;a            {a,x,y,b}
  let c = Bar a                             let c = Bar a
  -- Con x y &#8614; a, Bar a &#8614; c      {}         b&#8614;a            {a,x,y,b,c}
  let c = some expression                   let c' = some expression
  -- Con x y &#8614; a, Bar a &#8614; c      c&#8614;c'       b&#8614;a            {a,x,y,b,c,c'}
  let d = Bar b                             (removed)
  -- Con x y &#8614; a, Bar a &#8614; c      c&#8614;c'       b&#8614;a, d&#8614;c       {a,x,y,b,c,c',d}
  (a, b, c d)                               (a, a, c' c)
-}</span><span>
</span><a name="line-172"></a><span>
</span><a name="line-173"></a><span class="hs-identifier">initEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span>
</span><a name="line-174"></a><a name="initEnv"><a href="StgCse.html#initEnv"><span class="hs-identifier">initEnv</span></a></a><span> </span><a name="local-6989586621679377427"><a href="#local-6989586621679377427"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-var">CseEnv</span></a><span>
</span><a name="line-175"></a><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ce_conAppMap</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TrieMap.html#emptyTM"><span class="hs-identifier hs-var">emptyTM</span></a><span>
</span><a name="line-176"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ce_renaming</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span>
</span><a name="line-177"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ce_subst</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span>
</span><a name="line-178"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ce_in_scope</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679377427"><span class="hs-identifier hs-var">in_scope</span></a><span>
</span><a name="line-179"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-180"></a><span>
</span><a name="line-181"></a><span class="hs-identifier">envLookup</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#OutStgArg"><span class="hs-identifier hs-type">OutStgArg</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a><span>
</span><a name="line-182"></a><a name="envLookup"><a href="StgCse.html#envLookup"><span class="hs-identifier">envLookup</span></a></a><span> </span><a name="local-6989586621679377428"><a href="#local-6989586621679377428"><span class="hs-identifier">dataCon</span></a></a><span> </span><a name="local-6989586621679377429"><a href="#local-6989586621679377429"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621679377430"><a href="#local-6989586621679377430"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TrieMap.html#lookupTM"><span class="hs-identifier hs-var">lookupTM</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679377428"><span class="hs-identifier hs-var">dataCon</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679377429"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ce_conAppMap</span><span> </span><a href="#local-6989586621679377430"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-183"></a><span>
</span><a name="line-184"></a><span class="hs-identifier">addDataCon</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#OutStgArg"><span class="hs-identifier hs-type">OutStgArg</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span>
</span><a name="line-185"></a><span class="hs-comment">-- do not bother with nullary data constructors, they are static anyways</span><span>
</span><a name="line-186"></a><a name="addDataCon"><a href="StgCse.html#addDataCon"><span class="hs-identifier">addDataCon</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621679377431"><a href="#local-6989586621679377431"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679377431"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-187"></a><span class="hs-identifier">addDataCon</span><span> </span><a name="local-6989586621679377432"><a href="#local-6989586621679377432"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621679377433"><a href="#local-6989586621679377433"><span class="hs-identifier">dataCon</span></a></a><span> </span><a name="local-6989586621679377434"><a href="#local-6989586621679377434"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621679377435"><a href="#local-6989586621679377435"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679377435"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ce_conAppMap</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679377436"><span class="hs-identifier hs-var">new_env</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-188"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-189"></a><span>    </span><a name="local-6989586621679377436"><a href="#local-6989586621679377436"><span class="hs-identifier">new_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TrieMap.html#insertTM"><span class="hs-identifier hs-var">insertTM</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679377433"><span class="hs-identifier hs-var">dataCon</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679377434"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679377432"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ce_conAppMap</span><span> </span><a href="#local-6989586621679377435"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-190"></a><span>
</span><a name="line-191"></a><span class="hs-identifier">forgetCse</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span>
</span><a name="line-192"></a><a name="forgetCse"><a href="StgCse.html#forgetCse"><span class="hs-identifier">forgetCse</span></a></a><span> </span><a name="local-6989586621679377437"><a href="#local-6989586621679377437"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679377437"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ce_conAppMap</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TrieMap.html#emptyTM"><span class="hs-identifier hs-var">emptyTM</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-193"></a><span>    </span><span class="hs-comment">-- See note [Free variables of an StgClosure]</span><span>
</span><a name="line-194"></a><span>
</span><a name="line-195"></a><span class="hs-identifier">addSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span>
</span><a name="line-196"></a><a name="addSubst"><a href="StgCse.html#addSubst"><span class="hs-identifier">addSubst</span></a></a><span> </span><a name="local-6989586621679377438"><a href="#local-6989586621679377438"><span class="hs-identifier">from</span></a></a><span> </span><a name="local-6989586621679377439"><a href="#local-6989586621679377439"><span class="hs-identifier">to</span></a></a><span> </span><a name="local-6989586621679377440"><a href="#local-6989586621679377440"><span class="hs-identifier">env</span></a></a><span>
</span><a name="line-197"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679377440"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ce_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ce_subst</span><span> </span><a href="#local-6989586621679377440"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679377438"><span class="hs-identifier hs-var">from</span></a><span> </span><a href="#local-6989586621679377439"><span class="hs-identifier hs-var">to</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-198"></a><span>
</span><a name="line-199"></a><span class="hs-identifier">substArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#InStgArg"><span class="hs-identifier hs-type">InStgArg</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#OutStgArg"><span class="hs-identifier hs-type">OutStgArg</span></a><span class="hs-special">]</span><span>
</span><a name="line-200"></a><a name="substArgs"><a href="StgCse.html#substArgs"><span class="hs-identifier">substArgs</span></a></a><span> </span><a name="local-6989586621679377441"><a href="#local-6989586621679377441"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><a href="StgCse.html#substArg"><span class="hs-identifier hs-var">substArg</span></a><span> </span><a href="#local-6989586621679377441"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-201"></a><span>
</span><a name="line-202"></a><span class="hs-identifier">substArg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#InStgArg"><span class="hs-identifier hs-type">InStgArg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#OutStgArg"><span class="hs-identifier hs-type">OutStgArg</span></a><span>
</span><a name="line-203"></a><a name="substArg"><a href="StgCse.html#substArg"><span class="hs-identifier">substArg</span></a></a><span> </span><a name="local-6989586621679377442"><a href="#local-6989586621679377442"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgVarArg"><span class="hs-identifier hs-var">StgVarArg</span></a><span> </span><a name="local-6989586621679377443"><a href="#local-6989586621679377443"><span class="hs-identifier">from</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgVarArg"><span class="hs-identifier hs-var">StgVarArg</span></a><span> </span><span class="hs-special">(</span><a href="StgCse.html#substVar"><span class="hs-identifier hs-var">substVar</span></a><span> </span><a href="#local-6989586621679377442"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679377443"><span class="hs-identifier hs-var">from</span></a><span class="hs-special">)</span><span>
</span><a name="line-204"></a><span class="hs-identifier">substArg</span><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-special">(</span><a href="StgSyn.html#StgLitArg"><span class="hs-identifier hs-var">StgLitArg</span></a><span> </span><a name="local-6989586621679377444"><a href="#local-6989586621679377444"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgLitArg"><span class="hs-identifier hs-var">StgLitArg</span></a><span> </span><a href="#local-6989586621679377444"><span class="hs-identifier hs-var">lit</span></a><span>
</span><a name="line-205"></a><span>
</span><a name="line-206"></a><span class="hs-identifier">substVars</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#InId"><span class="hs-identifier hs-type">InId</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a><span class="hs-special">]</span><span>
</span><a name="line-207"></a><a name="substVars"><a href="StgCse.html#substVars"><span class="hs-identifier">substVars</span></a></a><span> </span><a name="local-6989586621679377445"><a href="#local-6989586621679377445"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><a href="StgCse.html#substVar"><span class="hs-identifier hs-var">substVar</span></a><span> </span><a href="#local-6989586621679377445"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-208"></a><span>
</span><a name="line-209"></a><span class="hs-identifier">substVar</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#InId"><span class="hs-identifier hs-type">InId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a><span>
</span><a name="line-210"></a><a name="substVar"><a href="StgCse.html#substVar"><span class="hs-identifier">substVar</span></a></a><span> </span><a name="local-6989586621679377446"><a href="#local-6989586621679377446"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679377447"><a href="#local-6989586621679377447"><span class="hs-identifier">id0</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679377449"><span class="hs-identifier hs-var">id2</span></a><span>
</span><a name="line-211"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-212"></a><span>    </span><a name="local-6989586621679377448"><a href="#local-6989586621679377448"><span class="hs-identifier">id1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#fromMaybe"><span class="hs-identifier hs-var">fromMaybe</span></a><span> </span><a href="#local-6989586621679377447"><span class="hs-identifier hs-var">id0</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="VarEnv.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ce_renaming</span><span> </span><a href="#local-6989586621679377446"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679377447"><span class="hs-identifier hs-var">id0</span></a><span>
</span><a name="line-213"></a><span>    </span><a name="local-6989586621679377449"><a href="#local-6989586621679377449"><span class="hs-identifier">id2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#fromMaybe"><span class="hs-identifier hs-var">fromMaybe</span></a><span> </span><a href="#local-6989586621679377448"><span class="hs-identifier hs-var">id1</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="VarEnv.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ce_subst</span><span> </span><a href="#local-6989586621679377446"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>    </span><a href="#local-6989586621679377448"><span class="hs-identifier hs-var">id1</span></a><span>
</span><a name="line-214"></a><span>
</span><a name="line-215"></a><span class="hs-comment">-- Functions to enter binders</span><span>
</span><a name="line-216"></a><span>
</span><a name="line-217"></a><span class="hs-comment">-- This is much simpler than the requivalent code in CoreSubst:</span><span>
</span><a name="line-218"></a><span class="hs-comment">--  * We do not substitute type variables, and</span><span>
</span><a name="line-219"></a><span class="hs-comment">--  * There is nothing relevant in IdInfo at this stage</span><span>
</span><a name="line-220"></a><span class="hs-comment">--    that needs substitutions.</span><span>
</span><a name="line-221"></a><span class="hs-comment">-- Therefore, no special treatment for a recursive group is required.</span><span>
</span><a name="line-222"></a><span>
</span><a name="line-223"></a><span class="hs-identifier">substBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#InId"><span class="hs-identifier hs-type">InId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a><span class="hs-special">)</span><span>
</span><a name="line-224"></a><a name="substBndr"><a href="StgCse.html#substBndr"><span class="hs-identifier">substBndr</span></a></a><span> </span><a name="local-6989586621679377450"><a href="#local-6989586621679377450"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679377451"><a href="#local-6989586621679377451"><span class="hs-identifier">old_id</span></a></a><span>
</span><a name="line-225"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679377455"><span class="hs-identifier hs-var">new_env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679377452"><span class="hs-identifier hs-var">new_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-226"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-227"></a><span>    </span><a name="local-6989586621679377452"><a href="#local-6989586621679377452"><span class="hs-identifier">new_id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#uniqAway"><span class="hs-identifier hs-var">uniqAway</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ce_in_scope</span><span> </span><a href="#local-6989586621679377450"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679377451"><span class="hs-identifier hs-var">old_id</span></a><span>
</span><a name="line-228"></a><span>    </span><a name="local-6989586621679377453"><a href="#local-6989586621679377453"><span class="hs-identifier">no_change</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679377452"><span class="hs-identifier hs-var">new_id</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679377451"><span class="hs-identifier hs-var">old_id</span></a><span>
</span><a name="line-229"></a><span>    </span><a name="local-6989586621679377454"><a href="#local-6989586621679377454"><span class="hs-identifier">env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679377450"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ce_in_scope</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ce_in_scope</span><span> </span><a href="#local-6989586621679377450"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#extendInScopeSet"><span class="hs-identifier hs-var">extendInScopeSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679377452"><span class="hs-identifier hs-var">new_id</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-230"></a><span>    </span><a name="local-6989586621679377455"><a href="#local-6989586621679377455"><span class="hs-identifier">new_env</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679377453"><span class="hs-identifier hs-var">no_change</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679377454"><span class="hs-identifier hs-var">env'</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ce_renaming</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ce_subst</span><span> </span><a href="#local-6989586621679377450"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679377451"><span class="hs-identifier hs-var">old_id</span></a><span> </span><a href="#local-6989586621679377452"><span class="hs-identifier hs-var">new_id</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-231"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679377454"><span class="hs-identifier hs-var">env'</span></a><span>
</span><a name="line-232"></a><span>
</span><a name="line-233"></a><span class="hs-identifier">substBndrs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#InVar"><span class="hs-identifier hs-type">InVar</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Var.html#OutVar"><span class="hs-identifier hs-type">OutVar</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-234"></a><a name="substBndrs"><a href="StgCse.html#substBndrs"><span class="hs-identifier">substBndrs</span></a></a><span> </span><a name="local-6989586621679377456"><a href="#local-6989586621679377456"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679377457"><a href="#local-6989586621679377457"><span class="hs-identifier">bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapAccumL"><span class="hs-identifier hs-var">mapAccumL</span></a><span> </span><a href="StgCse.html#substBndr"><span class="hs-identifier hs-var">substBndr</span></a><span> </span><a href="#local-6989586621679377456"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679377457"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-235"></a><span>
</span><a name="line-236"></a><span class="hs-identifier">substPairs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Var.html#InVar"><span class="hs-identifier hs-type">InVar</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679377426"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Var.html#OutVar"><span class="hs-identifier hs-type">OutVar</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679377426"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-237"></a><a name="substPairs"><a href="StgCse.html#substPairs"><span class="hs-identifier">substPairs</span></a></a><span> </span><a name="local-6989586621679377458"><a href="#local-6989586621679377458"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679377459"><a href="#local-6989586621679377459"><span class="hs-identifier">bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapAccumL"><span class="hs-identifier hs-var">mapAccumL</span></a><span> </span><a href="#local-6989586621679377460"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679377458"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679377459"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-238"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679377460"><a href="#local-6989586621679377460"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621679377461"><a href="#local-6989586621679377461"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679377462"><a href="#local-6989586621679377462"><span class="hs-identifier">id</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679377463"><a href="#local-6989586621679377463"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679377464"><a href="#local-6989586621679377464"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679377465"><a href="#local-6989586621679377465"><span class="hs-identifier">id'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#substBndr"><span class="hs-identifier hs-var">substBndr</span></a><span> </span><a href="#local-6989586621679377461"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679377462"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-239"></a><span>                         </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679377464"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679377465"><span class="hs-identifier hs-var">id'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679377463"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-240"></a><span>
</span><a name="line-241"></a><span class="hs-comment">-- Main entry point</span><span>
</span><a name="line-242"></a><span>
</span><a name="line-243"></a><span class="hs-identifier">stgCse</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#InStgTopBinding"><span class="hs-identifier hs-type">InStgTopBinding</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#OutStgTopBinding"><span class="hs-identifier hs-type">OutStgTopBinding</span></a><span class="hs-special">]</span><span>
</span><a name="line-244"></a><a name="stgCse"><a href="StgCse.html#stgCse"><span class="hs-identifier">stgCse</span></a></a><span> </span><a name="local-6989586621679377466"><a href="#local-6989586621679377466"><span class="hs-identifier">binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#snd"><span class="hs-identifier hs-var">snd</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapAccumL"><span class="hs-identifier hs-var">mapAccumL</span></a><span> </span><a href="StgCse.html#stgCseTopLvl"><span class="hs-identifier hs-var">stgCseTopLvl</span></a><span> </span><a href="VarEnv.html#emptyInScopeSet"><span class="hs-identifier hs-var">emptyInScopeSet</span></a><span> </span><a href="#local-6989586621679377466"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-245"></a><span>
</span><a name="line-246"></a><span class="hs-comment">-- Top level bindings.</span><span>
</span><a name="line-247"></a><span class="hs-comment">--</span><span>
</span><a name="line-248"></a><span class="hs-comment">-- We do not CSE these, as top-level closures are allocated statically anyways.</span><span>
</span><a name="line-249"></a><span class="hs-comment">-- Also, they might be exported.</span><span>
</span><a name="line-250"></a><span class="hs-comment">-- But we still have to collect the set of in-scope variables, otherwise</span><span>
</span><a name="line-251"></a><span class="hs-comment">-- uniqAway might shadow a top-level closure.</span><span>
</span><a name="line-252"></a><span>
</span><a name="line-253"></a><span class="hs-identifier">stgCseTopLvl</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#InStgTopBinding"><span class="hs-identifier hs-type">InStgTopBinding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="VarEnv.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a><span class="hs-special">,</span><span> </span><a href="StgSyn.html#OutStgTopBinding"><span class="hs-identifier hs-type">OutStgTopBinding</span></a><span class="hs-special">)</span><span>
</span><a name="line-254"></a><a name="stgCseTopLvl"><a href="StgCse.html#stgCseTopLvl"><span class="hs-identifier">stgCseTopLvl</span></a></a><span> </span><a name="local-6989586621679377467"><a href="#local-6989586621679377467"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-6989586621679377468"><a href="#local-6989586621679377468"><span class="hs-identifier">t</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="StgSyn.html#StgTopStringLit"><span class="hs-identifier hs-var">StgTopStringLit</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679377467"><span class="hs-identifier hs-var">in_scope</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679377468"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-255"></a><span class="hs-identifier">stgCseTopLvl</span><span> </span><a name="local-6989586621679377469"><a href="#local-6989586621679377469"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgTopLifted"><span class="hs-identifier hs-var">StgTopLifted</span></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgNonRec"><span class="hs-identifier hs-var">StgNonRec</span></a><span> </span><a name="local-6989586621679377470"><a href="#local-6989586621679377470"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621679377471"><a href="#local-6989586621679377471"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-256"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679377472"><span class="hs-identifier hs-var">in_scope'</span></a><span>
</span><a name="line-257"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="StgSyn.html#StgTopLifted"><span class="hs-identifier hs-var">StgTopLifted</span></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgNonRec"><span class="hs-identifier hs-var">StgNonRec</span></a><span> </span><a href="#local-6989586621679377470"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-special">(</span><a href="StgCse.html#stgCseTopLvlRhs"><span class="hs-identifier hs-var">stgCseTopLvlRhs</span></a><span> </span><a href="#local-6989586621679377469"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-6989586621679377471"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-258"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679377472"><a href="#local-6989586621679377472"><span class="hs-identifier">in_scope'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679377469"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#extendInScopeSet"><span class="hs-identifier hs-var">extendInScopeSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679377470"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-259"></a><span>
</span><a name="line-260"></a><span class="hs-identifier">stgCseTopLvl</span><span> </span><a name="local-6989586621679377473"><a href="#local-6989586621679377473"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgTopLifted"><span class="hs-identifier hs-var">StgTopLifted</span></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgRec"><span class="hs-identifier hs-var">StgRec</span></a><span> </span><a name="local-6989586621679377474"><a href="#local-6989586621679377474"><span class="hs-identifier">eqs</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-261"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621679377475"><span class="hs-identifier hs-var">in_scope'</span></a><span>
</span><a name="line-262"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="StgSyn.html#StgTopLifted"><span class="hs-identifier hs-var">StgTopLifted</span></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgRec"><span class="hs-identifier hs-var">StgRec</span></a><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679377477"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">,</span><span> </span><a href="StgCse.html#stgCseTopLvlRhs"><span class="hs-identifier hs-var">stgCseTopLvlRhs</span></a><span> </span><a href="#local-6989586621679377475"><span class="hs-identifier hs-var">in_scope'</span></a><span> </span><a href="#local-6989586621679377478"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679377477"><a href="#local-6989586621679377477"><span class="hs-identifier">bndr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679377478"><a href="#local-6989586621679377478"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679377474"><span class="hs-identifier hs-var">eqs</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-263"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679377475"><a href="#local-6989586621679377475"><span class="hs-identifier">in_scope'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679377473"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#extendInScopeSetList"><span class="hs-identifier hs-var">extendInScopeSetList</span></a><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621679377476"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679377476"><a href="#local-6989586621679377476"><span class="hs-identifier">bndr</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679377474"><span class="hs-identifier hs-var">eqs</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-264"></a><span>
</span><a name="line-265"></a><span class="hs-identifier">stgCseTopLvlRhs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#InStgRhs"><span class="hs-identifier hs-type">InStgRhs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#OutStgRhs"><span class="hs-identifier hs-type">OutStgRhs</span></a><span>
</span><a name="line-266"></a><a name="stgCseTopLvlRhs"><a href="StgCse.html#stgCseTopLvlRhs"><span class="hs-identifier">stgCseTopLvlRhs</span></a></a><span> </span><a name="local-6989586621679377479"><a href="#local-6989586621679377479"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgRhsClosure"><span class="hs-identifier hs-var">StgRhsClosure</span></a><span> </span><a name="local-6989586621679377480"><a href="#local-6989586621679377480"><span class="hs-identifier">ccs</span></a></a><span> </span><a name="local-6989586621679377481"><a href="#local-6989586621679377481"><span class="hs-identifier">info</span></a></a><span> </span><a name="local-6989586621679377482"><a href="#local-6989586621679377482"><span class="hs-identifier">occs</span></a></a><span> </span><a name="local-6989586621679377483"><a href="#local-6989586621679377483"><span class="hs-identifier">upd</span></a></a><span> </span><a name="local-6989586621679377484"><a href="#local-6989586621679377484"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621679377485"><a href="#local-6989586621679377485"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-267"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679377486"><a href="#local-6989586621679377486"><span class="hs-identifier">body'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#stgCseExpr"><span class="hs-identifier hs-var">stgCseExpr</span></a><span> </span><span class="hs-special">(</span><a href="StgCse.html#initEnv"><span class="hs-identifier hs-var">initEnv</span></a><span> </span><a href="#local-6989586621679377479"><span class="hs-identifier hs-var">in_scope</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679377485"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-268"></a><span>      </span><span class="hs-keyword">in</span><span>  </span><a href="StgSyn.html#StgRhsClosure"><span class="hs-identifier hs-var">StgRhsClosure</span></a><span> </span><a href="#local-6989586621679377480"><span class="hs-identifier hs-var">ccs</span></a><span> </span><a href="#local-6989586621679377481"><span class="hs-identifier hs-var">info</span></a><span> </span><a href="#local-6989586621679377482"><span class="hs-identifier hs-var">occs</span></a><span> </span><a href="#local-6989586621679377483"><span class="hs-identifier hs-var">upd</span></a><span> </span><a href="#local-6989586621679377484"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621679377486"><span class="hs-identifier hs-var">body'</span></a><span>
</span><a name="line-269"></a><span class="hs-identifier">stgCseTopLvlRhs</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgRhsCon"><span class="hs-identifier hs-var">StgRhsCon</span></a><span> </span><a name="local-6989586621679377487"><a href="#local-6989586621679377487"><span class="hs-identifier">ccs</span></a></a><span> </span><a name="local-6989586621679377488"><a href="#local-6989586621679377488"><span class="hs-identifier">dataCon</span></a></a><span> </span><a name="local-6989586621679377489"><a href="#local-6989586621679377489"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-270"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgRhsCon"><span class="hs-identifier hs-var">StgRhsCon</span></a><span> </span><a href="#local-6989586621679377487"><span class="hs-identifier hs-var">ccs</span></a><span> </span><a href="#local-6989586621679377488"><span class="hs-identifier hs-var">dataCon</span></a><span> </span><a href="#local-6989586621679377489"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-271"></a><span>
</span><a name="line-272"></a><span class="hs-comment">------------------------------</span><span>
</span><a name="line-273"></a><span class="hs-comment">-- The actual AST traversal --</span><span>
</span><a name="line-274"></a><span class="hs-comment">------------------------------</span><span>
</span><a name="line-275"></a><span>
</span><a name="line-276"></a><span class="hs-comment">-- Trivial cases</span><span>
</span><a name="line-277"></a><span class="hs-identifier">stgCseExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#InStgExpr"><span class="hs-identifier hs-type">InStgExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#OutStgExpr"><span class="hs-identifier hs-type">OutStgExpr</span></a><span>
</span><a name="line-278"></a><a name="stgCseExpr"><a href="StgCse.html#stgCseExpr"><span class="hs-identifier">stgCseExpr</span></a></a><span> </span><a name="local-6989586621679377490"><a href="#local-6989586621679377490"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgApp"><span class="hs-identifier hs-var">StgApp</span></a><span> </span><a name="local-6989586621679377491"><a href="#local-6989586621679377491"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621679377492"><a href="#local-6989586621679377492"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-279"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgApp"><span class="hs-identifier hs-var">StgApp</span></a><span> </span><a href="#local-6989586621679377493"><span class="hs-identifier hs-var">fun'</span></a><span> </span><a href="#local-6989586621679377494"><span class="hs-identifier hs-var">args'</span></a><span>
</span><a name="line-280"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679377493"><a href="#local-6989586621679377493"><span class="hs-identifier">fun'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#substVar"><span class="hs-identifier hs-var">substVar</span></a><span> </span><a href="#local-6989586621679377490"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679377491"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-281"></a><span>        </span><a name="local-6989586621679377494"><a href="#local-6989586621679377494"><span class="hs-identifier">args'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#substArgs"><span class="hs-identifier hs-var">substArgs</span></a><span> </span><a href="#local-6989586621679377490"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679377492"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-282"></a><span class="hs-identifier">stgCseExpr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgLit"><span class="hs-identifier hs-var">StgLit</span></a><span> </span><a name="local-6989586621679377495"><a href="#local-6989586621679377495"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-283"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgLit"><span class="hs-identifier hs-var">StgLit</span></a><span> </span><a href="#local-6989586621679377495"><span class="hs-identifier hs-var">lit</span></a><span>
</span><a name="line-284"></a><span class="hs-identifier">stgCseExpr</span><span> </span><a name="local-6989586621679377496"><a href="#local-6989586621679377496"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgOpApp"><span class="hs-identifier hs-var">StgOpApp</span></a><span> </span><a name="local-6989586621679377497"><a href="#local-6989586621679377497"><span class="hs-identifier">op</span></a></a><span> </span><a name="local-6989586621679377498"><a href="#local-6989586621679377498"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621679377499"><a href="#local-6989586621679377499"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-285"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgOpApp"><span class="hs-identifier hs-var">StgOpApp</span></a><span> </span><a href="#local-6989586621679377497"><span class="hs-identifier hs-var">op</span></a><span> </span><a href="#local-6989586621679377500"><span class="hs-identifier hs-var">args'</span></a><span> </span><a href="#local-6989586621679377499"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-286"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679377500"><a href="#local-6989586621679377500"><span class="hs-identifier">args'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#substArgs"><span class="hs-identifier hs-var">substArgs</span></a><span> </span><a href="#local-6989586621679377496"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679377498"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-287"></a><span class="hs-identifier">stgCseExpr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgLam"><span class="hs-identifier hs-var">StgLam</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-288"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;stgCseExp&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;StgLam&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-289"></a><span class="hs-identifier">stgCseExpr</span><span> </span><a name="local-6989586621679377501"><a href="#local-6989586621679377501"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgTick"><span class="hs-identifier hs-var">StgTick</span></a><span> </span><a name="local-6989586621679377502"><a href="#local-6989586621679377502"><span class="hs-identifier">tick</span></a></a><span> </span><a name="local-6989586621679377503"><a href="#local-6989586621679377503"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-290"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679377504"><a href="#local-6989586621679377504"><span class="hs-identifier">body'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#stgCseExpr"><span class="hs-identifier hs-var">stgCseExpr</span></a><span> </span><a href="#local-6989586621679377501"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679377503"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-291"></a><span>      </span><span class="hs-keyword">in</span><span> </span><a href="StgSyn.html#StgTick"><span class="hs-identifier hs-var">StgTick</span></a><span> </span><a href="#local-6989586621679377502"><span class="hs-identifier hs-var">tick</span></a><span> </span><a href="#local-6989586621679377504"><span class="hs-identifier hs-var">body'</span></a><span>
</span><a name="line-292"></a><span class="hs-identifier">stgCseExpr</span><span> </span><a name="local-6989586621679377505"><a href="#local-6989586621679377505"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgCase"><span class="hs-identifier hs-var">StgCase</span></a><span> </span><a name="local-6989586621679377506"><a href="#local-6989586621679377506"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621679377507"><a href="#local-6989586621679377507"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621679377508"><a href="#local-6989586621679377508"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621679377509"><a href="#local-6989586621679377509"><span class="hs-identifier">alts</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-293"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgCase"><span class="hs-identifier hs-var">StgCase</span></a><span> </span><a href="#local-6989586621679377510"><span class="hs-identifier hs-var">scrut'</span></a><span> </span><a href="#local-6989586621679377512"><span class="hs-identifier hs-var">bndr'</span></a><span> </span><a href="#local-6989586621679377508"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621679377514"><span class="hs-identifier hs-var">alts'</span></a><span>
</span><a name="line-294"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-295"></a><span>    </span><a name="local-6989586621679377510"><a href="#local-6989586621679377510"><span class="hs-identifier">scrut'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#stgCseExpr"><span class="hs-identifier hs-var">stgCseExpr</span></a><span> </span><a href="#local-6989586621679377505"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679377506"><span class="hs-identifier hs-var">scrut</span></a><span>
</span><a name="line-296"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679377511"><a href="#local-6989586621679377511"><span class="hs-identifier">env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679377512"><a href="#local-6989586621679377512"><span class="hs-identifier">bndr'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#substBndr"><span class="hs-identifier hs-var">substBndr</span></a><span> </span><a href="#local-6989586621679377505"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679377507"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-297"></a><span>    </span><a name="local-6989586621679377513"><a href="#local-6989586621679377513"><span class="hs-identifier">cse_bndr</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="StgSyn.html#StgApp"><span class="hs-identifier hs-var">StgApp</span></a><span> </span><a name="local-6989586621679377515"><a href="#local-6989586621679377515"><span class="hs-identifier">trivial_scrut</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679377510"><span class="hs-identifier hs-var">scrut'</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679377515"><span class="hs-identifier hs-var">trivial_scrut</span></a><span>
</span><a name="line-298"></a><span>                 </span><span class="hs-comment">-- See Note [Trivial case scrutinee]</span><span>
</span><a name="line-299"></a><span>             </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>                         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679377512"><span class="hs-identifier hs-var">bndr'</span></a><span>
</span><a name="line-300"></a><span>    </span><a name="local-6989586621679377514"><a href="#local-6989586621679377514"><span class="hs-identifier">alts'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><a href="StgCse.html#stgCseAlt"><span class="hs-identifier hs-var">stgCseAlt</span></a><span> </span><a href="#local-6989586621679377511"><span class="hs-identifier hs-var">env1</span></a><span> </span><a href="#local-6989586621679377513"><span class="hs-identifier hs-var">cse_bndr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679377509"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-301"></a><span>
</span><a name="line-302"></a><span>
</span><a name="line-303"></a><span class="hs-comment">-- A constructor application.</span><span>
</span><a name="line-304"></a><span class="hs-comment">-- To be removed by a variable use when found in the CSE environment</span><span>
</span><a name="line-305"></a><span class="hs-identifier">stgCseExpr</span><span> </span><a name="local-6989586621679377516"><a href="#local-6989586621679377516"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgConApp"><span class="hs-identifier hs-var">StgConApp</span></a><span> </span><a name="local-6989586621679377517"><a href="#local-6989586621679377517"><span class="hs-identifier">dataCon</span></a></a><span> </span><a name="local-6989586621679377518"><a href="#local-6989586621679377518"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621679377519"><a href="#local-6989586621679377519"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-306"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679377521"><a href="#local-6989586621679377521"><span class="hs-identifier">bndr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCse.html#envLookup"><span class="hs-identifier hs-var">envLookup</span></a><span> </span><a href="#local-6989586621679377517"><span class="hs-identifier hs-var">dataCon</span></a><span> </span><a href="#local-6989586621679377520"><span class="hs-identifier hs-var">args'</span></a><span> </span><a href="#local-6989586621679377516"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-307"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgApp"><span class="hs-identifier hs-var">StgApp</span></a><span> </span><a href="#local-6989586621679377521"><span class="hs-identifier hs-var">bndr'</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-308"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-309"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgConApp"><span class="hs-identifier hs-var">StgConApp</span></a><span> </span><a href="#local-6989586621679377517"><span class="hs-identifier hs-var">dataCon</span></a><span> </span><a href="#local-6989586621679377520"><span class="hs-identifier hs-var">args'</span></a><span> </span><a href="#local-6989586621679377519"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-310"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679377520"><a href="#local-6989586621679377520"><span class="hs-identifier">args'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#substArgs"><span class="hs-identifier hs-var">substArgs</span></a><span> </span><a href="#local-6989586621679377516"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679377518"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-311"></a><span>
</span><a name="line-312"></a><span class="hs-comment">-- Let bindings</span><span>
</span><a name="line-313"></a><span class="hs-comment">-- The binding might be removed due to CSE (we do not want trivial bindings on</span><span>
</span><a name="line-314"></a><span class="hs-comment">-- the STG level), so use the smart constructor `mkStgLet` to remove the binding</span><span>
</span><a name="line-315"></a><span class="hs-comment">-- if empty.</span><span>
</span><a name="line-316"></a><span class="hs-identifier">stgCseExpr</span><span> </span><a name="local-6989586621679377522"><a href="#local-6989586621679377522"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgLet"><span class="hs-identifier hs-var">StgLet</span></a><span> </span><a name="local-6989586621679377523"><a href="#local-6989586621679377523"><span class="hs-identifier">binds</span></a></a><span> </span><a name="local-6989586621679377524"><a href="#local-6989586621679377524"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-317"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679377525"><a href="#local-6989586621679377525"><span class="hs-identifier">binds'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679377526"><a href="#local-6989586621679377526"><span class="hs-identifier">env'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#stgCseBind"><span class="hs-identifier hs-var">stgCseBind</span></a><span> </span><a href="#local-6989586621679377522"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679377523"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-318"></a><span>          </span><a name="local-6989586621679377527"><a href="#local-6989586621679377527"><span class="hs-identifier">body'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#stgCseExpr"><span class="hs-identifier hs-var">stgCseExpr</span></a><span> </span><a href="#local-6989586621679377526"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621679377524"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-319"></a><span>      </span><span class="hs-keyword">in</span><span> </span><a href="StgCse.html#mkStgLet"><span class="hs-identifier hs-var">mkStgLet</span></a><span> </span><a href="StgSyn.html#StgLet"><span class="hs-identifier hs-var">StgLet</span></a><span> </span><a href="#local-6989586621679377525"><span class="hs-identifier hs-var">binds'</span></a><span> </span><a href="#local-6989586621679377527"><span class="hs-identifier hs-var">body'</span></a><span>
</span><a name="line-320"></a><span class="hs-identifier">stgCseExpr</span><span> </span><a name="local-6989586621679377528"><a href="#local-6989586621679377528"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgLetNoEscape"><span class="hs-identifier hs-var">StgLetNoEscape</span></a><span> </span><a name="local-6989586621679377529"><a href="#local-6989586621679377529"><span class="hs-identifier">binds</span></a></a><span> </span><a name="local-6989586621679377530"><a href="#local-6989586621679377530"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-321"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679377531"><a href="#local-6989586621679377531"><span class="hs-identifier">binds'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679377532"><a href="#local-6989586621679377532"><span class="hs-identifier">env'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#stgCseBind"><span class="hs-identifier hs-var">stgCseBind</span></a><span> </span><a href="#local-6989586621679377528"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679377529"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-322"></a><span>          </span><a name="local-6989586621679377533"><a href="#local-6989586621679377533"><span class="hs-identifier">body'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#stgCseExpr"><span class="hs-identifier hs-var">stgCseExpr</span></a><span> </span><a href="#local-6989586621679377532"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621679377530"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-323"></a><span>      </span><span class="hs-keyword">in</span><span> </span><a href="StgCse.html#mkStgLet"><span class="hs-identifier hs-var">mkStgLet</span></a><span> </span><a href="StgSyn.html#StgLetNoEscape"><span class="hs-identifier hs-var">StgLetNoEscape</span></a><span> </span><a href="#local-6989586621679377531"><span class="hs-identifier hs-var">binds'</span></a><span> </span><a href="#local-6989586621679377533"><span class="hs-identifier hs-var">body'</span></a><span>
</span><a name="line-324"></a><span>
</span><a name="line-325"></a><span class="hs-comment">-- Case alternatives</span><span>
</span><a name="line-326"></a><span class="hs-comment">-- Extend the CSE environment</span><span>
</span><a name="line-327"></a><span class="hs-identifier">stgCseAlt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#InStgAlt"><span class="hs-identifier hs-type">InStgAlt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#OutStgAlt"><span class="hs-identifier hs-type">OutStgAlt</span></a><span>
</span><a name="line-328"></a><a name="stgCseAlt"><a href="StgCse.html#stgCseAlt"><span class="hs-identifier">stgCseAlt</span></a></a><span> </span><a name="local-6989586621679377534"><a href="#local-6989586621679377534"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679377535"><a href="#local-6989586621679377535"><span class="hs-identifier">case_bndr</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#DataAlt"><span class="hs-identifier hs-var">DataAlt</span></a><span> </span><a name="local-6989586621679377536"><a href="#local-6989586621679377536"><span class="hs-identifier">dataCon</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679377537"><a href="#local-6989586621679377537"><span class="hs-identifier">args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679377538"><a href="#local-6989586621679377538"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-329"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679377539"><a href="#local-6989586621679377539"><span class="hs-identifier">env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679377540"><a href="#local-6989586621679377540"><span class="hs-identifier">args'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#substBndrs"><span class="hs-identifier hs-var">substBndrs</span></a><span> </span><a href="#local-6989586621679377534"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679377537"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-330"></a><span>          </span><a name="local-6989586621679377541"><a href="#local-6989586621679377541"><span class="hs-identifier">env2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#addDataCon"><span class="hs-identifier hs-var">addDataCon</span></a><span> </span><a href="#local-6989586621679377535"><span class="hs-identifier hs-var">case_bndr</span></a><span> </span><a href="#local-6989586621679377536"><span class="hs-identifier hs-var">dataCon</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="StgSyn.html#StgVarArg"><span class="hs-identifier hs-var">StgVarArg</span></a><span> </span><a href="#local-6989586621679377540"><span class="hs-identifier hs-var">args'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679377539"><span class="hs-identifier hs-var">env1</span></a><span>
</span><a name="line-331"></a><span>            </span><span class="hs-comment">-- see note [Case 2: CSEing case binders]</span><span>
</span><a name="line-332"></a><span>          </span><a name="local-6989586621679377542"><a href="#local-6989586621679377542"><span class="hs-identifier">rhs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#stgCseExpr"><span class="hs-identifier hs-var">stgCseExpr</span></a><span> </span><a href="#local-6989586621679377541"><span class="hs-identifier hs-var">env2</span></a><span> </span><a href="#local-6989586621679377538"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-333"></a><span>      </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#DataAlt"><span class="hs-identifier hs-var">DataAlt</span></a><span> </span><a href="#local-6989586621679377536"><span class="hs-identifier hs-var">dataCon</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679377540"><span class="hs-identifier hs-var">args'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679377542"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-334"></a><span class="hs-identifier">stgCseAlt</span><span> </span><a name="local-6989586621679377543"><a href="#local-6989586621679377543"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679377544"><a href="#local-6989586621679377544"><span class="hs-identifier">altCon</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679377545"><a href="#local-6989586621679377545"><span class="hs-identifier">args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679377546"><a href="#local-6989586621679377546"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-335"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679377547"><a href="#local-6989586621679377547"><span class="hs-identifier">env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679377548"><a href="#local-6989586621679377548"><span class="hs-identifier">args'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#substBndrs"><span class="hs-identifier hs-var">substBndrs</span></a><span> </span><a href="#local-6989586621679377543"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679377545"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-336"></a><span>          </span><a name="local-6989586621679377549"><a href="#local-6989586621679377549"><span class="hs-identifier">rhs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#stgCseExpr"><span class="hs-identifier hs-var">stgCseExpr</span></a><span> </span><a href="#local-6989586621679377547"><span class="hs-identifier hs-var">env1</span></a><span> </span><a href="#local-6989586621679377546"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-337"></a><span>      </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679377544"><span class="hs-identifier hs-var">altCon</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679377548"><span class="hs-identifier hs-var">args'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679377549"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-338"></a><span>
</span><a name="line-339"></a><span class="hs-comment">-- Bindings</span><span>
</span><a name="line-340"></a><span class="hs-identifier">stgCseBind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#InStgBinding"><span class="hs-identifier hs-type">InStgBinding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="StgSyn.html#OutStgBinding"><span class="hs-identifier hs-type">OutStgBinding</span></a><span class="hs-special">,</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span class="hs-special">)</span><span>
</span><a name="line-341"></a><a name="stgCseBind"><a href="StgCse.html#stgCseBind"><span class="hs-identifier">stgCseBind</span></a></a><span> </span><a name="local-6989586621679377550"><a href="#local-6989586621679377550"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgNonRec"><span class="hs-identifier hs-var">StgNonRec</span></a><span> </span><a name="local-6989586621679377551"><a href="#local-6989586621679377551"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621679377552"><a href="#local-6989586621679377552"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-342"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679377553"><a href="#local-6989586621679377553"><span class="hs-identifier">env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679377554"><a href="#local-6989586621679377554"><span class="hs-identifier">b'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#substBndr"><span class="hs-identifier hs-var">substBndr</span></a><span> </span><a href="#local-6989586621679377550"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679377551"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-343"></a><span>      </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="StgCse.html#stgCseRhs"><span class="hs-identifier hs-var">stgCseRhs</span></a><span> </span><a href="#local-6989586621679377553"><span class="hs-identifier hs-var">env1</span></a><span> </span><a href="#local-6989586621679377554"><span class="hs-identifier hs-var">b'</span></a><span> </span><a href="#local-6989586621679377552"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-344"></a><span>        </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">,</span><span>      </span><a name="local-6989586621679377555"><a href="#local-6989586621679377555"><span class="hs-identifier">env2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">,</span><span>                </span><a href="#local-6989586621679377555"><span class="hs-identifier hs-var">env2</span></a><span class="hs-special">)</span><span>
</span><a name="line-345"></a><span>        </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679377556"><a href="#local-6989586621679377556"><span class="hs-identifier">b2</span></a></a><span class="hs-special">,</span><a name="local-6989586621679377557"><a href="#local-6989586621679377557"><span class="hs-identifier">e'</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679377558"><a href="#local-6989586621679377558"><span class="hs-identifier">env2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgNonRec"><span class="hs-identifier hs-var">StgNonRec</span></a><span> </span><a href="#local-6989586621679377556"><span class="hs-identifier hs-var">b2</span></a><span> </span><a href="#local-6989586621679377557"><span class="hs-identifier hs-var">e'</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679377558"><span class="hs-identifier hs-var">env2</span></a><span class="hs-special">)</span><span>
</span><a name="line-346"></a><span class="hs-identifier">stgCseBind</span><span> </span><a name="local-6989586621679377559"><a href="#local-6989586621679377559"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgRec"><span class="hs-identifier hs-var">StgRec</span></a><span> </span><a name="local-6989586621679377560"><a href="#local-6989586621679377560"><span class="hs-identifier">pairs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-347"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679377561"><a href="#local-6989586621679377561"><span class="hs-identifier">env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679377562"><a href="#local-6989586621679377562"><span class="hs-identifier">pairs1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#substPairs"><span class="hs-identifier hs-var">substPairs</span></a><span> </span><a href="#local-6989586621679377559"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679377560"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-348"></a><span>      </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="StgCse.html#stgCsePairs"><span class="hs-identifier hs-var">stgCsePairs</span></a><span> </span><a href="#local-6989586621679377561"><span class="hs-identifier hs-var">env1</span></a><span> </span><a href="#local-6989586621679377562"><span class="hs-identifier hs-var">pairs1</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-349"></a><span>        </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>     </span><a name="local-6989586621679377563"><a href="#local-6989586621679377563"><span class="hs-identifier">env2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679377563"><span class="hs-identifier hs-var">env2</span></a><span class="hs-special">)</span><span>
</span><a name="line-350"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621679377564"><a href="#local-6989586621679377564"><span class="hs-identifier">pairs2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679377565"><a href="#local-6989586621679377565"><span class="hs-identifier">env2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgRec"><span class="hs-identifier hs-var">StgRec</span></a><span> </span><a href="#local-6989586621679377564"><span class="hs-identifier hs-var">pairs2</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679377565"><span class="hs-identifier hs-var">env2</span></a><span class="hs-special">)</span><span>
</span><a name="line-351"></a><span>
</span><a name="line-352"></a><span class="hs-identifier">stgCsePairs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a><span class="hs-special">,</span><span> </span><a href="StgSyn.html#InStgRhs"><span class="hs-identifier hs-type">InStgRhs</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a><span class="hs-special">,</span><span> </span><a href="StgSyn.html#OutStgRhs"><span class="hs-identifier hs-type">OutStgRhs</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span class="hs-special">)</span><span>
</span><a name="line-353"></a><a name="stgCsePairs"><a href="StgCse.html#stgCsePairs"><span class="hs-identifier">stgCsePairs</span></a></a><span> </span><a name="local-6989586621679377566"><a href="#local-6989586621679377566"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679377566"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-354"></a><span class="hs-identifier">stgCsePairs</span><span> </span><a name="local-6989586621679377567"><a href="#local-6989586621679377567"><span class="hs-identifier">env0</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621679377568"><a href="#local-6989586621679377568"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><a name="local-6989586621679377569"><a href="#local-6989586621679377569"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span class="hs-glyph">:</span><a name="local-6989586621679377570"><a href="#local-6989586621679377570"><span class="hs-identifier">pairs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-355"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679377572"><a href="#local-6989586621679377572"><span class="hs-identifier">pairMB</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679377573"><a href="#local-6989586621679377573"><span class="hs-identifier">env1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#stgCseRhs"><span class="hs-identifier hs-var">stgCseRhs</span></a><span> </span><a href="#local-6989586621679377567"><span class="hs-identifier hs-var">env0</span></a><span> </span><a href="#local-6989586621679377568"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621679377569"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-356"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621679377574"><a href="#local-6989586621679377574"><span class="hs-identifier">pairs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679377575"><a href="#local-6989586621679377575"><span class="hs-identifier">env2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#stgCsePairs"><span class="hs-identifier hs-var">stgCsePairs</span></a><span> </span><a href="#local-6989586621679377573"><span class="hs-identifier hs-var">env1</span></a><span> </span><a href="#local-6989586621679377570"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-357"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679377572"><span class="hs-identifier hs-var">pairMB</span></a><span> </span><span class="hs-special">`</span><a href="#local-6989586621679377571"><span class="hs-identifier hs-var">mbCons</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679377574"><span class="hs-identifier hs-var">pairs'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679377575"><span class="hs-identifier hs-var">env2</span></a><span class="hs-special">)</span><span>
</span><a name="line-358"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-359"></a><span>    </span><a name="local-6989586621679377571"><a href="#local-6989586621679377571"><span class="hs-identifier">mbCons</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#maybe"><span class="hs-identifier hs-var">maybe</span></a><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#id"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">)</span><span>
</span><a name="line-360"></a><span>
</span><a name="line-361"></a><span class="hs-comment">-- The RHS of a binding.</span><span>
</span><a name="line-362"></a><span class="hs-comment">-- If it is an constructor application, either short-cut it or extend the environment</span><span>
</span><a name="line-363"></a><span class="hs-identifier">stgCseRhs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#InStgRhs"><span class="hs-identifier hs-type">InStgRhs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a><span class="hs-special">,</span><span> </span><a href="StgSyn.html#OutStgRhs"><span class="hs-identifier hs-type">OutStgRhs</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span class="hs-special">)</span><span>
</span><a name="line-364"></a><a name="stgCseRhs"><a href="StgCse.html#stgCseRhs"><span class="hs-identifier">stgCseRhs</span></a></a><span> </span><a name="local-6989586621679377576"><a href="#local-6989586621679377576"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679377577"><a href="#local-6989586621679377577"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgRhsCon"><span class="hs-identifier hs-var">StgRhsCon</span></a><span> </span><a name="local-6989586621679377578"><a href="#local-6989586621679377578"><span class="hs-identifier">ccs</span></a></a><span> </span><a name="local-6989586621679377579"><a href="#local-6989586621679377579"><span class="hs-identifier">dataCon</span></a></a><span> </span><a name="local-6989586621679377580"><a href="#local-6989586621679377580"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-365"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679377582"><a href="#local-6989586621679377582"><span class="hs-identifier">other_bndr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCse.html#envLookup"><span class="hs-identifier hs-var">envLookup</span></a><span> </span><a href="#local-6989586621679377579"><span class="hs-identifier hs-var">dataCon</span></a><span> </span><a href="#local-6989586621679377581"><span class="hs-identifier hs-var">args'</span></a><span> </span><a href="#local-6989586621679377576"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-366"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679377583"><a href="#local-6989586621679377583"><span class="hs-identifier">env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#addSubst"><span class="hs-identifier hs-var">addSubst</span></a><span> </span><a href="#local-6989586621679377577"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621679377582"><span class="hs-identifier hs-var">other_bndr</span></a><span> </span><a href="#local-6989586621679377576"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-367"></a><span>      </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679377583"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">)</span><span>
</span><a name="line-368"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-369"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679377584"><a href="#local-6989586621679377584"><span class="hs-identifier">env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#addDataCon"><span class="hs-identifier hs-var">addDataCon</span></a><span> </span><a href="#local-6989586621679377577"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621679377579"><span class="hs-identifier hs-var">dataCon</span></a><span> </span><a href="#local-6989586621679377581"><span class="hs-identifier hs-var">args'</span></a><span> </span><a href="#local-6989586621679377576"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-370"></a><span>            </span><span class="hs-comment">-- see note [Case 1: CSEing allocated closures]</span><span>
</span><a name="line-371"></a><span>          </span><a name="local-6989586621679377585"><a href="#local-6989586621679377585"><span class="hs-identifier">pair</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679377577"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">,</span><span> </span><a href="StgSyn.html#StgRhsCon"><span class="hs-identifier hs-var">StgRhsCon</span></a><span> </span><a href="#local-6989586621679377578"><span class="hs-identifier hs-var">ccs</span></a><span> </span><a href="#local-6989586621679377579"><span class="hs-identifier hs-var">dataCon</span></a><span> </span><a href="#local-6989586621679377581"><span class="hs-identifier hs-var">args'</span></a><span class="hs-special">)</span><span>
</span><a name="line-372"></a><span>      </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-6989586621679377585"><span class="hs-identifier hs-var">pair</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679377584"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">)</span><span>
</span><a name="line-373"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679377581"><a href="#local-6989586621679377581"><span class="hs-identifier">args'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#substArgs"><span class="hs-identifier hs-var">substArgs</span></a><span> </span><a href="#local-6989586621679377576"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679377580"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-374"></a><span class="hs-identifier">stgCseRhs</span><span> </span><a name="local-6989586621679377586"><a href="#local-6989586621679377586"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679377587"><a href="#local-6989586621679377587"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgRhsClosure"><span class="hs-identifier hs-var">StgRhsClosure</span></a><span> </span><a name="local-6989586621679377588"><a href="#local-6989586621679377588"><span class="hs-identifier">ccs</span></a></a><span> </span><a name="local-6989586621679377589"><a href="#local-6989586621679377589"><span class="hs-identifier">info</span></a></a><span> </span><a name="local-6989586621679377590"><a href="#local-6989586621679377590"><span class="hs-identifier">occs</span></a></a><span> </span><a name="local-6989586621679377591"><a href="#local-6989586621679377591"><span class="hs-identifier">upd</span></a></a><span> </span><a name="local-6989586621679377592"><a href="#local-6989586621679377592"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621679377593"><a href="#local-6989586621679377593"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-375"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679377595"><a href="#local-6989586621679377595"><span class="hs-identifier">env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679377596"><a href="#local-6989586621679377596"><span class="hs-identifier">args'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#substBndrs"><span class="hs-identifier hs-var">substBndrs</span></a><span> </span><a href="#local-6989586621679377586"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679377592"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-376"></a><span>          </span><a name="local-6989586621679377597"><a href="#local-6989586621679377597"><span class="hs-identifier">env2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#forgetCse"><span class="hs-identifier hs-var">forgetCse</span></a><span> </span><a href="#local-6989586621679377595"><span class="hs-identifier hs-var">env1</span></a><span> </span><span class="hs-comment">-- See note [Free variables of an StgClosure]</span><span>
</span><a name="line-377"></a><span>          </span><a name="local-6989586621679377598"><a href="#local-6989586621679377598"><span class="hs-identifier">body'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#stgCseExpr"><span class="hs-identifier hs-var">stgCseExpr</span></a><span> </span><a href="#local-6989586621679377597"><span class="hs-identifier hs-var">env2</span></a><span> </span><a href="#local-6989586621679377593"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-378"></a><span>      </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="StgCse.html#substVar"><span class="hs-identifier hs-var">substVar</span></a><span> </span><a href="#local-6989586621679377586"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679377587"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">,</span><span> </span><a href="StgSyn.html#StgRhsClosure"><span class="hs-identifier hs-var">StgRhsClosure</span></a><span> </span><a href="#local-6989586621679377588"><span class="hs-identifier hs-var">ccs</span></a><span> </span><a href="#local-6989586621679377589"><span class="hs-identifier hs-var">info</span></a><span> </span><a href="#local-6989586621679377594"><span class="hs-identifier hs-var">occs'</span></a><span> </span><a href="#local-6989586621679377591"><span class="hs-identifier hs-var">upd</span></a><span> </span><a href="#local-6989586621679377596"><span class="hs-identifier hs-var">args'</span></a><span> </span><a href="#local-6989586621679377598"><span class="hs-identifier hs-var">body'</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679377586"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-379"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679377594"><a href="#local-6989586621679377594"><span class="hs-identifier">occs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#substVars"><span class="hs-identifier hs-var">substVars</span></a><span> </span><a href="#local-6989586621679377586"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679377590"><span class="hs-identifier hs-var">occs</span></a><span>
</span><a name="line-380"></a><span>
</span><a name="line-381"></a><span class="hs-comment">-- Utilities</span><span>
</span><a name="line-382"></a><span>
</span><a name="line-383"></a><span class="hs-comment">-- | This function short-cuts let-bindings that are now obsolete</span><span>
</span><a name="line-384"></a><span class="hs-identifier">mkStgLet</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679377424"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679377425"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679377425"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="#local-6989586621679377424"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679377425"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679377425"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-385"></a><a name="mkStgLet"><a href="StgCse.html#mkStgLet"><span class="hs-identifier">mkStgLet</span></a></a><span> </span><span class="hs-identifier">_</span><span>      </span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>      </span><a name="local-6989586621679377599"><a href="#local-6989586621679377599"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679377599"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-386"></a><span class="hs-identifier">mkStgLet</span><span> </span><a name="local-6989586621679377600"><a href="#local-6989586621679377600"><span class="hs-identifier">stgLet</span></a></a><span> </span><span class="hs-special">(</span><a href="../base-4.10.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679377601"><a href="#local-6989586621679377601"><span class="hs-identifier">binds</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679377602"><a href="#local-6989586621679377602"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679377600"><span class="hs-identifier hs-var">stgLet</span></a><span> </span><a href="#local-6989586621679377601"><span class="hs-identifier hs-var">binds</span></a><span> </span><a href="#local-6989586621679377602"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-387"></a><span>
</span><a name="line-388"></a><span>
</span><a name="line-389"></a><span class="hs-comment">{-
Note [Trivial case scrutinee]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we find

    case x as b of { Con a -&gt; &#8230; }

we really want to replace uses of Con a in the body with x, and not just b, in
order to handle nested reconstruction of constructors as in

    nested :: Either Int (Either Int a) -&gt; Either Bool (Either Bool a)
    nested (Right (Right x)) = Right (Right x)
    nested _ = Left True

Therefore, we add
    Con a &#8614; x
to the ConAppMap respectively.
Compare Note [CSE for case expressions] in CSE.hs, which does the same for Core CSE.

If we find
    case foo x as b of { Con a -&gt; &#8230; }
we use
    Con a &#8614; b

Note [Free variables of an StgClosure]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
StgClosures (function and thunks) have an explicit list of free variables:

foo [x] =
    let not_a_free_var = Left [x]
    let a_free_var = Right [x]
    let closure = \[x a_free_var] -&gt; \[y] -&gt; bar y (Left [x]) a_free_var
    in closure

If we were to CSE `Left [x]` in the body of `closure` with `not_a_free_var`,
then the list of free variables would be wrong, so for now, we do not CSE
across such a closure, simply because I (Joachim) was not sure about possible
knock-on effects. If deemed safe and worth the slight code complication of
re-calculating this list during or after this pass, this can surely be done.
-}</span><span>
</span><a name="line-429"></a></pre></body></html>