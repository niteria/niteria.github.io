<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2006
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998


The Desugarer: turning HsSyn into Core.
-}</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Desugar</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-12"></a><span>    </span><span class="hs-comment">-- * Desugaring operations</span><span>
</span><a name="line-13"></a><span>    </span><a href="Desugar.html#deSugar"><span class="hs-identifier hs-var">deSugar</span></a><span class="hs-special">,</span><span> </span><a href="Desugar.html#deSugarExpr"><span class="hs-identifier hs-var">deSugarExpr</span></a><span class="hs-special">,</span><span>
</span><a name="line-14"></a><span>    </span><span class="hs-comment">-- * Dependency/fingerprinting code (used by MkIface)</span><span>
</span><a name="line-15"></a><span>    </span><a href="Desugar.html#mkUsageInfo"><span class="hs-identifier hs-var">mkUsageInfo</span></a><span class="hs-special">,</span><span> </span><a href="Desugar.html#mkUsedNames"><span class="hs-identifier hs-var">mkUsedNames</span></a><span class="hs-special">,</span><span> </span><a href="Desugar.html#mkDependencies"><span class="hs-identifier hs-var">mkDependencies</span></a><span>
</span><a name="line-16"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;</span><span>
</span><a name="line-19"></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><a href="DynFlags.html"><span class="hs-identifier">DynFlags</span></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="HscTypes.html"><span class="hs-identifier">HscTypes</span></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="HsSyn.html"><span class="hs-identifier">HsSyn</span></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnTypes.html"><span class="hs-identifier">TcRnTypes</span></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="TcRnMonad.html#finalSafeMode"><span class="hs-identifier hs-var">finalSafeMode</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#fixSafeInstances"><span class="hs-identifier hs-var">fixSafeInstances</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="Id.html"><span class="hs-identifier">Id</span></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="Name.html"><span class="hs-identifier">Name</span></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="Type.html"><span class="hs-identifier">Type</span></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="FamInstEnv.html"><span class="hs-identifier">FamInstEnv</span></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="InstEnv.html"><span class="hs-identifier">InstEnv</span></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="Class.html"><span class="hs-identifier">Class</span></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="Avail.html"><span class="hs-identifier">Avail</span></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><a href="CoreSyn.html"><span class="hs-identifier">CoreSyn</span></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="CoreFVs.html"><span class="hs-identifier">CoreFVs</span></a><span class="hs-special">(</span><span> </span><a href="CoreFVs.html#exprsSomeFreeVarsList"><span class="hs-identifier hs-var">exprsSomeFreeVarsList</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><a href="CoreSubst.html"><span class="hs-identifier">CoreSubst</span></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><a href="PprCore.html"><span class="hs-identifier">PprCore</span></a><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><a href="DsMonad.html"><span class="hs-identifier">DsMonad</span></a><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><a href="DsExpr.html"><span class="hs-identifier">DsExpr</span></a><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><a href="DsBinds.html"><span class="hs-identifier">DsBinds</span></a><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><a href="DsForeign.html"><span class="hs-identifier">DsForeign</span></a><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><a href="PrelNames.html"><span class="hs-identifier">PrelNames</span></a><span>   </span><span class="hs-special">(</span><span> </span><a href="PrelNames.html#coercibleTyConKey"><span class="hs-identifier hs-var">coercibleTyConKey</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><a href="TysPrim.html"><span class="hs-identifier">TysPrim</span></a><span>     </span><span class="hs-special">(</span><span> </span><a href="TysPrim.html#eqReprPrimTyCon"><span class="hs-identifier hs-var">eqReprPrimTyCon</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><a href="Unique.html"><span class="hs-identifier">Unique</span></a><span>      </span><span class="hs-special">(</span><span> </span><a href="Unique.html#hasKey"><span class="hs-identifier hs-var">hasKey</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><a href="Coercion.html"><span class="hs-identifier">Coercion</span></a><span>    </span><span class="hs-special">(</span><span> </span><a href="Coercion.html#mkCoVarCo"><span class="hs-identifier hs-var">mkCoVarCo</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><a href="TysWiredIn.html"><span class="hs-identifier">TysWiredIn</span></a><span>  </span><span class="hs-special">(</span><span> </span><a href="TysWiredIn.html#coercibleDataCon"><span class="hs-identifier hs-var">coercibleDataCon</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><a href="DataCon.html"><span class="hs-identifier">DataCon</span></a><span>     </span><span class="hs-special">(</span><span> </span><a href="DataCon.html#dataConWrapId"><span class="hs-identifier hs-var">dataConWrapId</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><a href="MkCore.html"><span class="hs-identifier">MkCore</span></a><span>      </span><span class="hs-special">(</span><span> </span><a href="MkCore.html#mkCoreLet"><span class="hs-identifier hs-var">mkCoreLet</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><a href="Module.html"><span class="hs-identifier">Module</span></a><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><a href="NameSet.html"><span class="hs-identifier">NameSet</span></a><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><a href="NameEnv.html"><span class="hs-identifier">NameEnv</span></a><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><a href="Rules.html"><span class="hs-identifier">Rules</span></a><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><a href="BasicTypes.html"><span class="hs-identifier">BasicTypes</span></a><span>       </span><span class="hs-special">(</span><span> </span><a href="BasicTypes.html#Activation"><span class="hs-identifier hs-type">Activation</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span> </span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="BasicTypes.html#competesWith"><span class="hs-identifier hs-var">competesWith</span></a><span class="hs-special">,</span><span> </span><a href="BasicTypes.html#pprRuleName"><span class="hs-identifier hs-var">pprRuleName</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><a href="CoreMonad.html"><span class="hs-identifier">CoreMonad</span></a><span>        </span><span class="hs-special">(</span><span> </span><a href="CoreMonad.html#CoreToDo"><span class="hs-identifier hs-type">CoreToDo</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><a href="CoreLint.html"><span class="hs-identifier">CoreLint</span></a><span>         </span><span class="hs-special">(</span><span> </span><a href="CoreLint.html#endPassIO"><span class="hs-identifier hs-var">endPassIO</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><a href="VarSet.html"><span class="hs-identifier">VarSet</span></a><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><a href="FastString.html"><span class="hs-identifier">FastString</span></a><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><a href="ErrUtils.html"><span class="hs-identifier">ErrUtils</span></a><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><a href="Outputable.html"><span class="hs-identifier">Outputable</span></a><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><a href="SrcLoc.html"><span class="hs-identifier">SrcLoc</span></a><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><a href="Coverage.html"><span class="hs-identifier">Coverage</span></a><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><a href="Util.html"><span class="hs-identifier">Util</span></a><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><a href="MonadUtils.html"><span class="hs-identifier">MonadUtils</span></a><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span> </span><a href="OrdList.html"><span class="hs-identifier">OrdList</span></a><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><a href="StaticPtrTable.html"><span class="hs-identifier">StaticPtrTable</span></a><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><a href="UniqFM.html"><span class="hs-identifier">UniqFM</span></a><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><a href="ListSetOps.html"><span class="hs-identifier">ListSetOps</span></a><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span> </span><a href="Fingerprint.html"><span class="hs-identifier">Fingerprint</span></a><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span> </span><a href="Maybes.html"><span class="hs-identifier">Maybes</span></a><span>
</span><a name="line-68"></a><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Function.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Function</span></a><span>
</span><a name="line-70"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.List.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span></a><span>
</span><a name="line-71"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.IORef.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">IORef</span></a><span>
</span><a name="line-72"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html"><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span></a><span class="hs-special">(</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span> </span><a href="../containers-0.5.7.1/src/%{MODULE/./-}.html#%{NAME}/Data.Map.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Map</span></a><span> </span><span class="hs-special">(</span><a href="../containers-0.5.7.1/src/%{MODULE/./-}.html#%{NAME}/Data.Map.Base.html#Map"><span class="hs-identifier hs-type">Map</span></a><span class="hs-special">)</span><span>
</span><a name="line-74"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="../containers-0.5.7.1/src/%{MODULE/./-}.html#%{NAME}/Data.Map.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Map</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-75"></a><span>
</span><a name="line-76"></a><span class="hs-comment">-- | Extract information from the rename and typecheck phases to produce</span><span>
</span><a name="line-77"></a><span class="hs-comment">-- a dependencies information for the module being compiled.</span><span>
</span><a name="line-78"></a><span class="hs-identifier">mkDependencies</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#TcGblEnv"><span class="hs-identifier hs-type">TcGblEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="HscTypes.html#Dependencies"><span class="hs-identifier hs-type">Dependencies</span></a><span>
</span><a name="line-79"></a><a name="mkDependencies"><a href="Desugar.html#mkDependencies"><span class="hs-identifier">mkDependencies</span></a></a><span>
</span><a name="line-80"></a><span>          </span><a href="TcRnTypes.html#TcGblEnv"><span class="hs-identifier hs-var">TcGblEnv</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_mod</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628171975"><a href="#local-1628171975"><span class="hs-identifier">mod</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-81"></a><span>                    </span><span class="hs-identifier">tcg_imports</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628171976"><a href="#local-1628171976"><span class="hs-identifier">imports</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-82"></a><span>                    </span><span class="hs-identifier">tcg_th_used</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628171977"><a href="#local-1628171977"><span class="hs-identifier">th_var</span></a></a><span>
</span><a name="line-83"></a><span>                  </span><span class="hs-special">}</span><span>
</span><a name="line-84"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-85"></a><span>      </span><span class="hs-comment">-- Template Haskell used?</span><span>
</span><a name="line-86"></a><span>      </span><a name="local-1628171978"><a href="#local-1628171978"><span class="hs-identifier">th_used</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span> </span><a href="#local-1628171977"><span class="hs-identifier hs-var">th_var</span></a><span>
</span><a name="line-87"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-1628171979"><a href="#local-1628171979"><span class="hs-identifier">dep_mods</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UniqFM.html#eltsUFM"><span class="hs-identifier hs-var">eltsUFM</span></a><span> </span><span class="hs-special">(</span><a href="UniqFM.html#delFromUFM"><span class="hs-identifier hs-var">delFromUFM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">imp_dep_mods</span><span> </span><a href="#local-1628171976"><span class="hs-identifier hs-var">imports</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-1628171975"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-88"></a><span>                </span><span class="hs-comment">-- M.hi-boot can be in the imp_dep_mods, but we must remove</span><span>
</span><a name="line-89"></a><span>                </span><span class="hs-comment">-- it before recording the modules on which this one depends!</span><span>
</span><a name="line-90"></a><span>                </span><span class="hs-comment">-- (We want to retain M.hi-boot in imp_dep_mods so that</span><span>
</span><a name="line-91"></a><span>                </span><span class="hs-comment">--  loadHiBootInterface can see if M's direct imports depend</span><span>
</span><a name="line-92"></a><span>                </span><span class="hs-comment">--  on M.hi-boot, and hence that we should do the hi-boot consistency</span><span>
</span><a name="line-93"></a><span>                </span><span class="hs-comment">--  check.)</span><span>
</span><a name="line-94"></a><span>
</span><a name="line-95"></a><span>          </span><a name="local-1628171980"><a href="#local-1628171980"><span class="hs-identifier">pkgs</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628171978"><span class="hs-identifier hs-var">th_used</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="ListSetOps.html#insertList"><span class="hs-identifier hs-var">insertList</span></a><span> </span><a href="Module.html#thUnitId"><span class="hs-identifier hs-var">thUnitId</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">imp_dep_pkgs</span><span> </span><a href="#local-1628171976"><span class="hs-identifier hs-var">imports</span></a><span class="hs-special">)</span><span>
</span><a name="line-96"></a><span>               </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">imp_dep_pkgs</span><span> </span><a href="#local-1628171976"><span class="hs-identifier hs-var">imports</span></a><span>
</span><a name="line-97"></a><span>
</span><a name="line-98"></a><span>          </span><span class="hs-comment">-- Set the packages required to be Safe according to Safe Haskell.</span><span>
</span><a name="line-99"></a><span>          </span><span class="hs-comment">-- See Note [RnNames . Tracking Trust Transitively]</span><span>
</span><a name="line-100"></a><span>          </span><a name="local-1628171981"><a href="#local-1628171981"><span class="hs-identifier">sorted_pkgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.OldList.html#sortBy"><span class="hs-identifier hs-var">sortBy</span></a><span> </span><a href="Module.html#stableUnitIdCmp"><span class="hs-identifier hs-var">stableUnitIdCmp</span></a><span> </span><a href="#local-1628171980"><span class="hs-identifier hs-var">pkgs</span></a><span>
</span><a name="line-101"></a><span>          </span><a name="local-1628171982"><a href="#local-1628171982"><span class="hs-identifier">trust_pkgs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">imp_trust_pkgs</span><span> </span><a href="#local-1628171976"><span class="hs-identifier hs-var">imports</span></a><span>
</span><a name="line-102"></a><span>          </span><a name="local-1628171983"><a href="#local-1628171983"><span class="hs-identifier">dep_pkgs'</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-1628171984"><a href="#local-1628171984"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-1628171984"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628171984"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">`</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#elem"><span class="hs-identifier hs-var">elem</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628171982"><span class="hs-identifier hs-var">trust_pkgs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-1628171981"><span class="hs-identifier hs-var">sorted_pkgs</span></a><span>
</span><a name="line-103"></a><span>
</span><a name="line-104"></a><span>      </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="HscTypes.html#Deps"><span class="hs-identifier hs-var">Deps</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dep_mods</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.OldList.html#sortBy"><span class="hs-identifier hs-var">sortBy</span></a><span> </span><span class="hs-special">(</span><a href="Module.html#stableModuleNameCmp"><span class="hs-identifier hs-var">stableModuleNameCmp</span></a><span> </span><span class="hs-special">`</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Function.html#on"><span class="hs-identifier hs-var">on</span></a><span class="hs-special">`</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628171979"><span class="hs-identifier hs-var">dep_mods</span></a><span class="hs-special">,</span><span>
</span><a name="line-105"></a><span>                    </span><span class="hs-identifier">dep_pkgs</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628171983"><span class="hs-identifier hs-var">dep_pkgs'</span></a><span class="hs-special">,</span><span>
</span><a name="line-106"></a><span>                    </span><span class="hs-identifier">dep_orphs</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.OldList.html#sortBy"><span class="hs-identifier hs-var">sortBy</span></a><span> </span><a href="Module.html#stableModuleCmp"><span class="hs-identifier hs-var">stableModuleCmp</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">imp_orphs</span><span>  </span><a href="#local-1628171976"><span class="hs-identifier hs-var">imports</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-107"></a><span>                    </span><span class="hs-identifier">dep_finsts</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.OldList.html#sortBy"><span class="hs-identifier hs-var">sortBy</span></a><span> </span><a href="Module.html#stableModuleCmp"><span class="hs-identifier hs-var">stableModuleCmp</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">imp_finsts</span><span> </span><a href="#local-1628171976"><span class="hs-identifier hs-var">imports</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-108"></a><span>                    </span><span class="hs-comment">-- sort to get into canonical order</span><span>
</span><a name="line-109"></a><span>                    </span><span class="hs-comment">-- NB. remember to use lexicographic ordering</span><span>
</span><a name="line-110"></a><span>
</span><a name="line-111"></a><span class="hs-identifier">mkUsedNames</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#TcGblEnv"><span class="hs-identifier hs-type">TcGblEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="NameSet.html#NameSet"><span class="hs-identifier hs-type">NameSet</span></a><span>
</span><a name="line-112"></a><a name="mkUsedNames"><a href="Desugar.html#mkUsedNames"><span class="hs-identifier">mkUsedNames</span></a></a><span> </span><a href="TcRnTypes.html#TcGblEnv"><span class="hs-identifier hs-var">TcGblEnv</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_dus</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628171985"><a href="#local-1628171985"><span class="hs-identifier">dus</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="NameSet.html#allUses"><span class="hs-identifier hs-var">allUses</span></a><span> </span><a href="#local-1628171985"><span class="hs-identifier hs-var">dus</span></a><span>
</span><a name="line-113"></a><span>
</span><a name="line-114"></a><span class="hs-identifier">mkUsageInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HscTypes.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HscTypes.html#ImportedMods"><span class="hs-identifier hs-type">ImportedMods</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="NameSet.html#NameSet"><span class="hs-identifier hs-type">NameSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><a href="HscTypes.html#Usage"><span class="hs-identifier hs-type">Usage</span></a><span class="hs-special">]</span><span>
</span><a name="line-115"></a><a name="mkUsageInfo"><a href="Desugar.html#mkUsageInfo"><span class="hs-identifier">mkUsageInfo</span></a></a><span> </span><a name="local-1628171986"><a href="#local-1628171986"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-1628171987"><a href="#local-1628171987"><span class="hs-identifier">this_mod</span></a></a><span> </span><a name="local-1628171988"><a href="#local-1628171988"><span class="hs-identifier">dir_imp_mods</span></a></a><span> </span><a name="local-1628171989"><a href="#local-1628171989"><span class="hs-identifier">used_names</span></a></a><span> </span><a name="local-1628171990"><a href="#local-1628171990"><span class="hs-identifier">dependent_files</span></a></a><span>
</span><a name="line-116"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-117"></a><span>    </span><a name="local-1628171991"><a href="#local-1628171991"><span class="hs-identifier">eps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscTypes.html#hscEPS"><span class="hs-identifier hs-var">hscEPS</span></a><span> </span><a href="#local-1628171986"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-118"></a><span>    </span><a name="local-1628171992"><a href="#local-1628171992"><span class="hs-identifier">hashes</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Fingerprint.html#getFileHash"><span class="hs-identifier hs-var">getFileHash</span></a><span> </span><a href="#local-1628171990"><span class="hs-identifier hs-var">dependent_files</span></a><span>
</span><a name="line-119"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-1628171993"><a href="#local-1628171993"><span class="hs-identifier">mod_usages</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Desugar.html#mk_mod_usage_info"><span class="hs-identifier hs-var">mk_mod_usage_info</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">eps_PIT</span><span> </span><a href="#local-1628171991"><span class="hs-identifier hs-var">eps</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628171986"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-1628171987"><span class="hs-identifier hs-var">this_mod</span></a><span>
</span><a name="line-120"></a><span>                                       </span><a href="#local-1628171988"><span class="hs-identifier hs-var">dir_imp_mods</span></a><span> </span><a href="#local-1628171989"><span class="hs-identifier hs-var">used_names</span></a><span>
</span><a name="line-121"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-1628171994"><a href="#local-1628171994"><span class="hs-identifier">usages</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628171993"><span class="hs-identifier hs-var">mod_usages</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="HscTypes.html#UsageFile"><span class="hs-identifier hs-var">UsageFile</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">usg_file_path</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628171995"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-122"></a><span>                                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">usg_file_hash</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628171996"><span class="hs-identifier hs-var">hash</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-123"></a><span>                               </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-1628171995"><a href="#local-1628171995"><span class="hs-identifier">f</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628171996"><a href="#local-1628171996"><span class="hs-identifier">hash</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zip"><span class="hs-identifier hs-var">zip</span></a><span> </span><a href="#local-1628171990"><span class="hs-identifier hs-var">dependent_files</span></a><span> </span><a href="#local-1628171992"><span class="hs-identifier hs-var">hashes</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-124"></a><span>    </span><a href="#local-1628171994"><span class="hs-identifier hs-var">usages</span></a><span> </span><span class="hs-special">`</span><a href="Util.html#seqList"><span class="hs-identifier hs-var">seqList</span></a><span class="hs-special">`</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-1628171994"><span class="hs-identifier hs-var">usages</span></a><span>
</span><a name="line-125"></a><span>    </span><span class="hs-comment">-- seq the list of Usages returned: occasionally these</span><span>
</span><a name="line-126"></a><span>    </span><span class="hs-comment">-- don't get evaluated for a while and we can end up hanging on to</span><span>
</span><a name="line-127"></a><span>    </span><span class="hs-comment">-- the entire collection of Ifaces.</span><span>
</span><a name="line-128"></a><span>
</span><a name="line-129"></a><span class="hs-identifier">mk_mod_usage_info</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HscTypes.html#PackageIfaceTable"><span class="hs-identifier hs-type">PackageIfaceTable</span></a><span>
</span><a name="line-130"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HscTypes.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a><span>
</span><a name="line-131"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span>
</span><a name="line-132"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HscTypes.html#ImportedMods"><span class="hs-identifier hs-type">ImportedMods</span></a><span>
</span><a name="line-133"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="NameSet.html#NameSet"><span class="hs-identifier hs-type">NameSet</span></a><span>
</span><a name="line-134"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="HscTypes.html#Usage"><span class="hs-identifier hs-type">Usage</span></a><span class="hs-special">]</span><span>
</span><a name="line-135"></a><a name="mk_mod_usage_info"><a href="Desugar.html#mk_mod_usage_info"><span class="hs-identifier">mk_mod_usage_info</span></a></a><span> </span><a name="local-1628171997"><a href="#local-1628171997"><span class="hs-identifier">pit</span></a></a><span> </span><a name="local-1628171998"><a href="#local-1628171998"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-1628171999"><a href="#local-1628171999"><span class="hs-identifier">this_mod</span></a></a><span> </span><a name="local-1628172000"><a href="#local-1628172000"><span class="hs-identifier">direct_imports</span></a></a><span> </span><a name="local-1628172001"><a href="#local-1628172001"><span class="hs-identifier">used_names</span></a></a><span>
</span><a name="line-136"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#mapMaybe"><span class="hs-identifier hs-var">mapMaybe</span></a><span> </span><a href="#local-1628172010"><span class="hs-identifier hs-var">mkUsage</span></a><span> </span><a href="#local-1628172008"><span class="hs-identifier hs-var">usage_mods</span></a><span>
</span><a name="line-137"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-138"></a><span>    </span><a name="local-1628172002"><a href="#local-1628172002"><span class="hs-identifier">hpt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_HPT</span><span> </span><a href="#local-1628171998"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-139"></a><span>    </span><a name="local-1628172003"><a href="#local-1628172003"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-1628171998"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-140"></a><span>    </span><a name="local-1628172004"><a href="#local-1628172004"><span class="hs-identifier">this_pkg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">thisPackage</span><span> </span><a href="#local-1628172003"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-141"></a><span>
</span><a name="line-142"></a><span>    </span><a name="local-1628172005"><a href="#local-1628172005"><span class="hs-identifier">used_mods</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Module.html#moduleEnvKeys"><span class="hs-identifier hs-var">moduleEnvKeys</span></a><span> </span><a href="#local-1628172009"><span class="hs-identifier hs-var">ent_map</span></a><span>
</span><a name="line-143"></a><span>    </span><a name="local-1628172006"><a href="#local-1628172006"><span class="hs-identifier">dir_imp_mods</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Module.html#moduleEnvKeys"><span class="hs-identifier hs-var">moduleEnvKeys</span></a><span> </span><a href="#local-1628172000"><span class="hs-identifier hs-var">direct_imports</span></a><span>
</span><a name="line-144"></a><span>    </span><a name="local-1628172007"><a href="#local-1628172007"><span class="hs-identifier">all_mods</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628172005"><span class="hs-identifier hs-var">used_mods</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#notElem"><span class="hs-identifier hs-var">notElem</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628172005"><span class="hs-identifier hs-var">used_mods</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628172006"><span class="hs-identifier hs-var">dir_imp_mods</span></a><span>
</span><a name="line-145"></a><span>    </span><a name="local-1628172008"><a href="#local-1628172008"><span class="hs-identifier">usage_mods</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.OldList.html#sortBy"><span class="hs-identifier hs-var">sortBy</span></a><span> </span><a href="Module.html#stableModuleCmp"><span class="hs-identifier hs-var">stableModuleCmp</span></a><span> </span><a href="#local-1628172007"><span class="hs-identifier hs-var">all_mods</span></a><span>
</span><a name="line-146"></a><span>                        </span><span class="hs-comment">-- canonical order is imported, to avoid interface-file</span><span>
</span><a name="line-147"></a><span>                        </span><span class="hs-comment">-- wobblage.</span><span>
</span><a name="line-148"></a><span>
</span><a name="line-149"></a><span>    </span><span class="hs-comment">-- ent_map groups together all the things imported and used</span><span>
</span><a name="line-150"></a><span>    </span><span class="hs-comment">-- from a particular module</span><span>
</span><a name="line-151"></a><span>    </span><span class="hs-identifier">ent_map</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Module.html#ModuleEnv"><span class="hs-identifier hs-type">ModuleEnv</span></a><span> </span><span class="hs-special">[</span><a href="OccName.html#OccName"><span class="hs-identifier hs-type">OccName</span></a><span class="hs-special">]</span><span>
</span><a name="line-152"></a><span>    </span><a name="local-1628172009"><a href="#local-1628172009"><span class="hs-identifier">ent_map</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="NameSet.html#foldNameSet"><span class="hs-identifier hs-var">foldNameSet</span></a><span> </span><a href="#local-1628172011"><span class="hs-identifier hs-var">add_mv</span></a><span> </span><a href="Module.html#emptyModuleEnv"><span class="hs-identifier hs-var">emptyModuleEnv</span></a><span> </span><a href="#local-1628172001"><span class="hs-identifier hs-var">used_names</span></a><span>
</span><a name="line-153"></a><span>     </span><span class="hs-keyword">where</span><span>
</span><a name="line-154"></a><span>      </span><a name="local-1628172011"><a href="#local-1628172011"><span class="hs-identifier">add_mv</span></a></a><span> </span><a name="local-1628172012"><a href="#local-1628172012"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-1628172013"><a href="#local-1628172013"><span class="hs-identifier">mv_map</span></a></a><span>
</span><a name="line-155"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="Name.html#isWiredInName"><span class="hs-identifier hs-var">isWiredInName</span></a><span> </span><a href="#local-1628172012"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628172013"><span class="hs-identifier hs-var">mv_map</span></a><span>  </span><span class="hs-comment">-- ignore wired-in names</span><span>
</span><a name="line-156"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-157"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Name.html#nameModule_maybe"><span class="hs-identifier hs-var">nameModule_maybe</span></a><span> </span><a href="#local-1628172012"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-158"></a><span>             </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isSystemName</span><span> </span><a href="Name.html#isSystemName"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><a href="Name.html#isSystemName"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-identifier">name</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier">mv_map</span><span>
</span><a name="line-159"></a><span>                </span><span class="hs-comment">-- See Note [Internal used_names]</span><span>
</span><a name="line-160"></a><span>
</span><a name="line-161"></a><span>             </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628172014"><a href="#local-1628172014"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">-- This lambda function is really just a</span><span>
</span><a name="line-162"></a><span>                         </span><span class="hs-comment">-- specialised (++); originally came about to</span><span>
</span><a name="line-163"></a><span>                         </span><span class="hs-comment">-- avoid quadratic behaviour (trac #2680)</span><span>
</span><a name="line-164"></a><span>                         </span><a href="Module.html#extendModuleEnvWith"><span class="hs-identifier hs-var">extendModuleEnvWith</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><a name="local-1628172016"><a href="#local-1628172016"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628172015"><span class="hs-identifier hs-var">occ</span></a><span class="hs-glyph">:</span><a href="#local-1628172016"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628172013"><span class="hs-identifier hs-var">mv_map</span></a><span> </span><a href="#local-1628172014"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-special">[</span><a href="#local-1628172015"><span class="hs-identifier hs-var">occ</span></a><span class="hs-special">]</span><span>
</span><a name="line-165"></a><span>                </span><span class="hs-keyword">where</span><span> </span><a name="local-1628172015"><a href="#local-1628172015"><span class="hs-identifier">occ</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Name.html#nameOccName"><span class="hs-identifier hs-var">nameOccName</span></a><span> </span><a href="#local-1628172012"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-166"></a><span>
</span><a name="line-167"></a><span>    </span><span class="hs-comment">-- We want to create a Usage for a home module if</span><span>
</span><a name="line-168"></a><span>    </span><span class="hs-comment">--  a) we used something from it; has something in used_names</span><span>
</span><a name="line-169"></a><span>    </span><span class="hs-comment">--  b) we imported it, even if we used nothing from it</span><span>
</span><a name="line-170"></a><span>    </span><span class="hs-comment">--     (need to recompile if its export list changes: export_fprint)</span><span>
</span><a name="line-171"></a><span>    </span><span class="hs-identifier">mkUsage</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="HscTypes.html#Usage"><span class="hs-identifier hs-type">Usage</span></a><span>
</span><a name="line-172"></a><span>    </span><a name="local-1628172010"><a href="#local-1628172010"><span class="hs-identifier">mkUsage</span></a></a><span> </span><a name="local-1628172017"><a href="#local-1628172017"><span class="hs-identifier">mod</span></a></a><span>
</span><a name="line-173"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#isNothing"><span class="hs-identifier hs-var">isNothing</span></a><span> </span><a href="#local-1628172018"><span class="hs-identifier hs-var">maybe_iface</span></a><span>           </span><span class="hs-comment">-- We can't depend on it if we didn't</span><span>
</span><a name="line-174"></a><span>                                        </span><span class="hs-comment">-- load its interface.</span><span>
</span><a name="line-175"></a><span>      </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-1628172017"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-1628171999"><span class="hs-identifier hs-var">this_mod</span></a><span>                </span><span class="hs-comment">-- We don't care about usages of</span><span>
</span><a name="line-176"></a><span>                                        </span><span class="hs-comment">-- things in *this* module</span><span>
</span><a name="line-177"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-178"></a><span>
</span><a name="line-179"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">moduleUnitId</span><span> </span><a href="#local-1628172017"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-1628172004"><span class="hs-identifier hs-var">this_pkg</span></a><span>
</span><a name="line-180"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="HscTypes.html#UsagePackageModule"><span class="hs-identifier hs-var">UsagePackageModule</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">usg_mod</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628172017"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">,</span><span>
</span><a name="line-181"></a><span>                                 </span><span class="hs-identifier">usg_mod_hash</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628172022"><span class="hs-identifier hs-var">mod_hash</span></a><span class="hs-special">,</span><span>
</span><a name="line-182"></a><span>                                 </span><span class="hs-identifier">usg_safe</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628172025"><span class="hs-identifier hs-var">imp_safe</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-183"></a><span>        </span><span class="hs-comment">-- for package modules, we record the module hash only</span><span>
</span><a name="line-184"></a><span>
</span><a name="line-185"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1628172026"><span class="hs-identifier hs-var">used_occs</span></a><span>
</span><a name="line-186"></a><span>          </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#isNothing"><span class="hs-identifier hs-var">isNothing</span></a><span> </span><a href="#local-1628172023"><span class="hs-identifier hs-var">export_hash</span></a><span>
</span><a name="line-187"></a><span>          </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-1628172024"><span class="hs-identifier hs-var">is_direct_import</span></a><span>
</span><a name="line-188"></a><span>          </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-1628172020"><span class="hs-identifier hs-var">finsts_mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-189"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>                 </span><span class="hs-comment">-- Record no usage info</span><span>
</span><a name="line-190"></a><span>        </span><span class="hs-comment">-- for directly-imported modules, we always want to record a usage</span><span>
</span><a name="line-191"></a><span>        </span><span class="hs-comment">-- on the orphan hash.  This is what triggers a recompilation if</span><span>
</span><a name="line-192"></a><span>        </span><span class="hs-comment">-- an orphan is added or removed somewhere below us in the future.</span><span>
</span><a name="line-193"></a><span>
</span><a name="line-194"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-195"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="HscTypes.html#UsageHomeModule"><span class="hs-identifier hs-var">UsageHomeModule</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-196"></a><span>                      </span><span class="hs-identifier">usg_mod_name</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-1628172017"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">,</span><span>
</span><a name="line-197"></a><span>                      </span><span class="hs-identifier">usg_mod_hash</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628172022"><span class="hs-identifier hs-var">mod_hash</span></a><span class="hs-special">,</span><span>
</span><a name="line-198"></a><span>                      </span><span class="hs-identifier">usg_exports</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628172023"><span class="hs-identifier hs-var">export_hash</span></a><span class="hs-special">,</span><span>
</span><a name="line-199"></a><span>                      </span><span class="hs-identifier">usg_entities</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../containers-0.5.7.1/src/%{MODULE/./-}.html#%{NAME}/Data.Map.Base.html#toList"><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">toList</span></a><span> </span><a href="#local-1628172027"><span class="hs-identifier hs-var">ent_hashs</span></a><span class="hs-special">,</span><span>
</span><a name="line-200"></a><span>                      </span><span class="hs-identifier">usg_safe</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628172025"><span class="hs-identifier hs-var">imp_safe</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-201"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-202"></a><span>        </span><a name="local-1628172018"><a href="#local-1628172018"><span class="hs-identifier">maybe_iface</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="HscTypes.html#lookupIfaceByModule"><span class="hs-identifier hs-var">lookupIfaceByModule</span></a><span> </span><a href="#local-1628172003"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-1628172002"><span class="hs-identifier hs-var">hpt</span></a><span> </span><a href="#local-1628171997"><span class="hs-identifier hs-var">pit</span></a><span> </span><a href="#local-1628172017"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-203"></a><span>                </span><span class="hs-comment">-- In one-shot mode, the interfaces for home-package</span><span>
</span><a name="line-204"></a><span>                </span><span class="hs-comment">-- modules accumulate in the PIT not HPT.  Sigh.</span><span>
</span><a name="line-205"></a><span>
</span><a name="line-206"></a><span>        </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628172019"><a href="#local-1628172019"><span class="hs-identifier">iface</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628172018"><span class="hs-identifier hs-var">maybe_iface</span></a><span>
</span><a name="line-207"></a><span>        </span><a name="local-1628172020"><a href="#local-1628172020"><span class="hs-identifier">finsts_mod</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mi_finsts</span><span>    </span><a href="#local-1628172019"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-208"></a><span>        </span><a name="local-1628172021"><a href="#local-1628172021"><span class="hs-identifier">hash_env</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mi_hash_fn</span><span>   </span><a href="#local-1628172019"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-209"></a><span>        </span><a name="local-1628172022"><a href="#local-1628172022"><span class="hs-identifier">mod_hash</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mi_mod_hash</span><span>  </span><a href="#local-1628172019"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-210"></a><span>        </span><a name="local-1628172023"><a href="#local-1628172023"><span class="hs-identifier">export_hash</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628172029"><span class="hs-identifier hs-var">depend_on_exports</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_exp_hash</span><span> </span><a href="#local-1628172019"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span>
</span><a name="line-211"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-212"></a><span>
</span><a name="line-213"></a><span>        </span><span class="hs-special">(</span><a name="local-1628172024"><a href="#local-1628172024"><span class="hs-identifier">is_direct_import</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628172025"><a href="#local-1628172025"><span class="hs-identifier">imp_safe</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-214"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Module.html#lookupModuleEnv"><span class="hs-identifier hs-var">lookupModuleEnv</span></a><span> </span><a href="#local-1628172000"><span class="hs-identifier hs-var">direct_imports</span></a><span> </span><a href="#local-1628172017"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-215"></a><span>                </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1628172030"><a href="#local-1628172030"><span class="hs-identifier">imv</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-1628172031"><a href="#local-1628172031"><span class="hs-identifier">_xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">imv_is_safe</span><span> </span><a href="#local-1628172030"><span class="hs-identifier hs-var">imv</span></a><span class="hs-special">)</span><span>
</span><a name="line-216"></a><span>                </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-identifier">_</span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;mkUsage: empty direct import&quot;</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">Outputable</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-217"></a><span>                </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><a href="DynFlags.html#safeImplicitImpsReq"><span class="hs-identifier hs-var">safeImplicitImpsReq</span></a><span> </span><a href="#local-1628172003"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-218"></a><span>                </span><span class="hs-comment">-- Nothing case is for implicit imports like 'System.IO' when 'putStrLn'</span><span>
</span><a name="line-219"></a><span>                </span><span class="hs-comment">-- is used in the source code. We require them to be safe in Safe Haskell</span><span>
</span><a name="line-220"></a><span>
</span><a name="line-221"></a><span>        </span><a name="local-1628172026"><a href="#local-1628172026"><span class="hs-identifier">used_occs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Module.html#lookupModuleEnv"><span class="hs-identifier hs-var">lookupModuleEnv</span></a><span> </span><a href="#local-1628172009"><span class="hs-identifier hs-var">ent_map</span></a><span> </span><a href="#local-1628172017"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-special">`</span><a href="Maybes.html#orElse"><span class="hs-identifier hs-var">orElse</span></a><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-222"></a><span>
</span><a name="line-223"></a><span>        </span><span class="hs-comment">-- Making a Map here ensures that (a) we remove duplicates</span><span>
</span><a name="line-224"></a><span>        </span><span class="hs-comment">-- when we have usages on several subordinates of a single parent,</span><span>
</span><a name="line-225"></a><span>        </span><span class="hs-comment">-- and (b) that the usages emerge in a canonical order, which</span><span>
</span><a name="line-226"></a><span>        </span><span class="hs-comment">-- is why we use Map rather than OccEnv: Map works</span><span>
</span><a name="line-227"></a><span>        </span><span class="hs-comment">-- using Ord on the OccNames, which is a lexicographic ordering.</span><span>
</span><a name="line-228"></a><span>        </span><span class="hs-identifier">ent_hashs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../containers-0.5.7.1/src/%{MODULE/./-}.html#%{NAME}/Data.Map.Base.html#Map"><span class="hs-identifier hs-type">Map</span></a><span> </span><a href="OccName.html#OccName"><span class="hs-identifier hs-type">OccName</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Fingerprint.Type.html#Fingerprint"><span class="hs-identifier hs-type">Fingerprint</span></a><span>
</span><a name="line-229"></a><span>        </span><a name="local-1628172027"><a href="#local-1628172027"><span class="hs-identifier">ent_hashs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../containers-0.5.7.1/src/%{MODULE/./-}.html#%{NAME}/Data.Map.Base.html#fromList"><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromList</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="#local-1628172028"><span class="hs-identifier hs-var">lookup_occ</span></a><span> </span><a href="#local-1628172026"><span class="hs-identifier hs-var">used_occs</span></a><span class="hs-special">)</span><span>
</span><a name="line-230"></a><span>
</span><a name="line-231"></a><span>        </span><a name="local-1628172028"><a href="#local-1628172028"><span class="hs-identifier">lookup_occ</span></a></a><span> </span><a name="local-1628172032"><a href="#local-1628172032"><span class="hs-identifier">occ</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-232"></a><span>            </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628172021"><span class="hs-identifier hs-var">hash_env</span></a><span> </span><a href="#local-1628172032"><span class="hs-identifier hs-var">occ</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-233"></a><span>                </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;mkUsage&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628172017"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628172032"><span class="hs-identifier hs-var">occ</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628172001"><span class="hs-identifier hs-var">used_names</span></a><span class="hs-special">)</span><span>
</span><a name="line-234"></a><span>                </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628172033"><a href="#local-1628172033"><span class="hs-identifier">r</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628172033"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-235"></a><span>
</span><a name="line-236"></a><span>        </span><a name="local-1628172029"><a href="#local-1628172029"><span class="hs-identifier">depend_on_exports</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628172024"><span class="hs-identifier hs-var">is_direct_import</span></a><span>
</span><a name="line-237"></a><span>        </span><span class="hs-comment">{- True
              Even if we used 'import M ()', we have to register a
              usage on the export list because we are sensitive to
              changes in orphan instances/rules.
           False
              In GHC 6.8.x we always returned true, and in
              fact it recorded a dependency on *all* the
              modules underneath in the dependency tree.  This
              happens to make orphans work right, but is too
              expensive: it'll read too many interface files.
              The 'isNothing maybe_iface' check above saved us
              from generating many of these usages (at least in
              one-shot mode), but that's even more bogus!
        -}</span><span>
</span><a name="line-251"></a><span>
</span><a name="line-252"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
*              The main function: deSugar
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-259"></a><span>
</span><a name="line-260"></a><span class="hs-comment">-- | Main entry point to the desugarer.</span><span>
</span><a name="line-261"></a><span class="hs-identifier">deSugar</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HscTypes.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Module.html#ModLocation"><span class="hs-identifier hs-type">ModLocation</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcGblEnv"><span class="hs-identifier hs-type">TcGblEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="ErrUtils.html#Messages"><span class="hs-identifier hs-type">Messages</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="HscTypes.html#ModGuts"><span class="hs-identifier hs-type">ModGuts</span></a><span class="hs-special">)</span><span>
</span><a name="line-262"></a><span class="hs-comment">-- Can modify PCS by faulting in more declarations</span><span>
</span><a name="line-263"></a><span>
</span><a name="line-264"></a><a name="deSugar"><a href="Desugar.html#deSugar"><span class="hs-identifier">deSugar</span></a></a><span> </span><a name="local-1628172034"><a href="#local-1628172034"><span class="hs-identifier">hsc_env</span></a></a><span>
</span><a name="line-265"></a><span>        </span><a name="local-1628172035"><a href="#local-1628172035"><span class="hs-identifier">mod_loc</span></a></a><span>
</span><a name="line-266"></a><span>        </span><a name="local-1628172036"><a href="#local-1628172036"><span class="hs-identifier">tcg_env</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TcRnTypes.html#TcGblEnv"><span class="hs-identifier hs-var">TcGblEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_mod</span><span>          </span><span class="hs-glyph">=</span><span> </span><a name="local-1628172037"><a href="#local-1628172037"><span class="hs-identifier">mod</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-267"></a><span>                            </span><span class="hs-identifier">tcg_src</span><span>          </span><span class="hs-glyph">=</span><span> </span><a name="local-1628172038"><a href="#local-1628172038"><span class="hs-identifier">hsc_src</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-268"></a><span>                            </span><span class="hs-identifier">tcg_type_env</span><span>     </span><span class="hs-glyph">=</span><span> </span><a name="local-1628172039"><a href="#local-1628172039"><span class="hs-identifier">type_env</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-269"></a><span>                            </span><span class="hs-identifier">tcg_imports</span><span>      </span><span class="hs-glyph">=</span><span> </span><a name="local-1628172040"><a href="#local-1628172040"><span class="hs-identifier">imports</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-270"></a><span>                            </span><span class="hs-identifier">tcg_exports</span><span>      </span><span class="hs-glyph">=</span><span> </span><a name="local-1628172041"><a href="#local-1628172041"><span class="hs-identifier">exports</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-271"></a><span>                            </span><span class="hs-identifier">tcg_keep</span><span>         </span><span class="hs-glyph">=</span><span> </span><a name="local-1628172042"><a href="#local-1628172042"><span class="hs-identifier">keep_var</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-272"></a><span>                            </span><span class="hs-identifier">tcg_th_splice_used</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628172043"><a href="#local-1628172043"><span class="hs-identifier">tc_splice_used</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-273"></a><span>                            </span><span class="hs-identifier">tcg_rdr_env</span><span>      </span><span class="hs-glyph">=</span><span> </span><a name="local-1628172044"><a href="#local-1628172044"><span class="hs-identifier">rdr_env</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-274"></a><span>                            </span><span class="hs-identifier">tcg_fix_env</span><span>      </span><span class="hs-glyph">=</span><span> </span><a name="local-1628172045"><a href="#local-1628172045"><span class="hs-identifier">fix_env</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-275"></a><span>                            </span><span class="hs-identifier">tcg_inst_env</span><span>     </span><span class="hs-glyph">=</span><span> </span><a name="local-1628172046"><a href="#local-1628172046"><span class="hs-identifier">inst_env</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-276"></a><span>                            </span><span class="hs-identifier">tcg_fam_inst_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628172047"><a href="#local-1628172047"><span class="hs-identifier">fam_inst_env</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-277"></a><span>                            </span><span class="hs-identifier">tcg_warns</span><span>        </span><span class="hs-glyph">=</span><span> </span><a name="local-1628172048"><a href="#local-1628172048"><span class="hs-identifier">warns</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-278"></a><span>                            </span><span class="hs-identifier">tcg_anns</span><span>         </span><span class="hs-glyph">=</span><span> </span><a name="local-1628172049"><a href="#local-1628172049"><span class="hs-identifier">anns</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-279"></a><span>                            </span><span class="hs-identifier">tcg_binds</span><span>        </span><span class="hs-glyph">=</span><span> </span><a name="local-1628172050"><a href="#local-1628172050"><span class="hs-identifier">binds</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-280"></a><span>                            </span><span class="hs-identifier">tcg_imp_specs</span><span>    </span><span class="hs-glyph">=</span><span> </span><a name="local-1628172051"><a href="#local-1628172051"><span class="hs-identifier">imp_specs</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-281"></a><span>                            </span><span class="hs-identifier">tcg_dependent_files</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628172052"><a href="#local-1628172052"><span class="hs-identifier">dependent_files</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-282"></a><span>                            </span><span class="hs-identifier">tcg_ev_binds</span><span>     </span><span class="hs-glyph">=</span><span> </span><a name="local-1628172053"><a href="#local-1628172053"><span class="hs-identifier">ev_binds</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-283"></a><span>                            </span><span class="hs-identifier">tcg_fords</span><span>        </span><span class="hs-glyph">=</span><span> </span><a name="local-1628172054"><a href="#local-1628172054"><span class="hs-identifier">fords</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-284"></a><span>                            </span><span class="hs-identifier">tcg_rules</span><span>        </span><span class="hs-glyph">=</span><span> </span><a name="local-1628172055"><a href="#local-1628172055"><span class="hs-identifier">rules</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-285"></a><span>                            </span><span class="hs-identifier">tcg_vects</span><span>        </span><span class="hs-glyph">=</span><span> </span><a name="local-1628172056"><a href="#local-1628172056"><span class="hs-identifier">vects</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-286"></a><span>                            </span><span class="hs-identifier">tcg_patsyns</span><span>      </span><span class="hs-glyph">=</span><span> </span><a name="local-1628172057"><a href="#local-1628172057"><span class="hs-identifier">patsyns</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-287"></a><span>                            </span><span class="hs-identifier">tcg_tcs</span><span>          </span><span class="hs-glyph">=</span><span> </span><a name="local-1628172058"><a href="#local-1628172058"><span class="hs-identifier">tcs</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-288"></a><span>                            </span><span class="hs-identifier">tcg_insts</span><span>        </span><span class="hs-glyph">=</span><span> </span><a name="local-1628172059"><a href="#local-1628172059"><span class="hs-identifier">insts</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-289"></a><span>                            </span><span class="hs-identifier">tcg_fam_insts</span><span>    </span><span class="hs-glyph">=</span><span> </span><a name="local-1628172060"><a href="#local-1628172060"><span class="hs-identifier">fam_insts</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-290"></a><span>                            </span><span class="hs-identifier">tcg_hpc</span><span>          </span><span class="hs-glyph">=</span><span> </span><a name="local-1628172061"><a href="#local-1628172061"><span class="hs-identifier">other_hpc_info</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-291"></a><span>
</span><a name="line-292"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628172062"><a href="#local-1628172062"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-1628172034"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-293"></a><span>             </span><a name="local-1628172063"><a href="#local-1628172063"><span class="hs-identifier">print_unqual</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="HscTypes.html#mkPrintUnqualified"><span class="hs-identifier hs-var">mkPrintUnqualified</span></a><span> </span><a href="#local-1628172062"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-1628172044"><span class="hs-identifier hs-var">rdr_env</span></a><span>
</span><a name="line-294"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="ErrUtils.html#withTiming"><span class="hs-identifier hs-var">withTiming</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a><span> </span><a href="#local-1628172062"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-295"></a><span>                     </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Desugar&quot;</span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><a href="Outputable.html#brackets"><span class="hs-identifier hs-var">brackets</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628172037"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-296"></a><span>                     </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#const"><span class="hs-identifier hs-var">const</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-297"></a><span>     </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Desugar the program</span><span>
</span><a name="line-298"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628172064"><a href="#local-1628172064"><span class="hs-identifier">export_set</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Avail.html#availsToNameSet"><span class="hs-identifier hs-var">availsToNameSet</span></a><span> </span><a href="#local-1628172041"><span class="hs-identifier hs-var">exports</span></a><span>
</span><a name="line-299"></a><span>              </span><a name="local-1628172065"><a href="#local-1628172065"><span class="hs-identifier">target</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hscTarget</span><span> </span><a href="#local-1628172062"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-300"></a><span>              </span><a name="local-1628172066"><a href="#local-1628172066"><span class="hs-identifier">hpcInfo</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="HscTypes.html#emptyHpcInfo"><span class="hs-identifier hs-var">emptyHpcInfo</span></a><span> </span><a href="#local-1628172061"><span class="hs-identifier hs-var">other_hpc_info</span></a><span>
</span><a name="line-301"></a><span>
</span><a name="line-302"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628172067"><a href="#local-1628172067"><span class="hs-identifier">binds_cvr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628172068"><a href="#local-1628172068"><span class="hs-identifier">ds_hpc_info</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628172069"><a href="#local-1628172069"><span class="hs-identifier">modBreaks</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-303"></a><span>                         </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="DriverPhases.html#isHsBootOrSig"><span class="hs-identifier hs-var">isHsBootOrSig</span></a><span> </span><a href="#local-1628172038"><span class="hs-identifier hs-var">hsc_src</span></a><span class="hs-special">)</span><span>
</span><a name="line-304"></a><span>                              </span><span class="hs-keyword">then</span><span> </span><a href="Coverage.html#addTicksToBinds"><span class="hs-identifier hs-var">addTicksToBinds</span></a><span> </span><a href="#local-1628172034"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-1628172037"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="#local-1628172035"><span class="hs-identifier hs-var">mod_loc</span></a><span>
</span><a name="line-305"></a><span>                                       </span><a href="#local-1628172064"><span class="hs-identifier hs-var">export_set</span></a><span> </span><span class="hs-special">(</span><a href="HscTypes.html#typeEnvTyCons"><span class="hs-identifier hs-var">typeEnvTyCons</span></a><span> </span><a href="#local-1628172039"><span class="hs-identifier hs-var">type_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628172050"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-306"></a><span>                              </span><span class="hs-keyword">else</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628172050"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628172066"><span class="hs-identifier hs-var">hpcInfo</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">)</span><span>
</span><a name="line-307"></a><span>
</span><a name="line-308"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628172081"><a href="#local-1628172081"><span class="hs-identifier">msgs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628172082"><a href="#local-1628172082"><span class="hs-identifier">mb_res</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#initDs"><span class="hs-identifier hs-var">initDs</span></a><span> </span><a href="#local-1628172034"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-1628172037"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="#local-1628172044"><span class="hs-identifier hs-var">rdr_env</span></a><span> </span><a href="#local-1628172039"><span class="hs-identifier hs-var">type_env</span></a><span> </span><a href="#local-1628172047"><span class="hs-identifier hs-var">fam_inst_env</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-309"></a><span>                       </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628172070"><a href="#local-1628172070"><span class="hs-identifier">ds_ev_binds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsBinds.html#dsEvBinds"><span class="hs-identifier hs-var">dsEvBinds</span></a><span> </span><a href="#local-1628172053"><span class="hs-identifier hs-var">ev_binds</span></a><span>
</span><a name="line-310"></a><span>                          </span><span class="hs-special">;</span><span> </span><a name="local-1628172071"><a href="#local-1628172071"><span class="hs-identifier">core_prs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsBinds.html#dsTopLHsBinds"><span class="hs-identifier hs-var">dsTopLHsBinds</span></a><span> </span><a href="#local-1628172067"><span class="hs-identifier hs-var">binds_cvr</span></a><span>
</span><a name="line-311"></a><span>                          </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628172072"><a href="#local-1628172072"><span class="hs-identifier">spec_prs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628172073"><a href="#local-1628172073"><span class="hs-identifier">spec_rules</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Desugar.html#dsImpSpecs"><span class="hs-identifier hs-var">dsImpSpecs</span></a><span> </span><a href="#local-1628172051"><span class="hs-identifier hs-var">imp_specs</span></a><span>
</span><a name="line-312"></a><span>                          </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628172074"><a href="#local-1628172074"><span class="hs-identifier">ds_fords</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628172075"><a href="#local-1628172075"><span class="hs-identifier">foreign_prs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsForeign.html#dsForeigns"><span class="hs-identifier hs-var">dsForeigns</span></a><span> </span><a href="#local-1628172054"><span class="hs-identifier hs-var">fords</span></a><span>
</span><a name="line-313"></a><span>                          </span><span class="hs-special">;</span><span> </span><a name="local-1628172076"><a href="#local-1628172076"><span class="hs-identifier">ds_rules</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="MonadUtils.html#mapMaybeM"><span class="hs-identifier hs-var">mapMaybeM</span></a><span> </span><a href="Desugar.html#dsRule"><span class="hs-identifier hs-var">dsRule</span></a><span> </span><a href="#local-1628172055"><span class="hs-identifier hs-var">rules</span></a><span>
</span><a name="line-314"></a><span>                          </span><span class="hs-special">;</span><span> </span><a name="local-1628172077"><a href="#local-1628172077"><span class="hs-identifier">ds_vects</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><a href="Desugar.html#dsVect"><span class="hs-identifier hs-var">dsVect</span></a><span> </span><a href="#local-1628172056"><span class="hs-identifier hs-var">vects</span></a><span>
</span><a name="line-315"></a><span>                          </span><span class="hs-special">;</span><span> </span><a name="local-1628172078"><a href="#local-1628172078"><span class="hs-identifier">stBinds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#dsGetStaticBindsVar"><span class="hs-identifier hs-var">dsGetStaticBindsVar</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a><span>
</span><a name="line-316"></a><span>                                           </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.IO.Class.html#liftIO"><span class="hs-identifier hs-var">liftIO</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span>
</span><a name="line-317"></a><span>                          </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628172079"><a href="#local-1628172079"><span class="hs-identifier">hpc_init</span></a></a><span>
</span><a name="line-318"></a><span>                                  </span><span class="hs-glyph">|</span><span> </span><a href="DynFlags.html#gopt"><span class="hs-identifier hs-var">gopt</span></a><span> </span><a href="DynFlags.html#Opt_Hpc"><span class="hs-identifier hs-var">Opt_Hpc</span></a><span> </span><a href="#local-1628172062"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coverage.html#hpcInitCode"><span class="hs-identifier hs-var">hpcInitCode</span></a><span> </span><a href="#local-1628172037"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="#local-1628172068"><span class="hs-identifier hs-var">ds_hpc_info</span></a><span>
</span><a name="line-319"></a><span>                                  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-320"></a><span>                                </span><span class="hs-comment">-- Stub to insert the static entries of the</span><span>
</span><a name="line-321"></a><span>                                </span><span class="hs-comment">-- module into the static pointer table</span><span>
</span><a name="line-322"></a><span>                                </span><a name="local-1628172080"><a href="#local-1628172080"><span class="hs-identifier">spt_init</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StaticPtrTable.html#sptInitCode"><span class="hs-identifier hs-var">sptInitCode</span></a><span> </span><a href="#local-1628172037"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="#local-1628172078"><span class="hs-identifier hs-var">stBinds</span></a><span>
</span><a name="line-323"></a><span>                          </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="#local-1628172070"><span class="hs-identifier hs-var">ds_ev_binds</span></a><span>
</span><a name="line-324"></a><span>                                   </span><span class="hs-special">,</span><span> </span><a href="#local-1628172075"><span class="hs-identifier hs-var">foreign_prs</span></a><span> </span><span class="hs-special">`</span><a href="OrdList.html#appOL"><span class="hs-identifier hs-var">appOL</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628172071"><span class="hs-identifier hs-var">core_prs</span></a><span> </span><span class="hs-special">`</span><a href="OrdList.html#appOL"><span class="hs-identifier hs-var">appOL</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628172072"><span class="hs-identifier hs-var">spec_prs</span></a><span>
</span><a name="line-325"></a><span>                                                 </span><span class="hs-special">`</span><a href="OrdList.html#appOL"><span class="hs-identifier hs-var">appOL</span></a><span class="hs-special">`</span><span> </span><a href="OrdList.html#toOL"><span class="hs-identifier hs-var">toOL</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#snd"><span class="hs-identifier hs-var">snd</span></a><span> </span><a href="#local-1628172078"><span class="hs-identifier hs-var">stBinds</span></a><span class="hs-special">)</span><span>
</span><a name="line-326"></a><span>                                   </span><span class="hs-special">,</span><span> </span><a href="#local-1628172073"><span class="hs-identifier hs-var">spec_rules</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-1628172076"><span class="hs-identifier hs-var">ds_rules</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628172077"><span class="hs-identifier hs-var">ds_vects</span></a><span>
</span><a name="line-327"></a><span>                                   </span><span class="hs-special">,</span><span> </span><a href="#local-1628172074"><span class="hs-identifier hs-var">ds_fords</span></a><span> </span><span class="hs-special">`</span><a href="HscTypes.html#appendStubC"><span class="hs-identifier hs-var">appendStubC</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628172079"><span class="hs-identifier hs-var">hpc_init</span></a><span>
</span><a name="line-328"></a><span>                                              </span><span class="hs-special">`</span><a href="HscTypes.html#appendStubC"><span class="hs-identifier hs-var">appendStubC</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628172080"><span class="hs-identifier hs-var">spt_init</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-329"></a><span>
</span><a name="line-330"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628172082"><span class="hs-identifier hs-var">mb_res</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-331"></a><span>           </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628172081"><span class="hs-identifier hs-var">msgs</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-332"></a><span>           </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1628172083"><a href="#local-1628172083"><span class="hs-identifier">ds_ev_binds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628172084"><a href="#local-1628172084"><span class="hs-identifier">all_prs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628172085"><a href="#local-1628172085"><span class="hs-identifier">all_rules</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628172086"><a href="#local-1628172086"><span class="hs-identifier">vects0</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628172087"><a href="#local-1628172087"><span class="hs-identifier">ds_fords</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-333"></a><span>
</span><a name="line-334"></a><span>     </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>       </span><span class="hs-comment">-- Add export flags to bindings</span><span>
</span><a name="line-335"></a><span>          </span><a name="local-1628172088"><a href="#local-1628172088"><span class="hs-identifier">keep_alive</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span> </span><a href="#local-1628172042"><span class="hs-identifier hs-var">keep_var</span></a><span>
</span><a name="line-336"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-1628172089"><a href="#local-1628172089"><span class="hs-identifier">rules_for_locals</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628172090"><a href="#local-1628172090"><span class="hs-identifier">rules_for_imps</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.OldList.html#partition"><span class="hs-identifier hs-var">partition</span></a><span> </span><a href="CoreSyn.html#isLocalRule"><span class="hs-identifier hs-var">isLocalRule</span></a><span> </span><a href="#local-1628172085"><span class="hs-identifier hs-var">all_rules</span></a><span>
</span><a name="line-337"></a><span>              </span><a name="local-1628172091"><a href="#local-1628172091"><span class="hs-identifier">final_prs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Desugar.html#addExportFlagsAndRules"><span class="hs-identifier hs-var">addExportFlagsAndRules</span></a><span> </span><a href="#local-1628172065"><span class="hs-identifier hs-var">target</span></a><span> </span><a href="#local-1628172064"><span class="hs-identifier hs-var">export_set</span></a><span> </span><a href="#local-1628172088"><span class="hs-identifier hs-var">keep_alive</span></a><span>
</span><a name="line-338"></a><span>                                                 </span><a href="#local-1628172089"><span class="hs-identifier hs-var">rules_for_locals</span></a><span> </span><span class="hs-special">(</span><a href="OrdList.html#fromOL"><span class="hs-identifier hs-var">fromOL</span></a><span> </span><a href="#local-1628172084"><span class="hs-identifier hs-var">all_prs</span></a><span class="hs-special">)</span><span>
</span><a name="line-339"></a><span>
</span><a name="line-340"></a><span>              </span><a name="local-1628172092"><a href="#local-1628172092"><span class="hs-identifier">final_pgm</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Desugar.html#combineEvBinds"><span class="hs-identifier hs-var">combineEvBinds</span></a><span> </span><a href="#local-1628172083"><span class="hs-identifier hs-var">ds_ev_binds</span></a><span> </span><a href="#local-1628172091"><span class="hs-identifier hs-var">final_prs</span></a><span>
</span><a name="line-341"></a><span>        </span><span class="hs-comment">-- Notice that we put the whole lot in a big Rec, even the foreign binds</span><span>
</span><a name="line-342"></a><span>        </span><span class="hs-comment">-- When compiling PrelFloat, which defines data Float = F# Float#</span><span>
</span><a name="line-343"></a><span>        </span><span class="hs-comment">-- we want F# to be in scope in the foreign marshalling code!</span><span>
</span><a name="line-344"></a><span>        </span><span class="hs-comment">-- You might think it doesn't matter, but the simplifier brings all top-level</span><span>
</span><a name="line-345"></a><span>        </span><span class="hs-comment">-- things into the in-scope set before simplifying; so we get no unfolding for F#!</span><span>
</span><a name="line-346"></a><span>
</span><a name="line-347"></a><span class="hs-cpp">#ifdef DEBUG</span><span>
</span><a name="line-348"></a><span>          </span><span class="hs-comment">-- Debug only as pre-simple-optimisation program may be really big</span><span>
</span><a name="line-349"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">endPassIO</span><span> </span><span class="hs-identifier">hsc_env</span><span> </span><span class="hs-identifier">print_unqual</span><span> </span><span class="hs-identifier">CoreDesugar</span><span> </span><span class="hs-identifier">final_pgm</span><span> </span><span class="hs-identifier">rules_for_imps</span><span>
</span><a name="line-350"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-351"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628172093"><a href="#local-1628172093"><span class="hs-identifier">ds_binds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628172094"><a href="#local-1628172094"><span class="hs-identifier">ds_rules_for_imps</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628172095"><a href="#local-1628172095"><span class="hs-identifier">ds_vects</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-352"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreSubst.html#simpleOptPgm"><span class="hs-identifier hs-var">simpleOptPgm</span></a><span> </span><a href="#local-1628172062"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-1628172037"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="#local-1628172092"><span class="hs-identifier hs-var">final_pgm</span></a><span> </span><a href="#local-1628172090"><span class="hs-identifier hs-var">rules_for_imps</span></a><span> </span><a href="#local-1628172086"><span class="hs-identifier hs-var">vects0</span></a><span>
</span><a name="line-353"></a><span>                         </span><span class="hs-comment">-- The simpleOptPgm gets rid of type</span><span>
</span><a name="line-354"></a><span>                         </span><span class="hs-comment">-- bindings plus any stupid dead code</span><span>
</span><a name="line-355"></a><span>
</span><a name="line-356"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="CoreLint.html#endPassIO"><span class="hs-identifier hs-var">endPassIO</span></a><span> </span><a href="#local-1628172034"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-1628172063"><span class="hs-identifier hs-var">print_unqual</span></a><span> </span><a href="CoreMonad.html#CoreDesugarOpt"><span class="hs-identifier hs-var">CoreDesugarOpt</span></a><span> </span><a href="#local-1628172093"><span class="hs-identifier hs-var">ds_binds</span></a><span> </span><a href="#local-1628172094"><span class="hs-identifier hs-var">ds_rules_for_imps</span></a><span>
</span><a name="line-357"></a><span>
</span><a name="line-358"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628172096"><a href="#local-1628172096"><span class="hs-identifier">used_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Desugar.html#mkUsedNames"><span class="hs-identifier hs-var">mkUsedNames</span></a><span> </span><a href="#local-1628172036"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-359"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-1628172097"><a href="#local-1628172097"><span class="hs-identifier">deps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Desugar.html#mkDependencies"><span class="hs-identifier hs-var">mkDependencies</span></a><span> </span><a href="#local-1628172036"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-360"></a><span>
</span><a name="line-361"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-1628172098"><a href="#local-1628172098"><span class="hs-identifier">used_th</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span> </span><a href="#local-1628172043"><span class="hs-identifier hs-var">tc_splice_used</span></a><span>
</span><a name="line-362"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-1628172099"><a href="#local-1628172099"><span class="hs-identifier">dep_files</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a><span> </span><a href="#local-1628172052"><span class="hs-identifier hs-var">dependent_files</span></a><span>
</span><a name="line-363"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-1628172100"><a href="#local-1628172100"><span class="hs-identifier">safe_mode</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#finalSafeMode"><span class="hs-identifier hs-var">finalSafeMode</span></a><span> </span><a href="#local-1628172062"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-1628172036"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-364"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-1628172101"><a href="#local-1628172101"><span class="hs-identifier">usages</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Desugar.html#mkUsageInfo"><span class="hs-identifier hs-var">mkUsageInfo</span></a><span> </span><a href="#local-1628172034"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-1628172037"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">imp_mods</span><span> </span><a href="#local-1628172040"><span class="hs-identifier hs-var">imports</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628172096"><span class="hs-identifier hs-var">used_names</span></a><span> </span><a href="#local-1628172099"><span class="hs-identifier hs-var">dep_files</span></a><span>
</span><a name="line-365"></a><span>
</span><a name="line-366"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628172102"><a href="#local-1628172102"><span class="hs-identifier">mod_guts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="HscTypes.html#ModGuts"><span class="hs-identifier hs-var">ModGuts</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-367"></a><span>                </span><span class="hs-identifier">mg_module</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628172037"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">,</span><span>
</span><a name="line-368"></a><span>                </span><span class="hs-identifier">mg_hsc_src</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628172038"><span class="hs-identifier hs-var">hsc_src</span></a><span class="hs-special">,</span><span>
</span><a name="line-369"></a><span>                </span><span class="hs-identifier">mg_loc</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="Desugar.html#mkFileSrcSpan"><span class="hs-identifier hs-var">mkFileSrcSpan</span></a><span> </span><a href="#local-1628172035"><span class="hs-identifier hs-var">mod_loc</span></a><span class="hs-special">,</span><span>
</span><a name="line-370"></a><span>                </span><span class="hs-identifier">mg_exports</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628172041"><span class="hs-identifier hs-var">exports</span></a><span class="hs-special">,</span><span>
</span><a name="line-371"></a><span>                </span><span class="hs-identifier">mg_usages</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628172101"><span class="hs-identifier hs-var">usages</span></a><span class="hs-special">,</span><span>
</span><a name="line-372"></a><span>                </span><span class="hs-identifier">mg_deps</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628172097"><span class="hs-identifier hs-var">deps</span></a><span class="hs-special">,</span><span>
</span><a name="line-373"></a><span>                </span><span class="hs-identifier">mg_used_th</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628172098"><span class="hs-identifier hs-var">used_th</span></a><span class="hs-special">,</span><span>
</span><a name="line-374"></a><span>                </span><span class="hs-identifier">mg_rdr_env</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628172044"><span class="hs-identifier hs-var">rdr_env</span></a><span class="hs-special">,</span><span>
</span><a name="line-375"></a><span>                </span><span class="hs-identifier">mg_fix_env</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628172045"><span class="hs-identifier hs-var">fix_env</span></a><span class="hs-special">,</span><span>
</span><a name="line-376"></a><span>                </span><span class="hs-identifier">mg_warns</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628172048"><span class="hs-identifier hs-var">warns</span></a><span class="hs-special">,</span><span>
</span><a name="line-377"></a><span>                </span><span class="hs-identifier">mg_anns</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628172049"><span class="hs-identifier hs-var">anns</span></a><span class="hs-special">,</span><span>
</span><a name="line-378"></a><span>                </span><span class="hs-identifier">mg_tcs</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628172058"><span class="hs-identifier hs-var">tcs</span></a><span class="hs-special">,</span><span>
</span><a name="line-379"></a><span>                </span><span class="hs-identifier">mg_insts</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#fixSafeInstances"><span class="hs-identifier hs-var">fixSafeInstances</span></a><span> </span><a href="#local-1628172100"><span class="hs-identifier hs-var">safe_mode</span></a><span> </span><a href="#local-1628172059"><span class="hs-identifier hs-var">insts</span></a><span class="hs-special">,</span><span>
</span><a name="line-380"></a><span>                </span><span class="hs-identifier">mg_fam_insts</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628172060"><span class="hs-identifier hs-var">fam_insts</span></a><span class="hs-special">,</span><span>
</span><a name="line-381"></a><span>                </span><span class="hs-identifier">mg_inst_env</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628172046"><span class="hs-identifier hs-var">inst_env</span></a><span class="hs-special">,</span><span>
</span><a name="line-382"></a><span>                </span><span class="hs-identifier">mg_fam_inst_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628172047"><span class="hs-identifier hs-var">fam_inst_env</span></a><span class="hs-special">,</span><span>
</span><a name="line-383"></a><span>                </span><span class="hs-identifier">mg_patsyns</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628172057"><span class="hs-identifier hs-var">patsyns</span></a><span class="hs-special">,</span><span>
</span><a name="line-384"></a><span>                </span><span class="hs-identifier">mg_rules</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628172094"><span class="hs-identifier hs-var">ds_rules_for_imps</span></a><span class="hs-special">,</span><span>
</span><a name="line-385"></a><span>                </span><span class="hs-identifier">mg_binds</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628172093"><span class="hs-identifier hs-var">ds_binds</span></a><span class="hs-special">,</span><span>
</span><a name="line-386"></a><span>                </span><span class="hs-identifier">mg_foreign</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628172087"><span class="hs-identifier hs-var">ds_fords</span></a><span class="hs-special">,</span><span>
</span><a name="line-387"></a><span>                </span><span class="hs-identifier">mg_hpc_info</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628172068"><span class="hs-identifier hs-var">ds_hpc_info</span></a><span class="hs-special">,</span><span>
</span><a name="line-388"></a><span>                </span><span class="hs-identifier">mg_modBreaks</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628172069"><span class="hs-identifier hs-var">modBreaks</span></a><span class="hs-special">,</span><span>
</span><a name="line-389"></a><span>                </span><span class="hs-identifier">mg_vect_decls</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628172095"><span class="hs-identifier hs-var">ds_vects</span></a><span class="hs-special">,</span><span>
</span><a name="line-390"></a><span>                </span><span class="hs-identifier">mg_vect_info</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="HscTypes.html#noVectInfo"><span class="hs-identifier hs-var">noVectInfo</span></a><span class="hs-special">,</span><span>
</span><a name="line-391"></a><span>                </span><span class="hs-identifier">mg_safe_haskell</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628172100"><span class="hs-identifier hs-var">safe_mode</span></a><span class="hs-special">,</span><span>
</span><a name="line-392"></a><span>                </span><span class="hs-identifier">mg_trust_pkg</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">imp_trust_own_pkg</span><span> </span><a href="#local-1628172040"><span class="hs-identifier hs-var">imports</span></a><span>
</span><a name="line-393"></a><span>              </span><span class="hs-special">}</span><span>
</span><a name="line-394"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628172081"><span class="hs-identifier hs-var">msgs</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-1628172102"><span class="hs-identifier hs-var">mod_guts</span></a><span class="hs-special">)</span><span>
</span><a name="line-395"></a><span>        </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-396"></a><span>
</span><a name="line-397"></a><span class="hs-identifier">mkFileSrcSpan</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Module.html#ModLocation"><span class="hs-identifier hs-type">ModLocation</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SrcLoc.html#SrcSpan"><span class="hs-identifier hs-type">SrcSpan</span></a><span>
</span><a name="line-398"></a><a name="mkFileSrcSpan"><a href="Desugar.html#mkFileSrcSpan"><span class="hs-identifier">mkFileSrcSpan</span></a></a><span> </span><a name="local-1628172103"><a href="#local-1628172103"><span class="hs-identifier">mod_loc</span></a></a><span>
</span><a name="line-399"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">ml_hs_file</span><span> </span><a href="#local-1628172103"><span class="hs-identifier hs-var">mod_loc</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-400"></a><span>      </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628172104"><a href="#local-1628172104"><span class="hs-identifier">file_path</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SrcLoc.html#mkGeneralSrcSpan"><span class="hs-identifier hs-var">mkGeneralSrcSpan</span></a><span> </span><span class="hs-special">(</span><a href="FastString.html#mkFastString"><span class="hs-identifier hs-var">mkFastString</span></a><span> </span><a href="#local-1628172104"><span class="hs-identifier hs-var">file_path</span></a><span class="hs-special">)</span><span>
</span><a name="line-401"></a><span>      </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SrcLoc.html#interactiveSrcSpan"><span class="hs-identifier hs-var">interactiveSrcSpan</span></a><span>   </span><span class="hs-comment">-- Presumably</span><span>
</span><a name="line-402"></a><span>
</span><a name="line-403"></a><span class="hs-identifier">dsImpSpecs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="HsBinds.html#LTcSpecPrag"><span class="hs-identifier hs-type">LTcSpecPrag</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#DsM"><span class="hs-identifier hs-type">DsM</span></a><span> </span><span class="hs-special">(</span><a href="OrdList.html#OrdList"><span class="hs-identifier hs-type">OrdList</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">,</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-404"></a><a name="dsImpSpecs"><a href="Desugar.html#dsImpSpecs"><span class="hs-identifier">dsImpSpecs</span></a></a><span> </span><a name="local-1628172105"><a href="#local-1628172105"><span class="hs-identifier">imp_specs</span></a></a><span>
</span><a name="line-405"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628172106"><a href="#local-1628172106"><span class="hs-identifier">spec_prs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="MonadUtils.html#mapMaybeM"><span class="hs-identifier hs-var">mapMaybeM</span></a><span> </span><span class="hs-special">(</span><a href="DsBinds.html#dsSpec"><span class="hs-identifier hs-var">dsSpec</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628172105"><span class="hs-identifier hs-var">imp_specs</span></a><span>
</span><a name="line-406"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-1628172107"><a href="#local-1628172107"><span class="hs-identifier">spec_binds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628172108"><a href="#local-1628172108"><span class="hs-identifier">spec_rules</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#unzip"><span class="hs-identifier hs-var">unzip</span></a><span> </span><a href="#local-1628172106"><span class="hs-identifier hs-var">spec_prs</span></a><span>
</span><a name="line-407"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="OrdList.html#concatOL"><span class="hs-identifier hs-var">concatOL</span></a><span> </span><a href="#local-1628172107"><span class="hs-identifier hs-var">spec_binds</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628172108"><span class="hs-identifier hs-var">spec_rules</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-408"></a><span>
</span><a name="line-409"></a><span class="hs-identifier">combineEvBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">,</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a><span class="hs-special">]</span><span>
</span><a name="line-410"></a><span class="hs-comment">-- Top-level bindings can include coercion bindings, but not via superclasses</span><span>
</span><a name="line-411"></a><span class="hs-comment">-- See Note [Top-level evidence]</span><span>
</span><a name="line-412"></a><a name="combineEvBinds"><a href="Desugar.html#combineEvBinds"><span class="hs-identifier">combineEvBinds</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-1628172109"><a href="#local-1628172109"><span class="hs-identifier">val_prs</span></a></a><span>
</span><a name="line-413"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><a href="#local-1628172109"><span class="hs-identifier hs-var">val_prs</span></a><span class="hs-special">]</span><span>
</span><a name="line-414"></a><span class="hs-identifier">combineEvBinds</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a name="local-1628172110"><a href="#local-1628172110"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-1628172111"><a href="#local-1628172111"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-1628172112"><a href="#local-1628172112"><span class="hs-identifier">bs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1628172113"><a href="#local-1628172113"><span class="hs-identifier">val_prs</span></a></a><span>
</span><a name="line-415"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isId"><span class="hs-identifier hs-var">isId</span></a><span> </span><a href="#local-1628172110"><span class="hs-identifier hs-var">b</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Desugar.html#combineEvBinds"><span class="hs-identifier hs-var">combineEvBinds</span></a><span> </span><a href="#local-1628172112"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-1628172110"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">,</span><a href="#local-1628172111"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span class="hs-glyph">:</span><a href="#local-1628172113"><span class="hs-identifier hs-var">val_prs</span></a><span class="hs-special">)</span><span>
</span><a name="line-416"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a href="#local-1628172110"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-1628172111"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="Desugar.html#combineEvBinds"><span class="hs-identifier hs-var">combineEvBinds</span></a><span> </span><a href="#local-1628172112"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="#local-1628172113"><span class="hs-identifier hs-var">val_prs</span></a><span>
</span><a name="line-417"></a><span class="hs-identifier">combineEvBinds</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><a name="local-1628172114"><a href="#local-1628172114"><span class="hs-identifier">prs</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-1628172115"><a href="#local-1628172115"><span class="hs-identifier">bs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1628172116"><a href="#local-1628172116"><span class="hs-identifier">val_prs</span></a></a><span>
</span><a name="line-418"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Desugar.html#combineEvBinds"><span class="hs-identifier hs-var">combineEvBinds</span></a><span> </span><a href="#local-1628172115"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628172114"><span class="hs-identifier hs-var">prs</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-1628172116"><span class="hs-identifier hs-var">val_prs</span></a><span class="hs-special">)</span><span>
</span><a name="line-419"></a><span>
</span><a name="line-420"></a><span class="hs-comment">{-
Note [Top-level evidence]
~~~~~~~~~~~~~~~~~~~~~~~~~
Top-level evidence bindings may be mutually recursive with the top-level value
bindings, so we must put those in a Rec.  But we can't put them *all* in a Rec
because the occurrence analyser doesn't teke account of type/coercion variables
when computing dependencies.

So we pull out the type/coercion variables (which are in dependency order),
and Rec the rest.
-}</span><span>
</span><a name="line-431"></a><span>
</span><a name="line-432"></a><span class="hs-identifier">deSugarExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HscTypes.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HsExpr.html#LHsExpr"><span class="hs-identifier hs-type">LHsExpr</span></a><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="ErrUtils.html#Messages"><span class="hs-identifier hs-type">Messages</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-433"></a><span>
</span><a name="line-434"></a><a name="deSugarExpr"><a href="Desugar.html#deSugarExpr"><span class="hs-identifier">deSugarExpr</span></a></a><span> </span><a name="local-1628172117"><a href="#local-1628172117"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-1628172118"><a href="#local-1628172118"><span class="hs-identifier">tc_expr</span></a></a><span>
</span><a name="line-435"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628172119"><a href="#local-1628172119"><span class="hs-identifier">dflags</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-1628172117"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-436"></a><span>             </span><a name="local-1628172120"><a href="#local-1628172120"><span class="hs-identifier">icntxt</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_IC</span><span> </span><a href="#local-1628172117"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-437"></a><span>             </span><a name="local-1628172121"><a href="#local-1628172121"><span class="hs-identifier">rdr_env</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ic_rn_gbl_env</span><span> </span><a href="#local-1628172120"><span class="hs-identifier hs-var">icntxt</span></a><span>
</span><a name="line-438"></a><span>             </span><a name="local-1628172122"><a href="#local-1628172122"><span class="hs-identifier">type_env</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="HscTypes.html#mkTypeEnvWithImplicits"><span class="hs-identifier hs-var">mkTypeEnvWithImplicits</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ic_tythings</span><span> </span><a href="#local-1628172120"><span class="hs-identifier hs-var">icntxt</span></a><span class="hs-special">)</span><span>
</span><a name="line-439"></a><span>             </span><a name="local-1628172123"><a href="#local-1628172123"><span class="hs-identifier">fam_insts</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#snd"><span class="hs-identifier hs-var">snd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ic_instances</span><span> </span><a href="#local-1628172120"><span class="hs-identifier hs-var">icntxt</span></a><span class="hs-special">)</span><span>
</span><a name="line-440"></a><span>             </span><a name="local-1628172124"><a href="#local-1628172124"><span class="hs-identifier">fam_inst_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#extendFamInstEnvList"><span class="hs-identifier hs-var">extendFamInstEnvList</span></a><span> </span><a href="FamInstEnv.html#emptyFamInstEnv"><span class="hs-identifier hs-var">emptyFamInstEnv</span></a><span> </span><a href="#local-1628172123"><span class="hs-identifier hs-var">fam_insts</span></a><span>
</span><a name="line-441"></a><span>             </span><span class="hs-comment">-- This stuff is a half baked version of TcRnDriver.setInteractiveContext</span><span>
</span><a name="line-442"></a><span>
</span><a name="line-443"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="ErrUtils.html#showPass"><span class="hs-identifier hs-var">showPass</span></a><span> </span><a href="#local-1628172119"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-string">&quot;Desugar&quot;</span><span>
</span><a name="line-444"></a><span>
</span><a name="line-445"></a><span>         </span><span class="hs-comment">-- Do desugaring</span><span>
</span><a name="line-446"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628172125"><a href="#local-1628172125"><span class="hs-identifier">msgs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628172126"><a href="#local-1628172126"><span class="hs-identifier">mb_core_expr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#initDs"><span class="hs-identifier hs-var">initDs</span></a><span> </span><a href="#local-1628172117"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><a href="HscTypes.html#icInteractiveModule"><span class="hs-identifier hs-var">icInteractiveModule</span></a><span> </span><a href="#local-1628172120"><span class="hs-identifier hs-var">icntxt</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628172121"><span class="hs-identifier hs-var">rdr_env</span></a><span>
</span><a name="line-447"></a><span>                                        </span><a href="#local-1628172122"><span class="hs-identifier hs-var">type_env</span></a><span> </span><a href="#local-1628172124"><span class="hs-identifier hs-var">fam_inst_env</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-448"></a><span>                                 </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-1628172118"><span class="hs-identifier hs-var">tc_expr</span></a><span>
</span><a name="line-449"></a><span>
</span><a name="line-450"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628172126"><span class="hs-identifier hs-var">mb_core_expr</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-451"></a><span>            </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-452"></a><span>            </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628172127"><a href="#local-1628172127"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ErrUtils.html#dumpIfSet_dyn"><span class="hs-identifier hs-var">dumpIfSet_dyn</span></a><span> </span><a href="#local-1628172119"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="DynFlags.html#Opt_D_dump_ds"><span class="hs-identifier hs-var">Opt_D_dump_ds</span></a><span> </span><span class="hs-string">&quot;Desugared&quot;</span><span> </span><span class="hs-special">(</span><a href="PprCore.html#pprCoreExpr"><span class="hs-identifier hs-var">pprCoreExpr</span></a><span> </span><a href="#local-1628172127"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-453"></a><span>
</span><a name="line-454"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628172125"><span class="hs-identifier hs-var">msgs</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628172126"><span class="hs-identifier hs-var">mb_core_expr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-455"></a><span>
</span><a name="line-456"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
*              Add rules and export flags to binders
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-463"></a><span>
</span><a name="line-464"></a><span class="hs-identifier">addExportFlagsAndRules</span><span>
</span><a name="line-465"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#HscTarget"><span class="hs-identifier hs-type">HscTarget</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="NameSet.html#NameSet"><span class="hs-identifier hs-type">NameSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="NameSet.html#NameSet"><span class="hs-identifier hs-type">NameSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">]</span><span>
</span><a name="line-466"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628171974"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628171974"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-467"></a><a name="addExportFlagsAndRules"><a href="Desugar.html#addExportFlagsAndRules"><span class="hs-identifier">addExportFlagsAndRules</span></a></a><span> </span><a name="local-1628172128"><a href="#local-1628172128"><span class="hs-identifier">target</span></a></a><span> </span><a name="local-1628172129"><a href="#local-1628172129"><span class="hs-identifier">exports</span></a></a><span> </span><a name="local-1628172130"><a href="#local-1628172130"><span class="hs-identifier">keep_alive</span></a></a><span> </span><a name="local-1628172131"><a href="#local-1628172131"><span class="hs-identifier">rules</span></a></a><span> </span><a name="local-1628172132"><a href="#local-1628172132"><span class="hs-identifier">prs</span></a></a><span>
</span><a name="line-468"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#mapFst"><span class="hs-identifier hs-var">mapFst</span></a><span> </span><a href="#local-1628172133"><span class="hs-identifier hs-var">add_one</span></a><span> </span><a href="#local-1628172132"><span class="hs-identifier hs-var">prs</span></a><span>
</span><a name="line-469"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-470"></a><span>    </span><a name="local-1628172133"><a href="#local-1628172133"><span class="hs-identifier">add_one</span></a></a><span> </span><a name="local-1628172139"><a href="#local-1628172139"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628172134"><span class="hs-identifier hs-var">add_rules</span></a><span> </span><a href="#local-1628172140"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628172136"><span class="hs-identifier hs-var">add_export</span></a><span> </span><a href="#local-1628172140"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-1628172139"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-471"></a><span>       </span><span class="hs-keyword">where</span><span>
</span><a name="line-472"></a><span>         </span><a name="local-1628172140"><a href="#local-1628172140"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#idName"><span class="hs-identifier hs-var">idName</span></a><span> </span><a href="#local-1628172139"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-473"></a><span>
</span><a name="line-474"></a><span>    </span><span class="hs-comment">---------- Rules --------</span><span>
</span><a name="line-475"></a><span>        </span><span class="hs-comment">-- See Note [Attach rules to local ids]</span><span>
</span><a name="line-476"></a><span>        </span><span class="hs-comment">-- NB: the binder might have some existing rules,</span><span>
</span><a name="line-477"></a><span>        </span><span class="hs-comment">-- arising from specialisation pragmas</span><span>
</span><a name="line-478"></a><span>    </span><a name="local-1628172134"><a href="#local-1628172134"><span class="hs-identifier">add_rules</span></a></a><span> </span><a name="local-1628172141"><a href="#local-1628172141"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-1628172142"><a href="#local-1628172142"><span class="hs-identifier">bndr</span></a></a><span>
</span><a name="line-479"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628172143"><a href="#local-1628172143"><span class="hs-identifier">rules</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="NameEnv.html#lookupNameEnv"><span class="hs-identifier hs-var">lookupNameEnv</span></a><span> </span><a href="#local-1628172135"><span class="hs-identifier hs-var">rule_base</span></a><span> </span><a href="#local-1628172141"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-480"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628172142"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-special">`</span><a href="Rules.html#addIdSpecialisations"><span class="hs-identifier hs-var">addIdSpecialisations</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628172143"><span class="hs-identifier hs-var">rules</span></a><span>
</span><a name="line-481"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-482"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628172142"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-483"></a><span>    </span><a name="local-1628172135"><a href="#local-1628172135"><span class="hs-identifier">rule_base</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Rules.html#extendRuleBaseList"><span class="hs-identifier hs-var">extendRuleBaseList</span></a><span> </span><a href="Rules.html#emptyRuleBase"><span class="hs-identifier hs-var">emptyRuleBase</span></a><span> </span><a href="#local-1628172131"><span class="hs-identifier hs-var">rules</span></a><span>
</span><a name="line-484"></a><span>
</span><a name="line-485"></a><span>    </span><span class="hs-comment">---------- Export flag --------</span><span>
</span><a name="line-486"></a><span>    </span><span class="hs-comment">-- See Note [Adding export flags]</span><span>
</span><a name="line-487"></a><span>    </span><a name="local-1628172136"><a href="#local-1628172136"><span class="hs-identifier">add_export</span></a></a><span> </span><a name="local-1628172144"><a href="#local-1628172144"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-1628172145"><a href="#local-1628172145"><span class="hs-identifier">bndr</span></a></a><span>
</span><a name="line-488"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628172137"><span class="hs-identifier hs-var">dont_discard</span></a><span> </span><a href="#local-1628172144"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#setIdExported"><span class="hs-identifier hs-var">setIdExported</span></a><span> </span><a href="#local-1628172145"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-489"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628172145"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-490"></a><span>
</span><a name="line-491"></a><span>    </span><span class="hs-identifier">dont_discard</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-492"></a><span>    </span><a name="local-1628172137"><a href="#local-1628172137"><span class="hs-identifier">dont_discard</span></a></a><span> </span><a name="local-1628172146"><a href="#local-1628172146"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628172138"><span class="hs-identifier hs-var">is_exported</span></a><span> </span><a href="#local-1628172146"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-493"></a><span>                     </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-1628172146"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">`</span><a href="NameSet.html#elemNameSet"><span class="hs-identifier hs-var">elemNameSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628172130"><span class="hs-identifier hs-var">keep_alive</span></a><span>
</span><a name="line-494"></a><span>
</span><a name="line-495"></a><span>        </span><span class="hs-comment">-- In interactive mode, we don't want to discard any top-level</span><span>
</span><a name="line-496"></a><span>        </span><span class="hs-comment">-- entities at all (eg. do not inline them away during</span><span>
</span><a name="line-497"></a><span>        </span><span class="hs-comment">-- simplification), and retain them all in the TypeEnv so they are</span><span>
</span><a name="line-498"></a><span>        </span><span class="hs-comment">-- available from the command line.</span><span>
</span><a name="line-499"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-500"></a><span>        </span><span class="hs-comment">-- isExternalName separates the user-defined top-level names from those</span><span>
</span><a name="line-501"></a><span>        </span><span class="hs-comment">-- introduced by the type checker.</span><span>
</span><a name="line-502"></a><span>    </span><span class="hs-identifier">is_exported</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-503"></a><span>    </span><a name="local-1628172138"><a href="#local-1628172138"><span class="hs-identifier">is_exported</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="DynFlags.html#targetRetainsAllBindings"><span class="hs-identifier hs-var">targetRetainsAllBindings</span></a><span> </span><a href="#local-1628172128"><span class="hs-identifier hs-var">target</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Name.html#isExternalName"><span class="hs-identifier hs-var">isExternalName</span></a><span>
</span><a name="line-504"></a><span>                </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>                       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="NameSet.html#elemNameSet"><span class="hs-identifier hs-var">elemNameSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628172129"><span class="hs-identifier hs-var">exports</span></a><span class="hs-special">)</span><span>
</span><a name="line-505"></a><span>
</span><a name="line-506"></a><span class="hs-comment">{-
Note [Adding export flags]
~~~~~~~~~~~~~~~~~~~~~~~~~~
Set the no-discard flag if either
        a) the Id is exported
        b) it's mentioned in the RHS of an orphan rule
        c) it's in the keep-alive set

It means that the binding won't be discarded EVEN if the binding
ends up being trivial (v = w) -- the simplifier would usually just
substitute w for v throughout, but we don't apply the substitution to
the rules (maybe we should?), so this substitution would make the rule
bogus.

You might wonder why exported Ids aren't already marked as such;
it's just because the type checker is rather busy already and
I didn't want to pass in yet another mapping.

Note [Attach rules to local ids]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Find the rules for locally-defined Ids; then we can attach them
to the binders in the top-level bindings

Reason
  - It makes the rules easier to look up
  - It means that transformation rules and specialisations for
    locally defined Ids are handled uniformly
  - It keeps alive things that are referred to only from a rule
    (the occurrence analyser knows about rules attached to Ids)
  - It makes sure that, when we apply a rule, the free vars
    of the RHS are more likely to be in scope
  - The imported rules are carried in the in-scope set
    which is extended on each iteration by the new wave of
    local binders; any rules which aren't on the binding will
    thereby get dropped


************************************************************************
*                                                                      *
*              Desugaring transformation rules
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-549"></a><span>
</span><a name="line-550"></a><span class="hs-identifier">dsRule</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HsDecls.html#LRuleDecl"><span class="hs-identifier hs-type">LRuleDecl</span></a><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#DsM"><span class="hs-identifier hs-type">DsM</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">)</span><span>
</span><a name="line-551"></a><a name="dsRule"><a href="Desugar.html#dsRule"><span class="hs-identifier">dsRule</span></a></a><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><a name="local-1628172147"><a href="#local-1628172147"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><a href="HsDecls.html#HsRule"><span class="hs-identifier hs-var">HsRule</span></a><span> </span><a name="local-1628172148"><a href="#local-1628172148"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-1628172149"><a href="#local-1628172149"><span class="hs-identifier">rule_act</span></a></a><span> </span><a name="local-1628172150"><a href="#local-1628172150"><span class="hs-identifier">vars</span></a></a><span> </span><a name="local-1628172151"><a href="#local-1628172151"><span class="hs-identifier">lhs</span></a></a><span> </span><a name="local-1628172152"><a href="#local-1628172152"><span class="hs-identifier">_tv_lhs</span></a></a><span> </span><a name="local-1628172153"><a href="#local-1628172153"><span class="hs-identifier">rhs</span></a></a><span> </span><a name="local-1628172154"><a href="#local-1628172154"><span class="hs-identifier">_fv_rhs</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-552"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DsMonad.html#putSrcSpanDs"><span class="hs-identifier hs-var">putSrcSpanDs</span></a><span> </span><a href="#local-1628172147"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-553"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628172155"><a href="#local-1628172155"><span class="hs-identifier">bndrs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-1628172156"><span class="hs-identifier hs-var">var</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="HsDecls.html#RuleBndr"><span class="hs-identifier hs-var">RuleBndr</span></a><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1628172156"><a href="#local-1628172156"><span class="hs-identifier">var</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628172150"><span class="hs-identifier hs-var">vars</span></a><span class="hs-special">]</span><span>
</span><a name="line-554"></a><span>
</span><a name="line-555"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-1628172157"><a href="#local-1628172157"><span class="hs-identifier">lhs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#unsetGOptM"><span class="hs-identifier hs-var">unsetGOptM</span></a><span> </span><a href="DynFlags.html#Opt_EnableRewriteRules"><span class="hs-identifier hs-var">Opt_EnableRewriteRules</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-556"></a><span>                  </span><a href="TcRnMonad.html#unsetWOptM"><span class="hs-identifier hs-var">unsetWOptM</span></a><span> </span><a href="DynFlags.html#Opt_WarnIdentities"><span class="hs-identifier hs-var">Opt_WarnIdentities</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-557"></a><span>                  </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-1628172151"><span class="hs-identifier hs-var">lhs</span></a><span>   </span><span class="hs-comment">-- Note [Desugaring RULE left hand sides]</span><span>
</span><a name="line-558"></a><span>
</span><a name="line-559"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-1628172158"><a href="#local-1628172158"><span class="hs-identifier">rhs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-1628172153"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-560"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-1628172159"><a href="#local-1628172159"><span class="hs-identifier">this_mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Module.html#getModule"><span class="hs-identifier hs-var">getModule</span></a><span>
</span><a name="line-561"></a><span>
</span><a name="line-562"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628172160"><a href="#local-1628172160"><span class="hs-identifier">bndrs''</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628172161"><a href="#local-1628172161"><span class="hs-identifier">lhs''</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628172162"><a href="#local-1628172162"><span class="hs-identifier">rhs''</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Desugar.html#unfold_coerce"><span class="hs-identifier hs-var">unfold_coerce</span></a><span> </span><a href="#local-1628172155"><span class="hs-identifier hs-var">bndrs'</span></a><span> </span><a href="#local-1628172157"><span class="hs-identifier hs-var">lhs'</span></a><span> </span><a href="#local-1628172158"><span class="hs-identifier hs-var">rhs'</span></a><span>
</span><a name="line-563"></a><span>
</span><a name="line-564"></a><span>        </span><span class="hs-comment">-- Substitute the dict bindings eagerly,</span><span>
</span><a name="line-565"></a><span>        </span><span class="hs-comment">-- and take the body apart into a (f args) form</span><span>
</span><a name="line-566"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="DsBinds.html#decomposeRuleLhs"><span class="hs-identifier hs-var">decomposeRuleLhs</span></a><span> </span><a href="#local-1628172160"><span class="hs-identifier hs-var">bndrs''</span></a><span> </span><a href="#local-1628172161"><span class="hs-identifier hs-var">lhs''</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-567"></a><span>                </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Either.html#Left"><span class="hs-identifier hs-var">Left</span></a><span> </span><a name="local-1628172163"><a href="#local-1628172163"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="DsMonad.html#warnDs"><span class="hs-identifier hs-var">warnDs</span></a><span> </span><a href="DynFlags.html#NoReason"><span class="hs-identifier hs-var">NoReason</span></a><span> </span><a href="#local-1628172163"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-568"></a><span>                </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Either.html#Right"><span class="hs-identifier hs-var">Right</span></a><span> </span><span class="hs-special">(</span><a name="local-1628172164"><a href="#local-1628172164"><span class="hs-identifier">final_bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628172165"><a href="#local-1628172165"><span class="hs-identifier">fn_id</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628172166"><a href="#local-1628172166"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-569"></a><span>
</span><a name="line-570"></a><span>        </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628172167"><a href="#local-1628172167"><span class="hs-identifier">is_local</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#isLocalId"><span class="hs-identifier hs-var">isLocalId</span></a><span> </span><a href="#local-1628172165"><span class="hs-identifier hs-var">fn_id</span></a><span>
</span><a name="line-571"></a><span>                </span><span class="hs-comment">-- NB: isLocalId is False of implicit Ids.  This is good because</span><span>
</span><a name="line-572"></a><span>                </span><span class="hs-comment">-- we don't want to attach rules to the bindings of implicit Ids,</span><span>
</span><a name="line-573"></a><span>                </span><span class="hs-comment">-- because they don't show up in the bindings until just before code gen</span><span>
</span><a name="line-574"></a><span>              </span><a name="local-1628172168"><a href="#local-1628172168"><span class="hs-identifier">fn_name</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#idName"><span class="hs-identifier hs-var">idName</span></a><span> </span><a href="#local-1628172165"><span class="hs-identifier hs-var">fn_id</span></a><span>
</span><a name="line-575"></a><span>              </span><a name="local-1628172169"><a href="#local-1628172169"><span class="hs-identifier">final_rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#simpleOptExpr"><span class="hs-identifier hs-var">simpleOptExpr</span></a><span> </span><a href="#local-1628172162"><span class="hs-identifier hs-var">rhs''</span></a><span>    </span><span class="hs-comment">-- De-crap it</span><span>
</span><a name="line-576"></a><span>              </span><a name="local-1628172170"><a href="#local-1628172170"><span class="hs-identifier">rule_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#snd"><span class="hs-identifier hs-var">snd</span></a><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#unLoc"><span class="hs-identifier hs-var">unLoc</span></a><span> </span><a href="#local-1628172148"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-577"></a><span>              </span><a name="local-1628172171"><a href="#local-1628172171"><span class="hs-identifier">final_bndrs_set</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a><span> </span><a href="#local-1628172164"><span class="hs-identifier hs-var">final_bndrs</span></a><span>
</span><a name="line-578"></a><span>              </span><a name="local-1628172172"><a href="#local-1628172172"><span class="hs-identifier">arg_ids</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#filterOut"><span class="hs-identifier hs-var">filterOut</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="VarSet.html#elemVarSet"><span class="hs-identifier hs-var">elemVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628172171"><span class="hs-identifier hs-var">final_bndrs_set</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-579"></a><span>                        </span><a href="CoreFVs.html#exprsSomeFreeVarsList"><span class="hs-identifier hs-var">exprsSomeFreeVarsList</span></a><span> </span><a href="Var.html#isId"><span class="hs-identifier hs-var">isId</span></a><span> </span><a href="#local-1628172166"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-580"></a><span>
</span><a name="line-581"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-1628172173"><a href="#local-1628172173"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a><span>
</span><a name="line-582"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-1628172174"><a href="#local-1628172174"><span class="hs-identifier">rule</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsBinds.html#dsMkUserRule"><span class="hs-identifier hs-var">dsMkUserRule</span></a><span> </span><a href="#local-1628172159"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-1628172167"><span class="hs-identifier hs-var">is_local</span></a><span>
</span><a name="line-583"></a><span>                         </span><a href="#local-1628172170"><span class="hs-identifier hs-var">rule_name</span></a><span> </span><a href="#local-1628172149"><span class="hs-identifier hs-var">rule_act</span></a><span> </span><a href="#local-1628172168"><span class="hs-identifier hs-var">fn_name</span></a><span> </span><a href="#local-1628172164"><span class="hs-identifier hs-var">final_bndrs</span></a><span> </span><a href="#local-1628172166"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-584"></a><span>                         </span><a href="#local-1628172169"><span class="hs-identifier hs-var">final_rhs</span></a><span>
</span><a name="line-585"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><span class="hs-special">(</span><a href="DynFlags.html#wopt"><span class="hs-identifier hs-var">wopt</span></a><span> </span><a href="DynFlags.html#Opt_WarnInlineRuleShadowing"><span class="hs-identifier hs-var">Opt_WarnInlineRuleShadowing</span></a><span> </span><a href="#local-1628172173"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-586"></a><span>          </span><a href="Desugar.html#warnRuleShadowing"><span class="hs-identifier hs-var">warnRuleShadowing</span></a><span> </span><a href="#local-1628172170"><span class="hs-identifier hs-var">rule_name</span></a><span> </span><a href="#local-1628172149"><span class="hs-identifier hs-var">rule_act</span></a><span> </span><a href="#local-1628172165"><span class="hs-identifier hs-var">fn_id</span></a><span> </span><a href="#local-1628172172"><span class="hs-identifier hs-var">arg_ids</span></a><span>
</span><a name="line-587"></a><span>
</span><a name="line-588"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-1628172174"><span class="hs-identifier hs-var">rule</span></a><span class="hs-special">)</span><span>
</span><a name="line-589"></a><span>        </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-590"></a><span>
</span><a name="line-591"></a><span>
</span><a name="line-592"></a><span class="hs-identifier">warnRuleShadowing</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#RuleName"><span class="hs-identifier hs-type">RuleName</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#Activation"><span class="hs-identifier hs-type">Activation</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#DsM"><span class="hs-identifier hs-type">DsM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-593"></a><span class="hs-comment">-- See Note [Rules and inlining/other rules]</span><span>
</span><a name="line-594"></a><a name="warnRuleShadowing"><a href="Desugar.html#warnRuleShadowing"><span class="hs-identifier">warnRuleShadowing</span></a></a><span> </span><a name="local-1628172175"><a href="#local-1628172175"><span class="hs-identifier">rule_name</span></a></a><span> </span><a name="local-1628172176"><a href="#local-1628172176"><span class="hs-identifier">rule_act</span></a></a><span> </span><a name="local-1628172177"><a href="#local-1628172177"><span class="hs-identifier">fn_id</span></a></a><span> </span><a name="local-1628172178"><a href="#local-1628172178"><span class="hs-identifier">arg_ids</span></a></a><span>
</span><a name="line-595"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="#local-1628172179"><span class="hs-identifier hs-var">check</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-1628172177"><span class="hs-identifier hs-var">fn_id</span></a><span>    </span><span class="hs-comment">-- We often have multiple rules for the same Id in a</span><span>
</span><a name="line-596"></a><span>                              </span><span class="hs-comment">-- module. Maybe we should check that they don't overlap</span><span>
</span><a name="line-597"></a><span>                              </span><span class="hs-comment">-- but currently we don't</span><span>
</span><a name="line-598"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628172179"><span class="hs-identifier hs-var">check</span></a><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span> </span><a href="#local-1628172178"><span class="hs-identifier hs-var">arg_ids</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-599"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-600"></a><span>    </span><a name="local-1628172179"><a href="#local-1628172179"><span class="hs-identifier">check</span></a></a><span> </span><a name="local-1628172181"><a href="#local-1628172181"><span class="hs-identifier">check_rules_too</span></a></a><span> </span><a name="local-1628172182"><a href="#local-1628172182"><span class="hs-identifier">lhs_id</span></a></a><span>
</span><a name="line-601"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isLocalId"><span class="hs-identifier hs-var">isLocalId</span></a><span> </span><a href="#local-1628172182"><span class="hs-identifier hs-var">lhs_id</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="CoreSyn.html#canUnfold"><span class="hs-identifier hs-var">canUnfold</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idUnfolding"><span class="hs-identifier hs-var">idUnfolding</span></a><span> </span><a href="#local-1628172182"><span class="hs-identifier hs-var">lhs_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-602"></a><span>                       </span><span class="hs-comment">-- If imported with no unfolding, no worries</span><span>
</span><a name="line-603"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="Id.html#idInlineActivation"><span class="hs-identifier hs-var">idInlineActivation</span></a><span> </span><a href="#local-1628172182"><span class="hs-identifier hs-var">lhs_id</span></a><span> </span><span class="hs-special">`</span><a href="BasicTypes.html#competesWith"><span class="hs-identifier hs-var">competesWith</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628172176"><span class="hs-identifier hs-var">rule_act</span></a><span>
</span><a name="line-604"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="DsMonad.html#warnDs"><span class="hs-identifier hs-var">warnDs</span></a><span> </span><span class="hs-special">(</span><a href="DynFlags.html#Reason"><span class="hs-identifier hs-var">Reason</span></a><span> </span><a href="DynFlags.html#Opt_WarnInlineRuleShadowing"><span class="hs-identifier hs-var">Opt_WarnInlineRuleShadowing</span></a><span class="hs-special">)</span><span>
</span><a name="line-605"></a><span>               </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Rule&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="BasicTypes.html#pprRuleName"><span class="hs-identifier hs-var">pprRuleName</span></a><span> </span><a href="#local-1628172175"><span class="hs-identifier hs-var">rule_name</span></a><span>
</span><a name="line-606"></a><span>                               </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;may never fire&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-607"></a><span>                            </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;because&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628172182"><span class="hs-identifier hs-var">lhs_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-608"></a><span>                               </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;might inline first&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-609"></a><span>                     </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Probable fix: add an INLINE[n] or NOINLINE[n] pragma for&quot;</span><span>
</span><a name="line-610"></a><span>                       </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628172182"><span class="hs-identifier hs-var">lhs_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-611"></a><span>                     </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#ifPprDebug"><span class="hs-identifier hs-var">ifPprDebug</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idInlineActivation"><span class="hs-identifier hs-var">idInlineActivation</span></a><span> </span><a href="#local-1628172182"><span class="hs-identifier hs-var">lhs_id</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628172176"><span class="hs-identifier hs-var">rule_act</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-612"></a><span>
</span><a name="line-613"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628172181"><span class="hs-identifier hs-var">check_rules_too</span></a><span>
</span><a name="line-614"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="local-1628172183"><a href="#local-1628172183"><span class="hs-identifier">bad_rule</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628172180"><span class="hs-identifier hs-var">get_bad_rules</span></a><span> </span><a href="#local-1628172182"><span class="hs-identifier hs-var">lhs_id</span></a><span>
</span><a name="line-615"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="DsMonad.html#warnDs"><span class="hs-identifier hs-var">warnDs</span></a><span> </span><span class="hs-special">(</span><a href="DynFlags.html#Reason"><span class="hs-identifier hs-var">Reason</span></a><span> </span><a href="DynFlags.html#Opt_WarnInlineRuleShadowing"><span class="hs-identifier hs-var">Opt_WarnInlineRuleShadowing</span></a><span class="hs-special">)</span><span>
</span><a name="line-616"></a><span>               </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Rule&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="BasicTypes.html#pprRuleName"><span class="hs-identifier hs-var">pprRuleName</span></a><span> </span><a href="#local-1628172175"><span class="hs-identifier hs-var">rule_name</span></a><span>
</span><a name="line-617"></a><span>                               </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;may never fire&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-618"></a><span>                            </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;because rule&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="BasicTypes.html#pprRuleName"><span class="hs-identifier hs-var">pprRuleName</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#ruleName"><span class="hs-identifier hs-var">ruleName</span></a><span> </span><a href="#local-1628172183"><span class="hs-identifier hs-var">bad_rule</span></a><span class="hs-special">)</span><span>
</span><a name="line-619"></a><span>                               </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;for&quot;</span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628172182"><span class="hs-identifier hs-var">lhs_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-620"></a><span>                               </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;might fire first&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-621"></a><span>                      </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Probable fix: add phase [n] or [~n] to the competing rule&quot;</span><span>
</span><a name="line-622"></a><span>                      </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#ifPprDebug"><span class="hs-identifier hs-var">ifPprDebug</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628172183"><span class="hs-identifier hs-var">bad_rule</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-623"></a><span>
</span><a name="line-624"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-625"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-626"></a><span>
</span><a name="line-627"></a><span>    </span><a name="local-1628172180"><a href="#local-1628172180"><span class="hs-identifier">get_bad_rules</span></a></a><span> </span><a name="local-1628172184"><a href="#local-1628172184"><span class="hs-identifier">lhs_id</span></a></a><span>
</span><a name="line-628"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-1628172185"><span class="hs-identifier hs-var">rule</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-1628172185"><a href="#local-1628172185"><span class="hs-identifier">rule</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Id.html#idCoreRules"><span class="hs-identifier hs-var">idCoreRules</span></a><span> </span><a href="#local-1628172184"><span class="hs-identifier hs-var">lhs_id</span></a><span>
</span><a name="line-629"></a><span>               </span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#ruleActivation"><span class="hs-identifier hs-var">ruleActivation</span></a><span> </span><a href="#local-1628172185"><span class="hs-identifier hs-var">rule</span></a><span> </span><span class="hs-special">`</span><a href="BasicTypes.html#competesWith"><span class="hs-identifier hs-var">competesWith</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628172176"><span class="hs-identifier hs-var">rule_act</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-630"></a><span>
</span><a name="line-631"></a><span class="hs-comment">-- See Note [Desugaring coerce as cast]</span><span>
</span><a name="line-632"></a><span class="hs-identifier">unfold_coerce</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#DsM"><span class="hs-identifier hs-type">DsM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-633"></a><a name="unfold_coerce"><a href="Desugar.html#unfold_coerce"><span class="hs-identifier">unfold_coerce</span></a></a><span> </span><a name="local-1628172186"><a href="#local-1628172186"><span class="hs-identifier">bndrs</span></a></a><span> </span><a name="local-1628172187"><a href="#local-1628172187"><span class="hs-identifier">lhs</span></a></a><span> </span><a name="local-1628172188"><a href="#local-1628172188"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-634"></a><span>    </span><span class="hs-special">(</span><a name="local-1628172204"><a href="#local-1628172204"><span class="hs-identifier">bndrs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628172205"><a href="#local-1628172205"><span class="hs-identifier">wrap</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628172189"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1628172186"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-635"></a><span>    </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628172204"><span class="hs-identifier hs-var">bndrs'</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628172205"><span class="hs-identifier hs-var">wrap</span></a><span> </span><a href="#local-1628172187"><span class="hs-identifier hs-var">lhs</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628172205"><span class="hs-identifier hs-var">wrap</span></a><span> </span><a href="#local-1628172188"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-636"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-637"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#DsM"><span class="hs-identifier hs-type">DsM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-638"></a><span>    </span><a name="local-1628172189"><a href="#local-1628172189"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#id"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-639"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a name="local-1628172190"><a href="#local-1628172190"><span class="hs-identifier">v</span></a></a><span class="hs-glyph">:</span><a name="local-1628172191"><a href="#local-1628172191"><span class="hs-identifier">vs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-640"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1628172192"><a href="#local-1628172192"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a name="local-1628172193"><a href="#local-1628172193"><span class="hs-identifier">k</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628172194"><a href="#local-1628172194"><span class="hs-identifier">t1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628172195"><a href="#local-1628172195"><span class="hs-identifier">t2</span></a></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-var">splitTyConApp_maybe</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idType"><span class="hs-identifier hs-var">idType</span></a><span> </span><a href="#local-1628172190"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-641"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="#local-1628172192"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">`</span><a href="Unique.html#hasKey"><span class="hs-identifier hs-var">hasKey</span></a><span class="hs-special">`</span><span> </span><a href="PrelNames.html#coercibleTyConKey"><span class="hs-identifier hs-var">coercibleTyConKey</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-642"></a><span>            </span><a name="local-1628172196"><a href="#local-1628172196"><span class="hs-identifier">u</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newUnique"><span class="hs-identifier hs-var">newUnique</span></a><span>
</span><a name="line-643"></a><span>
</span><a name="line-644"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-1628172197"><a href="#local-1628172197"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a><span> </span><a href="TysPrim.html#eqReprPrimTyCon"><span class="hs-identifier hs-var">eqReprPrimTyCon</span></a><span> </span><span class="hs-special">[</span><a href="#local-1628172193"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628172193"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628172194"><span class="hs-identifier hs-var">t1</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628172195"><span class="hs-identifier hs-var">t2</span></a><span class="hs-special">]</span><span>
</span><a name="line-645"></a><span>                </span><a name="local-1628172198"><a href="#local-1628172198"><span class="hs-identifier">v'</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#mkLocalCoVar"><span class="hs-identifier hs-var">mkLocalCoVar</span></a><span>
</span><a name="line-646"></a><span>                        </span><span class="hs-special">(</span><a href="Name.html#mkDerivedInternalName"><span class="hs-identifier hs-var">mkDerivedInternalName</span></a><span> </span><a href="OccName.html#mkRepEqOcc"><span class="hs-identifier hs-var">mkRepEqOcc</span></a><span> </span><a href="#local-1628172196"><span class="hs-identifier hs-var">u</span></a><span> </span><span class="hs-special">(</span><a href="Name.html#getName"><span class="hs-identifier hs-var">getName</span></a><span> </span><a href="#local-1628172190"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-1628172197"><span class="hs-identifier hs-var">ty'</span></a><span>
</span><a name="line-647"></a><span>                </span><a name="local-1628172199"><a href="#local-1628172199"><span class="hs-identifier">box</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#dataConWrapId"><span class="hs-identifier hs-var">dataConWrapId</span></a><span> </span><a href="TysWiredIn.html#coercibleDataCon"><span class="hs-identifier hs-var">coercibleDataCon</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="CoreSyn.html#mkTyApps"><span class="hs-identifier hs-var">mkTyApps</span></a><span class="hs-special">`</span><span>
</span><a name="line-648"></a><span>                      </span><span class="hs-special">[</span><a href="#local-1628172193"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628172194"><span class="hs-identifier hs-var">t1</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628172195"><span class="hs-identifier hs-var">t2</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">`</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span class="hs-special">`</span><span>
</span><a name="line-649"></a><span>                      </span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkCoVarCo"><span class="hs-identifier hs-var">mkCoVarCo</span></a><span> </span><a href="#local-1628172198"><span class="hs-identifier hs-var">v'</span></a><span class="hs-special">)</span><span>
</span><a name="line-650"></a><span>
</span><a name="line-651"></a><span>            </span><span class="hs-special">(</span><a name="local-1628172200"><a href="#local-1628172200"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628172201"><a href="#local-1628172201"><span class="hs-identifier">wrap</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628172189"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1628172191"><span class="hs-identifier hs-var">vs</span></a><span>
</span><a name="line-652"></a><span>            </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628172198"><span class="hs-identifier hs-var">v'</span></a><span class="hs-glyph">:</span><a href="#local-1628172200"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">,</span><span> </span><a href="MkCore.html#mkCoreLet"><span class="hs-identifier hs-var">mkCoreLet</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a href="#local-1628172190"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-1628172199"><span class="hs-identifier hs-var">box</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="#local-1628172201"><span class="hs-identifier hs-var">wrap</span></a><span class="hs-special">)</span><span>
</span><a name="line-653"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-654"></a><span>            </span><span class="hs-special">(</span><a name="local-1628172202"><a href="#local-1628172202"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><a name="local-1628172203"><a href="#local-1628172203"><span class="hs-identifier">wrap</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628172189"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1628172191"><span class="hs-identifier hs-var">vs</span></a><span>
</span><a name="line-655"></a><span>            </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628172190"><span class="hs-identifier hs-var">v</span></a><span class="hs-glyph">:</span><a href="#local-1628172202"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628172203"><span class="hs-identifier hs-var">wrap</span></a><span class="hs-special">)</span><span>
</span><a name="line-656"></a><span>
</span><a name="line-657"></a><span class="hs-comment">{- Note [Desugaring RULE left hand sides]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
For the LHS of a RULE we do *not* want to desugar
    [x]   to    build (\cn. x `c` n)
We want to leave explicit lists simply as chains
of cons's. We can achieve that slightly indirectly by
switching off EnableRewriteRules.  See DsExpr.dsExplicitList.

That keeps the desugaring of list comprehensions simple too.

Nor do we want to warn of conversion identities on the LHS;
the rule is precisly to optimise them:
  {-# RULES &quot;fromRational/id&quot; fromRational = id :: Rational -&gt; Rational #-}

Note [Desugaring coerce as cast]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We want the user to express a rule saying roughly &#8220;mapping a coercion over a
list can be replaced by a coercion&#8221;. But the cast operator of Core (&#9655;) cannot
be written in Haskell. So we use `coerce` for that (#2110). The user writes
    map coerce = coerce
as a RULE, and this optimizes any kind of mapped' casts aways, including `map
MkNewtype`.

For that we replace any forall'ed `c :: Coercible a b` value in a RULE by
corresponding `co :: a ~#R b` and wrap the LHS and the RHS in
`let c = MkCoercible co in ...`. This is later simplified to the desired form
by simpleOptExpr (for the LHS) resp. the simplifiers (for the RHS).
See also Note [Getting the map/coerce RULE to work] in CoreSubst.

Note [Rules and inlining/other rules]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If you have
  f x = ...
  g x = ...
  {-# RULES &quot;rule-for-f&quot; forall x. f (g x) = ... #-}
then there's a good chance that in a potential rule redex
    ...f (g e)...
then 'f' or 'g' will inline befor the rule can fire.  Solution: add an
INLINE [n] or NOINLINE [n] pragma to 'f' and 'g'.

Note that this applies to all the free variables on the LHS, both the
main function and things in its arguments.

We also check if there are Ids on the LHS that have competing RULES.
In the above example, suppose we had
  {-# RULES &quot;rule-for-g&quot; forally. g [y] = ... #-}
Then &quot;rule-for-f&quot; and &quot;rule-for-g&quot; would compete.  Better to add phase
control, so &quot;rule-for-f&quot; has a chance to fire before &quot;rule-for-g&quot; becomes
active; or perhpas after &quot;rule-for-g&quot; has become inactive. This is checked
by 'competesWith'

Class methods have a built-in RULE to select the method from the dictionary,
so you can't change the phase on this.  That makes id very dubious to
match on class methods in RULE lhs's.   See Trac #10595.   I'm not happy
about this. For exmaple in Control.Arrow we have

{-# RULES &quot;compose/arr&quot;   forall f g .
                          (arr f) . (arr g) = arr (f . g) #-}

and similar, which will elicit exactly these warnings, and risk never
firing.  But it's not clear what to do instead.  We could make the
class methocd rules inactive in phase 2, but that would delay when
subsequent transformations could fire.


************************************************************************
*                                                                      *
*              Desugaring vectorisation declarations
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-728"></a><span>
</span><a name="line-729"></a><span class="hs-identifier">dsVect</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HsDecls.html#LVectDecl"><span class="hs-identifier hs-type">LVectDecl</span></a><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#DsM"><span class="hs-identifier hs-type">DsM</span></a><span> </span><a href="CoreSyn.html#CoreVect"><span class="hs-identifier hs-type">CoreVect</span></a><span>
</span><a name="line-730"></a><a name="dsVect"><a href="Desugar.html#dsVect"><span class="hs-identifier">dsVect</span></a></a><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><a name="local-1628172206"><a href="#local-1628172206"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><a href="HsDecls.html#HsVect"><span class="hs-identifier hs-var">HsVect</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1628172207"><a href="#local-1628172207"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1628172208"><a href="#local-1628172208"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-731"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DsMonad.html#putSrcSpanDs"><span class="hs-identifier hs-var">putSrcSpanDs</span></a><span> </span><a href="#local-1628172206"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-732"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628172209"><a href="#local-1628172209"><span class="hs-identifier">rhs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-1628172208"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-733"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="CoreSyn.html#Vect"><span class="hs-identifier hs-var">Vect</span></a><span> </span><a href="#local-1628172207"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-1628172209"><span class="hs-identifier hs-var">rhs'</span></a><span>
</span><a name="line-734"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-735"></a><span class="hs-identifier">dsVect</span><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><a name="local-1628172210"><a href="#local-1628172210"><span class="hs-identifier">_loc</span></a></a><span> </span><span class="hs-special">(</span><a href="HsDecls.html#HsNoVect"><span class="hs-identifier hs-var">HsNoVect</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1628172211"><a href="#local-1628172211"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-736"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="CoreSyn.html#NoVect"><span class="hs-identifier hs-var">NoVect</span></a><span> </span><a href="#local-1628172211"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-737"></a><span class="hs-identifier">dsVect</span><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><a name="local-1628172212"><a href="#local-1628172212"><span class="hs-identifier">_loc</span></a></a><span> </span><span class="hs-special">(</span><a href="HsDecls.html#HsVectTypeOut"><span class="hs-identifier hs-var">HsVectTypeOut</span></a><span> </span><a name="local-1628172213"><a href="#local-1628172213"><span class="hs-identifier">isScalar</span></a></a><span> </span><a name="local-1628172214"><a href="#local-1628172214"><span class="hs-identifier">tycon</span></a></a><span> </span><a name="local-1628172215"><a href="#local-1628172215"><span class="hs-identifier">rhs_tycon</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-738"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="CoreSyn.html#VectType"><span class="hs-identifier hs-var">VectType</span></a><span> </span><a href="#local-1628172213"><span class="hs-identifier hs-var">isScalar</span></a><span> </span><a href="#local-1628172216"><span class="hs-identifier hs-var">tycon'</span></a><span> </span><a href="#local-1628172215"><span class="hs-identifier hs-var">rhs_tycon</span></a><span>
</span><a name="line-739"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-740"></a><span>    </span><a name="local-1628172216"><a href="#local-1628172216"><span class="hs-identifier">tycon'</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628172217"><a href="#local-1628172217"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#coreView"><span class="hs-identifier hs-var">coreView</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TyCoRep.html#mkTyConTy"><span class="hs-identifier hs-var">mkTyConTy</span></a><span> </span><a href="#local-1628172214"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-741"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-1628172218"><a href="#local-1628172218"><span class="hs-identifier">tycon'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitTyConApp"><span class="hs-identifier hs-var">splitTyConApp</span></a><span> </span><a href="#local-1628172217"><span class="hs-identifier hs-var">ty</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628172218"><span class="hs-identifier hs-var">tycon'</span></a><span>
</span><a name="line-742"></a><span>           </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>                             </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628172214"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-743"></a><span class="hs-identifier">dsVect</span><span> </span><a name="local-1628172219"><a href="#local-1628172219"><span class="hs-identifier">vd</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="HsDecls.html#HsVectTypeIn"><span class="hs-identifier hs-var">HsVectTypeIn</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-744"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;Desugar.dsVect: unexpected 'HsVectTypeIn'&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628172219"><span class="hs-identifier hs-var">vd</span></a><span class="hs-special">)</span><span>
</span><a name="line-745"></a><span class="hs-identifier">dsVect</span><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><a name="local-1628172220"><a href="#local-1628172220"><span class="hs-identifier">_loc</span></a></a><span> </span><span class="hs-special">(</span><a href="HsDecls.html#HsVectClassOut"><span class="hs-identifier hs-var">HsVectClassOut</span></a><span> </span><a name="local-1628172221"><a href="#local-1628172221"><span class="hs-identifier">cls</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-746"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="CoreSyn.html#VectClass"><span class="hs-identifier hs-var">VectClass</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">classTyCon</span><span> </span><a href="#local-1628172221"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span>
</span><a name="line-747"></a><span class="hs-identifier">dsVect</span><span> </span><a name="local-1628172222"><a href="#local-1628172222"><span class="hs-identifier">vc</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="HsDecls.html#HsVectClassIn"><span class="hs-identifier hs-var">HsVectClassIn</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-748"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;Desugar.dsVect: unexpected 'HsVectClassIn'&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628172222"><span class="hs-identifier hs-var">vc</span></a><span class="hs-special">)</span><span>
</span><a name="line-749"></a><span class="hs-identifier">dsVect</span><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><a name="local-1628172223"><a href="#local-1628172223"><span class="hs-identifier">_loc</span></a></a><span> </span><span class="hs-special">(</span><a href="HsDecls.html#HsVectInstOut"><span class="hs-identifier hs-var">HsVectInstOut</span></a><span> </span><a name="local-1628172224"><a href="#local-1628172224"><span class="hs-identifier">inst</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-750"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="CoreSyn.html#VectInst"><span class="hs-identifier hs-var">VectInst</span></a><span> </span><span class="hs-special">(</span><a href="InstEnv.html#instanceDFunId"><span class="hs-identifier hs-var">instanceDFunId</span></a><span> </span><a href="#local-1628172224"><span class="hs-identifier hs-var">inst</span></a><span class="hs-special">)</span><span>
</span><a name="line-751"></a><span class="hs-identifier">dsVect</span><span> </span><a name="local-1628172225"><a href="#local-1628172225"><span class="hs-identifier">vi</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="HsDecls.html#HsVectInstIn"><span class="hs-identifier hs-var">HsVectInstIn</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-752"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;Desugar.dsVect: unexpected 'HsVectInstIn'&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628172225"><span class="hs-identifier hs-var">vi</span></a><span class="hs-special">)</span><span>
</span><a name="line-753"></a></pre></body></html>