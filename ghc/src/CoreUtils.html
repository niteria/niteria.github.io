<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2006
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998


Utility functions on @Core@ syntax
-}</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-comment">-- | Commonly useful utilites for manipulating the Core language</span><span>
</span><a name="line-12"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">CoreUtils</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-13"></a><span>        </span><span class="hs-comment">-- * Constructing expressions</span><span>
</span><a name="line-14"></a><span>        </span><a href="CoreUtils.html#mkCast"><span class="hs-identifier hs-var">mkCast</span></a><span class="hs-special">,</span><span>
</span><a name="line-15"></a><span>        </span><a href="CoreUtils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#mkTicks"><span class="hs-identifier hs-var">mkTicks</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#mkTickNoHNF"><span class="hs-identifier hs-var">mkTickNoHNF</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#tickHNFArgs"><span class="hs-identifier hs-var">tickHNFArgs</span></a><span class="hs-special">,</span><span>
</span><a name="line-16"></a><span>        </span><a href="CoreUtils.html#bindNonRec"><span class="hs-identifier hs-var">bindNonRec</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#needsCaseBinding"><span class="hs-identifier hs-var">needsCaseBinding</span></a><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>        </span><a href="CoreUtils.html#mkAltExpr"><span class="hs-identifier hs-var">mkAltExpr</span></a><span class="hs-special">,</span><span>
</span><a name="line-18"></a><span>
</span><a name="line-19"></a><span>        </span><span class="hs-comment">-- * Taking expressions apart</span><span>
</span><a name="line-20"></a><span>        </span><a href="CoreUtils.html#findDefault"><span class="hs-identifier hs-var">findDefault</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#addDefault"><span class="hs-identifier hs-var">addDefault</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#findAlt"><span class="hs-identifier hs-var">findAlt</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#isDefaultAlt"><span class="hs-identifier hs-var">isDefaultAlt</span></a><span class="hs-special">,</span><span>
</span><a name="line-21"></a><span>        </span><a href="CoreUtils.html#mergeAlts"><span class="hs-identifier hs-var">mergeAlts</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#trimConArgs"><span class="hs-identifier hs-var">trimConArgs</span></a><span class="hs-special">,</span><span>
</span><a name="line-22"></a><span>        </span><a href="CoreUtils.html#filterAlts"><span class="hs-identifier hs-var">filterAlts</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#combineIdenticalAlts"><span class="hs-identifier hs-var">combineIdenticalAlts</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#refineDefaultAlt"><span class="hs-identifier hs-var">refineDefaultAlt</span></a><span class="hs-special">,</span><span>
</span><a name="line-23"></a><span>
</span><a name="line-24"></a><span>        </span><span class="hs-comment">-- * Properties of expressions</span><span>
</span><a name="line-25"></a><span>        </span><a href="CoreUtils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#coreAltType"><span class="hs-identifier hs-var">coreAltType</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#coreAltsType"><span class="hs-identifier hs-var">coreAltsType</span></a><span class="hs-special">,</span><span>
</span><a name="line-26"></a><span>        </span><a href="CoreUtils.html#exprIsDupable"><span class="hs-identifier hs-var">exprIsDupable</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#exprIsTrivial"><span class="hs-identifier hs-var">exprIsTrivial</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#getIdFromTrivialExpr"><span class="hs-identifier hs-var">getIdFromTrivialExpr</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#exprIsBottom"><span class="hs-identifier hs-var">exprIsBottom</span></a><span class="hs-special">,</span><span>
</span><a name="line-27"></a><span>        </span><a href="CoreUtils.html#exprIsCheap"><span class="hs-identifier hs-var">exprIsCheap</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#exprIsExpandable"><span class="hs-identifier hs-var">exprIsExpandable</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#exprIsCheap%27"><span class="hs-identifier hs-var">exprIsCheap'</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#CheapAppFun"><span class="hs-identifier hs-type">CheapAppFun</span></a><span class="hs-special">,</span><span>
</span><a name="line-28"></a><span>        </span><a href="CoreUtils.html#exprIsHNF"><span class="hs-identifier hs-var">exprIsHNF</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#exprOkForSpeculation"><span class="hs-identifier hs-var">exprOkForSpeculation</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#exprOkForSideEffects"><span class="hs-identifier hs-var">exprOkForSideEffects</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#exprIsWorkFree"><span class="hs-identifier hs-var">exprIsWorkFree</span></a><span class="hs-special">,</span><span>
</span><a name="line-29"></a><span>        </span><a href="CoreUtils.html#exprIsBig"><span class="hs-identifier hs-var">exprIsBig</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#exprIsConLike"><span class="hs-identifier hs-var">exprIsConLike</span></a><span class="hs-special">,</span><span>
</span><a name="line-30"></a><span>        </span><a href="CoreUtils.html#rhsIsStatic"><span class="hs-identifier hs-var">rhsIsStatic</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#isCheapApp"><span class="hs-identifier hs-var">isCheapApp</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#isExpandableApp"><span class="hs-identifier hs-var">isExpandableApp</span></a><span class="hs-special">,</span><span>
</span><a name="line-31"></a><span>
</span><a name="line-32"></a><span>        </span><span class="hs-comment">-- * Equality</span><span>
</span><a name="line-33"></a><span>        </span><a href="CoreUtils.html#cheapEqExpr"><span class="hs-identifier hs-var">cheapEqExpr</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#cheapEqExpr%27"><span class="hs-identifier hs-var">cheapEqExpr'</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#eqExpr"><span class="hs-identifier hs-var">eqExpr</span></a><span class="hs-special">,</span><span>
</span><a name="line-34"></a><span>        </span><a href="CoreUtils.html#diffExpr"><span class="hs-identifier hs-var">diffExpr</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#diffBinds"><span class="hs-identifier hs-var">diffBinds</span></a><span class="hs-special">,</span><span>
</span><a name="line-35"></a><span>
</span><a name="line-36"></a><span>        </span><span class="hs-comment">-- * Eta reduction</span><span>
</span><a name="line-37"></a><span>        </span><a href="CoreUtils.html#tryEtaReduce"><span class="hs-identifier hs-var">tryEtaReduce</span></a><span class="hs-special">,</span><span>
</span><a name="line-38"></a><span>
</span><a name="line-39"></a><span>        </span><span class="hs-comment">-- * Manipulating data constructors and types</span><span>
</span><a name="line-40"></a><span>        </span><a href="CoreSyn.html#exprToType"><span class="hs-identifier hs-var">exprToType</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#exprToCoercion_maybe"><span class="hs-identifier hs-var">exprToCoercion_maybe</span></a><span class="hs-special">,</span><span>
</span><a name="line-41"></a><span>        </span><a href="CoreUtils.html#applyTypeToArgs"><span class="hs-identifier hs-var">applyTypeToArgs</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#applyTypeToArg"><span class="hs-identifier hs-var">applyTypeToArg</span></a><span class="hs-special">,</span><span>
</span><a name="line-42"></a><span>        </span><a href="CoreUtils.html#dataConRepInstPat"><span class="hs-identifier hs-var">dataConRepInstPat</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#dataConRepFSInstPat"><span class="hs-identifier hs-var">dataConRepFSInstPat</span></a><span class="hs-special">,</span><span>
</span><a name="line-43"></a><span>        </span><a href="CoreUtils.html#isEmptyTy"><span class="hs-identifier hs-var">isEmptyTy</span></a><span class="hs-special">,</span><span>
</span><a name="line-44"></a><span>
</span><a name="line-45"></a><span>        </span><span class="hs-comment">-- * Working with ticks</span><span>
</span><a name="line-46"></a><span>        </span><a href="CoreUtils.html#stripTicksTop"><span class="hs-identifier hs-var">stripTicksTop</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#stripTicksTopE"><span class="hs-identifier hs-var">stripTicksTopE</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#stripTicksTopT"><span class="hs-identifier hs-var">stripTicksTopT</span></a><span class="hs-special">,</span><span>
</span><a name="line-47"></a><span>        </span><a href="CoreUtils.html#stripTicksE"><span class="hs-identifier hs-var">stripTicksE</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#stripTicksT"><span class="hs-identifier hs-var">stripTicksT</span></a><span>
</span><a name="line-48"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-49"></a><span>
</span><a name="line-50"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;</span><span>
</span><a name="line-51"></a><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><a href="CoreSyn.html"><span class="hs-identifier">CoreSyn</span></a><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><a href="PprCore.html"><span class="hs-identifier">PprCore</span></a><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><a href="CoreFVs.html"><span class="hs-identifier">CoreFVs</span></a><span class="hs-special">(</span><span> </span><a href="CoreFVs.html#exprFreeVars"><span class="hs-identifier hs-var">exprFreeVars</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><a href="Var.html"><span class="hs-identifier">Var</span></a><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><a href="SrcLoc.html"><span class="hs-identifier">SrcLoc</span></a><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><a href="VarEnv.html"><span class="hs-identifier">VarEnv</span></a><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><a href="VarSet.html"><span class="hs-identifier">VarSet</span></a><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><a href="Name.html"><span class="hs-identifier">Name</span></a><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><a href="Literal.html"><span class="hs-identifier">Literal</span></a><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><a href="DataCon.html"><span class="hs-identifier">DataCon</span></a><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span> </span><a href="PrimOp.html"><span class="hs-identifier">PrimOp</span></a><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><a href="Id.html"><span class="hs-identifier">Id</span></a><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><a href="IdInfo.html"><span class="hs-identifier">IdInfo</span></a><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><a href="Type.html"><span class="hs-identifier">Type</span></a><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span> </span><a href="Coercion.html"><span class="hs-identifier">Coercion</span></a><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span> </span><a href="TyCon.html"><span class="hs-identifier">TyCon</span></a><span>
</span><a name="line-68"></a><span class="hs-keyword">import</span><span> </span><a href="Unique.html"><span class="hs-identifier">Unique</span></a><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span> </span><a href="Outputable.html"><span class="hs-identifier">Outputable</span></a><span>
</span><a name="line-70"></a><span class="hs-keyword">import</span><span> </span><a href="TysPrim.html"><span class="hs-identifier">TysPrim</span></a><span>
</span><a name="line-71"></a><span class="hs-keyword">import</span><span> </span><a href="DynFlags.html"><span class="hs-identifier">DynFlags</span></a><span>
</span><a name="line-72"></a><span class="hs-keyword">import</span><span> </span><a href="FastString.html"><span class="hs-identifier">FastString</span></a><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span> </span><a href="Maybes.html"><span class="hs-identifier">Maybes</span></a><span>
</span><a name="line-74"></a><span class="hs-keyword">import</span><span> </span><a href="ListSetOps.html"><span class="hs-identifier">ListSetOps</span></a><span>       </span><span class="hs-special">(</span><span> </span><a href="ListSetOps.html#minusList"><span class="hs-identifier hs-var">minusList</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-75"></a><span class="hs-keyword">import</span><span> </span><a href="Platform.html"><span class="hs-identifier">Platform</span></a><span>
</span><a name="line-76"></a><span class="hs-keyword">import</span><span> </span><a href="Util.html"><span class="hs-identifier">Util</span></a><span>
</span><a name="line-77"></a><span class="hs-keyword">import</span><span> </span><a href="Pair.html"><span class="hs-identifier">Pair</span></a><span>
</span><a name="line-78"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Function.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Function</span></a><span>       </span><span class="hs-special">(</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Function.html#on"><span class="hs-identifier hs-var">on</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-79"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.List.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span></a><span>
</span><a name="line-80"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Ord.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Ord</span></a><span>            </span><span class="hs-special">(</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Ord.html#comparing"><span class="hs-identifier hs-var">comparing</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-81"></a><span class="hs-keyword">import</span><span> </span><a href="OrdList.html"><span class="hs-identifier">OrdList</span></a><span>
</span><a name="line-82"></a><span>
</span><a name="line-83"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Find the type of a Core atom/expression}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-90"></a><span>
</span><a name="line-91"></a><span class="hs-identifier">exprType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>
</span><a name="line-92"></a><span class="hs-comment">-- ^ Recover the type of a well-typed Core expression. Fails when</span><span>
</span><a name="line-93"></a><span class="hs-comment">-- applied to the actual 'CoreSyn.Type' expression as it cannot</span><span>
</span><a name="line-94"></a><span class="hs-comment">-- really be said to have a type</span><span>
</span><a name="line-95"></a><a name="exprType"><a href="CoreUtils.html#exprType"><span class="hs-identifier">exprType</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-1627735074"><a href="#local-1627735074"><span class="hs-identifier">var</span></a></a><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#idType"><span class="hs-identifier hs-var">idType</span></a><span> </span><a href="#local-1627735074"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-96"></a><span class="hs-identifier">exprType</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><a name="local-1627735075"><a href="#local-1627735075"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="Literal.html#literalType"><span class="hs-identifier hs-var">literalType</span></a><span> </span><a href="#local-1627735075"><span class="hs-identifier hs-var">lit</span></a><span>
</span><a name="line-97"></a><span class="hs-identifier">exprType</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a name="local-1627735076"><a href="#local-1627735076"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#coercionType"><span class="hs-identifier hs-var">coercionType</span></a><span> </span><a href="#local-1627735076"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-98"></a><span class="hs-identifier">exprType</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><a name="local-1627735077"><a href="#local-1627735077"><span class="hs-identifier">bind</span></a></a><span> </span><a name="local-1627735078"><a href="#local-1627735078"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-99"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a name="local-1627735079"><a href="#local-1627735079"><span class="hs-identifier">tv</span></a></a><span> </span><a name="local-1627735080"><a href="#local-1627735080"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627735077"><span class="hs-identifier hs-var">bind</span></a><span>    </span><span class="hs-comment">-- See Note [Type bindings]</span><span>
</span><a name="line-100"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a name="local-1627735081"><a href="#local-1627735081"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627735080"><span class="hs-identifier hs-var">rhs</span></a><span>           </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substTyWithUnchecked"><span class="hs-identifier hs-var">substTyWithUnchecked</span></a><span> </span><span class="hs-special">[</span><a href="#local-1627735079"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><a href="#local-1627735081"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><a href="CoreUtils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a><span> </span><a href="#local-1627735078"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-101"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>                </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a><span> </span><a href="#local-1627735078"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-102"></a><span class="hs-identifier">exprType</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Case"><span class="hs-identifier hs-var">Case</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627735082"><a href="#local-1627735082"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735082"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-103"></a><span class="hs-identifier">exprType</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627735083"><a href="#local-1627735083"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">pSnd</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span> </span><a href="#local-1627735083"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-104"></a><span class="hs-identifier">exprType</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627735084"><a href="#local-1627735084"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a><span> </span><a href="#local-1627735084"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-105"></a><span class="hs-identifier">exprType</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a name="local-1627735085"><a href="#local-1627735085"><span class="hs-identifier">binder</span></a></a><span> </span><a name="local-1627735086"><a href="#local-1627735086"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#mkPiType"><span class="hs-identifier hs-var">mkPiType</span></a><span> </span><a href="#local-1627735085"><span class="hs-identifier hs-var">binder</span></a><span> </span><span class="hs-special">(</span><a href="CoreUtils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a><span> </span><a href="#local-1627735086"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-106"></a><span class="hs-identifier">exprType</span><span> </span><a name="local-1627735087"><a href="#local-1627735087"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-107"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="CoreSyn.html#collectArgs"><span class="hs-identifier hs-var">collectArgs</span></a><span> </span><a href="#local-1627735087"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-108"></a><span>        </span><span class="hs-special">(</span><a name="local-1627735088"><a href="#local-1627735088"><span class="hs-identifier">fun</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627735089"><a href="#local-1627735089"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreUtils.html#applyTypeToArgs"><span class="hs-identifier hs-var">applyTypeToArgs</span></a><span> </span><a href="#local-1627735087"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-special">(</span><a href="CoreUtils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a><span> </span><a href="#local-1627735088"><span class="hs-identifier hs-var">fun</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735089"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-109"></a><span>
</span><a name="line-110"></a><span class="hs-identifier">exprType</span><span> </span><a name="local-1627735090"><a href="#local-1627735090"><span class="hs-identifier">other</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprTrace"><span class="hs-identifier hs-var">pprTrace</span></a><span> </span><span class="hs-string">&quot;exprType&quot;</span><span> </span><span class="hs-special">(</span><a href="PprCore.html#pprCoreExpr"><span class="hs-identifier hs-var">pprCoreExpr</span></a><span> </span><a href="#local-1627735090"><span class="hs-identifier hs-var">other</span></a><span class="hs-special">)</span><span> </span><a href="TysPrim.html#alphaTy"><span class="hs-identifier hs-var">alphaTy</span></a><span>
</span><a name="line-111"></a><span>
</span><a name="line-112"></a><span class="hs-identifier">coreAltType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreAlt"><span class="hs-identifier hs-type">CoreAlt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>
</span><a name="line-113"></a><span class="hs-comment">-- ^ Returns the type of the alternatives right hand side</span><span>
</span><a name="line-114"></a><a name="coreAltType"><a href="CoreUtils.html#coreAltType"><span class="hs-identifier">coreAltType</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-1627735091"><a href="#local-1627735091"><span class="hs-identifier">bs</span></a></a><span class="hs-special">,</span><a name="local-1627735092"><a href="#local-1627735092"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-115"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#any"><span class="hs-identifier hs-var">any</span></a><span> </span><a href="#local-1627735095"><span class="hs-identifier hs-var">bad_binder</span></a><span> </span><a href="#local-1627735091"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#expandTypeSynonyms"><span class="hs-identifier hs-var">expandTypeSynonyms</span></a><span> </span><a href="#local-1627735093"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-116"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735093"><span class="hs-identifier hs-var">ty</span></a><span>    </span><span class="hs-comment">-- Note [Existential variables and silly type synonyms]</span><span>
</span><a name="line-117"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-118"></a><span>    </span><a name="local-1627735093"><a href="#local-1627735093"><span class="hs-identifier">ty</span></a></a><span>           </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a><span> </span><a href="#local-1627735092"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-119"></a><span>    </span><a name="local-1627735094"><a href="#local-1627735094"><span class="hs-identifier">free_tvs</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#tyCoVarsOfType"><span class="hs-identifier hs-var">tyCoVarsOfType</span></a><span> </span><a href="#local-1627735093"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-120"></a><span>    </span><a name="local-1627735095"><a href="#local-1627735095"><span class="hs-identifier">bad_binder</span></a></a><span> </span><a name="local-1627735096"><a href="#local-1627735096"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735096"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#elemVarSet"><span class="hs-identifier hs-var">elemVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627735094"><span class="hs-identifier hs-var">free_tvs</span></a><span>
</span><a name="line-121"></a><span>
</span><a name="line-122"></a><span class="hs-identifier">coreAltsType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreAlt"><span class="hs-identifier hs-type">CoreAlt</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>
</span><a name="line-123"></a><span class="hs-comment">-- ^ Returns the type of the first alternative, which should be the same as for all alternatives</span><span>
</span><a name="line-124"></a><a name="coreAltsType"><a href="CoreUtils.html#coreAltsType"><span class="hs-identifier">coreAltsType</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1627735097"><a href="#local-1627735097"><span class="hs-identifier">alt</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#coreAltType"><span class="hs-identifier hs-var">coreAltType</span></a><span> </span><a href="#local-1627735097"><span class="hs-identifier hs-var">alt</span></a><span>
</span><a name="line-125"></a><span class="hs-identifier">coreAltsType</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Panic.html#panic"><span class="hs-identifier hs-var">panic</span></a><span> </span><span class="hs-string">&quot;corAltsType&quot;</span><span>
</span><a name="line-126"></a><span>
</span><a name="line-127"></a><span class="hs-comment">{-
Note [Type bindings]
~~~~~~~~~~~~~~~~~~~~
Core does allow type bindings, although such bindings are
not much used, except in the output of the desuguarer.
Example:
     let a = Int in (\x:a. x)
Given this, exprType must be careful to substitute 'a' in the
result type (Trac #8522).

Note [Existential variables and silly type synonyms]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
        data T = forall a. T (Funny a)
        type Funny a = Bool
        f :: T -&gt; Bool
        f (T x) = x

Now, the type of 'x' is (Funny a), where 'a' is existentially quantified.
That means that 'exprType' and 'coreAltsType' may give a result that *appears*
to mention an out-of-scope type variable.  See Trac #3409 for a more real-world
example.

Various possibilities suggest themselves:

 - Ignore the problem, and make Lint not complain about such variables

 - Expand all type synonyms (or at least all those that discard arguments)
      This is tricky, because at least for top-level things we want to
      retain the type the user originally specified.

 - Expand synonyms on the fly, when the problem arises. That is what
   we are doing here.  It's not too expensive, I think.

Note that there might be existentially quantified coercion variables, too.
-}</span><span>
</span><a name="line-163"></a><span>
</span><a name="line-164"></a><span class="hs-comment">-- Not defined with applyTypeToArg because you can't print from CoreSyn.</span><span>
</span><a name="line-165"></a><span class="hs-identifier">applyTypeToArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>
</span><a name="line-166"></a><span class="hs-comment">-- ^ A more efficient version of 'applyTypeToArg' when we have several arguments.</span><span>
</span><a name="line-167"></a><span class="hs-comment">-- The first argument is just for debugging, and gives some context</span><span>
</span><a name="line-168"></a><a name="applyTypeToArgs"><a href="CoreUtils.html#applyTypeToArgs"><span class="hs-identifier">applyTypeToArgs</span></a></a><span> </span><a name="local-1627735098"><a href="#local-1627735098"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-1627735099"><a href="#local-1627735099"><span class="hs-identifier">op_ty</span></a></a><span> </span><a name="local-1627735100"><a href="#local-1627735100"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-169"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735101"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735099"><span class="hs-identifier hs-var">op_ty</span></a><span> </span><a href="#local-1627735100"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-170"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-171"></a><span>    </span><a name="local-1627735101"><a href="#local-1627735101"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-1627735104"><a href="#local-1627735104"><span class="hs-identifier">op_ty</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>                   </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735104"><span class="hs-identifier hs-var">op_ty</span></a><span>
</span><a name="line-172"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1627735105"><a href="#local-1627735105"><span class="hs-identifier">op_ty</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a name="local-1627735106"><a href="#local-1627735106"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-1627735107"><a href="#local-1627735107"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735102"><span class="hs-identifier hs-var">go_ty_args</span></a><span> </span><a href="#local-1627735105"><span class="hs-identifier hs-var">op_ty</span></a><span> </span><span class="hs-special">[</span><a href="#local-1627735106"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">]</span><span> </span><a href="#local-1627735107"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-173"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1627735108"><a href="#local-1627735108"><span class="hs-identifier">op_ty</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a name="local-1627735109"><a href="#local-1627735109"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-1627735110"><a href="#local-1627735110"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735102"><span class="hs-identifier hs-var">go_ty_args</span></a><span> </span><a href="#local-1627735108"><span class="hs-identifier hs-var">op_ty</span></a><span> </span><span class="hs-special">[</span><a href="Type.html#mkCoercionTy"><span class="hs-identifier hs-var">mkCoercionTy</span></a><span> </span><a href="#local-1627735109"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">]</span><span> </span><a href="#local-1627735110"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-174"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1627735111"><a href="#local-1627735111"><span class="hs-identifier">op_ty</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-1627735112"><a href="#local-1627735112"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>           </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-1627735113"><a href="#local-1627735113"><span class="hs-identifier">res_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitFunTy_maybe"><span class="hs-identifier hs-var">splitFunTy_maybe</span></a><span> </span><a href="#local-1627735111"><span class="hs-identifier hs-var">op_ty</span></a><span>
</span><a name="line-175"></a><span>                                  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735101"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735113"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><a href="#local-1627735112"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-176"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;applyTypeToArgs&quot;</span><span> </span><a href="#local-1627735103"><span class="hs-identifier hs-var">panic_msg</span></a><span>
</span><a name="line-177"></a><span>
</span><a name="line-178"></a><span>    </span><span class="hs-comment">-- go_ty_args: accumulate type arguments so we can</span><span>
</span><a name="line-179"></a><span>    </span><span class="hs-comment">-- instantiate all at once with piResultTys</span><span>
</span><a name="line-180"></a><span>    </span><a name="local-1627735102"><a href="#local-1627735102"><span class="hs-identifier">go_ty_args</span></a></a><span> </span><a name="local-1627735114"><a href="#local-1627735114"><span class="hs-identifier">op_ty</span></a></a><span> </span><a name="local-1627735115"><a href="#local-1627735115"><span class="hs-identifier">rev_tys</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a name="local-1627735116"><a href="#local-1627735116"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-1627735117"><a href="#local-1627735117"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-181"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735102"><span class="hs-identifier hs-var">go_ty_args</span></a><span> </span><a href="#local-1627735114"><span class="hs-identifier hs-var">op_ty</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627735116"><span class="hs-identifier hs-var">ty</span></a><span class="hs-glyph">:</span><a href="#local-1627735115"><span class="hs-identifier hs-var">rev_tys</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735117"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-182"></a><span>    </span><span class="hs-identifier">go_ty_args</span><span> </span><a name="local-1627735118"><a href="#local-1627735118"><span class="hs-identifier">op_ty</span></a></a><span> </span><a name="local-1627735119"><a href="#local-1627735119"><span class="hs-identifier">rev_tys</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a name="local-1627735120"><a href="#local-1627735120"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-1627735121"><a href="#local-1627735121"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-183"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735102"><span class="hs-identifier hs-var">go_ty_args</span></a><span> </span><a href="#local-1627735118"><span class="hs-identifier hs-var">op_ty</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#mkCoercionTy"><span class="hs-identifier hs-var">mkCoercionTy</span></a><span> </span><a href="#local-1627735120"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-1627735119"><span class="hs-identifier hs-var">rev_tys</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735121"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-184"></a><span>    </span><span class="hs-identifier">go_ty_args</span><span> </span><a name="local-1627735122"><a href="#local-1627735122"><span class="hs-identifier">op_ty</span></a></a><span> </span><a name="local-1627735123"><a href="#local-1627735123"><span class="hs-identifier">rev_tys</span></a></a><span> </span><a name="local-1627735124"><a href="#local-1627735124"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-185"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735101"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#piResultTys"><span class="hs-identifier hs-var">piResultTys</span></a><span> </span><a href="#local-1627735122"><span class="hs-identifier hs-var">op_ty</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#reverse"><span class="hs-identifier hs-var">reverse</span></a><span> </span><a href="#local-1627735123"><span class="hs-identifier hs-var">rev_tys</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-1627735124"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-186"></a><span>
</span><a name="line-187"></a><span>    </span><a name="local-1627735103"><a href="#local-1627735103"><span class="hs-identifier">panic_msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Expression:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="PprCore.html#pprCoreExpr"><span class="hs-identifier hs-var">pprCoreExpr</span></a><span> </span><a href="#local-1627735098"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-188"></a><span>                     </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Type:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1627735099"><span class="hs-identifier hs-var">op_ty</span></a><span>
</span><a name="line-189"></a><span>                     </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Args:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1627735100"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-190"></a><span>
</span><a name="line-191"></a><span>
</span><a name="line-192"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Attaching notes}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-199"></a><span>
</span><a name="line-200"></a><span class="hs-comment">-- | Wrap the given expression in the coercion safely, dropping</span><span>
</span><a name="line-201"></a><span class="hs-comment">-- identity coercions and coalescing nested coercions</span><span>
</span><a name="line-202"></a><span class="hs-identifier">mkCast</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-203"></a><a name="mkCast"><a href="CoreUtils.html#mkCast"><span class="hs-identifier">mkCast</span></a></a><span> </span><a name="local-1627735125"><a href="#local-1627735125"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-1627735126"><a href="#local-1627735126"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-204"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">coercionRole</span><span> </span><a href="Coercion.html#coercionRole"><span class="hs-identifier hs-var">co</span></a><span> </span><a href="Coercion.html#coercionRole"><span class="hs-operator hs-var">==</span></a><span> </span><span class="hs-identifier">Representational</span><span>
</span><a name="line-205"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;coercion&quot;</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">co</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ptext</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sLit</span><span> </span><span class="hs-string">&quot;passed to mkCast&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-206"></a><span>             </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">e</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;has wrong role&quot;</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">coercionRole</span><span> </span><span class="hs-identifier">co</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-207"></a><span>    </span><a href="Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a><span> </span><a href="#local-1627735126"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-208"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735125"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-209"></a><span>
</span><a name="line-210"></a><span class="hs-identifier">mkCast</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a name="local-1627735127"><a href="#local-1627735127"><span class="hs-identifier">e_co</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627735128"><a href="#local-1627735128"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-211"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TyCoRep.html#isCoercionType"><span class="hs-identifier hs-var">isCoercionType</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">pSnd</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span> </span><a href="#local-1627735128"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-212"></a><span>       </span><span class="hs-comment">-- The guard here checks that g has a (~#) on both sides,</span><span>
</span><a name="line-213"></a><span>       </span><span class="hs-comment">-- otherwise decomposeCo fails.  Can in principle happen</span><span>
</span><a name="line-214"></a><span>       </span><span class="hs-comment">-- with unsafeCoerce</span><span>
</span><a name="line-215"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkCoCast"><span class="hs-identifier hs-var">mkCoCast</span></a><span> </span><a href="#local-1627735127"><span class="hs-identifier hs-var">e_co</span></a><span> </span><a href="#local-1627735128"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-216"></a><span>
</span><a name="line-217"></a><span class="hs-identifier">mkCast</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-1627735129"><a href="#local-1627735129"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-1627735130"><a href="#local-1627735130"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627735131"><a href="#local-1627735131"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-218"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">WARN</span><span class="hs-special">(</span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">Pair</span><span>  </span><span class="hs-identifier">from_ty</span><span>  </span><span class="hs-identifier">_to_ty</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">coercionKind</span><span> </span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">;</span><span>
</span><a name="line-219"></a><span>               </span><span class="hs-identifier">Pair</span><span> </span><span class="hs-identifier">_from_ty2</span><span>  </span><span class="hs-identifier">to_ty2</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">coercionKind</span><span> </span><span class="hs-identifier">co2</span><span class="hs-special">}</span><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-220"></a><span>            </span><span class="hs-identifier">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">from_ty</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">eqType</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">to_ty2</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-221"></a><span>             </span><span class="hs-identifier">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span> </span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;expr:&quot;</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">expr</span><span>
</span><a name="line-222"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;co2:&quot;</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">co2</span><span>
</span><a name="line-223"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;co:&quot;</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">co</span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-224"></a><span>    </span><a href="CoreUtils.html#mkCast"><span class="hs-identifier hs-var">mkCast</span></a><span> </span><a href="#local-1627735129"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkTransCo"><span class="hs-identifier hs-var">mkTransCo</span></a><span> </span><a href="#local-1627735130"><span class="hs-identifier hs-var">co2</span></a><span> </span><a href="#local-1627735131"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-225"></a><span>
</span><a name="line-226"></a><span class="hs-identifier">mkCast</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-1627735136"><a href="#local-1627735136"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-1627735137"><a href="#local-1627735137"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627735138"><a href="#local-1627735138"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-227"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a href="#local-1627735136"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-special">(</span><a href="CoreUtils.html#mkCast"><span class="hs-identifier hs-var">mkCast</span></a><span> </span><a href="#local-1627735137"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-1627735138"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-228"></a><span>
</span><a name="line-229"></a><span class="hs-identifier">mkCast</span><span> </span><a name="local-1627735139"><a href="#local-1627735139"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-1627735140"><a href="#local-1627735140"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-230"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-1627735141"><a href="#local-1627735141"><span class="hs-identifier">from_ty</span></a></a><span> </span><a name="local-1627735142"><a href="#local-1627735142"><span class="hs-identifier">_to_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span> </span><a href="#local-1627735140"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-231"></a><span>    </span><span class="hs-identifier">WARN</span><span class="hs-special">(</span><span> </span><a href="Outputable.html#warnPprTrace"><span class="hs-identifier hs-var">not</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">from_ty</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">eqType</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">exprType</span><span> </span><span class="hs-identifier">expr</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-232"></a><span>          </span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;Trying to coerce&quot;</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;(&quot;</span><span> </span><span class="hs-operator">&lt;&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">expr</span><span>
</span><a name="line-233"></a><span>          </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;::&quot;</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">exprType</span><span> </span><span class="hs-identifier">expr</span><span class="hs-special">)</span><span> </span><span class="hs-operator">&lt;&gt;</span><span> </span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;)&quot;</span><span>
</span><a name="line-234"></a><span>          </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">co</span><span> </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">coercionType</span><span> </span><span class="hs-identifier">co</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-235"></a><span>    </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a href="#local-1627735139"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-1627735140"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-236"></a><span>
</span><a name="line-237"></a><span class="hs-comment">-- | Wraps the given expression in the source annotation, dropping the</span><span>
</span><a name="line-238"></a><span class="hs-comment">-- annotation if possible.</span><span>
</span><a name="line-239"></a><span class="hs-identifier">mkTick</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-240"></a><a name="mkTick"><a href="CoreUtils.html#mkTick"><span class="hs-identifier">mkTick</span></a></a><span> </span><a name="local-1627735143"><a href="#local-1627735143"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-1627735144"><a href="#local-1627735144"><span class="hs-identifier">orig_expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735146"><span class="hs-identifier hs-var">mkTick'</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#id"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#id"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-1627735144"><span class="hs-identifier hs-var">orig_expr</span></a><span>
</span><a name="line-241"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-242"></a><span>  </span><span class="hs-comment">-- Some ticks (cost-centres) can be split in two, with the</span><span>
</span><a name="line-243"></a><span>  </span><span class="hs-comment">-- non-counting part having laxer placement properties.</span><span>
</span><a name="line-244"></a><span>  </span><a name="local-1627735145"><a href="#local-1627735145"><span class="hs-identifier">canSplit</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#tickishCanSplit"><span class="hs-identifier hs-var">tickishCanSplit</span></a><span> </span><a href="#local-1627735143"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="CoreSyn.html#tickishPlace"><span class="hs-identifier hs-var">tickishPlace</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#mkNoCount"><span class="hs-identifier hs-var">mkNoCount</span></a><span> </span><a href="#local-1627735143"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">/=</span><span> </span><a href="CoreSyn.html#tickishPlace"><span class="hs-identifier hs-var">tickishPlace</span></a><span> </span><a href="#local-1627735143"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-245"></a><span>
</span><a name="line-246"></a><span>  </span><span class="hs-identifier">mkTick'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ apply after adding tick (float through)</span><span>
</span><a name="line-247"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ apply before adding tick (float with)</span><span>
</span><a name="line-248"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>               </span><span class="hs-comment">-- ^ current expression</span><span>
</span><a name="line-249"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-250"></a><span>  </span><a name="local-1627735146"><a href="#local-1627735146"><span class="hs-identifier">mkTick'</span></a></a><span> </span><a name="local-1627735147"><a href="#local-1627735147"><span class="hs-identifier">top</span></a></a><span> </span><a name="local-1627735148"><a href="#local-1627735148"><span class="hs-identifier">rest</span></a></a><span> </span><a name="local-1627735149"><a href="#local-1627735149"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1627735149"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-251"></a><span>
</span><a name="line-252"></a><span>    </span><span class="hs-comment">-- Cost centre ticks should never be reordered relative to each</span><span>
</span><a name="line-253"></a><span>    </span><span class="hs-comment">-- other. Therefore we can stop whenever two collide.</span><span>
</span><a name="line-254"></a><span>    </span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-1627735150"><a href="#local-1627735150"><span class="hs-identifier">t2</span></a></a><span> </span><a name="local-1627735151"><a href="#local-1627735151"><span class="hs-identifier">e</span></a></a><span>
</span><a name="line-255"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#ProfNote"><span class="hs-identifier hs-var">ProfNote</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627735150"><span class="hs-identifier hs-var">t2</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#ProfNote"><span class="hs-identifier hs-var">ProfNote</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627735143"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627735147"><span class="hs-identifier hs-var">top</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a href="#local-1627735143"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="#local-1627735148"><span class="hs-identifier hs-var">rest</span></a><span> </span><a href="#local-1627735149"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-256"></a><span>
</span><a name="line-257"></a><span>    </span><span class="hs-comment">-- Otherwise we assume that ticks of different placements float</span><span>
</span><a name="line-258"></a><span>    </span><span class="hs-comment">-- through each other.</span><span>
</span><a name="line-259"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#tickishPlace"><span class="hs-identifier hs-var">tickishPlace</span></a><span> </span><a href="#local-1627735150"><span class="hs-identifier hs-var">t2</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><a href="CoreSyn.html#tickishPlace"><span class="hs-identifier hs-var">tickishPlace</span></a><span> </span><a href="#local-1627735143"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627735146"><span class="hs-identifier hs-var">mkTick'</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627735147"><span class="hs-identifier hs-var">top</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a href="#local-1627735150"><span class="hs-identifier hs-var">t2</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735148"><span class="hs-identifier hs-var">rest</span></a><span> </span><a href="#local-1627735151"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-260"></a><span>
</span><a name="line-261"></a><span>    </span><span class="hs-comment">-- For annotations this is where we make sure to not introduce</span><span>
</span><a name="line-262"></a><span>    </span><span class="hs-comment">-- redundant ticks.</span><span>
</span><a name="line-263"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#tickishContains"><span class="hs-identifier hs-var">tickishContains</span></a><span> </span><a href="#local-1627735143"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-1627735150"><span class="hs-identifier hs-var">t2</span></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627735146"><span class="hs-identifier hs-var">mkTick'</span></a><span> </span><a href="#local-1627735147"><span class="hs-identifier hs-var">top</span></a><span> </span><a href="#local-1627735148"><span class="hs-identifier hs-var">rest</span></a><span> </span><a href="#local-1627735151"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-264"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#tickishContains"><span class="hs-identifier hs-var">tickishContains</span></a><span> </span><a href="#local-1627735150"><span class="hs-identifier hs-var">t2</span></a><span> </span><a href="#local-1627735143"><span class="hs-identifier hs-var">t</span></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627735144"><span class="hs-identifier hs-var">orig_expr</span></a><span>
</span><a name="line-265"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627735146"><span class="hs-identifier hs-var">mkTick'</span></a><span> </span><a href="#local-1627735147"><span class="hs-identifier hs-var">top</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627735148"><span class="hs-identifier hs-var">rest</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a href="#local-1627735150"><span class="hs-identifier hs-var">t2</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735151"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-266"></a><span>
</span><a name="line-267"></a><span>    </span><span class="hs-comment">-- Ticks don't care about types, so we just float all ticks</span><span>
</span><a name="line-268"></a><span>    </span><span class="hs-comment">-- through them. Note that it's not enough to check for these</span><span>
</span><a name="line-269"></a><span>    </span><span class="hs-comment">-- cases top-level. While mkTick will never produce Core with type</span><span>
</span><a name="line-270"></a><span>    </span><span class="hs-comment">-- expressions below ticks, such constructs can be the result of</span><span>
</span><a name="line-271"></a><span>    </span><span class="hs-comment">-- unfoldings. We therefore make an effort to put everything into</span><span>
</span><a name="line-272"></a><span>    </span><span class="hs-comment">-- the right place no matter what we start with.</span><span>
</span><a name="line-273"></a><span>    </span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-1627735152"><a href="#local-1627735152"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-1627735153"><a href="#local-1627735153"><span class="hs-identifier">co</span></a></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627735146"><span class="hs-identifier hs-var">mkTick'</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627735147"><span class="hs-identifier hs-var">top</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#flip"><span class="hs-identifier hs-var">flip</span></a><span> </span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a href="#local-1627735153"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735148"><span class="hs-identifier hs-var">rest</span></a><span> </span><a href="#local-1627735152"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-274"></a><span>    </span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a name="local-1627735154"><a href="#local-1627735154"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a href="#local-1627735154"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-275"></a><span>
</span><a name="line-276"></a><span>    </span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a name="local-1627735155"><a href="#local-1627735155"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-1627735156"><a href="#local-1627735156"><span class="hs-identifier">e</span></a></a><span>
</span><a name="line-277"></a><span>      </span><span class="hs-comment">-- Always float through type lambdas. Even for non-type lambdas,</span><span>
</span><a name="line-278"></a><span>      </span><span class="hs-comment">-- floating is allowed for all but the most strict placement rule.</span><span>
</span><a name="line-279"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#isRuntimeVar"><span class="hs-identifier hs-var">isRuntimeVar</span></a><span> </span><a href="#local-1627735155"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="CoreSyn.html#tickishPlace"><span class="hs-identifier hs-var">tickishPlace</span></a><span> </span><a href="#local-1627735143"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><a href="CoreSyn.html#PlaceRuntime"><span class="hs-identifier hs-var">PlaceRuntime</span></a><span>
</span><a name="line-280"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627735146"><span class="hs-identifier hs-var">mkTick'</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627735147"><span class="hs-identifier hs-var">top</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a href="#local-1627735155"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735148"><span class="hs-identifier hs-var">rest</span></a><span> </span><a href="#local-1627735156"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-281"></a><span>
</span><a name="line-282"></a><span>      </span><span class="hs-comment">-- If it is both counting and scoped, we split the tick into its</span><span>
</span><a name="line-283"></a><span>      </span><span class="hs-comment">-- two components, often allowing us to keep the counting tick on</span><span>
</span><a name="line-284"></a><span>      </span><span class="hs-comment">-- the outside of the lambda and push the scoped tick inside.</span><span>
</span><a name="line-285"></a><span>      </span><span class="hs-comment">-- The point of this is that the counting tick can probably be</span><span>
</span><a name="line-286"></a><span>      </span><span class="hs-comment">-- floated, and the lambda may then be in a position to be</span><span>
</span><a name="line-287"></a><span>      </span><span class="hs-comment">-- beta-reduced.</span><span>
</span><a name="line-288"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627735145"><span class="hs-identifier hs-var">canSplit</span></a><span>
</span><a name="line-289"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627735147"><span class="hs-identifier hs-var">top</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#mkNoScope"><span class="hs-identifier hs-var">mkNoScope</span></a><span> </span><a href="#local-1627735143"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="#local-1627735148"><span class="hs-identifier hs-var">rest</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a href="#local-1627735155"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="CoreUtils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#mkNoCount"><span class="hs-identifier hs-var">mkNoCount</span></a><span> </span><a href="#local-1627735143"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735156"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-290"></a><span>
</span><a name="line-291"></a><span>    </span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-1627735157"><a href="#local-1627735157"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-1627735158"><a href="#local-1627735158"><span class="hs-identifier">arg</span></a></a><span>
</span><a name="line-292"></a><span>      </span><span class="hs-comment">-- Always float through type applications.</span><span>
</span><a name="line-293"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#isRuntimeArg"><span class="hs-identifier hs-var">isRuntimeArg</span></a><span> </span><a href="#local-1627735158"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span>
</span><a name="line-294"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627735146"><span class="hs-identifier hs-var">mkTick'</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627735147"><span class="hs-identifier hs-var">top</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#flip"><span class="hs-identifier hs-var">flip</span></a><span> </span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a href="#local-1627735158"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735148"><span class="hs-identifier hs-var">rest</span></a><span> </span><a href="#local-1627735157"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-295"></a><span>
</span><a name="line-296"></a><span>      </span><span class="hs-comment">-- We can also float through constructor applications, placement</span><span>
</span><a name="line-297"></a><span>      </span><span class="hs-comment">-- permitting. Again we can split.</span><span>
</span><a name="line-298"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="CoreUtils.html#isSaturatedConApp"><span class="hs-identifier hs-var">isSaturatedConApp</span></a><span> </span><a href="#local-1627735149"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#tickishPlace"><span class="hs-identifier hs-var">tickishPlace</span></a><span> </span><a href="#local-1627735143"><span class="hs-identifier hs-var">t</span></a><span class="hs-operator hs-var">==</span><a href="CoreSyn.html#PlaceCostCentre"><span class="hs-identifier hs-var">PlaceCostCentre</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-1627735145"><span class="hs-identifier hs-var">canSplit</span></a><span class="hs-special">)</span><span>
</span><a name="line-299"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="CoreSyn.html#tickishPlace"><span class="hs-identifier hs-var">tickishPlace</span></a><span> </span><a href="#local-1627735143"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="CoreSyn.html#PlaceCostCentre"><span class="hs-identifier hs-var">PlaceCostCentre</span></a><span>
</span><a name="line-300"></a><span>         </span><span class="hs-keyword">then</span><span> </span><a href="#local-1627735147"><span class="hs-identifier hs-var">top</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="#local-1627735148"><span class="hs-identifier hs-var">rest</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="CoreUtils.html#tickHNFArgs"><span class="hs-identifier hs-var">tickHNFArgs</span></a><span> </span><a href="#local-1627735143"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-1627735149"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-301"></a><span>         </span><span class="hs-keyword">else</span><span> </span><a href="#local-1627735147"><span class="hs-identifier hs-var">top</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#mkNoScope"><span class="hs-identifier hs-var">mkNoScope</span></a><span> </span><a href="#local-1627735143"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="#local-1627735148"><span class="hs-identifier hs-var">rest</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="CoreUtils.html#tickHNFArgs"><span class="hs-identifier hs-var">tickHNFArgs</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#mkNoCount"><span class="hs-identifier hs-var">mkNoCount</span></a><span> </span><a href="#local-1627735143"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735149"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-302"></a><span>
</span><a name="line-303"></a><span>    </span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-1627735159"><a href="#local-1627735159"><span class="hs-identifier">x</span></a></a><span>
</span><a name="line-304"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627735160"><span class="hs-identifier hs-var">notFunction</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="CoreSyn.html#tickishPlace"><span class="hs-identifier hs-var">tickishPlace</span></a><span> </span><a href="#local-1627735143"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="CoreSyn.html#PlaceCostCentre"><span class="hs-identifier hs-var">PlaceCostCentre</span></a><span>
</span><a name="line-305"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627735144"><span class="hs-identifier hs-var">orig_expr</span></a><span>
</span><a name="line-306"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627735160"><span class="hs-identifier hs-var">notFunction</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-1627735145"><span class="hs-identifier hs-var">canSplit</span></a><span>
</span><a name="line-307"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627735147"><span class="hs-identifier hs-var">top</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#mkNoScope"><span class="hs-identifier hs-var">mkNoScope</span></a><span> </span><a href="#local-1627735143"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="#local-1627735148"><span class="hs-identifier hs-var">rest</span></a><span> </span><a href="#local-1627735149"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-308"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-309"></a><span>        </span><span class="hs-comment">-- SCCs can be eliminated on variables provided the variable</span><span>
</span><a name="line-310"></a><span>        </span><span class="hs-comment">-- is not a function.  In these cases the SCC makes no difference:</span><span>
</span><a name="line-311"></a><span>        </span><span class="hs-comment">-- the cost of evaluating the variable will be attributed to its</span><span>
</span><a name="line-312"></a><span>        </span><span class="hs-comment">-- definition site.  When the variable refers to a function, however,</span><span>
</span><a name="line-313"></a><span>        </span><span class="hs-comment">-- an SCC annotation on the variable affects the cost-centre stack</span><span>
</span><a name="line-314"></a><span>        </span><span class="hs-comment">-- when the function is called, so we must retain those.</span><span>
</span><a name="line-315"></a><span>        </span><a name="local-1627735160"><a href="#local-1627735160"><span class="hs-identifier">notFunction</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Type.html#isFunTy"><span class="hs-identifier hs-var">isFunTy</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idType"><span class="hs-identifier hs-var">idType</span></a><span> </span><a href="#local-1627735159"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-316"></a><span>
</span><a name="line-317"></a><span>    </span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span>
</span><a name="line-318"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#tickishPlace"><span class="hs-identifier hs-var">tickishPlace</span></a><span> </span><a href="#local-1627735143"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="CoreSyn.html#PlaceCostCentre"><span class="hs-identifier hs-var">PlaceCostCentre</span></a><span>
</span><a name="line-319"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627735144"><span class="hs-identifier hs-var">orig_expr</span></a><span>
</span><a name="line-320"></a><span>
</span><a name="line-321"></a><span>    </span><span class="hs-comment">-- Catch-all: Annotate where we stand</span><span>
</span><a name="line-322"></a><span>    </span><a name="local-1627735161"><a href="#local-1627735161"><span class="hs-identifier">_any</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627735147"><span class="hs-identifier hs-var">top</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a href="#local-1627735143"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="#local-1627735148"><span class="hs-identifier hs-var">rest</span></a><span> </span><a href="#local-1627735149"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-323"></a><span>
</span><a name="line-324"></a><span class="hs-identifier">mkTicks</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-325"></a><a name="mkTicks"><a href="CoreUtils.html#mkTicks"><span class="hs-identifier">mkTicks</span></a></a><span> </span><a name="local-1627735162"><a href="#local-1627735162"><span class="hs-identifier">ticks</span></a></a><span> </span><a name="local-1627735163"><a href="#local-1627735163"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#foldr"><span class="hs-identifier hs-var">foldr</span></a><span> </span><a href="CoreUtils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a><span> </span><a href="#local-1627735163"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-1627735162"><span class="hs-identifier hs-var">ticks</span></a><span>
</span><a name="line-326"></a><span>
</span><a name="line-327"></a><span class="hs-identifier">isSaturatedConApp</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-328"></a><a name="isSaturatedConApp"><a href="CoreUtils.html#isSaturatedConApp"><span class="hs-identifier">isSaturatedConApp</span></a></a><span> </span><a name="local-1627735164"><a href="#local-1627735164"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735165"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735164"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-329"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-1627735165"><a href="#local-1627735165"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-1627735166"><a href="#local-1627735166"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-1627735167"><a href="#local-1627735167"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735165"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735166"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627735167"><span class="hs-identifier hs-var">a</span></a><span class="hs-glyph">:</span><span class="hs-keyword">as</span><span class="hs-special">)</span><span>
</span><a name="line-330"></a><span>        </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-1627735169"><a href="#local-1627735169"><span class="hs-identifier">fun</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627735170"><a href="#local-1627735170"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-331"></a><span>           </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#isConLikeId"><span class="hs-identifier hs-var">isConLikeId</span></a><span> </span><a href="#local-1627735169"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a><span> </span><a href="#local-1627735169"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="CoreSyn.html#valArgCount"><span class="hs-identifier hs-var">valArgCount</span></a><span> </span><a href="#local-1627735170"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-332"></a><span>        </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-1627735171"><a href="#local-1627735171"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735165"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735171"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-keyword">as</span><span>
</span><a name="line-333"></a><span>        </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-334"></a><span>
</span><a name="line-335"></a><span class="hs-identifier">mkTickNoHNF</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-336"></a><a name="mkTickNoHNF"><a href="CoreUtils.html#mkTickNoHNF"><span class="hs-identifier">mkTickNoHNF</span></a></a><span> </span><a name="local-1627735173"><a href="#local-1627735173"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-1627735174"><a href="#local-1627735174"><span class="hs-identifier">e</span></a></a><span>
</span><a name="line-337"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="CoreUtils.html#exprIsHNF"><span class="hs-identifier hs-var">exprIsHNF</span></a><span> </span><a href="#local-1627735174"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#tickHNFArgs"><span class="hs-identifier hs-var">tickHNFArgs</span></a><span> </span><a href="#local-1627735173"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-1627735174"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-338"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a><span> </span><a href="#local-1627735173"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-1627735174"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-339"></a><span>
</span><a name="line-340"></a><span class="hs-comment">-- push a tick into the arguments of a HNF (call or constructor app)</span><span>
</span><a name="line-341"></a><span class="hs-identifier">tickHNFArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-342"></a><a name="tickHNFArgs"><a href="CoreUtils.html#tickHNFArgs"><span class="hs-identifier">tickHNFArgs</span></a></a><span> </span><a name="local-1627735175"><a href="#local-1627735175"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-1627735176"><a href="#local-1627735176"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735177"><span class="hs-identifier hs-var">push</span></a><span> </span><a href="#local-1627735175"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-1627735176"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-343"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-344"></a><span>  </span><a name="local-1627735177"><a href="#local-1627735177"><span class="hs-identifier">push</span></a></a><span> </span><a name="local-1627735178"><a href="#local-1627735178"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-1627735179"><a href="#local-1627735179"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a name="local-1627735180"><a href="#local-1627735180"><span class="hs-identifier">u</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627735177"><span class="hs-identifier hs-var">push</span></a><span> </span><a href="#local-1627735178"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-1627735179"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a href="#local-1627735180"><span class="hs-identifier hs-var">u</span></a><span class="hs-special">)</span><span>
</span><a name="line-345"></a><span>  </span><span class="hs-identifier">push</span><span> </span><a name="local-1627735181"><a href="#local-1627735181"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-1627735182"><a href="#local-1627735182"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-1627735183"><a href="#local-1627735183"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627735177"><span class="hs-identifier hs-var">push</span></a><span> </span><a href="#local-1627735181"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-1627735182"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreUtils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a><span> </span><a href="#local-1627735181"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-1627735183"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span>
</span><a name="line-346"></a><span>  </span><span class="hs-identifier">push</span><span> </span><a name="local-1627735184"><a href="#local-1627735184"><span class="hs-identifier">_t</span></a></a><span> </span><a name="local-1627735185"><a href="#local-1627735185"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735185"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-347"></a><span>
</span><a name="line-348"></a><span class="hs-comment">-- | Strip ticks satisfying a predicate from top of an expression</span><span>
</span><a name="line-349"></a><span class="hs-identifier">stripTicksTop</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-1627735073"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-1627735073"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-350"></a><a name="stripTicksTop"><a href="CoreUtils.html#stripTicksTop"><span class="hs-identifier">stripTicksTop</span></a></a><span> </span><a name="local-1627735186"><a href="#local-1627735186"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735187"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-351"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-1627735187"><a href="#local-1627735187"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-1627735188"><a href="#local-1627735188"><span class="hs-identifier">ts</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-1627735189"><a href="#local-1627735189"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-1627735190"><a href="#local-1627735190"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627735186"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-1627735189"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735187"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627735189"><span class="hs-identifier hs-var">t</span></a><span class="hs-glyph">:</span><a href="#local-1627735188"><span class="hs-identifier hs-var">ts</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735190"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-352"></a><span>        </span><span class="hs-identifier">go</span><span> </span><a name="local-1627735191"><a href="#local-1627735191"><span class="hs-identifier">ts</span></a></a><span> </span><a name="local-1627735192"><a href="#local-1627735192"><span class="hs-identifier">other</span></a></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#reverse"><span class="hs-identifier hs-var">reverse</span></a><span> </span><a href="#local-1627735191"><span class="hs-identifier hs-var">ts</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627735192"><span class="hs-identifier hs-var">other</span></a><span class="hs-special">)</span><span>
</span><a name="line-353"></a><span>
</span><a name="line-354"></a><span class="hs-comment">-- | Strip ticks satisfying a predicate from top of an expression,</span><span>
</span><a name="line-355"></a><span class="hs-comment">-- returning the remaining expresion</span><span>
</span><a name="line-356"></a><span class="hs-identifier">stripTicksTopE</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-1627735072"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-1627735072"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-357"></a><a name="stripTicksTopE"><a href="CoreUtils.html#stripTicksTopE"><span class="hs-identifier">stripTicksTopE</span></a></a><span> </span><a name="local-1627735193"><a href="#local-1627735193"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735194"><span class="hs-identifier hs-var">go</span></a><span>
</span><a name="line-358"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-1627735194"><a href="#local-1627735194"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-1627735195"><a href="#local-1627735195"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-1627735196"><a href="#local-1627735196"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627735193"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-1627735195"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735194"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735196"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-359"></a><span>        </span><span class="hs-identifier">go</span><span> </span><a name="local-1627735197"><a href="#local-1627735197"><span class="hs-identifier">other</span></a></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735197"><span class="hs-identifier hs-var">other</span></a><span>
</span><a name="line-360"></a><span>
</span><a name="line-361"></a><span class="hs-comment">-- | Strip ticks satisfying a predicate from top of an expression,</span><span>
</span><a name="line-362"></a><span class="hs-comment">-- returning the ticks</span><span>
</span><a name="line-363"></a><span class="hs-identifier">stripTicksTopT</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-1627735071"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">]</span><span>
</span><a name="line-364"></a><a name="stripTicksTopT"><a href="CoreUtils.html#stripTicksTopT"><span class="hs-identifier">stripTicksTopT</span></a></a><span> </span><a name="local-1627735198"><a href="#local-1627735198"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735199"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-365"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-1627735199"><a href="#local-1627735199"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-1627735200"><a href="#local-1627735200"><span class="hs-identifier">ts</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-1627735201"><a href="#local-1627735201"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-1627735202"><a href="#local-1627735202"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627735198"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-1627735201"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735199"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627735201"><span class="hs-identifier hs-var">t</span></a><span class="hs-glyph">:</span><a href="#local-1627735200"><span class="hs-identifier hs-var">ts</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735202"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-366"></a><span>        </span><span class="hs-identifier">go</span><span> </span><a name="local-1627735203"><a href="#local-1627735203"><span class="hs-identifier">ts</span></a></a><span> </span><span class="hs-identifier">_</span><span>                </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735203"><span class="hs-identifier hs-var">ts</span></a><span>
</span><a name="line-367"></a><span>
</span><a name="line-368"></a><span class="hs-comment">-- | Completely strip ticks satisfying a predicate from an</span><span>
</span><a name="line-369"></a><span class="hs-comment">-- expression. Note this is O(n) in the size of the expression!</span><span>
</span><a name="line-370"></a><span class="hs-identifier">stripTicksE</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-1627735070"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-1627735070"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-371"></a><a name="stripTicksE"><a href="CoreUtils.html#stripTicksE"><span class="hs-identifier">stripTicksE</span></a></a><span> </span><a name="local-1627735204"><a href="#local-1627735204"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-1627735205"><a href="#local-1627735205"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735206"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735205"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-372"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-1627735206"><a href="#local-1627735206"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-1627735210"><a href="#local-1627735210"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-1627735211"><a href="#local-1627735211"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627735206"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735210"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-1627735206"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735211"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-373"></a><span>        </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a name="local-1627735212"><a href="#local-1627735212"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-1627735213"><a href="#local-1627735213"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a href="#local-1627735212"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627735206"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735213"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-374"></a><span>        </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><a name="local-1627735214"><a href="#local-1627735214"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-1627735215"><a href="#local-1627735215"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627735207"><span class="hs-identifier hs-var">go_bs</span></a><span> </span><a href="#local-1627735214"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-1627735206"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735215"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-375"></a><span>        </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Case"><span class="hs-identifier hs-var">Case</span></a><span> </span><a name="local-1627735216"><a href="#local-1627735216"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-1627735217"><a href="#local-1627735217"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-1627735218"><a href="#local-1627735218"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Case"><span class="hs-identifier hs-var">Case</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627735206"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735216"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735217"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-1627735218"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="#local-1627735209"><span class="hs-identifier hs-var">go_a</span></a><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span>
</span><a name="line-376"></a><span>        </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-1627735220"><a href="#local-1627735220"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-1627735221"><a href="#local-1627735221"><span class="hs-identifier">c</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627735206"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735220"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735221"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-377"></a><span>        </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-1627735222"><a href="#local-1627735222"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-1627735223"><a href="#local-1627735223"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-378"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627735204"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-1627735222"><span class="hs-identifier hs-var">t</span></a><span>             </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735206"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735223"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-379"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a href="#local-1627735222"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627735206"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735223"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-380"></a><span>        </span><span class="hs-identifier">go</span><span> </span><a name="local-1627735224"><a href="#local-1627735224"><span class="hs-identifier">other</span></a></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735224"><span class="hs-identifier hs-var">other</span></a><span>
</span><a name="line-381"></a><span>        </span><a name="local-1627735207"><a href="#local-1627735207"><span class="hs-identifier">go_bs</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a name="local-1627735225"><a href="#local-1627735225"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-1627735226"><a href="#local-1627735226"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a href="#local-1627735225"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627735206"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735226"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-382"></a><span>        </span><span class="hs-identifier">go_bs</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><a name="local-1627735227"><a href="#local-1627735227"><span class="hs-identifier">bs</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="#local-1627735208"><span class="hs-identifier hs-var">go_b</span></a><span> </span><a href="#local-1627735227"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span>
</span><a name="line-383"></a><span>        </span><a name="local-1627735208"><a href="#local-1627735208"><span class="hs-identifier">go_b</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1627735228"><a href="#local-1627735228"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627735229"><a href="#local-1627735229"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-1627735228"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627735206"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735229"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-384"></a><span>        </span><a name="local-1627735209"><a href="#local-1627735209"><span class="hs-identifier">go_a</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1627735230"><a href="#local-1627735230"><span class="hs-identifier">c</span></a></a><span class="hs-special">,</span><a name="local-1627735231"><a href="#local-1627735231"><span class="hs-identifier">bs</span></a></a><span class="hs-special">,</span><a name="local-1627735232"><a href="#local-1627735232"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-1627735230"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">,</span><a href="#local-1627735231"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627735206"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735232"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-385"></a><span>
</span><a name="line-386"></a><span class="hs-identifier">stripTicksT</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-1627735069"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">]</span><span>
</span><a name="line-387"></a><a name="stripTicksT"><a href="CoreUtils.html#stripTicksT"><span class="hs-identifier">stripTicksT</span></a></a><span> </span><a name="local-1627735233"><a href="#local-1627735233"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-1627735234"><a href="#local-1627735234"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OrdList.html#fromOL"><span class="hs-identifier hs-var">fromOL</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="#local-1627735235"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735234"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-388"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-1627735235"><a href="#local-1627735235"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-1627735239"><a href="#local-1627735239"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-1627735240"><a href="#local-1627735240"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735235"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735239"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-special">`</span><a href="OrdList.html#appOL"><span class="hs-identifier hs-var">appOL</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627735235"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735240"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-389"></a><span>        </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627735241"><a href="#local-1627735241"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735235"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735241"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-390"></a><span>        </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><a name="local-1627735242"><a href="#local-1627735242"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-1627735243"><a href="#local-1627735243"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735236"><span class="hs-identifier hs-var">go_bs</span></a><span> </span><a href="#local-1627735242"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-special">`</span><a href="OrdList.html#appOL"><span class="hs-identifier hs-var">appOL</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627735235"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735243"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-391"></a><span>        </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Case"><span class="hs-identifier hs-var">Case</span></a><span> </span><a name="local-1627735244"><a href="#local-1627735244"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735235"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735244"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-special">`</span><a href="OrdList.html#appOL"><span class="hs-identifier hs-var">appOL</span></a><span class="hs-special">`</span><span> </span><a href="OrdList.html#concatOL"><span class="hs-identifier hs-var">concatOL</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="#local-1627735238"><span class="hs-identifier hs-var">go_a</span></a><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span>
</span><a name="line-392"></a><span>        </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-1627735246"><a href="#local-1627735246"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735235"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735246"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-393"></a><span>        </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-1627735247"><a href="#local-1627735247"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-1627735248"><a href="#local-1627735248"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-394"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627735233"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-1627735247"><span class="hs-identifier hs-var">t</span></a><span>             </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735247"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-special">`</span><a href="OrdList.html#consOL"><span class="hs-identifier hs-var">consOL</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627735235"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735248"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-395"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735235"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735248"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-396"></a><span>        </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span>                </span><span class="hs-glyph">=</span><span> </span><a href="OrdList.html#nilOL"><span class="hs-identifier hs-var">nilOL</span></a><span>
</span><a name="line-397"></a><span>        </span><a name="local-1627735236"><a href="#local-1627735236"><span class="hs-identifier">go_bs</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627735249"><a href="#local-1627735249"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735235"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735249"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-398"></a><span>        </span><span class="hs-identifier">go_bs</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><a name="local-1627735250"><a href="#local-1627735250"><span class="hs-identifier">bs</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="OrdList.html#concatOL"><span class="hs-identifier hs-var">concatOL</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="#local-1627735237"><span class="hs-identifier hs-var">go_b</span></a><span> </span><a href="#local-1627735250"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span>
</span><a name="line-399"></a><span>        </span><a name="local-1627735237"><a href="#local-1627735237"><span class="hs-identifier">go_b</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-1627735251"><a href="#local-1627735251"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735235"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735251"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-400"></a><span>        </span><a name="local-1627735238"><a href="#local-1627735238"><span class="hs-identifier">go_a</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-1627735252"><a href="#local-1627735252"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735235"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735252"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-401"></a><span>
</span><a name="line-402"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Other expression construction}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-409"></a><span>
</span><a name="line-410"></a><span class="hs-identifier">bindNonRec</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-411"></a><span class="hs-comment">-- ^ @bindNonRec x r b@ produces either:</span><span>
</span><a name="line-412"></a><span class="hs-comment">--</span><span>
</span><a name="line-413"></a><span class="hs-comment">-- &gt; let x = r in b</span><span>
</span><a name="line-414"></a><span class="hs-comment">--</span><span>
</span><a name="line-415"></a><span class="hs-comment">-- or:</span><span>
</span><a name="line-416"></a><span class="hs-comment">--</span><span>
</span><a name="line-417"></a><span class="hs-comment">-- &gt; case r of x { _DEFAULT_ -&gt; b }</span><span>
</span><a name="line-418"></a><span class="hs-comment">--</span><span>
</span><a name="line-419"></a><span class="hs-comment">-- depending on whether we have to use a @case@ or @let@</span><span>
</span><a name="line-420"></a><span class="hs-comment">-- binding for the expression (see 'needsCaseBinding').</span><span>
</span><a name="line-421"></a><span class="hs-comment">-- It's used by the desugarer to avoid building bindings</span><span>
</span><a name="line-422"></a><span class="hs-comment">-- that give Core Lint a heart attack, although actually</span><span>
</span><a name="line-423"></a><span class="hs-comment">-- the simplifier deals with them perfectly well. See</span><span>
</span><a name="line-424"></a><span class="hs-comment">-- also 'MkCore.mkCoreLet'</span><span>
</span><a name="line-425"></a><a name="bindNonRec"><a href="CoreUtils.html#bindNonRec"><span class="hs-identifier">bindNonRec</span></a></a><span> </span><a name="local-1627735253"><a href="#local-1627735253"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-1627735254"><a href="#local-1627735254"><span class="hs-identifier">rhs</span></a></a><span> </span><a name="local-1627735255"><a href="#local-1627735255"><span class="hs-identifier">body</span></a></a><span>
</span><a name="line-426"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="CoreUtils.html#needsCaseBinding"><span class="hs-identifier hs-var">needsCaseBinding</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idType"><span class="hs-identifier hs-var">idType</span></a><span> </span><a href="#local-1627735253"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735254"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Case"><span class="hs-identifier hs-var">Case</span></a><span> </span><a href="#local-1627735254"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-1627735253"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-special">(</span><a href="CoreUtils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a><span> </span><a href="#local-1627735255"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CoreSyn.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-1627735255"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-427"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>                          </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a href="#local-1627735253"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-1627735254"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735255"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-428"></a><span>
</span><a name="line-429"></a><span class="hs-comment">-- | Tests whether we have to use a @case@ rather than @let@ binding for this expression</span><span>
</span><a name="line-430"></a><span class="hs-comment">-- as per the invariants of 'CoreExpr': see &quot;CoreSyn#let_app_invariant&quot;</span><span>
</span><a name="line-431"></a><span class="hs-identifier">needsCaseBinding</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-432"></a><a name="needsCaseBinding"><a href="CoreUtils.html#needsCaseBinding"><span class="hs-identifier">needsCaseBinding</span></a></a><span> </span><a name="local-1627735256"><a href="#local-1627735256"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-1627735257"><a href="#local-1627735257"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#isUnliftedType"><span class="hs-identifier hs-var">isUnliftedType</span></a><span> </span><a href="#local-1627735256"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CoreUtils.html#exprOkForSpeculation"><span class="hs-identifier hs-var">exprOkForSpeculation</span></a><span> </span><a href="#local-1627735257"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-433"></a><span>        </span><span class="hs-comment">-- Make a case expression instead of a let</span><span>
</span><a name="line-434"></a><span>        </span><span class="hs-comment">-- These can arise either from the desugarer,</span><span>
</span><a name="line-435"></a><span>        </span><span class="hs-comment">-- or from beta reductions: (\x.e) (x +# y)</span><span>
</span><a name="line-436"></a><span>
</span><a name="line-437"></a><span class="hs-identifier">mkAltExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a><span>     </span><span class="hs-comment">-- ^ Case alternative constructor</span><span>
</span><a name="line-438"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span class="hs-special">]</span><span> </span><span class="hs-comment">-- ^ Things bound by the pattern match</span><span>
</span><a name="line-439"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>     </span><span class="hs-comment">-- ^ The type arguments to the case alternative</span><span>
</span><a name="line-440"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-441"></a><span class="hs-comment">-- ^ This guy constructs the value that the scrutinee must have</span><span>
</span><a name="line-442"></a><span class="hs-comment">-- given that you are in one particular branch of a case</span><span>
</span><a name="line-443"></a><a name="mkAltExpr"><a href="CoreUtils.html#mkAltExpr"><span class="hs-identifier">mkAltExpr</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#DataAlt"><span class="hs-identifier hs-var">DataAlt</span></a><span> </span><a name="local-1627735258"><a href="#local-1627735258"><span class="hs-identifier">con</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627735259"><a href="#local-1627735259"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-1627735260"><a href="#local-1627735260"><span class="hs-identifier">inst_tys</span></a></a><span>
</span><a name="line-444"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#mkConApp"><span class="hs-identifier hs-var">mkConApp</span></a><span> </span><a href="#local-1627735258"><span class="hs-identifier hs-var">con</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a href="#local-1627735260"><span class="hs-identifier hs-var">inst_tys</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="CoreSyn.html#varsToCoreExprs"><span class="hs-identifier hs-var">varsToCoreExprs</span></a><span> </span><a href="#local-1627735259"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-445"></a><span class="hs-identifier">mkAltExpr</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#LitAlt"><span class="hs-identifier hs-var">LitAlt</span></a><span> </span><a name="local-1627735261"><a href="#local-1627735261"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-446"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><a href="#local-1627735261"><span class="hs-identifier hs-var">lit</span></a><span>
</span><a name="line-447"></a><span class="hs-identifier">mkAltExpr</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#LitAlt"><span class="hs-identifier hs-var">LitAlt</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Panic.html#panic"><span class="hs-identifier hs-var">panic</span></a><span> </span><span class="hs-string">&quot;mkAltExpr LitAlt&quot;</span><span>
</span><a name="line-448"></a><span class="hs-identifier">mkAltExpr</span><span> </span><a href="CoreSyn.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Panic.html#panic"><span class="hs-identifier hs-var">panic</span></a><span> </span><span class="hs-string">&quot;mkAltExpr DEFAULT&quot;</span><span>
</span><a name="line-449"></a><span>
</span><a name="line-450"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
               Operations oer case alternatives
*                                                                      *
************************************************************************

The default alternative must be first, if it exists at all.
This makes it easy to find, though it makes matching marginally harder.
-}</span><span>
</span><a name="line-460"></a><span>
</span><a name="line-461"></a><span class="hs-comment">-- | Extract the default case alternative</span><span>
</span><a name="line-462"></a><span class="hs-identifier">findDefault</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CoreSyn.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="#local-1627735067"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-1627735068"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CoreSyn.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="#local-1627735067"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-1627735068"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="#local-1627735068"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-463"></a><a name="findDefault"><a href="CoreUtils.html#findDefault"><span class="hs-identifier">findDefault</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="CoreSyn.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a><span class="hs-special">,</span><a name="local-1627735262"><a href="#local-1627735262"><span class="hs-identifier">args</span></a></a><span class="hs-special">,</span><a name="local-1627735263"><a href="#local-1627735263"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-1627735264"><a href="#local-1627735264"><span class="hs-identifier">alts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">null</span></a><span> </span><span class="hs-identifier">args</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">alts</span><span class="hs-special">,</span><span> </span><a href="#local-1627735262"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-identifier">rhs</span><span class="hs-special">)</span><span>
</span><a name="line-464"></a><span class="hs-identifier">findDefault</span><span> </span><a name="local-1627735265"><a href="#local-1627735265"><span class="hs-identifier">alts</span></a></a><span>                        </span><span class="hs-glyph">=</span><span>                     </span><span class="hs-special">(</span><a href="#local-1627735265"><span class="hs-identifier hs-var">alts</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">)</span><span>
</span><a name="line-465"></a><span>
</span><a name="line-466"></a><span class="hs-identifier">addDefault</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CoreSyn.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="#local-1627735065"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-1627735066"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="#local-1627735066"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CoreSyn.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="#local-1627735065"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-1627735066"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-467"></a><a name="addDefault"><a href="CoreUtils.html#addDefault"><span class="hs-identifier">addDefault</span></a></a><span> </span><a name="local-1627735266"><a href="#local-1627735266"><span class="hs-identifier">alts</span></a></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735266"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-468"></a><span class="hs-identifier">addDefault</span><span> </span><a name="local-1627735267"><a href="#local-1627735267"><span class="hs-identifier">alts</span></a></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1627735268"><a href="#local-1627735268"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-1627735268"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-1627735267"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-469"></a><span>
</span><a name="line-470"></a><span class="hs-identifier">isDefaultAlt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627735063"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627735064"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-471"></a><a name="isDefaultAlt"><a href="CoreUtils.html#isDefaultAlt"><span class="hs-identifier">isDefaultAlt</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-472"></a><span class="hs-identifier">isDefaultAlt</span><span> </span><span class="hs-identifier">_</span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-473"></a><span>
</span><a name="line-474"></a><span class="hs-comment">-- | Find the case alternative corresponding to a particular</span><span>
</span><a name="line-475"></a><span class="hs-comment">-- constructor: panics if no such constructor exists</span><span>
</span><a name="line-476"></a><span class="hs-identifier">findAlt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CoreSyn.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627735061"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627735062"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627735061"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627735062"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-477"></a><span>    </span><span class="hs-comment">-- A &quot;Nothing&quot; result *is* legitmiate</span><span>
</span><a name="line-478"></a><span>    </span><span class="hs-comment">-- See Note [Unreachable code]</span><span>
</span><a name="line-479"></a><a name="findAlt"><a href="CoreUtils.html#findAlt"><span class="hs-identifier">findAlt</span></a></a><span> </span><a name="local-1627735269"><a href="#local-1627735269"><span class="hs-identifier">con</span></a></a><span> </span><a name="local-1627735270"><a href="#local-1627735270"><span class="hs-identifier">alts</span></a></a><span>
</span><a name="line-480"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1627735270"><span class="hs-identifier hs-var">alts</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-481"></a><span>        </span><span class="hs-special">(</span><a name="local-1627735277"><a href="#local-1627735277"><span class="hs-identifier">deflt</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSyn.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-glyph">:</span><a name="local-1627735278"><a href="#local-1627735278"><span class="hs-identifier">alts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627735271"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735278"><span class="hs-identifier hs-var">alts</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-1627735277"><span class="hs-identifier hs-var">deflt</span></a><span class="hs-special">)</span><span>
</span><a name="line-482"></a><span>        </span><span class="hs-identifier">_</span><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627735271"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735270"><span class="hs-identifier hs-var">alts</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-483"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-484"></a><span>    </span><a name="local-1627735271"><a href="#local-1627735271"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>                     </span><a name="local-1627735272"><a href="#local-1627735272"><span class="hs-identifier">deflt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735272"><span class="hs-identifier hs-var">deflt</span></a><span>
</span><a name="line-485"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a name="local-1627735273"><a href="#local-1627735273"><span class="hs-identifier">alt</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-1627735274"><a href="#local-1627735274"><span class="hs-identifier">con1</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-1627735275"><a href="#local-1627735275"><span class="hs-identifier">alts</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627735276"><a href="#local-1627735276"><span class="hs-identifier">deflt</span></a></a><span>
</span><a name="line-486"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1627735269"><span class="hs-identifier hs-var">con</span></a><span> </span><span class="hs-special">`</span><a href="CoreSyn.html#cmpAltCon"><span class="hs-identifier hs-var">cmpAltCon</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627735274"><span class="hs-identifier hs-var">con1</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-487"></a><span>          </span><span class="hs-identifier hs-var">LT</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627735276"><span class="hs-identifier hs-var">deflt</span></a><span>   </span><span class="hs-comment">-- Missed it already; the alts are in increasing order</span><span>
</span><a name="line-488"></a><span>          </span><span class="hs-identifier hs-var">EQ</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-1627735273"><span class="hs-identifier hs-var">alt</span></a><span>
</span><a name="line-489"></a><span>          </span><span class="hs-identifier hs-var">GT</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">not</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">con1</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">DEFAULT</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">go</span><span> </span><a href="CoreSyn.html#DEFAULT"><span class="hs-identifier hs-var">alts</span></a><span> </span><span class="hs-identifier">deflt</span><span>
</span><a name="line-490"></a><span>
</span><a name="line-491"></a><span class="hs-comment">{- Note [Unreachable code]
~~~~~~~~~~~~~~~~~~~~~~~~~~
It is possible (although unusual) for GHC to find a case expression
that cannot match.  For example:

     data Col = Red | Green | Blue
     x = Red
     f v = case x of
              Red -&gt; ...
              _ -&gt; ...(case x of { Green -&gt; e1; Blue -&gt; e2 })...

Suppose that for some silly reason, x isn't substituted in the case
expression.  (Perhaps there's a NOINLINE on it, or profiling SCC stuff
gets in the way; cf Trac #3118.)  Then the full-lazines pass might produce
this

     x = Red
     lvl = case x of { Green -&gt; e1; Blue -&gt; e2 })
     f v = case x of
             Red -&gt; ...
             _ -&gt; ...lvl...

Now if x gets inlined, we won't be able to find a matching alternative
for 'Red'.  That's because 'lvl' is unreachable.  So rather than crashing
we generate (error &quot;Inaccessible alternative&quot;).

Similar things can happen (augmented by GADTs) when the Simplifier
filters down the matching alternatives in Simplify.rebuildCase.
-}</span><span>
</span><a name="line-520"></a><span>
</span><a name="line-521"></a><span class="hs-comment">---------------------------------</span><span>
</span><a name="line-522"></a><span class="hs-identifier">mergeAlts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CoreSyn.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627735059"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627735060"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CoreSyn.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627735059"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627735060"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CoreSyn.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627735059"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627735060"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-523"></a><span class="hs-comment">-- ^ Merge alternatives preserving order; alternatives in</span><span>
</span><a name="line-524"></a><span class="hs-comment">-- the first argument shadow ones in the second</span><span>
</span><a name="line-525"></a><a name="mergeAlts"><a href="CoreUtils.html#mergeAlts"><span class="hs-identifier">mergeAlts</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-1627735279"><a href="#local-1627735279"><span class="hs-identifier">as2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735279"><span class="hs-identifier hs-var">as2</span></a><span>
</span><a name="line-526"></a><span class="hs-identifier">mergeAlts</span><span> </span><a name="local-1627735280"><a href="#local-1627735280"><span class="hs-identifier">as1</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735280"><span class="hs-identifier hs-var">as1</span></a><span>
</span><a name="line-527"></a><span class="hs-identifier">mergeAlts</span><span> </span><span class="hs-special">(</span><a name="local-1627735281"><a href="#local-1627735281"><span class="hs-identifier">a1</span></a></a><span class="hs-glyph">:</span><a name="local-1627735282"><a href="#local-1627735282"><span class="hs-identifier">as1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-1627735283"><a href="#local-1627735283"><span class="hs-identifier">a2</span></a></a><span class="hs-glyph">:</span><a name="local-1627735284"><a href="#local-1627735284"><span class="hs-identifier">as2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-528"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1627735281"><span class="hs-identifier hs-var">a1</span></a><span> </span><span class="hs-special">`</span><a href="CoreSyn.html#cmpAlt"><span class="hs-identifier hs-var">cmpAlt</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627735283"><span class="hs-identifier hs-var">a2</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-529"></a><span>        </span><span class="hs-identifier hs-var">LT</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627735281"><span class="hs-identifier hs-var">a1</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="CoreUtils.html#mergeAlts"><span class="hs-identifier hs-var">mergeAlts</span></a><span> </span><a href="#local-1627735282"><span class="hs-identifier hs-var">as1</span></a><span>      </span><span class="hs-special">(</span><a href="#local-1627735283"><span class="hs-identifier hs-var">a2</span></a><span class="hs-glyph">:</span><a href="#local-1627735284"><span class="hs-identifier hs-var">as2</span></a><span class="hs-special">)</span><span>
</span><a name="line-530"></a><span>        </span><span class="hs-identifier hs-var">EQ</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627735281"><span class="hs-identifier hs-var">a1</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="CoreUtils.html#mergeAlts"><span class="hs-identifier hs-var">mergeAlts</span></a><span> </span><a href="#local-1627735282"><span class="hs-identifier hs-var">as1</span></a><span>      </span><a href="#local-1627735284"><span class="hs-identifier hs-var">as2</span></a><span>       </span><span class="hs-comment">-- Discard a2</span><span>
</span><a name="line-531"></a><span>        </span><span class="hs-identifier hs-var">GT</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627735283"><span class="hs-identifier hs-var">a2</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="CoreUtils.html#mergeAlts"><span class="hs-identifier hs-var">mergeAlts</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627735281"><span class="hs-identifier hs-var">a1</span></a><span class="hs-glyph">:</span><a href="#local-1627735282"><span class="hs-identifier hs-var">as1</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735284"><span class="hs-identifier hs-var">as2</span></a><span>
</span><a name="line-532"></a><span>
</span><a name="line-533"></a><span>
</span><a name="line-534"></a><span class="hs-comment">---------------------------------</span><span>
</span><a name="line-535"></a><span class="hs-identifier">trimConArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a><span class="hs-special">]</span><span>
</span><a name="line-536"></a><span class="hs-comment">-- ^ Given:</span><span>
</span><a name="line-537"></a><span class="hs-comment">--</span><span>
</span><a name="line-538"></a><span class="hs-comment">-- &gt; case (C a b x y) of</span><span>
</span><a name="line-539"></a><span class="hs-comment">-- &gt;        C b x y -&gt; ...</span><span>
</span><a name="line-540"></a><span class="hs-comment">--</span><span>
</span><a name="line-541"></a><span class="hs-comment">-- We want to drop the leading type argument of the scrutinee</span><span>
</span><a name="line-542"></a><span class="hs-comment">-- leaving the arguments to match against the pattern</span><span>
</span><a name="line-543"></a><span>
</span><a name="line-544"></a><a name="trimConArgs"><a href="CoreUtils.html#trimConArgs"><span class="hs-identifier">trimConArgs</span></a></a><span> </span><a href="CoreSyn.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a><span>      </span><a name="local-1627735285"><a href="#local-1627735285"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">null</span></a><span> </span><span class="hs-identifier">args</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-545"></a><span class="hs-identifier">trimConArgs</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#LitAlt"><span class="hs-identifier hs-var">LitAlt</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>   </span><a name="local-1627735286"><a href="#local-1627735286"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">null</span></a><span> </span><span class="hs-identifier">args</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-546"></a><span class="hs-identifier">trimConArgs</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#DataAlt"><span class="hs-identifier hs-var">DataAlt</span></a><span> </span><a name="local-1627735287"><a href="#local-1627735287"><span class="hs-identifier">dc</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627735288"><a href="#local-1627735288"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#dropList"><span class="hs-identifier hs-var">dropList</span></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#dataConUnivTyVars"><span class="hs-identifier hs-var">dataConUnivTyVars</span></a><span> </span><a href="#local-1627735287"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735288"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-547"></a><span>
</span><a name="line-548"></a><span class="hs-identifier">filterAlts</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span>                </span><span class="hs-comment">-- ^ Type constructor of scrutinee's type (used to prune possibilities)</span><span>
</span><a name="line-549"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>               </span><span class="hs-comment">-- ^ And its type arguments</span><span>
</span><a name="line-550"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a><span class="hs-special">]</span><span>             </span><span class="hs-comment">-- ^ 'imposs_cons': constructors known to be impossible due to the form of the scrutinee</span><span>
</span><a name="line-551"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CoreSyn.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-1627735058"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- ^ Alternatives</span><span>
</span><a name="line-552"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="CoreSyn.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CoreSyn.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-1627735058"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-553"></a><span>             </span><span class="hs-comment">-- Returns:</span><span>
</span><a name="line-554"></a><span>             </span><span class="hs-comment">--  1. Constructors that will never be encountered by the</span><span>
</span><a name="line-555"></a><span>             </span><span class="hs-comment">--     *default* case (if any).  A superset of imposs_cons</span><span>
</span><a name="line-556"></a><span>             </span><span class="hs-comment">--  2. The new alternatives, trimmed by</span><span>
</span><a name="line-557"></a><span>             </span><span class="hs-comment">--        a) remove imposs_cons</span><span>
</span><a name="line-558"></a><span>             </span><span class="hs-comment">--        b) remove constructors which can't match because of GADTs</span><span>
</span><a name="line-559"></a><span>             </span><span class="hs-comment">--      and with the DEFAULT expanded to a DataAlt if there is exactly</span><span>
</span><a name="line-560"></a><span>             </span><span class="hs-comment">--      remaining constructor that can match</span><span>
</span><a name="line-561"></a><span>             </span><span class="hs-comment">--</span><span>
</span><a name="line-562"></a><span>             </span><span class="hs-comment">-- NB: the final list of alternatives may be empty:</span><span>
</span><a name="line-563"></a><span>             </span><span class="hs-comment">-- This is a tricky corner case.  If the data type has no constructors,</span><span>
</span><a name="line-564"></a><span>             </span><span class="hs-comment">-- which GHC allows, or if the imposs_cons covers all constructors (after taking</span><span>
</span><a name="line-565"></a><span>             </span><span class="hs-comment">-- account of GADTs), then no alternatives can match.</span><span>
</span><a name="line-566"></a><span>             </span><span class="hs-comment">--</span><span>
</span><a name="line-567"></a><span>             </span><span class="hs-comment">-- If callers need to preserve the invariant that there is always at least one branch</span><span>
</span><a name="line-568"></a><span>             </span><span class="hs-comment">-- in a &quot;case&quot; statement then they will need to manually add a dummy case branch that just</span><span>
</span><a name="line-569"></a><span>             </span><span class="hs-comment">-- calls &quot;error&quot; or similar.</span><span>
</span><a name="line-570"></a><a name="filterAlts"><a href="CoreUtils.html#filterAlts"><span class="hs-identifier">filterAlts</span></a></a><span> </span><a name="local-1627735289"><a href="#local-1627735289"><span class="hs-identifier">_tycon</span></a></a><span> </span><a name="local-1627735290"><a href="#local-1627735290"><span class="hs-identifier">inst_tys</span></a></a><span> </span><a name="local-1627735291"><a href="#local-1627735291"><span class="hs-identifier">imposs_cons</span></a></a><span> </span><a name="local-1627735292"><a href="#local-1627735292"><span class="hs-identifier">alts</span></a></a><span>
</span><a name="line-571"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-1627735297"><span class="hs-identifier hs-var">imposs_deflt_cons</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#addDefault"><span class="hs-identifier hs-var">addDefault</span></a><span> </span><a href="#local-1627735296"><span class="hs-identifier hs-var">trimmed_alts</span></a><span> </span><a href="#local-1627735294"><span class="hs-identifier hs-var">maybe_deflt</span></a><span class="hs-special">)</span><span>
</span><a name="line-572"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-573"></a><span>    </span><span class="hs-special">(</span><a name="local-1627735293"><a href="#local-1627735293"><span class="hs-identifier">alts_wo_default</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627735294"><a href="#local-1627735294"><span class="hs-identifier">maybe_deflt</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#findDefault"><span class="hs-identifier hs-var">findDefault</span></a><span> </span><a href="#local-1627735292"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-574"></a><span>    </span><a name="local-1627735295"><a href="#local-1627735295"><span class="hs-identifier">alt_cons</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-1627735301"><span class="hs-identifier hs-var">con</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-1627735301"><a href="#local-1627735301"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627735293"><span class="hs-identifier hs-var">alts_wo_default</span></a><span class="hs-special">]</span><span>
</span><a name="line-575"></a><span>
</span><a name="line-576"></a><span>    </span><a name="local-1627735296"><a href="#local-1627735296"><span class="hs-identifier">trimmed_alts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#filterOut"><span class="hs-identifier hs-var">filterOut</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627735298"><span class="hs-identifier hs-var">impossible_alt</span></a><span> </span><a href="#local-1627735290"><span class="hs-identifier hs-var">inst_tys</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735293"><span class="hs-identifier hs-var">alts_wo_default</span></a><span>
</span><a name="line-577"></a><span>
</span><a name="line-578"></a><span>    </span><a name="local-1627735297"><a href="#local-1627735297"><span class="hs-identifier">imposs_deflt_cons</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.OldList.html#nub"><span class="hs-identifier hs-var">nub</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627735291"><span class="hs-identifier hs-var">imposs_cons</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-1627735295"><span class="hs-identifier hs-var">alt_cons</span></a><span class="hs-special">)</span><span>
</span><a name="line-579"></a><span>         </span><span class="hs-comment">-- &quot;imposs_deflt_cons&quot; are handled</span><span>
</span><a name="line-580"></a><span>         </span><span class="hs-comment">--   EITHER by the context,</span><span>
</span><a name="line-581"></a><span>         </span><span class="hs-comment">--   OR by a non-DEFAULT branch in this case expression.</span><span>
</span><a name="line-582"></a><span>
</span><a name="line-583"></a><span>    </span><span class="hs-identifier">impossible_alt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627735299"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627735300"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-584"></a><span>    </span><a name="local-1627735298"><a href="#local-1627735298"><span class="hs-identifier">impossible_alt</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a name="local-1627735302"><a href="#local-1627735302"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627735302"><span class="hs-identifier hs-var">con</span></a><span> </span><span class="hs-special">`</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#elem"><span class="hs-identifier hs-var">elem</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627735291"><span class="hs-identifier hs-var">imposs_cons</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-585"></a><span>    </span><span class="hs-identifier">impossible_alt</span><span> </span><a name="local-1627735303"><a href="#local-1627735303"><span class="hs-identifier">inst_tys</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#DataAlt"><span class="hs-identifier hs-var">DataAlt</span></a><span> </span><a name="local-1627735304"><a href="#local-1627735304"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DataCon.html#dataConCannotMatch"><span class="hs-identifier hs-var">dataConCannotMatch</span></a><span> </span><a href="#local-1627735303"><span class="hs-identifier hs-var">inst_tys</span></a><span> </span><a href="#local-1627735304"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-586"></a><span>    </span><span class="hs-identifier">impossible_alt</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-identifier">_</span><span>                         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-587"></a><span>
</span><a name="line-588"></a><span class="hs-identifier">refineDefaultAlt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>
</span><a name="line-589"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- Constructors tha cannot match the DEFAULT (if any)</span><span>
</span><a name="line-590"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreAlt"><span class="hs-identifier hs-type">CoreAlt</span></a><span class="hs-special">]</span><span>
</span><a name="line-591"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreAlt"><span class="hs-identifier hs-type">CoreAlt</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-592"></a><span class="hs-comment">-- Refine the default alterantive to a DataAlt,</span><span>
</span><a name="line-593"></a><span class="hs-comment">-- if there is a unique way to do so</span><span>
</span><a name="line-594"></a><a name="refineDefaultAlt"><a href="CoreUtils.html#refineDefaultAlt"><span class="hs-identifier">refineDefaultAlt</span></a></a><span> </span><a name="local-1627735305"><a href="#local-1627735305"><span class="hs-identifier">us</span></a></a><span> </span><a name="local-1627735306"><a href="#local-1627735306"><span class="hs-identifier">tycon</span></a></a><span> </span><a name="local-1627735307"><a href="#local-1627735307"><span class="hs-identifier">tys</span></a></a><span> </span><a name="local-1627735308"><a href="#local-1627735308"><span class="hs-identifier">imposs_deflt_cons</span></a></a><span> </span><a name="local-1627735309"><a href="#local-1627735309"><span class="hs-identifier">all_alts</span></a></a><span>
</span><a name="line-595"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-1627735310"><a href="#local-1627735310"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-1627735311"><a href="#local-1627735311"><span class="hs-identifier">rest_alts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627735309"><span class="hs-identifier hs-var">all_alts</span></a><span>
</span><a name="line-596"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="TyCon.html#isAlgTyCon"><span class="hs-identifier hs-var">isAlgTyCon</span></a><span> </span><a href="#local-1627735306"><span class="hs-identifier hs-var">tycon</span></a><span>            </span><span class="hs-comment">-- It's a data type, tuple, or unboxed tuples.</span><span>
</span><a name="line-597"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="TyCon.html#isNewTyCon"><span class="hs-identifier hs-var">isNewTyCon</span></a><span> </span><a href="#local-1627735306"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span>      </span><span class="hs-comment">-- We can have a newtype, if we are just doing an eval:</span><span>
</span><a name="line-598"></a><span>                                </span><span class="hs-comment">--      case x of { DEFAULT -&gt; e }</span><span>
</span><a name="line-599"></a><span>                                </span><span class="hs-comment">-- and we don't want to fill in a default for them!</span><span>
</span><a name="line-600"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1627735312"><a href="#local-1627735312"><span class="hs-identifier">all_cons</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TyCon.html#tyConDataCons_maybe"><span class="hs-identifier hs-var">tyConDataCons_maybe</span></a><span> </span><a href="#local-1627735306"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-601"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1627735313"><a href="#local-1627735313"><span class="hs-identifier">imposs_data_cons</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-1627735315"><span class="hs-identifier hs-var">con</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#DataAlt"><span class="hs-identifier hs-var">DataAlt</span></a><span> </span><a name="local-1627735315"><a href="#local-1627735315"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627735308"><span class="hs-identifier hs-var">imposs_deflt_cons</span></a><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- We now know it's a data type</span><span>
</span><a name="line-602"></a><span>        </span><a name="local-1627735314"><a href="#local-1627735314"><span class="hs-identifier">impossible</span></a></a><span> </span><a name="local-1627735316"><a href="#local-1627735316"><span class="hs-identifier">con</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735316"><span class="hs-identifier hs-var">con</span></a><span> </span><span class="hs-special">`</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#elem"><span class="hs-identifier hs-var">elem</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627735313"><span class="hs-identifier hs-var">imposs_data_cons</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="DataCon.html#dataConCannotMatch"><span class="hs-identifier hs-var">dataConCannotMatch</span></a><span> </span><a href="#local-1627735307"><span class="hs-identifier hs-var">tys</span></a><span> </span><a href="#local-1627735316"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-603"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Util.html#filterOut"><span class="hs-identifier hs-var">filterOut</span></a><span> </span><a href="#local-1627735314"><span class="hs-identifier hs-var">impossible</span></a><span> </span><a href="#local-1627735312"><span class="hs-identifier hs-var">all_cons</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-604"></a><span>       </span><span class="hs-comment">-- Eliminate the default alternative</span><span>
</span><a name="line-605"></a><span>       </span><span class="hs-comment">-- altogether if it can't match:</span><span>
</span><a name="line-606"></a><span>       </span><span class="hs-special">[</span><span class="hs-special">]</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><a href="#local-1627735311"><span class="hs-identifier hs-var">rest_alts</span></a><span class="hs-special">)</span><span>
</span><a name="line-607"></a><span>
</span><a name="line-608"></a><span>       </span><span class="hs-comment">-- It matches exactly one constructor, so fill it in:</span><span>
</span><a name="line-609"></a><span>       </span><span class="hs-special">[</span><a name="local-1627735317"><a href="#local-1627735317"><span class="hs-identifier">con</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#mergeAlts"><span class="hs-identifier hs-var">mergeAlts</span></a><span> </span><a href="#local-1627735311"><span class="hs-identifier hs-var">rest_alts</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CoreSyn.html#DataAlt"><span class="hs-identifier hs-var">DataAlt</span></a><span> </span><a href="#local-1627735317"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627735318"><span class="hs-identifier hs-var">ex_tvs</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-1627735319"><span class="hs-identifier hs-var">arg_ids</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627735310"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-610"></a><span>                       </span><span class="hs-comment">-- We need the mergeAlts to keep the alternatives in the right order</span><span>
</span><a name="line-611"></a><span>             </span><span class="hs-keyword">where</span><span>
</span><a name="line-612"></a><span>                </span><span class="hs-special">(</span><a name="local-1627735318"><a href="#local-1627735318"><span class="hs-identifier">ex_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627735319"><a href="#local-1627735319"><span class="hs-identifier">arg_ids</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#dataConRepInstPat"><span class="hs-identifier hs-var">dataConRepInstPat</span></a><span> </span><a href="#local-1627735305"><span class="hs-identifier hs-var">us</span></a><span> </span><a href="#local-1627735317"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-1627735307"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-613"></a><span>
</span><a name="line-614"></a><span>       </span><span class="hs-comment">-- It matches more than one, so do nothing</span><span>
</span><a name="line-615"></a><span>       </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><a href="#local-1627735309"><span class="hs-identifier hs-var">all_alts</span></a><span class="hs-special">)</span><span>
</span><a name="line-616"></a><span>
</span><a name="line-617"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">debugIsOn</span></a><span class="hs-special">,</span><span> </span><a href="TyCon.html#isAlgTyCon"><span class="hs-identifier hs-var">isAlgTyCon</span></a><span> </span><a href="#local-1627735306"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><span class="hs-special">(</span><a href="TyCon.html#tyConDataCons"><span class="hs-identifier hs-var">tyConDataCons</span></a><span> </span><a href="#local-1627735306"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span>
</span><a name="line-618"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="TyCon.html#isFamilyTyCon"><span class="hs-identifier hs-var">isFamilyTyCon</span></a><span> </span><a href="#local-1627735306"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="TyCon.html#isAbstractTyCon"><span class="hs-identifier hs-var">isAbstractTyCon</span></a><span> </span><a href="#local-1627735306"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span>
</span><a name="line-619"></a><span>        </span><span class="hs-comment">-- Check for no data constructors</span><span>
</span><a name="line-620"></a><span>        </span><span class="hs-comment">-- This can legitimately happen for abstract types and type families,</span><span>
</span><a name="line-621"></a><span>        </span><span class="hs-comment">-- so don't report that</span><span>
</span><a name="line-622"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><a href="#local-1627735309"><span class="hs-identifier hs-var">all_alts</span></a><span class="hs-special">)</span><span>
</span><a name="line-623"></a><span>
</span><a name="line-624"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>      </span><span class="hs-comment">-- The common case</span><span>
</span><a name="line-625"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><a href="#local-1627735309"><span class="hs-identifier hs-var">all_alts</span></a><span class="hs-special">)</span><span>
</span><a name="line-626"></a><span>
</span><a name="line-627"></a><span class="hs-comment">{- Note [Combine identical alternatives]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If several alternatives are identical, merge them into a single
DEFAULT alternative.  I've occasionally seen this making a big
difference:

     case e of               =====&gt;     case e of
       C _ -&gt; f x                         D v -&gt; ....v....
       D v -&gt; ....v....                   DEFAULT -&gt; f x
       DEFAULT -&gt; f x

The point is that we merge common RHSs, at least for the DEFAULT case.
[One could do something more elaborate but I've never seen it needed.]
To avoid an expensive test, we just merge branches equal to the *first*
alternative; this picks up the common cases
     a) all branches equal
     b) some branches equal to the DEFAULT (which occurs first)

The case where Combine Identical Alternatives transformation showed up
was like this (base/Foreign/C/Err/Error.hs):

        x | p `is` 1 -&gt; e1
          | p `is` 2 -&gt; e2
        ...etc...

where @is@ was something like

        p `is` n = p /= (-1) &amp;&amp; p == n

This gave rise to a horrible sequence of cases

        case p of
          (-1) -&gt; $j p
          1    -&gt; e1
          DEFAULT -&gt; $j p

and similarly in cascade for all the join points!

NB: it's important that all this is done in [InAlt], *before* we work
on the alternatives themselves, because Simpify.simplAlt may zap the
occurrence info on the binders in the alternatives, which in turn
defeats combineIdenticalAlts (see Trac #7360).

Note [Care with impossible-constructors when combining alternatives]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have (Trac #10538)
   data T = A | B | C | D

      case x::T of   (Imposs-default-cons {A,B})
         DEFAULT -&gt; e1
         A -&gt; e2
         B -&gt; e1

When calling combineIdentialAlts, we'll have computed that the
&quot;impossible constructors&quot; for the DEFAULT alt is {A,B}, since if x is
A or B we'll take the other alternatives.  But suppose we combine B
into the DEFAULT, to get

      case x::T of   (Imposs-default-cons {A})
         DEFAULT -&gt; e1
         A -&gt; e2

Then we must be careful to trim the impossible constructors to just {A},
else we risk compiling 'e1' wrong!

Not only that, but we take care when there is no DEFAULT beforehand,
because we are introducing one.  Consider

   case x of   (Imposs-default-cons {A,B,C})
     A -&gt; e1
     B -&gt; e2
     C -&gt; e1

Then when combining the A and C alternatives we get

   case x of   (Imposs-default-cons {B})
     DEFAULT -&gt; e1
     B -&gt; e2

Note that we have a new DEFAULT branch that we didn't have before.  So
we need delete from the &quot;impossible-default-constructors&quot; all the
known-con alternatives that we have eliminated. (In Trac #11172 we
missed the first one.)

-}</span><span>
</span><a name="line-712"></a><span>
</span><a name="line-713"></a><span class="hs-identifier">combineIdenticalAlts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- Constructors that cannot match DEFAULT</span><span>
</span><a name="line-714"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreAlt"><span class="hs-identifier hs-type">CoreAlt</span></a><span class="hs-special">]</span><span>
</span><a name="line-715"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span>      </span><span class="hs-comment">-- True &lt;=&gt; something happened</span><span>
</span><a name="line-716"></a><span>                         </span><span class="hs-special">[</span><a href="CoreSyn.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- New contructors that cannot match DEFAULT</span><span>
</span><a name="line-717"></a><span>                         </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreAlt"><span class="hs-identifier hs-type">CoreAlt</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- New alternatives</span><span>
</span><a name="line-718"></a><span class="hs-comment">-- See Note [Combine identical alternatives]</span><span>
</span><a name="line-719"></a><span class="hs-comment">-- True &lt;=&gt; we did some combining, result is a single DEFAULT alternative</span><span>
</span><a name="line-720"></a><a name="combineIdenticalAlts"><a href="CoreUtils.html#combineIdenticalAlts"><span class="hs-identifier">combineIdenticalAlts</span></a></a><span> </span><a name="local-1627735320"><a href="#local-1627735320"><span class="hs-identifier">imposs_deflt_cons</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-1627735321"><a href="#local-1627735321"><span class="hs-identifier">con1</span></a></a><span class="hs-special">,</span><a name="local-1627735322"><a href="#local-1627735322"><span class="hs-identifier">bndrs1</span></a></a><span class="hs-special">,</span><a name="local-1627735323"><a href="#local-1627735323"><span class="hs-identifier">rhs1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-1627735324"><a href="#local-1627735324"><span class="hs-identifier">rest_alts</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-721"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a><span> </span><a href="Id.html#isDeadBinder"><span class="hs-identifier hs-var">isDeadBinder</span></a><span> </span><a href="#local-1627735322"><span class="hs-identifier hs-var">bndrs1</span></a><span>    </span><span class="hs-comment">-- Remember the default</span><span>
</span><a name="line-722"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1627735325"><span class="hs-identifier hs-var">elim_rest</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- alternative comes first</span><span>
</span><a name="line-723"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><a href="#local-1627735328"><span class="hs-identifier hs-var">imposs_deflt_cons'</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627735327"><span class="hs-identifier hs-var">deflt_alt</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-1627735326"><span class="hs-identifier hs-var">filtered_rest</span></a><span class="hs-special">)</span><span>
</span><a name="line-724"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-725"></a><span>    </span><span class="hs-special">(</span><a name="local-1627735325"><a href="#local-1627735325"><span class="hs-identifier">elim_rest</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627735326"><a href="#local-1627735326"><span class="hs-identifier">filtered_rest</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.OldList.html#partition"><span class="hs-identifier hs-var">partition</span></a><span> </span><a href="#local-1627735332"><span class="hs-identifier hs-var">identical_to_alt1</span></a><span> </span><a href="#local-1627735324"><span class="hs-identifier hs-var">rest_alts</span></a><span>
</span><a name="line-726"></a><span>    </span><a name="local-1627735327"><a href="#local-1627735327"><span class="hs-identifier">deflt_alt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#mkTicks"><span class="hs-identifier hs-var">mkTicks</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#concat"><span class="hs-identifier hs-var">concat</span></a><span> </span><a href="#local-1627735333"><span class="hs-identifier hs-var">tickss</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735323"><span class="hs-identifier hs-var">rhs1</span></a><span class="hs-special">)</span><span>
</span><a name="line-727"></a><span>
</span><a name="line-728"></a><span>     </span><span class="hs-comment">-- See Note [Care with impossible-constructors when combining alternatives]</span><span>
</span><a name="line-729"></a><span>    </span><a name="local-1627735328"><a href="#local-1627735328"><span class="hs-identifier">imposs_deflt_cons'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735320"><span class="hs-identifier hs-var">imposs_deflt_cons</span></a><span> </span><span class="hs-special">`</span><a href="ListSetOps.html#minusList"><span class="hs-identifier hs-var">minusList</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627735329"><span class="hs-identifier hs-var">elim_cons</span></a><span>
</span><a name="line-730"></a><span>    </span><a name="local-1627735329"><a href="#local-1627735329"><span class="hs-identifier">elim_cons</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735330"><span class="hs-identifier hs-var">elim_con1</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="Util.html#fstOf3"><span class="hs-identifier hs-var">fstOf3</span></a><span> </span><a href="#local-1627735325"><span class="hs-identifier hs-var">elim_rest</span></a><span>
</span><a name="line-731"></a><span>    </span><a name="local-1627735330"><a href="#local-1627735330"><span class="hs-identifier">elim_con1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1627735321"><span class="hs-identifier hs-var">con1</span></a><span> </span><span class="hs-keyword">of</span><span>     </span><span class="hs-comment">-- Don't forget con1!</span><span>
</span><a name="line-732"></a><span>                  </span><a href="CoreSyn.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- See Note [</span><span>
</span><a name="line-733"></a><span>                  </span><span class="hs-identifier">_</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-1627735321"><span class="hs-identifier hs-var">con1</span></a><span class="hs-special">]</span><span>
</span><a name="line-734"></a><span>
</span><a name="line-735"></a><span>    </span><a name="local-1627735331"><a href="#local-1627735331"><span class="hs-identifier">cheapEqTicked</span></a></a><span> </span><a name="local-1627735334"><a href="#local-1627735334"><span class="hs-identifier">e1</span></a></a><span> </span><a name="local-1627735335"><a href="#local-1627735335"><span class="hs-identifier">e2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#cheapEqExpr%27"><span class="hs-identifier hs-var">cheapEqExpr'</span></a><span> </span><a href="CoreSyn.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a><span> </span><a href="#local-1627735334"><span class="hs-identifier hs-var">e1</span></a><span> </span><a href="#local-1627735335"><span class="hs-identifier hs-var">e2</span></a><span>
</span><a name="line-736"></a><span>    </span><a name="local-1627735332"><a href="#local-1627735332"><span class="hs-identifier">identical_to_alt1</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1627735336"><a href="#local-1627735336"><span class="hs-identifier">_con</span></a></a><span class="hs-special">,</span><a name="local-1627735337"><a href="#local-1627735337"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><a name="local-1627735338"><a href="#local-1627735338"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-737"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a><span> </span><a href="Id.html#isDeadBinder"><span class="hs-identifier hs-var">isDeadBinder</span></a><span> </span><a href="#local-1627735337"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-1627735338"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-special">`</span><a href="#local-1627735331"><span class="hs-identifier hs-var">cheapEqTicked</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627735323"><span class="hs-identifier hs-var">rhs1</span></a><span>
</span><a name="line-738"></a><span>    </span><a name="local-1627735333"><a href="#local-1627735333"><span class="hs-identifier">tickss</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><a href="CoreUtils.html#stripTicksT"><span class="hs-identifier hs-var">stripTicksT</span></a><span> </span><a href="CoreSyn.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="Util.html#thdOf3"><span class="hs-identifier hs-var">thdOf3</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735325"><span class="hs-identifier hs-var">elim_rest</span></a><span>
</span><a name="line-739"></a><span>
</span><a name="line-740"></a><span class="hs-identifier">combineIdenticalAlts</span><span> </span><a name="local-1627735339"><a href="#local-1627735339"><span class="hs-identifier">imposs_cons</span></a></a><span> </span><a name="local-1627735340"><a href="#local-1627735340"><span class="hs-identifier">alts</span></a></a><span>
</span><a name="line-741"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><a href="#local-1627735339"><span class="hs-identifier hs-var">imposs_cons</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627735340"><span class="hs-identifier hs-var">alts</span></a><span class="hs-special">)</span><span>
</span><a name="line-742"></a><span>
</span><a name="line-743"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
             exprIsTrivial
*                                                                      *
************************************************************************

Note [exprIsTrivial]
~~~~~~~~~~~~~~~~~~~~
@exprIsTrivial@ is true of expressions we are unconditionally happy to
                duplicate; simple variables and constants, and type
                applications.  Note that primop Ids aren't considered
                trivial unless

Note [Variables are trivial]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
There used to be a gruesome test for (hasNoBinding v) in the
Var case:
        exprIsTrivial (Var v) | hasNoBinding v = idArity v == 0
The idea here is that a constructor worker, like \$wJust, is
really short for (\x -&gt; \$wJust x), because \$wJust has no binding.
So it should be treated like a lambda.  Ditto unsaturated primops.
But now constructor workers are not &quot;have-no-binding&quot; Ids.  And
completely un-applied primops and foreign-call Ids are sufficiently
rare that I plan to allow them to be duplicated and put up with
saturating them.

Note [Tick trivial]
~~~~~~~~~~~~~~~~~~~
Ticks are only trivial if they are pure annotations. If we treat
&quot;tick&lt;n&gt; x&quot; as trivial, it will be inlined inside lambdas and the
entry count will be skewed, for example.  Furthermore &quot;scc&lt;n&gt; x&quot; will
turn into just &quot;x&quot; in mkTick.

Note [Empty case is trivial]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The expression (case (x::Int) Bool of {}) is just a type-changing
case used when we are sure that 'x' will not return.  See
Note [Empty case alternatives] in CoreSyn.

If the scrutinee is trivial, then so is the whole expression; and the
CoreToSTG pass in fact drops the case expression leaving only the
scrutinee.

Having more trivial expressions is good.  Moreover, if we don't treat
it as trivial we may land up with let-bindings like
   let v = case x of {} in ...
and after CoreToSTG that gives
   let v = x in ...
and that confuses the code generator (Trac #11155). So best to kill
it off at source.
-}</span><span>
</span><a name="line-794"></a><span>
</span><a name="line-795"></a><span class="hs-identifier">exprIsTrivial</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-796"></a><a name="exprIsTrivial"><a href="CoreUtils.html#exprIsTrivial"><span class="hs-identifier">exprIsTrivial</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>        </span><span class="hs-comment">-- See Note [Variables are trivial]</span><span>
</span><a name="line-797"></a><span class="hs-identifier">exprIsTrivial</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-798"></a><span class="hs-identifier">exprIsTrivial</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-799"></a><span class="hs-identifier">exprIsTrivial</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><a name="local-1627735341"><a href="#local-1627735341"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Literal.html#litIsTrivial"><span class="hs-identifier hs-var">litIsTrivial</span></a><span> </span><a href="#local-1627735341"><span class="hs-identifier hs-var">lit</span></a><span>
</span><a name="line-800"></a><span class="hs-identifier">exprIsTrivial</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-1627735342"><a href="#local-1627735342"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-1627735343"><a href="#local-1627735343"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#isRuntimeArg"><span class="hs-identifier hs-var">isRuntimeArg</span></a><span> </span><a href="#local-1627735343"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="CoreUtils.html#exprIsTrivial"><span class="hs-identifier hs-var">exprIsTrivial</span></a><span> </span><a href="#local-1627735342"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-801"></a><span class="hs-identifier">exprIsTrivial</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-1627735344"><a href="#local-1627735344"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-1627735345"><a href="#local-1627735345"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#tickishIsCode"><span class="hs-identifier hs-var">tickishIsCode</span></a><span> </span><a href="#local-1627735344"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="CoreUtils.html#exprIsTrivial"><span class="hs-identifier hs-var">exprIsTrivial</span></a><span> </span><a href="#local-1627735345"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-802"></a><span>                                 </span><span class="hs-comment">-- See Note [Tick trivial]</span><span>
</span><a name="line-803"></a><span class="hs-identifier">exprIsTrivial</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-1627735346"><a href="#local-1627735346"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#exprIsTrivial"><span class="hs-identifier hs-var">exprIsTrivial</span></a><span> </span><a href="#local-1627735346"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-804"></a><span class="hs-identifier">exprIsTrivial</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a name="local-1627735347"><a href="#local-1627735347"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-1627735348"><a href="#local-1627735348"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#isRuntimeVar"><span class="hs-identifier hs-var">isRuntimeVar</span></a><span> </span><a href="#local-1627735347"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="CoreUtils.html#exprIsTrivial"><span class="hs-identifier hs-var">exprIsTrivial</span></a><span> </span><a href="#local-1627735348"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-805"></a><span class="hs-identifier">exprIsTrivial</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Case"><span class="hs-identifier hs-var">Case</span></a><span> </span><a name="local-1627735349"><a href="#local-1627735349"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#exprIsTrivial"><span class="hs-identifier hs-var">exprIsTrivial</span></a><span> </span><a href="#local-1627735349"><span class="hs-identifier hs-var">e</span></a><span>  </span><span class="hs-comment">-- See Note [Empty case is trivial]</span><span>
</span><a name="line-806"></a><span class="hs-identifier">exprIsTrivial</span><span> </span><span class="hs-identifier">_</span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-807"></a><span>
</span><a name="line-808"></a><span class="hs-comment">{-
When substituting in a breakpoint we need to strip away the type cruft
from a trivial expression and get back to the Id.  The invariant is
that the expression we're substituting was originally trivial
according to exprIsTrivial.
-}</span><span>
</span><a name="line-814"></a><span>
</span><a name="line-815"></a><span class="hs-identifier">getIdFromTrivialExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span>
</span><a name="line-816"></a><a name="getIdFromTrivialExpr"><a href="CoreUtils.html#getIdFromTrivialExpr"><span class="hs-identifier">getIdFromTrivialExpr</span></a></a><span> </span><a name="local-1627735350"><a href="#local-1627735350"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735351"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735350"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-817"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-1627735351"><a href="#local-1627735351"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-1627735352"><a href="#local-1627735352"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735352"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-818"></a><span>        </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-1627735353"><a href="#local-1627735353"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-1627735354"><a href="#local-1627735354"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#isRuntimeArg"><span class="hs-identifier hs-var">isRuntimeArg</span></a><span> </span><a href="#local-1627735354"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735351"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735353"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-819"></a><span>        </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-1627735355"><a href="#local-1627735355"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-1627735356"><a href="#local-1627735356"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#tickishIsCode"><span class="hs-identifier hs-var">tickishIsCode</span></a><span> </span><a href="#local-1627735355"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735351"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735356"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-820"></a><span>        </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-1627735357"><a href="#local-1627735357"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735351"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735357"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-821"></a><span>        </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a name="local-1627735358"><a href="#local-1627735358"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-1627735359"><a href="#local-1627735359"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#isRuntimeVar"><span class="hs-identifier hs-var">isRuntimeVar</span></a><span> </span><a href="#local-1627735358"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735351"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735359"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-822"></a><span>        </span><span class="hs-identifier">go</span><span> </span><a name="local-1627735360"><a href="#local-1627735360"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;getIdFromTrivialExpr&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1627735360"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-823"></a><span>
</span><a name="line-824"></a><span class="hs-comment">{-
exprIsBottom is a very cheap and cheerful function; it may return
False for bottoming expressions, but it never costs much to ask.  See
also CoreArity.exprBotStrictness_maybe, but that's a bit more
expensive.
-}</span><span>
</span><a name="line-830"></a><span>
</span><a name="line-831"></a><span class="hs-identifier">exprIsBottom</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-832"></a><span class="hs-comment">-- See Note [Bottoming expressions]</span><span>
</span><a name="line-833"></a><a name="exprIsBottom"><a href="CoreUtils.html#exprIsBottom"><span class="hs-identifier">exprIsBottom</span></a></a><span> </span><a name="local-1627735361"><a href="#local-1627735361"><span class="hs-identifier">e</span></a></a><span>
</span><a name="line-834"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="CoreUtils.html#isEmptyTy"><span class="hs-identifier hs-var">isEmptyTy</span></a><span> </span><span class="hs-special">(</span><a href="CoreUtils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a><span> </span><a href="#local-1627735361"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-835"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-836"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-837"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735362"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-1627735361"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-838"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-839"></a><span>    </span><a name="local-1627735362"><a href="#local-1627735362"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-1627735363"><a href="#local-1627735363"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-1627735364"><a href="#local-1627735364"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#isBottomingId"><span class="hs-identifier hs-var">isBottomingId</span></a><span> </span><a href="#local-1627735364"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>  </span><a href="#local-1627735363"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><a href="Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a><span> </span><a href="#local-1627735364"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-840"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1627735365"><a href="#local-1627735365"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-1627735366"><a href="#local-1627735366"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-1627735367"><a href="#local-1627735367"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#isTypeArg"><span class="hs-identifier hs-var">isTypeArg</span></a><span> </span><a href="#local-1627735367"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735362"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735365"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-1627735366"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-841"></a><span>                   </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735362"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627735365"><span class="hs-identifier hs-var">n</span></a><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-1627735366"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-842"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1627735368"><a href="#local-1627735368"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627735369"><a href="#local-1627735369"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735362"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735368"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-1627735369"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-843"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1627735370"><a href="#local-1627735370"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-1627735371"><a href="#local-1627735371"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735362"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735370"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-1627735371"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-844"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1627735372"><a href="#local-1627735372"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627735373"><a href="#local-1627735373"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>               </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735362"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735372"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-1627735373"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-845"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1627735374"><a href="#local-1627735374"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a name="local-1627735375"><a href="#local-1627735375"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-1627735376"><a href="#local-1627735376"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-1627735375"><span class="hs-identifier hs-var">v</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735362"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735374"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-1627735376"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-846"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Case"><span class="hs-identifier hs-var">Case</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627735377"><a href="#local-1627735377"><span class="hs-identifier">alts</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1627735377"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-847"></a><span>       </span><span class="hs-comment">-- See Note [Empty case alternatives] in CoreSyn</span><span>
</span><a name="line-848"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>                       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-849"></a><span>
</span><a name="line-850"></a><span class="hs-comment">{- Note [Bottoming expressions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
A bottoming expression is guaranteed to diverge, or raise an
exception.  We can test for it in two different ways, and exprIsBottom
checks for both of these situations:

* Visibly-bottom computations.  For example
      (error Int &quot;Hello&quot;)
  is visibly bottom.  The strictness analyser also finds out if
  a function diverges or raises an exception, and puts that info
  in its strictness signature.

* Empty types.  If a type is empty, its only inhabitant is bottom.
  For example:
      data T
      f :: T -&gt; Bool
      f = \(x:t). case x of Bool {}
  Since T has no data constructors, the case alternatives are of course
  empty.  However note that 'x' is not bound to a visibly-bottom value;
  it's the *type* that tells us it's going to diverge.

A GADT may also be empty even though it has constructors:
        data T a where
          T1 :: a -&gt; T Bool
          T2 :: T Int
        ...(case (x::T Char) of {})...
Here (T Char) is uninhabited.  A more realistic case is (Int ~ Bool),
which is likewise uninhabited.


************************************************************************
*                                                                      *
             exprIsDupable
*                                                                      *
************************************************************************

Note [exprIsDupable]
~~~~~~~~~~~~~~~~~~~~
@exprIsDupable@ is true of expressions that can be duplicated at a modest
                cost in code size.  This will only happen in different case
                branches, so there's no issue about duplicating work.

                That is, exprIsDupable returns True of (f x) even if
                f is very very expensive to call.

                Its only purpose is to avoid fruitless let-binding
                and then inlining of case join points
-}</span><span>
</span><a name="line-898"></a><span>
</span><a name="line-899"></a><span class="hs-identifier">exprIsDupable</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-900"></a><a name="exprIsDupable"><a href="CoreUtils.html#exprIsDupable"><span class="hs-identifier">exprIsDupable</span></a></a><span> </span><a name="local-1627735378"><a href="#local-1627735378"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-1627735379"><a href="#local-1627735379"><span class="hs-identifier">e</span></a></a><span>
</span><a name="line-901"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#isJust"><span class="hs-identifier hs-var">isJust</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627735380"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="CoreUtils.html#dupAppSize"><span class="hs-identifier hs-var">dupAppSize</span></a><span> </span><a href="#local-1627735379"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-902"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-903"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-904"></a><span>    </span><a name="local-1627735380"><a href="#local-1627735380"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-1627735382"><a href="#local-1627735382"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-1627735382"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-905"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1627735383"><a href="#local-1627735383"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-1627735383"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-906"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1627735384"><a href="#local-1627735384"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735381"><span class="hs-identifier hs-var">decrement</span></a><span> </span><a href="#local-1627735384"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-907"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1627735385"><a href="#local-1627735385"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627735386"><a href="#local-1627735386"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735380"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735385"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-1627735386"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-908"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1627735387"><a href="#local-1627735387"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-1627735388"><a href="#local-1627735388"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735380"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735387"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-1627735388"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-909"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1627735389"><a href="#local-1627735389"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-1627735390"><a href="#local-1627735390"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-1627735391"><a href="#local-1627735391"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1627735392"><a href="#local-1627735392"><span class="hs-identifier">n'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627735380"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735389"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-1627735391"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735380"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735392"><span class="hs-identifier hs-var">n'</span></a><span> </span><a href="#local-1627735390"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-910"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1627735393"><a href="#local-1627735393"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><a name="local-1627735394"><a href="#local-1627735394"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="Literal.html#litIsDupable"><span class="hs-identifier hs-var">litIsDupable</span></a><span> </span><a href="#local-1627735378"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-1627735394"><span class="hs-identifier hs-var">lit</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735381"><span class="hs-identifier hs-var">decrement</span></a><span> </span><a href="#local-1627735393"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-911"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-912"></a><span>
</span><a name="line-913"></a><span>    </span><span class="hs-identifier">decrement</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-914"></a><span>    </span><a name="local-1627735381"><a href="#local-1627735381"><span class="hs-identifier">decrement</span></a></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-915"></a><span>    </span><span class="hs-identifier">decrement</span><span> </span><a name="local-1627735395"><a href="#local-1627735395"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627735395"><span class="hs-identifier hs-var">n</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-916"></a><span>
</span><a name="line-917"></a><span class="hs-identifier">dupAppSize</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-918"></a><a name="dupAppSize"><a href="CoreUtils.html#dupAppSize"><span class="hs-identifier">dupAppSize</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">8</span><span>   </span><span class="hs-comment">-- Size of term we are prepared to duplicate</span><span>
</span><a name="line-919"></a><span>                 </span><span class="hs-comment">-- This is *just* big enough to make test MethSharing</span><span>
</span><a name="line-920"></a><span>                 </span><span class="hs-comment">-- inline enough join points.  Really it should be</span><span>
</span><a name="line-921"></a><span>                 </span><span class="hs-comment">-- smaller, and could be if we fixed Trac #4960.</span><span>
</span><a name="line-922"></a><span>
</span><a name="line-923"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
             exprIsCheap, exprIsExpandable
*                                                                      *
************************************************************************

Note [exprIsWorkFree]
~~~~~~~~~~~~~~~~~~~~~
exprIsWorkFree is used when deciding whether to inline something; we
don't inline it if doing so might duplicate work, by peeling off a
complete copy of the expression.  Here we do not want even to
duplicate a primop (Trac #5623):
   eg   let x = a #+ b in x +# x
   we do not want to inline/duplicate x

Previously we were a bit more liberal, which led to the primop-duplicating
problem.  However, being more conservative did lead to a big regression in
one nofib benchmark, wheel-sieve1.  The situation looks like this:

   let noFactor_sZ3 :: GHC.Types.Int -&gt; GHC.Types.Bool
       noFactor_sZ3 = case s_adJ of _ { GHC.Types.I# x_aRs -&gt;
         case GHC.Prim.&lt;=# x_aRs 2 of _ {
           GHC.Types.False -&gt; notDivBy ps_adM qs_adN;
           GHC.Types.True -&gt; lvl_r2Eb }}
       go = \x. ...(noFactor (I# y))....(go x')...

The function 'noFactor' is heap-allocated and then called.  Turns out
that 'notDivBy' is strict in its THIRD arg, but that is invisible to
the caller of noFactor, which therefore cannot do w/w and
heap-allocates noFactor's argument.  At the moment (May 12) we are just
going to put up with this, because the previous more aggressive inlining
(which treated 'noFactor' as work-free) was duplicating primops, which
in turn was making inner loops of array calculations runs slow (#5623)
-}</span><span>
</span><a name="line-958"></a><span>
</span><a name="line-959"></a><span class="hs-identifier">exprIsWorkFree</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-960"></a><span class="hs-comment">-- See Note [exprIsWorkFree]</span><span>
</span><a name="line-961"></a><a name="exprIsWorkFree"><a href="CoreUtils.html#exprIsWorkFree"><span class="hs-identifier">exprIsWorkFree</span></a></a><span> </span><a name="local-1627735396"><a href="#local-1627735396"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735397"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-1627735396"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-962"></a><span>  </span><span class="hs-keyword">where</span><span>    </span><span class="hs-comment">-- n is the number of value arguments</span><span>
</span><a name="line-963"></a><span>    </span><a name="local-1627735397"><a href="#local-1627735397"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-964"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>                    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-965"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-966"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1627735398"><a href="#local-1627735398"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-1627735399"><a href="#local-1627735399"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>                   </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735397"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735398"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-1627735399"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-967"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1627735400"><a href="#local-1627735400"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Case"><span class="hs-identifier hs-var">Case</span></a><span> </span><a name="local-1627735401"><a href="#local-1627735401"><span class="hs-identifier">scrut</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627735402"><a href="#local-1627735402"><span class="hs-identifier">alts</span></a></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#foldl"><span class="hs-identifier hs-var">foldl</span></a><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&amp;&amp;</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreUtils.html#exprIsWorkFree"><span class="hs-identifier hs-var">exprIsWorkFree</span></a><span> </span><a href="#local-1627735401"><span class="hs-identifier hs-var">scrut</span></a><span class="hs-special">)</span><span>
</span><a name="line-968"></a><span>                                              </span><span class="hs-special">[</span><span> </span><a href="#local-1627735397"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735400"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-1627735403"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-1627735403"><a href="#local-1627735403"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627735402"><span class="hs-identifier hs-var">alts</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-969"></a><span>         </span><span class="hs-comment">-- See Note [Case expressions are work-free]</span><span>
</span><a name="line-970"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-971"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1627735404"><a href="#local-1627735404"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-1627735405"><a href="#local-1627735405"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span>                      </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#isCheapApp"><span class="hs-identifier hs-var">isCheapApp</span></a><span> </span><a href="#local-1627735405"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-1627735404"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-972"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1627735406"><a href="#local-1627735406"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-1627735407"><a href="#local-1627735407"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-1627735408"><a href="#local-1627735408"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#tickishCounts"><span class="hs-identifier hs-var">tickishCounts</span></a><span> </span><a href="#local-1627735407"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-973"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735397"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735406"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-1627735408"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-974"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1627735409"><a href="#local-1627735409"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a name="local-1627735410"><a href="#local-1627735410"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-1627735411"><a href="#local-1627735411"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#isRuntimeVar"><span class="hs-identifier hs-var">isRuntimeVar</span></a><span> </span><a href="#local-1627735410"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735409"><span class="hs-identifier hs-var">n</span></a><span class="hs-operator hs-var">==</span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-1627735397"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627735409"><span class="hs-identifier hs-var">n</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-1627735411"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-975"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735397"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735409"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-1627735411"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-976"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1627735412"><a href="#local-1627735412"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-1627735413"><a href="#local-1627735413"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-1627735414"><a href="#local-1627735414"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#isRuntimeArg"><span class="hs-identifier hs-var">isRuntimeArg</span></a><span> </span><a href="#local-1627735414"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#exprIsWorkFree"><span class="hs-identifier hs-var">exprIsWorkFree</span></a><span> </span><a href="#local-1627735414"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-1627735397"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627735412"><span class="hs-identifier hs-var">n</span></a><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-1627735413"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-977"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735397"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735412"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-1627735413"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-978"></a><span>
</span><a name="line-979"></a><span class="hs-comment">{-
Note [Case expressions are work-free]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Are case-expressions work-free?  Consider
    let v = case x of (p,q) -&gt; p
        go = \y -&gt; ...case v of ...
Should we inline 'v' at its use site inside the loop?  At the moment
we do.  I experimented with saying that case are *not* work-free, but
that increased allocation slightly.  It's a fairly small effect, and at
the moment we go for the slightly more aggressive version which treats
(case x of ....) as work-free if the alternatives are.


Note [exprIsCheap]   See also Note [Interaction of exprIsCheap and lone variables]
~~~~~~~~~~~~~~~~~~   in CoreUnfold.hs
@exprIsCheap@ looks at a Core expression and returns \tr{True} if
it is obviously in weak head normal form, or is cheap to get to WHNF.
[Note that that's not the same as exprIsDupable; an expression might be
big, and hence not dupable, but still cheap.]

By ``cheap'' we mean a computation we're willing to:
        push inside a lambda, or
        inline at more than one place
That might mean it gets evaluated more than once, instead of being
shared.  The main examples of things which aren't WHNF but are
``cheap'' are:

  *     case e of
          pi -&gt; ei
        (where e, and all the ei are cheap)

  *     let x = e in b
        (where e and b are cheap)

  *     op x1 ... xn
        (where op is a cheap primitive operator)

  *     error &quot;foo&quot;
        (because we are happy to substitute it inside a lambda)

Notice that a variable is considered 'cheap': we can push it inside a lambda,
because sharing will make sure it is only evaluated once.

Note [exprIsCheap and exprIsHNF]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Note that exprIsHNF does not imply exprIsCheap.  Eg
        let x = fac 20 in Just x
This responds True to exprIsHNF (you can discard a seq), but
False to exprIsCheap.
-}</span><span>
</span><a name="line-1029"></a><span>
</span><a name="line-1030"></a><span class="hs-identifier">exprIsCheap</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1031"></a><a name="exprIsCheap"><a href="CoreUtils.html#exprIsCheap"><span class="hs-identifier">exprIsCheap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#exprIsCheap%27"><span class="hs-identifier hs-var">exprIsCheap'</span></a><span> </span><a href="CoreUtils.html#isCheapApp"><span class="hs-identifier hs-var">isCheapApp</span></a><span>
</span><a name="line-1032"></a><span>
</span><a name="line-1033"></a><span class="hs-identifier">exprIsExpandable</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1034"></a><a name="exprIsExpandable"><a href="CoreUtils.html#exprIsExpandable"><span class="hs-identifier">exprIsExpandable</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#exprIsCheap%27"><span class="hs-identifier hs-var">exprIsCheap'</span></a><span> </span><a href="CoreUtils.html#isExpandableApp"><span class="hs-identifier hs-var">isExpandableApp</span></a><span> </span><span class="hs-comment">-- See Note [CONLIKE pragma] in BasicTypes</span><span>
</span><a name="line-1035"></a><span>
</span><a name="line-1036"></a><span class="hs-identifier">exprIsCheap'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreUtils.html#CheapAppFun"><span class="hs-identifier hs-type">CheapAppFun</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1037"></a><a name="exprIsCheap%27"><a href="CoreUtils.html#exprIsCheap%27"><span class="hs-identifier">exprIsCheap'</span></a></a><span> </span><span class="hs-identifier">_</span><span>        </span><span class="hs-special">(</span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1038"></a><span class="hs-identifier">exprIsCheap'</span><span> </span><span class="hs-identifier">_</span><span>        </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1039"></a><span class="hs-identifier">exprIsCheap'</span><span> </span><span class="hs-identifier">_</span><span>        </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1040"></a><span class="hs-identifier">exprIsCheap'</span><span> </span><span class="hs-identifier">_</span><span>        </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1041"></a><span class="hs-identifier">exprIsCheap'</span><span> </span><a name="local-1627735415"><a href="#local-1627735415"><span class="hs-identifier">good_app</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-1627735416"><a href="#local-1627735416"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#exprIsCheap%27"><span class="hs-identifier hs-var">exprIsCheap'</span></a><span> </span><a href="#local-1627735415"><span class="hs-identifier hs-var">good_app</span></a><span> </span><a href="#local-1627735416"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1042"></a><span class="hs-identifier">exprIsCheap'</span><span> </span><a name="local-1627735417"><a href="#local-1627735417"><span class="hs-identifier">good_app</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a name="local-1627735418"><a href="#local-1627735418"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-1627735419"><a href="#local-1627735419"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#isRuntimeVar"><span class="hs-identifier hs-var">isRuntimeVar</span></a><span> </span><a href="#local-1627735418"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-1043"></a><span>                                  </span><span class="hs-operator hs-var">||</span><span> </span><a href="CoreUtils.html#exprIsCheap%27"><span class="hs-identifier hs-var">exprIsCheap'</span></a><span> </span><a href="#local-1627735417"><span class="hs-identifier hs-var">good_app</span></a><span> </span><a href="#local-1627735419"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1044"></a><span>
</span><a name="line-1045"></a><span class="hs-identifier">exprIsCheap'</span><span> </span><a name="local-1627735420"><a href="#local-1627735420"><span class="hs-identifier">good_app</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Case"><span class="hs-identifier hs-var">Case</span></a><span> </span><a name="local-1627735421"><a href="#local-1627735421"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627735422"><a href="#local-1627735422"><span class="hs-identifier">alts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#exprIsCheap%27"><span class="hs-identifier hs-var">exprIsCheap'</span></a><span> </span><a href="#local-1627735420"><span class="hs-identifier hs-var">good_app</span></a><span> </span><a href="#local-1627735421"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-1046"></a><span>                                          </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#and"><span class="hs-identifier hs-var">and</span></a><span> </span><span class="hs-special">[</span><a href="CoreUtils.html#exprIsCheap%27"><span class="hs-identifier hs-var">exprIsCheap'</span></a><span> </span><a href="#local-1627735420"><span class="hs-identifier hs-var">good_app</span></a><span> </span><a href="#local-1627735423"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-1627735423"><a href="#local-1627735423"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627735422"><span class="hs-identifier hs-var">alts</span></a><span class="hs-special">]</span><span>
</span><a name="line-1047"></a><span>        </span><span class="hs-comment">-- Experimentally, treat (case x of ...) as cheap</span><span>
</span><a name="line-1048"></a><span>        </span><span class="hs-comment">-- (and case __coerce x etc.)</span><span>
</span><a name="line-1049"></a><span>        </span><span class="hs-comment">-- This improves arities of overloaded functions where</span><span>
</span><a name="line-1050"></a><span>        </span><span class="hs-comment">-- there is only dictionary selection (no construction) involved</span><span>
</span><a name="line-1051"></a><span>
</span><a name="line-1052"></a><span class="hs-identifier">exprIsCheap'</span><span> </span><a name="local-1627735424"><a href="#local-1627735424"><span class="hs-identifier">good_app</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-1627735425"><a href="#local-1627735425"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-1627735426"><a href="#local-1627735426"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1053"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#tickishCounts"><span class="hs-identifier hs-var">tickishCounts</span></a><span> </span><a href="#local-1627735425"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1054"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#exprIsCheap%27"><span class="hs-identifier hs-var">exprIsCheap'</span></a><span> </span><a href="#local-1627735424"><span class="hs-identifier hs-var">good_app</span></a><span> </span><a href="#local-1627735426"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1055"></a><span>     </span><span class="hs-comment">-- never duplicate counting ticks.  If we get this wrong, then</span><span>
</span><a name="line-1056"></a><span>     </span><span class="hs-comment">-- HPC's entry counts will be off (check test in</span><span>
</span><a name="line-1057"></a><span>     </span><span class="hs-comment">-- libraries/hpc/tests/raytrace)</span><span>
</span><a name="line-1058"></a><span>
</span><a name="line-1059"></a><span class="hs-identifier">exprIsCheap'</span><span> </span><a name="local-1627735427"><a href="#local-1627735427"><span class="hs-identifier">good_app</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627735428"><a href="#local-1627735428"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627735429"><a href="#local-1627735429"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1060"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#exprIsCheap%27"><span class="hs-identifier hs-var">exprIsCheap'</span></a><span> </span><a href="#local-1627735427"><span class="hs-identifier hs-var">good_app</span></a><span> </span><a href="#local-1627735428"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="CoreUtils.html#exprIsCheap%27"><span class="hs-identifier hs-var">exprIsCheap'</span></a><span> </span><a href="#local-1627735427"><span class="hs-identifier hs-var">good_app</span></a><span> </span><a href="#local-1627735429"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1061"></a><span class="hs-identifier">exprIsCheap'</span><span> </span><a name="local-1627735430"><a href="#local-1627735430"><span class="hs-identifier">good_app</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><a name="local-1627735431"><a href="#local-1627735431"><span class="hs-identifier">prs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627735432"><a href="#local-1627735432"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1062"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a><span> </span><span class="hs-special">(</span><a href="CoreUtils.html#exprIsCheap%27"><span class="hs-identifier hs-var">exprIsCheap'</span></a><span> </span><a href="#local-1627735430"><span class="hs-identifier hs-var">good_app</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#snd"><span class="hs-identifier hs-var">snd</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735431"><span class="hs-identifier hs-var">prs</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="CoreUtils.html#exprIsCheap%27"><span class="hs-identifier hs-var">exprIsCheap'</span></a><span> </span><a href="#local-1627735430"><span class="hs-identifier hs-var">good_app</span></a><span> </span><a href="#local-1627735432"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1063"></a><span>
</span><a name="line-1064"></a><span class="hs-identifier">exprIsCheap'</span><span> </span><a name="local-1627735433"><a href="#local-1627735433"><span class="hs-identifier">good_app</span></a></a><span> </span><a name="local-1627735434"><a href="#local-1627735434"><span class="hs-identifier">other_expr</span></a></a><span>        </span><span class="hs-comment">-- Applications and variables</span><span>
</span><a name="line-1065"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735435"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735434"><span class="hs-identifier hs-var">other_expr</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1066"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1067"></a><span>        </span><span class="hs-comment">-- Accumulate value arguments, then decide</span><span>
</span><a name="line-1068"></a><span>    </span><a name="local-1627735435"><a href="#local-1627735435"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-1627735439"><a href="#local-1627735439"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-1627735440"><a href="#local-1627735440"><span class="hs-identifier">val_args</span></a></a><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735435"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735439"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-1627735440"><span class="hs-identifier hs-var">val_args</span></a><span>
</span><a name="line-1069"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-1627735441"><a href="#local-1627735441"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-1627735442"><a href="#local-1627735442"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627735443"><a href="#local-1627735443"><span class="hs-identifier">val_args</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#isRuntimeArg"><span class="hs-identifier hs-var">isRuntimeArg</span></a><span> </span><a href="#local-1627735442"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735435"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735441"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627735442"><span class="hs-identifier hs-var">a</span></a><span class="hs-glyph">:</span><a href="#local-1627735443"><span class="hs-identifier hs-var">val_args</span></a><span class="hs-special">)</span><span>
</span><a name="line-1070"></a><span>                          </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735435"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735441"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-1627735443"><span class="hs-identifier hs-var">val_args</span></a><span>
</span><a name="line-1071"></a><span>
</span><a name="line-1072"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1073"></a><span>         </span><span class="hs-comment">-- Just a type application of a variable</span><span>
</span><a name="line-1074"></a><span>         </span><span class="hs-comment">-- (f t1 t2 t3) counts as WHNF</span><span>
</span><a name="line-1075"></a><span>         </span><span class="hs-comment">-- This case is probably handeld by the good_app case</span><span>
</span><a name="line-1076"></a><span>         </span><span class="hs-comment">-- below, which should have a case for n=0, but putting</span><span>
</span><a name="line-1077"></a><span>         </span><span class="hs-comment">-- it here too is belt and braces; and it's such a common</span><span>
</span><a name="line-1078"></a><span>         </span><span class="hs-comment">-- case that checking for null directly seems like a</span><span>
</span><a name="line-1079"></a><span>         </span><span class="hs-comment">-- good plan</span><span>
</span><a name="line-1080"></a><span>
</span><a name="line-1081"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-1627735444"><a href="#local-1627735444"><span class="hs-identifier">f</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627735445"><a href="#local-1627735445"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-1082"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627735433"><span class="hs-identifier hs-var">good_app</span></a><span> </span><a href="#local-1627735444"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><a href="#local-1627735445"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Typically holds of data constructor applications</span><span>
</span><a name="line-1083"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735436"><span class="hs-identifier hs-var">go_pap</span></a><span> </span><a href="#local-1627735445"><span class="hs-identifier hs-var">args</span></a><span>               </span><span class="hs-comment">-- E.g. good_app = isCheapApp below</span><span>
</span><a name="line-1084"></a><span>
</span><a name="line-1085"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1086"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Var.html#idDetails"><span class="hs-identifier hs-var">idDetails</span></a><span> </span><a href="#local-1627735444"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1087"></a><span>                </span><a href="IdInfo.html#RecSelId"><span class="hs-identifier hs-var">RecSelId</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627735438"><span class="hs-identifier hs-var">go_sel</span></a><span> </span><a href="#local-1627735445"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1088"></a><span>                </span><a href="IdInfo.html#ClassOpId"><span class="hs-identifier hs-var">ClassOpId</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627735438"><span class="hs-identifier hs-var">go_sel</span></a><span> </span><a href="#local-1627735445"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1089"></a><span>                </span><a href="IdInfo.html#PrimOpId"><span class="hs-identifier hs-var">PrimOpId</span></a><span> </span><a name="local-1627735446"><a href="#local-1627735446"><span class="hs-identifier">op</span></a></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627735437"><span class="hs-identifier hs-var">go_primop</span></a><span> </span><a href="#local-1627735446"><span class="hs-identifier hs-var">op</span></a><span> </span><a href="#local-1627735445"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1090"></a><span>                </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="Id.html#isBottomingId"><span class="hs-identifier hs-var">isBottomingId</span></a><span> </span><a href="#local-1627735444"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1091"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1092"></a><span>                        </span><span class="hs-comment">-- Application of a function which</span><span>
</span><a name="line-1093"></a><span>                        </span><span class="hs-comment">-- always gives bottom; we treat this as cheap</span><span>
</span><a name="line-1094"></a><span>                        </span><span class="hs-comment">-- because it certainly doesn't need to be shared!</span><span>
</span><a name="line-1095"></a><span>
</span><a name="line-1096"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-1627735447"><a href="#local-1627735447"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-1627735448"><a href="#local-1627735448"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627735449"><a href="#local-1627735449"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-1097"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#tickishCounts"><span class="hs-identifier hs-var">tickishCounts</span></a><span> </span><a href="#local-1627735447"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- don't duplicate counting ticks, see above</span><span>
</span><a name="line-1098"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735435"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735448"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-1627735449"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1099"></a><span>
</span><a name="line-1100"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1101"></a><span>
</span><a name="line-1102"></a><span>    </span><span class="hs-comment">--------------</span><span>
</span><a name="line-1103"></a><span>    </span><a name="local-1627735436"><a href="#local-1627735436"><span class="hs-identifier">go_pap</span></a></a><span> </span><a name="local-1627735450"><a href="#local-1627735450"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a><span> </span><span class="hs-special">(</span><a href="CoreUtils.html#exprIsCheap%27"><span class="hs-identifier hs-var">exprIsCheap'</span></a><span> </span><a href="#local-1627735433"><span class="hs-identifier hs-var">good_app</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735450"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1104"></a><span>        </span><span class="hs-comment">-- Used to be &quot;all exprIsTrivial args&quot; due to concerns about</span><span>
</span><a name="line-1105"></a><span>        </span><span class="hs-comment">-- duplicating nested constructor applications, but see #4978.</span><span>
</span><a name="line-1106"></a><span>        </span><span class="hs-comment">-- The principle here is that</span><span>
</span><a name="line-1107"></a><span>        </span><span class="hs-comment">--    let x = a +# b in c *# x</span><span>
</span><a name="line-1108"></a><span>        </span><span class="hs-comment">-- should behave equivalently to</span><span>
</span><a name="line-1109"></a><span>        </span><span class="hs-comment">--    c *# (a +# b)</span><span>
</span><a name="line-1110"></a><span>        </span><span class="hs-comment">-- Since lets with cheap RHSs are accepted,</span><span>
</span><a name="line-1111"></a><span>        </span><span class="hs-comment">-- so should paps with cheap arguments</span><span>
</span><a name="line-1112"></a><span>
</span><a name="line-1113"></a><span>    </span><span class="hs-comment">--------------</span><span>
</span><a name="line-1114"></a><span>    </span><a name="local-1627735437"><a href="#local-1627735437"><span class="hs-identifier">go_primop</span></a></a><span> </span><a name="local-1627735451"><a href="#local-1627735451"><span class="hs-identifier">op</span></a></a><span> </span><a name="local-1627735452"><a href="#local-1627735452"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="PrimOp.html#primOpIsCheap"><span class="hs-identifier hs-var">primOpIsCheap</span></a><span> </span><a href="#local-1627735451"><span class="hs-identifier hs-var">op</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a><span> </span><span class="hs-special">(</span><a href="CoreUtils.html#exprIsCheap%27"><span class="hs-identifier hs-var">exprIsCheap'</span></a><span> </span><a href="#local-1627735433"><span class="hs-identifier hs-var">good_app</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735452"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1115"></a><span>        </span><span class="hs-comment">-- In principle we should worry about primops</span><span>
</span><a name="line-1116"></a><span>        </span><span class="hs-comment">-- that return a type variable, since the result</span><span>
</span><a name="line-1117"></a><span>        </span><span class="hs-comment">-- might be applied to something, but I'm not going</span><span>
</span><a name="line-1118"></a><span>        </span><span class="hs-comment">-- to bother to check the number of args</span><span>
</span><a name="line-1119"></a><span>
</span><a name="line-1120"></a><span>    </span><span class="hs-comment">--------------</span><span>
</span><a name="line-1121"></a><span>    </span><a name="local-1627735438"><a href="#local-1627735438"><span class="hs-identifier">go_sel</span></a></a><span> </span><span class="hs-special">[</span><a name="local-1627735453"><a href="#local-1627735453"><span class="hs-identifier">arg</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#exprIsCheap%27"><span class="hs-identifier hs-var">exprIsCheap'</span></a><span> </span><a href="#local-1627735433"><span class="hs-identifier hs-var">good_app</span></a><span> </span><a href="#local-1627735453"><span class="hs-identifier hs-var">arg</span></a><span>    </span><span class="hs-comment">-- I'm experimenting with making record selection</span><span>
</span><a name="line-1122"></a><span>    </span><span class="hs-identifier">go_sel</span><span> </span><span class="hs-identifier">_</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>                </span><span class="hs-comment">-- look cheap, so we will substitute it inside a</span><span>
</span><a name="line-1123"></a><span>                                        </span><span class="hs-comment">-- lambda.  Particularly for dictionary field selection.</span><span>
</span><a name="line-1124"></a><span>                </span><span class="hs-comment">-- BUT: Take care with (sel d x)!  The (sel d) might be cheap, but</span><span>
</span><a name="line-1125"></a><span>                </span><span class="hs-comment">--      there's no guarantee that (sel d x) will be too.  Hence (n_val_args == 1)</span><span>
</span><a name="line-1126"></a><span>
</span><a name="line-1127"></a><span class="hs-comment">-------------------------------------</span><span>
</span><a name="line-1128"></a><span class="hs-keyword">type</span><span> </span><a name="CheapAppFun"><a href="CoreUtils.html#CheapAppFun"><span class="hs-identifier">CheapAppFun</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1129"></a><span>  </span><span class="hs-comment">-- Is an application of this function to n *value* args</span><span>
</span><a name="line-1130"></a><span>  </span><span class="hs-comment">-- always cheap, assuming the arguments are cheap?</span><span>
</span><a name="line-1131"></a><span>  </span><span class="hs-comment">-- Mainly true of partial applications, data constructors,</span><span>
</span><a name="line-1132"></a><span>  </span><span class="hs-comment">-- and of course true if the number of args is zero</span><span>
</span><a name="line-1133"></a><span>
</span><a name="line-1134"></a><span class="hs-identifier">isCheapApp</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreUtils.html#CheapAppFun"><span class="hs-identifier hs-type">CheapAppFun</span></a><span>
</span><a name="line-1135"></a><a name="isCheapApp"><a href="CoreUtils.html#isCheapApp"><span class="hs-identifier">isCheapApp</span></a></a><span> </span><a name="local-1627735454"><a href="#local-1627735454"><span class="hs-identifier">fn</span></a></a><span> </span><a name="local-1627735455"><a href="#local-1627735455"><span class="hs-identifier">n_val_args</span></a></a><span>
</span><a name="line-1136"></a><span>  </span><span class="hs-glyph">=</span><span>  </span><a href="Id.html#isDataConWorkId"><span class="hs-identifier hs-var">isDataConWorkId</span></a><span> </span><a href="#local-1627735454"><span class="hs-identifier hs-var">fn</span></a><span>
</span><a name="line-1137"></a><span>  </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-1627735455"><span class="hs-identifier hs-var">n_val_args</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-1138"></a><span>  </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-1627735455"><span class="hs-identifier hs-var">n_val_args</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a><span> </span><a href="#local-1627735454"><span class="hs-identifier hs-var">fn</span></a><span>
</span><a name="line-1139"></a><span>
</span><a name="line-1140"></a><span class="hs-identifier">isExpandableApp</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreUtils.html#CheapAppFun"><span class="hs-identifier hs-type">CheapAppFun</span></a><span>
</span><a name="line-1141"></a><a name="isExpandableApp"><a href="CoreUtils.html#isExpandableApp"><span class="hs-identifier">isExpandableApp</span></a></a><span> </span><a name="local-1627735456"><a href="#local-1627735456"><span class="hs-identifier">fn</span></a></a><span> </span><a name="local-1627735457"><a href="#local-1627735457"><span class="hs-identifier">n_val_args</span></a></a><span>
</span><a name="line-1142"></a><span>  </span><span class="hs-glyph">=</span><span>  </span><a href="Id.html#isConLikeId"><span class="hs-identifier hs-var">isConLikeId</span></a><span> </span><a href="#local-1627735456"><span class="hs-identifier hs-var">fn</span></a><span>
</span><a name="line-1143"></a><span>  </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-1627735457"><span class="hs-identifier hs-var">n_val_args</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a><span> </span><a href="#local-1627735456"><span class="hs-identifier hs-var">fn</span></a><span>
</span><a name="line-1144"></a><span>  </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-1627735458"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735457"><span class="hs-identifier hs-var">n_val_args</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idType"><span class="hs-identifier hs-var">idType</span></a><span> </span><a href="#local-1627735456"><span class="hs-identifier hs-var">fn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1145"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1146"></a><span>  </span><span class="hs-comment">-- See if all the arguments are PredTys (implicit params or classes)</span><span>
</span><a name="line-1147"></a><span>  </span><span class="hs-comment">-- If so we'll regard it as expandable; see Note [Expandable overloadings]</span><span>
</span><a name="line-1148"></a><span>  </span><span class="hs-comment">-- This incidentally picks up the (n_val_args = 0) case</span><span>
</span><a name="line-1149"></a><span>     </span><a name="local-1627735458"><a href="#local-1627735458"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1150"></a><span>     </span><span class="hs-identifier">go</span><span> </span><a name="local-1627735459"><a href="#local-1627735459"><span class="hs-identifier">n_val_args</span></a></a><span> </span><a name="local-1627735460"><a href="#local-1627735460"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-1151"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1627735461"><a href="#local-1627735461"><span class="hs-identifier">bndr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627735462"><a href="#local-1627735462"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitPiTy_maybe"><span class="hs-identifier hs-var">splitPiTy_maybe</span></a><span> </span><a href="#local-1627735460"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1152"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#caseBinder"><span class="hs-identifier hs-var">caseBinder</span></a><span> </span><a href="#local-1627735461"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-1153"></a><span>           </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-1627735463"><a href="#local-1627735463"><span class="hs-identifier">_tv</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627735458"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735459"><span class="hs-identifier hs-var">n_val_args</span></a><span> </span><a href="#local-1627735462"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1154"></a><span>           </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-1627735464"><a href="#local-1627735464"><span class="hs-identifier">bndr_ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Type.html#isPredTy"><span class="hs-identifier hs-var">isPredTy</span></a><span> </span><a href="#local-1627735464"><span class="hs-identifier hs-var">bndr_ty</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-1627735458"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627735459"><span class="hs-identifier hs-var">n_val_args</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-1627735462"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1155"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1156"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1157"></a><span>
</span><a name="line-1158"></a><span class="hs-comment">{-
Note [Expandable overloadings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose the user wrote this
   {-# RULE  forall x. foo (negate x) = h x #-}
   f x = ....(foo (negate x))....
He'd expect the rule to fire. But since negate is overloaded, we might
get this:
    f = \d -&gt; let n = negate d in \x -&gt; ...foo (n x)...
So we treat the application of a function (negate in this case) to a
*dictionary* as expandable.  In effect, every function is CONLIKE when
it's applied only to dictionaries.


************************************************************************
*                                                                      *
             exprOkForSpeculation
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1178"></a><span>
</span><a name="line-1179"></a><span class="hs-comment">-----------------------------</span><span>
</span><a name="line-1180"></a><span class="hs-comment">-- | 'exprOkForSpeculation' returns True of an expression that is:</span><span>
</span><a name="line-1181"></a><span class="hs-comment">--</span><span>
</span><a name="line-1182"></a><span class="hs-comment">--  * Safe to evaluate even if normal order eval might not</span><span>
</span><a name="line-1183"></a><span class="hs-comment">--    evaluate the expression at all, or</span><span>
</span><a name="line-1184"></a><span class="hs-comment">--</span><span>
</span><a name="line-1185"></a><span class="hs-comment">--  * Safe /not/ to evaluate even if normal order would do so</span><span>
</span><a name="line-1186"></a><span class="hs-comment">--</span><span>
</span><a name="line-1187"></a><span class="hs-comment">-- It is usually called on arguments of unlifted type, but not always</span><span>
</span><a name="line-1188"></a><span class="hs-comment">-- In particular, Simplify.rebuildCase calls it on lifted types</span><span>
</span><a name="line-1189"></a><span class="hs-comment">-- when a 'case' is a plain 'seq'. See the example in</span><span>
</span><a name="line-1190"></a><span class="hs-comment">-- Note [exprOkForSpeculation: case expressions] below</span><span>
</span><a name="line-1191"></a><span class="hs-comment">--</span><span>
</span><a name="line-1192"></a><span class="hs-comment">-- Precisely, it returns @True@ iff:</span><span>
</span><a name="line-1193"></a><span class="hs-comment">--  a) The expression guarantees to terminate,</span><span>
</span><a name="line-1194"></a><span class="hs-comment">--  b) soon,</span><span>
</span><a name="line-1195"></a><span class="hs-comment">--  c) without causing a write side effect (e.g. writing a mutable variable)</span><span>
</span><a name="line-1196"></a><span class="hs-comment">--  d) without throwing a Haskell exception</span><span>
</span><a name="line-1197"></a><span class="hs-comment">--  e) without risking an unchecked runtime exception (array out of bounds,</span><span>
</span><a name="line-1198"></a><span class="hs-comment">--     divide by zero)</span><span>
</span><a name="line-1199"></a><span class="hs-comment">--</span><span>
</span><a name="line-1200"></a><span class="hs-comment">-- For @exprOkForSideEffects@ the list is the same, but omitting (e).</span><span>
</span><a name="line-1201"></a><span class="hs-comment">--</span><span>
</span><a name="line-1202"></a><span class="hs-comment">-- Note that</span><span>
</span><a name="line-1203"></a><span class="hs-comment">--    exprIsHNF            implies exprOkForSpeculation</span><span>
</span><a name="line-1204"></a><span class="hs-comment">--    exprOkForSpeculation implies exprOkForSideEffects</span><span>
</span><a name="line-1205"></a><span class="hs-comment">--</span><span>
</span><a name="line-1206"></a><span class="hs-comment">-- See Note [PrimOp can_fail and has_side_effects] in PrimOp</span><span>
</span><a name="line-1207"></a><span class="hs-comment">-- and Note [Implementation: how can_fail/has_side_effects affect transformations]</span><span>
</span><a name="line-1208"></a><span class="hs-comment">--</span><span>
</span><a name="line-1209"></a><span class="hs-comment">-- As an example of the considerations in this test, consider:</span><span>
</span><a name="line-1210"></a><span class="hs-comment">--</span><span>
</span><a name="line-1211"></a><span class="hs-comment">-- &gt; let x = case y# +# 1# of { r# -&gt; I# r# }</span><span>
</span><a name="line-1212"></a><span class="hs-comment">-- &gt; in E</span><span>
</span><a name="line-1213"></a><span class="hs-comment">--</span><span>
</span><a name="line-1214"></a><span class="hs-comment">-- being translated to:</span><span>
</span><a name="line-1215"></a><span class="hs-comment">--</span><span>
</span><a name="line-1216"></a><span class="hs-comment">-- &gt; case y# +# 1# of { r# -&gt;</span><span>
</span><a name="line-1217"></a><span class="hs-comment">-- &gt;    let x = I# r#</span><span>
</span><a name="line-1218"></a><span class="hs-comment">-- &gt;    in E</span><span>
</span><a name="line-1219"></a><span class="hs-comment">-- &gt; }</span><span>
</span><a name="line-1220"></a><span class="hs-comment">--</span><span>
</span><a name="line-1221"></a><span class="hs-comment">-- We can only do this if the @y + 1@ is ok for speculation: it has no</span><span>
</span><a name="line-1222"></a><span class="hs-comment">-- side effects, and can't diverge or raise an exception.</span><span>
</span><a name="line-1223"></a><span class="hs-identifier">exprOkForSpeculation</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">exprOkForSideEffects</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-1627735057"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1224"></a><a name="exprOkForSpeculation"><a href="CoreUtils.html#exprOkForSpeculation"><span class="hs-identifier">exprOkForSpeculation</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#expr_ok"><span class="hs-identifier hs-var">expr_ok</span></a><span> </span><a href="PrimOp.html#primOpOkForSpeculation"><span class="hs-identifier hs-var">primOpOkForSpeculation</span></a><span>
</span><a name="line-1225"></a><a name="exprOkForSideEffects"><a href="CoreUtils.html#exprOkForSideEffects"><span class="hs-identifier">exprOkForSideEffects</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#expr_ok"><span class="hs-identifier hs-var">expr_ok</span></a><span> </span><a href="PrimOp.html#primOpOkForSideEffects"><span class="hs-identifier hs-var">primOpOkForSideEffects</span></a><span>
</span><a name="line-1226"></a><span>  </span><span class="hs-comment">-- Polymorphic in binder type</span><span>
</span><a name="line-1227"></a><span>  </span><span class="hs-comment">-- There is one call at a non-Id binder type, in SetLevels</span><span>
</span><a name="line-1228"></a><span>
</span><a name="line-1229"></a><span class="hs-identifier">expr_ok</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="PrimOp.html#PrimOp"><span class="hs-identifier hs-type">PrimOp</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-1627735056"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1230"></a><a name="expr_ok"><a href="CoreUtils.html#expr_ok"><span class="hs-identifier">expr_ok</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1231"></a><span class="hs-identifier">expr_ok</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1232"></a><span class="hs-identifier">expr_ok</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1233"></a><span class="hs-identifier">expr_ok</span><span> </span><a name="local-1627735465"><a href="#local-1627735465"><span class="hs-identifier">primop_ok</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-1627735466"><a href="#local-1627735466"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#app_ok"><span class="hs-identifier hs-var">app_ok</span></a><span> </span><a href="#local-1627735465"><span class="hs-identifier hs-var">primop_ok</span></a><span> </span><a href="#local-1627735466"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1234"></a><span class="hs-identifier">expr_ok</span><span> </span><a name="local-1627735467"><a href="#local-1627735467"><span class="hs-identifier">primop_ok</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-1627735468"><a href="#local-1627735468"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#expr_ok"><span class="hs-identifier hs-var">expr_ok</span></a><span> </span><a href="#local-1627735467"><span class="hs-identifier hs-var">primop_ok</span></a><span> </span><a href="#local-1627735468"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1235"></a><span>
</span><a name="line-1236"></a><span class="hs-comment">-- Tick annotations that *tick* cannot be speculated, because these</span><span>
</span><a name="line-1237"></a><span class="hs-comment">-- are meant to identify whether or not (and how often) the particular</span><span>
</span><a name="line-1238"></a><span class="hs-comment">-- source expression was evaluated at runtime.</span><span>
</span><a name="line-1239"></a><span class="hs-identifier">expr_ok</span><span> </span><a name="local-1627735469"><a href="#local-1627735469"><span class="hs-identifier">primop_ok</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-1627735470"><a href="#local-1627735470"><span class="hs-identifier">tickish</span></a></a><span> </span><a name="local-1627735471"><a href="#local-1627735471"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1240"></a><span>   </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#tickishCounts"><span class="hs-identifier hs-var">tickishCounts</span></a><span> </span><a href="#local-1627735470"><span class="hs-identifier hs-var">tickish</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1241"></a><span>   </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>             </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#expr_ok"><span class="hs-identifier hs-var">expr_ok</span></a><span> </span><a href="#local-1627735469"><span class="hs-identifier hs-var">primop_ok</span></a><span> </span><a href="#local-1627735471"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1242"></a><span>
</span><a name="line-1243"></a><span class="hs-identifier">expr_ok</span><span> </span><a name="local-1627735472"><a href="#local-1627735472"><span class="hs-identifier">primop_ok</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Case"><span class="hs-identifier hs-var">Case</span></a><span> </span><a name="local-1627735473"><a href="#local-1627735473"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627735474"><a href="#local-1627735474"><span class="hs-identifier">alts</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1244"></a><span>  </span><span class="hs-glyph">=</span><span>  </span><a href="CoreUtils.html#expr_ok"><span class="hs-identifier hs-var">expr_ok</span></a><span> </span><a href="#local-1627735472"><span class="hs-identifier hs-var">primop_ok</span></a><span> </span><a href="#local-1627735473"><span class="hs-identifier hs-var">e</span></a><span>  </span><span class="hs-comment">-- Note [exprOkForSpeculation: case expressions]</span><span>
</span><a name="line-1245"></a><span>  </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-1627735475"><a href="#local-1627735475"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreUtils.html#expr_ok"><span class="hs-identifier hs-var">expr_ok</span></a><span> </span><a href="#local-1627735472"><span class="hs-identifier hs-var">primop_ok</span></a><span> </span><a href="#local-1627735475"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735474"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-1246"></a><span>  </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="CoreUtils.html#altsAreExhaustive"><span class="hs-identifier hs-var">altsAreExhaustive</span></a><span> </span><a href="#local-1627735474"><span class="hs-identifier hs-var">alts</span></a><span>     </span><span class="hs-comment">-- Note [Exhaustive alts]</span><span>
</span><a name="line-1247"></a><span>
</span><a name="line-1248"></a><span class="hs-identifier">expr_ok</span><span> </span><a name="local-1627735476"><a href="#local-1627735476"><span class="hs-identifier">primop_ok</span></a></a><span> </span><a name="local-1627735477"><a href="#local-1627735477"><span class="hs-identifier">other_expr</span></a></a><span>
</span><a name="line-1249"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="CoreSyn.html#collectArgs"><span class="hs-identifier hs-var">collectArgs</span></a><span> </span><a href="#local-1627735477"><span class="hs-identifier hs-var">other_expr</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1250"></a><span>        </span><span class="hs-special">(</span><a name="local-1627735478"><a href="#local-1627735478"><span class="hs-identifier">expr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627735479"><a href="#local-1627735479"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-1627735480"><a href="#local-1627735480"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreUtils.html#stripTicksTopE"><span class="hs-identifier hs-var">stripTicksTopE</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="CoreSyn.html#tickishCounts"><span class="hs-identifier hs-var">tickishCounts</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735478"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-1251"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreUtils.html#app_ok"><span class="hs-identifier hs-var">app_ok</span></a><span> </span><a href="#local-1627735476"><span class="hs-identifier hs-var">primop_ok</span></a><span> </span><a href="#local-1627735480"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-1627735479"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1252"></a><span>        </span><span class="hs-identifier">_</span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1253"></a><span>
</span><a name="line-1254"></a><span class="hs-comment">-----------------------------</span><span>
</span><a name="line-1255"></a><span class="hs-identifier">app_ok</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="PrimOp.html#PrimOp"><span class="hs-identifier hs-type">PrimOp</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-1627735055"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1256"></a><a name="app_ok"><a href="CoreUtils.html#app_ok"><span class="hs-identifier">app_ok</span></a></a><span> </span><a name="local-1627735481"><a href="#local-1627735481"><span class="hs-identifier">primop_ok</span></a></a><span> </span><a name="local-1627735482"><a href="#local-1627735482"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-1627735483"><a href="#local-1627735483"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-1257"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Var.html#idDetails"><span class="hs-identifier hs-var">idDetails</span></a><span> </span><a href="#local-1627735482"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1258"></a><span>      </span><a href="IdInfo.html#DFunId"><span class="hs-identifier hs-var">DFunId</span></a><span> </span><a name="local-1627735484"><a href="#local-1627735484"><span class="hs-identifier">new_type</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>  </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-1627735484"><span class="hs-identifier hs-var">new_type</span></a><span>
</span><a name="line-1259"></a><span>         </span><span class="hs-comment">-- DFuns terminate, unless the dict is implemented</span><span>
</span><a name="line-1260"></a><span>         </span><span class="hs-comment">-- with a newtype in which case they may not</span><span>
</span><a name="line-1261"></a><span>
</span><a name="line-1262"></a><span>      </span><a href="IdInfo.html#DataConWorkId"><span class="hs-identifier hs-var">DataConWorkId</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1263"></a><span>                </span><span class="hs-comment">-- The strictness of the constructor has already</span><span>
</span><a name="line-1264"></a><span>                </span><span class="hs-comment">-- been expressed by its &quot;wrapper&quot;, so we don't need</span><span>
</span><a name="line-1265"></a><span>                </span><span class="hs-comment">-- to take the arguments into account</span><span>
</span><a name="line-1266"></a><span>
</span><a name="line-1267"></a><span>      </span><a href="IdInfo.html#PrimOpId"><span class="hs-identifier hs-var">PrimOpId</span></a><span> </span><a name="local-1627735485"><a href="#local-1627735485"><span class="hs-identifier">op</span></a></a><span>
</span><a name="line-1268"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="CoreUtils.html#isDivOp"><span class="hs-identifier hs-var">isDivOp</span></a><span> </span><a href="#local-1627735485"><span class="hs-identifier hs-var">op</span></a><span>              </span><span class="hs-comment">-- Special case for dividing operations that fail</span><span>
</span><a name="line-1269"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a name="local-1627735486"><a href="#local-1627735486"><span class="hs-identifier">arg1</span></a></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><a name="local-1627735487"><a href="#local-1627735487"><span class="hs-identifier">lit</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627735483"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-comment">-- only if the divisor is zero</span><span>
</span><a name="line-1270"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Literal.html#isZeroLit"><span class="hs-identifier hs-var">isZeroLit</span></a><span> </span><a href="#local-1627735487"><span class="hs-identifier hs-var">lit</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="CoreUtils.html#expr_ok"><span class="hs-identifier hs-var">expr_ok</span></a><span> </span><a href="#local-1627735481"><span class="hs-identifier hs-var">primop_ok</span></a><span> </span><a href="#local-1627735486"><span class="hs-identifier hs-var">arg1</span></a><span>
</span><a name="line-1271"></a><span>                  </span><span class="hs-comment">-- Often there is a literal divisor, and this</span><span>
</span><a name="line-1272"></a><span>                  </span><span class="hs-comment">-- can get rid of a thunk in an inner looop</span><span>
</span><a name="line-1273"></a><span>
</span><a name="line-1274"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="PrimOp.html#DataToTagOp"><span class="hs-identifier hs-var">DataToTagOp</span></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627735485"><span class="hs-identifier hs-var">op</span></a><span>      </span><span class="hs-comment">-- See Note [dataToTag speculation]</span><span>
</span><a name="line-1275"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1276"></a><span>
</span><a name="line-1277"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1278"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627735481"><span class="hs-identifier hs-var">primop_ok</span></a><span> </span><a href="#local-1627735485"><span class="hs-identifier hs-var">op</span></a><span>                   </span><span class="hs-comment">-- A bit conservative: we don't really need</span><span>
</span><a name="line-1279"></a><span>        </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a><span> </span><span class="hs-special">(</span><a href="CoreUtils.html#expr_ok"><span class="hs-identifier hs-var">expr_ok</span></a><span> </span><a href="#local-1627735481"><span class="hs-identifier hs-var">primop_ok</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735483"><span class="hs-identifier hs-var">args</span></a><span>   </span><span class="hs-comment">-- to care about lazy arguments, but this is easy</span><span>
</span><a name="line-1280"></a><span>
</span><a name="line-1281"></a><span>      </span><a name="local-1627735488"><a href="#local-1627735488"><span class="hs-identifier">_other</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Type.html#isUnliftedType"><span class="hs-identifier hs-var">isUnliftedType</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idType"><span class="hs-identifier hs-var">idType</span></a><span> </span><a href="#local-1627735482"><span class="hs-identifier hs-var">fun</span></a><span class="hs-special">)</span><span>          </span><span class="hs-comment">-- c.f. the Var case of exprIsHNF</span><span>
</span><a name="line-1282"></a><span>             </span><span class="hs-operator hs-var">||</span><span> </span><a href="Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a><span> </span><a href="#local-1627735482"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="#local-1627735489"><span class="hs-identifier hs-var">n_val_args</span></a><span>             </span><span class="hs-comment">-- Partial apps</span><span>
</span><a name="line-1283"></a><span>             </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-special">(</span><a href="#local-1627735489"><span class="hs-identifier hs-var">n_val_args</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-1284"></a><span>                 </span><a href="CoreSyn.html#isEvaldUnfolding"><span class="hs-identifier hs-var">isEvaldUnfolding</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idUnfolding"><span class="hs-identifier hs-var">idUnfolding</span></a><span> </span><a href="#local-1627735482"><span class="hs-identifier hs-var">fun</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Let-bound values</span><span>
</span><a name="line-1285"></a><span>             </span><span class="hs-keyword">where</span><span>
</span><a name="line-1286"></a><span>               </span><a name="local-1627735489"><a href="#local-1627735489"><span class="hs-identifier">n_val_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#valArgCount"><span class="hs-identifier hs-var">valArgCount</span></a><span> </span><a href="#local-1627735483"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1287"></a><span>
</span><a name="line-1288"></a><span class="hs-comment">-----------------------------</span><span>
</span><a name="line-1289"></a><span class="hs-identifier">altsAreExhaustive</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#Alt"><span class="hs-identifier hs-type">Alt</span></a><span> </span><a href="#local-1627735054"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1290"></a><span class="hs-comment">-- True  &lt;=&gt; the case alternatives are definiely exhaustive</span><span>
</span><a name="line-1291"></a><span class="hs-comment">-- False &lt;=&gt; they may or may not be</span><span>
</span><a name="line-1292"></a><a name="altsAreExhaustive"><a href="CoreUtils.html#altsAreExhaustive"><span class="hs-identifier">altsAreExhaustive</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1293"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>    </span><span class="hs-comment">-- Should not happen</span><span>
</span><a name="line-1294"></a><span class="hs-identifier">altsAreExhaustive</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-1627735490"><a href="#local-1627735490"><span class="hs-identifier">con1</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-1627735491"><a href="#local-1627735491"><span class="hs-identifier">alts</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1295"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1627735490"><span class="hs-identifier hs-var">con1</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1296"></a><span>      </span><a href="CoreSyn.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1297"></a><span>      </span><a href="CoreSyn.html#LitAlt"><span class="hs-identifier hs-var">LitAlt</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1298"></a><span>      </span><a href="CoreSyn.html#DataAlt"><span class="hs-identifier hs-var">DataAlt</span></a><span> </span><a name="local-1627735492"><a href="#local-1627735492"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-number">1</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><a href="#local-1627735491"><span class="hs-identifier hs-var">alts</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="TyCon.html#tyConFamilySize"><span class="hs-identifier hs-var">tyConFamilySize</span></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#dataConTyCon"><span class="hs-identifier hs-var">dataConTyCon</span></a><span> </span><a href="#local-1627735492"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span>
</span><a name="line-1299"></a><span>      </span><span class="hs-comment">-- It is possible to have an exhaustive case that does not</span><span>
</span><a name="line-1300"></a><span>      </span><span class="hs-comment">-- enumerate all constructors, notably in a GADT match, but</span><span>
</span><a name="line-1301"></a><span>      </span><span class="hs-comment">-- we behave conservatively here -- I don't think it's important</span><span>
</span><a name="line-1302"></a><span>      </span><span class="hs-comment">-- enough to deserve special treatment</span><span>
</span><a name="line-1303"></a><span>
</span><a name="line-1304"></a><span class="hs-comment">-- | True of dyadic operators that can fail only if the second arg is zero!</span><span>
</span><a name="line-1305"></a><span class="hs-identifier">isDivOp</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="PrimOp.html#PrimOp"><span class="hs-identifier hs-type">PrimOp</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1306"></a><span class="hs-comment">-- This function probably belongs in PrimOp, or even in</span><span>
</span><a name="line-1307"></a><span class="hs-comment">-- an automagically generated file.. but it's such a</span><span>
</span><a name="line-1308"></a><span class="hs-comment">-- special case I thought I'd leave it here for now.</span><span>
</span><a name="line-1309"></a><a name="isDivOp"><a href="CoreUtils.html#isDivOp"><span class="hs-identifier">isDivOp</span></a></a><span> </span><a href="PrimOp.html#IntQuotOp"><span class="hs-identifier hs-var">IntQuotOp</span></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1310"></a><span class="hs-identifier">isDivOp</span><span> </span><a href="PrimOp.html#IntRemOp"><span class="hs-identifier hs-var">IntRemOp</span></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1311"></a><span class="hs-identifier">isDivOp</span><span> </span><a href="PrimOp.html#WordQuotOp"><span class="hs-identifier hs-var">WordQuotOp</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1312"></a><span class="hs-identifier">isDivOp</span><span> </span><a href="PrimOp.html#WordRemOp"><span class="hs-identifier hs-var">WordRemOp</span></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1313"></a><span class="hs-identifier">isDivOp</span><span> </span><a href="PrimOp.html#FloatDivOp"><span class="hs-identifier hs-var">FloatDivOp</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1314"></a><span class="hs-identifier">isDivOp</span><span> </span><a href="PrimOp.html#DoubleDivOp"><span class="hs-identifier hs-var">DoubleDivOp</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1315"></a><span class="hs-identifier">isDivOp</span><span> </span><span class="hs-identifier">_</span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1316"></a><span>
</span><a name="line-1317"></a><span class="hs-comment">{-
Note [exprOkForSpeculation: case expressions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It's always sound for exprOkForSpeculation to return False, and we
don't want it to take too long, so it bales out on complicated-looking
terms.  Notably lets, which can be stacked very deeply; and in any
case the argument of exprOkForSpeculation is usually in a strict context,
so any lets will have been floated away.

However, we keep going on case-expressions.  An example like this one
showed up in DPH code (Trac #3717):
    foo :: Int -&gt; Int
    foo 0 = 0
    foo n = (if n &lt; 5 then 1 else 2) `seq` foo (n-1)

If exprOkForSpeculation doesn't look through case expressions, you get this:
    T.$wfoo =
      \ (ww :: GHC.Prim.Int#) -&gt;
        case ww of ds {
          __DEFAULT -&gt; case (case &lt;# ds 5 of _ {
                          GHC.Types.False -&gt; lvl1;
                          GHC.Types.True -&gt; lvl})
                       of _ { __DEFAULT -&gt;
                       T.$wfoo (GHC.Prim.-# ds_XkE 1) };
          0 -&gt; 0
        }

The inner case is redundant, and should be nuked.

Note [Exhaustive alts]
~~~~~~~~~~~~~~~~~~~~~~
We might have something like
  case x of {
    A -&gt; ...
    _ -&gt; ...(case x of { B -&gt; ...; C -&gt; ... })...
Here, the inner case is fine, because the A alternative
can't happen, but it's not ok to float the inner case outside
the outer one (even if we know x is evaluated outside), because
then it would be non-exhaustive. See Trac #5453.

Similarly, this is a valid program (albeit a slightly dodgy one)
   let v = case x of { B -&gt; ...; C -&gt; ... }
   in case x of
         A -&gt; ...
         _ -&gt;  ...v...v....
But we don't want to speculate the v binding.

One could try to be clever, but the easy fix is simpy to regard
a non-exhaustive case as *not* okForSpeculation.


Note [dataToTag speculation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Is this OK?
   f x = let v::Int# = dataToTag# x
         in ...
We say &quot;yes&quot;, even though 'x' may not be evaluated.  Reasons

  * dataToTag#'s strictness means that its argument often will be
    evaluated, but FloatOut makes that temporarily untrue
         case x of y -&gt; let v = dataToTag# y in ...
    --&gt;
         case x of y -&gt; let v = dataToTag# x in ...
    Note that we look at 'x' instead of 'y' (this is to improve
    floating in FloatOut).  So Lint complains.

    Moreover, it really *might* improve floating to let the
    v-binding float out

  * CorePrep makes sure dataToTag#'s argument is evaluated, just
    before code gen.  Until then, it's not guaranteed


************************************************************************
*                                                                      *
             exprIsHNF, exprIsConLike
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1396"></a><span>
</span><a name="line-1397"></a><span class="hs-comment">-- Note [exprIsHNF]             See also Note [exprIsCheap and exprIsHNF]</span><span>
</span><a name="line-1398"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-1399"></a><span class="hs-comment">-- | exprIsHNF returns true for expressions that are certainly /already/</span><span>
</span><a name="line-1400"></a><span class="hs-comment">-- evaluated to /head/ normal form.  This is used to decide whether it's ok</span><span>
</span><a name="line-1401"></a><span class="hs-comment">-- to change:</span><span>
</span><a name="line-1402"></a><span class="hs-comment">--</span><span>
</span><a name="line-1403"></a><span class="hs-comment">-- &gt; case x of _ -&gt; e</span><span>
</span><a name="line-1404"></a><span class="hs-comment">--</span><span>
</span><a name="line-1405"></a><span class="hs-comment">--    into:</span><span>
</span><a name="line-1406"></a><span class="hs-comment">--</span><span>
</span><a name="line-1407"></a><span class="hs-comment">-- &gt; e</span><span>
</span><a name="line-1408"></a><span class="hs-comment">--</span><span>
</span><a name="line-1409"></a><span class="hs-comment">-- and to decide whether it's safe to discard a 'seq'.</span><span>
</span><a name="line-1410"></a><span class="hs-comment">--</span><span>
</span><a name="line-1411"></a><span class="hs-comment">-- So, it does /not/ treat variables as evaluated, unless they say they are.</span><span>
</span><a name="line-1412"></a><span class="hs-comment">-- However, it /does/ treat partial applications and constructor applications</span><span>
</span><a name="line-1413"></a><span class="hs-comment">-- as values, even if their arguments are non-trivial, provided the argument</span><span>
</span><a name="line-1414"></a><span class="hs-comment">-- type is lifted. For example, both of these are values:</span><span>
</span><a name="line-1415"></a><span class="hs-comment">--</span><span>
</span><a name="line-1416"></a><span class="hs-comment">-- &gt; (:) (f x) (map f xs)</span><span>
</span><a name="line-1417"></a><span class="hs-comment">-- &gt; map (...redex...)</span><span>
</span><a name="line-1418"></a><span class="hs-comment">--</span><span>
</span><a name="line-1419"></a><span class="hs-comment">-- because 'seq' on such things completes immediately.</span><span>
</span><a name="line-1420"></a><span class="hs-comment">--</span><span>
</span><a name="line-1421"></a><span class="hs-comment">-- For unlifted argument types, we have to be careful:</span><span>
</span><a name="line-1422"></a><span class="hs-comment">--</span><span>
</span><a name="line-1423"></a><span class="hs-comment">-- &gt; C (f x :: Int#)</span><span>
</span><a name="line-1424"></a><span class="hs-comment">--</span><span>
</span><a name="line-1425"></a><span class="hs-comment">-- Suppose @f x@ diverges; then @C (f x)@ is not a value. However this can't</span><span>
</span><a name="line-1426"></a><span class="hs-comment">-- happen: see &quot;CoreSyn#let_app_invariant&quot;. This invariant states that arguments of</span><span>
</span><a name="line-1427"></a><span class="hs-comment">-- unboxed type must be ok-for-speculation (or trivial).</span><span>
</span><a name="line-1428"></a><span class="hs-identifier">exprIsHNF</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>           </span><span class="hs-comment">-- True =&gt; Value-lambda, constructor, PAP</span><span>
</span><a name="line-1429"></a><a name="exprIsHNF"><a href="CoreUtils.html#exprIsHNF"><span class="hs-identifier">exprIsHNF</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#exprIsHNFlike"><span class="hs-identifier hs-var">exprIsHNFlike</span></a><span> </span><a href="Id.html#isDataConWorkId"><span class="hs-identifier hs-var">isDataConWorkId</span></a><span> </span><a href="CoreSyn.html#isEvaldUnfolding"><span class="hs-identifier hs-var">isEvaldUnfolding</span></a><span>
</span><a name="line-1430"></a><span>
</span><a name="line-1431"></a><span class="hs-comment">-- | Similar to 'exprIsHNF' but includes CONLIKE functions as well as</span><span>
</span><a name="line-1432"></a><span class="hs-comment">-- data constructors. Conlike arguments are considered interesting by the</span><span>
</span><a name="line-1433"></a><span class="hs-comment">-- inliner.</span><span>
</span><a name="line-1434"></a><span class="hs-identifier">exprIsConLike</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>       </span><span class="hs-comment">-- True =&gt; lambda, conlike, PAP</span><span>
</span><a name="line-1435"></a><a name="exprIsConLike"><a href="CoreUtils.html#exprIsConLike"><span class="hs-identifier">exprIsConLike</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#exprIsHNFlike"><span class="hs-identifier hs-var">exprIsHNFlike</span></a><span> </span><a href="Id.html#isConLikeId"><span class="hs-identifier hs-var">isConLikeId</span></a><span> </span><a href="CoreSyn.html#isConLikeUnfolding"><span class="hs-identifier hs-var">isConLikeUnfolding</span></a><span>
</span><a name="line-1436"></a><span>
</span><a name="line-1437"></a><span class="hs-comment">-- | Returns true for values or value-like expressions. These are lambdas,</span><span>
</span><a name="line-1438"></a><span class="hs-comment">-- constructors / CONLIKE functions (as determined by the function argument)</span><span>
</span><a name="line-1439"></a><span class="hs-comment">-- or PAPs.</span><span>
</span><a name="line-1440"></a><span class="hs-comment">--</span><span>
</span><a name="line-1441"></a><span class="hs-identifier">exprIsHNFlike</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1442"></a><a name="exprIsHNFlike"><a href="CoreUtils.html#exprIsHNFlike"><span class="hs-identifier">exprIsHNFlike</span></a></a><span> </span><a name="local-1627735493"><a href="#local-1627735493"><span class="hs-identifier">is_con</span></a></a><span> </span><a name="local-1627735494"><a href="#local-1627735494"><span class="hs-identifier">is_con_unf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735495"><span class="hs-identifier hs-var">is_hnf_like</span></a><span>
</span><a name="line-1443"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1444"></a><span>    </span><a name="local-1627735495"><a href="#local-1627735495"><span class="hs-identifier">is_hnf_like</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-1627735497"><a href="#local-1627735497"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- NB: There are no value args at this point</span><span>
</span><a name="line-1445"></a><span>      </span><span class="hs-glyph">=</span><span>  </span><a href="#local-1627735493"><span class="hs-identifier hs-var">is_con</span></a><span> </span><a href="#local-1627735497"><span class="hs-identifier hs-var">v</span></a><span>       </span><span class="hs-comment">-- Catches nullary constructors,</span><span>
</span><a name="line-1446"></a><span>                        </span><span class="hs-comment">--      so that [] and () are values, for example</span><span>
</span><a name="line-1447"></a><span>      </span><span class="hs-operator hs-var">||</span><span> </span><a href="Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a><span> </span><a href="#local-1627735497"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span>  </span><span class="hs-comment">-- Catches (e.g.) primops that don't have unfoldings</span><span>
</span><a name="line-1448"></a><span>      </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-1627735494"><span class="hs-identifier hs-var">is_con_unf</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idUnfolding"><span class="hs-identifier hs-var">idUnfolding</span></a><span> </span><a href="#local-1627735497"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-1449"></a><span>        </span><span class="hs-comment">-- Check the thing's unfolding; it might be bound to a value</span><span>
</span><a name="line-1450"></a><span>        </span><span class="hs-comment">-- We don't look through loop breakers here, which is a bit conservative</span><span>
</span><a name="line-1451"></a><span>        </span><span class="hs-comment">-- but otherwise I worry that if an Id's unfolding is just itself,</span><span>
</span><a name="line-1452"></a><span>        </span><span class="hs-comment">-- we could get an infinite loop</span><span>
</span><a name="line-1453"></a><span>
</span><a name="line-1454"></a><span>    </span><span class="hs-identifier">is_hnf_like</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1455"></a><span>    </span><span class="hs-identifier">is_hnf_like</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>       </span><span class="hs-comment">-- Types are honorary Values;</span><span>
</span><a name="line-1456"></a><span>                                              </span><span class="hs-comment">-- we don't mind copying them</span><span>
</span><a name="line-1457"></a><span>    </span><span class="hs-identifier">is_hnf_like</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>       </span><span class="hs-comment">-- Same for coercions</span><span>
</span><a name="line-1458"></a><span>    </span><span class="hs-identifier">is_hnf_like</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a name="local-1627735498"><a href="#local-1627735498"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-1627735499"><a href="#local-1627735499"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#isRuntimeVar"><span class="hs-identifier hs-var">isRuntimeVar</span></a><span> </span><a href="#local-1627735498"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-1627735495"><span class="hs-identifier hs-var">is_hnf_like</span></a><span> </span><a href="#local-1627735499"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1459"></a><span>    </span><span class="hs-identifier">is_hnf_like</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-1627735500"><a href="#local-1627735500"><span class="hs-identifier">tickish</span></a></a><span> </span><a name="local-1627735501"><a href="#local-1627735501"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#tickishCounts"><span class="hs-identifier hs-var">tickishCounts</span></a><span> </span><a href="#local-1627735500"><span class="hs-identifier hs-var">tickish</span></a><span class="hs-special">)</span><span>
</span><a name="line-1460"></a><span>                                      </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-1627735495"><span class="hs-identifier hs-var">is_hnf_like</span></a><span> </span><a href="#local-1627735501"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1461"></a><span>                                      </span><span class="hs-comment">-- See Note [exprIsHNF Tick]</span><span>
</span><a name="line-1462"></a><span>    </span><span class="hs-identifier">is_hnf_like</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-1627735502"><a href="#local-1627735502"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735495"><span class="hs-identifier hs-var">is_hnf_like</span></a><span> </span><a href="#local-1627735502"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1463"></a><span>    </span><span class="hs-identifier">is_hnf_like</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-1627735503"><a href="#local-1627735503"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-1627735504"><a href="#local-1627735504"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1464"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#isValArg"><span class="hs-identifier hs-var">isValArg</span></a><span> </span><a href="#local-1627735504"><span class="hs-identifier hs-var">a</span></a><span>               </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735496"><span class="hs-identifier hs-var">app_is_value</span></a><span> </span><a href="#local-1627735503"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-number">1</span><span>
</span><a name="line-1465"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>                </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735495"><span class="hs-identifier hs-var">is_hnf_like</span></a><span> </span><a href="#local-1627735503"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1466"></a><span>    </span><span class="hs-identifier">is_hnf_like</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627735505"><a href="#local-1627735505"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735495"><span class="hs-identifier hs-var">is_hnf_like</span></a><span> </span><a href="#local-1627735505"><span class="hs-identifier hs-var">e</span></a><span>  </span><span class="hs-comment">-- Lazy let(rec)s don't affect us</span><span>
</span><a name="line-1467"></a><span>    </span><span class="hs-identifier">is_hnf_like</span><span> </span><span class="hs-identifier">_</span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1468"></a><span>
</span><a name="line-1469"></a><span>    </span><span class="hs-comment">-- There is at least one value argument</span><span>
</span><a name="line-1470"></a><span>    </span><span class="hs-comment">-- 'n' is number of value args to which the expression is applied</span><span>
</span><a name="line-1471"></a><span>    </span><span class="hs-identifier">app_is_value</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1472"></a><span>    </span><a name="local-1627735496"><a href="#local-1627735496"><span class="hs-identifier">app_is_value</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-1627735506"><a href="#local-1627735506"><span class="hs-identifier">fun</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627735507"><a href="#local-1627735507"><span class="hs-identifier">n_val_args</span></a></a><span>
</span><a name="line-1473"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a><span> </span><a href="#local-1627735506"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="#local-1627735507"><span class="hs-identifier hs-var">n_val_args</span></a><span>    </span><span class="hs-comment">-- Under-applied function</span><span>
</span><a name="line-1474"></a><span>        </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-1627735493"><span class="hs-identifier hs-var">is_con</span></a><span> </span><a href="#local-1627735506"><span class="hs-identifier hs-var">fun</span></a><span>               </span><span class="hs-comment">--  or constructor-like</span><span>
</span><a name="line-1475"></a><span>    </span><span class="hs-identifier">app_is_value</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627735508"><a href="#local-1627735508"><span class="hs-identifier">f</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627735509"><a href="#local-1627735509"><span class="hs-identifier">nva</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735496"><span class="hs-identifier hs-var">app_is_value</span></a><span> </span><a href="#local-1627735508"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-1627735509"><span class="hs-identifier hs-var">nva</span></a><span>
</span><a name="line-1476"></a><span>    </span><span class="hs-identifier">app_is_value</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-1627735510"><a href="#local-1627735510"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-1627735511"><a href="#local-1627735511"><span class="hs-identifier">nva</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735496"><span class="hs-identifier hs-var">app_is_value</span></a><span> </span><a href="#local-1627735510"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-1627735511"><span class="hs-identifier hs-var">nva</span></a><span>
</span><a name="line-1477"></a><span>    </span><span class="hs-identifier">app_is_value</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-1627735512"><a href="#local-1627735512"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-1627735513"><a href="#local-1627735513"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span>  </span><a name="local-1627735514"><a href="#local-1627735514"><span class="hs-identifier">nva</span></a></a><span>
</span><a name="line-1478"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#isValArg"><span class="hs-identifier hs-var">isValArg</span></a><span> </span><a href="#local-1627735513"><span class="hs-identifier hs-var">a</span></a><span>              </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735496"><span class="hs-identifier hs-var">app_is_value</span></a><span> </span><a href="#local-1627735512"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627735514"><span class="hs-identifier hs-var">nva</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-1479"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>               </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735496"><span class="hs-identifier hs-var">app_is_value</span></a><span> </span><a href="#local-1627735512"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-1627735514"><span class="hs-identifier hs-var">nva</span></a><span>
</span><a name="line-1480"></a><span>    </span><span class="hs-identifier">app_is_value</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1481"></a><span>
</span><a name="line-1482"></a><span class="hs-comment">{-
Note [exprIsHNF Tick]

We can discard source annotations on HNFs as long as they aren't
tick-like:

  scc c (\x . e)    =&gt;  \x . e
  scc c (C x1..xn)  =&gt;  C x1..xn

So we regard these as HNFs.  Tick annotations that tick are not
regarded as HNF if the expression they surround is HNF, because the
tick is there to tell us that the expression was evaluated, so we
don't want to discard a seq on it.
-}</span><span>
</span><a name="line-1496"></a><span>
</span><a name="line-1497"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
             Instantiating data constructors
*                                                                      *
************************************************************************

These InstPat functions go here to avoid circularity between DataCon and Id
-}</span><span>
</span><a name="line-1506"></a><span>
</span><a name="line-1507"></a><span class="hs-identifier">dataConRepInstPat</span><span>   </span><span class="hs-glyph">::</span><span>                 </span><span class="hs-special">[</span><a href="Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1508"></a><span class="hs-identifier">dataConRepFSInstPat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1509"></a><span>
</span><a name="line-1510"></a><a name="dataConRepInstPat"><a href="CoreUtils.html#dataConRepInstPat"><span class="hs-identifier">dataConRepInstPat</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#dataConInstPat"><span class="hs-identifier hs-var">dataConInstPat</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#repeat"><span class="hs-identifier hs-var">repeat</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="FastString.html#fsLit"><span class="hs-identifier hs-var">fsLit</span></a><span> </span><span class="hs-string">&quot;ipv&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1511"></a><a name="dataConRepFSInstPat"><a href="CoreUtils.html#dataConRepFSInstPat"><span class="hs-identifier">dataConRepFSInstPat</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#dataConInstPat"><span class="hs-identifier hs-var">dataConInstPat</span></a><span>
</span><a name="line-1512"></a><span>
</span><a name="line-1513"></a><span class="hs-identifier">dataConInstPat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span class="hs-special">]</span><span>          </span><span class="hs-comment">-- A long enough list of FSs to use for names</span><span>
</span><a name="line-1514"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a><span class="hs-special">]</span><span>              </span><span class="hs-comment">-- An equally long list of uniques, at least one for each binder</span><span>
</span><a name="line-1515"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span>
</span><a name="line-1516"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>                </span><span class="hs-comment">-- Types to instantiate the universally quantified tyvars</span><span>
</span><a name="line-1517"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>       </span><span class="hs-comment">-- Return instantiated variables</span><span>
</span><a name="line-1518"></a><span class="hs-comment">-- dataConInstPat arg_fun fss us con inst_tys returns a tuple</span><span>
</span><a name="line-1519"></a><span class="hs-comment">-- (ex_tvs, arg_ids),</span><span>
</span><a name="line-1520"></a><span class="hs-comment">--</span><span>
</span><a name="line-1521"></a><span class="hs-comment">--   ex_tvs are intended to be used as binders for existential type args</span><span>
</span><a name="line-1522"></a><span class="hs-comment">--</span><span>
</span><a name="line-1523"></a><span class="hs-comment">--   arg_ids are indended to be used as binders for value arguments,</span><span>
</span><a name="line-1524"></a><span class="hs-comment">--     and their types have been instantiated with inst_tys and ex_tys</span><span>
</span><a name="line-1525"></a><span class="hs-comment">--     The arg_ids include both evidence and</span><span>
</span><a name="line-1526"></a><span class="hs-comment">--     programmer-specified arguments (both after rep-ing)</span><span>
</span><a name="line-1527"></a><span class="hs-comment">--</span><span>
</span><a name="line-1528"></a><span class="hs-comment">-- Example.</span><span>
</span><a name="line-1529"></a><span class="hs-comment">--  The following constructor T1</span><span>
</span><a name="line-1530"></a><span class="hs-comment">--</span><span>
</span><a name="line-1531"></a><span class="hs-comment">--  data T a where</span><span>
</span><a name="line-1532"></a><span class="hs-comment">--    T1 :: forall b. Int -&gt; b -&gt; T(a,b)</span><span>
</span><a name="line-1533"></a><span class="hs-comment">--    ...</span><span>
</span><a name="line-1534"></a><span class="hs-comment">--</span><span>
</span><a name="line-1535"></a><span class="hs-comment">--  has representation type</span><span>
</span><a name="line-1536"></a><span class="hs-comment">--   forall a. forall a1. forall b. (a ~ (a1,b)) =&gt;</span><span>
</span><a name="line-1537"></a><span class="hs-comment">--     Int -&gt; b -&gt; T a</span><span>
</span><a name="line-1538"></a><span class="hs-comment">--</span><span>
</span><a name="line-1539"></a><span class="hs-comment">--  dataConInstPat fss us T1 (a1',b') will return</span><span>
</span><a name="line-1540"></a><span class="hs-comment">--</span><span>
</span><a name="line-1541"></a><span class="hs-comment">--  ([a1'', b''], [c :: (a1', b')~(a1'', b''), x :: Int, y :: b''])</span><span>
</span><a name="line-1542"></a><span class="hs-comment">--</span><span>
</span><a name="line-1543"></a><span class="hs-comment">--  where the double-primed variables are created with the FastStrings and</span><span>
</span><a name="line-1544"></a><span class="hs-comment">--  Uniques given as fss and us</span><span>
</span><a name="line-1545"></a><a name="dataConInstPat"><a href="CoreUtils.html#dataConInstPat"><span class="hs-identifier">dataConInstPat</span></a></a><span> </span><a name="local-1627735515"><a href="#local-1627735515"><span class="hs-identifier">fss</span></a></a><span> </span><a name="local-1627735516"><a href="#local-1627735516"><span class="hs-identifier">uniqs</span></a></a><span> </span><a name="local-1627735517"><a href="#local-1627735517"><span class="hs-identifier">con</span></a></a><span> </span><a name="local-1627735518"><a href="#local-1627735518"><span class="hs-identifier">inst_tys</span></a></a><span>
</span><a name="line-1546"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">univ_tvs</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">equalLength</span><span class="hs-special">`</span><span> </span><a href="Util.html#equalLength"><span class="hs-identifier hs-var">inst_tys</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1547"></a><span>    </span><span class="hs-special">(</span><a href="#local-1627735530"><span class="hs-identifier hs-var">ex_bndrs</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627735532"><span class="hs-identifier hs-var">arg_ids</span></a><span class="hs-special">)</span><span>
</span><a name="line-1548"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1549"></a><span>    </span><a name="local-1627735519"><a href="#local-1627735519"><span class="hs-identifier">univ_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DataCon.html#dataConUnivTyVars"><span class="hs-identifier hs-var">dataConUnivTyVars</span></a><span> </span><a href="#local-1627735517"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-1550"></a><span>    </span><a name="local-1627735520"><a href="#local-1627735520"><span class="hs-identifier">ex_tvs</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="DataCon.html#dataConExTyVars"><span class="hs-identifier hs-var">dataConExTyVars</span></a><span> </span><a href="#local-1627735517"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-1551"></a><span>    </span><a name="local-1627735521"><a href="#local-1627735521"><span class="hs-identifier">arg_tys</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DataCon.html#dataConRepArgTys"><span class="hs-identifier hs-var">dataConRepArgTys</span></a><span> </span><a href="#local-1627735517"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-1552"></a><span>    </span><a name="local-1627735522"><a href="#local-1627735522"><span class="hs-identifier">arg_strs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DataCon.html#dataConRepStrictness"><span class="hs-identifier hs-var">dataConRepStrictness</span></a><span> </span><a href="#local-1627735517"><span class="hs-identifier hs-var">con</span></a><span>  </span><span class="hs-comment">-- 1-1 with arg_tys</span><span>
</span><a name="line-1553"></a><span>    </span><a name="local-1627735523"><a href="#local-1627735523"><span class="hs-identifier">n_ex</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><a href="#local-1627735520"><span class="hs-identifier hs-var">ex_tvs</span></a><span>
</span><a name="line-1554"></a><span>
</span><a name="line-1555"></a><span>      </span><span class="hs-comment">-- split the Uniques and FastStrings</span><span>
</span><a name="line-1556"></a><span>    </span><span class="hs-special">(</span><a name="local-1627735524"><a href="#local-1627735524"><span class="hs-identifier">ex_uniqs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627735525"><a href="#local-1627735525"><span class="hs-identifier">id_uniqs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#splitAt"><span class="hs-identifier hs-var">splitAt</span></a><span> </span><a href="#local-1627735523"><span class="hs-identifier hs-var">n_ex</span></a><span> </span><a href="#local-1627735516"><span class="hs-identifier hs-var">uniqs</span></a><span>
</span><a name="line-1557"></a><span>    </span><span class="hs-special">(</span><a name="local-1627735526"><a href="#local-1627735526"><span class="hs-identifier">ex_fss</span></a></a><span class="hs-special">,</span><span>   </span><a name="local-1627735527"><a href="#local-1627735527"><span class="hs-identifier">id_fss</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#splitAt"><span class="hs-identifier hs-var">splitAt</span></a><span> </span><a href="#local-1627735523"><span class="hs-identifier hs-var">n_ex</span></a><span> </span><a href="#local-1627735515"><span class="hs-identifier hs-var">fss</span></a><span>
</span><a name="line-1558"></a><span>
</span><a name="line-1559"></a><span>      </span><span class="hs-comment">-- Make the instantiating substitution for universals</span><span>
</span><a name="line-1560"></a><span>    </span><a name="local-1627735528"><a href="#local-1627735528"><span class="hs-identifier">univ_subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#zipTvSubst"><span class="hs-identifier hs-var">zipTvSubst</span></a><span> </span><a href="#local-1627735519"><span class="hs-identifier hs-var">univ_tvs</span></a><span> </span><a href="#local-1627735518"><span class="hs-identifier hs-var">inst_tys</span></a><span>
</span><a name="line-1561"></a><span>
</span><a name="line-1562"></a><span>      </span><span class="hs-comment">-- Make existential type variables, applyingn and extending the substitution</span><span>
</span><a name="line-1563"></a><span>    </span><span class="hs-special">(</span><a name="local-1627735529"><a href="#local-1627735529"><span class="hs-identifier">full_subst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627735530"><a href="#local-1627735530"><span class="hs-identifier">ex_bndrs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapAccumL"><span class="hs-identifier hs-var">mapAccumL</span></a><span> </span><a href="#local-1627735531"><span class="hs-identifier hs-var">mk_ex_var</span></a><span> </span><a href="#local-1627735528"><span class="hs-identifier hs-var">univ_subst</span></a><span>
</span><a name="line-1564"></a><span>                                       </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zip3"><span class="hs-identifier hs-var">zip3</span></a><span> </span><a href="#local-1627735520"><span class="hs-identifier hs-var">ex_tvs</span></a><span> </span><a href="#local-1627735526"><span class="hs-identifier hs-var">ex_fss</span></a><span> </span><a href="#local-1627735524"><span class="hs-identifier hs-var">ex_uniqs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1565"></a><span>
</span><a name="line-1566"></a><span>    </span><span class="hs-identifier">mk_ex_var</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-type">TCvSubst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">,</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span class="hs-special">,</span><span> </span><a href="Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-type">TCvSubst</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">)</span><span>
</span><a name="line-1567"></a><span>    </span><a name="local-1627735531"><a href="#local-1627735531"><span class="hs-identifier">mk_ex_var</span></a></a><span> </span><a name="local-1627735534"><a href="#local-1627735534"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1627735535"><a href="#local-1627735535"><span class="hs-identifier">tv</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627735536"><a href="#local-1627735536"><span class="hs-identifier">fs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627735537"><a href="#local-1627735537"><span class="hs-identifier">uniq</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#extendTvSubst"><span class="hs-identifier hs-var">Type</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">extendTvSubst</span></a><span> </span><a href="#local-1627735534"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627735535"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-1568"></a><span>                                       </span><span class="hs-special">(</span><a href="TyCoRep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a><span> </span><a href="#local-1627735538"><span class="hs-identifier hs-var">new_tv</span></a><span class="hs-special">)</span><span>
</span><a name="line-1569"></a><span>                                     </span><span class="hs-special">,</span><span> </span><a href="#local-1627735538"><span class="hs-identifier hs-var">new_tv</span></a><span class="hs-special">)</span><span>
</span><a name="line-1570"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1571"></a><span>        </span><a name="local-1627735538"><a href="#local-1627735538"><span class="hs-identifier">new_tv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#mkTyVar"><span class="hs-identifier hs-var">mkTyVar</span></a><span> </span><span class="hs-special">(</span><a href="Name.html#mkSysTvName"><span class="hs-identifier hs-var">mkSysTvName</span></a><span> </span><a href="#local-1627735537"><span class="hs-identifier hs-var">uniq</span></a><span> </span><a href="#local-1627735536"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735539"><span class="hs-identifier hs-var">kind</span></a><span>
</span><a name="line-1572"></a><span>        </span><a name="local-1627735539"><a href="#local-1627735539"><span class="hs-identifier">kind</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substTyUnchecked"><span class="hs-identifier hs-var">Type</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">substTyUnchecked</span></a><span> </span><a href="#local-1627735534"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a><span> </span><a href="#local-1627735535"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span>
</span><a name="line-1573"></a><span>
</span><a name="line-1574"></a><span>      </span><span class="hs-comment">-- Make value vars, instantiating types</span><span>
</span><a name="line-1575"></a><span>    </span><a name="local-1627735532"><a href="#local-1627735532"><span class="hs-identifier">arg_ids</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.OldList.html#zipWith4"><span class="hs-identifier hs-var">zipWith4</span></a><span> </span><a href="#local-1627735533"><span class="hs-identifier hs-var">mk_id_var</span></a><span> </span><a href="#local-1627735525"><span class="hs-identifier hs-var">id_uniqs</span></a><span> </span><a href="#local-1627735527"><span class="hs-identifier hs-var">id_fss</span></a><span> </span><a href="#local-1627735521"><span class="hs-identifier hs-var">arg_tys</span></a><span> </span><a href="#local-1627735522"><span class="hs-identifier hs-var">arg_strs</span></a><span>
</span><a name="line-1576"></a><span>    </span><a name="local-1627735533"><a href="#local-1627735533"><span class="hs-identifier">mk_id_var</span></a></a><span> </span><a name="local-1627735540"><a href="#local-1627735540"><span class="hs-identifier">uniq</span></a></a><span> </span><a name="local-1627735541"><a href="#local-1627735541"><span class="hs-identifier">fs</span></a></a><span> </span><a name="local-1627735542"><a href="#local-1627735542"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-1627735543"><a href="#local-1627735543"><span class="hs-identifier">str</span></a></a><span>
</span><a name="line-1577"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#mkLocalIdOrCoVarWithInfo"><span class="hs-identifier hs-var">mkLocalIdOrCoVarWithInfo</span></a><span> </span><a href="#local-1627735544"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#substTyUnchecked"><span class="hs-identifier hs-var">Type</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">substTyUnchecked</span></a><span> </span><a href="#local-1627735529"><span class="hs-identifier hs-var">full_subst</span></a><span> </span><a href="#local-1627735542"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735545"><span class="hs-identifier hs-var">info</span></a><span>
</span><a name="line-1578"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1579"></a><span>        </span><a name="local-1627735544"><a href="#local-1627735544"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Name.html#mkInternalName"><span class="hs-identifier hs-var">mkInternalName</span></a><span> </span><a href="#local-1627735540"><span class="hs-identifier hs-var">uniq</span></a><span> </span><span class="hs-special">(</span><a href="OccName.html#mkVarOccFS"><span class="hs-identifier hs-var">mkVarOccFS</span></a><span> </span><a href="#local-1627735541"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">)</span><span> </span><a href="SrcLoc.html#noSrcSpan"><span class="hs-identifier hs-var">noSrcSpan</span></a><span>
</span><a name="line-1580"></a><span>        </span><a name="local-1627735545"><a href="#local-1627735545"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="DataCon.html#isMarkedStrict"><span class="hs-identifier hs-var">isMarkedStrict</span></a><span> </span><a href="#local-1627735543"><span class="hs-identifier hs-var">str</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="IdInfo.html#vanillaIdInfo"><span class="hs-identifier hs-var">vanillaIdInfo</span></a><span> </span><span class="hs-special">`</span><a href="IdInfo.html#setUnfoldingInfo"><span class="hs-identifier hs-var">setUnfoldingInfo</span></a><span class="hs-special">`</span><span> </span><a href="CoreSyn.html#evaldUnfolding"><span class="hs-identifier hs-var">evaldUnfolding</span></a><span>
</span><a name="line-1581"></a><span>             </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="IdInfo.html#vanillaIdInfo"><span class="hs-identifier hs-var">vanillaIdInfo</span></a><span>
</span><a name="line-1582"></a><span>             </span><span class="hs-comment">-- See Note [Mark evaluated arguments]</span><span>
</span><a name="line-1583"></a><span>
</span><a name="line-1584"></a><span class="hs-comment">{-
Note [Mark evaluated arguments]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When pattern matching on a constructor with strict fields, the binder
can have an 'evaldUnfolding'.  Moreover, it *should* have one, so that
when loading an interface file unfolding like:
  data T = MkT !Int
  f x = case x of { MkT y -&gt; let v::Int# = case y of I# n -&gt; n+1
                             in ... }
we don't want Lint to complain.  The 'y' is evaluated, so the
case in the RHS of the binding for 'v' is fine.  But only if we
*know* that 'y' is evaluated.

c.f. add_evals in Simplify.simplAlt

************************************************************************
*                                                                      *
         Equality
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1605"></a><span>
</span><a name="line-1606"></a><span class="hs-comment">-- | A cheap equality test which bales out fast!</span><span>
</span><a name="line-1607"></a><span class="hs-comment">--      If it returns @True@ the arguments are definitely equal,</span><span>
</span><a name="line-1608"></a><span class="hs-comment">--      otherwise, they may or may not be equal.</span><span>
</span><a name="line-1609"></a><span class="hs-comment">--</span><span>
</span><a name="line-1610"></a><span class="hs-comment">-- See also 'exprIsBig'</span><span>
</span><a name="line-1611"></a><span class="hs-identifier">cheapEqExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-1627735053"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-1627735053"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1612"></a><a name="cheapEqExpr"><a href="CoreUtils.html#cheapEqExpr"><span class="hs-identifier">cheapEqExpr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#cheapEqExpr%27"><span class="hs-identifier hs-var">cheapEqExpr'</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#const"><span class="hs-identifier hs-var">const</span></a><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span>
</span><a name="line-1613"></a><span>
</span><a name="line-1614"></a><span class="hs-comment">-- | Cheap expression equality test, can ignore ticks by type.</span><span>
</span><a name="line-1615"></a><span class="hs-identifier">cheapEqExpr'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-1627735052"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-1627735052"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1616"></a><a name="cheapEqExpr%27"><a href="CoreUtils.html#cheapEqExpr%27"><span class="hs-identifier">cheapEqExpr'</span></a></a><span> </span><a name="local-1627735546"><a href="#local-1627735546"><span class="hs-identifier">ignoreTick</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735547"><span class="hs-identifier hs-var">go_s</span></a><span>
</span><a name="line-1617"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-1627735547"><a href="#local-1627735547"><span class="hs-identifier">go_s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735548"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">`</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Function.html#on"><span class="hs-identifier hs-var">on</span></a><span class="hs-special">`</span><span> </span><a href="CoreUtils.html#stripTicksTopE"><span class="hs-identifier hs-var">stripTicksTopE</span></a><span> </span><a href="#local-1627735546"><span class="hs-identifier hs-var">ignoreTick</span></a><span>
</span><a name="line-1618"></a><span>        </span><a name="local-1627735548"><a href="#local-1627735548"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-1627735549"><a href="#local-1627735549"><span class="hs-identifier">v1</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-1627735550"><a href="#local-1627735550"><span class="hs-identifier">v2</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735549"><span class="hs-identifier hs-var">v1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-1627735550"><span class="hs-identifier hs-var">v2</span></a><span>
</span><a name="line-1619"></a><span>        </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><a name="local-1627735551"><a href="#local-1627735551"><span class="hs-identifier">lit1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><a name="local-1627735552"><a href="#local-1627735552"><span class="hs-identifier">lit2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735551"><span class="hs-identifier hs-var">lit1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-1627735552"><span class="hs-identifier hs-var">lit2</span></a><span>
</span><a name="line-1620"></a><span>        </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a name="local-1627735553"><a href="#local-1627735553"><span class="hs-identifier">t1</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a name="local-1627735554"><a href="#local-1627735554"><span class="hs-identifier">t2</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735553"><span class="hs-identifier hs-var">t1</span></a><span> </span><span class="hs-special">`</span><a href="Type.html#eqType"><span class="hs-identifier hs-var">eqType</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627735554"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-1621"></a><span>        </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a name="local-1627735555"><a href="#local-1627735555"><span class="hs-identifier">c1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a name="local-1627735556"><a href="#local-1627735556"><span class="hs-identifier">c2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735555"><span class="hs-identifier hs-var">c1</span></a><span> </span><span class="hs-special">`</span><a href="Coercion.html#eqCoercion"><span class="hs-identifier hs-var">eqCoercion</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627735556"><span class="hs-identifier hs-var">c2</span></a><span>
</span><a name="line-1622"></a><span>
</span><a name="line-1623"></a><span>        </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-1627735557"><a href="#local-1627735557"><span class="hs-identifier">f1</span></a></a><span> </span><a name="local-1627735558"><a href="#local-1627735558"><span class="hs-identifier">a1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-1627735559"><a href="#local-1627735559"><span class="hs-identifier">f2</span></a></a><span> </span><a name="local-1627735560"><a href="#local-1627735560"><span class="hs-identifier">a2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1624"></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735557"><span class="hs-identifier hs-var">f1</span></a><span> </span><span class="hs-special">`</span><a href="#local-1627735547"><span class="hs-identifier hs-var">go_s</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627735559"><span class="hs-identifier hs-var">f2</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-1627735558"><span class="hs-identifier hs-var">a1</span></a><span> </span><span class="hs-special">`</span><a href="#local-1627735547"><span class="hs-identifier hs-var">go_s</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627735560"><span class="hs-identifier hs-var">a2</span></a><span>
</span><a name="line-1625"></a><span>
</span><a name="line-1626"></a><span>        </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-1627735561"><a href="#local-1627735561"><span class="hs-identifier">e1</span></a></a><span> </span><a name="local-1627735562"><a href="#local-1627735562"><span class="hs-identifier">t1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-1627735563"><a href="#local-1627735563"><span class="hs-identifier">e2</span></a></a><span> </span><a name="local-1627735564"><a href="#local-1627735564"><span class="hs-identifier">t2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1627"></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735561"><span class="hs-identifier hs-var">e1</span></a><span> </span><span class="hs-special">`</span><a href="#local-1627735547"><span class="hs-identifier hs-var">go_s</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627735563"><span class="hs-identifier hs-var">e2</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-1627735562"><span class="hs-identifier hs-var">t1</span></a><span> </span><span class="hs-special">`</span><a href="Coercion.html#eqCoercion"><span class="hs-identifier hs-var">eqCoercion</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627735564"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-1628"></a><span>
</span><a name="line-1629"></a><span>        </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-1627735565"><a href="#local-1627735565"><span class="hs-identifier">t1</span></a></a><span> </span><a name="local-1627735566"><a href="#local-1627735566"><span class="hs-identifier">e1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-1627735567"><a href="#local-1627735567"><span class="hs-identifier">t2</span></a></a><span> </span><a name="local-1627735568"><a href="#local-1627735568"><span class="hs-identifier">e2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1630"></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735565"><span class="hs-identifier hs-var">t1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-1627735567"><span class="hs-identifier hs-var">t2</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-1627735566"><span class="hs-identifier hs-var">e1</span></a><span> </span><span class="hs-special">`</span><a href="#local-1627735547"><span class="hs-identifier hs-var">go_s</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627735568"><span class="hs-identifier hs-var">e2</span></a><span>
</span><a name="line-1631"></a><span>
</span><a name="line-1632"></a><span>        </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1633"></a><span>        </span><span class="hs-pragma">{-# INLINE go #-}</span><span>
</span><a name="line-1634"></a><span class="hs-pragma">{-# INLINE cheapEqExpr' #-}</span><span>
</span><a name="line-1635"></a><span>
</span><a name="line-1636"></a><span class="hs-identifier">exprIsBig</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-1627735051"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1637"></a><span class="hs-comment">-- ^ Returns @True@ of expressions that are too big to be compared by 'cheapEqExpr'</span><span>
</span><a name="line-1638"></a><a name="exprIsBig"><a href="CoreUtils.html#exprIsBig"><span class="hs-identifier">exprIsBig</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1639"></a><span class="hs-identifier">exprIsBig</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1640"></a><span class="hs-identifier">exprIsBig</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1641"></a><span class="hs-identifier">exprIsBig</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1642"></a><span class="hs-identifier">exprIsBig</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627735569"><a href="#local-1627735569"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#exprIsBig"><span class="hs-identifier hs-var">exprIsBig</span></a><span> </span><a href="#local-1627735569"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1643"></a><span class="hs-identifier">exprIsBig</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-1627735570"><a href="#local-1627735570"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-1627735571"><a href="#local-1627735571"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#exprIsBig"><span class="hs-identifier hs-var">exprIsBig</span></a><span> </span><a href="#local-1627735570"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="CoreUtils.html#exprIsBig"><span class="hs-identifier hs-var">exprIsBig</span></a><span> </span><a href="#local-1627735571"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-1644"></a><span class="hs-identifier">exprIsBig</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-1627735572"><a href="#local-1627735572"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#exprIsBig"><span class="hs-identifier hs-var">exprIsBig</span></a><span> </span><a href="#local-1627735572"><span class="hs-identifier hs-var">e</span></a><span>    </span><span class="hs-comment">-- Hopefully coercions are not too big!</span><span>
</span><a name="line-1645"></a><span class="hs-identifier">exprIsBig</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627735573"><a href="#local-1627735573"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#exprIsBig"><span class="hs-identifier hs-var">exprIsBig</span></a><span> </span><a href="#local-1627735573"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1646"></a><span class="hs-identifier">exprIsBig</span><span> </span><span class="hs-identifier">_</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1647"></a><span>
</span><a name="line-1648"></a><span class="hs-identifier">eqExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1649"></a><span class="hs-comment">-- Compares for equality, modulo alpha</span><span>
</span><a name="line-1650"></a><a name="eqExpr"><a href="CoreUtils.html#eqExpr"><span class="hs-identifier">eqExpr</span></a></a><span> </span><a name="local-1627735574"><a href="#local-1627735574"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-1627735575"><a href="#local-1627735575"><span class="hs-identifier">e1</span></a></a><span> </span><a name="local-1627735576"><a href="#local-1627735576"><span class="hs-identifier">e2</span></a></a><span>
</span><a name="line-1651"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735577"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#mkRnEnv2"><span class="hs-identifier hs-var">mkRnEnv2</span></a><span> </span><a href="#local-1627735574"><span class="hs-identifier hs-var">in_scope</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735575"><span class="hs-identifier hs-var">e1</span></a><span> </span><a href="#local-1627735576"><span class="hs-identifier hs-var">e2</span></a><span>
</span><a name="line-1652"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1653"></a><span>    </span><a name="local-1627735577"><a href="#local-1627735577"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-1627735579"><a href="#local-1627735579"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-1627735580"><a href="#local-1627735580"><span class="hs-identifier">v1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-1627735581"><a href="#local-1627735581"><span class="hs-identifier">v2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1654"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="VarEnv.html#rnOccL"><span class="hs-identifier hs-var">rnOccL</span></a><span> </span><a href="#local-1627735579"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735580"><span class="hs-identifier hs-var">v1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="VarEnv.html#rnOccR"><span class="hs-identifier hs-var">rnOccR</span></a><span> </span><a href="#local-1627735579"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735581"><span class="hs-identifier hs-var">v2</span></a><span>
</span><a name="line-1655"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1656"></a><span>
</span><a name="line-1657"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-special">(</span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><a name="local-1627735582"><a href="#local-1627735582"><span class="hs-identifier">lit1</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-special">(</span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><a name="local-1627735583"><a href="#local-1627735583"><span class="hs-identifier">lit2</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735582"><span class="hs-identifier hs-var">lit1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-1627735583"><span class="hs-identifier hs-var">lit2</span></a><span>
</span><a name="line-1658"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1627735584"><a href="#local-1627735584"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a name="local-1627735585"><a href="#local-1627735585"><span class="hs-identifier">t1</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a name="local-1627735586"><a href="#local-1627735586"><span class="hs-identifier">t2</span></a></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#eqTypeX"><span class="hs-identifier hs-var">eqTypeX</span></a><span> </span><a href="#local-1627735584"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735585"><span class="hs-identifier hs-var">t1</span></a><span> </span><a href="#local-1627735586"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-1659"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1627735587"><a href="#local-1627735587"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a name="local-1627735588"><a href="#local-1627735588"><span class="hs-identifier">co1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a name="local-1627735589"><a href="#local-1627735589"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#eqCoercionX"><span class="hs-identifier hs-var">eqCoercionX</span></a><span> </span><a href="#local-1627735587"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735588"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-1627735589"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-1660"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1627735590"><a href="#local-1627735590"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-1627735591"><a href="#local-1627735591"><span class="hs-identifier">e1</span></a></a><span> </span><a name="local-1627735592"><a href="#local-1627735592"><span class="hs-identifier">co1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-1627735593"><a href="#local-1627735593"><span class="hs-identifier">e2</span></a></a><span> </span><a name="local-1627735594"><a href="#local-1627735594"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#eqCoercionX"><span class="hs-identifier hs-var">eqCoercionX</span></a><span> </span><a href="#local-1627735590"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735592"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-1627735594"><span class="hs-identifier hs-var">co2</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-1627735577"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735590"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735591"><span class="hs-identifier hs-var">e1</span></a><span> </span><a href="#local-1627735593"><span class="hs-identifier hs-var">e2</span></a><span>
</span><a name="line-1661"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1627735595"><a href="#local-1627735595"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-1627735596"><a href="#local-1627735596"><span class="hs-identifier">f1</span></a></a><span> </span><a name="local-1627735597"><a href="#local-1627735597"><span class="hs-identifier">a1</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-1627735598"><a href="#local-1627735598"><span class="hs-identifier">f2</span></a></a><span> </span><a name="local-1627735599"><a href="#local-1627735599"><span class="hs-identifier">a2</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735577"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735595"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735596"><span class="hs-identifier hs-var">f1</span></a><span> </span><a href="#local-1627735598"><span class="hs-identifier hs-var">f2</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-1627735577"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735595"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735597"><span class="hs-identifier hs-var">a1</span></a><span> </span><a href="#local-1627735599"><span class="hs-identifier hs-var">a2</span></a><span>
</span><a name="line-1662"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1627735600"><a href="#local-1627735600"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-1627735601"><a href="#local-1627735601"><span class="hs-identifier">n1</span></a></a><span> </span><a name="local-1627735602"><a href="#local-1627735602"><span class="hs-identifier">e1</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-1627735603"><a href="#local-1627735603"><span class="hs-identifier">n2</span></a></a><span> </span><a name="local-1627735604"><a href="#local-1627735604"><span class="hs-identifier">e2</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#eqTickish"><span class="hs-identifier hs-var">eqTickish</span></a><span> </span><a href="#local-1627735600"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735601"><span class="hs-identifier hs-var">n1</span></a><span> </span><a href="#local-1627735603"><span class="hs-identifier hs-var">n2</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-1627735577"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735600"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735602"><span class="hs-identifier hs-var">e1</span></a><span> </span><a href="#local-1627735604"><span class="hs-identifier hs-var">e2</span></a><span>
</span><a name="line-1663"></a><span>
</span><a name="line-1664"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1627735605"><a href="#local-1627735605"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a name="local-1627735606"><a href="#local-1627735606"><span class="hs-identifier">b1</span></a></a><span> </span><a name="local-1627735607"><a href="#local-1627735607"><span class="hs-identifier">e1</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a name="local-1627735608"><a href="#local-1627735608"><span class="hs-identifier">b2</span></a></a><span> </span><a name="local-1627735609"><a href="#local-1627735609"><span class="hs-identifier">e2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1665"></a><span>      </span><span class="hs-glyph">=</span><span>  </span><a href="Type.html#eqTypeX"><span class="hs-identifier hs-var">eqTypeX</span></a><span> </span><a href="#local-1627735605"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">varType</span><span> </span><a href="#local-1627735606"><span class="hs-identifier hs-var">b1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">varType</span><span> </span><a href="#local-1627735608"><span class="hs-identifier hs-var">b2</span></a><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- False for Id/TyVar combination</span><span>
</span><a name="line-1666"></a><span>      </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-1627735577"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#rnBndr2"><span class="hs-identifier hs-var">rnBndr2</span></a><span> </span><a href="#local-1627735605"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735606"><span class="hs-identifier hs-var">b1</span></a><span> </span><a href="#local-1627735608"><span class="hs-identifier hs-var">b2</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735607"><span class="hs-identifier hs-var">e1</span></a><span> </span><a href="#local-1627735609"><span class="hs-identifier hs-var">e2</span></a><span>
</span><a name="line-1667"></a><span>
</span><a name="line-1668"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1627735610"><a href="#local-1627735610"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a name="local-1627735611"><a href="#local-1627735611"><span class="hs-identifier">v1</span></a></a><span> </span><a name="local-1627735612"><a href="#local-1627735612"><span class="hs-identifier">r1</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627735613"><a href="#local-1627735613"><span class="hs-identifier">e1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a name="local-1627735614"><a href="#local-1627735614"><span class="hs-identifier">v2</span></a></a><span> </span><a name="local-1627735615"><a href="#local-1627735615"><span class="hs-identifier">r2</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627735616"><a href="#local-1627735616"><span class="hs-identifier">e2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1669"></a><span>      </span><span class="hs-glyph">=</span><span>  </span><a href="#local-1627735577"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735610"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735612"><span class="hs-identifier hs-var">r1</span></a><span> </span><a href="#local-1627735615"><span class="hs-identifier hs-var">r2</span></a><span>  </span><span class="hs-comment">-- No need to check binder types, since RHSs match</span><span>
</span><a name="line-1670"></a><span>      </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-1627735577"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#rnBndr2"><span class="hs-identifier hs-var">rnBndr2</span></a><span> </span><a href="#local-1627735610"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735611"><span class="hs-identifier hs-var">v1</span></a><span> </span><a href="#local-1627735614"><span class="hs-identifier hs-var">v2</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735613"><span class="hs-identifier hs-var">e1</span></a><span> </span><a href="#local-1627735616"><span class="hs-identifier hs-var">e2</span></a><span>
</span><a name="line-1671"></a><span>
</span><a name="line-1672"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1627735617"><a href="#local-1627735617"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><a name="local-1627735618"><a href="#local-1627735618"><span class="hs-identifier">ps1</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627735619"><a href="#local-1627735619"><span class="hs-identifier">e1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><a name="local-1627735620"><a href="#local-1627735620"><span class="hs-identifier">ps2</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627735621"><a href="#local-1627735621"><span class="hs-identifier">e2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1673"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><a href="#local-1627735618"><span class="hs-identifier hs-var">ps1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><a href="#local-1627735620"><span class="hs-identifier hs-var">ps2</span></a><span>
</span><a name="line-1674"></a><span>      </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="Util.html#all2"><span class="hs-identifier hs-var">all2</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627735577"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735626"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735623"><span class="hs-identifier hs-var">rs1</span></a><span> </span><a href="#local-1627735625"><span class="hs-identifier hs-var">rs2</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-1627735577"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735626"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-1627735619"><span class="hs-identifier hs-var">e1</span></a><span> </span><a href="#local-1627735621"><span class="hs-identifier hs-var">e2</span></a><span>
</span><a name="line-1675"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1676"></a><span>        </span><span class="hs-special">(</span><a name="local-1627735622"><a href="#local-1627735622"><span class="hs-identifier">bs1</span></a></a><span class="hs-special">,</span><a name="local-1627735623"><a href="#local-1627735623"><span class="hs-identifier">rs1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#unzip"><span class="hs-identifier hs-var">unzip</span></a><span> </span><a href="#local-1627735618"><span class="hs-identifier hs-var">ps1</span></a><span>
</span><a name="line-1677"></a><span>        </span><span class="hs-special">(</span><a name="local-1627735624"><a href="#local-1627735624"><span class="hs-identifier">bs2</span></a></a><span class="hs-special">,</span><a name="local-1627735625"><a href="#local-1627735625"><span class="hs-identifier">rs2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#unzip"><span class="hs-identifier hs-var">unzip</span></a><span> </span><a href="#local-1627735620"><span class="hs-identifier hs-var">ps2</span></a><span>
</span><a name="line-1678"></a><span>        </span><a name="local-1627735626"><a href="#local-1627735626"><span class="hs-identifier">env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#rnBndrs2"><span class="hs-identifier hs-var">rnBndrs2</span></a><span> </span><a href="#local-1627735617"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735622"><span class="hs-identifier hs-var">bs1</span></a><span> </span><a href="#local-1627735624"><span class="hs-identifier hs-var">bs2</span></a><span>
</span><a name="line-1679"></a><span>
</span><a name="line-1680"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1627735627"><a href="#local-1627735627"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Case"><span class="hs-identifier hs-var">Case</span></a><span> </span><a name="local-1627735628"><a href="#local-1627735628"><span class="hs-identifier">e1</span></a></a><span> </span><a name="local-1627735629"><a href="#local-1627735629"><span class="hs-identifier">b1</span></a></a><span> </span><a name="local-1627735630"><a href="#local-1627735630"><span class="hs-identifier">t1</span></a></a><span> </span><a name="local-1627735631"><a href="#local-1627735631"><span class="hs-identifier">a1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Case"><span class="hs-identifier hs-var">Case</span></a><span> </span><a name="local-1627735632"><a href="#local-1627735632"><span class="hs-identifier">e2</span></a></a><span> </span><a name="local-1627735633"><a href="#local-1627735633"><span class="hs-identifier">b2</span></a></a><span> </span><a name="local-1627735634"><a href="#local-1627735634"><span class="hs-identifier">t2</span></a></a><span> </span><a name="local-1627735635"><a href="#local-1627735635"><span class="hs-identifier">a2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1681"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1627735631"><span class="hs-identifier hs-var">a1</span></a><span>   </span><span class="hs-comment">-- See Note [Empty case alternatives] in TrieMap</span><span>
</span><a name="line-1682"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1627735635"><span class="hs-identifier hs-var">a2</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-1627735577"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735627"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735628"><span class="hs-identifier hs-var">e1</span></a><span> </span><a href="#local-1627735632"><span class="hs-identifier hs-var">e2</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="Type.html#eqTypeX"><span class="hs-identifier hs-var">eqTypeX</span></a><span> </span><a href="#local-1627735627"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735630"><span class="hs-identifier hs-var">t1</span></a><span> </span><a href="#local-1627735634"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-1683"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1684"></a><span>      </span><span class="hs-glyph">=</span><span>  </span><a href="#local-1627735577"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735627"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735628"><span class="hs-identifier hs-var">e1</span></a><span> </span><a href="#local-1627735632"><span class="hs-identifier hs-var">e2</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="Util.html#all2"><span class="hs-identifier hs-var">all2</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627735578"><span class="hs-identifier hs-var">go_alt</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#rnBndr2"><span class="hs-identifier hs-var">rnBndr2</span></a><span> </span><a href="#local-1627735627"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735629"><span class="hs-identifier hs-var">b1</span></a><span> </span><a href="#local-1627735633"><span class="hs-identifier hs-var">b2</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-1627735631"><span class="hs-identifier hs-var">a1</span></a><span> </span><a href="#local-1627735635"><span class="hs-identifier hs-var">a2</span></a><span>
</span><a name="line-1685"></a><span>
</span><a name="line-1686"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1687"></a><span>
</span><a name="line-1688"></a><span>    </span><span class="hs-comment">-----------</span><span>
</span><a name="line-1689"></a><span>    </span><a name="local-1627735578"><a href="#local-1627735578"><span class="hs-identifier">go_alt</span></a></a><span> </span><a name="local-1627735636"><a href="#local-1627735636"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1627735637"><a href="#local-1627735637"><span class="hs-identifier">c1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627735638"><a href="#local-1627735638"><span class="hs-identifier">bs1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627735639"><a href="#local-1627735639"><span class="hs-identifier">e1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-1627735640"><a href="#local-1627735640"><span class="hs-identifier">c2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627735641"><a href="#local-1627735641"><span class="hs-identifier">bs2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627735642"><a href="#local-1627735642"><span class="hs-identifier">e2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1690"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735637"><span class="hs-identifier hs-var">c1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-1627735640"><span class="hs-identifier hs-var">c2</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-1627735577"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#rnBndrs2"><span class="hs-identifier hs-var">rnBndrs2</span></a><span> </span><a href="#local-1627735636"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735638"><span class="hs-identifier hs-var">bs1</span></a><span> </span><a href="#local-1627735641"><span class="hs-identifier hs-var">bs2</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735639"><span class="hs-identifier hs-var">e1</span></a><span> </span><a href="#local-1627735642"><span class="hs-identifier hs-var">e2</span></a><span>
</span><a name="line-1691"></a><span>
</span><a name="line-1692"></a><span class="hs-identifier">eqTickish</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#RnEnv2"><span class="hs-identifier hs-type">RnEnv2</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1693"></a><a name="eqTickish"><a href="CoreUtils.html#eqTickish"><span class="hs-identifier">eqTickish</span></a></a><span> </span><a name="local-1627735643"><a href="#local-1627735643"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Breakpoint"><span class="hs-identifier hs-var">Breakpoint</span></a><span> </span><a name="local-1627735644"><a href="#local-1627735644"><span class="hs-identifier">lid</span></a></a><span> </span><a name="local-1627735645"><a href="#local-1627735645"><span class="hs-identifier">lids</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Breakpoint"><span class="hs-identifier hs-var">Breakpoint</span></a><span> </span><a name="local-1627735646"><a href="#local-1627735646"><span class="hs-identifier">rid</span></a></a><span> </span><a name="local-1627735647"><a href="#local-1627735647"><span class="hs-identifier">rids</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1694"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735644"><span class="hs-identifier hs-var">lid</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-1627735646"><span class="hs-identifier hs-var">rid</span></a><span>  </span><span class="hs-operator hs-var">&amp;&amp;</span><span>  </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#rnOccL"><span class="hs-identifier hs-var">rnOccL</span></a><span> </span><a href="#local-1627735643"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735645"><span class="hs-identifier hs-var">lids</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#rnOccR"><span class="hs-identifier hs-var">rnOccR</span></a><span> </span><a href="#local-1627735643"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735647"><span class="hs-identifier hs-var">rids</span></a><span>
</span><a name="line-1695"></a><span class="hs-identifier">eqTickish</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627735648"><a href="#local-1627735648"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-1627735649"><a href="#local-1627735649"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735648"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-1627735649"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-1696"></a><span>
</span><a name="line-1697"></a><span class="hs-comment">-- | Finds differences between core expressions, modulo alpha and</span><span>
</span><a name="line-1698"></a><span class="hs-comment">-- renaming. Setting @top@ means that the @IdInfo@ of bindings will be</span><span>
</span><a name="line-1699"></a><span class="hs-comment">-- checked for differences as well.</span><span>
</span><a name="line-1700"></a><span class="hs-identifier">diffExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarEnv.html#RnEnv2"><span class="hs-identifier hs-type">RnEnv2</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span class="hs-special">]</span><span>
</span><a name="line-1701"></a><a name="diffExpr"><a href="CoreUtils.html#diffExpr"><span class="hs-identifier">diffExpr</span></a></a><span> </span><span class="hs-identifier">_</span><span>   </span><a name="local-1627735650"><a href="#local-1627735650"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-1627735651"><a href="#local-1627735651"><span class="hs-identifier">v1</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-1627735652"><a href="#local-1627735652"><span class="hs-identifier">v2</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">|</span><span> </span><a href="VarEnv.html#rnOccL"><span class="hs-identifier hs-var">rnOccL</span></a><span> </span><a href="#local-1627735650"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735651"><span class="hs-identifier hs-var">v1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="VarEnv.html#rnOccR"><span class="hs-identifier hs-var">rnOccR</span></a><span> </span><a href="#local-1627735650"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735652"><span class="hs-identifier hs-var">v2</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1702"></a><span class="hs-identifier">diffExpr</span><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-identifier">_</span><span>   </span><span class="hs-special">(</span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><a name="local-1627735653"><a href="#local-1627735653"><span class="hs-identifier">lit1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><a name="local-1627735654"><a href="#local-1627735654"><span class="hs-identifier">lit2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627735653"><span class="hs-identifier hs-var">lit1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-1627735654"><span class="hs-identifier hs-var">lit2</span></a><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1703"></a><span class="hs-identifier">diffExpr</span><span> </span><span class="hs-identifier">_</span><span>   </span><a name="local-1627735655"><a href="#local-1627735655"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a name="local-1627735656"><a href="#local-1627735656"><span class="hs-identifier">t1</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a name="local-1627735657"><a href="#local-1627735657"><span class="hs-identifier">t2</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Type.html#eqTypeX"><span class="hs-identifier hs-var">eqTypeX</span></a><span> </span><a href="#local-1627735655"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735656"><span class="hs-identifier hs-var">t1</span></a><span> </span><a href="#local-1627735657"><span class="hs-identifier hs-var">t2</span></a><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1704"></a><span class="hs-identifier">diffExpr</span><span> </span><span class="hs-identifier">_</span><span>   </span><a name="local-1627735658"><a href="#local-1627735658"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a name="local-1627735659"><a href="#local-1627735659"><span class="hs-identifier">co1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a name="local-1627735660"><a href="#local-1627735660"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1705"></a><span>                                       </span><span class="hs-glyph">|</span><span> </span><a href="Coercion.html#eqCoercionX"><span class="hs-identifier hs-var">eqCoercionX</span></a><span> </span><a href="#local-1627735658"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735659"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-1627735660"><span class="hs-identifier hs-var">co2</span></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1706"></a><span class="hs-identifier">diffExpr</span><span> </span><a name="local-1627735661"><a href="#local-1627735661"><span class="hs-identifier">top</span></a></a><span> </span><a name="local-1627735662"><a href="#local-1627735662"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-1627735663"><a href="#local-1627735663"><span class="hs-identifier">e1</span></a></a><span> </span><a name="local-1627735664"><a href="#local-1627735664"><span class="hs-identifier">co1</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-1627735665"><a href="#local-1627735665"><span class="hs-identifier">e2</span></a></a><span> </span><a name="local-1627735666"><a href="#local-1627735666"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1707"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Coercion.html#eqCoercionX"><span class="hs-identifier hs-var">eqCoercionX</span></a><span> </span><a href="#local-1627735662"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735664"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-1627735666"><span class="hs-identifier hs-var">co2</span></a><span>                </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#diffExpr"><span class="hs-identifier hs-var">diffExpr</span></a><span> </span><a href="#local-1627735661"><span class="hs-identifier hs-var">top</span></a><span> </span><a href="#local-1627735662"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735663"><span class="hs-identifier hs-var">e1</span></a><span> </span><a href="#local-1627735665"><span class="hs-identifier hs-var">e2</span></a><span>
</span><a name="line-1708"></a><span class="hs-identifier">diffExpr</span><span> </span><a name="local-1627735667"><a href="#local-1627735667"><span class="hs-identifier">top</span></a></a><span> </span><a name="local-1627735668"><a href="#local-1627735668"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-1627735669"><a href="#local-1627735669"><span class="hs-identifier">n1</span></a></a><span> </span><a name="local-1627735670"><a href="#local-1627735670"><span class="hs-identifier">e1</span></a></a><span class="hs-special">)</span><span>   </span><a name="local-1627735671"><a href="#local-1627735671"><span class="hs-identifier">e2</span></a></a><span>
</span><a name="line-1709"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#tickishIsCode"><span class="hs-identifier hs-var">tickishIsCode</span></a><span> </span><a href="#local-1627735669"><span class="hs-identifier hs-var">n1</span></a><span class="hs-special">)</span><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#diffExpr"><span class="hs-identifier hs-var">diffExpr</span></a><span> </span><a href="#local-1627735667"><span class="hs-identifier hs-var">top</span></a><span> </span><a href="#local-1627735668"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735670"><span class="hs-identifier hs-var">e1</span></a><span> </span><a href="#local-1627735671"><span class="hs-identifier hs-var">e2</span></a><span>
</span><a name="line-1710"></a><span class="hs-identifier">diffExpr</span><span> </span><a name="local-1627735672"><a href="#local-1627735672"><span class="hs-identifier">top</span></a></a><span> </span><a name="local-1627735673"><a href="#local-1627735673"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-1627735674"><a href="#local-1627735674"><span class="hs-identifier">e1</span></a></a><span>             </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-1627735675"><a href="#local-1627735675"><span class="hs-identifier">n2</span></a></a><span> </span><a name="local-1627735676"><a href="#local-1627735676"><span class="hs-identifier">e2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1711"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#tickishIsCode"><span class="hs-identifier hs-var">tickishIsCode</span></a><span> </span><a href="#local-1627735675"><span class="hs-identifier hs-var">n2</span></a><span class="hs-special">)</span><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#diffExpr"><span class="hs-identifier hs-var">diffExpr</span></a><span> </span><a href="#local-1627735672"><span class="hs-identifier hs-var">top</span></a><span> </span><a href="#local-1627735673"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735674"><span class="hs-identifier hs-var">e1</span></a><span> </span><a href="#local-1627735676"><span class="hs-identifier hs-var">e2</span></a><span>
</span><a name="line-1712"></a><span class="hs-identifier">diffExpr</span><span> </span><a name="local-1627735677"><a href="#local-1627735677"><span class="hs-identifier">top</span></a></a><span> </span><a name="local-1627735678"><a href="#local-1627735678"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-1627735679"><a href="#local-1627735679"><span class="hs-identifier">n1</span></a></a><span> </span><a name="local-1627735680"><a href="#local-1627735680"><span class="hs-identifier">e1</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-1627735681"><a href="#local-1627735681"><span class="hs-identifier">n2</span></a></a><span> </span><a name="local-1627735682"><a href="#local-1627735682"><span class="hs-identifier">e2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1713"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="CoreUtils.html#eqTickish"><span class="hs-identifier hs-var">eqTickish</span></a><span> </span><a href="#local-1627735678"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735679"><span class="hs-identifier hs-var">n1</span></a><span> </span><a href="#local-1627735681"><span class="hs-identifier hs-var">n2</span></a><span>                    </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#diffExpr"><span class="hs-identifier hs-var">diffExpr</span></a><span> </span><a href="#local-1627735677"><span class="hs-identifier hs-var">top</span></a><span> </span><a href="#local-1627735678"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735680"><span class="hs-identifier hs-var">e1</span></a><span> </span><a href="#local-1627735682"><span class="hs-identifier hs-var">e2</span></a><span>
</span><a name="line-1714"></a><span> </span><span class="hs-comment">-- The error message of failed pattern matches will contain</span><span>
</span><a name="line-1715"></a><span> </span><span class="hs-comment">-- generated names, which are allowed to differ.</span><span>
</span><a name="line-1716"></a><span class="hs-identifier">diffExpr</span><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-identifier">_</span><span>   </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-1627735683"><a href="#local-1627735683"><span class="hs-identifier">absent</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-1717"></a><span>                 </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-1627735684"><a href="#local-1627735684"><span class="hs-identifier">absent2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-1718"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Id.html#isBottomingId"><span class="hs-identifier hs-var">isBottomingId</span></a><span> </span><a href="#local-1627735683"><span class="hs-identifier hs-var">absent</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="Id.html#isBottomingId"><span class="hs-identifier hs-var">isBottomingId</span></a><span> </span><a href="#local-1627735684"><span class="hs-identifier hs-var">absent2</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1719"></a><span class="hs-identifier">diffExpr</span><span> </span><a name="local-1627735685"><a href="#local-1627735685"><span class="hs-identifier">top</span></a></a><span> </span><a name="local-1627735686"><a href="#local-1627735686"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-1627735687"><a href="#local-1627735687"><span class="hs-identifier">f1</span></a></a><span> </span><a name="local-1627735688"><a href="#local-1627735688"><span class="hs-identifier">a1</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-1627735689"><a href="#local-1627735689"><span class="hs-identifier">f2</span></a></a><span> </span><a name="local-1627735690"><a href="#local-1627735690"><span class="hs-identifier">a2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1720"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#diffExpr"><span class="hs-identifier hs-var">diffExpr</span></a><span> </span><a href="#local-1627735685"><span class="hs-identifier hs-var">top</span></a><span> </span><a href="#local-1627735686"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735687"><span class="hs-identifier hs-var">f1</span></a><span> </span><a href="#local-1627735689"><span class="hs-identifier hs-var">f2</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="CoreUtils.html#diffExpr"><span class="hs-identifier hs-var">diffExpr</span></a><span> </span><a href="#local-1627735685"><span class="hs-identifier hs-var">top</span></a><span> </span><a href="#local-1627735686"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735688"><span class="hs-identifier hs-var">a1</span></a><span> </span><a href="#local-1627735690"><span class="hs-identifier hs-var">a2</span></a><span>
</span><a name="line-1721"></a><span class="hs-identifier">diffExpr</span><span> </span><a name="local-1627735691"><a href="#local-1627735691"><span class="hs-identifier">top</span></a></a><span> </span><a name="local-1627735692"><a href="#local-1627735692"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a name="local-1627735693"><a href="#local-1627735693"><span class="hs-identifier">b1</span></a></a><span> </span><a name="local-1627735694"><a href="#local-1627735694"><span class="hs-identifier">e1</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a name="local-1627735695"><a href="#local-1627735695"><span class="hs-identifier">b2</span></a></a><span> </span><a name="local-1627735696"><a href="#local-1627735696"><span class="hs-identifier">e2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1722"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Type.html#eqTypeX"><span class="hs-identifier hs-var">eqTypeX</span></a><span> </span><a href="#local-1627735692"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">varType</span><span> </span><a href="#local-1627735693"><span class="hs-identifier hs-var">b1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">varType</span><span> </span><a href="#local-1627735695"><span class="hs-identifier hs-var">b2</span></a><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- False for Id/TyVar combination</span><span>
</span><a name="line-1723"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#diffExpr"><span class="hs-identifier hs-var">diffExpr</span></a><span> </span><a href="#local-1627735691"><span class="hs-identifier hs-var">top</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#rnBndr2"><span class="hs-identifier hs-var">rnBndr2</span></a><span> </span><a href="#local-1627735692"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735693"><span class="hs-identifier hs-var">b1</span></a><span> </span><a href="#local-1627735695"><span class="hs-identifier hs-var">b2</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735694"><span class="hs-identifier hs-var">e1</span></a><span> </span><a href="#local-1627735696"><span class="hs-identifier hs-var">e2</span></a><span>
</span><a name="line-1724"></a><span class="hs-identifier">diffExpr</span><span> </span><a name="local-1627735697"><a href="#local-1627735697"><span class="hs-identifier">top</span></a></a><span> </span><a name="local-1627735698"><a href="#local-1627735698"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><a name="local-1627735699"><a href="#local-1627735699"><span class="hs-identifier">bs1</span></a></a><span> </span><a name="local-1627735700"><a href="#local-1627735700"><span class="hs-identifier">e1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><a name="local-1627735701"><a href="#local-1627735701"><span class="hs-identifier">bs2</span></a></a><span> </span><a name="local-1627735702"><a href="#local-1627735702"><span class="hs-identifier">e2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1725"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-1627735703"><a href="#local-1627735703"><span class="hs-identifier">ds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627735704"><a href="#local-1627735704"><span class="hs-identifier">env'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#diffBinds"><span class="hs-identifier hs-var">diffBinds</span></a><span> </span><a href="#local-1627735697"><span class="hs-identifier hs-var">top</span></a><span> </span><a href="#local-1627735698"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#flattenBinds"><span class="hs-identifier hs-var">flattenBinds</span></a><span> </span><span class="hs-special">[</span><a href="#local-1627735699"><span class="hs-identifier hs-var">bs1</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#flattenBinds"><span class="hs-identifier hs-var">flattenBinds</span></a><span> </span><span class="hs-special">[</span><a href="#local-1627735701"><span class="hs-identifier hs-var">bs2</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1726"></a><span>    </span><span class="hs-keyword">in</span><span> </span><a href="#local-1627735703"><span class="hs-identifier hs-var">ds</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="CoreUtils.html#diffExpr"><span class="hs-identifier hs-var">diffExpr</span></a><span> </span><a href="#local-1627735697"><span class="hs-identifier hs-var">top</span></a><span> </span><a href="#local-1627735704"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-1627735700"><span class="hs-identifier hs-var">e1</span></a><span> </span><a href="#local-1627735702"><span class="hs-identifier hs-var">e2</span></a><span>
</span><a name="line-1727"></a><span class="hs-identifier">diffExpr</span><span> </span><a name="local-1627735705"><a href="#local-1627735705"><span class="hs-identifier">top</span></a></a><span> </span><a name="local-1627735706"><a href="#local-1627735706"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Case"><span class="hs-identifier hs-var">Case</span></a><span> </span><a name="local-1627735707"><a href="#local-1627735707"><span class="hs-identifier">e1</span></a></a><span> </span><a name="local-1627735708"><a href="#local-1627735708"><span class="hs-identifier">b1</span></a></a><span> </span><a name="local-1627735709"><a href="#local-1627735709"><span class="hs-identifier">t1</span></a></a><span> </span><a name="local-1627735710"><a href="#local-1627735710"><span class="hs-identifier">a1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Case"><span class="hs-identifier hs-var">Case</span></a><span> </span><a name="local-1627735711"><a href="#local-1627735711"><span class="hs-identifier">e2</span></a></a><span> </span><a name="local-1627735712"><a href="#local-1627735712"><span class="hs-identifier">b2</span></a></a><span> </span><a name="local-1627735713"><a href="#local-1627735713"><span class="hs-identifier">t2</span></a></a><span> </span><a name="local-1627735714"><a href="#local-1627735714"><span class="hs-identifier">a2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1728"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><a href="#local-1627735710"><span class="hs-identifier hs-var">a1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><a href="#local-1627735714"><span class="hs-identifier hs-var">a2</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1627735710"><span class="hs-identifier hs-var">a1</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="Type.html#eqTypeX"><span class="hs-identifier hs-var">eqTypeX</span></a><span> </span><a href="#local-1627735706"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735709"><span class="hs-identifier hs-var">t1</span></a><span> </span><a href="#local-1627735713"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-1729"></a><span>    </span><span class="hs-comment">-- See Note [Empty case alternatives] in TrieMap</span><span>
</span><a name="line-1730"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#diffExpr"><span class="hs-identifier hs-var">diffExpr</span></a><span> </span><a href="#local-1627735705"><span class="hs-identifier hs-var">top</span></a><span> </span><a href="#local-1627735706"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735707"><span class="hs-identifier hs-var">e1</span></a><span> </span><a href="#local-1627735711"><span class="hs-identifier hs-var">e2</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#concat"><span class="hs-identifier hs-var">concat</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zipWith"><span class="hs-identifier hs-var">zipWith</span></a><span> </span><a href="#local-1627735716"><span class="hs-identifier hs-var">diffAlt</span></a><span> </span><a href="#local-1627735710"><span class="hs-identifier hs-var">a1</span></a><span> </span><a href="#local-1627735714"><span class="hs-identifier hs-var">a2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1731"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-1627735715"><a href="#local-1627735715"><span class="hs-identifier">env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#rnBndr2"><span class="hs-identifier hs-var">rnBndr2</span></a><span> </span><a href="#local-1627735706"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735708"><span class="hs-identifier hs-var">b1</span></a><span> </span><a href="#local-1627735712"><span class="hs-identifier hs-var">b2</span></a><span>
</span><a name="line-1732"></a><span>        </span><a name="local-1627735716"><a href="#local-1627735716"><span class="hs-identifier">diffAlt</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1627735717"><a href="#local-1627735717"><span class="hs-identifier">c1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627735718"><a href="#local-1627735718"><span class="hs-identifier">bs1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627735719"><a href="#local-1627735719"><span class="hs-identifier">e1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-1627735720"><a href="#local-1627735720"><span class="hs-identifier">c2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627735721"><a href="#local-1627735721"><span class="hs-identifier">bs2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627735722"><a href="#local-1627735722"><span class="hs-identifier">e2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1733"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627735717"><span class="hs-identifier hs-var">c1</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-1627735720"><span class="hs-identifier hs-var">c2</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;alt-cons &quot;</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1627735717"><span class="hs-identifier hs-var">c1</span></a><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot; /= &quot;</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1627735720"><span class="hs-identifier hs-var">c2</span></a><span class="hs-special">]</span><span>
</span><a name="line-1734"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#diffExpr"><span class="hs-identifier hs-var">diffExpr</span></a><span> </span><a href="#local-1627735705"><span class="hs-identifier hs-var">top</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#rnBndrs2"><span class="hs-identifier hs-var">rnBndrs2</span></a><span> </span><a href="#local-1627735715"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-1627735718"><span class="hs-identifier hs-var">bs1</span></a><span> </span><a href="#local-1627735721"><span class="hs-identifier hs-var">bs2</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735719"><span class="hs-identifier hs-var">e1</span></a><span> </span><a href="#local-1627735722"><span class="hs-identifier hs-var">e2</span></a><span>
</span><a name="line-1735"></a><span class="hs-identifier">diffExpr</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-identifier">_</span><span> </span><a name="local-1627735723"><a href="#local-1627735723"><span class="hs-identifier">e1</span></a></a><span> </span><a name="local-1627735724"><a href="#local-1627735724"><span class="hs-identifier">e2</span></a></a><span>
</span><a name="line-1736"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="Outputable.html#fsep"><span class="hs-identifier hs-var">fsep</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1627735723"><span class="hs-identifier hs-var">e1</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;/=&quot;</span><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1627735724"><span class="hs-identifier hs-var">e2</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-1737"></a><span>
</span><a name="line-1738"></a><span class="hs-comment">-- | Finds differences between core bindings, see @diffExpr@.</span><span>
</span><a name="line-1739"></a><span class="hs-comment">--</span><span>
</span><a name="line-1740"></a><span class="hs-comment">-- The main problem here is that while we expect the binds to have the</span><span>
</span><a name="line-1741"></a><span class="hs-comment">-- same order in both lists, this is not guaranteed. To do this</span><span>
</span><a name="line-1742"></a><span class="hs-comment">-- properly we'd either have to do some sort of unification or check</span><span>
</span><a name="line-1743"></a><span class="hs-comment">-- all possible mappings, which would be seriously expensive. So</span><span>
</span><a name="line-1744"></a><span class="hs-comment">-- instead we simply match single bindings as far as we can. This</span><span>
</span><a name="line-1745"></a><span class="hs-comment">-- leaves us just with mutually recursive and/or mismatching bindings,</span><span>
</span><a name="line-1746"></a><span class="hs-comment">-- which we then specuatively match by ordering them. It's by no means</span><span>
</span><a name="line-1747"></a><span class="hs-comment">-- perfect, but gets the job done well enough.</span><span>
</span><a name="line-1748"></a><span class="hs-identifier">diffBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarEnv.html#RnEnv2"><span class="hs-identifier hs-type">RnEnv2</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1749"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="VarEnv.html#RnEnv2"><span class="hs-identifier hs-type">RnEnv2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1750"></a><a name="diffBinds"><a href="CoreUtils.html#diffBinds"><span class="hs-identifier">diffBinds</span></a></a><span> </span><a name="local-1627735725"><a href="#local-1627735725"><span class="hs-identifier">top</span></a></a><span> </span><a name="local-1627735726"><a href="#local-1627735726"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-1627735727"><a href="#local-1627735727"><span class="hs-identifier">binds1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735728"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><a href="#local-1627735727"><span class="hs-identifier hs-var">binds1</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735726"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735727"><span class="hs-identifier hs-var">binds1</span></a><span>
</span><a name="line-1751"></a><span> </span><span class="hs-keyword">where</span><span> </span><a name="local-1627735728"><a href="#local-1627735728"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-identifier">_</span><span>    </span><a name="local-1627735732"><a href="#local-1627735732"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1752"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-1627735732"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1753"></a><span>       </span><span class="hs-identifier">go</span><span> </span><a name="local-1627735733"><a href="#local-1627735733"><span class="hs-identifier">fuel</span></a></a><span> </span><a name="local-1627735734"><a href="#local-1627735734"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-1627735735"><a href="#local-1627735735"><span class="hs-identifier">binds1</span></a></a><span> </span><a name="local-1627735736"><a href="#local-1627735736"><span class="hs-identifier">binds2</span></a></a><span>
</span><a name="line-1754"></a><span>          </span><span class="hs-comment">-- No binds left to compare? Bail out early.</span><span>
</span><a name="line-1755"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1627735735"><span class="hs-identifier hs-var">binds1</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1627735736"><span class="hs-identifier hs-var">binds2</span></a><span>
</span><a name="line-1756"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-1627735729"><span class="hs-identifier hs-var">warn</span></a><span> </span><a href="#local-1627735734"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735735"><span class="hs-identifier hs-var">binds1</span></a><span> </span><a href="#local-1627735736"><span class="hs-identifier hs-var">binds2</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627735734"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1757"></a><span>          </span><span class="hs-comment">-- Iterated over all binds without finding a match? Then</span><span>
</span><a name="line-1758"></a><span>          </span><span class="hs-comment">-- try speculatively matching binders by order.</span><span>
</span><a name="line-1759"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627735733"><span class="hs-identifier hs-var">fuel</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-1760"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="#local-1627735734"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#inRnEnvL"><span class="hs-identifier hs-var">inRnEnvL</span></a><span class="hs-special">`</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#head"><span class="hs-identifier hs-var">head</span></a><span> </span><a href="#local-1627735735"><span class="hs-identifier hs-var">binds1</span></a><span class="hs-special">)</span><span>
</span><a name="line-1761"></a><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1627735737"><a href="#local-1627735737"><span class="hs-identifier">env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#uncurry"><span class="hs-identifier hs-var">uncurry</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#rnBndrs2"><span class="hs-identifier hs-var">rnBndrs2</span></a><span> </span><a href="#local-1627735734"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#unzip"><span class="hs-identifier hs-var">unzip</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1762"></a><span>                            </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zip"><span class="hs-identifier hs-var">zip</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.OldList.html#sort"><span class="hs-identifier hs-var">sort</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a><span> </span><a href="#local-1627735735"><span class="hs-identifier hs-var">binds1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.OldList.html#sort"><span class="hs-identifier hs-var">sort</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a><span> </span><a href="#local-1627735736"><span class="hs-identifier hs-var">binds2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1763"></a><span>                 </span><span class="hs-keyword">in</span><span> </span><a href="#local-1627735728"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><a href="#local-1627735735"><span class="hs-identifier hs-var">binds1</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735737"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-1627735735"><span class="hs-identifier hs-var">binds1</span></a><span> </span><a href="#local-1627735736"><span class="hs-identifier hs-var">binds2</span></a><span>
</span><a name="line-1764"></a><span>            </span><span class="hs-comment">-- If we have already tried that, give up</span><span>
</span><a name="line-1765"></a><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">(</span><a href="#local-1627735729"><span class="hs-identifier hs-var">warn</span></a><span> </span><a href="#local-1627735734"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735735"><span class="hs-identifier hs-var">binds1</span></a><span> </span><a href="#local-1627735736"><span class="hs-identifier hs-var">binds2</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627735734"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1766"></a><span>       </span><span class="hs-identifier">go</span><span> </span><a name="local-1627735738"><a href="#local-1627735738"><span class="hs-identifier">fuel</span></a></a><span> </span><a name="local-1627735739"><a href="#local-1627735739"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-1627735740"><a href="#local-1627735740"><span class="hs-identifier">bndr1</span></a></a><span class="hs-special">,</span><a name="local-1627735741"><a href="#local-1627735741"><span class="hs-identifier">expr1</span></a></a><span class="hs-special">)</span><span class="hs-glyph">:</span><a name="local-1627735742"><a href="#local-1627735742"><span class="hs-identifier">binds1</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627735743"><a href="#local-1627735743"><span class="hs-identifier">binds2</span></a></a><span>
</span><a name="line-1767"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1627735744"><a href="#local-1627735744"><span class="hs-identifier">matchExpr</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1627735745"><a href="#local-1627735745"><span class="hs-identifier">bndr</span></a></a><span class="hs-special">,</span><a name="local-1627735746"><a href="#local-1627735746"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1768"></a><span>                  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-1627735725"><span class="hs-identifier hs-var">top</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><span class="hs-special">(</span><a href="CoreUtils.html#diffIdInfo"><span class="hs-identifier hs-var">diffIdInfo</span></a><span> </span><a href="#local-1627735739"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735745"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-1627735740"><span class="hs-identifier hs-var">bndr1</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-1769"></a><span>                  </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><span class="hs-special">(</span><a href="CoreUtils.html#diffExpr"><span class="hs-identifier hs-var">diffExpr</span></a><span> </span><a href="#local-1627735725"><span class="hs-identifier hs-var">top</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#rnBndr2"><span class="hs-identifier hs-var">rnBndr2</span></a><span> </span><a href="#local-1627735739"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735740"><span class="hs-identifier hs-var">bndr1</span></a><span> </span><a href="#local-1627735745"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735741"><span class="hs-identifier hs-var">expr1</span></a><span> </span><a href="#local-1627735746"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1770"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-1627735747"><a href="#local-1627735747"><span class="hs-identifier">binds2l</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-1627735748"><a href="#local-1627735748"><span class="hs-identifier">bndr2</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-glyph">:</span><a name="local-1627735749"><a href="#local-1627735749"><span class="hs-identifier">binds2r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#break"><span class="hs-identifier hs-var">break</span></a><span> </span><a href="#local-1627735744"><span class="hs-identifier hs-var">matchExpr</span></a><span> </span><a href="#local-1627735743"><span class="hs-identifier hs-var">binds2</span></a><span>
</span><a name="line-1771"></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735728"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><a href="#local-1627735742"><span class="hs-identifier hs-var">binds1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="VarEnv.html#rnBndr2"><span class="hs-identifier hs-var">rnBndr2</span></a><span> </span><a href="#local-1627735739"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735740"><span class="hs-identifier hs-var">bndr1</span></a><span> </span><a href="#local-1627735748"><span class="hs-identifier hs-var">bndr2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1772"></a><span>                </span><a href="#local-1627735742"><span class="hs-identifier hs-var">binds1</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627735747"><span class="hs-identifier hs-var">binds2l</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-1627735749"><span class="hs-identifier hs-var">binds2r</span></a><span class="hs-special">)</span><span>
</span><a name="line-1773"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-comment">-- No match, so push back (FIXME O(n^2))</span><span>
</span><a name="line-1774"></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735728"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627735738"><span class="hs-identifier hs-var">fuel</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-1627735739"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627735742"><span class="hs-identifier hs-var">binds1</span></a><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-1627735740"><span class="hs-identifier hs-var">bndr1</span></a><span class="hs-special">,</span><a href="#local-1627735741"><span class="hs-identifier hs-var">expr1</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="#local-1627735743"><span class="hs-identifier hs-var">binds2</span></a><span>
</span><a name="line-1775"></a><span>       </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Panic.html#panic"><span class="hs-identifier hs-var">panic</span></a><span> </span><span class="hs-string">&quot;diffBinds: impossible&quot;</span><span> </span><span class="hs-comment">-- GHC isn't smart enough</span><span>
</span><a name="line-1776"></a><span>
</span><a name="line-1777"></a><span>       </span><span class="hs-comment">-- We have tried everything, but couldn't find a good match. So</span><span>
</span><a name="line-1778"></a><span>       </span><span class="hs-comment">-- now we just return the comparison results when we pair up</span><span>
</span><a name="line-1779"></a><span>       </span><span class="hs-comment">-- the binds in a pseudo-random order.</span><span>
</span><a name="line-1780"></a><span>       </span><a name="local-1627735729"><a href="#local-1627735729"><span class="hs-identifier">warn</span></a></a><span> </span><a name="local-1627735750"><a href="#local-1627735750"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-1627735751"><a href="#local-1627735751"><span class="hs-identifier">binds1</span></a></a><span> </span><a name="local-1627735752"><a href="#local-1627735752"><span class="hs-identifier">binds2</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1781"></a><span>         </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#concatMap"><span class="hs-identifier hs-var">concatMap</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#uncurry"><span class="hs-identifier hs-var">uncurry</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627735731"><span class="hs-identifier hs-var">diffBind</span></a><span> </span><a href="#local-1627735750"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zip"><span class="hs-identifier hs-var">zip</span></a><span> </span><a href="#local-1627735753"><span class="hs-identifier hs-var">binds1'</span></a><span> </span><a href="#local-1627735754"><span class="hs-identifier hs-var">binds2'</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span>
</span><a name="line-1782"></a><span>         </span><a href="#local-1627735730"><span class="hs-identifier hs-var">unmatched</span></a><span> </span><span class="hs-string">&quot;unmatched left-hand:&quot;</span><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#drop"><span class="hs-identifier hs-var">drop</span></a><span> </span><a href="#local-1627735755"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-1627735753"><span class="hs-identifier hs-var">binds1'</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span>
</span><a name="line-1783"></a><span>         </span><a href="#local-1627735730"><span class="hs-identifier hs-var">unmatched</span></a><span> </span><span class="hs-string">&quot;unmatched right-hand:&quot;</span><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#drop"><span class="hs-identifier hs-var">drop</span></a><span> </span><a href="#local-1627735755"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-1627735754"><span class="hs-identifier hs-var">binds2'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1784"></a><span>        </span><span class="hs-keyword">where</span><span> </span><a name="local-1627735753"><a href="#local-1627735753"><span class="hs-identifier">binds1'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.OldList.html#sortBy"><span class="hs-identifier hs-var">sortBy</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Ord.html#comparing"><span class="hs-identifier hs-var">comparing</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735751"><span class="hs-identifier hs-var">binds1</span></a><span>
</span><a name="line-1785"></a><span>              </span><a name="local-1627735754"><a href="#local-1627735754"><span class="hs-identifier">binds2'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.OldList.html#sortBy"><span class="hs-identifier hs-var">sortBy</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Ord.html#comparing"><span class="hs-identifier hs-var">comparing</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735752"><span class="hs-identifier hs-var">binds2</span></a><span>
</span><a name="line-1786"></a><span>              </span><a name="local-1627735755"><a href="#local-1627735755"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">min</span><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><a href="#local-1627735753"><span class="hs-identifier hs-var">binds1'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><a href="#local-1627735754"><span class="hs-identifier hs-var">binds2'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1787"></a><span>       </span><a name="local-1627735730"><a href="#local-1627735730"><span class="hs-identifier">unmatched</span></a></a><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1788"></a><span>       </span><span class="hs-identifier">unmatched</span><span> </span><a name="local-1627735756"><a href="#local-1627735756"><span class="hs-identifier">txt</span></a></a><span> </span><a name="local-1627735757"><a href="#local-1627735757"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><a href="#local-1627735756"><span class="hs-identifier hs-var">txt</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><a href="#local-1627735757"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1789"></a><span>       </span><a name="local-1627735731"><a href="#local-1627735731"><span class="hs-identifier">diffBind</span></a></a><span> </span><a name="local-1627735758"><a href="#local-1627735758"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1627735759"><a href="#local-1627735759"><span class="hs-identifier">bndr1</span></a></a><span class="hs-special">,</span><a name="local-1627735760"><a href="#local-1627735760"><span class="hs-identifier">expr1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-1627735761"><a href="#local-1627735761"><span class="hs-identifier">bndr2</span></a></a><span class="hs-special">,</span><a name="local-1627735762"><a href="#local-1627735762"><span class="hs-identifier">expr2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1790"></a><span>         </span><span class="hs-glyph">|</span><span> </span><a name="local-1627735763"><a href="#local-1627735763"><span class="hs-identifier">ds</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreUtils.html#diffExpr"><span class="hs-identifier hs-var">diffExpr</span></a><span> </span><a href="#local-1627735725"><span class="hs-identifier hs-var">top</span></a><span> </span><a href="#local-1627735758"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735760"><span class="hs-identifier hs-var">expr1</span></a><span> </span><a href="#local-1627735762"><span class="hs-identifier hs-var">expr2</span></a><span>
</span><a name="line-1791"></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#locBind"><span class="hs-identifier hs-var">locBind</span></a><span> </span><span class="hs-string">&quot;in binding&quot;</span><span> </span><a href="#local-1627735759"><span class="hs-identifier hs-var">bndr1</span></a><span> </span><a href="#local-1627735761"><span class="hs-identifier hs-var">bndr2</span></a><span> </span><a href="#local-1627735763"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-1792"></a><span>         </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1793"></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#diffIdInfo"><span class="hs-identifier hs-var">diffIdInfo</span></a><span> </span><a href="#local-1627735758"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735759"><span class="hs-identifier hs-var">bndr1</span></a><span> </span><a href="#local-1627735761"><span class="hs-identifier hs-var">bndr2</span></a><span>
</span><a name="line-1794"></a><span>
</span><a name="line-1795"></a><span class="hs-comment">-- | Find differences in @IdInfo@. We will especially check whether</span><span>
</span><a name="line-1796"></a><span class="hs-comment">-- the unfoldings match, if present (see @diffUnfold@).</span><span>
</span><a name="line-1797"></a><span class="hs-identifier">diffIdInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#RnEnv2"><span class="hs-identifier hs-type">RnEnv2</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span class="hs-special">]</span><span>
</span><a name="line-1798"></a><a name="diffIdInfo"><a href="CoreUtils.html#diffIdInfo"><span class="hs-identifier">diffIdInfo</span></a></a><span> </span><a name="local-1627735764"><a href="#local-1627735764"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-1627735765"><a href="#local-1627735765"><span class="hs-identifier">bndr1</span></a></a><span> </span><a name="local-1627735766"><a href="#local-1627735766"><span class="hs-identifier">bndr2</span></a></a><span>
</span><a name="line-1799"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">arityInfo</span><span> </span><a href="#local-1627735767"><span class="hs-identifier hs-var">info1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">arityInfo</span><span> </span><a href="#local-1627735768"><span class="hs-identifier hs-var">info2</span></a><span>
</span><a name="line-1800"></a><span>    </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier">cafInfo</span><span> </span><a href="#local-1627735767"><span class="hs-identifier hs-var">info1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">cafInfo</span><span> </span><a href="#local-1627735768"><span class="hs-identifier hs-var">info2</span></a><span>
</span><a name="line-1801"></a><span>    </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier">oneShotInfo</span><span> </span><a href="#local-1627735767"><span class="hs-identifier hs-var">info1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">oneShotInfo</span><span> </span><a href="#local-1627735768"><span class="hs-identifier hs-var">info2</span></a><span>
</span><a name="line-1802"></a><span>    </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier">inlinePragInfo</span><span> </span><a href="#local-1627735767"><span class="hs-identifier hs-var">info1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">inlinePragInfo</span><span> </span><a href="#local-1627735768"><span class="hs-identifier hs-var">info2</span></a><span>
</span><a name="line-1803"></a><span>    </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier">occInfo</span><span> </span><a href="#local-1627735767"><span class="hs-identifier hs-var">info1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">occInfo</span><span> </span><a href="#local-1627735768"><span class="hs-identifier hs-var">info2</span></a><span>
</span><a name="line-1804"></a><span>    </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier">demandInfo</span><span> </span><a href="#local-1627735767"><span class="hs-identifier hs-var">info1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">demandInfo</span><span> </span><a href="#local-1627735768"><span class="hs-identifier hs-var">info2</span></a><span>
</span><a name="line-1805"></a><span>    </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier">callArityInfo</span><span> </span><a href="#local-1627735767"><span class="hs-identifier hs-var">info1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">callArityInfo</span><span> </span><a href="#local-1627735768"><span class="hs-identifier hs-var">info2</span></a><span>
</span><a name="line-1806"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#locBind"><span class="hs-identifier hs-var">locBind</span></a><span> </span><span class="hs-string">&quot;in unfolding of&quot;</span><span> </span><a href="#local-1627735765"><span class="hs-identifier hs-var">bndr1</span></a><span> </span><a href="#local-1627735766"><span class="hs-identifier hs-var">bndr2</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1807"></a><span>    </span><a href="CoreUtils.html#diffUnfold"><span class="hs-identifier hs-var">diffUnfold</span></a><span> </span><a href="#local-1627735764"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">unfoldingInfo</span><span> </span><a href="#local-1627735767"><span class="hs-identifier hs-var">info1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">unfoldingInfo</span><span> </span><a href="#local-1627735768"><span class="hs-identifier hs-var">info2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1808"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1809"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#locBind"><span class="hs-identifier hs-var">locBind</span></a><span> </span><span class="hs-string">&quot;in Id info of&quot;</span><span> </span><a href="#local-1627735765"><span class="hs-identifier hs-var">bndr1</span></a><span> </span><a href="#local-1627735766"><span class="hs-identifier hs-var">bndr2</span></a><span>
</span><a name="line-1810"></a><span>    </span><span class="hs-special">[</span><a href="Outputable.html#fsep"><span class="hs-identifier hs-var">fsep</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#pprBndr"><span class="hs-identifier hs-var">pprBndr</span></a><span> </span><a href="Outputable.html#LetBind"><span class="hs-identifier hs-var">LetBind</span></a><span> </span><a href="#local-1627735765"><span class="hs-identifier hs-var">bndr1</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;/=&quot;</span><span class="hs-special">,</span><span> </span><a href="Outputable.html#pprBndr"><span class="hs-identifier hs-var">pprBndr</span></a><span> </span><a href="Outputable.html#LetBind"><span class="hs-identifier hs-var">LetBind</span></a><span> </span><a href="#local-1627735766"><span class="hs-identifier hs-var">bndr2</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-1811"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-1627735767"><a href="#local-1627735767"><span class="hs-identifier">info1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#idInfo"><span class="hs-identifier hs-var">idInfo</span></a><span> </span><a href="#local-1627735765"><span class="hs-identifier hs-var">bndr1</span></a><span class="hs-special">;</span><span> </span><a name="local-1627735768"><a href="#local-1627735768"><span class="hs-identifier">info2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#idInfo"><span class="hs-identifier hs-var">idInfo</span></a><span> </span><a href="#local-1627735766"><span class="hs-identifier hs-var">bndr2</span></a><span>
</span><a name="line-1812"></a><span>
</span><a name="line-1813"></a><span class="hs-comment">-- | Find differences in unfoldings. Note that we will not check for</span><span>
</span><a name="line-1814"></a><span class="hs-comment">-- differences of @IdInfo@ in unfoldings, as this is generally</span><span>
</span><a name="line-1815"></a><span class="hs-comment">-- redundant, and can lead to an exponential blow-up in complexity.</span><span>
</span><a name="line-1816"></a><span class="hs-identifier">diffUnfold</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#RnEnv2"><span class="hs-identifier hs-type">RnEnv2</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span class="hs-special">]</span><span>
</span><a name="line-1817"></a><a name="diffUnfold"><a href="CoreUtils.html#diffUnfold"><span class="hs-identifier">diffUnfold</span></a></a><span> </span><span class="hs-identifier">_</span><span>   </span><a href="CoreSyn.html#NoUnfolding"><span class="hs-identifier hs-var">NoUnfolding</span></a><span>    </span><a href="CoreSyn.html#NoUnfolding"><span class="hs-identifier hs-var">NoUnfolding</span></a><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1818"></a><span class="hs-identifier">diffUnfold</span><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-special">(</span><a href="CoreSyn.html#OtherCon"><span class="hs-identifier hs-var">OtherCon</span></a><span> </span><a name="local-1627735769"><a href="#local-1627735769"><span class="hs-identifier">cs1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#OtherCon"><span class="hs-identifier hs-var">OtherCon</span></a><span> </span><a name="local-1627735770"><a href="#local-1627735770"><span class="hs-identifier">cs2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627735769"><span class="hs-identifier hs-var">cs1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-1627735770"><span class="hs-identifier hs-var">cs2</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1819"></a><span class="hs-identifier">diffUnfold</span><span> </span><a name="local-1627735771"><a href="#local-1627735771"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#DFunUnfolding"><span class="hs-identifier hs-var">DFunUnfolding</span></a><span> </span><a name="local-1627735772"><a href="#local-1627735772"><span class="hs-identifier">bs1</span></a></a><span> </span><a name="local-1627735773"><a href="#local-1627735773"><span class="hs-identifier">c1</span></a></a><span> </span><a name="local-1627735774"><a href="#local-1627735774"><span class="hs-identifier">a1</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1820"></a><span>               </span><span class="hs-special">(</span><a href="CoreSyn.html#DFunUnfolding"><span class="hs-identifier hs-var">DFunUnfolding</span></a><span> </span><a name="local-1627735775"><a href="#local-1627735775"><span class="hs-identifier">bs2</span></a></a><span> </span><a name="local-1627735776"><a href="#local-1627735776"><span class="hs-identifier">c2</span></a></a><span> </span><a name="local-1627735777"><a href="#local-1627735777"><span class="hs-identifier">a2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1821"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627735773"><span class="hs-identifier hs-var">c1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-1627735776"><span class="hs-identifier hs-var">c2</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><a href="#local-1627735772"><span class="hs-identifier hs-var">bs1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><a href="#local-1627735775"><span class="hs-identifier hs-var">bs2</span></a><span>
</span><a name="line-1822"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#concatMap"><span class="hs-identifier hs-var">concatMap</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#uncurry"><span class="hs-identifier hs-var">uncurry</span></a><span> </span><span class="hs-special">(</span><a href="CoreUtils.html#diffExpr"><span class="hs-identifier hs-var">diffExpr</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-1627735778"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zip"><span class="hs-identifier hs-var">zip</span></a><span> </span><a href="#local-1627735774"><span class="hs-identifier hs-var">a1</span></a><span> </span><a href="#local-1627735777"><span class="hs-identifier hs-var">a2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1823"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-1627735778"><a href="#local-1627735778"><span class="hs-identifier">env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#rnBndrs2"><span class="hs-identifier hs-var">rnBndrs2</span></a><span> </span><a href="#local-1627735771"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735772"><span class="hs-identifier hs-var">bs1</span></a><span> </span><a href="#local-1627735775"><span class="hs-identifier hs-var">bs2</span></a><span>
</span><a name="line-1824"></a><span class="hs-identifier">diffUnfold</span><span> </span><a name="local-1627735779"><a href="#local-1627735779"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#CoreUnfolding"><span class="hs-identifier hs-var">CoreUnfolding</span></a><span> </span><a name="local-1627735780"><a href="#local-1627735780"><span class="hs-identifier">t1</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627735781"><a href="#local-1627735781"><span class="hs-identifier">v1</span></a></a><span> </span><a name="local-1627735782"><a href="#local-1627735782"><span class="hs-identifier">cl1</span></a></a><span> </span><a name="local-1627735783"><a href="#local-1627735783"><span class="hs-identifier">wf1</span></a></a><span> </span><a name="local-1627735784"><a href="#local-1627735784"><span class="hs-identifier">x1</span></a></a><span> </span><a name="local-1627735785"><a href="#local-1627735785"><span class="hs-identifier">g1</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1825"></a><span>               </span><span class="hs-special">(</span><a href="CoreSyn.html#CoreUnfolding"><span class="hs-identifier hs-var">CoreUnfolding</span></a><span> </span><a name="local-1627735786"><a href="#local-1627735786"><span class="hs-identifier">t2</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627735787"><a href="#local-1627735787"><span class="hs-identifier">v2</span></a></a><span> </span><a name="local-1627735788"><a href="#local-1627735788"><span class="hs-identifier">cl2</span></a></a><span> </span><a name="local-1627735789"><a href="#local-1627735789"><span class="hs-identifier">wf2</span></a></a><span> </span><a name="local-1627735790"><a href="#local-1627735790"><span class="hs-identifier">x2</span></a></a><span> </span><a name="local-1627735791"><a href="#local-1627735791"><span class="hs-identifier">g2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1826"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627735781"><span class="hs-identifier hs-var">v1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-1627735787"><span class="hs-identifier hs-var">v2</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-1627735782"><span class="hs-identifier hs-var">cl1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-1627735788"><span class="hs-identifier hs-var">cl2</span></a><span>
</span><a name="line-1827"></a><span>    </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-1627735783"><span class="hs-identifier hs-var">wf1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-1627735789"><span class="hs-identifier hs-var">wf2</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-1627735784"><span class="hs-identifier hs-var">x1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-1627735790"><span class="hs-identifier hs-var">x2</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-1627735785"><span class="hs-identifier hs-var">g1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-1627735791"><span class="hs-identifier hs-var">g2</span></a><span>
</span><a name="line-1828"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#diffExpr"><span class="hs-identifier hs-var">diffExpr</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-1627735779"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627735780"><span class="hs-identifier hs-var">t1</span></a><span> </span><a href="#local-1627735786"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-1829"></a><span class="hs-identifier">diffUnfold</span><span> </span><span class="hs-identifier">_</span><span>   </span><a name="local-1627735792"><a href="#local-1627735792"><span class="hs-identifier">uf1</span></a></a><span> </span><a name="local-1627735793"><a href="#local-1627735793"><span class="hs-identifier">uf2</span></a></a><span>
</span><a name="line-1830"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="Outputable.html#fsep"><span class="hs-identifier hs-var">fsep</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1627735792"><span class="hs-identifier hs-var">uf1</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;/=&quot;</span><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1627735793"><span class="hs-identifier hs-var">uf2</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-1831"></a><span>
</span><a name="line-1832"></a><span class="hs-comment">-- | Add location information to diff messages</span><span>
</span><a name="line-1833"></a><span class="hs-identifier">locBind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span class="hs-special">]</span><span>
</span><a name="line-1834"></a><a name="locBind"><a href="CoreUtils.html#locBind"><span class="hs-identifier">locBind</span></a></a><span> </span><a name="local-1627735794"><a href="#local-1627735794"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-1627735795"><a href="#local-1627735795"><span class="hs-identifier">b1</span></a></a><span> </span><a name="local-1627735796"><a href="#local-1627735796"><span class="hs-identifier">b2</span></a></a><span> </span><a name="local-1627735797"><a href="#local-1627735797"><span class="hs-identifier">diffs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="#local-1627735798"><span class="hs-identifier hs-var">addLoc</span></a><span> </span><a href="#local-1627735797"><span class="hs-identifier hs-var">diffs</span></a><span>
</span><a name="line-1835"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-1627735798"><a href="#local-1627735798"><span class="hs-identifier">addLoc</span></a></a><span> </span><a name="local-1627735800"><a href="#local-1627735800"><span class="hs-identifier">d</span></a></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735800"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><a href="#local-1627735794"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="#local-1627735799"><span class="hs-identifier hs-var">bindLoc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1836"></a><span>        </span><a name="local-1627735799"><a href="#local-1627735799"><span class="hs-identifier">bindLoc</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627735795"><span class="hs-identifier hs-var">b1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-1627735796"><span class="hs-identifier hs-var">b2</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1627735795"><span class="hs-identifier hs-var">b1</span></a><span>
</span><a name="line-1837"></a><span>                </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1627735795"><span class="hs-identifier hs-var">b1</span></a><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#char"><span class="hs-identifier hs-var">char</span></a><span> </span><span class="hs-char">'/'</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1627735796"><span class="hs-identifier hs-var">b2</span></a><span>
</span><a name="line-1838"></a><span>
</span><a name="line-1839"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Eta reduction
*                                                                      *
************************************************************************

Note [Eta reduction conditions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We try for eta reduction here, but *only* if we get all the way to an
trivial expression.  We don't want to remove extra lambdas unless we
are going to avoid allocating this thing altogether.

There are some particularly delicate points here:

* We want to eta-reduce if doing so leaves a trivial expression,
  *including* a cast.  For example
       \x. f |&gt; co  --&gt;  f |&gt; co
  (provided co doesn't mention x)

* Eta reduction is not valid in general:
        \x. bot  /=  bot
  This matters, partly for old-fashioned correctness reasons but,
  worse, getting it wrong can yield a seg fault. Consider
        f = \x.f x
        h y = case (case y of { True -&gt; f `seq` True; False -&gt; False }) of
                True -&gt; ...; False -&gt; ...

  If we (unsoundly) eta-reduce f to get f=f, the strictness analyser
  says f=bottom, and replaces the (f `seq` True) with just
  (f `cast` unsafe-co).  BUT, as thing stand, 'f' got arity 1, and it
  *keeps* arity 1 (perhaps also wrongly).  So CorePrep eta-expands
  the definition again, so that it does not termninate after all.
  Result: seg-fault because the boolean case actually gets a function value.
  See Trac #1947.

  So it's important to do the right thing.

* Note [Arity care]: we need to be careful if we just look at f's
  arity. Currently (Dec07), f's arity is visible in its own RHS (see
  Note [Arity robustness] in SimplEnv) so we must *not* trust the
  arity when checking that 'f' is a value.  Otherwise we will
  eta-reduce
      f = \x. f x
  to
      f = f
  Which might change a terminating program (think (f `seq` e)) to a
  non-terminating one.  So we check for being a loop breaker first.

  However for GlobalIds we can look at the arity; and for primops we
  must, since they have no unfolding.

* Regardless of whether 'f' is a value, we always want to
  reduce (/\a -&gt; f a) to f
  This came up in a RULE: foldr (build (/\a -&gt; g a))
  did not match           foldr (build (/\b -&gt; ...something complex...))
  The type checker can insert these eta-expanded versions,
  with both type and dictionary lambdas; hence the slightly
  ad-hoc isDictId

* Never *reduce* arity. For example
      f = \xy. g x y
  Then if h has arity 1 we don't want to eta-reduce because then
  f's arity would decrease, and that is bad

These delicacies are why we don't use exprIsTrivial and exprIsHNF here.
Alas.

Note [Eta reduction with casted arguments]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
    (\(x:t3). f (x |&gt; g)) :: t3 -&gt; t2
  where
    f :: t1 -&gt; t2
    g :: t3 ~ t1
This should be eta-reduced to

    f |&gt; (sym g -&gt; t2)

So we need to accumulate a coercion, pushing it inward (past
variable arguments only) thus:
   f (x |&gt; co_arg) |&gt; co  --&gt;  (f |&gt; (sym co_arg -&gt; co)) x
   f (x:t)         |&gt; co  --&gt;  (f |&gt; (t -&gt; co)) x
   f @ a           |&gt; co  --&gt;  (f |&gt; (forall a.co)) @ a
   f @ (g:t1~t2)   |&gt; co  --&gt;  (f |&gt; (t1~t2 =&gt; co)) @ (g:t1~t2)
These are the equations for ok_arg.

It's true that we could also hope to eta reduce these:
    (\xy. (f x |&gt; g) y)
    (\xy. (f x y) |&gt; g)
But the simplifier pushes those casts outwards, so we don't
need to address that here.
-}</span><span>
</span><a name="line-1932"></a><span>
</span><a name="line-1933"></a><span class="hs-identifier">tryEtaReduce</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-1934"></a><a name="tryEtaReduce"><a href="CoreUtils.html#tryEtaReduce"><span class="hs-identifier">tryEtaReduce</span></a></a><span> </span><a name="local-1627735801"><a href="#local-1627735801"><span class="hs-identifier">bndrs</span></a></a><span> </span><a name="local-1627735802"><a href="#local-1627735802"><span class="hs-identifier">body</span></a></a><span>
</span><a name="line-1935"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735804"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#reverse"><span class="hs-identifier hs-var">reverse</span></a><span> </span><a href="#local-1627735801"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735802"><span class="hs-identifier hs-var">body</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkRepReflCo"><span class="hs-identifier hs-var">mkRepReflCo</span></a><span> </span><span class="hs-special">(</span><a href="CoreUtils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a><span> </span><a href="#local-1627735802"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1936"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1937"></a><span>    </span><a name="local-1627735803"><a href="#local-1627735803"><span class="hs-identifier">incoming_arity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#count"><span class="hs-identifier hs-var">count</span></a><span> </span><a href="Var.html#isId"><span class="hs-identifier hs-var">isId</span></a><span> </span><a href="#local-1627735801"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-1938"></a><span>
</span><a name="line-1939"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span>            </span><span class="hs-comment">-- Binders, innermost first, types [a3,a2,a1]</span><span>
</span><a name="line-1940"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>         </span><span class="hs-comment">-- Of type tr</span><span>
</span><a name="line-1941"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>         </span><span class="hs-comment">-- Of type tr ~ ts</span><span>
</span><a name="line-1942"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>   </span><span class="hs-comment">-- Of type a1 -&gt; a2 -&gt; a3 -&gt; ts</span><span>
</span><a name="line-1943"></a><span>    </span><span class="hs-comment">-- See Note [Eta reduction with casted arguments]</span><span>
</span><a name="line-1944"></a><span>    </span><span class="hs-comment">-- for why we have an accumulating coercion</span><span>
</span><a name="line-1945"></a><span>    </span><a name="local-1627735804"><a href="#local-1627735804"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-1627735810"><a href="#local-1627735810"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-1627735811"><a href="#local-1627735811"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-1946"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627735805"><span class="hs-identifier hs-var">ok_fun</span></a><span> </span><a href="#local-1627735810"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-1947"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1627735812"><a href="#local-1627735812"><span class="hs-identifier">used_vars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreFVs.html#exprFreeVars"><span class="hs-identifier hs-var">exprFreeVars</span></a><span> </span><a href="#local-1627735810"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span class="hs-special">`</span><span> </span><a href="TyCoRep.html#tyCoVarsOfCo"><span class="hs-identifier hs-var">tyCoVarsOfCo</span></a><span> </span><a href="#local-1627735811"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1948"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#any"><span class="hs-identifier hs-var">any</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="VarSet.html#elemVarSet"><span class="hs-identifier hs-var">elemVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627735812"><span class="hs-identifier hs-var">used_vars</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735801"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1949"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="CoreUtils.html#mkCast"><span class="hs-identifier hs-var">mkCast</span></a><span> </span><a href="#local-1627735810"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-1627735811"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- Check for any of the binders free in the result</span><span>
</span><a name="line-1950"></a><span>                               </span><span class="hs-comment">-- including the accumulated coercion</span><span>
</span><a name="line-1951"></a><span>
</span><a name="line-1952"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1627735813"><a href="#local-1627735813"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-1627735814"><a href="#local-1627735814"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-1627735815"><a href="#local-1627735815"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627735816"><a href="#local-1627735816"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-1953"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a><span> </span><a href="#local-1627735814"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-1954"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a href="#local-1627735814"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="#local-1627735804"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735813"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="#local-1627735815"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-1627735816"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1955"></a><span>      </span><span class="hs-comment">-- Float app ticks: \x -&gt; Tick t (e x) ==&gt; Tick t e</span><span>
</span><a name="line-1956"></a><span>
</span><a name="line-1957"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a name="local-1627735817"><a href="#local-1627735817"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-1627735818"><a href="#local-1627735818"><span class="hs-identifier">bs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-1627735819"><a href="#local-1627735819"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-1627735820"><a href="#local-1627735820"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627735821"><a href="#local-1627735821"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-1958"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1627735822"><a href="#local-1627735822"><span class="hs-identifier">co'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627735823"><a href="#local-1627735823"><span class="hs-identifier">ticks</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627735809"><span class="hs-identifier hs-var">ok_arg</span></a><span> </span><a href="#local-1627735817"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-1627735820"><span class="hs-identifier hs-var">arg</span></a><span> </span><a href="#local-1627735821"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1959"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#flip"><span class="hs-identifier hs-var">flip</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#foldr"><span class="hs-identifier hs-var">foldr</span></a><span> </span><a href="CoreUtils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735823"><span class="hs-identifier hs-var">ticks</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="#local-1627735804"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735818"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="#local-1627735819"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-1627735822"><span class="hs-identifier hs-var">co'</span></a><span>
</span><a name="line-1960"></a><span>            </span><span class="hs-comment">-- Float arg ticks: \x -&gt; e (Tick t x) ==&gt; Tick t e</span><span>
</span><a name="line-1961"></a><span>
</span><a name="line-1962"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>         </span><span class="hs-comment">-- Failure!</span><span>
</span><a name="line-1963"></a><span>
</span><a name="line-1964"></a><span>    </span><span class="hs-comment">---------------</span><span>
</span><a name="line-1965"></a><span>    </span><span class="hs-comment">-- Note [Eta reduction conditions]</span><span>
</span><a name="line-1966"></a><span>    </span><a name="local-1627735805"><a href="#local-1627735805"><span class="hs-identifier">ok_fun</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-1627735824"><a href="#local-1627735824"><span class="hs-identifier">fun</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735805"><span class="hs-identifier hs-var">ok_fun</span></a><span> </span><a href="#local-1627735824"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-1967"></a><span>    </span><span class="hs-identifier">ok_fun</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-1627735825"><a href="#local-1627735825"><span class="hs-identifier">fun</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735805"><span class="hs-identifier hs-var">ok_fun</span></a><span> </span><a href="#local-1627735825"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-1968"></a><span>    </span><span class="hs-identifier">ok_fun</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627735826"><a href="#local-1627735826"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735805"><span class="hs-identifier hs-var">ok_fun</span></a><span> </span><a href="#local-1627735826"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-1969"></a><span>    </span><span class="hs-identifier">ok_fun</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-1627735827"><a href="#local-1627735827"><span class="hs-identifier">fun_id</span></a></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735806"><span class="hs-identifier hs-var">ok_fun_id</span></a><span> </span><a href="#local-1627735827"><span class="hs-identifier hs-var">fun_id</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a><span> </span><a href="#local-1627735808"><span class="hs-identifier hs-var">ok_lam</span></a><span> </span><a href="#local-1627735801"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-1970"></a><span>    </span><span class="hs-identifier">ok_fun</span><span> </span><a name="local-1627735828"><a href="#local-1627735828"><span class="hs-identifier">_fun</span></a></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1971"></a><span>
</span><a name="line-1972"></a><span>    </span><span class="hs-comment">---------------</span><span>
</span><a name="line-1973"></a><span>    </span><a name="local-1627735806"><a href="#local-1627735806"><span class="hs-identifier">ok_fun_id</span></a></a><span> </span><a name="local-1627735829"><a href="#local-1627735829"><span class="hs-identifier">fun</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735807"><span class="hs-identifier hs-var">fun_arity</span></a><span> </span><a href="#local-1627735829"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><a href="#local-1627735803"><span class="hs-identifier hs-var">incoming_arity</span></a><span>
</span><a name="line-1974"></a><span>
</span><a name="line-1975"></a><span>    </span><span class="hs-comment">---------------</span><span>
</span><a name="line-1976"></a><span>    </span><a name="local-1627735807"><a href="#local-1627735807"><span class="hs-identifier">fun_arity</span></a></a><span> </span><a name="local-1627735830"><a href="#local-1627735830"><span class="hs-identifier">fun</span></a></a><span>             </span><span class="hs-comment">-- See Note [Arity care]</span><span>
</span><a name="line-1977"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isLocalId"><span class="hs-identifier hs-var">isLocalId</span></a><span> </span><a href="#local-1627735830"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-1978"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="BasicTypes.html#isStrongLoopBreaker"><span class="hs-identifier hs-var">isStrongLoopBreaker</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idOccInfo"><span class="hs-identifier hs-var">idOccInfo</span></a><span> </span><a href="#local-1627735830"><span class="hs-identifier hs-var">fun</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-1979"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627735831"><span class="hs-identifier hs-var">arity</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span>                           </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735831"><span class="hs-identifier hs-var">arity</span></a><span>
</span><a name="line-1980"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#isEvaldUnfolding"><span class="hs-identifier hs-var">isEvaldUnfolding</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idUnfolding"><span class="hs-identifier hs-var">idUnfolding</span></a><span> </span><a href="#local-1627735830"><span class="hs-identifier hs-var">fun</span></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-1981"></a><span>            </span><span class="hs-comment">-- See Note [Eta reduction of an eval'd function]</span><span>
</span><a name="line-1982"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>                           </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-1983"></a><span>       </span><span class="hs-keyword">where</span><span>
</span><a name="line-1984"></a><span>         </span><a name="local-1627735831"><a href="#local-1627735831"><span class="hs-identifier">arity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a><span> </span><a href="#local-1627735830"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-1985"></a><span>
</span><a name="line-1986"></a><span>    </span><span class="hs-comment">---------------</span><span>
</span><a name="line-1987"></a><span>    </span><a name="local-1627735808"><a href="#local-1627735808"><span class="hs-identifier">ok_lam</span></a></a><span> </span><a name="local-1627735832"><a href="#local-1627735832"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-1627735832"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="Id.html#isEvVar"><span class="hs-identifier hs-var">isEvVar</span></a><span> </span><a href="#local-1627735832"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-1988"></a><span>
</span><a name="line-1989"></a><span>    </span><span class="hs-comment">---------------</span><span>
</span><a name="line-1990"></a><span>    </span><span class="hs-identifier">ok_arg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span>              </span><span class="hs-comment">-- Of type bndr_t</span><span>
</span><a name="line-1991"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>         </span><span class="hs-comment">-- Of type arg_t</span><span>
</span><a name="line-1992"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>         </span><span class="hs-comment">-- Of kind (t1~t2)</span><span>
</span><a name="line-1993"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>  </span><span class="hs-comment">-- Of type (arg_t -&gt; t1 ~  bndr_t -&gt; t2)</span><span>
</span><a name="line-1994"></a><span>                               </span><span class="hs-comment">--   (and similarly for tyvars, coercion args)</span><span>
</span><a name="line-1995"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1996"></a><span>    </span><span class="hs-comment">-- See Note [Eta reduction with casted arguments]</span><span>
</span><a name="line-1997"></a><span>    </span><a name="local-1627735809"><a href="#local-1627735809"><span class="hs-identifier">ok_arg</span></a></a><span> </span><a name="local-1627735833"><a href="#local-1627735833"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a name="local-1627735834"><a href="#local-1627735834"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627735835"><a href="#local-1627735835"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-1998"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1627735836"><a href="#local-1627735836"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#getTyVar_maybe"><span class="hs-identifier hs-var">getTyVar_maybe</span></a><span> </span><a href="#local-1627735834"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1999"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="#local-1627735833"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-1627735836"><span class="hs-identifier hs-var">tv</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkHomoForAllCos"><span class="hs-identifier hs-var">mkHomoForAllCos</span></a><span> </span><span class="hs-special">[</span><a href="#local-1627735836"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">]</span><span> </span><a href="#local-1627735835"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2000"></a><span>    </span><span class="hs-identifier">ok_arg</span><span> </span><a name="local-1627735837"><a href="#local-1627735837"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-1627735838"><a href="#local-1627735838"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627735839"><a href="#local-1627735839"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-2001"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627735837"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-1627735838"><span class="hs-identifier hs-var">v</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1627735840"><a href="#local-1627735840"><span class="hs-identifier">reflCo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkRepReflCo"><span class="hs-identifier hs-var">mkRepReflCo</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idType"><span class="hs-identifier hs-var">idType</span></a><span> </span><a href="#local-1627735837"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2002"></a><span>                       </span><span class="hs-keyword">in</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkFunCo"><span class="hs-identifier hs-var">mkFunCo</span></a><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span> </span><a href="#local-1627735840"><span class="hs-identifier hs-var">reflCo</span></a><span> </span><a href="#local-1627735839"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2003"></a><span>    </span><span class="hs-identifier">ok_arg</span><span> </span><a name="local-1627735841"><a href="#local-1627735841"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-1627735842"><a href="#local-1627735842"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-1627735843"><a href="#local-1627735843"><span class="hs-identifier">co_arg</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627735844"><a href="#local-1627735844"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-2004"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-1627735845"><a href="#local-1627735845"><span class="hs-identifier">ticks</span></a></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-1627735846"><a href="#local-1627735846"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreUtils.html#stripTicksTop"><span class="hs-identifier hs-var">stripTicksTop</span></a><span> </span><a href="CoreSyn.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a><span> </span><a href="#local-1627735842"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-2005"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="#local-1627735841"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-1627735846"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-2006"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkFunCo"><span class="hs-identifier hs-var">mkFunCo</span></a><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a><span> </span><a href="#local-1627735843"><span class="hs-identifier hs-var">co_arg</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735844"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627735845"><span class="hs-identifier hs-var">ticks</span></a><span class="hs-special">)</span><span>
</span><a name="line-2007"></a><span>       </span><span class="hs-comment">-- The simplifier combines multiple casts into one,</span><span>
</span><a name="line-2008"></a><span>       </span><span class="hs-comment">-- so we can have a simple-minded pattern match here</span><span>
</span><a name="line-2009"></a><span>    </span><span class="hs-identifier">ok_arg</span><span> </span><a name="local-1627735847"><a href="#local-1627735847"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-1627735848"><a href="#local-1627735848"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-1627735849"><a href="#local-1627735849"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627735850"><a href="#local-1627735850"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-2010"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a><span> </span><a href="#local-1627735848"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1627735851"><a href="#local-1627735851"><span class="hs-identifier">co'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627735852"><a href="#local-1627735852"><span class="hs-identifier">ticks</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627735809"><span class="hs-identifier hs-var">ok_arg</span></a><span> </span><a href="#local-1627735847"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-1627735849"><span class="hs-identifier hs-var">arg</span></a><span> </span><a href="#local-1627735850"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-2011"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627735851"><span class="hs-identifier hs-var">co'</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627735848"><span class="hs-identifier hs-var">t</span></a><span class="hs-glyph">:</span><a href="#local-1627735852"><span class="hs-identifier hs-var">ticks</span></a><span class="hs-special">)</span><span>
</span><a name="line-2012"></a><span>
</span><a name="line-2013"></a><span>    </span><span class="hs-identifier">ok_arg</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-2014"></a><span>
</span><a name="line-2015"></a><span class="hs-comment">{-
Note [Eta reduction of an eval'd function]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In Haskell is is not true that    f = \x. f x
because f might be bottom, and 'seq' can distinguish them.

But it *is* true that   f = f `seq` \x. f x
and we'd like to simplify the latter to the former.  This amounts
to the rule that
  * when there is just *one* value argument,
  * f is not bottom
we can eta-reduce    \x. f x  ===&gt;  f

This turned up in Trac #7542.


************************************************************************
*                                                                      *
\subsection{Determining non-updatable right-hand-sides}
*                                                                      *
************************************************************************

Top-level constructor applications can usually be allocated
statically, but they can't if the constructor, or any of the
arguments, come from another DLL (because we can't refer to static
labels in other DLLs).

If this happens we simply make the RHS into an updatable thunk,
and 'execute' it rather than allocating it statically.
-}</span><span>
</span><a name="line-2045"></a><span>
</span><a name="line-2046"></a><span class="hs-comment">-- | This function is called only on *top-level* right-hand sides.</span><span>
</span><a name="line-2047"></a><span class="hs-comment">-- Returns @True@ if the RHS can be allocated statically in the output,</span><span>
</span><a name="line-2048"></a><span class="hs-comment">-- with no thunks involved at all.</span><span>
</span><a name="line-2049"></a><span class="hs-identifier">rhsIsStatic</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Platform.html#Platform"><span class="hs-identifier hs-type">Platform</span></a><span>
</span><a name="line-2050"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span>         </span><span class="hs-comment">-- Which names are dynamic</span><span>
</span><a name="line-2051"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Integer</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Desugaring for integer literals (disgusting)</span><span>
</span><a name="line-2052"></a><span>                                      </span><span class="hs-comment">-- C.f. Note [Disgusting computation of CafRefs]</span><span>
</span><a name="line-2053"></a><span>                                      </span><span class="hs-comment">--      in TidyPgm</span><span>
</span><a name="line-2054"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-2055"></a><span class="hs-comment">-- It's called (i) in TidyPgm.hasCafRefs to decide if the rhs is, or</span><span>
</span><a name="line-2056"></a><span class="hs-comment">-- refers to, CAFs; (ii) in CoreToStg to decide whether to put an</span><span>
</span><a name="line-2057"></a><span class="hs-comment">-- update flag on it and (iii) in DsExpr to decide how to expand</span><span>
</span><a name="line-2058"></a><span class="hs-comment">-- list literals</span><span>
</span><a name="line-2059"></a><span class="hs-comment">--</span><span>
</span><a name="line-2060"></a><span class="hs-comment">-- The basic idea is that rhsIsStatic returns True only if the RHS is</span><span>
</span><a name="line-2061"></a><span class="hs-comment">--      (a) a value lambda</span><span>
</span><a name="line-2062"></a><span class="hs-comment">--      (b) a saturated constructor application with static args</span><span>
</span><a name="line-2063"></a><span class="hs-comment">--</span><span>
</span><a name="line-2064"></a><span class="hs-comment">-- BUT watch out for</span><span>
</span><a name="line-2065"></a><span class="hs-comment">--  (i) Any cross-DLL references kill static-ness completely</span><span>
</span><a name="line-2066"></a><span class="hs-comment">--      because they must be 'executed' not statically allocated</span><span>
</span><a name="line-2067"></a><span class="hs-comment">--      (&quot;DLL&quot; here really only refers to Windows DLLs, on other platforms,</span><span>
</span><a name="line-2068"></a><span class="hs-comment">--      this is not necessary)</span><span>
</span><a name="line-2069"></a><span class="hs-comment">--</span><span>
</span><a name="line-2070"></a><span class="hs-comment">-- (ii) We treat partial applications as redexes, because in fact we</span><span>
</span><a name="line-2071"></a><span class="hs-comment">--      make a thunk for them that runs and builds a PAP</span><span>
</span><a name="line-2072"></a><span class="hs-comment">--      at run-time.  The only appliations that are treated as</span><span>
</span><a name="line-2073"></a><span class="hs-comment">--      static are *saturated* applications of constructors.</span><span>
</span><a name="line-2074"></a><span>
</span><a name="line-2075"></a><span class="hs-comment">-- We used to try to be clever with nested structures like this:</span><span>
</span><a name="line-2076"></a><span class="hs-comment">--              ys = (:) w ((:) w [])</span><span>
</span><a name="line-2077"></a><span class="hs-comment">-- on the grounds that CorePrep will flatten ANF-ise it later.</span><span>
</span><a name="line-2078"></a><span class="hs-comment">-- But supporting this special case made the function much more</span><span>
</span><a name="line-2079"></a><span class="hs-comment">-- complicated, because the special case only applies if there are no</span><span>
</span><a name="line-2080"></a><span class="hs-comment">-- enclosing type lambdas:</span><span>
</span><a name="line-2081"></a><span class="hs-comment">--              ys = /\ a -&gt; Foo (Baz ([] a))</span><span>
</span><a name="line-2082"></a><span class="hs-comment">-- Here the nested (Baz []) won't float out to top level in CorePrep.</span><span>
</span><a name="line-2083"></a><span class="hs-comment">--</span><span>
</span><a name="line-2084"></a><span class="hs-comment">-- But in fact, even without -O, nested structures at top level are</span><span>
</span><a name="line-2085"></a><span class="hs-comment">-- flattened by the simplifier, so we don't need to be super-clever here.</span><span>
</span><a name="line-2086"></a><span class="hs-comment">--</span><span>
</span><a name="line-2087"></a><span class="hs-comment">-- Examples</span><span>
</span><a name="line-2088"></a><span class="hs-comment">--</span><span>
</span><a name="line-2089"></a><span class="hs-comment">--      f = \x::Int. x+7        TRUE</span><span>
</span><a name="line-2090"></a><span class="hs-comment">--      p = (True,False)        TRUE</span><span>
</span><a name="line-2091"></a><span class="hs-comment">--</span><span>
</span><a name="line-2092"></a><span class="hs-comment">--      d = (fst p, False)      FALSE because there's a redex inside</span><span>
</span><a name="line-2093"></a><span class="hs-comment">--                              (this particular one doesn't happen but...)</span><span>
</span><a name="line-2094"></a><span class="hs-comment">--</span><span>
</span><a name="line-2095"></a><span class="hs-comment">--      h = D# (1.0## /## 2.0##)        FALSE (redex again)</span><span>
</span><a name="line-2096"></a><span class="hs-comment">--      n = /\a. Nil a                  TRUE</span><span>
</span><a name="line-2097"></a><span class="hs-comment">--</span><span>
</span><a name="line-2098"></a><span class="hs-comment">--      t = /\a. (:) (case w a of ...) (Nil a)  FALSE (redex)</span><span>
</span><a name="line-2099"></a><span class="hs-comment">--</span><span>
</span><a name="line-2100"></a><span class="hs-comment">--</span><span>
</span><a name="line-2101"></a><span class="hs-comment">-- This is a bit like CoreUtils.exprIsHNF, with the following differences:</span><span>
</span><a name="line-2102"></a><span class="hs-comment">--    a) scc &quot;foo&quot; (\x -&gt; ...) is updatable (so we catch the right SCC)</span><span>
</span><a name="line-2103"></a><span class="hs-comment">--</span><span>
</span><a name="line-2104"></a><span class="hs-comment">--    b) (C x xs), where C is a contructor is updatable if the application is</span><span>
</span><a name="line-2105"></a><span class="hs-comment">--         dynamic</span><span>
</span><a name="line-2106"></a><span class="hs-comment">--</span><span>
</span><a name="line-2107"></a><span class="hs-comment">--    c) don't look through unfolding of f in (f x).</span><span>
</span><a name="line-2108"></a><span>
</span><a name="line-2109"></a><a name="rhsIsStatic"><a href="CoreUtils.html#rhsIsStatic"><span class="hs-identifier">rhsIsStatic</span></a></a><span> </span><a name="local-1627735853"><a href="#local-1627735853"><span class="hs-identifier">platform</span></a></a><span> </span><a name="local-1627735854"><a href="#local-1627735854"><span class="hs-identifier">is_dynamic_name</span></a></a><span> </span><a name="local-1627735855"><a href="#local-1627735855"><span class="hs-identifier">cvt_integer</span></a></a><span> </span><a name="local-1627735856"><a href="#local-1627735856"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735857"><span class="hs-identifier hs-var">is_static</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-1627735856"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-2110"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2111"></a><span>  </span><span class="hs-identifier">is_static</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>     </span><span class="hs-comment">-- True &lt;=&gt; in a constructor argument; must be atomic</span><span>
</span><a name="line-2112"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-2113"></a><span>
</span><a name="line-2114"></a><span>  </span><a name="local-1627735857"><a href="#local-1627735857"><span class="hs-identifier">is_static</span></a></a><span> </span><span class="hs-identifier hs-var">False</span><span>  </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a name="local-1627735858"><a href="#local-1627735858"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-1627735859"><a href="#local-1627735859"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#isRuntimeVar"><span class="hs-identifier hs-var">isRuntimeVar</span></a><span> </span><a href="#local-1627735858"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-1627735857"><span class="hs-identifier hs-var">is_static</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-1627735859"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-2115"></a><span>  </span><span class="hs-identifier">is_static</span><span> </span><a name="local-1627735860"><a href="#local-1627735860"><span class="hs-identifier">in_arg</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-1627735861"><a href="#local-1627735861"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-1627735862"><a href="#local-1627735862"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#tickishIsCode"><span class="hs-identifier hs-var">tickishIsCode</span></a><span> </span><a href="#local-1627735861"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-2116"></a><span>                                              </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-1627735857"><span class="hs-identifier hs-var">is_static</span></a><span> </span><a href="#local-1627735860"><span class="hs-identifier hs-var">in_arg</span></a><span> </span><a href="#local-1627735862"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-2117"></a><span>  </span><span class="hs-identifier">is_static</span><span> </span><a name="local-1627735863"><a href="#local-1627735863"><span class="hs-identifier">in_arg</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-1627735864"><a href="#local-1627735864"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>             </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735857"><span class="hs-identifier hs-var">is_static</span></a><span> </span><a href="#local-1627735863"><span class="hs-identifier hs-var">in_arg</span></a><span> </span><a href="#local-1627735864"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-2118"></a><span>  </span><span class="hs-identifier">is_static</span><span> </span><span class="hs-identifier">_</span><span>      </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>   </span><span class="hs-comment">-- Behaves just like a literal</span><span>
</span><a name="line-2119"></a><span>  </span><span class="hs-identifier">is_static</span><span> </span><a name="local-1627735865"><a href="#local-1627735865"><span class="hs-identifier">in_arg</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><span class="hs-special">(</span><a href="Literal.html#LitInteger"><span class="hs-identifier hs-var">LitInteger</span></a><span> </span><a name="local-1627735866"><a href="#local-1627735866"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735857"><span class="hs-identifier hs-var">is_static</span></a><span> </span><a href="#local-1627735865"><span class="hs-identifier hs-var">in_arg</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627735855"><span class="hs-identifier hs-var">cvt_integer</span></a><span> </span><a href="#local-1627735866"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span>
</span><a name="line-2120"></a><span>  </span><span class="hs-identifier">is_static</span><span> </span><span class="hs-identifier">_</span><span>      </span><span class="hs-special">(</span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><span class="hs-special">(</span><a href="Literal.html#MachLabel"><span class="hs-identifier hs-var">MachLabel</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-2121"></a><span>  </span><span class="hs-identifier">is_static</span><span> </span><span class="hs-identifier">_</span><span>      </span><span class="hs-special">(</span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-2122"></a><span>        </span><span class="hs-comment">-- A MachLabel (foreign import &quot;&amp;foo&quot;) in an argument</span><span>
</span><a name="line-2123"></a><span>        </span><span class="hs-comment">-- prevents a constructor application from being static.  The</span><span>
</span><a name="line-2124"></a><span>        </span><span class="hs-comment">-- reason is that it might give rise to unresolvable symbols</span><span>
</span><a name="line-2125"></a><span>        </span><span class="hs-comment">-- in the object file: under Linux, references to &quot;weak&quot;</span><span>
</span><a name="line-2126"></a><span>        </span><span class="hs-comment">-- symbols from the data segment give rise to &quot;unresolvable</span><span>
</span><a name="line-2127"></a><span>        </span><span class="hs-comment">-- relocation&quot; errors at link time This might be due to a bug</span><span>
</span><a name="line-2128"></a><span>        </span><span class="hs-comment">-- in the linker, but we'll work around it here anyway.</span><span>
</span><a name="line-2129"></a><span>        </span><span class="hs-comment">-- SDM 24/2/2004</span><span>
</span><a name="line-2130"></a><span>
</span><a name="line-2131"></a><span>  </span><span class="hs-identifier">is_static</span><span> </span><a name="local-1627735867"><a href="#local-1627735867"><span class="hs-identifier">in_arg</span></a></a><span> </span><a name="local-1627735868"><a href="#local-1627735868"><span class="hs-identifier">other_expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735869"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735868"><span class="hs-identifier hs-var">other_expr</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-2132"></a><span>   </span><span class="hs-keyword">where</span><span>
</span><a name="line-2133"></a><span>    </span><a name="local-1627735869"><a href="#local-1627735869"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-1627735871"><a href="#local-1627735871"><span class="hs-identifier">f</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627735872"><a href="#local-1627735872"><span class="hs-identifier">n_val_args</span></a></a><span>
</span><a name="line-2134"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">platformOS</span><span> </span><a href="#local-1627735853"><span class="hs-identifier hs-var">platform</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><a href="Platform.html#OSMinGW32"><span class="hs-identifier hs-var">OSMinGW32</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">||</span><span>
</span><a name="line-2135"></a><span>          </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-1627735854"><span class="hs-identifier hs-var">is_dynamic_name</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idName"><span class="hs-identifier hs-var">idName</span></a><span> </span><a href="#local-1627735871"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2136"></a><span>        </span><span class="hs-glyph">=</span><span>  </span><a href="#local-1627735870"><span class="hs-identifier hs-var">saturated_data_con</span></a><span> </span><a href="#local-1627735871"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-1627735872"><span class="hs-identifier hs-var">n_val_args</span></a><span>
</span><a name="line-2137"></a><span>        </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-special">(</span><a href="#local-1627735867"><span class="hs-identifier hs-var">in_arg</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-1627735872"><span class="hs-identifier hs-var">n_val_args</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-2138"></a><span>                </span><span class="hs-comment">-- A naked un-applied variable is *not* deemed a static RHS</span><span>
</span><a name="line-2139"></a><span>                </span><span class="hs-comment">-- E.g.         f = g</span><span>
</span><a name="line-2140"></a><span>                </span><span class="hs-comment">-- Reason: better to update so that the indirection gets shorted</span><span>
</span><a name="line-2141"></a><span>                </span><span class="hs-comment">--         out, and the true value will be seen</span><span>
</span><a name="line-2142"></a><span>                </span><span class="hs-comment">-- NB: if you change this, you'll break the invariant that THUNK_STATICs</span><span>
</span><a name="line-2143"></a><span>                </span><span class="hs-comment">--     are always updatable.  If you do so, make sure that non-updatable</span><span>
</span><a name="line-2144"></a><span>                </span><span class="hs-comment">--     ones have enough space for their static link field!</span><span>
</span><a name="line-2145"></a><span>
</span><a name="line-2146"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-1627735873"><a href="#local-1627735873"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-1627735874"><a href="#local-1627735874"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627735875"><a href="#local-1627735875"><span class="hs-identifier">n_val_args</span></a></a><span>
</span><a name="line-2147"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#isTypeArg"><span class="hs-identifier hs-var">isTypeArg</span></a><span> </span><a href="#local-1627735874"><span class="hs-identifier hs-var">a</span></a><span>                    </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735869"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735873"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-1627735875"><span class="hs-identifier hs-var">n_val_args</span></a><span>
</span><a name="line-2148"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-1627735867"><span class="hs-identifier hs-var">in_arg</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-1627735857"><span class="hs-identifier hs-var">is_static</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-1627735874"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735869"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735873"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627735875"><span class="hs-identifier hs-var">n_val_args</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-2149"></a><span>        </span><span class="hs-comment">-- The (not in_arg) checks that we aren't in a constructor argument;</span><span>
</span><a name="line-2150"></a><span>        </span><span class="hs-comment">-- if we are, we don't allow (value) applications of any sort</span><span>
</span><a name="line-2151"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-2152"></a><span>        </span><span class="hs-comment">-- NB. In case you wonder, args are sometimes not atomic.  eg.</span><span>
</span><a name="line-2153"></a><span>        </span><span class="hs-comment">--   x = D# (1.0## /## 2.0##)</span><span>
</span><a name="line-2154"></a><span>        </span><span class="hs-comment">-- can't float because /## can fail.</span><span>
</span><a name="line-2155"></a><span>
</span><a name="line-2156"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-1627735876"><a href="#local-1627735876"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-1627735877"><a href="#local-1627735877"><span class="hs-identifier">f</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627735878"><a href="#local-1627735878"><span class="hs-identifier">n_val_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#tickishIsCode"><span class="hs-identifier hs-var">tickishIsCode</span></a><span> </span><a href="#local-1627735876"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-1627735869"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735877"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-1627735878"><span class="hs-identifier hs-var">n_val_args</span></a><span>
</span><a name="line-2157"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-1627735879"><a href="#local-1627735879"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-1627735880"><a href="#local-1627735880"><span class="hs-identifier">n_val_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627735869"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627735879"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-1627735880"><span class="hs-identifier hs-var">n_val_args</span></a><span>
</span><a name="line-2158"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span>          </span><span class="hs-identifier">_</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-2159"></a><span>
</span><a name="line-2160"></a><span>    </span><a name="local-1627735870"><a href="#local-1627735870"><span class="hs-identifier">saturated_data_con</span></a></a><span> </span><a name="local-1627735881"><a href="#local-1627735881"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-1627735882"><a href="#local-1627735882"><span class="hs-identifier">n_val_args</span></a></a><span>
</span><a name="line-2161"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Id.html#isDataConWorkId_maybe"><span class="hs-identifier hs-var">isDataConWorkId_maybe</span></a><span> </span><a href="#local-1627735881"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2162"></a><span>            </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1627735883"><a href="#local-1627735883"><span class="hs-identifier">dc</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627735882"><span class="hs-identifier hs-var">n_val_args</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="DataCon.html#dataConRepArity"><span class="hs-identifier hs-var">dataConRepArity</span></a><span> </span><a href="#local-1627735883"><span class="hs-identifier hs-var">dc</span></a><span>
</span><a name="line-2163"></a><span>            </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-2164"></a><span>
</span><a name="line-2165"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Type utilities}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-2172"></a><span>
</span><a name="line-2173"></a><span class="hs-comment">-- | True if the type has no non-bottom elements, e.g. when it is an empty</span><span>
</span><a name="line-2174"></a><span class="hs-comment">-- datatype, or a GADT with non-satisfiable type parameters, e.g. Int :~: Bool.</span><span>
</span><a name="line-2175"></a><span class="hs-comment">-- See Note [Bottoming expressions]</span><span>
</span><a name="line-2176"></a><span class="hs-comment">--</span><span>
</span><a name="line-2177"></a><span class="hs-comment">-- See Note [No alternatives lint check] for another use of this function.</span><span>
</span><a name="line-2178"></a><span class="hs-identifier">isEmptyTy</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-2179"></a><a name="isEmptyTy"><a href="CoreUtils.html#isEmptyTy"><span class="hs-identifier">isEmptyTy</span></a></a><span> </span><a name="local-1627735884"><a href="#local-1627735884"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-2180"></a><span>    </span><span class="hs-comment">-- Data types where, given the particular type parameters, no data</span><span>
</span><a name="line-2181"></a><span>    </span><span class="hs-comment">-- constructor matches, are empty.</span><span>
</span><a name="line-2182"></a><span>    </span><span class="hs-comment">-- This includes data types with no constructors, e.g. Data.Void.Void.</span><span>
</span><a name="line-2183"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1627735885"><a href="#local-1627735885"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627735886"><a href="#local-1627735886"><span class="hs-identifier">inst_tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-var">splitTyConApp_maybe</span></a><span> </span><a href="#local-1627735884"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-2184"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1627735887"><a href="#local-1627735887"><span class="hs-identifier">dcs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TyCon.html#tyConDataCons_maybe"><span class="hs-identifier hs-var">tyConDataCons_maybe</span></a><span> </span><a href="#local-1627735885"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-2185"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#dataConCannotMatch"><span class="hs-identifier hs-var">dataConCannotMatch</span></a><span> </span><a href="#local-1627735886"><span class="hs-identifier hs-var">inst_tys</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627735887"><span class="hs-identifier hs-var">dcs</span></a><span>
</span><a name="line-2186"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-2187"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-2188"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-2189"></a></pre></body></html>