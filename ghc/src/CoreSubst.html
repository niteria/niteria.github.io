<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2006
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998


Utility functions on @Core@ syntax
-}</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-10"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">CoreSubst</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-11"></a><span>        </span><span class="hs-comment">-- * Main data types</span><span>
</span><a name="line-12"></a><span>        </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- Implementation exported for supercompiler's Renaming.hs only</span><span>
</span><a name="line-13"></a><span>        </span><a href="TyCoRep.html#TvSubstEnv"><span class="hs-identifier hs-type">TvSubstEnv</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#IdSubstEnv"><span class="hs-identifier hs-type">IdSubstEnv</span></a><span class="hs-special">,</span><span> </span><a href="VarEnv.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a><span class="hs-special">,</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span>        </span><span class="hs-comment">-- ** Substituting into expressions and related types</span><span>
</span><a name="line-16"></a><span>        </span><a href="CoreSubst.html#deShadowBinds"><span class="hs-identifier hs-var">deShadowBinds</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#substSpec"><span class="hs-identifier hs-var">substSpec</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#substRulesForImportedIds"><span class="hs-identifier hs-var">substRulesForImportedIds</span></a><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>        </span><a href="CoreSubst.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#substCo"><span class="hs-identifier hs-var">substCo</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#substExpr"><span class="hs-identifier hs-var">substExpr</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#substExprSC"><span class="hs-identifier hs-var">substExprSC</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#substBind"><span class="hs-identifier hs-var">substBind</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#substBindSC"><span class="hs-identifier hs-var">substBindSC</span></a><span class="hs-special">,</span><span>
</span><a name="line-18"></a><span>        </span><a href="CoreSubst.html#substUnfolding"><span class="hs-identifier hs-var">substUnfolding</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#substUnfoldingSC"><span class="hs-identifier hs-var">substUnfoldingSC</span></a><span class="hs-special">,</span><span>
</span><a name="line-19"></a><span>        </span><a href="CoreSubst.html#lookupIdSubst"><span class="hs-identifier hs-var">lookupIdSubst</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#lookupTCvSubst"><span class="hs-identifier hs-var">lookupTCvSubst</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#substIdOcc"><span class="hs-identifier hs-var">substIdOcc</span></a><span class="hs-special">,</span><span>
</span><a name="line-20"></a><span>        </span><a href="CoreSubst.html#substTickish"><span class="hs-identifier hs-var">substTickish</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#substDVarSet"><span class="hs-identifier hs-var">substDVarSet</span></a><span class="hs-special">,</span><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span>        </span><span class="hs-comment">-- ** Operations on substitutions</span><span>
</span><a name="line-23"></a><span>        </span><a href="CoreSubst.html#emptySubst"><span class="hs-identifier hs-var">emptySubst</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#mkEmptySubst"><span class="hs-identifier hs-var">mkEmptySubst</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#mkSubst"><span class="hs-identifier hs-var">mkSubst</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#mkOpenSubst"><span class="hs-identifier hs-var">mkOpenSubst</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#substInScope"><span class="hs-identifier hs-var">substInScope</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#isEmptySubst"><span class="hs-identifier hs-var">isEmptySubst</span></a><span class="hs-special">,</span><span>
</span><a name="line-24"></a><span>        </span><a href="CoreSubst.html#extendIdSubst"><span class="hs-identifier hs-var">extendIdSubst</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#extendIdSubstList"><span class="hs-identifier hs-var">extendIdSubstList</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#extendTCvSubst"><span class="hs-identifier hs-var">extendTCvSubst</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#extendTvSubstList"><span class="hs-identifier hs-var">extendTvSubstList</span></a><span class="hs-special">,</span><span>
</span><a name="line-25"></a><span>        </span><a href="CoreSubst.html#extendSubst"><span class="hs-identifier hs-var">extendSubst</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#extendSubstList"><span class="hs-identifier hs-var">extendSubstList</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#extendSubstWithVar"><span class="hs-identifier hs-var">extendSubstWithVar</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#zapSubstEnv"><span class="hs-identifier hs-var">zapSubstEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-26"></a><span>        </span><a href="CoreSubst.html#addInScopeSet"><span class="hs-identifier hs-var">addInScopeSet</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#extendInScope"><span class="hs-identifier hs-var">extendInScope</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#extendInScopeList"><span class="hs-identifier hs-var">extendInScopeList</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#extendInScopeIds"><span class="hs-identifier hs-var">extendInScopeIds</span></a><span class="hs-special">,</span><span>
</span><a name="line-27"></a><span>        </span><a href="CoreSubst.html#isInScope"><span class="hs-identifier hs-var">isInScope</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#setInScope"><span class="hs-identifier hs-var">setInScope</span></a><span class="hs-special">,</span><span>
</span><a name="line-28"></a><span>        </span><a href="CoreSubst.html#delBndr"><span class="hs-identifier hs-var">delBndr</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#delBndrs"><span class="hs-identifier hs-var">delBndrs</span></a><span class="hs-special">,</span><span>
</span><a name="line-29"></a><span>
</span><a name="line-30"></a><span>        </span><span class="hs-comment">-- ** Substituting and cloning binders</span><span>
</span><a name="line-31"></a><span>        </span><a href="CoreSubst.html#substBndr"><span class="hs-identifier hs-var">substBndr</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#substBndrs"><span class="hs-identifier hs-var">substBndrs</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#substRecBndrs"><span class="hs-identifier hs-var">substRecBndrs</span></a><span class="hs-special">,</span><span>
</span><a name="line-32"></a><span>        </span><a href="CoreSubst.html#cloneBndr"><span class="hs-identifier hs-var">cloneBndr</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#cloneBndrs"><span class="hs-identifier hs-var">cloneBndrs</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#cloneIdBndr"><span class="hs-identifier hs-var">cloneIdBndr</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#cloneIdBndrs"><span class="hs-identifier hs-var">cloneIdBndrs</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#cloneRecIdBndrs"><span class="hs-identifier hs-var">cloneRecIdBndrs</span></a><span class="hs-special">,</span><span>
</span><a name="line-33"></a><span>
</span><a name="line-34"></a><span>        </span><span class="hs-comment">-- ** Simple expression optimiser</span><span>
</span><a name="line-35"></a><span>        </span><a href="CoreSubst.html#simpleOptPgm"><span class="hs-identifier hs-var">simpleOptPgm</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#simpleOptExpr"><span class="hs-identifier hs-var">simpleOptExpr</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#simpleOptExprWith"><span class="hs-identifier hs-var">simpleOptExprWith</span></a><span class="hs-special">,</span><span>
</span><a name="line-36"></a><span>        </span><a href="CoreSubst.html#exprIsConApp_maybe"><span class="hs-identifier hs-var">exprIsConApp_maybe</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#exprIsLiteral_maybe"><span class="hs-identifier hs-var">exprIsLiteral_maybe</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#exprIsLambda_maybe"><span class="hs-identifier hs-var">exprIsLambda_maybe</span></a><span class="hs-special">,</span><span>
</span><a name="line-37"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-38"></a><span>
</span><a name="line-39"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;</span><span>
</span><a name="line-40"></a><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><a href="CoreSyn.html"><span class="hs-identifier">CoreSyn</span></a><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><a href="CoreFVs.html"><span class="hs-identifier">CoreFVs</span></a><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><a href="CoreSeq.html"><span class="hs-identifier">CoreSeq</span></a><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><a href="CoreUtils.html"><span class="hs-identifier">CoreUtils</span></a><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><a href="Literal.html"><span class="hs-identifier">Literal</span></a><span>  </span><span class="hs-special">(</span><span> </span><a href="Literal.html#Literal"><span class="hs-identifier hs-type">Literal</span></a><span class="hs-special">(</span><a href="Literal.html#MachStr"><span class="hs-identifier hs-var">MachStr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="../bytestring-0.10.7.0/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BS</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><a href="OccurAnal.html"><span class="hs-identifier">OccurAnal</span></a><span class="hs-special">(</span><span> </span><a href="OccurAnal.html#occurAnalyseExpr"><span class="hs-identifier hs-var">occurAnalyseExpr</span></a><span class="hs-special">,</span><span> </span><a href="OccurAnal.html#occurAnalysePgm"><span class="hs-identifier hs-var">occurAnalysePgm</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Type.html"><span class="hs-identifier">Type</span></a><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Coercion.html"><span class="hs-identifier">Coercion</span></a><span>
</span><a name="line-51"></a><span>
</span><a name="line-52"></a><span>        </span><span class="hs-comment">-- We are defining local versions</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><a href="Type.html"><span class="hs-identifier">Type</span></a><span>     </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><a href="TyCoRep.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#extendTvSubst"><span class="hs-identifier hs-var">extendTvSubst</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#extendCvSubst"><span class="hs-identifier hs-var">extendCvSubst</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#extendTvSubstList"><span class="hs-identifier hs-var">extendTvSubstList</span></a><span>
</span><a name="line-54"></a><span>                       </span><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#isInScope"><span class="hs-identifier hs-var">isInScope</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#substTyVarBndr"><span class="hs-identifier hs-var">substTyVarBndr</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#cloneTyVarBndr"><span class="hs-identifier hs-var">cloneTyVarBndr</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><a href="Coercion.html"><span class="hs-identifier">Coercion</span></a><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><a href="TyCoRep.html#substCo"><span class="hs-identifier hs-var">substCo</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#substCoVarBndr"><span class="hs-identifier hs-var">substCoVarBndr</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-56"></a><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><a href="TyCon.html"><span class="hs-identifier">TyCon</span></a><span>       </span><span class="hs-special">(</span><span> </span><a href="TyCon.html#tyConArity"><span class="hs-identifier hs-var">tyConArity</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><a href="DataCon.html"><span class="hs-identifier">DataCon</span></a><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><a href="PrelNames.html"><span class="hs-identifier">PrelNames</span></a><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><a href="OptCoercion.html"><span class="hs-identifier">OptCoercion</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="OptCoercion.html#optCoercion"><span class="hs-identifier hs-var">optCoercion</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><a href="PprCore.html"><span class="hs-identifier">PprCore</span></a><span>     </span><span class="hs-special">(</span><span> </span><a href="PprCore.html#pprCoreBindings"><span class="hs-identifier hs-var">pprCoreBindings</span></a><span class="hs-special">,</span><span> </span><a href="PprCore.html#pprRules"><span class="hs-identifier hs-var">pprRules</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span> </span><a href="Module.html"><span class="hs-identifier">Module</span></a><span>      </span><span class="hs-special">(</span><span> </span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><a href="VarSet.html"><span class="hs-identifier">VarSet</span></a><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><a href="VarEnv.html"><span class="hs-identifier">VarEnv</span></a><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><a href="Id.html"><span class="hs-identifier">Id</span></a><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span> </span><a href="Name.html"><span class="hs-identifier">Name</span></a><span>     </span><span class="hs-special">(</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span> </span><a href="Var.html"><span class="hs-identifier">Var</span></a><span>
</span><a name="line-68"></a><span class="hs-keyword">import</span><span> </span><a href="IdInfo.html"><span class="hs-identifier">IdInfo</span></a><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span> </span><a href="UniqSupply.html"><span class="hs-identifier">UniqSupply</span></a><span>
</span><a name="line-70"></a><span class="hs-keyword">import</span><span> </span><a href="Maybes.html"><span class="hs-identifier">Maybes</span></a><span>
</span><a name="line-71"></a><span class="hs-keyword">import</span><span> </span><a href="ErrUtils.html"><span class="hs-identifier">ErrUtils</span></a><span>
</span><a name="line-72"></a><span class="hs-keyword">import</span><span> </span><a href="DynFlags.html"><span class="hs-identifier">DynFlags</span></a><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span> </span><a href="BasicTypes.html"><span class="hs-identifier">BasicTypes</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="BasicTypes.html#isAlwaysActive"><span class="hs-identifier hs-var">isAlwaysActive</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-74"></a><span class="hs-keyword">import</span><span> </span><a href="Util.html"><span class="hs-identifier">Util</span></a><span>
</span><a name="line-75"></a><span class="hs-keyword">import</span><span> </span><a href="Pair.html"><span class="hs-identifier">Pair</span></a><span>
</span><a name="line-76"></a><span class="hs-keyword">import</span><span> </span><a href="Outputable.html"><span class="hs-identifier">Outputable</span></a><span>
</span><a name="line-77"></a><span class="hs-keyword">import</span><span> </span><a href="PprCore.html"><span class="hs-identifier">PprCore</span></a><span>          </span><span class="hs-special">(</span><span class="hs-special">)</span><span>              </span><span class="hs-comment">-- Instances</span><span>
</span><a name="line-78"></a><span class="hs-keyword">import</span><span> </span><a href="FastString.html"><span class="hs-identifier">FastString</span></a><span>
</span><a name="line-79"></a><span>
</span><a name="line-80"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.List.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span></a><span>
</span><a name="line-81"></a><span>
</span><a name="line-82"></a><span class="hs-keyword">import</span><span> </span><a href="TysWiredIn.html"><span class="hs-identifier">TysWiredIn</span></a><span>
</span><a name="line-83"></a><span>
</span><a name="line-84"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Substitutions}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-91"></a><span>
</span><a name="line-92"></a><span class="hs-comment">-- | A substitution environment, containing 'Id', 'TyVar', and 'CoVar'</span><span>
</span><a name="line-93"></a><span class="hs-comment">-- substitutions.</span><span>
</span><a name="line-94"></a><span class="hs-comment">--</span><span>
</span><a name="line-95"></a><span class="hs-comment">-- Some invariants apply to how you use the substitution:</span><span>
</span><a name="line-96"></a><span class="hs-comment">--</span><span>
</span><a name="line-97"></a><span class="hs-comment">-- 1. #in_scope_invariant# The in-scope set contains at least those 'Id's and 'TyVar's that will be in scope /after/</span><span>
</span><a name="line-98"></a><span class="hs-comment">-- applying the substitution to a term. Precisely, the in-scope set must be a superset of the free vars of the</span><span>
</span><a name="line-99"></a><span class="hs-comment">-- substitution range that might possibly clash with locally-bound variables in the thing being substituted in.</span><span>
</span><a name="line-100"></a><span class="hs-comment">--</span><span>
</span><a name="line-101"></a><span class="hs-comment">-- 2. #apply_once# You may apply the substitution only /once/</span><span>
</span><a name="line-102"></a><span class="hs-comment">--</span><span>
</span><a name="line-103"></a><span class="hs-comment">-- There are various ways of setting up the in-scope set such that the first of these invariants hold:</span><span>
</span><a name="line-104"></a><span class="hs-comment">--</span><span>
</span><a name="line-105"></a><span class="hs-comment">-- * Arrange that the in-scope set really is all the things in scope</span><span>
</span><a name="line-106"></a><span class="hs-comment">--</span><span>
</span><a name="line-107"></a><span class="hs-comment">-- * Arrange that it's the free vars of the range of the substitution</span><span>
</span><a name="line-108"></a><span class="hs-comment">--</span><span>
</span><a name="line-109"></a><span class="hs-comment">-- * Make it empty, if you know that all the free vars of the substitution are fresh, and hence can't possibly clash</span><span>
</span><a name="line-110"></a><span class="hs-keyword">data</span><span> </span><a name="Subst"><a href="CoreSubst.html#Subst"><span class="hs-identifier">Subst</span></a></a><span>
</span><a name="line-111"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="Subst"><a href="CoreSubst.html#Subst"><span class="hs-identifier">Subst</span></a></a><span> </span><a href="VarEnv.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a><span>  </span><span class="hs-comment">-- Variables in in scope (both Ids and TyVars) /after/</span><span>
</span><a name="line-112"></a><span>                      </span><span class="hs-comment">-- applying the substitution</span><span>
</span><a name="line-113"></a><span>          </span><a href="CoreSubst.html#IdSubstEnv"><span class="hs-identifier hs-type">IdSubstEnv</span></a><span>  </span><span class="hs-comment">-- Substitution from NcIds to CoreExprs</span><span>
</span><a name="line-114"></a><span>          </span><a href="TyCoRep.html#TvSubstEnv"><span class="hs-identifier hs-type">TvSubstEnv</span></a><span>  </span><span class="hs-comment">-- Substitution from TyVars to Types</span><span>
</span><a name="line-115"></a><span>          </span><a href="TyCoRep.html#CvSubstEnv"><span class="hs-identifier hs-type">CvSubstEnv</span></a><span>  </span><span class="hs-comment">-- Substitution from CoVars to Coercions</span><span>
</span><a name="line-116"></a><span>
</span><a name="line-117"></a><span>        </span><span class="hs-comment">-- INVARIANT 1: See #in_scope_invariant#</span><span>
</span><a name="line-118"></a><span>        </span><span class="hs-comment">-- This is what lets us deal with name capture properly</span><span>
</span><a name="line-119"></a><span>        </span><span class="hs-comment">-- It's a hard invariant to check...</span><span>
</span><a name="line-120"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-121"></a><span>        </span><span class="hs-comment">-- INVARIANT 2: The substitution is apply-once; see Note [Apply once] with</span><span>
</span><a name="line-122"></a><span>        </span><span class="hs-comment">--              Types.TvSubstEnv</span><span>
</span><a name="line-123"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-124"></a><span>        </span><span class="hs-comment">-- INVARIANT 3: See Note [Extending the Subst]</span><span>
</span><a name="line-125"></a><span>
</span><a name="line-126"></a><span class="hs-comment">{-
Note [Extending the Subst]
~~~~~~~~~~~~~~~~~~~~~~~~~~
For a core Subst, which binds Ids as well, we make a different choice for Ids
than we do for TyVars.

For TyVars, see Note [Extending the TCvSubst] with Type.TvSubstEnv

For Ids, we have a different invariant
        The IdSubstEnv is extended *only* when the Unique on an Id changes
        Otherwise, we just extend the InScopeSet

In consequence:

* If all subst envs are empty, substExpr would be a
  no-op, so substExprSC (&quot;short cut&quot;) does nothing.

  However, substExpr still goes ahead and substitutes.  Reason: we may
  want to replace existing Ids with new ones from the in-scope set, to
  avoid space leaks.

* In substIdBndr, we extend the IdSubstEnv only when the unique changes

* If the CvSubstEnv, TvSubstEnv and IdSubstEnv are all empty,
  substExpr does nothing (Note that the above rule for substIdBndr
  maintains this property.  If the incoming envts are both empty, then
  substituting the type and IdInfo can't change anything.)

* In lookupIdSubst, we *must* look up the Id in the in-scope set, because
  it may contain non-trivial changes.  Example:
        (/\a. \x:a. ...x...) Int
  We extend the TvSubstEnv with [a |-&gt; Int]; but x's unique does not change
  so we only extend the in-scope set.  Then we must look up in the in-scope
  set when we find the occurrence of x.

* The requirement to look up the Id in the in-scope set means that we
  must NOT take no-op short cut when the IdSubst is empty.
  We must still look up every Id in the in-scope set.

* (However, we don't need to do so for expressions found in the IdSubst
  itself, whose range is assumed to be correct wrt the in-scope set.)

Why do we make a different choice for the IdSubstEnv than the
TvSubstEnv and CvSubstEnv?

* For Ids, we change the IdInfo all the time (e.g. deleting the
  unfolding), and adding it back later, so using the TyVar convention
  would entail extending the substitution almost all the time

* The simplifier wants to look up in the in-scope set anyway, in case it
  can see a better unfolding from an enclosing case expression

* For TyVars, only coercion variables can possibly change, and they are
  easy to spot
-}</span><span>
</span><a name="line-181"></a><span>
</span><a name="line-182"></a><span class="hs-comment">-- | An environment for substituting for 'Id's</span><span>
</span><a name="line-183"></a><span class="hs-keyword">type</span><span> </span><a name="IdSubstEnv"><a href="CoreSubst.html#IdSubstEnv"><span class="hs-identifier">IdSubstEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#IdEnv"><span class="hs-identifier hs-type">IdEnv</span></a><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>   </span><span class="hs-comment">-- Domain is NcIds, i.e. not coercions</span><span>
</span><a name="line-184"></a><span>
</span><a name="line-185"></a><span class="hs-comment">----------------------------</span><span>
</span><a name="line-186"></a><span class="hs-identifier">isEmptySubst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-187"></a><a name="isEmptySubst"><a href="CoreSubst.html#isEmptySubst"><span class="hs-identifier">isEmptySubst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627855299"><a href="#local-1627855299"><span class="hs-identifier">id_env</span></a></a><span> </span><a name="local-1627855300"><a href="#local-1627855300"><span class="hs-identifier">tv_env</span></a></a><span> </span><a name="local-1627855301"><a href="#local-1627855301"><span class="hs-identifier">cv_env</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-188"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#isEmptyVarEnv"><span class="hs-identifier hs-var">isEmptyVarEnv</span></a><span> </span><a href="#local-1627855299"><span class="hs-identifier hs-var">id_env</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="VarEnv.html#isEmptyVarEnv"><span class="hs-identifier hs-var">isEmptyVarEnv</span></a><span> </span><a href="#local-1627855300"><span class="hs-identifier hs-var">tv_env</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="VarEnv.html#isEmptyVarEnv"><span class="hs-identifier hs-var">isEmptyVarEnv</span></a><span> </span><a href="#local-1627855301"><span class="hs-identifier hs-var">cv_env</span></a><span>
</span><a name="line-189"></a><span>
</span><a name="line-190"></a><span class="hs-identifier">emptySubst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-191"></a><a name="emptySubst"><a href="CoreSubst.html#emptySubst"><span class="hs-identifier">emptySubst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a href="VarEnv.html#emptyInScopeSet"><span class="hs-identifier hs-var">emptyInScopeSet</span></a><span> </span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span> </span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span> </span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span>
</span><a name="line-192"></a><span>
</span><a name="line-193"></a><span class="hs-identifier">mkEmptySubst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-194"></a><a name="mkEmptySubst"><a href="CoreSubst.html#mkEmptySubst"><span class="hs-identifier">mkEmptySubst</span></a></a><span> </span><a name="local-1627855302"><a href="#local-1627855302"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a href="#local-1627855302"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span> </span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span> </span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span>
</span><a name="line-195"></a><span>
</span><a name="line-196"></a><span class="hs-identifier">mkSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#TvSubstEnv"><span class="hs-identifier hs-type">TvSubstEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#CvSubstEnv"><span class="hs-identifier hs-type">CvSubstEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#IdSubstEnv"><span class="hs-identifier hs-type">IdSubstEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-197"></a><a name="mkSubst"><a href="CoreSubst.html#mkSubst"><span class="hs-identifier">mkSubst</span></a></a><span> </span><a name="local-1627855303"><a href="#local-1627855303"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-1627855304"><a href="#local-1627855304"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-1627855305"><a href="#local-1627855305"><span class="hs-identifier">cvs</span></a></a><span> </span><a name="local-1627855306"><a href="#local-1627855306"><span class="hs-identifier">ids</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a href="#local-1627855303"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-1627855306"><span class="hs-identifier hs-var">ids</span></a><span> </span><a href="#local-1627855304"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-1627855305"><span class="hs-identifier hs-var">cvs</span></a><span>
</span><a name="line-198"></a><span>
</span><a name="line-199"></a><span class="hs-comment">-- | Find the in-scope set: see &quot;CoreSubst#in_scope_invariant&quot;</span><span>
</span><a name="line-200"></a><span class="hs-identifier">substInScope</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarEnv.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a><span>
</span><a name="line-201"></a><a name="substInScope"><a href="CoreSubst.html#substInScope"><span class="hs-identifier">substInScope</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-1627855307"><a href="#local-1627855307"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855307"><span class="hs-identifier hs-var">in_scope</span></a><span>
</span><a name="line-202"></a><span>
</span><a name="line-203"></a><span class="hs-comment">-- | Remove all substitutions for 'Id's and 'Var's that might have been built up</span><span>
</span><a name="line-204"></a><span class="hs-comment">-- while preserving the in-scope set</span><span>
</span><a name="line-205"></a><span class="hs-identifier">zapSubstEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-206"></a><a name="zapSubstEnv"><a href="CoreSubst.html#zapSubstEnv"><span class="hs-identifier">zapSubstEnv</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-1627855308"><a href="#local-1627855308"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a href="#local-1627855308"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span> </span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span> </span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span>
</span><a name="line-207"></a><span>
</span><a name="line-208"></a><span class="hs-comment">-- | Add a substitution for an 'Id' to the 'Subst': you must ensure that the in-scope set is</span><span>
</span><a name="line-209"></a><span class="hs-comment">-- such that the &quot;CoreSubst#in_scope_invariant&quot; is true after extending the substitution like this</span><span>
</span><a name="line-210"></a><span class="hs-identifier">extendIdSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-211"></a><span class="hs-comment">-- ToDo: add an ASSERT that fvs(subst-result) is already in the in-scope set</span><span>
</span><a name="line-212"></a><a name="extendIdSubst"><a href="CoreSubst.html#extendIdSubst"><span class="hs-identifier">extendIdSubst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-1627855309"><a href="#local-1627855309"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-1627855310"><a href="#local-1627855310"><span class="hs-identifier">ids</span></a></a><span> </span><a name="local-1627855311"><a href="#local-1627855311"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-1627855312"><a href="#local-1627855312"><span class="hs-identifier">cvs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627855313"><a href="#local-1627855313"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-1627855314"><a href="#local-1627855314"><span class="hs-identifier">r</span></a></a><span>
</span><a name="line-213"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isNonCoVarId</span><span> </span><a href="Var.html#isNonCoVarId"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#isNonCoVarId"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="Var.html#isNonCoVarId"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="Var.html#isNonCoVarId"><span class="hs-operator hs-var">$$</span></a><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">r</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-214"></a><span>    </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a href="#local-1627855309"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a><span> </span><a href="#local-1627855310"><span class="hs-identifier hs-var">ids</span></a><span> </span><a href="#local-1627855313"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-1627855314"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855311"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-1627855312"><span class="hs-identifier hs-var">cvs</span></a><span>
</span><a name="line-215"></a><span>
</span><a name="line-216"></a><span class="hs-comment">-- | Adds multiple 'Id' substitutions to the 'Subst': see also 'extendIdSubst'</span><span>
</span><a name="line-217"></a><span class="hs-identifier">extendIdSubstList</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-218"></a><a name="extendIdSubstList"><a href="CoreSubst.html#extendIdSubstList"><span class="hs-identifier">extendIdSubstList</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-1627855315"><a href="#local-1627855315"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-1627855316"><a href="#local-1627855316"><span class="hs-identifier">ids</span></a></a><span> </span><a name="local-1627855317"><a href="#local-1627855317"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-1627855318"><a href="#local-1627855318"><span class="hs-identifier">cvs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627855319"><a href="#local-1627855319"><span class="hs-identifier">prs</span></a></a><span>
</span><a name="line-219"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">all</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">isNonCoVarId</span><span> </span><span class="hs-operator">.</span><span> </span><a href="Var.html#isNonCoVarId"><span class="hs-identifier hs-var">fst</span></a><span class="hs-special">)</span><span> </span><a href="Var.html#isNonCoVarId"><span class="hs-identifier hs-var">prs</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-220"></a><span>    </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a href="#local-1627855315"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#extendVarEnvList"><span class="hs-identifier hs-var">extendVarEnvList</span></a><span> </span><a href="#local-1627855316"><span class="hs-identifier hs-var">ids</span></a><span> </span><a href="#local-1627855319"><span class="hs-identifier hs-var">prs</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855317"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-1627855318"><span class="hs-identifier hs-var">cvs</span></a><span>
</span><a name="line-221"></a><span>
</span><a name="line-222"></a><span class="hs-comment">-- | Add a substitution for a 'TyVar' to the 'Subst'</span><span>
</span><a name="line-223"></a><span class="hs-comment">-- The 'TyVar' *must* be a real TyVar, and not a CoVar</span><span>
</span><a name="line-224"></a><span class="hs-comment">-- You must ensure that the in-scope set is such that</span><span>
</span><a name="line-225"></a><span class="hs-comment">-- the &quot;CoreSubst#in_scope_invariant&quot; is true after extending</span><span>
</span><a name="line-226"></a><span class="hs-comment">-- the substitution like this.</span><span>
</span><a name="line-227"></a><span class="hs-identifier">extendTvSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-228"></a><a name="extendTvSubst"><a href="CoreSubst.html#extendTvSubst"><span class="hs-identifier">extendTvSubst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-1627855320"><a href="#local-1627855320"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-1627855321"><a href="#local-1627855321"><span class="hs-identifier">ids</span></a></a><span> </span><a name="local-1627855322"><a href="#local-1627855322"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-1627855323"><a href="#local-1627855323"><span class="hs-identifier">cvs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627855324"><a href="#local-1627855324"><span class="hs-identifier">tv</span></a></a><span> </span><a name="local-1627855325"><a href="#local-1627855325"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-229"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isTyVar</span><span> </span><span class="hs-identifier hs-var">tv</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-230"></a><span>    </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a href="#local-1627855320"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-1627855321"><span class="hs-identifier hs-var">ids</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a><span> </span><a href="#local-1627855322"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-1627855324"><span class="hs-identifier hs-var">tv</span></a><span> </span><a href="#local-1627855325"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855323"><span class="hs-identifier hs-var">cvs</span></a><span>
</span><a name="line-231"></a><span>
</span><a name="line-232"></a><span class="hs-comment">-- | Adds multiple 'TyVar' substitutions to the 'Subst': see also 'extendTvSubst'</span><span>
</span><a name="line-233"></a><span class="hs-identifier">extendTvSubstList</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">,</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-234"></a><a name="extendTvSubstList"><a href="CoreSubst.html#extendTvSubstList"><span class="hs-identifier">extendTvSubstList</span></a></a><span> </span><a name="local-1627855326"><a href="#local-1627855326"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-1627855327"><a href="#local-1627855327"><span class="hs-identifier">vrs</span></a></a><span>
</span><a name="line-235"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#foldl%27"><span class="hs-identifier hs-var">foldl'</span></a><span> </span><a href="#local-1627855328"><span class="hs-identifier hs-var">extend</span></a><span> </span><a href="#local-1627855326"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855327"><span class="hs-identifier hs-var">vrs</span></a><span>
</span><a name="line-236"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-237"></a><span>    </span><a name="local-1627855328"><a href="#local-1627855328"><span class="hs-identifier">extend</span></a></a><span> </span><a name="local-1627855329"><a href="#local-1627855329"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1627855330"><a href="#local-1627855330"><span class="hs-identifier">v</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855331"><a href="#local-1627855331"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#extendTvSubst"><span class="hs-identifier hs-var">extendTvSubst</span></a><span> </span><a href="#local-1627855329"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855330"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-1627855331"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-238"></a><span>
</span><a name="line-239"></a><span class="hs-comment">-- | Add a substitution from a 'CoVar' to a 'Coercion' to the 'Subst': you must ensure that the in-scope set is</span><span>
</span><a name="line-240"></a><span class="hs-comment">-- such that the &quot;CoreSubst#in_scope_invariant&quot; is true after extending the substitution like this</span><span>
</span><a name="line-241"></a><span class="hs-identifier">extendCvSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#CoVar"><span class="hs-identifier hs-type">CoVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-242"></a><a name="extendCvSubst"><a href="CoreSubst.html#extendCvSubst"><span class="hs-identifier">extendCvSubst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-1627855332"><a href="#local-1627855332"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-1627855333"><a href="#local-1627855333"><span class="hs-identifier">ids</span></a></a><span> </span><a name="local-1627855334"><a href="#local-1627855334"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-1627855335"><a href="#local-1627855335"><span class="hs-identifier">cvs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627855336"><a href="#local-1627855336"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-1627855337"><a href="#local-1627855337"><span class="hs-identifier">r</span></a></a><span>
</span><a name="line-243"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isCoVar</span><span> </span><span class="hs-identifier hs-var">v</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-244"></a><span>    </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a href="#local-1627855332"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-1627855333"><span class="hs-identifier hs-var">ids</span></a><span> </span><a href="#local-1627855334"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a><span> </span><a href="#local-1627855335"><span class="hs-identifier hs-var">cvs</span></a><span> </span><a href="#local-1627855336"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-1627855337"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-245"></a><span>
</span><a name="line-246"></a><span class="hs-comment">-- | Add a substitution appropriate to the thing being substituted</span><span>
</span><a name="line-247"></a><span class="hs-comment">--   (whether an expression, type, or coercion). See also</span><span>
</span><a name="line-248"></a><span class="hs-comment">--   'extendIdSubst', 'extendTvSubst', 'extendCvSubst'</span><span>
</span><a name="line-249"></a><span class="hs-identifier">extendSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-250"></a><a name="extendSubst"><a href="CoreSubst.html#extendSubst"><span class="hs-identifier">extendSubst</span></a></a><span> </span><a name="local-1627855338"><a href="#local-1627855338"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-1627855339"><a href="#local-1627855339"><span class="hs-identifier">var</span></a></a><span> </span><a name="local-1627855340"><a href="#local-1627855340"><span class="hs-identifier">arg</span></a></a><span>
</span><a name="line-251"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1627855340"><span class="hs-identifier hs-var">arg</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-252"></a><span>      </span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a name="local-1627855341"><a href="#local-1627855341"><span class="hs-identifier">ty</span></a></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isTyVar</span><span> </span><span class="hs-identifier hs-var">var</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier">extendTvSubst</span><span> </span><span class="hs-identifier">subst</span><span> </span><a href="Panic.html#assertPanic"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="Panic.html#assertPanic"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-253"></a><span>      </span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a name="local-1627855342"><a href="#local-1627855342"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isCoVar</span><span> </span><span class="hs-identifier hs-var">var</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier">extendCvSubst</span><span> </span><span class="hs-identifier">subst</span><span> </span><a href="Panic.html#assertPanic"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="Panic.html#assertPanic"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-254"></a><span>      </span><span class="hs-identifier">_</span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">isId</span></a><span>    </span><span class="hs-identifier hs-var">var</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier">extendIdSubst</span><span> </span><span class="hs-identifier">subst</span><span> </span><a href="Panic.html#assertPanic"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="Panic.html#assertPanic"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-255"></a><span>
</span><a name="line-256"></a><span class="hs-identifier">extendSubstWithVar</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-257"></a><a name="extendSubstWithVar"><a href="CoreSubst.html#extendSubstWithVar"><span class="hs-identifier">extendSubstWithVar</span></a></a><span> </span><a name="local-1627855343"><a href="#local-1627855343"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-1627855344"><a href="#local-1627855344"><span class="hs-identifier">v1</span></a></a><span> </span><a name="local-1627855345"><a href="#local-1627855345"><span class="hs-identifier">v2</span></a></a><span>
</span><a name="line-258"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-1627855344"><span class="hs-identifier hs-var">v1</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isTyVar</span><span> </span><span class="hs-identifier hs-var">v2</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier">extendTvSubst</span><span> </span><span class="hs-identifier">subst</span><span> </span><a href="Panic.html#assertPanic"><span class="hs-identifier hs-var">v1</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">mkTyVarTy</span><span> </span><span class="hs-identifier">v2</span><span class="hs-special">)</span><span>
</span><a name="line-259"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a><span> </span><a href="#local-1627855344"><span class="hs-identifier hs-var">v1</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isCoVar</span><span> </span><span class="hs-identifier hs-var">v2</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier">extendCvSubst</span><span> </span><span class="hs-identifier">subst</span><span> </span><a href="Panic.html#assertPanic"><span class="hs-identifier hs-var">v1</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">mkCoVarCo</span><span> </span><span class="hs-identifier">v2</span><span class="hs-special">)</span><span>
</span><a name="line-260"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">isId</span></a><span>    </span><span class="hs-identifier hs-var">v2</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier">extendIdSubst</span><span> </span><span class="hs-identifier">subst</span><span> </span><a href="Panic.html#assertPanic"><span class="hs-identifier hs-var">v1</span></a><span> </span><span class="hs-special">(</span><a href="Panic.html#assertPanic"><span class="hs-identifier hs-var">Var</span></a><span> </span><a href="Panic.html#assertPanic"><span class="hs-identifier hs-var">v2</span></a><span class="hs-special">)</span><span>
</span><a name="line-261"></a><span>
</span><a name="line-262"></a><span class="hs-comment">-- | Add a substitution as appropriate to each of the terms being</span><span>
</span><a name="line-263"></a><span class="hs-comment">--   substituted (whether expressions, types, or coercions). See also</span><span>
</span><a name="line-264"></a><span class="hs-comment">--   'extendSubst'.</span><span>
</span><a name="line-265"></a><span class="hs-identifier">extendSubstList</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">,</span><a href="CoreSyn.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-266"></a><a name="extendSubstList"><a href="CoreSubst.html#extendSubstList"><span class="hs-identifier">extendSubstList</span></a></a><span> </span><a name="local-1627855346"><a href="#local-1627855346"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>              </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855346"><span class="hs-identifier hs-var">subst</span></a><span>
</span><a name="line-267"></a><span class="hs-identifier">extendSubstList</span><span> </span><a name="local-1627855347"><a href="#local-1627855347"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-1627855348"><a href="#local-1627855348"><span class="hs-identifier">var</span></a></a><span class="hs-special">,</span><a name="local-1627855349"><a href="#local-1627855349"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span class="hs-glyph">:</span><a name="local-1627855350"><a href="#local-1627855350"><span class="hs-identifier">prs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#extendSubstList"><span class="hs-identifier hs-var">extendSubstList</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#extendSubst"><span class="hs-identifier hs-var">extendSubst</span></a><span> </span><a href="#local-1627855347"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855348"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-1627855349"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855350"><span class="hs-identifier hs-var">prs</span></a><span>
</span><a name="line-268"></a><span>
</span><a name="line-269"></a><span class="hs-comment">-- | Find the substitution for an 'Id' in the 'Subst'</span><span>
</span><a name="line-270"></a><span class="hs-identifier">lookupIdSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-271"></a><a name="lookupIdSubst"><a href="CoreSubst.html#lookupIdSubst"><span class="hs-identifier">lookupIdSubst</span></a></a><span> </span><a name="local-1627855351"><a href="#local-1627855351"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-1627855352"><a href="#local-1627855352"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-1627855353"><a href="#local-1627855353"><span class="hs-identifier">ids</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-1627855354"><a href="#local-1627855354"><span class="hs-identifier">v</span></a></a><span>
</span><a name="line-272"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Var.html#isLocalId"><span class="hs-identifier hs-var">isLocalId</span></a><span> </span><a href="#local-1627855354"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a href="#local-1627855354"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-273"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1627855355"><a href="#local-1627855355"><span class="hs-identifier">e</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="VarEnv.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a><span> </span><a href="#local-1627855353"><span class="hs-identifier hs-var">ids</span></a><span>       </span><a href="#local-1627855354"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855355"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-274"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1627855356"><a href="#local-1627855356"><span class="hs-identifier">v'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="VarEnv.html#lookupInScope"><span class="hs-identifier hs-var">lookupInScope</span></a><span> </span><a href="#local-1627855352"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-1627855354"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a href="#local-1627855356"><span class="hs-identifier hs-var">v'</span></a><span>
</span><a name="line-275"></a><span>        </span><span class="hs-comment">-- Vital! See Note [Extending the Subst]</span><span>
</span><a name="line-276"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">WARN</span><span class="hs-special">(</span><span> </span><a href="Outputable.html#warnPprTrace"><span class="hs-identifier hs-var">True</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;CoreSubst.lookupIdSubst&quot;</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">doc</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">v</span><span>
</span><a name="line-277"></a><span>                            </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">in_scope</span><span class="hs-special">)</span><span>
</span><a name="line-278"></a><span>                </span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a href="#local-1627855354"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-279"></a><span>
</span><a name="line-280"></a><span class="hs-comment">-- | Find the substitution for a 'TyVar' in the 'Subst'</span><span>
</span><a name="line-281"></a><span class="hs-identifier">lookupTCvSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>
</span><a name="line-282"></a><a name="lookupTCvSubst"><a href="CoreSubst.html#lookupTCvSubst"><span class="hs-identifier">lookupTCvSubst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627855357"><a href="#local-1627855357"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-1627855358"><a href="#local-1627855358"><span class="hs-identifier">cvs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627855359"><a href="#local-1627855359"><span class="hs-identifier">v</span></a></a><span>
</span><a name="line-283"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-1627855359"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-284"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a><span> </span><a href="#local-1627855357"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-1627855359"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-special">`</span><a href="Maybes.html#orElse"><span class="hs-identifier hs-var">orElse</span></a><span class="hs-special">`</span><span> </span><a href="TyCoRep.html#mkTyVarTy"><span class="hs-identifier hs-var">Type</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">mkTyVarTy</span></a><span> </span><a href="#local-1627855359"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-285"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-286"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#mkCoercionTy"><span class="hs-identifier hs-var">mkCoercionTy</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="VarEnv.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a><span> </span><a href="#local-1627855358"><span class="hs-identifier hs-var">cvs</span></a><span> </span><a href="#local-1627855359"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-special">`</span><a href="Maybes.html#orElse"><span class="hs-identifier hs-var">orElse</span></a><span class="hs-special">`</span><span> </span><a href="Coercion.html#mkCoVarCo"><span class="hs-identifier hs-var">mkCoVarCo</span></a><span> </span><a href="#local-1627855359"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-287"></a><span>
</span><a name="line-288"></a><span class="hs-identifier">delBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-289"></a><a name="delBndr"><a href="CoreSubst.html#delBndr"><span class="hs-identifier">delBndr</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-1627855360"><a href="#local-1627855360"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-1627855361"><a href="#local-1627855361"><span class="hs-identifier">ids</span></a></a><span> </span><a name="local-1627855362"><a href="#local-1627855362"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-1627855363"><a href="#local-1627855363"><span class="hs-identifier">cvs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627855364"><a href="#local-1627855364"><span class="hs-identifier">v</span></a></a><span>
</span><a name="line-290"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a><span> </span><a href="#local-1627855364"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a href="#local-1627855360"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-1627855361"><span class="hs-identifier hs-var">ids</span></a><span> </span><a href="#local-1627855362"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#delVarEnv"><span class="hs-identifier hs-var">delVarEnv</span></a><span> </span><a href="#local-1627855363"><span class="hs-identifier hs-var">cvs</span></a><span> </span><a href="#local-1627855364"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-291"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-1627855364"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a href="#local-1627855360"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-1627855361"><span class="hs-identifier hs-var">ids</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#delVarEnv"><span class="hs-identifier hs-var">delVarEnv</span></a><span> </span><a href="#local-1627855362"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-1627855364"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855363"><span class="hs-identifier hs-var">cvs</span></a><span>
</span><a name="line-292"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a href="#local-1627855360"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#delVarEnv"><span class="hs-identifier hs-var">delVarEnv</span></a><span> </span><a href="#local-1627855361"><span class="hs-identifier hs-var">ids</span></a><span> </span><a href="#local-1627855364"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855362"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-1627855363"><span class="hs-identifier hs-var">cvs</span></a><span>
</span><a name="line-293"></a><span>
</span><a name="line-294"></a><span class="hs-identifier">delBndrs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-295"></a><a name="delBndrs"><a href="CoreSubst.html#delBndrs"><span class="hs-identifier">delBndrs</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-1627855365"><a href="#local-1627855365"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-1627855366"><a href="#local-1627855366"><span class="hs-identifier">ids</span></a></a><span> </span><a name="local-1627855367"><a href="#local-1627855367"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-1627855368"><a href="#local-1627855368"><span class="hs-identifier">cvs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627855369"><a href="#local-1627855369"><span class="hs-identifier">vs</span></a></a><span>
</span><a name="line-296"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a href="#local-1627855365"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#delVarEnvList"><span class="hs-identifier hs-var">delVarEnvList</span></a><span> </span><a href="#local-1627855366"><span class="hs-identifier hs-var">ids</span></a><span> </span><a href="#local-1627855369"><span class="hs-identifier hs-var">vs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="VarEnv.html#delVarEnvList"><span class="hs-identifier hs-var">delVarEnvList</span></a><span> </span><a href="#local-1627855367"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-1627855369"><span class="hs-identifier hs-var">vs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="VarEnv.html#delVarEnvList"><span class="hs-identifier hs-var">delVarEnvList</span></a><span> </span><a href="#local-1627855368"><span class="hs-identifier hs-var">cvs</span></a><span> </span><a href="#local-1627855369"><span class="hs-identifier hs-var">vs</span></a><span class="hs-special">)</span><span>
</span><a name="line-297"></a><span>      </span><span class="hs-comment">-- Easiest thing is just delete all from all!</span><span>
</span><a name="line-298"></a><span>
</span><a name="line-299"></a><span class="hs-comment">-- | Simultaneously substitute for a bunch of variables</span><span>
</span><a name="line-300"></a><span class="hs-comment">--   No left-right shadowing</span><span>
</span><a name="line-301"></a><span class="hs-comment">--   ie the substitution for   (\x \y. e) a1 a2</span><span>
</span><a name="line-302"></a><span class="hs-comment">--      so neither x nor y scope over a1 a2</span><span>
</span><a name="line-303"></a><span class="hs-identifier">mkOpenSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">,</span><a href="CoreSyn.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-304"></a><a name="mkOpenSubst"><a href="CoreSubst.html#mkOpenSubst"><span class="hs-identifier">mkOpenSubst</span></a></a><span> </span><a name="local-1627855370"><a href="#local-1627855370"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-1627855371"><a href="#local-1627855371"><span class="hs-identifier">pairs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a href="#local-1627855370"><span class="hs-identifier hs-var">in_scope</span></a><span>
</span><a name="line-305"></a><span>                                   </span><span class="hs-special">(</span><a href="VarEnv.html#mkVarEnv"><span class="hs-identifier hs-var">mkVarEnv</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-1627855372"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">,</span><a href="#local-1627855373"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-1627855372"><a href="#local-1627855372"><span class="hs-identifier">id</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855373"><a href="#local-1627855373"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627855371"><span class="hs-identifier hs-var">pairs</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#isId"><span class="hs-identifier hs-var">isId</span></a><span> </span><a href="#local-1627855372"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-306"></a><span>                                   </span><span class="hs-special">(</span><a href="VarEnv.html#mkVarEnv"><span class="hs-identifier hs-var">mkVarEnv</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-1627855374"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">,</span><a href="#local-1627855375"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-1627855374"><a href="#local-1627855374"><span class="hs-identifier">tv</span></a></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a name="local-1627855375"><a href="#local-1627855375"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627855371"><span class="hs-identifier hs-var">pairs</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-307"></a><span>                                   </span><span class="hs-special">(</span><a href="VarEnv.html#mkVarEnv"><span class="hs-identifier hs-var">mkVarEnv</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-1627855376"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">,</span><a href="#local-1627855377"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-1627855376"><a href="#local-1627855376"><span class="hs-identifier">v</span></a></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a name="local-1627855377"><a href="#local-1627855377"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627855371"><span class="hs-identifier hs-var">pairs</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-308"></a><span>
</span><a name="line-309"></a><span class="hs-comment">------------------------------</span><span>
</span><a name="line-310"></a><span class="hs-identifier">isInScope</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-311"></a><a name="isInScope"><a href="CoreSubst.html#isInScope"><span class="hs-identifier">isInScope</span></a></a><span> </span><a name="local-1627855378"><a href="#local-1627855378"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-1627855379"><a href="#local-1627855379"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855378"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#elemInScopeSet"><span class="hs-identifier hs-var">elemInScopeSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627855379"><span class="hs-identifier hs-var">in_scope</span></a><span>
</span><a name="line-312"></a><span>
</span><a name="line-313"></a><span class="hs-comment">-- | Add the 'Var' to the in-scope set, but do not remove</span><span>
</span><a name="line-314"></a><span class="hs-comment">-- any existing substitutions for it</span><span>
</span><a name="line-315"></a><span class="hs-identifier">addInScopeSet</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-316"></a><a name="addInScopeSet"><a href="CoreSubst.html#addInScopeSet"><span class="hs-identifier">addInScopeSet</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-1627855380"><a href="#local-1627855380"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-1627855381"><a href="#local-1627855381"><span class="hs-identifier">ids</span></a></a><span> </span><a name="local-1627855382"><a href="#local-1627855382"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-1627855383"><a href="#local-1627855383"><span class="hs-identifier">cvs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627855384"><a href="#local-1627855384"><span class="hs-identifier">vs</span></a></a><span>
</span><a name="line-317"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855380"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#extendInScopeSetSet"><span class="hs-identifier hs-var">extendInScopeSetSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627855384"><span class="hs-identifier hs-var">vs</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855381"><span class="hs-identifier hs-var">ids</span></a><span> </span><a href="#local-1627855382"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-1627855383"><span class="hs-identifier hs-var">cvs</span></a><span>
</span><a name="line-318"></a><span>
</span><a name="line-319"></a><span class="hs-comment">-- | Add the 'Var' to the in-scope set: as a side effect,</span><span>
</span><a name="line-320"></a><span class="hs-comment">-- and remove any existing substitutions for it</span><span>
</span><a name="line-321"></a><span class="hs-identifier">extendInScope</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-322"></a><a name="extendInScope"><a href="CoreSubst.html#extendInScope"><span class="hs-identifier">extendInScope</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-1627855385"><a href="#local-1627855385"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-1627855386"><a href="#local-1627855386"><span class="hs-identifier">ids</span></a></a><span> </span><a name="local-1627855387"><a href="#local-1627855387"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-1627855388"><a href="#local-1627855388"><span class="hs-identifier">cvs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627855389"><a href="#local-1627855389"><span class="hs-identifier">v</span></a></a><span>
</span><a name="line-323"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855385"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#extendInScopeSet"><span class="hs-identifier hs-var">extendInScopeSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627855389"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-324"></a><span>          </span><span class="hs-special">(</span><a href="#local-1627855386"><span class="hs-identifier hs-var">ids</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#delVarEnv"><span class="hs-identifier hs-var">delVarEnv</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627855389"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-1627855387"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#delVarEnv"><span class="hs-identifier hs-var">delVarEnv</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627855389"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-1627855388"><span class="hs-identifier hs-var">cvs</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#delVarEnv"><span class="hs-identifier hs-var">delVarEnv</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627855389"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-325"></a><span>
</span><a name="line-326"></a><span class="hs-comment">-- | Add the 'Var's to the in-scope set: see also 'extendInScope'</span><span>
</span><a name="line-327"></a><span class="hs-identifier">extendInScopeList</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-328"></a><a name="extendInScopeList"><a href="CoreSubst.html#extendInScopeList"><span class="hs-identifier">extendInScopeList</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-1627855390"><a href="#local-1627855390"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-1627855391"><a href="#local-1627855391"><span class="hs-identifier">ids</span></a></a><span> </span><a name="local-1627855392"><a href="#local-1627855392"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-1627855393"><a href="#local-1627855393"><span class="hs-identifier">cvs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627855394"><a href="#local-1627855394"><span class="hs-identifier">vs</span></a></a><span>
</span><a name="line-329"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855390"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#extendInScopeSetList"><span class="hs-identifier hs-var">extendInScopeSetList</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627855394"><span class="hs-identifier hs-var">vs</span></a><span class="hs-special">)</span><span>
</span><a name="line-330"></a><span>          </span><span class="hs-special">(</span><a href="#local-1627855391"><span class="hs-identifier hs-var">ids</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#delVarEnvList"><span class="hs-identifier hs-var">delVarEnvList</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627855394"><span class="hs-identifier hs-var">vs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-1627855392"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#delVarEnvList"><span class="hs-identifier hs-var">delVarEnvList</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627855394"><span class="hs-identifier hs-var">vs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-1627855393"><span class="hs-identifier hs-var">cvs</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#delVarEnvList"><span class="hs-identifier hs-var">delVarEnvList</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627855394"><span class="hs-identifier hs-var">vs</span></a><span class="hs-special">)</span><span>
</span><a name="line-331"></a><span>
</span><a name="line-332"></a><span class="hs-comment">-- | Optimized version of 'extendInScopeList' that can be used if you are certain</span><span>
</span><a name="line-333"></a><span class="hs-comment">-- all the things being added are 'Id's and hence none are 'TyVar's or 'CoVar's</span><span>
</span><a name="line-334"></a><span class="hs-identifier">extendInScopeIds</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-335"></a><a name="extendInScopeIds"><a href="CoreSubst.html#extendInScopeIds"><span class="hs-identifier">extendInScopeIds</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-1627855395"><a href="#local-1627855395"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-1627855396"><a href="#local-1627855396"><span class="hs-identifier">ids</span></a></a><span> </span><a name="local-1627855397"><a href="#local-1627855397"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-1627855398"><a href="#local-1627855398"><span class="hs-identifier">cvs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627855399"><a href="#local-1627855399"><span class="hs-identifier">vs</span></a></a><span>
</span><a name="line-336"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855395"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#extendInScopeSetList"><span class="hs-identifier hs-var">extendInScopeSetList</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627855399"><span class="hs-identifier hs-var">vs</span></a><span class="hs-special">)</span><span>
</span><a name="line-337"></a><span>          </span><span class="hs-special">(</span><a href="#local-1627855396"><span class="hs-identifier hs-var">ids</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#delVarEnvList"><span class="hs-identifier hs-var">delVarEnvList</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627855399"><span class="hs-identifier hs-var">vs</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855397"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-1627855398"><span class="hs-identifier hs-var">cvs</span></a><span>
</span><a name="line-338"></a><span>
</span><a name="line-339"></a><span class="hs-identifier">setInScope</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarEnv.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-340"></a><a name="setInScope"><a href="CoreSubst.html#setInScope"><span class="hs-identifier">setInScope</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627855400"><a href="#local-1627855400"><span class="hs-identifier">ids</span></a></a><span> </span><a name="local-1627855401"><a href="#local-1627855401"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-1627855402"><a href="#local-1627855402"><span class="hs-identifier">cvs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627855403"><a href="#local-1627855403"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a href="#local-1627855403"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-1627855400"><span class="hs-identifier hs-var">ids</span></a><span> </span><a href="#local-1627855401"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-1627855402"><span class="hs-identifier hs-var">cvs</span></a><span>
</span><a name="line-341"></a><span>
</span><a name="line-342"></a><span class="hs-comment">-- Pretty printing, for debugging only</span><span>
</span><a name="line-343"></a><span>
</span><a name="line-344"></a><span class="hs-keyword">instance</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-345"></a><span>  </span><a name="local-1912652361"><a href="Outputable.html#ppr"><span class="hs-identifier">ppr</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-1627855942"><a href="#local-1627855942"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-1627855943"><a href="#local-1627855943"><span class="hs-identifier">ids</span></a></a><span> </span><a name="local-1627855944"><a href="#local-1627855944"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-1627855945"><a href="#local-1627855945"><span class="hs-identifier">cvs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-346"></a><span>        </span><span class="hs-glyph">=</span><span>  </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;&lt;InScope =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#braces"><span class="hs-identifier hs-var">braces</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#fsep"><span class="hs-identifier hs-var">fsep</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#varEnvElts"><span class="hs-identifier hs-var">varEnvElts</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#getInScopeVars"><span class="hs-identifier hs-var">getInScopeVars</span></a><span> </span><a href="#local-1627855942"><span class="hs-identifier hs-var">in_scope</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-347"></a><span>        </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot; IdSubst   =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1627855943"><span class="hs-identifier hs-var">ids</span></a><span>
</span><a name="line-348"></a><span>        </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot; TvSubst   =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1627855944"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-349"></a><span>        </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot; CvSubst   =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1627855945"><span class="hs-identifier hs-var">cvs</span></a><span>
</span><a name="line-350"></a><span>         </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#char"><span class="hs-identifier hs-var">char</span></a><span> </span><span class="hs-char">'&gt;'</span><span>
</span><a name="line-351"></a><span>
</span><a name="line-352"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Substituting expressions
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-359"></a><span>
</span><a name="line-360"></a><span class="hs-comment">-- | Apply a substitution to an entire 'CoreExpr'. Remember, you may only</span><span>
</span><a name="line-361"></a><span class="hs-comment">-- apply the substitution /once/: see &quot;CoreSubst#apply_once&quot;</span><span>
</span><a name="line-362"></a><span class="hs-comment">--</span><span>
</span><a name="line-363"></a><span class="hs-comment">-- Do *not* attempt to short-cut in the case of an empty substitution!</span><span>
</span><a name="line-364"></a><span class="hs-comment">-- See Note [Extending the Subst]</span><span>
</span><a name="line-365"></a><span class="hs-identifier">substExprSC</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-366"></a><a name="substExprSC"><a href="CoreSubst.html#substExprSC"><span class="hs-identifier">substExprSC</span></a></a><span> </span><a name="local-1627855404"><a href="#local-1627855404"><span class="hs-identifier">doc</span></a></a><span> </span><a name="local-1627855405"><a href="#local-1627855405"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-1627855406"><a href="#local-1627855406"><span class="hs-identifier">orig_expr</span></a></a><span>
</span><a name="line-367"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="CoreSubst.html#isEmptySubst"><span class="hs-identifier hs-var">isEmptySubst</span></a><span> </span><a href="#local-1627855405"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855406"><span class="hs-identifier hs-var">orig_expr</span></a><span>
</span><a name="line-368"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;enter subst-expr&quot; (doc $$ ppr orig_expr) $</span><span>
</span><a name="line-369"></a><span>                         </span><a href="CoreSubst.html#subst_expr"><span class="hs-identifier hs-var">subst_expr</span></a><span> </span><a href="#local-1627855404"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-1627855405"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855406"><span class="hs-identifier hs-var">orig_expr</span></a><span>
</span><a name="line-370"></a><span>
</span><a name="line-371"></a><span class="hs-identifier">substExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-372"></a><a name="substExpr"><a href="CoreSubst.html#substExpr"><span class="hs-identifier">substExpr</span></a></a><span> </span><a name="local-1627855407"><a href="#local-1627855407"><span class="hs-identifier">doc</span></a></a><span> </span><a name="local-1627855408"><a href="#local-1627855408"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-1627855409"><a href="#local-1627855409"><span class="hs-identifier">orig_expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#subst_expr"><span class="hs-identifier hs-var">subst_expr</span></a><span> </span><a href="#local-1627855407"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-1627855408"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855409"><span class="hs-identifier hs-var">orig_expr</span></a><span>
</span><a name="line-373"></a><span>
</span><a name="line-374"></a><span class="hs-identifier">subst_expr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-375"></a><a name="subst_expr"><a href="CoreSubst.html#subst_expr"><span class="hs-identifier">subst_expr</span></a></a><span> </span><a name="local-1627855410"><a href="#local-1627855410"><span class="hs-identifier">doc</span></a></a><span> </span><a name="local-1627855411"><a href="#local-1627855411"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-1627855412"><a href="#local-1627855412"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-376"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855413"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627855412"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-377"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-378"></a><span>    </span><a name="local-1627855413"><a href="#local-1627855413"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-1627855415"><a href="#local-1627855415"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#lookupIdSubst"><span class="hs-identifier hs-var">lookupIdSubst</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855410"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;subst_expr&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-1627855411"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855415"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-379"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a name="local-1627855416"><a href="#local-1627855416"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><a href="#local-1627855411"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855416"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-380"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a name="local-1627855417"><a href="#local-1627855417"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substCo"><span class="hs-identifier hs-var">substCo</span></a><span> </span><a href="#local-1627855411"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855417"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-381"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><a name="local-1627855418"><a href="#local-1627855418"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><a href="#local-1627855418"><span class="hs-identifier hs-var">lit</span></a><span>
</span><a name="line-382"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-1627855419"><a href="#local-1627855419"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-1627855420"><a href="#local-1627855420"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855413"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627855419"><span class="hs-identifier hs-var">fun</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-1627855413"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627855420"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span>
</span><a name="line-383"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-1627855421"><a href="#local-1627855421"><span class="hs-identifier">tickish</span></a></a><span> </span><a name="local-1627855422"><a href="#local-1627855422"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substTickish"><span class="hs-identifier hs-var">substTickish</span></a><span> </span><a href="#local-1627855411"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855421"><span class="hs-identifier hs-var">tickish</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-1627855413"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627855422"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-384"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-1627855423"><a href="#local-1627855423"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-1627855424"><a href="#local-1627855424"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855413"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627855423"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substCo"><span class="hs-identifier hs-var">substCo</span></a><span> </span><a href="#local-1627855411"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855424"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-385"></a><span>       </span><span class="hs-comment">-- Do not optimise even identity coercions</span><span>
</span><a name="line-386"></a><span>       </span><span class="hs-comment">-- Reason: substitution applies to the LHS of RULES, and</span><span>
</span><a name="line-387"></a><span>       </span><span class="hs-comment">--         if you &quot;optimise&quot; an identity coercion, you may</span><span>
</span><a name="line-388"></a><span>       </span><span class="hs-comment">--         lose a binder. We optimise the LHS of rules at</span><span>
</span><a name="line-389"></a><span>       </span><span class="hs-comment">--         construction time</span><span>
</span><a name="line-390"></a><span>
</span><a name="line-391"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a name="local-1627855425"><a href="#local-1627855425"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-1627855426"><a href="#local-1627855426"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a href="#local-1627855428"><span class="hs-identifier hs-var">bndr'</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#subst_expr"><span class="hs-identifier hs-var">subst_expr</span></a><span> </span><a href="#local-1627855410"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-1627855427"><span class="hs-identifier hs-var">subst'</span></a><span> </span><a href="#local-1627855426"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-392"></a><span>                       </span><span class="hs-keyword">where</span><span>
</span><a name="line-393"></a><span>                         </span><span class="hs-special">(</span><a name="local-1627855427"><a href="#local-1627855427"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855428"><a href="#local-1627855428"><span class="hs-identifier">bndr'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substBndr"><span class="hs-identifier hs-var">substBndr</span></a><span> </span><a href="#local-1627855411"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855425"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-394"></a><span>
</span><a name="line-395"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><a name="local-1627855429"><a href="#local-1627855429"><span class="hs-identifier">bind</span></a></a><span> </span><a name="local-1627855430"><a href="#local-1627855430"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><a href="#local-1627855432"><span class="hs-identifier hs-var">bind'</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#subst_expr"><span class="hs-identifier hs-var">subst_expr</span></a><span> </span><a href="#local-1627855410"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-1627855431"><span class="hs-identifier hs-var">subst'</span></a><span> </span><a href="#local-1627855430"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-396"></a><span>                       </span><span class="hs-keyword">where</span><span>
</span><a name="line-397"></a><span>                         </span><span class="hs-special">(</span><a name="local-1627855431"><a href="#local-1627855431"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855432"><a href="#local-1627855432"><span class="hs-identifier">bind'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substBind"><span class="hs-identifier hs-var">substBind</span></a><span> </span><a href="#local-1627855411"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855429"><span class="hs-identifier hs-var">bind</span></a><span>
</span><a name="line-398"></a><span>
</span><a name="line-399"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Case"><span class="hs-identifier hs-var">Case</span></a><span> </span><a name="local-1627855433"><a href="#local-1627855433"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-1627855434"><a href="#local-1627855434"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-1627855435"><a href="#local-1627855435"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-1627855436"><a href="#local-1627855436"><span class="hs-identifier">alts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Case"><span class="hs-identifier hs-var">Case</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855413"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627855433"><span class="hs-identifier hs-var">scrut</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855438"><span class="hs-identifier hs-var">bndr'</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><a href="#local-1627855411"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855435"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855414"><span class="hs-identifier hs-var">go_alt</span></a><span> </span><a href="#local-1627855437"><span class="hs-identifier hs-var">subst'</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855436"><span class="hs-identifier hs-var">alts</span></a><span class="hs-special">)</span><span>
</span><a name="line-400"></a><span>                                 </span><span class="hs-keyword">where</span><span>
</span><a name="line-401"></a><span>                                 </span><span class="hs-special">(</span><a name="local-1627855437"><a href="#local-1627855437"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855438"><a href="#local-1627855438"><span class="hs-identifier">bndr'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substBndr"><span class="hs-identifier hs-var">substBndr</span></a><span> </span><a href="#local-1627855411"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855434"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-402"></a><span>
</span><a name="line-403"></a><span>    </span><a name="local-1627855414"><a href="#local-1627855414"><span class="hs-identifier">go_alt</span></a></a><span> </span><a name="local-1627855439"><a href="#local-1627855439"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1627855440"><a href="#local-1627855440"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855441"><a href="#local-1627855441"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855442"><a href="#local-1627855442"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-1627855440"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627855444"><span class="hs-identifier hs-var">bndrs'</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#subst_expr"><span class="hs-identifier hs-var">subst_expr</span></a><span> </span><a href="#local-1627855410"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-1627855443"><span class="hs-identifier hs-var">subst'</span></a><span> </span><a href="#local-1627855442"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-404"></a><span>                                 </span><span class="hs-keyword">where</span><span>
</span><a name="line-405"></a><span>                                   </span><span class="hs-special">(</span><a name="local-1627855443"><a href="#local-1627855443"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855444"><a href="#local-1627855444"><span class="hs-identifier">bndrs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substBndrs"><span class="hs-identifier hs-var">substBndrs</span></a><span> </span><a href="#local-1627855439"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855441"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-406"></a><span>
</span><a name="line-407"></a><span class="hs-comment">-- | Apply a substitution to an entire 'CoreBind', additionally returning an updated 'Subst'</span><span>
</span><a name="line-408"></a><span class="hs-comment">-- that should be used by subsequent substitutions.</span><span>
</span><a name="line-409"></a><span class="hs-identifier">substBind</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">substBindSC</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a><span class="hs-special">)</span><span>
</span><a name="line-410"></a><span>
</span><a name="line-411"></a><a name="substBindSC"><a href="CoreSubst.html#substBindSC"><span class="hs-identifier">substBindSC</span></a></a><span> </span><a name="local-1627855445"><a href="#local-1627855445"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-1627855446"><a href="#local-1627855446"><span class="hs-identifier">bind</span></a></a><span>    </span><span class="hs-comment">-- Short-cut if the substitution is empty</span><span>
</span><a name="line-412"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#isEmptySubst"><span class="hs-identifier hs-var">isEmptySubst</span></a><span> </span><a href="#local-1627855445"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">)</span><span>
</span><a name="line-413"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substBind"><span class="hs-identifier hs-var">substBind</span></a><span> </span><a href="#local-1627855445"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855446"><span class="hs-identifier hs-var">bind</span></a><span>
</span><a name="line-414"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-415"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1627855446"><span class="hs-identifier hs-var">bind</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-416"></a><span>       </span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a name="local-1627855447"><a href="#local-1627855447"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-1627855448"><a href="#local-1627855448"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-1627855449"><span class="hs-identifier hs-var">subst'</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a href="#local-1627855450"><span class="hs-identifier hs-var">bndr'</span></a><span> </span><a href="#local-1627855448"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-417"></a><span>          </span><span class="hs-keyword">where</span><span>
</span><a name="line-418"></a><span>            </span><span class="hs-special">(</span><a name="local-1627855449"><a href="#local-1627855449"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855450"><a href="#local-1627855450"><span class="hs-identifier">bndr'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substBndr"><span class="hs-identifier hs-var">substBndr</span></a><span> </span><a href="#local-1627855445"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855447"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-419"></a><span>       </span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><a name="local-1627855451"><a href="#local-1627855451"><span class="hs-identifier">pairs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-1627855454"><span class="hs-identifier hs-var">subst'</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855455"><span class="hs-identifier hs-var">bndrs'</span></a><span> </span><span class="hs-special">`</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zip"><span class="hs-identifier hs-var">zip</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627855456"><span class="hs-identifier hs-var">rhss'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-420"></a><span>          </span><span class="hs-keyword">where</span><span>
</span><a name="line-421"></a><span>            </span><span class="hs-special">(</span><a name="local-1627855452"><a href="#local-1627855452"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855453"><a href="#local-1627855453"><span class="hs-identifier">rhss</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#unzip"><span class="hs-identifier hs-var">unzip</span></a><span> </span><a href="#local-1627855451"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-422"></a><span>            </span><span class="hs-special">(</span><a name="local-1627855454"><a href="#local-1627855454"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855455"><a href="#local-1627855455"><span class="hs-identifier">bndrs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substRecBndrs"><span class="hs-identifier hs-var">substRecBndrs</span></a><span> </span><a href="#local-1627855445"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855452"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-423"></a><span>            </span><a name="local-1627855456"><a href="#local-1627855456"><span class="hs-identifier">rhss'</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="CoreSubst.html#isEmptySubst"><span class="hs-identifier hs-var">isEmptySubst</span></a><span> </span><a href="#local-1627855454"><span class="hs-identifier hs-var">subst'</span></a><span>
</span><a name="line-424"></a><span>                  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855453"><span class="hs-identifier hs-var">rhss</span></a><span>
</span><a name="line-425"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-426"></a><span>                  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#subst_expr"><span class="hs-identifier hs-var">subst_expr</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;substBindSC&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-1627855454"><span class="hs-identifier hs-var">subst'</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855453"><span class="hs-identifier hs-var">rhss</span></a><span>
</span><a name="line-427"></a><span>
</span><a name="line-428"></a><a name="substBind"><a href="CoreSubst.html#substBind"><span class="hs-identifier">substBind</span></a></a><span> </span><a name="local-1627855457"><a href="#local-1627855457"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a name="local-1627855458"><a href="#local-1627855458"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-1627855459"><a href="#local-1627855459"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-429"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-1627855460"><span class="hs-identifier hs-var">subst'</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a href="#local-1627855461"><span class="hs-identifier hs-var">bndr'</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#subst_expr"><span class="hs-identifier hs-var">subst_expr</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;substBind&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-1627855457"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855459"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-430"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-431"></a><span>    </span><span class="hs-special">(</span><a name="local-1627855460"><a href="#local-1627855460"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855461"><a href="#local-1627855461"><span class="hs-identifier">bndr'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substBndr"><span class="hs-identifier hs-var">substBndr</span></a><span> </span><a href="#local-1627855457"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855458"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-432"></a><span>
</span><a name="line-433"></a><span class="hs-identifier">substBind</span><span> </span><a name="local-1627855462"><a href="#local-1627855462"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><a name="local-1627855463"><a href="#local-1627855463"><span class="hs-identifier">pairs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-434"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-1627855466"><span class="hs-identifier hs-var">subst'</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855467"><span class="hs-identifier hs-var">bndrs'</span></a><span> </span><span class="hs-special">`</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zip"><span class="hs-identifier hs-var">zip</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627855468"><span class="hs-identifier hs-var">rhss'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-435"></a><span>   </span><span class="hs-keyword">where</span><span>
</span><a name="line-436"></a><span>       </span><span class="hs-special">(</span><a name="local-1627855464"><a href="#local-1627855464"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855465"><a href="#local-1627855465"><span class="hs-identifier">rhss</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#unzip"><span class="hs-identifier hs-var">unzip</span></a><span> </span><a href="#local-1627855463"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-437"></a><span>       </span><span class="hs-special">(</span><a name="local-1627855466"><a href="#local-1627855466"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855467"><a href="#local-1627855467"><span class="hs-identifier">bndrs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substRecBndrs"><span class="hs-identifier hs-var">substRecBndrs</span></a><span> </span><a href="#local-1627855462"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855464"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-438"></a><span>       </span><a name="local-1627855468"><a href="#local-1627855468"><span class="hs-identifier">rhss'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#subst_expr"><span class="hs-identifier hs-var">subst_expr</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;substBind&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-1627855466"><span class="hs-identifier hs-var">subst'</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855465"><span class="hs-identifier hs-var">rhss</span></a><span>
</span><a name="line-439"></a><span>
</span><a name="line-440"></a><span class="hs-comment">-- | De-shadowing the program is sometimes a useful pre-pass. It can be done simply</span><span>
</span><a name="line-441"></a><span class="hs-comment">-- by running over the bindings with an empty substitution, because substitution</span><span>
</span><a name="line-442"></a><span class="hs-comment">-- returns a result that has no-shadowing guaranteed.</span><span>
</span><a name="line-443"></a><span class="hs-comment">--</span><span>
</span><a name="line-444"></a><span class="hs-comment">-- (Actually, within a single /type/ there might still be shadowing, because</span><span>
</span><a name="line-445"></a><span class="hs-comment">-- 'substTy' is a no-op for the empty substitution, but that's probably OK.)</span><span>
</span><a name="line-446"></a><span class="hs-comment">--</span><span>
</span><a name="line-447"></a><span class="hs-comment">-- [Aug 09] This function is not used in GHC at the moment, but seems so</span><span>
</span><a name="line-448"></a><span class="hs-comment">--          short and simple that I'm going to leave it here</span><span>
</span><a name="line-449"></a><span class="hs-identifier">deShadowBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreProgram"><span class="hs-identifier hs-type">CoreProgram</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreProgram"><span class="hs-identifier hs-type">CoreProgram</span></a><span>
</span><a name="line-450"></a><a name="deShadowBinds"><a href="CoreSubst.html#deShadowBinds"><span class="hs-identifier">deShadowBinds</span></a></a><span> </span><a name="local-1627855469"><a href="#local-1627855469"><span class="hs-identifier">binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#snd"><span class="hs-identifier hs-var">snd</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapAccumL"><span class="hs-identifier hs-var">mapAccumL</span></a><span> </span><a href="CoreSubst.html#substBind"><span class="hs-identifier hs-var">substBind</span></a><span> </span><a href="CoreSubst.html#emptySubst"><span class="hs-identifier hs-var">emptySubst</span></a><span> </span><a href="#local-1627855469"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-451"></a><span>
</span><a name="line-452"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Substituting binders
*                                                                      *
************************************************************************

Remember that substBndr and friends are used when doing expression
substitution only.  Their only business is substitution, so they
preserve all IdInfo (suitably substituted).  For example, we *want* to
preserve occ info in rules.
-}</span><span>
</span><a name="line-464"></a><span>
</span><a name="line-465"></a><span class="hs-comment">-- | Substitutes a 'Var' for another one according to the 'Subst' given, returning</span><span>
</span><a name="line-466"></a><span class="hs-comment">-- the result and an updated 'Subst' that should be used by subsequent substitutions.</span><span>
</span><a name="line-467"></a><span class="hs-comment">-- 'IdInfo' is preserved by this process, although it is substituted into appropriately.</span><span>
</span><a name="line-468"></a><span class="hs-identifier">substBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">)</span><span>
</span><a name="line-469"></a><a name="substBndr"><a href="CoreSubst.html#substBndr"><span class="hs-identifier">substBndr</span></a></a><span> </span><a name="local-1627855470"><a href="#local-1627855470"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-1627855471"><a href="#local-1627855471"><span class="hs-identifier">bndr</span></a></a><span>
</span><a name="line-470"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-1627855471"><span class="hs-identifier hs-var">bndr</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substTyVarBndr"><span class="hs-identifier hs-var">substTyVarBndr</span></a><span> </span><a href="#local-1627855470"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855471"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-471"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a><span> </span><a href="#local-1627855471"><span class="hs-identifier hs-var">bndr</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substCoVarBndr"><span class="hs-identifier hs-var">substCoVarBndr</span></a><span> </span><a href="#local-1627855470"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855471"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-472"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substIdBndr"><span class="hs-identifier hs-var">substIdBndr</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;var-bndr&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-1627855470"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855470"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855471"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-473"></a><span>
</span><a name="line-474"></a><span class="hs-comment">-- | Applies 'substBndr' to a number of 'Var's, accumulating a new 'Subst' left-to-right</span><span>
</span><a name="line-475"></a><span class="hs-identifier">substBndrs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-476"></a><a name="substBndrs"><a href="CoreSubst.html#substBndrs"><span class="hs-identifier">substBndrs</span></a></a><span> </span><a name="local-1627855472"><a href="#local-1627855472"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-1627855473"><a href="#local-1627855473"><span class="hs-identifier">bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapAccumL"><span class="hs-identifier hs-var">mapAccumL</span></a><span> </span><a href="CoreSubst.html#substBndr"><span class="hs-identifier hs-var">substBndr</span></a><span> </span><a href="#local-1627855472"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855473"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-477"></a><span>
</span><a name="line-478"></a><span class="hs-comment">-- | Substitute in a mutually recursive group of 'Id's</span><span>
</span><a name="line-479"></a><span class="hs-identifier">substRecBndrs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-480"></a><a name="substRecBndrs"><a href="CoreSubst.html#substRecBndrs"><span class="hs-identifier">substRecBndrs</span></a></a><span> </span><a name="local-1627855474"><a href="#local-1627855474"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-1627855475"><a href="#local-1627855475"><span class="hs-identifier">bndrs</span></a></a><span>
</span><a name="line-481"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-1627855476"><span class="hs-identifier hs-var">new_subst</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627855477"><span class="hs-identifier hs-var">new_bndrs</span></a><span class="hs-special">)</span><span>
</span><a name="line-482"></a><span>  </span><span class="hs-keyword">where</span><span>         </span><span class="hs-comment">-- Here's the reason we need to pass rec_subst to subst_id</span><span>
</span><a name="line-483"></a><span>    </span><span class="hs-special">(</span><a name="local-1627855476"><a href="#local-1627855476"><span class="hs-identifier">new_subst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855477"><a href="#local-1627855477"><span class="hs-identifier">new_bndrs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapAccumL"><span class="hs-identifier hs-var">mapAccumL</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substIdBndr"><span class="hs-identifier hs-var">substIdBndr</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;rec-bndr&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-1627855476"><span class="hs-identifier hs-var">new_subst</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855474"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855475"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-484"></a><span>
</span><a name="line-485"></a><span class="hs-identifier">substIdBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-486"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>            </span><span class="hs-comment">-- ^ Substitution to use for the IdInfo</span><span>
</span><a name="line-487"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span>      </span><span class="hs-comment">-- ^ Substitution and Id to transform</span><span>
</span><a name="line-488"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">)</span><span>      </span><span class="hs-comment">-- ^ Transformed pair</span><span>
</span><a name="line-489"></a><span>                                </span><span class="hs-comment">-- NB: unfolding may be zapped</span><span>
</span><a name="line-490"></a><span>
</span><a name="line-491"></a><a name="substIdBndr"><a href="CoreSubst.html#substIdBndr"><span class="hs-identifier">substIdBndr</span></a></a><span> </span><a name="local-1627855478"><a href="#local-1627855478"><span class="hs-identifier">_doc</span></a></a><span> </span><a name="local-1627855479"><a href="#local-1627855479"><span class="hs-identifier">rec_subst</span></a></a><span> </span><a name="local-1627855480"><a href="#local-1627855480"><span class="hs-identifier">subst</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-1627855481"><a href="#local-1627855481"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-1627855482"><a href="#local-1627855482"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-1627855483"><a href="#local-1627855483"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-1627855484"><a href="#local-1627855484"><span class="hs-identifier">cvs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627855485"><a href="#local-1627855485"><span class="hs-identifier">old_id</span></a></a><span>
</span><a name="line-492"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;substIdBndr&quot; (doc $$ ppr old_id $$ ppr in_scope) $</span><span>
</span><a name="line-493"></a><span>    </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855481"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#extendInScopeSet"><span class="hs-identifier hs-var">extendInScopeSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627855490"><span class="hs-identifier hs-var">new_id</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855492"><span class="hs-identifier hs-var">new_env</span></a><span> </span><a href="#local-1627855483"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-1627855484"><span class="hs-identifier hs-var">cvs</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627855490"><span class="hs-identifier hs-var">new_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-494"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-495"></a><span>    </span><a name="local-1627855486"><a href="#local-1627855486"><span class="hs-identifier">id1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#uniqAway"><span class="hs-identifier hs-var">uniqAway</span></a><span> </span><a href="#local-1627855481"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-1627855485"><span class="hs-identifier hs-var">old_id</span></a><span>      </span><span class="hs-comment">-- id1 is cloned if necessary</span><span>
</span><a name="line-496"></a><span>    </span><a name="local-1627855487"><a href="#local-1627855487"><span class="hs-identifier">id2</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627855489"><span class="hs-identifier hs-var">no_type_change</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855486"><span class="hs-identifier hs-var">id1</span></a><span>
</span><a name="line-497"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#setIdType"><span class="hs-identifier hs-var">setIdType</span></a><span> </span><a href="#local-1627855486"><span class="hs-identifier hs-var">id1</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><a href="#local-1627855480"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855488"><span class="hs-identifier hs-var">old_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-498"></a><span>
</span><a name="line-499"></a><span>    </span><a name="local-1627855488"><a href="#local-1627855488"><span class="hs-identifier">old_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#idType"><span class="hs-identifier hs-var">idType</span></a><span> </span><a href="#local-1627855485"><span class="hs-identifier hs-var">old_id</span></a><span>
</span><a name="line-500"></a><span>    </span><a name="local-1627855489"><a href="#local-1627855489"><span class="hs-identifier">no_type_change</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="VarEnv.html#isEmptyVarEnv"><span class="hs-identifier hs-var">isEmptyVarEnv</span></a><span> </span><a href="#local-1627855483"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="VarEnv.html#isEmptyVarEnv"><span class="hs-identifier hs-var">isEmptyVarEnv</span></a><span> </span><a href="#local-1627855484"><span class="hs-identifier hs-var">cvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">||</span><span>
</span><a name="line-501"></a><span>                     </span><a href="VarSet.html#isEmptyVarSet"><span class="hs-identifier hs-var">isEmptyVarSet</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#tyCoVarsOfType"><span class="hs-identifier hs-var">tyCoVarsOfType</span></a><span> </span><a href="#local-1627855488"><span class="hs-identifier hs-var">old_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-502"></a><span>
</span><a name="line-503"></a><span>        </span><span class="hs-comment">-- new_id has the right IdInfo</span><span>
</span><a name="line-504"></a><span>        </span><span class="hs-comment">-- The lazy-set is because we're in a loop here, with</span><span>
</span><a name="line-505"></a><span>        </span><span class="hs-comment">-- rec_subst, when dealing with a mutually-recursive group</span><span>
</span><a name="line-506"></a><span>    </span><a name="local-1627855490"><a href="#local-1627855490"><span class="hs-identifier">new_id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#maybeModifyIdInfo"><span class="hs-identifier hs-var">maybeModifyIdInfo</span></a><span> </span><a href="#local-1627855491"><span class="hs-identifier hs-var">mb_new_info</span></a><span> </span><a href="#local-1627855487"><span class="hs-identifier hs-var">id2</span></a><span>
</span><a name="line-507"></a><span>    </span><a name="local-1627855491"><a href="#local-1627855491"><span class="hs-identifier">mb_new_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substIdInfo"><span class="hs-identifier hs-var">substIdInfo</span></a><span> </span><a href="#local-1627855479"><span class="hs-identifier hs-var">rec_subst</span></a><span> </span><a href="#local-1627855487"><span class="hs-identifier hs-var">id2</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#idInfo"><span class="hs-identifier hs-var">idInfo</span></a><span> </span><a href="#local-1627855487"><span class="hs-identifier hs-var">id2</span></a><span class="hs-special">)</span><span>
</span><a name="line-508"></a><span>        </span><span class="hs-comment">-- NB: unfolding info may be zapped</span><span>
</span><a name="line-509"></a><span>
</span><a name="line-510"></a><span>        </span><span class="hs-comment">-- Extend the substitution if the unique has changed</span><span>
</span><a name="line-511"></a><span>        </span><span class="hs-comment">-- See the notes with substTyVarBndr for the delVarEnv</span><span>
</span><a name="line-512"></a><span>    </span><a name="local-1627855492"><a href="#local-1627855492"><span class="hs-identifier">new_env</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627855493"><span class="hs-identifier hs-var">no_change</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#delVarEnv"><span class="hs-identifier hs-var">delVarEnv</span></a><span> </span><a href="#local-1627855482"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627855485"><span class="hs-identifier hs-var">old_id</span></a><span>
</span><a name="line-513"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a><span> </span><a href="#local-1627855482"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627855485"><span class="hs-identifier hs-var">old_id</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a href="#local-1627855490"><span class="hs-identifier hs-var">new_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-514"></a><span>
</span><a name="line-515"></a><span>    </span><a name="local-1627855493"><a href="#local-1627855493"><span class="hs-identifier">no_change</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855486"><span class="hs-identifier hs-var">id1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-1627855485"><span class="hs-identifier hs-var">old_id</span></a><span>
</span><a name="line-516"></a><span>        </span><span class="hs-comment">-- See Note [Extending the Subst]</span><span>
</span><a name="line-517"></a><span>        </span><span class="hs-comment">-- it's /not/ necessary to check mb_new_info and no_type_change</span><span>
</span><a name="line-518"></a><span>
</span><a name="line-519"></a><span class="hs-comment">{-
Now a variant that unconditionally allocates a new unique.
It also unconditionally zaps the OccInfo.
-}</span><span>
</span><a name="line-523"></a><span>
</span><a name="line-524"></a><span class="hs-comment">-- | Very similar to 'substBndr', but it always allocates a new 'Unique' for</span><span>
</span><a name="line-525"></a><span class="hs-comment">-- each variable in its output.  It substitutes the IdInfo though.</span><span>
</span><a name="line-526"></a><span class="hs-identifier">cloneIdBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UniqSupply.html#UniqSupply"><span class="hs-identifier hs-type">UniqSupply</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">)</span><span>
</span><a name="line-527"></a><a name="cloneIdBndr"><a href="CoreSubst.html#cloneIdBndr"><span class="hs-identifier">cloneIdBndr</span></a></a><span> </span><a name="local-1627855494"><a href="#local-1627855494"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-1627855495"><a href="#local-1627855495"><span class="hs-identifier">us</span></a></a><span> </span><a name="local-1627855496"><a href="#local-1627855496"><span class="hs-identifier">old_id</span></a></a><span>
</span><a name="line-528"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#clone_id"><span class="hs-identifier hs-var">clone_id</span></a><span> </span><a href="#local-1627855494"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855494"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855496"><span class="hs-identifier hs-var">old_id</span></a><span class="hs-special">,</span><span> </span><a href="UniqSupply.html#uniqFromSupply"><span class="hs-identifier hs-var">uniqFromSupply</span></a><span> </span><a href="#local-1627855495"><span class="hs-identifier hs-var">us</span></a><span class="hs-special">)</span><span>
</span><a name="line-529"></a><span>
</span><a name="line-530"></a><span class="hs-comment">-- | Applies 'cloneIdBndr' to a number of 'Id's, accumulating a final</span><span>
</span><a name="line-531"></a><span class="hs-comment">-- substitution from left to right</span><span>
</span><a name="line-532"></a><span class="hs-identifier">cloneIdBndrs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UniqSupply.html#UniqSupply"><span class="hs-identifier hs-type">UniqSupply</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-533"></a><a name="cloneIdBndrs"><a href="CoreSubst.html#cloneIdBndrs"><span class="hs-identifier">cloneIdBndrs</span></a></a><span> </span><a name="local-1627855497"><a href="#local-1627855497"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-1627855498"><a href="#local-1627855498"><span class="hs-identifier">us</span></a></a><span> </span><a name="local-1627855499"><a href="#local-1627855499"><span class="hs-identifier">ids</span></a></a><span>
</span><a name="line-534"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapAccumL"><span class="hs-identifier hs-var">mapAccumL</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#clone_id"><span class="hs-identifier hs-var">clone_id</span></a><span> </span><a href="#local-1627855497"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855497"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855499"><span class="hs-identifier hs-var">ids</span></a><span> </span><span class="hs-special">`</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zip"><span class="hs-identifier hs-var">zip</span></a><span class="hs-special">`</span><span> </span><a href="UniqSupply.html#uniqsFromSupply"><span class="hs-identifier hs-var">uniqsFromSupply</span></a><span> </span><a href="#local-1627855498"><span class="hs-identifier hs-var">us</span></a><span class="hs-special">)</span><span>
</span><a name="line-535"></a><span>
</span><a name="line-536"></a><span class="hs-identifier">cloneBndrs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UniqSupply.html#UniqSupply"><span class="hs-identifier hs-type">UniqSupply</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-537"></a><span class="hs-comment">-- Works for all kinds of variables (typically case binders)</span><span>
</span><a name="line-538"></a><span class="hs-comment">-- not just Ids</span><span>
</span><a name="line-539"></a><a name="cloneBndrs"><a href="CoreSubst.html#cloneBndrs"><span class="hs-identifier">cloneBndrs</span></a></a><span> </span><a name="local-1627855500"><a href="#local-1627855500"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-1627855501"><a href="#local-1627855501"><span class="hs-identifier">us</span></a></a><span> </span><a name="local-1627855502"><a href="#local-1627855502"><span class="hs-identifier">vs</span></a></a><span>
</span><a name="line-540"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapAccumL"><span class="hs-identifier hs-var">mapAccumL</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-1627855503"><a href="#local-1627855503"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1627855504"><a href="#local-1627855504"><span class="hs-identifier">v</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855505"><a href="#local-1627855505"><span class="hs-identifier">u</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#cloneBndr"><span class="hs-identifier hs-var">cloneBndr</span></a><span> </span><a href="#local-1627855503"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855505"><span class="hs-identifier hs-var">u</span></a><span> </span><a href="#local-1627855504"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855500"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855502"><span class="hs-identifier hs-var">vs</span></a><span> </span><span class="hs-special">`</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zip"><span class="hs-identifier hs-var">zip</span></a><span class="hs-special">`</span><span> </span><a href="UniqSupply.html#uniqsFromSupply"><span class="hs-identifier hs-var">uniqsFromSupply</span></a><span> </span><a href="#local-1627855501"><span class="hs-identifier hs-var">us</span></a><span class="hs-special">)</span><span>
</span><a name="line-541"></a><span>
</span><a name="line-542"></a><span class="hs-identifier">cloneBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">)</span><span>
</span><a name="line-543"></a><a name="cloneBndr"><a href="CoreSubst.html#cloneBndr"><span class="hs-identifier">cloneBndr</span></a></a><span> </span><a name="local-1627855506"><a href="#local-1627855506"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-1627855507"><a href="#local-1627855507"><span class="hs-identifier">uniq</span></a></a><span> </span><a name="local-1627855508"><a href="#local-1627855508"><span class="hs-identifier">v</span></a></a><span>
</span><a name="line-544"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-1627855508"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#cloneTyVarBndr"><span class="hs-identifier hs-var">cloneTyVarBndr</span></a><span> </span><a href="#local-1627855506"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855508"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-1627855507"><span class="hs-identifier hs-var">uniq</span></a><span>
</span><a name="line-545"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#clone_id"><span class="hs-identifier hs-var">clone_id</span></a><span> </span><a href="#local-1627855506"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855506"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855508"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">,</span><a href="#local-1627855507"><span class="hs-identifier hs-var">uniq</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Works for coercion variables too</span><span>
</span><a name="line-546"></a><span>
</span><a name="line-547"></a><span class="hs-comment">-- | Clone a mutually recursive group of 'Id's</span><span>
</span><a name="line-548"></a><span class="hs-identifier">cloneRecIdBndrs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UniqSupply.html#UniqSupply"><span class="hs-identifier hs-type">UniqSupply</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-549"></a><a name="cloneRecIdBndrs"><a href="CoreSubst.html#cloneRecIdBndrs"><span class="hs-identifier">cloneRecIdBndrs</span></a></a><span> </span><a name="local-1627855509"><a href="#local-1627855509"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-1627855510"><a href="#local-1627855510"><span class="hs-identifier">us</span></a></a><span> </span><a name="local-1627855511"><a href="#local-1627855511"><span class="hs-identifier">ids</span></a></a><span>
</span><a name="line-550"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-1627855512"><span class="hs-identifier hs-var">subst'</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627855513"><span class="hs-identifier hs-var">ids'</span></a><span class="hs-special">)</span><span>
</span><a name="line-551"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-552"></a><span>    </span><span class="hs-special">(</span><a name="local-1627855512"><a href="#local-1627855512"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855513"><a href="#local-1627855513"><span class="hs-identifier">ids'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapAccumL"><span class="hs-identifier hs-var">mapAccumL</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#clone_id"><span class="hs-identifier hs-var">clone_id</span></a><span> </span><a href="#local-1627855512"><span class="hs-identifier hs-var">subst'</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855509"><span class="hs-identifier hs-var">subst</span></a><span>
</span><a name="line-553"></a><span>                               </span><span class="hs-special">(</span><a href="#local-1627855511"><span class="hs-identifier hs-var">ids</span></a><span> </span><span class="hs-special">`</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zip"><span class="hs-identifier hs-var">zip</span></a><span class="hs-special">`</span><span> </span><a href="UniqSupply.html#uniqsFromSupply"><span class="hs-identifier hs-var">uniqsFromSupply</span></a><span> </span><a href="#local-1627855510"><span class="hs-identifier hs-var">us</span></a><span class="hs-special">)</span><span>
</span><a name="line-554"></a><span>
</span><a name="line-555"></a><span class="hs-comment">-- Just like substIdBndr, except that it always makes a new unique</span><span>
</span><a name="line-556"></a><span class="hs-comment">-- It is given the unique to use</span><span>
</span><a name="line-557"></a><span class="hs-identifier">clone_id</span><span>    </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>                    </span><span class="hs-comment">-- Substitution for the IdInfo</span><span>
</span><a name="line-558"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">,</span><span> </span><a href="Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- Substitution and Id to transform</span><span>
</span><a name="line-559"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">)</span><span>              </span><span class="hs-comment">-- Transformed pair</span><span>
</span><a name="line-560"></a><span>
</span><a name="line-561"></a><a name="clone_id"><a href="CoreSubst.html#clone_id"><span class="hs-identifier">clone_id</span></a></a><span> </span><a name="local-1627855514"><a href="#local-1627855514"><span class="hs-identifier">rec_subst</span></a></a><span> </span><a name="local-1627855515"><a href="#local-1627855515"><span class="hs-identifier">subst</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-1627855516"><a href="#local-1627855516"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-1627855517"><a href="#local-1627855517"><span class="hs-identifier">idvs</span></a></a><span> </span><a name="local-1627855518"><a href="#local-1627855518"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-1627855519"><a href="#local-1627855519"><span class="hs-identifier">cvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-1627855520"><a href="#local-1627855520"><span class="hs-identifier">old_id</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855521"><a href="#local-1627855521"><span class="hs-identifier">uniq</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-562"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855516"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#extendInScopeSet"><span class="hs-identifier hs-var">extendInScopeSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627855524"><span class="hs-identifier hs-var">new_id</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855525"><span class="hs-identifier hs-var">new_idvs</span></a><span> </span><a href="#local-1627855518"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-1627855526"><span class="hs-identifier hs-var">new_cvs</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627855524"><span class="hs-identifier hs-var">new_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-563"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-564"></a><span>    </span><a name="local-1627855522"><a href="#local-1627855522"><span class="hs-identifier">id1</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#setVarUnique"><span class="hs-identifier hs-var">setVarUnique</span></a><span> </span><a href="#local-1627855520"><span class="hs-identifier hs-var">old_id</span></a><span> </span><a href="#local-1627855521"><span class="hs-identifier hs-var">uniq</span></a><span>
</span><a name="line-565"></a><span>    </span><a name="local-1627855523"><a href="#local-1627855523"><span class="hs-identifier">id2</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substIdType"><span class="hs-identifier hs-var">substIdType</span></a><span> </span><a href="#local-1627855515"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855522"><span class="hs-identifier hs-var">id1</span></a><span>
</span><a name="line-566"></a><span>    </span><a name="local-1627855524"><a href="#local-1627855524"><span class="hs-identifier">new_id</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#maybeModifyIdInfo"><span class="hs-identifier hs-var">maybeModifyIdInfo</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substIdInfo"><span class="hs-identifier hs-var">substIdInfo</span></a><span> </span><a href="#local-1627855514"><span class="hs-identifier hs-var">rec_subst</span></a><span> </span><a href="#local-1627855523"><span class="hs-identifier hs-var">id2</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#idInfo"><span class="hs-identifier hs-var">idInfo</span></a><span> </span><a href="#local-1627855520"><span class="hs-identifier hs-var">old_id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-1627855523"><span class="hs-identifier hs-var">id2</span></a><span>
</span><a name="line-567"></a><span>    </span><span class="hs-special">(</span><a name="local-1627855525"><a href="#local-1627855525"><span class="hs-identifier">new_idvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855526"><a href="#local-1627855526"><span class="hs-identifier">new_cvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a><span> </span><a href="#local-1627855520"><span class="hs-identifier hs-var">old_id</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-1627855517"><span class="hs-identifier hs-var">idvs</span></a><span class="hs-special">,</span><span> </span><a href="VarEnv.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a><span> </span><a href="#local-1627855519"><span class="hs-identifier hs-var">cvs</span></a><span> </span><a href="#local-1627855520"><span class="hs-identifier hs-var">old_id</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkCoVarCo"><span class="hs-identifier hs-var">mkCoVarCo</span></a><span> </span><a href="#local-1627855524"><span class="hs-identifier hs-var">new_id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-568"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="VarEnv.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a><span> </span><a href="#local-1627855517"><span class="hs-identifier hs-var">idvs</span></a><span> </span><a href="#local-1627855520"><span class="hs-identifier hs-var">old_id</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a href="#local-1627855524"><span class="hs-identifier hs-var">new_id</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-1627855519"><span class="hs-identifier hs-var">cvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-569"></a><span>
</span><a name="line-570"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Types and Coercions
*                                                                      *
************************************************************************

For types and coercions we just call the corresponding functions in
Type and Coercion, but we have to repackage the substitution, from a
Subst to a TCvSubst.
-}</span><span>
</span><a name="line-581"></a><span>
</span><a name="line-582"></a><span class="hs-identifier">substTyVarBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">)</span><span>
</span><a name="line-583"></a><a name="substTyVarBndr"><a href="CoreSubst.html#substTyVarBndr"><span class="hs-identifier">substTyVarBndr</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-1627855527"><a href="#local-1627855527"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-1627855528"><a href="#local-1627855528"><span class="hs-identifier">id_env</span></a></a><span> </span><a name="local-1627855529"><a href="#local-1627855529"><span class="hs-identifier">tv_env</span></a></a><span> </span><a name="local-1627855530"><a href="#local-1627855530"><span class="hs-identifier">cv_env</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627855531"><a href="#local-1627855531"><span class="hs-identifier">tv</span></a></a><span>
</span><a name="line-584"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="TyCoRep.html#substTyVarBndr"><span class="hs-identifier hs-var">Type</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">substTyVarBndr</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-var">TCvSubst</span></a><span> </span><a href="#local-1627855527"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-1627855529"><span class="hs-identifier hs-var">tv_env</span></a><span> </span><a href="#local-1627855530"><span class="hs-identifier hs-var">cv_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855531"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-585"></a><span>        </span><span class="hs-special">(</span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-var">TCvSubst</span></a><span> </span><a name="local-1627855532"><a href="#local-1627855532"><span class="hs-identifier">in_scope'</span></a></a><span> </span><a name="local-1627855533"><a href="#local-1627855533"><span class="hs-identifier">tv_env'</span></a></a><span> </span><a name="local-1627855534"><a href="#local-1627855534"><span class="hs-identifier">cv_env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855535"><a href="#local-1627855535"><span class="hs-identifier">tv'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-586"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a href="#local-1627855532"><span class="hs-identifier hs-var">in_scope'</span></a><span> </span><a href="#local-1627855528"><span class="hs-identifier hs-var">id_env</span></a><span> </span><a href="#local-1627855533"><span class="hs-identifier hs-var">tv_env'</span></a><span> </span><a href="#local-1627855534"><span class="hs-identifier hs-var">cv_env'</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627855535"><span class="hs-identifier hs-var">tv'</span></a><span class="hs-special">)</span><span>
</span><a name="line-587"></a><span>
</span><a name="line-588"></a><span class="hs-identifier">cloneTyVarBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">)</span><span>
</span><a name="line-589"></a><a name="cloneTyVarBndr"><a href="CoreSubst.html#cloneTyVarBndr"><span class="hs-identifier">cloneTyVarBndr</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-1627855536"><a href="#local-1627855536"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-1627855537"><a href="#local-1627855537"><span class="hs-identifier">id_env</span></a></a><span> </span><a name="local-1627855538"><a href="#local-1627855538"><span class="hs-identifier">tv_env</span></a></a><span> </span><a name="local-1627855539"><a href="#local-1627855539"><span class="hs-identifier">cv_env</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627855540"><a href="#local-1627855540"><span class="hs-identifier">tv</span></a></a><span> </span><a name="local-1627855541"><a href="#local-1627855541"><span class="hs-identifier">uniq</span></a></a><span>
</span><a name="line-590"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="TyCoRep.html#cloneTyVarBndr"><span class="hs-identifier hs-var">Type</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">cloneTyVarBndr</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-var">TCvSubst</span></a><span> </span><a href="#local-1627855536"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-1627855538"><span class="hs-identifier hs-var">tv_env</span></a><span> </span><a href="#local-1627855539"><span class="hs-identifier hs-var">cv_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855540"><span class="hs-identifier hs-var">tv</span></a><span> </span><a href="#local-1627855541"><span class="hs-identifier hs-var">uniq</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-591"></a><span>        </span><span class="hs-special">(</span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-var">TCvSubst</span></a><span> </span><a name="local-1627855542"><a href="#local-1627855542"><span class="hs-identifier">in_scope'</span></a></a><span> </span><a name="local-1627855543"><a href="#local-1627855543"><span class="hs-identifier">tv_env'</span></a></a><span> </span><a name="local-1627855544"><a href="#local-1627855544"><span class="hs-identifier">cv_env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855545"><a href="#local-1627855545"><span class="hs-identifier">tv'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-592"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a href="#local-1627855542"><span class="hs-identifier hs-var">in_scope'</span></a><span> </span><a href="#local-1627855537"><span class="hs-identifier hs-var">id_env</span></a><span> </span><a href="#local-1627855543"><span class="hs-identifier hs-var">tv_env'</span></a><span> </span><a href="#local-1627855544"><span class="hs-identifier hs-var">cv_env'</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627855545"><span class="hs-identifier hs-var">tv'</span></a><span class="hs-special">)</span><span>
</span><a name="line-593"></a><span>
</span><a name="line-594"></a><span class="hs-identifier">substCoVarBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">)</span><span>
</span><a name="line-595"></a><a name="substCoVarBndr"><a href="CoreSubst.html#substCoVarBndr"><span class="hs-identifier">substCoVarBndr</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-1627855546"><a href="#local-1627855546"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-1627855547"><a href="#local-1627855547"><span class="hs-identifier">id_env</span></a></a><span> </span><a name="local-1627855548"><a href="#local-1627855548"><span class="hs-identifier">tv_env</span></a></a><span> </span><a name="local-1627855549"><a href="#local-1627855549"><span class="hs-identifier">cv_env</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627855550"><a href="#local-1627855550"><span class="hs-identifier">cv</span></a></a><span>
</span><a name="line-596"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="TyCoRep.html#substCoVarBndr"><span class="hs-identifier hs-var">Coercion</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">substCoVarBndr</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-var">TCvSubst</span></a><span> </span><a href="#local-1627855546"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-1627855548"><span class="hs-identifier hs-var">tv_env</span></a><span> </span><a href="#local-1627855549"><span class="hs-identifier hs-var">cv_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855550"><span class="hs-identifier hs-var">cv</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-597"></a><span>        </span><span class="hs-special">(</span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-var">TCvSubst</span></a><span> </span><a name="local-1627855551"><a href="#local-1627855551"><span class="hs-identifier">in_scope'</span></a></a><span> </span><a name="local-1627855552"><a href="#local-1627855552"><span class="hs-identifier">tv_env'</span></a></a><span> </span><a name="local-1627855553"><a href="#local-1627855553"><span class="hs-identifier">cv_env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855554"><a href="#local-1627855554"><span class="hs-identifier">cv'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-598"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a href="#local-1627855551"><span class="hs-identifier hs-var">in_scope'</span></a><span> </span><a href="#local-1627855547"><span class="hs-identifier hs-var">id_env</span></a><span> </span><a href="#local-1627855552"><span class="hs-identifier hs-var">tv_env'</span></a><span> </span><a href="#local-1627855553"><span class="hs-identifier hs-var">cv_env'</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627855554"><span class="hs-identifier hs-var">cv'</span></a><span class="hs-special">)</span><span>
</span><a name="line-599"></a><span>
</span><a name="line-600"></a><span class="hs-comment">-- | See 'Type.substTy'</span><span>
</span><a name="line-601"></a><span class="hs-identifier">substTy</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>
</span><a name="line-602"></a><a name="substTy"><a href="CoreSubst.html#substTy"><span class="hs-identifier">substTy</span></a></a><span> </span><a name="local-1627855555"><a href="#local-1627855555"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-1627855556"><a href="#local-1627855556"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substTyUnchecked"><span class="hs-identifier hs-var">Type</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">substTyUnchecked</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#getTCvSubst"><span class="hs-identifier hs-var">getTCvSubst</span></a><span> </span><a href="#local-1627855555"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855556"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-603"></a><span>
</span><a name="line-604"></a><span class="hs-identifier">getTCvSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-type">TCvSubst</span></a><span>
</span><a name="line-605"></a><a name="getTCvSubst"><a href="CoreSubst.html#getTCvSubst"><span class="hs-identifier">getTCvSubst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-1627855557"><a href="#local-1627855557"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627855558"><a href="#local-1627855558"><span class="hs-identifier">tenv</span></a></a><span> </span><a name="local-1627855559"><a href="#local-1627855559"><span class="hs-identifier">cenv</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-var">TCvSubst</span></a><span> </span><a href="#local-1627855557"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-1627855558"><span class="hs-identifier hs-var">tenv</span></a><span> </span><a href="#local-1627855559"><span class="hs-identifier hs-var">cenv</span></a><span>
</span><a name="line-606"></a><span>
</span><a name="line-607"></a><span class="hs-comment">-- | See 'Coercion.substCo'</span><span>
</span><a name="line-608"></a><span class="hs-identifier">substCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-609"></a><a name="substCo"><a href="CoreSubst.html#substCo"><span class="hs-identifier">substCo</span></a></a><span> </span><a name="local-1627855560"><a href="#local-1627855560"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-1627855561"><a href="#local-1627855561"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substCo"><span class="hs-identifier hs-var">Coercion</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">substCo</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#getTCvSubst"><span class="hs-identifier hs-var">getTCvSubst</span></a><span> </span><a href="#local-1627855560"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855561"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-610"></a><span>
</span><a name="line-611"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\section{IdInfo substitution}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-618"></a><span>
</span><a name="line-619"></a><span class="hs-identifier">substIdType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span>
</span><a name="line-620"></a><a name="substIdType"><a href="CoreSubst.html#substIdType"><span class="hs-identifier">substIdType</span></a></a><span> </span><a name="local-1627855562"><a href="#local-1627855562"><span class="hs-identifier">subst</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627855563"><a href="#local-1627855563"><span class="hs-identifier">tv_env</span></a></a><span> </span><a name="local-1627855564"><a href="#local-1627855564"><span class="hs-identifier">cv_env</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627855565"><a href="#local-1627855565"><span class="hs-identifier">id</span></a></a><span>
</span><a name="line-621"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a href="VarEnv.html#isEmptyVarEnv"><span class="hs-identifier hs-var">isEmptyVarEnv</span></a><span> </span><a href="#local-1627855563"><span class="hs-identifier hs-var">tv_env</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="VarEnv.html#isEmptyVarEnv"><span class="hs-identifier hs-var">isEmptyVarEnv</span></a><span> </span><a href="#local-1627855564"><span class="hs-identifier hs-var">cv_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="VarSet.html#isEmptyVarSet"><span class="hs-identifier hs-var">isEmptyVarSet</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#tyCoVarsOfType"><span class="hs-identifier hs-var">tyCoVarsOfType</span></a><span> </span><a href="#local-1627855566"><span class="hs-identifier hs-var">old_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855565"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-622"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#setIdType"><span class="hs-identifier hs-var">setIdType</span></a><span> </span><a href="#local-1627855565"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><a href="#local-1627855562"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855566"><span class="hs-identifier hs-var">old_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-623"></a><span>                </span><span class="hs-comment">-- The tyCoVarsOfType is cheaper than it looks</span><span>
</span><a name="line-624"></a><span>                </span><span class="hs-comment">-- because we cache the free tyvars of the type</span><span>
</span><a name="line-625"></a><span>                </span><span class="hs-comment">-- in a Note in the id's type itself</span><span>
</span><a name="line-626"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-627"></a><span>    </span><a name="local-1627855566"><a href="#local-1627855566"><span class="hs-identifier">old_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#idType"><span class="hs-identifier hs-var">idType</span></a><span> </span><a href="#local-1627855565"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-628"></a><span>
</span><a name="line-629"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-630"></a><span class="hs-comment">-- | Substitute into some 'IdInfo' with regard to the supplied new 'Id'.</span><span>
</span><a name="line-631"></a><span class="hs-identifier">substIdInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="IdInfo.html#IdInfo"><span class="hs-identifier hs-type">IdInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="IdInfo.html#IdInfo"><span class="hs-identifier hs-type">IdInfo</span></a><span>
</span><a name="line-632"></a><a name="substIdInfo"><a href="CoreSubst.html#substIdInfo"><span class="hs-identifier">substIdInfo</span></a></a><span> </span><a name="local-1627855567"><a href="#local-1627855567"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-1627855568"><a href="#local-1627855568"><span class="hs-identifier">new_id</span></a></a><span> </span><a name="local-1627855569"><a href="#local-1627855569"><span class="hs-identifier">info</span></a></a><span>
</span><a name="line-633"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627855572"><span class="hs-identifier hs-var">nothing_to_do</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-634"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855569"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-special">`</span><a href="IdInfo.html#setRuleInfo"><span class="hs-identifier hs-var">setRuleInfo</span></a><span class="hs-special">`</span><span>      </span><a href="CoreSubst.html#substSpec"><span class="hs-identifier hs-var">substSpec</span></a><span> </span><a href="#local-1627855567"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855568"><span class="hs-identifier hs-var">new_id</span></a><span> </span><a href="#local-1627855570"><span class="hs-identifier hs-var">old_rules</span></a><span>
</span><a name="line-635"></a><span>                               </span><span class="hs-special">`</span><a href="IdInfo.html#setUnfoldingInfo"><span class="hs-identifier hs-var">setUnfoldingInfo</span></a><span class="hs-special">`</span><span> </span><a href="CoreSubst.html#substUnfolding"><span class="hs-identifier hs-var">substUnfolding</span></a><span> </span><a href="#local-1627855567"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855571"><span class="hs-identifier hs-var">old_unf</span></a><span class="hs-special">)</span><span>
</span><a name="line-636"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-637"></a><span>    </span><a name="local-1627855570"><a href="#local-1627855570"><span class="hs-identifier">old_rules</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ruleInfo</span><span> </span><a href="#local-1627855569"><span class="hs-identifier hs-var">info</span></a><span>
</span><a name="line-638"></a><span>    </span><a name="local-1627855571"><a href="#local-1627855571"><span class="hs-identifier">old_unf</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">unfoldingInfo</span><span> </span><a href="#local-1627855569"><span class="hs-identifier hs-var">info</span></a><span>
</span><a name="line-639"></a><span>    </span><a name="local-1627855572"><a href="#local-1627855572"><span class="hs-identifier">nothing_to_do</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="IdInfo.html#isEmptyRuleInfo"><span class="hs-identifier hs-var">isEmptyRuleInfo</span></a><span> </span><a href="#local-1627855570"><span class="hs-identifier hs-var">old_rules</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="CoreSyn.html#isClosedUnfolding"><span class="hs-identifier hs-var">isClosedUnfolding</span></a><span> </span><a href="#local-1627855571"><span class="hs-identifier hs-var">old_unf</span></a><span>
</span><a name="line-640"></a><span>
</span><a name="line-641"></a><span>
</span><a name="line-642"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-643"></a><span class="hs-comment">-- | Substitutes for the 'Id's within an unfolding</span><span>
</span><a name="line-644"></a><span class="hs-identifier">substUnfolding</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">substUnfoldingSC</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a><span>
</span><a name="line-645"></a><span>        </span><span class="hs-comment">-- Seq'ing on the returned Unfolding is enough to cause</span><span>
</span><a name="line-646"></a><span>        </span><span class="hs-comment">-- all the substitutions to happen completely</span><span>
</span><a name="line-647"></a><span>
</span><a name="line-648"></a><a name="substUnfoldingSC"><a href="CoreSubst.html#substUnfoldingSC"><span class="hs-identifier">substUnfoldingSC</span></a></a><span> </span><a name="local-1627855573"><a href="#local-1627855573"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-1627855574"><a href="#local-1627855574"><span class="hs-identifier">unf</span></a></a><span>       </span><span class="hs-comment">-- Short-cut version</span><span>
</span><a name="line-649"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="CoreSubst.html#isEmptySubst"><span class="hs-identifier hs-var">isEmptySubst</span></a><span> </span><a href="#local-1627855573"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855574"><span class="hs-identifier hs-var">unf</span></a><span>
</span><a name="line-650"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substUnfolding"><span class="hs-identifier hs-var">substUnfolding</span></a><span> </span><a href="#local-1627855573"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855574"><span class="hs-identifier hs-var">unf</span></a><span>
</span><a name="line-651"></a><span>
</span><a name="line-652"></a><a name="substUnfolding"><a href="CoreSubst.html#substUnfolding"><span class="hs-identifier">substUnfolding</span></a></a><span> </span><a name="local-1627855575"><a href="#local-1627855575"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-1627855576"><a href="#local-1627855576"><span class="hs-identifier">df</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSyn.html#DFunUnfolding"><span class="hs-identifier hs-var">DFunUnfolding</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">df_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1627855577"><a href="#local-1627855577"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">df_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1627855578"><a href="#local-1627855578"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-653"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855576"><span class="hs-identifier hs-var">df</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">df_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855580"><span class="hs-identifier hs-var">bndrs'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">df_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855581"><span class="hs-identifier hs-var">args'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-654"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-655"></a><span>    </span><span class="hs-special">(</span><a name="local-1627855579"><a href="#local-1627855579"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><a name="local-1627855580"><a href="#local-1627855580"><span class="hs-identifier">bndrs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substBndrs"><span class="hs-identifier hs-var">substBndrs</span></a><span> </span><a href="#local-1627855575"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855577"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-656"></a><span>    </span><a name="local-1627855581"><a href="#local-1627855581"><span class="hs-identifier">args'</span></a></a><span>           </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substExpr"><span class="hs-identifier hs-var">substExpr</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;subst-unf:dfun&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-1627855579"><span class="hs-identifier hs-var">subst'</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855578"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-657"></a><span>
</span><a name="line-658"></a><span class="hs-identifier">substUnfolding</span><span> </span><a name="local-1627855582"><a href="#local-1627855582"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-1627855583"><a href="#local-1627855583"><span class="hs-identifier">unf</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSyn.html#CoreUnfolding"><span class="hs-identifier hs-var">CoreUnfolding</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uf_tmpl</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1627855584"><a href="#local-1627855584"><span class="hs-identifier">tmpl</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">uf_src</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1627855585"><a href="#local-1627855585"><span class="hs-identifier">src</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-659"></a><span>        </span><span class="hs-comment">-- Retain an InlineRule!</span><span>
</span><a name="line-660"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#isStableSource"><span class="hs-identifier hs-var">isStableSource</span></a><span> </span><a href="#local-1627855585"><span class="hs-identifier hs-var">src</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Zap an unstable unfolding, to save substitution work</span><span>
</span><a name="line-661"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#NoUnfolding"><span class="hs-identifier hs-var">NoUnfolding</span></a><span>
</span><a name="line-662"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>                 </span><span class="hs-comment">-- But keep a stable one!</span><span>
</span><a name="line-663"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSeq.html#seqExpr"><span class="hs-identifier hs-var">seqExpr</span></a><span> </span><a href="#local-1627855586"><span class="hs-identifier hs-var">new_tmpl</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span>
</span><a name="line-664"></a><span>    </span><a href="#local-1627855583"><span class="hs-identifier hs-var">unf</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uf_tmpl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855586"><span class="hs-identifier hs-var">new_tmpl</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-665"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-666"></a><span>    </span><a name="local-1627855586"><a href="#local-1627855586"><span class="hs-identifier">new_tmpl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substExpr"><span class="hs-identifier hs-var">substExpr</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;subst-unf&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-1627855582"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855584"><span class="hs-identifier hs-var">tmpl</span></a><span>
</span><a name="line-667"></a><span>
</span><a name="line-668"></a><span class="hs-identifier">substUnfolding</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627855587"><a href="#local-1627855587"><span class="hs-identifier">unf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855587"><span class="hs-identifier hs-var">unf</span></a><span>      </span><span class="hs-comment">-- NoUnfolding, OtherCon</span><span>
</span><a name="line-669"></a><span>
</span><a name="line-670"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-671"></a><span class="hs-identifier">substIdOcc</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span>
</span><a name="line-672"></a><span class="hs-comment">-- These Ids should not be substituted to non-Ids</span><span>
</span><a name="line-673"></a><a name="substIdOcc"><a href="CoreSubst.html#substIdOcc"><span class="hs-identifier">substIdOcc</span></a></a><span> </span><a name="local-1627855588"><a href="#local-1627855588"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-1627855589"><a href="#local-1627855589"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="CoreSubst.html#lookupIdSubst"><span class="hs-identifier hs-var">lookupIdSubst</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;substIdOcc&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-1627855588"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855589"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-674"></a><span>                        </span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-1627855590"><a href="#local-1627855590"><span class="hs-identifier">v'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627855590"><span class="hs-identifier hs-var">v'</span></a><span>
</span><a name="line-675"></a><span>                        </span><a name="local-1627855591"><a href="#local-1627855591"><span class="hs-identifier">other</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;substIdOcc&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1627855589"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1627855591"><span class="hs-identifier hs-var">other</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1627855588"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-676"></a><span>
</span><a name="line-677"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-678"></a><span class="hs-comment">-- | Substitutes for the 'Id's within the 'WorkerInfo' given the new function 'Id'</span><span>
</span><a name="line-679"></a><span class="hs-identifier">substSpec</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="IdInfo.html#RuleInfo"><span class="hs-identifier hs-type">RuleInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="IdInfo.html#RuleInfo"><span class="hs-identifier hs-type">RuleInfo</span></a><span>
</span><a name="line-680"></a><a name="substSpec"><a href="CoreSubst.html#substSpec"><span class="hs-identifier">substSpec</span></a></a><span> </span><a name="local-1627855592"><a href="#local-1627855592"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-1627855593"><a href="#local-1627855593"><span class="hs-identifier">new_id</span></a></a><span> </span><span class="hs-special">(</span><a href="IdInfo.html#RuleInfo"><span class="hs-identifier hs-var">RuleInfo</span></a><span> </span><a name="local-1627855594"><a href="#local-1627855594"><span class="hs-identifier">rules</span></a></a><span> </span><a name="local-1627855595"><a href="#local-1627855595"><span class="hs-identifier">rhs_fvs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-681"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSeq.html#seqRuleInfo"><span class="hs-identifier hs-var">seqRuleInfo</span></a><span> </span><a href="#local-1627855597"><span class="hs-identifier hs-var">new_spec</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="#local-1627855597"><span class="hs-identifier hs-var">new_spec</span></a><span>
</span><a name="line-682"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-683"></a><span>    </span><a name="local-1627855596"><a href="#local-1627855596"><span class="hs-identifier">subst_ru_fn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#const"><span class="hs-identifier hs-var">const</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idName"><span class="hs-identifier hs-var">idName</span></a><span> </span><a href="#local-1627855593"><span class="hs-identifier hs-var">new_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-684"></a><span>    </span><a name="local-1627855597"><a href="#local-1627855597"><span class="hs-identifier">new_spec</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="IdInfo.html#RuleInfo"><span class="hs-identifier hs-var">RuleInfo</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substRule"><span class="hs-identifier hs-var">substRule</span></a><span> </span><a href="#local-1627855592"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855596"><span class="hs-identifier hs-var">subst_ru_fn</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855594"><span class="hs-identifier hs-var">rules</span></a><span class="hs-special">)</span><span>
</span><a name="line-685"></a><span>                        </span><span class="hs-special">(</span><a href="CoreSubst.html#substDVarSet"><span class="hs-identifier hs-var">substDVarSet</span></a><span> </span><a href="#local-1627855592"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855595"><span class="hs-identifier hs-var">rhs_fvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-686"></a><span>
</span><a name="line-687"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-688"></a><span class="hs-identifier">substRulesForImportedIds</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">]</span><span>
</span><a name="line-689"></a><a name="substRulesForImportedIds"><a href="CoreSubst.html#substRulesForImportedIds"><span class="hs-identifier">substRulesForImportedIds</span></a></a><span> </span><a name="local-1627855598"><a href="#local-1627855598"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-1627855599"><a href="#local-1627855599"><span class="hs-identifier">rules</span></a></a><span>
</span><a name="line-690"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substRule"><span class="hs-identifier hs-var">substRule</span></a><span> </span><a href="#local-1627855598"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855600"><span class="hs-identifier hs-var">not_needed</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855599"><span class="hs-identifier hs-var">rules</span></a><span>
</span><a name="line-691"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-692"></a><span>    </span><a name="local-1627855600"><a href="#local-1627855600"><span class="hs-identifier">not_needed</span></a></a><span> </span><a name="local-1627855601"><a href="#local-1627855601"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;substRulesForImportedIds&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1627855601"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-693"></a><span>
</span><a name="line-694"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-695"></a><span class="hs-identifier">substRule</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span>
</span><a name="line-696"></a><span>
</span><a name="line-697"></a><span class="hs-comment">-- The subst_ru_fn argument is applied to substitute the ru_fn field</span><span>
</span><a name="line-698"></a><span class="hs-comment">-- of the rule:</span><span>
</span><a name="line-699"></a><span class="hs-comment">--    - Rules for *imported* Ids never change ru_fn</span><span>
</span><a name="line-700"></a><span class="hs-comment">--    - Rules for *local* Ids are in the IdInfo for that Id,</span><span>
</span><a name="line-701"></a><span class="hs-comment">--      and the ru_fn field is simply replaced by the new name</span><span>
</span><a name="line-702"></a><span class="hs-comment">--      of the Id</span><span>
</span><a name="line-703"></a><a name="substRule"><a href="CoreSubst.html#substRule"><span class="hs-identifier">substRule</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627855602"><a href="#local-1627855602"><span class="hs-identifier">rule</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSyn.html#BuiltinRule"><span class="hs-identifier hs-var">BuiltinRule</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855602"><span class="hs-identifier hs-var">rule</span></a><span>
</span><a name="line-704"></a><span class="hs-identifier">substRule</span><span> </span><a name="local-1627855603"><a href="#local-1627855603"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-1627855604"><a href="#local-1627855604"><span class="hs-identifier">subst_ru_fn</span></a></a><span> </span><a name="local-1627855605"><a href="#local-1627855605"><span class="hs-identifier">rule</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSyn.html#Rule"><span class="hs-identifier hs-var">Rule</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ru_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1627855606"><a href="#local-1627855606"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1627855607"><a href="#local-1627855607"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-705"></a><span>                                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_fn</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1627855608"><a href="#local-1627855608"><span class="hs-identifier">fn_name</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1627855609"><a href="#local-1627855609"><span class="hs-identifier">rhs</span></a></a><span>
</span><a name="line-706"></a><span>                                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_local</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1627855610"><a href="#local-1627855610"><span class="hs-identifier">is_local</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-707"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855605"><span class="hs-identifier hs-var">rule</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ru_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855613"><span class="hs-identifier hs-var">bndrs'</span></a><span>
</span><a name="line-708"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_fn</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-1627855610"><span class="hs-identifier hs-var">is_local</span></a><span>
</span><a name="line-709"></a><span>                        </span><span class="hs-keyword">then</span><span> </span><a href="#local-1627855604"><span class="hs-identifier hs-var">subst_ru_fn</span></a><span> </span><a href="#local-1627855608"><span class="hs-identifier hs-var">fn_name</span></a><span>
</span><a name="line-710"></a><span>                        </span><span class="hs-keyword">else</span><span> </span><a href="#local-1627855608"><span class="hs-identifier hs-var">fn_name</span></a><span>
</span><a name="line-711"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_args</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substExpr"><span class="hs-identifier hs-var">substExpr</span></a><span> </span><a href="#local-1627855611"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-1627855612"><span class="hs-identifier hs-var">subst'</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855607"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-712"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_rhs</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substExpr"><span class="hs-identifier hs-var">substExpr</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;foo&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-1627855612"><span class="hs-identifier hs-var">subst'</span></a><span> </span><a href="#local-1627855609"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-713"></a><span>           </span><span class="hs-comment">-- Do NOT optimise the RHS (previously we did simplOptExpr here)</span><span>
</span><a name="line-714"></a><span>           </span><span class="hs-comment">-- See Note [Substitute lazily]</span><span>
</span><a name="line-715"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-716"></a><span>    </span><a name="local-1627855611"><a href="#local-1627855611"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;subst-rule&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1627855608"><span class="hs-identifier hs-var">fn_name</span></a><span>
</span><a name="line-717"></a><span>    </span><span class="hs-special">(</span><a name="local-1627855612"><a href="#local-1627855612"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855613"><a href="#local-1627855613"><span class="hs-identifier">bndrs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substBndrs"><span class="hs-identifier hs-var">substBndrs</span></a><span> </span><a href="#local-1627855603"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855606"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-718"></a><span>
</span><a name="line-719"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-720"></a><span class="hs-identifier">substVects</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreVect"><span class="hs-identifier hs-type">CoreVect</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreVect"><span class="hs-identifier hs-type">CoreVect</span></a><span class="hs-special">]</span><span>
</span><a name="line-721"></a><a name="substVects"><a href="CoreSubst.html#substVects"><span class="hs-identifier">substVects</span></a></a><span> </span><a name="local-1627855614"><a href="#local-1627855614"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substVect"><span class="hs-identifier hs-var">substVect</span></a><span> </span><a href="#local-1627855614"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">)</span><span>
</span><a name="line-722"></a><span>
</span><a name="line-723"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-724"></a><span class="hs-identifier">substVect</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreVect"><span class="hs-identifier hs-type">CoreVect</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreVect"><span class="hs-identifier hs-type">CoreVect</span></a><span>
</span><a name="line-725"></a><a name="substVect"><a href="CoreSubst.html#substVect"><span class="hs-identifier">substVect</span></a></a><span> </span><a name="local-1627855615"><a href="#local-1627855615"><span class="hs-identifier">subst</span></a></a><span>  </span><span class="hs-special">(</span><a href="CoreSyn.html#Vect"><span class="hs-identifier hs-var">Vect</span></a><span> </span><a name="local-1627855616"><a href="#local-1627855616"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-1627855617"><a href="#local-1627855617"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Vect"><span class="hs-identifier hs-var">Vect</span></a><span> </span><a href="#local-1627855616"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#simpleOptExprWith"><span class="hs-identifier hs-var">simpleOptExprWith</span></a><span> </span><a href="#local-1627855615"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855617"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-726"></a><span class="hs-identifier">substVect</span><span> </span><a name="local-1627855618"><a href="#local-1627855618"><span class="hs-identifier">_subst</span></a></a><span> </span><a name="local-1627855619"><a href="#local-1627855619"><span class="hs-identifier">vd</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSyn.html#NoVect"><span class="hs-identifier hs-var">NoVect</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855619"><span class="hs-identifier hs-var">vd</span></a><span>
</span><a name="line-727"></a><span class="hs-identifier">substVect</span><span> </span><a name="local-1627855620"><a href="#local-1627855620"><span class="hs-identifier">_subst</span></a></a><span> </span><a name="local-1627855621"><a href="#local-1627855621"><span class="hs-identifier">vd</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSyn.html#VectType"><span class="hs-identifier hs-var">VectType</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855621"><span class="hs-identifier hs-var">vd</span></a><span>
</span><a name="line-728"></a><span class="hs-identifier">substVect</span><span> </span><a name="local-1627855622"><a href="#local-1627855622"><span class="hs-identifier">_subst</span></a></a><span> </span><a name="local-1627855623"><a href="#local-1627855623"><span class="hs-identifier">vd</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSyn.html#VectClass"><span class="hs-identifier hs-var">VectClass</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855623"><span class="hs-identifier hs-var">vd</span></a><span>
</span><a name="line-729"></a><span class="hs-identifier">substVect</span><span> </span><a name="local-1627855624"><a href="#local-1627855624"><span class="hs-identifier">_subst</span></a></a><span> </span><a name="local-1627855625"><a href="#local-1627855625"><span class="hs-identifier">vd</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSyn.html#VectInst"><span class="hs-identifier hs-var">VectInst</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855625"><span class="hs-identifier hs-var">vd</span></a><span>
</span><a name="line-730"></a><span>
</span><a name="line-731"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-732"></a><span class="hs-identifier">substDVarSet</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#DVarSet"><span class="hs-identifier hs-type">DVarSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#DVarSet"><span class="hs-identifier hs-type">DVarSet</span></a><span>
</span><a name="line-733"></a><a name="substDVarSet"><a href="CoreSubst.html#substDVarSet"><span class="hs-identifier">substDVarSet</span></a></a><span> </span><a name="local-1627855626"><a href="#local-1627855626"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-1627855627"><a href="#local-1627855627"><span class="hs-identifier">fvs</span></a></a><span>
</span><a name="line-734"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#mkDVarSet"><span class="hs-identifier hs-var">mkDVarSet</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#foldr"><span class="hs-identifier hs-var">foldr</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855628"><span class="hs-identifier hs-var">subst_fv</span></a><span> </span><a href="#local-1627855626"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="VarSet.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="VarSet.html#dVarSetElems"><span class="hs-identifier hs-var">dVarSetElems</span></a><span> </span><a href="#local-1627855627"><span class="hs-identifier hs-var">fvs</span></a><span>
</span><a name="line-735"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-736"></a><span>  </span><a name="local-1627855628"><a href="#local-1627855628"><span class="hs-identifier">subst_fv</span></a></a><span> </span><a name="local-1627855629"><a href="#local-1627855629"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-1627855630"><a href="#local-1627855630"><span class="hs-identifier">fv</span></a></a><span> </span><a name="local-1627855631"><a href="#local-1627855631"><span class="hs-identifier">acc</span></a></a><span>
</span><a name="line-737"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isId"><span class="hs-identifier hs-var">isId</span></a><span> </span><a href="#local-1627855630"><span class="hs-identifier hs-var">fv</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreFVs.html#expr_fvs"><span class="hs-identifier hs-var">expr_fvs</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#lookupIdSubst"><span class="hs-identifier hs-var">lookupIdSubst</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;substDVarSet&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-1627855629"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855630"><span class="hs-identifier hs-var">fv</span></a><span class="hs-special">)</span><span> </span><a href="Var.html#isLocalVar"><span class="hs-identifier hs-var">isLocalVar</span></a><span> </span><a href="VarSet.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24%21"><span class="hs-operator hs-var">$!</span></a><span> </span><a href="#local-1627855631"><span class="hs-identifier hs-var">acc</span></a><span>
</span><a name="line-738"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#tyCoVarsOfTypeAcc"><span class="hs-identifier hs-var">tyCoVarsOfTypeAcc</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#lookupTCvSubst"><span class="hs-identifier hs-var">lookupTCvSubst</span></a><span> </span><a href="#local-1627855629"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855630"><span class="hs-identifier hs-var">fv</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#const"><span class="hs-identifier hs-var">const</span></a><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span> </span><a href="VarSet.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24%21"><span class="hs-operator hs-var">$!</span></a><span> </span><a href="#local-1627855631"><span class="hs-identifier hs-var">acc</span></a><span>
</span><a name="line-739"></a><span>
</span><a name="line-740"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-741"></a><span class="hs-identifier">substTickish</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span>
</span><a name="line-742"></a><a name="substTickish"><a href="CoreSubst.html#substTickish"><span class="hs-identifier">substTickish</span></a></a><span> </span><a name="local-1627855632"><a href="#local-1627855632"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Breakpoint"><span class="hs-identifier hs-var">Breakpoint</span></a><span> </span><a name="local-1627855633"><a href="#local-1627855633"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-1627855634"><a href="#local-1627855634"><span class="hs-identifier">ids</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-743"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Breakpoint"><span class="hs-identifier hs-var">Breakpoint</span></a><span> </span><a href="#local-1627855633"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="#local-1627855635"><span class="hs-identifier hs-var">do_one</span></a><span> </span><a href="#local-1627855634"><span class="hs-identifier hs-var">ids</span></a><span class="hs-special">)</span><span>
</span><a name="line-744"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-745"></a><span>    </span><a name="local-1627855635"><a href="#local-1627855635"><span class="hs-identifier">do_one</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#getIdFromTrivialExpr"><span class="hs-identifier hs-var">getIdFromTrivialExpr</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="CoreSubst.html#lookupIdSubst"><span class="hs-identifier hs-var">lookupIdSubst</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;subst_tickish&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-1627855632"><span class="hs-identifier hs-var">subst</span></a><span>
</span><a name="line-746"></a><span class="hs-identifier">substTickish</span><span> </span><a name="local-1627855636"><a href="#local-1627855636"><span class="hs-identifier">_subst</span></a></a><span> </span><a name="local-1627855637"><a href="#local-1627855637"><span class="hs-identifier">other</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855637"><span class="hs-identifier hs-var">other</span></a><span>
</span><a name="line-747"></a><span>
</span><a name="line-748"></a><span class="hs-comment">{- Note [Substitute lazily]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
The functions that substitute over IdInfo must be pretty lazy, because
they are knot-tied by substRecBndrs.

One case in point was Trac #10627 in which a rule for a function 'f'
referred to 'f' (at a differnet type) on the RHS.  But instead of just
substituting in the rhs of the rule, we were calling simpleOptExpr, which
looked at the idInfo for 'f'; result &lt;&lt;loop&gt;&gt;.

In any case we don't need to optimise the RHS of rules, or unfoldings,
because the simplifier will do that.


Note [substTickish]
~~~~~~~~~~~~~~~~~~~~~~
A Breakpoint contains a list of Ids.  What happens if we ever want to
substitute an expression for one of these Ids?

First, we ensure that we only ever substitute trivial expressions for
these Ids, by marking them as NoOccInfo in the occurrence analyser.
Then, when substituting for the Id, we unwrap any type applications
and abstractions to get back to an Id, with getIdFromTrivialExpr.

Second, we have to ensure that we never try to substitute a literal
for an Id in a breakpoint.  We ensure this by never storing an Id with
an unlifted type in a Breakpoint - see Coverage.mkTickish.
Breakpoints can't handle free variables with unlifted types anyway.
-}</span><span>
</span><a name="line-777"></a><span>
</span><a name="line-778"></a><span class="hs-comment">{-
Note [Worker inlining]
~~~~~~~~~~~~~~~~~~~~~~
A worker can get sustituted away entirely.
        - it might be trivial
        - it might simply be very small
We do not treat an InlWrapper as an 'occurrence' in the occurrence
analyser, so it's possible that the worker is not even in scope any more.

In all all these cases we simply drop the special case, returning to
InlVanilla.  The WARN is just so I can see if it happens a lot.


************************************************************************
*                                                                      *
        The Very Simple Optimiser
*                                                                      *
************************************************************************

Note [Getting the map/coerce RULE to work]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We wish to allow the &quot;map/coerce&quot; RULE to fire:

  {-# RULES &quot;map/coerce&quot; map coerce = coerce #-}

The naive core produced for this is

  forall a b (dict :: Coercible * a b).
    map @a @b (coerce @a @b @dict) = coerce @[a] @[b] @dict'

  where dict' :: Coercible [a] [b]
        dict' = ...

This matches literal uses of `map coerce` in code, but that's not what we
want. We want it to match, say, `map MkAge` (where newtype Age = MkAge Int)
too. Some of this is addressed by compulsorily unfolding coerce on the LHS,
yielding

  forall a b (dict :: Coercible * a b).
    map @a @b (\(x :: a) -&gt; case dict of
      MkCoercible (co :: a ~R# b) -&gt; x |&gt; co) = ...

Getting better. But this isn't exactly what gets produced. This is because
Coercible essentially has ~R# as a superclass, and superclasses get eagerly
extracted during solving. So we get this:

  forall a b (dict :: Coercible * a b).
    case Coercible_SCSel @* @a @b dict of
      _ [Dead] -&gt; map @a @b (\(x :: a) -&gt; case dict of
                               MkCoercible (co :: a ~R# b) -&gt; x |&gt; co) = ...

Unfortunately, this still abstracts over a Coercible dictionary. We really
want it to abstract over the ~R# evidence. So, we have Desugar.unfold_coerce,
which transforms the above to (see also Note [Desugaring coerce as cast] in
Desugar)

  forall a b (co :: a ~R# b).
    let dict = MkCoercible @* @a @b co in
    case Coercible_SCSel @* @a @b dict of
      _ [Dead] -&gt; map @a @b (\(x :: a) -&gt; case dict of
         MkCoercible (co :: a ~R# b) -&gt; x |&gt; co) = let dict = ... in ...

Now, we need simpleOptExpr to fix this up. It does so by taking three
separate actions:
  1. Inline certain non-recursive bindings. The choice whether to inline
     is made in maybe_substitute. Note the rather specific check for
     MkCoercible in there.

  2. Stripping case expressions like the Coercible_SCSel one.
     See the `Case` case of simple_opt_expr's `go` function.

  3. Look for case expressions that unpack something that was
     just packed and inline them. This is also done in simple_opt_expr's
     `go` function.

This is all a fair amount of special-purpose hackery, but it's for
a good cause. And it won't hurt other RULES and such that it comes across.

-}</span><span>
</span><a name="line-857"></a><span>
</span><a name="line-858"></a><span class="hs-identifier">simpleOptExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-859"></a><span class="hs-comment">-- Do simple optimisation on an expression</span><span>
</span><a name="line-860"></a><span class="hs-comment">-- The optimisation is very straightforward: just</span><span>
</span><a name="line-861"></a><span class="hs-comment">-- inline non-recursive bindings that are used only once,</span><span>
</span><a name="line-862"></a><span class="hs-comment">-- or where the RHS is trivial</span><span>
</span><a name="line-863"></a><span class="hs-comment">--</span><span>
</span><a name="line-864"></a><span class="hs-comment">-- We also inline bindings that bind a Eq# box: see</span><span>
</span><a name="line-865"></a><span class="hs-comment">-- See Note [Getting the map/coerce RULE to work].</span><span>
</span><a name="line-866"></a><span class="hs-comment">--</span><span>
</span><a name="line-867"></a><span class="hs-comment">-- The result is NOT guaranteed occurrence-analysed, because</span><span>
</span><a name="line-868"></a><span class="hs-comment">-- in  (let x = y in ....) we substitute for x; so y's occ-info</span><span>
</span><a name="line-869"></a><span class="hs-comment">-- may change radically</span><span>
</span><a name="line-870"></a><span>
</span><a name="line-871"></a><a name="simpleOptExpr"><a href="CoreSubst.html#simpleOptExpr"><span class="hs-identifier">simpleOptExpr</span></a></a><span> </span><a name="local-1627855638"><a href="#local-1627855638"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-872"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;simpleOptExpr&quot; (ppr init_subst $$ ppr expr)</span><span>
</span><a name="line-873"></a><span>    </span><a href="CoreSubst.html#simpleOptExprWith"><span class="hs-identifier hs-var">simpleOptExprWith</span></a><span> </span><a href="#local-1627855639"><span class="hs-identifier hs-var">init_subst</span></a><span> </span><a href="#local-1627855638"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-874"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-875"></a><span>    </span><a name="local-1627855639"><a href="#local-1627855639"><span class="hs-identifier">init_subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#mkEmptySubst"><span class="hs-identifier hs-var">mkEmptySubst</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#mkInScopeSet"><span class="hs-identifier hs-var">mkInScopeSet</span></a><span> </span><span class="hs-special">(</span><a href="CoreFVs.html#exprFreeVars"><span class="hs-identifier hs-var">exprFreeVars</span></a><span> </span><a href="#local-1627855638"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-876"></a><span>        </span><span class="hs-comment">-- It's potentially important to make a proper in-scope set</span><span>
</span><a name="line-877"></a><span>        </span><span class="hs-comment">-- Consider  let x = ..y.. in \y. ...x...</span><span>
</span><a name="line-878"></a><span>        </span><span class="hs-comment">-- Then we should remember to clone y before substituting</span><span>
</span><a name="line-879"></a><span>        </span><span class="hs-comment">-- for x.  It's very unlikely to occur, because we probably</span><span>
</span><a name="line-880"></a><span>        </span><span class="hs-comment">-- won't *be* substituting for x if it occurs inside a</span><span>
</span><a name="line-881"></a><span>        </span><span class="hs-comment">-- lambda.</span><span>
</span><a name="line-882"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-883"></a><span>        </span><span class="hs-comment">-- It's a bit painful to call exprFreeVars, because it makes</span><span>
</span><a name="line-884"></a><span>        </span><span class="hs-comment">-- three passes instead of two (occ-anal, and go)</span><span>
</span><a name="line-885"></a><span>
</span><a name="line-886"></a><span class="hs-identifier">simpleOptExprWith</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span>
</span><a name="line-887"></a><a name="simpleOptExprWith"><a href="CoreSubst.html#simpleOptExprWith"><span class="hs-identifier">simpleOptExprWith</span></a></a><span> </span><a name="local-1627855640"><a href="#local-1627855640"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-1627855641"><a href="#local-1627855641"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#simple_opt_expr"><span class="hs-identifier hs-var">simple_opt_expr</span></a><span> </span><a href="#local-1627855640"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#occurAnalyseExpr"><span class="hs-identifier hs-var">occurAnalyseExpr</span></a><span> </span><a href="#local-1627855641"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-888"></a><span>
</span><a name="line-889"></a><span class="hs-comment">----------------------</span><span>
</span><a name="line-890"></a><span class="hs-identifier">simpleOptPgm</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span>
</span><a name="line-891"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreProgram"><span class="hs-identifier hs-type">CoreProgram</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreVect"><span class="hs-identifier hs-type">CoreVect</span></a><span class="hs-special">]</span><span>
</span><a name="line-892"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#CoreProgram"><span class="hs-identifier hs-type">CoreProgram</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreVect"><span class="hs-identifier hs-type">CoreVect</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-893"></a><a name="simpleOptPgm"><a href="CoreSubst.html#simpleOptPgm"><span class="hs-identifier">simpleOptPgm</span></a></a><span> </span><a name="local-1627855642"><a href="#local-1627855642"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-1627855643"><a href="#local-1627855643"><span class="hs-identifier">this_mod</span></a></a><span> </span><a name="local-1627855644"><a href="#local-1627855644"><span class="hs-identifier">binds</span></a></a><span> </span><a name="local-1627855645"><a href="#local-1627855645"><span class="hs-identifier">rules</span></a></a><span> </span><a name="local-1627855646"><a href="#local-1627855646"><span class="hs-identifier">vects</span></a></a><span>
</span><a name="line-894"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="ErrUtils.html#dumpIfSet_dyn"><span class="hs-identifier hs-var">dumpIfSet_dyn</span></a><span> </span><a href="#local-1627855642"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="DynFlags.html#Opt_D_dump_occur_anal"><span class="hs-identifier hs-var">Opt_D_dump_occur_anal</span></a><span> </span><span class="hs-string">&quot;Occurrence analysis&quot;</span><span>
</span><a name="line-895"></a><span>                       </span><span class="hs-special">(</span><a href="PprCore.html#pprCoreBindings"><span class="hs-identifier hs-var">pprCoreBindings</span></a><span> </span><a href="#local-1627855647"><span class="hs-identifier hs-var">occ_anald_binds</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="PprCore.html#pprRules"><span class="hs-identifier hs-var">pprRules</span></a><span> </span><a href="#local-1627855645"><span class="hs-identifier hs-var">rules</span></a><span> </span><span class="hs-special">)</span><span class="hs-special">;</span><span>
</span><a name="line-896"></a><span>
</span><a name="line-897"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#reverse"><span class="hs-identifier hs-var">reverse</span></a><span> </span><a href="#local-1627855649"><span class="hs-identifier hs-var">binds'</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#substRulesForImportedIds"><span class="hs-identifier hs-var">substRulesForImportedIds</span></a><span> </span><a href="#local-1627855648"><span class="hs-identifier hs-var">subst'</span></a><span> </span><a href="#local-1627855645"><span class="hs-identifier hs-var">rules</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#substVects"><span class="hs-identifier hs-var">substVects</span></a><span> </span><a href="#local-1627855648"><span class="hs-identifier hs-var">subst'</span></a><span> </span><a href="#local-1627855646"><span class="hs-identifier hs-var">vects</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-898"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-899"></a><span>    </span><a name="local-1627855647"><a href="#local-1627855647"><span class="hs-identifier">occ_anald_binds</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#occurAnalysePgm"><span class="hs-identifier hs-var">occurAnalysePgm</span></a><span> </span><a href="#local-1627855643"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span> </span><span class="hs-comment">{- No rules active -}</span><span>
</span><a name="line-900"></a><span>                                       </span><a href="#local-1627855645"><span class="hs-identifier hs-var">rules</span></a><span> </span><a href="#local-1627855646"><span class="hs-identifier hs-var">vects</span></a><span> </span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span> </span><a href="#local-1627855644"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-901"></a><span>    </span><span class="hs-special">(</span><a name="local-1627855648"><a href="#local-1627855648"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855649"><a href="#local-1627855649"><span class="hs-identifier">binds'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#foldl"><span class="hs-identifier hs-var">foldl</span></a><span> </span><a href="#local-1627855650"><span class="hs-identifier hs-var">do_one</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#emptySubst"><span class="hs-identifier hs-var">emptySubst</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="#local-1627855647"><span class="hs-identifier hs-var">occ_anald_binds</span></a><span>
</span><a name="line-902"></a><span>
</span><a name="line-903"></a><span>    </span><a name="local-1627855650"><a href="#local-1627855650"><span class="hs-identifier">do_one</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1627855651"><a href="#local-1627855651"><span class="hs-identifier">subst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855652"><a href="#local-1627855652"><span class="hs-identifier">binds'</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627855653"><a href="#local-1627855653"><span class="hs-identifier">bind</span></a></a><span>
</span><a name="line-904"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="CoreSubst.html#simple_opt_bind"><span class="hs-identifier hs-var">simple_opt_bind</span></a><span> </span><a href="#local-1627855651"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855653"><span class="hs-identifier hs-var">bind</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-905"></a><span>          </span><span class="hs-special">(</span><a name="local-1627855654"><a href="#local-1627855654"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-1627855654"><span class="hs-identifier hs-var">subst'</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627855652"><span class="hs-identifier hs-var">binds'</span></a><span class="hs-special">)</span><span>
</span><a name="line-906"></a><span>          </span><span class="hs-special">(</span><a name="local-1627855655"><a href="#local-1627855655"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1627855656"><a href="#local-1627855656"><span class="hs-identifier">bind'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-1627855655"><span class="hs-identifier hs-var">subst'</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627855656"><span class="hs-identifier hs-var">bind'</span></a><span class="hs-glyph">:</span><a href="#local-1627855652"><span class="hs-identifier hs-var">binds'</span></a><span class="hs-special">)</span><span>
</span><a name="line-907"></a><span>
</span><a name="line-908"></a><span class="hs-comment">----------------------</span><span>
</span><a name="line-909"></a><span class="hs-keyword">type</span><span> </span><a name="InVar"><a href="CoreSubst.html#InVar"><span class="hs-identifier">InVar</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span>
</span><a name="line-910"></a><span class="hs-keyword">type</span><span> </span><a name="OutVar"><a href="CoreSubst.html#OutVar"><span class="hs-identifier">OutVar</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span>
</span><a name="line-911"></a><span class="hs-keyword">type</span><span> </span><a name="InId"><a href="CoreSubst.html#InId"><span class="hs-identifier">InId</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span>
</span><a name="line-912"></a><span class="hs-keyword">type</span><span> </span><a name="OutId"><a href="CoreSubst.html#OutId"><span class="hs-identifier">OutId</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span>
</span><a name="line-913"></a><span class="hs-keyword">type</span><span> </span><a name="InExpr"><a href="CoreSubst.html#InExpr"><span class="hs-identifier">InExpr</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-914"></a><span class="hs-keyword">type</span><span> </span><a name="OutExpr"><a href="CoreSubst.html#OutExpr"><span class="hs-identifier">OutExpr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-915"></a><span>
</span><a name="line-916"></a><span class="hs-comment">-- In these functions the substitution maps InVar -&gt; OutExpr</span><span>
</span><a name="line-917"></a><span>
</span><a name="line-918"></a><span class="hs-comment">----------------------</span><span>
</span><a name="line-919"></a><span class="hs-identifier">simple_opt_expr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span>
</span><a name="line-920"></a><a name="simple_opt_expr"><a href="CoreSubst.html#simple_opt_expr"><span class="hs-identifier">simple_opt_expr</span></a></a><span> </span><a name="local-1627855657"><a href="#local-1627855657"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-1627855658"><a href="#local-1627855658"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-921"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855660"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627855658"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-922"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-923"></a><span>    </span><a name="local-1627855659"><a href="#local-1627855659"><span class="hs-identifier">in_scope_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substInScope"><span class="hs-identifier hs-var">substInScope</span></a><span> </span><a href="#local-1627855657"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#simpleUnfoldingFun"><span class="hs-identifier hs-var">simpleUnfoldingFun</span></a><span class="hs-special">)</span><span>
</span><a name="line-924"></a><span>
</span><a name="line-925"></a><span>    </span><a name="local-1627855660"><a href="#local-1627855660"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-1627855663"><a href="#local-1627855663"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#lookupIdSubst"><span class="hs-identifier hs-var">lookupIdSubst</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;simpleOptExpr&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-1627855657"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855663"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-926"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-1627855664"><a href="#local-1627855664"><span class="hs-identifier">e1</span></a></a><span> </span><a name="local-1627855665"><a href="#local-1627855665"><span class="hs-identifier">e2</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#simple_app"><span class="hs-identifier hs-var">simple_app</span></a><span> </span><a href="#local-1627855657"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855664"><span class="hs-identifier hs-var">e1</span></a><span> </span><span class="hs-special">[</span><a href="#local-1627855660"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627855665"><span class="hs-identifier hs-var">e2</span></a><span class="hs-special">]</span><span>
</span><a name="line-927"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a name="local-1627855666"><a href="#local-1627855666"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span>     </span><span class="hs-special">(</span><a href="CoreSubst.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><a href="#local-1627855657"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855666"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-928"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a name="local-1627855667"><a href="#local-1627855667"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><span class="hs-special">(</span><a href="OptCoercion.html#optCoercion"><span class="hs-identifier hs-var">optCoercion</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#getTCvSubst"><span class="hs-identifier hs-var">getTCvSubst</span></a><span> </span><a href="#local-1627855657"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855667"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-929"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><a name="local-1627855668"><a href="#local-1627855668"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><a href="#local-1627855668"><span class="hs-identifier hs-var">lit</span></a><span>
</span><a name="line-930"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-1627855669"><a href="#local-1627855669"><span class="hs-identifier">tickish</span></a></a><span> </span><a name="local-1627855670"><a href="#local-1627855670"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substTickish"><span class="hs-identifier hs-var">substTickish</span></a><span> </span><a href="#local-1627855657"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855669"><span class="hs-identifier hs-var">tickish</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-1627855660"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627855670"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-931"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-1627855671"><a href="#local-1627855671"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-1627855672"><a href="#local-1627855672"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">|</span><span> </span><a href="Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a><span> </span><a href="#local-1627855673"><span class="hs-identifier hs-var">co'</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855660"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627855671"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-932"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855660"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627855671"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855673"><span class="hs-identifier hs-var">co'</span></a><span>
</span><a name="line-933"></a><span>                        </span><span class="hs-keyword">where</span><span>
</span><a name="line-934"></a><span>                          </span><a name="local-1627855673"><a href="#local-1627855673"><span class="hs-identifier">co'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#optCoercion"><span class="hs-identifier hs-var">optCoercion</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#getTCvSubst"><span class="hs-identifier hs-var">getTCvSubst</span></a><span> </span><a href="#local-1627855657"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855672"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-935"></a><span>
</span><a name="line-936"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><a name="local-1627855674"><a href="#local-1627855674"><span class="hs-identifier">bind</span></a></a><span> </span><a name="local-1627855675"><a href="#local-1627855675"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="CoreSubst.html#simple_opt_bind"><span class="hs-identifier hs-var">simple_opt_bind</span></a><span> </span><a href="#local-1627855657"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855674"><span class="hs-identifier hs-var">bind</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-937"></a><span>                           </span><span class="hs-special">(</span><a name="local-1627855676"><a href="#local-1627855676"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#simple_opt_expr"><span class="hs-identifier hs-var">simple_opt_expr</span></a><span> </span><a href="#local-1627855676"><span class="hs-identifier hs-var">subst'</span></a><span> </span><a href="#local-1627855675"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-938"></a><span>                           </span><span class="hs-special">(</span><a name="local-1627855677"><a href="#local-1627855677"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1627855678"><a href="#local-1627855678"><span class="hs-identifier">bind</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><a href="#local-1627855678"><span class="hs-identifier hs-var">bind</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#simple_opt_expr"><span class="hs-identifier hs-var">simple_opt_expr</span></a><span> </span><a href="#local-1627855677"><span class="hs-identifier hs-var">subst'</span></a><span> </span><a href="#local-1627855675"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-939"></a><span>
</span><a name="line-940"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1627855679"><a href="#local-1627855679"><span class="hs-identifier">lam</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855662"><span class="hs-identifier hs-var">go_lam</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-1627855657"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855679"><span class="hs-identifier hs-var">lam</span></a><span>
</span><a name="line-941"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Case"><span class="hs-identifier hs-var">Case</span></a><span> </span><a name="local-1627855680"><a href="#local-1627855680"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-1627855681"><a href="#local-1627855681"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-1627855682"><a href="#local-1627855682"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span>
</span><a name="line-942"></a><span>       </span><span class="hs-comment">-- See Note [Getting the map/coerce RULE to work]</span><span>
</span><a name="line-943"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="Id.html#isDeadBinder"><span class="hs-identifier hs-var">isDeadBinder</span></a><span> </span><a href="#local-1627855681"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-944"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1627855687"><a href="#local-1627855687"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855688"><a href="#local-1627855688"><span class="hs-identifier">_tys</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855689"><a href="#local-1627855689"><span class="hs-identifier">es</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreSubst.html#exprIsConApp_maybe"><span class="hs-identifier hs-var">exprIsConApp_maybe</span></a><span> </span><a href="#local-1627855659"><span class="hs-identifier hs-var">in_scope_env</span></a><span> </span><a href="#local-1627855684"><span class="hs-identifier hs-var">e'</span></a><span>
</span><a name="line-945"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1627855690"><a href="#local-1627855690"><span class="hs-identifier">altcon</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855691"><a href="#local-1627855691"><span class="hs-identifier">bs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855692"><a href="#local-1627855692"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreUtils.html#findAlt"><span class="hs-identifier hs-var">findAlt</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#DataAlt"><span class="hs-identifier hs-var">DataAlt</span></a><span> </span><a href="#local-1627855687"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">as</span><span>
</span><a name="line-946"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1627855690"><span class="hs-identifier hs-var">altcon</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-947"></a><span>          </span><a href="CoreSyn.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627855660"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627855692"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-948"></a><span>          </span><span class="hs-identifier">_</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#mkLets"><span class="hs-identifier hs-var">mkLets</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#catMaybes"><span class="hs-identifier hs-var">catMaybes</span></a><span> </span><a href="#local-1627855694"><span class="hs-identifier hs-var">mb_binds</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="CoreSubst.html#simple_opt_expr"><span class="hs-identifier hs-var">simple_opt_expr</span></a><span> </span><a href="#local-1627855693"><span class="hs-identifier hs-var">subst'</span></a><span> </span><a href="#local-1627855692"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-949"></a><span>            </span><span class="hs-keyword">where</span><span> </span><span class="hs-special">(</span><a name="local-1627855693"><a href="#local-1627855693"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855694"><a href="#local-1627855694"><span class="hs-identifier">mb_binds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapAccumL"><span class="hs-identifier hs-var">mapAccumL</span></a><span> </span><a href="CoreSubst.html#simple_opt_out_bind"><span class="hs-identifier hs-var">simple_opt_out_bind</span></a><span> </span><a href="#local-1627855657"><span class="hs-identifier hs-var">subst</span></a><span>
</span><a name="line-950"></a><span>                                                 </span><span class="hs-special">(</span><a href="Util.html#zipEqual"><span class="hs-identifier hs-var">zipEqual</span></a><span> </span><span class="hs-string">&quot;simpleOptExpr&quot;</span><span> </span><a href="#local-1627855691"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="#local-1627855689"><span class="hs-identifier hs-var">es</span></a><span class="hs-special">)</span><span>
</span><a name="line-951"></a><span>
</span><a name="line-952"></a><span>         </span><span class="hs-comment">-- Note [Getting the map/coerce RULE to work]</span><span>
</span><a name="line-953"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="Id.html#isDeadBinder"><span class="hs-identifier hs-var">isDeadBinder</span></a><span> </span><a href="#local-1627855681"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-954"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CoreSyn.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-1627855695"><a href="#local-1627855695"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">as</span><span>
</span><a name="line-955"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#isCoercionType"><span class="hs-identifier hs-var">isCoercionType</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">varType</span><span> </span><a href="#local-1627855681"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-956"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-1627855696"><a href="#local-1627855696"><span class="hs-identifier">fun</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855697"><a href="#local-1627855697"><span class="hs-identifier">_args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreSyn.html#collectArgs"><span class="hs-identifier hs-var">collectArgs</span></a><span> </span><a href="#local-1627855680"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-957"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="#local-1627855696"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-special">`</span><a href="Unique.html#hasKey"><span class="hs-identifier hs-var">hasKey</span></a><span class="hs-special">`</span><span> </span><a href="PrelNames.html#coercibleSCSelIdKey"><span class="hs-identifier hs-var">coercibleSCSelIdKey</span></a><span>
</span><a name="line-958"></a><span>         </span><span class="hs-comment">-- without this last check, we get #11230</span><span>
</span><a name="line-959"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855660"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627855695"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-960"></a><span>
</span><a name="line-961"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-962"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Case"><span class="hs-identifier hs-var">Case</span></a><span> </span><a href="#local-1627855684"><span class="hs-identifier hs-var">e'</span></a><span> </span><a href="#local-1627855686"><span class="hs-identifier hs-var">b'</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><a href="#local-1627855657"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855682"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-963"></a><span>                   </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855661"><span class="hs-identifier hs-var">go_alt</span></a><span> </span><a href="#local-1627855685"><span class="hs-identifier hs-var">subst'</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span>
</span><a name="line-964"></a><span>        </span><span class="hs-keyword">where</span><span>
</span><a name="line-965"></a><span>          </span><a name="local-1627855684"><a href="#local-1627855684"><span class="hs-identifier">e'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855660"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627855680"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-966"></a><span>          </span><span class="hs-special">(</span><a name="local-1627855685"><a href="#local-1627855685"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855686"><a href="#local-1627855686"><span class="hs-identifier">b'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#subst_opt_bndr"><span class="hs-identifier hs-var">subst_opt_bndr</span></a><span> </span><a href="#local-1627855657"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855681"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-967"></a><span>
</span><a name="line-968"></a><span>    </span><span class="hs-comment">----------------------</span><span>
</span><a name="line-969"></a><span>    </span><a name="local-1627855661"><a href="#local-1627855661"><span class="hs-identifier">go_alt</span></a></a><span> </span><a name="local-1627855698"><a href="#local-1627855698"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1627855699"><a href="#local-1627855699"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855700"><a href="#local-1627855700"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855701"><a href="#local-1627855701"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-970"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-1627855699"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627855703"><span class="hs-identifier hs-var">bndrs'</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#simple_opt_expr"><span class="hs-identifier hs-var">simple_opt_expr</span></a><span> </span><a href="#local-1627855702"><span class="hs-identifier hs-var">subst'</span></a><span> </span><a href="#local-1627855701"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-971"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-972"></a><span>        </span><span class="hs-special">(</span><a name="local-1627855702"><a href="#local-1627855702"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855703"><a href="#local-1627855703"><span class="hs-identifier">bndrs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#subst_opt_bndrs"><span class="hs-identifier hs-var">subst_opt_bndrs</span></a><span> </span><a href="#local-1627855698"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855700"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-973"></a><span>
</span><a name="line-974"></a><span>    </span><span class="hs-comment">----------------------</span><span>
</span><a name="line-975"></a><span>    </span><span class="hs-comment">-- go_lam tries eta reduction</span><span>
</span><a name="line-976"></a><span>    </span><a name="local-1627855662"><a href="#local-1627855662"><span class="hs-identifier">go_lam</span></a></a><span> </span><a name="local-1627855704"><a href="#local-1627855704"><span class="hs-identifier">bs'</span></a></a><span> </span><a name="local-1627855705"><a href="#local-1627855705"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a name="local-1627855706"><a href="#local-1627855706"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-1627855707"><a href="#local-1627855707"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-977"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855662"><span class="hs-identifier hs-var">go_lam</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855709"><span class="hs-identifier hs-var">b'</span></a><span class="hs-glyph">:</span><a href="#local-1627855704"><span class="hs-identifier hs-var">bs'</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855708"><span class="hs-identifier hs-var">subst'</span></a><span> </span><a href="#local-1627855707"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-978"></a><span>       </span><span class="hs-keyword">where</span><span>
</span><a name="line-979"></a><span>         </span><span class="hs-special">(</span><a name="local-1627855708"><a href="#local-1627855708"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855709"><a href="#local-1627855709"><span class="hs-identifier">b'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#subst_opt_bndr"><span class="hs-identifier hs-var">subst_opt_bndr</span></a><span> </span><a href="#local-1627855705"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855706"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-980"></a><span>    </span><span class="hs-identifier">go_lam</span><span> </span><a name="local-1627855710"><a href="#local-1627855710"><span class="hs-identifier">bs'</span></a></a><span> </span><a name="local-1627855711"><a href="#local-1627855711"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-1627855712"><a href="#local-1627855712"><span class="hs-identifier">e</span></a></a><span>
</span><a name="line-981"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1627855715"><a href="#local-1627855715"><span class="hs-identifier">etad_e</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreUtils.html#tryEtaReduce"><span class="hs-identifier hs-var">tryEtaReduce</span></a><span> </span><a href="#local-1627855713"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="#local-1627855714"><span class="hs-identifier hs-var">e'</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855715"><span class="hs-identifier hs-var">etad_e</span></a><span>
</span><a name="line-982"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>                         </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#mkLams"><span class="hs-identifier hs-var">mkLams</span></a><span> </span><a href="#local-1627855713"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="#local-1627855714"><span class="hs-identifier hs-var">e'</span></a><span>
</span><a name="line-983"></a><span>       </span><span class="hs-keyword">where</span><span>
</span><a name="line-984"></a><span>         </span><a name="local-1627855713"><a href="#local-1627855713"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#reverse"><span class="hs-identifier hs-var">reverse</span></a><span> </span><a href="#local-1627855710"><span class="hs-identifier hs-var">bs'</span></a><span>
</span><a name="line-985"></a><span>         </span><a name="local-1627855714"><a href="#local-1627855714"><span class="hs-identifier">e'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#simple_opt_expr"><span class="hs-identifier hs-var">simple_opt_expr</span></a><span> </span><a href="#local-1627855711"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855712"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-986"></a><span>
</span><a name="line-987"></a><span class="hs-comment">----------------------</span><span>
</span><a name="line-988"></a><span class="hs-comment">-- simple_app collects arguments for beta reduction</span><span>
</span><a name="line-989"></a><span class="hs-identifier">simple_app</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSubst.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-990"></a><a name="simple_app"><a href="CoreSubst.html#simple_app"><span class="hs-identifier">simple_app</span></a></a><span> </span><a name="local-1627855716"><a href="#local-1627855716"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-1627855717"><a href="#local-1627855717"><span class="hs-identifier">e1</span></a></a><span> </span><a name="local-1627855718"><a href="#local-1627855718"><span class="hs-identifier">e2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">as</span><span>
</span><a name="line-991"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#simple_app"><span class="hs-identifier hs-var">simple_app</span></a><span> </span><a href="#local-1627855716"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855717"><span class="hs-identifier hs-var">e1</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#simple_opt_expr"><span class="hs-identifier hs-var">simple_opt_expr</span></a><span> </span><a href="#local-1627855716"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855718"><span class="hs-identifier hs-var">e2</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span>
</span><a name="line-992"></a><span class="hs-identifier">simple_app</span><span> </span><a name="local-1627855720"><a href="#local-1627855720"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a name="local-1627855721"><a href="#local-1627855721"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-1627855722"><a href="#local-1627855722"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-1627855723"><a href="#local-1627855723"><span class="hs-identifier">a</span></a></a><span class="hs-glyph">:</span><span class="hs-keyword">as</span><span class="hs-special">)</span><span>
</span><a name="line-993"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="CoreSubst.html#maybe_substitute"><span class="hs-identifier hs-var">maybe_substitute</span></a><span> </span><a href="#local-1627855720"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855721"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-1627855723"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-994"></a><span>      </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1627855728"><a href="#local-1627855728"><span class="hs-identifier">ext_subst</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#simple_app"><span class="hs-identifier hs-var">simple_app</span></a><span> </span><a href="#local-1627855728"><span class="hs-identifier hs-var">ext_subst</span></a><span> </span><a href="#local-1627855722"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-keyword">as</span><span>
</span><a name="line-995"></a><span>      </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a href="#local-1627855727"><span class="hs-identifier hs-var">b2</span></a><span> </span><a href="#local-1627855723"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#simple_app"><span class="hs-identifier hs-var">simple_app</span></a><span> </span><a href="#local-1627855725"><span class="hs-identifier hs-var">subst'</span></a><span> </span><a href="#local-1627855722"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span>
</span><a name="line-996"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-997"></a><span>    </span><span class="hs-special">(</span><a name="local-1627855725"><a href="#local-1627855725"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855726"><a href="#local-1627855726"><span class="hs-identifier">b'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#subst_opt_bndr"><span class="hs-identifier hs-var">subst_opt_bndr</span></a><span> </span><a href="#local-1627855720"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855721"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-998"></a><span>    </span><a name="local-1627855727"><a href="#local-1627855727"><span class="hs-identifier">b2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#add_info"><span class="hs-identifier hs-var">add_info</span></a><span> </span><a href="#local-1627855725"><span class="hs-identifier hs-var">subst'</span></a><span> </span><a href="#local-1627855721"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-1627855726"><span class="hs-identifier hs-var">b'</span></a><span>
</span><a name="line-999"></a><span class="hs-identifier">simple_app</span><span> </span><a name="local-1627855729"><a href="#local-1627855729"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-1627855730"><a href="#local-1627855730"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">as</span><span>
</span><a name="line-1000"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#isCompulsoryUnfolding"><span class="hs-identifier hs-var">isCompulsoryUnfolding</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idUnfolding"><span class="hs-identifier hs-var">idUnfolding</span></a><span> </span><a href="#local-1627855730"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-1001"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="BasicTypes.html#isAlwaysActive"><span class="hs-identifier hs-var">isAlwaysActive</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idInlineActivation"><span class="hs-identifier hs-var">idInlineActivation</span></a><span> </span><a href="#local-1627855730"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-1002"></a><span>  </span><span class="hs-comment">-- See Note [Unfold compulsory unfoldings in LHSs]</span><span>
</span><a name="line-1003"></a><span>  </span><span class="hs-glyph">=</span><span>  </span><a href="CoreSubst.html#simple_app"><span class="hs-identifier hs-var">simple_app</span></a><span> </span><a href="#local-1627855729"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#unfoldingTemplate"><span class="hs-identifier hs-var">unfoldingTemplate</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idUnfolding"><span class="hs-identifier hs-var">idUnfolding</span></a><span> </span><a href="#local-1627855730"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">as</span><span>
</span><a name="line-1004"></a><span class="hs-identifier">simple_app</span><span> </span><a name="local-1627855732"><a href="#local-1627855732"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-1627855733"><a href="#local-1627855733"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-1627855734"><a href="#local-1627855734"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">as</span><span>
</span><a name="line-1005"></a><span>  </span><span class="hs-comment">-- Okay to do &quot;(Tick t e) x ==&gt; Tick t (e x)&quot;?</span><span>
</span><a name="line-1006"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627855733"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-special">`</span><a href="CoreSyn.html#tickishScopesLike"><span class="hs-identifier hs-var">tickishScopesLike</span></a><span class="hs-special">`</span><span> </span><a href="CoreSyn.html#SoftScope"><span class="hs-identifier hs-var">SoftScope</span></a><span>
</span><a name="line-1007"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a><span> </span><a href="#local-1627855733"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="CoreSubst.html#simple_app"><span class="hs-identifier hs-var">simple_app</span></a><span> </span><a href="#local-1627855732"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855734"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-keyword">as</span><span>
</span><a name="line-1008"></a><span class="hs-identifier">simple_app</span><span> </span><a name="local-1627855736"><a href="#local-1627855736"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-1627855737"><a href="#local-1627855737"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-keyword">as</span><span>
</span><a name="line-1009"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#foldl"><span class="hs-identifier hs-var">foldl</span></a><span> </span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#simple_opt_expr"><span class="hs-identifier hs-var">simple_opt_expr</span></a><span> </span><a href="#local-1627855736"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855737"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">as</span><span>
</span><a name="line-1010"></a><span>
</span><a name="line-1011"></a><span class="hs-comment">----------------------</span><span>
</span><a name="line-1012"></a><span class="hs-identifier">simple_opt_bind</span><span class="hs-special">,</span><span class="hs-identifier">simple_opt_bind'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="CoreSyn.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a><span class="hs-special">)</span><span>
</span><a name="line-1013"></a><a name="simple_opt_bind"><a href="CoreSubst.html#simple_opt_bind"><span class="hs-identifier">simple_opt_bind</span></a></a><span> </span><a name="local-1627855739"><a href="#local-1627855739"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-1627855740"><a href="#local-1627855740"><span class="hs-identifier">b</span></a></a><span>               </span><span class="hs-comment">-- Can add trace stuff here</span><span>
</span><a name="line-1014"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#simple_opt_bind%27"><span class="hs-identifier hs-var">simple_opt_bind'</span></a><span> </span><a href="#local-1627855739"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-1627855740"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-1015"></a><span>
</span><a name="line-1016"></a><a name="simple_opt_bind%27"><a href="CoreSubst.html#simple_opt_bind%27"><span class="hs-identifier">simple_opt_bind'</span></a></a><span> </span><a name="local-1627855741"><a href="#local-1627855741"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><a name="local-1627855742"><a href="#local-1627855742"><span class="hs-identifier">prs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1017"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-1627855746"><span class="hs-identifier hs-var">subst''</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627855743"><span class="hs-identifier hs-var">res_bind</span></a><span class="hs-special">)</span><span>
</span><a name="line-1018"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1019"></a><span>    </span><a name="local-1627855743"><a href="#local-1627855743"><span class="hs-identifier">res_bind</span></a></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#reverse"><span class="hs-identifier hs-var">reverse</span></a><span> </span><a href="#local-1627855747"><span class="hs-identifier hs-var">rev_prs'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1020"></a><span>    </span><span class="hs-special">(</span><a name="local-1627855744"><a href="#local-1627855744"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855745"><a href="#local-1627855745"><span class="hs-identifier">bndrs'</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#subst_opt_bndrs"><span class="hs-identifier hs-var">subst_opt_bndrs</span></a><span> </span><a href="#local-1627855741"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a><span> </span><a href="#local-1627855742"><span class="hs-identifier hs-var">prs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1021"></a><span>    </span><span class="hs-special">(</span><a name="local-1627855746"><a href="#local-1627855746"><span class="hs-identifier">subst''</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855747"><a href="#local-1627855747"><span class="hs-identifier">rev_prs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#foldl"><span class="hs-identifier hs-var">foldl</span></a><span> </span><a href="#local-1627855748"><span class="hs-identifier hs-var">do_pr</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855744"><span class="hs-identifier hs-var">subst'</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-1627855742"><span class="hs-identifier hs-var">prs</span></a><span> </span><span class="hs-special">`</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zip"><span class="hs-identifier hs-var">zip</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627855745"><span class="hs-identifier hs-var">bndrs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1022"></a><span>    </span><a name="local-1627855748"><a href="#local-1627855748"><span class="hs-identifier">do_pr</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1627855749"><a href="#local-1627855749"><span class="hs-identifier">subst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855750"><a href="#local-1627855750"><span class="hs-identifier">prs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-1627855751"><a href="#local-1627855751"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><a name="local-1627855752"><a href="#local-1627855752"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-1627855753"><a href="#local-1627855753"><span class="hs-identifier">b'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1023"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="CoreSubst.html#maybe_substitute"><span class="hs-identifier hs-var">maybe_substitute</span></a><span> </span><a href="#local-1627855749"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855751"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-1627855755"><span class="hs-identifier hs-var">r2</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1024"></a><span>           </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1627855756"><a href="#local-1627855756"><span class="hs-identifier">subst'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-1627855756"><span class="hs-identifier hs-var">subst'</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627855750"><span class="hs-identifier hs-var">prs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1025"></a><span>           </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-1627855749"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">,</span><span>  </span><span class="hs-special">(</span><a href="#local-1627855754"><span class="hs-identifier hs-var">b2</span></a><span class="hs-special">,</span><a href="#local-1627855755"><span class="hs-identifier hs-var">r2</span></a><span class="hs-special">)</span><span class="hs-glyph">:</span><a href="#local-1627855750"><span class="hs-identifier hs-var">prs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1026"></a><span>       </span><span class="hs-keyword">where</span><span>
</span><a name="line-1027"></a><span>         </span><a name="local-1627855754"><a href="#local-1627855754"><span class="hs-identifier">b2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#add_info"><span class="hs-identifier hs-var">add_info</span></a><span> </span><a href="#local-1627855749"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855751"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-1627855753"><span class="hs-identifier hs-var">b'</span></a><span>
</span><a name="line-1028"></a><span>         </span><a name="local-1627855755"><a href="#local-1627855755"><span class="hs-identifier">r2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#simple_opt_expr"><span class="hs-identifier hs-var">simple_opt_expr</span></a><span> </span><a href="#local-1627855749"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855752"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-1029"></a><span>
</span><a name="line-1030"></a><span class="hs-identifier">simple_opt_bind'</span><span> </span><a name="local-1627855757"><a href="#local-1627855757"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a name="local-1627855758"><a href="#local-1627855758"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-1627855759"><a href="#local-1627855759"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1031"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#simple_opt_out_bind"><span class="hs-identifier hs-var">simple_opt_out_bind</span></a><span> </span><a href="#local-1627855757"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855758"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#simple_opt_expr"><span class="hs-identifier hs-var">simple_opt_expr</span></a><span> </span><a href="#local-1627855757"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855759"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-1032"></a><span>
</span><a name="line-1033"></a><span class="hs-comment">----------------------</span><span>
</span><a name="line-1034"></a><span class="hs-identifier">simple_opt_out_bind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#InVar"><span class="hs-identifier hs-type">InVar</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="CoreSyn.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a><span class="hs-special">)</span><span>
</span><a name="line-1035"></a><a name="simple_opt_out_bind"><a href="CoreSubst.html#simple_opt_out_bind"><span class="hs-identifier">simple_opt_out_bind</span></a></a><span> </span><a name="local-1627855760"><a href="#local-1627855760"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1627855761"><a href="#local-1627855761"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855762"><a href="#local-1627855762"><span class="hs-identifier">r'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1036"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1627855766"><a href="#local-1627855766"><span class="hs-identifier">ext_subst</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreSubst.html#maybe_substitute"><span class="hs-identifier hs-var">maybe_substitute</span></a><span> </span><a href="#local-1627855760"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855761"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-1627855762"><span class="hs-identifier hs-var">r'</span></a><span>
</span><a name="line-1037"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-1627855766"><span class="hs-identifier hs-var">ext_subst</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">)</span><span>
</span><a name="line-1038"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1039"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-1627855763"><span class="hs-identifier hs-var">subst'</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a href="#local-1627855765"><span class="hs-identifier hs-var">b2</span></a><span> </span><a href="#local-1627855762"><span class="hs-identifier hs-var">r'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1040"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1041"></a><span>    </span><span class="hs-special">(</span><a name="local-1627855763"><a href="#local-1627855763"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855764"><a href="#local-1627855764"><span class="hs-identifier">b'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#subst_opt_bndr"><span class="hs-identifier hs-var">subst_opt_bndr</span></a><span> </span><a href="#local-1627855760"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855761"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-1042"></a><span>    </span><a name="local-1627855765"><a href="#local-1627855765"><span class="hs-identifier">b2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#add_info"><span class="hs-identifier hs-var">add_info</span></a><span> </span><a href="#local-1627855763"><span class="hs-identifier hs-var">subst'</span></a><span> </span><a href="#local-1627855761"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-1627855764"><span class="hs-identifier hs-var">b'</span></a><span>
</span><a name="line-1043"></a><span>
</span><a name="line-1044"></a><span class="hs-comment">----------------------</span><span>
</span><a name="line-1045"></a><span class="hs-identifier">maybe_substitute</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#InVar"><span class="hs-identifier hs-type">InVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-1046"></a><span>    </span><span class="hs-comment">-- (maybe_substitute subst in_var out_rhs)</span><span>
</span><a name="line-1047"></a><span>    </span><span class="hs-comment">--   either extends subst with (in_var -&gt; out_rhs)</span><span>
</span><a name="line-1048"></a><span>    </span><span class="hs-comment">--   or     returns Nothing</span><span>
</span><a name="line-1049"></a><a name="maybe_substitute"><a href="CoreSubst.html#maybe_substitute"><span class="hs-identifier">maybe_substitute</span></a></a><span> </span><a name="local-1627855767"><a href="#local-1627855767"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-1627855768"><a href="#local-1627855768"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-1627855769"><a href="#local-1627855769"><span class="hs-identifier">r</span></a></a><span>
</span><a name="line-1050"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a name="local-1627855777"><a href="#local-1627855777"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627855769"><span class="hs-identifier hs-var">r</span></a><span>        </span><span class="hs-comment">-- let a::* = TYPE ty in &lt;body&gt;</span><span>
</span><a name="line-1051"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isTyVar</span><span> </span><span class="hs-identifier hs-var">b</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1052"></a><span>    </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#extendTvSubst"><span class="hs-identifier hs-var">extendTvSubst</span></a><span> </span><a href="#local-1627855767"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855768"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-1627855777"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1053"></a><span>
</span><a name="line-1054"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a name="local-1627855778"><a href="#local-1627855778"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627855769"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-1055"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isCoVar</span><span> </span><span class="hs-identifier hs-var">b</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1056"></a><span>    </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#extendCvSubst"><span class="hs-identifier hs-var">extendCvSubst</span></a><span> </span><a href="#local-1627855767"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855768"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-1627855778"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-1057"></a><span>
</span><a name="line-1058"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isId"><span class="hs-identifier hs-var">isId</span></a><span> </span><a href="#local-1627855768"><span class="hs-identifier hs-var">b</span></a><span>              </span><span class="hs-comment">-- let x = e in &lt;body&gt;</span><span>
</span><a name="line-1059"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a><span> </span><a href="#local-1627855768"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>     </span><span class="hs-comment">-- See Note [Do not inline CoVars unconditionally]</span><span>
</span><a name="line-1060"></a><span>                        </span><span class="hs-comment">-- in SimplUtils</span><span>
</span><a name="line-1061"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-1627855770"><span class="hs-identifier hs-var">safe_to_inline</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idOccInfo"><span class="hs-identifier hs-var">idOccInfo</span></a><span> </span><a href="#local-1627855768"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-1062"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="BasicTypes.html#isAlwaysActive"><span class="hs-identifier hs-var">isAlwaysActive</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idInlineActivation"><span class="hs-identifier hs-var">idInlineActivation</span></a><span> </span><a href="#local-1627855768"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>       </span><span class="hs-comment">-- Note [Inline prag in simplOpt]</span><span>
</span><a name="line-1063"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#isStableUnfolding"><span class="hs-identifier hs-var">isStableUnfolding</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idUnfolding"><span class="hs-identifier hs-var">idUnfolding</span></a><span> </span><a href="#local-1627855768"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1064"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Var.html#isExportedId"><span class="hs-identifier hs-var">isExportedId</span></a><span> </span><a href="#local-1627855768"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-1065"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Type.html#isUnliftedType"><span class="hs-identifier hs-var">isUnliftedType</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idType"><span class="hs-identifier hs-var">idType</span></a><span> </span><a href="#local-1627855768"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="CoreUtils.html#exprOkForSpeculation"><span class="hs-identifier hs-var">exprOkForSpeculation</span></a><span> </span><a href="#local-1627855769"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-1066"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#extendIdSubst"><span class="hs-identifier hs-var">extendIdSubst</span></a><span> </span><a href="#local-1627855767"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855768"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-1627855769"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-1067"></a><span>
</span><a name="line-1068"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1069"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-1070"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1071"></a><span>        </span><span class="hs-comment">-- Unconditionally safe to inline</span><span>
</span><a name="line-1072"></a><span>    </span><span class="hs-identifier">safe_to_inline</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#OccInfo"><span class="hs-identifier hs-type">OccInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1073"></a><span>    </span><a name="local-1627855770"><a href="#local-1627855770"><span class="hs-identifier">safe_to_inline</span></a></a><span> </span><span class="hs-special">(</span><a href="BasicTypes.html#IAmALoopBreaker"><span class="hs-identifier hs-var">IAmALoopBreaker</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1074"></a><span>    </span><span class="hs-identifier">safe_to_inline</span><span> </span><a href="BasicTypes.html#IAmDead"><span class="hs-identifier hs-var">IAmDead</span></a><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1075"></a><span>    </span><span class="hs-identifier">safe_to_inline</span><span> </span><span class="hs-special">(</span><a href="BasicTypes.html#OneOcc"><span class="hs-identifier hs-var">OneOcc</span></a><span> </span><a name="local-1627855772"><a href="#local-1627855772"><span class="hs-identifier">in_lam</span></a></a><span> </span><a name="local-1627855773"><a href="#local-1627855773"><span class="hs-identifier">one_br</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-1627855772"><span class="hs-identifier hs-var">in_lam</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-1627855773"><span class="hs-identifier hs-var">one_br</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-1627855771"><span class="hs-identifier hs-var">trivial</span></a><span>
</span><a name="line-1076"></a><span>    </span><span class="hs-identifier">safe_to_inline</span><span> </span><a href="BasicTypes.html#NoOccInfo"><span class="hs-identifier hs-var">NoOccInfo</span></a><span>                </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855771"><span class="hs-identifier hs-var">trivial</span></a><span>
</span><a name="line-1077"></a><span>
</span><a name="line-1078"></a><span>    </span><a name="local-1627855771"><a href="#local-1627855771"><span class="hs-identifier">trivial</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="CoreUtils.html#exprIsTrivial"><span class="hs-identifier hs-var">exprIsTrivial</span></a><span> </span><a href="#local-1627855769"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1079"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-1627855774"><a href="#local-1627855774"><span class="hs-identifier">fun</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855775"><a href="#local-1627855775"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreSyn.html#collectArgs"><span class="hs-identifier hs-var">collectArgs</span></a><span> </span><a href="#local-1627855769"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-1080"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1627855776"><a href="#local-1627855776"><span class="hs-identifier">dc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Id.html#isDataConWorkId_maybe"><span class="hs-identifier hs-var">isDataConWorkId_maybe</span></a><span> </span><a href="#local-1627855774"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-1081"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="#local-1627855776"><span class="hs-identifier hs-var">dc</span></a><span> </span><span class="hs-special">`</span><a href="Unique.html#hasKey"><span class="hs-identifier hs-var">hasKey</span></a><span class="hs-special">`</span><span> </span><a href="PrelNames.html#heqDataConKey"><span class="hs-identifier hs-var">heqDataConKey</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-1627855776"><span class="hs-identifier hs-var">dc</span></a><span> </span><span class="hs-special">`</span><a href="Unique.html#hasKey"><span class="hs-identifier hs-var">hasKey</span></a><span class="hs-special">`</span><span> </span><a href="PrelNames.html#coercibleDataConKey"><span class="hs-identifier hs-var">coercibleDataConKey</span></a><span>
</span><a name="line-1082"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a><span> </span><a href="CoreUtils.html#exprIsTrivial"><span class="hs-identifier hs-var">exprIsTrivial</span></a><span> </span><a href="#local-1627855775"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1083"></a><span>                     </span><span class="hs-comment">-- See Note [Getting the map/coerce RULE to work]</span><span>
</span><a name="line-1084"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1085"></a><span>
</span><a name="line-1086"></a><span class="hs-comment">----------------------</span><span>
</span><a name="line-1087"></a><span class="hs-identifier">subst_opt_bndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#InVar"><span class="hs-identifier hs-type">InVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#OutVar"><span class="hs-identifier hs-type">OutVar</span></a><span class="hs-special">)</span><span>
</span><a name="line-1088"></a><a name="subst_opt_bndr"><a href="CoreSubst.html#subst_opt_bndr"><span class="hs-identifier">subst_opt_bndr</span></a></a><span> </span><a name="local-1627855779"><a href="#local-1627855779"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-1627855780"><a href="#local-1627855780"><span class="hs-identifier">bndr</span></a></a><span>
</span><a name="line-1089"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-1627855780"><span class="hs-identifier hs-var">bndr</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substTyVarBndr"><span class="hs-identifier hs-var">substTyVarBndr</span></a><span> </span><a href="#local-1627855779"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855780"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-1090"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a><span> </span><a href="#local-1627855780"><span class="hs-identifier hs-var">bndr</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substCoVarBndr"><span class="hs-identifier hs-var">substCoVarBndr</span></a><span> </span><a href="#local-1627855779"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855780"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-1091"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#subst_opt_id_bndr"><span class="hs-identifier hs-var">subst_opt_id_bndr</span></a><span> </span><a href="#local-1627855779"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855780"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-1092"></a><span>
</span><a name="line-1093"></a><span class="hs-identifier">subst_opt_id_bndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#InId"><span class="hs-identifier hs-type">InId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#OutId"><span class="hs-identifier hs-type">OutId</span></a><span class="hs-special">)</span><span>
</span><a name="line-1094"></a><span class="hs-comment">-- Nuke all fragile IdInfo, unfolding, and RULES;</span><span>
</span><a name="line-1095"></a><span class="hs-comment">--    it gets added back later by add_info</span><span>
</span><a name="line-1096"></a><span class="hs-comment">-- Rather like SimplEnv.substIdBndr</span><span>
</span><a name="line-1097"></a><span class="hs-comment">--</span><span>
</span><a name="line-1098"></a><span class="hs-comment">-- It's important to zap fragile OccInfo (which CoreSubst.substIdBndr</span><span>
</span><a name="line-1099"></a><span class="hs-comment">-- carefully does not do) because simplOptExpr invalidates it</span><span>
</span><a name="line-1100"></a><span>
</span><a name="line-1101"></a><a name="subst_opt_id_bndr"><a href="CoreSubst.html#subst_opt_id_bndr"><span class="hs-identifier">subst_opt_id_bndr</span></a></a><span> </span><a name="local-1627855781"><a href="#local-1627855781"><span class="hs-identifier">subst</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-1627855782"><a href="#local-1627855782"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-1627855783"><a href="#local-1627855783"><span class="hs-identifier">id_subst</span></a></a><span> </span><a name="local-1627855784"><a href="#local-1627855784"><span class="hs-identifier">tv_subst</span></a></a><span> </span><a name="local-1627855785"><a href="#local-1627855785"><span class="hs-identifier">cv_subst</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627855786"><a href="#local-1627855786"><span class="hs-identifier">old_id</span></a></a><span>
</span><a name="line-1102"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a href="#local-1627855790"><span class="hs-identifier hs-var">new_in_scope</span></a><span> </span><a href="#local-1627855791"><span class="hs-identifier hs-var">new_id_subst</span></a><span> </span><a href="#local-1627855784"><span class="hs-identifier hs-var">tv_subst</span></a><span> </span><a href="#local-1627855785"><span class="hs-identifier hs-var">cv_subst</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627855789"><span class="hs-identifier hs-var">new_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-1103"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1104"></a><span>    </span><a name="local-1627855787"><a href="#local-1627855787"><span class="hs-identifier">id1</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#uniqAway"><span class="hs-identifier hs-var">uniqAway</span></a><span> </span><a href="#local-1627855782"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-1627855786"><span class="hs-identifier hs-var">old_id</span></a><span>
</span><a name="line-1105"></a><span>    </span><a name="local-1627855788"><a href="#local-1627855788"><span class="hs-identifier">id2</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#setIdType"><span class="hs-identifier hs-var">setIdType</span></a><span> </span><a href="#local-1627855787"><span class="hs-identifier hs-var">id1</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><a href="#local-1627855781"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idType"><span class="hs-identifier hs-var">idType</span></a><span> </span><a href="#local-1627855786"><span class="hs-identifier hs-var">old_id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1106"></a><span>    </span><a name="local-1627855789"><a href="#local-1627855789"><span class="hs-identifier">new_id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#zapFragileIdInfo"><span class="hs-identifier hs-var">zapFragileIdInfo</span></a><span> </span><a href="#local-1627855788"><span class="hs-identifier hs-var">id2</span></a><span>       </span><span class="hs-comment">-- Zaps rules, worker-info, unfolding</span><span>
</span><a name="line-1107"></a><span>                                        </span><span class="hs-comment">-- and fragile OccInfo</span><span>
</span><a name="line-1108"></a><span>    </span><a name="local-1627855790"><a href="#local-1627855790"><span class="hs-identifier">new_in_scope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855782"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#extendInScopeSet"><span class="hs-identifier hs-var">extendInScopeSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627855789"><span class="hs-identifier hs-var">new_id</span></a><span>
</span><a name="line-1109"></a><span>
</span><a name="line-1110"></a><span>        </span><span class="hs-comment">-- Extend the substitution if the unique has changed,</span><span>
</span><a name="line-1111"></a><span>        </span><span class="hs-comment">-- or there's some useful occurrence information</span><span>
</span><a name="line-1112"></a><span>        </span><span class="hs-comment">-- See the notes with substTyVarBndr for the delSubstEnv</span><span>
</span><a name="line-1113"></a><span>    </span><a name="local-1627855791"><a href="#local-1627855791"><span class="hs-identifier">new_id_subst</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627855789"><span class="hs-identifier hs-var">new_id</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-1627855786"><span class="hs-identifier hs-var">old_id</span></a><span>
</span><a name="line-1114"></a><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a><span> </span><a href="#local-1627855783"><span class="hs-identifier hs-var">id_subst</span></a><span> </span><a href="#local-1627855786"><span class="hs-identifier hs-var">old_id</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a href="#local-1627855789"><span class="hs-identifier hs-var">new_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-1115"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1116"></a><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#delVarEnv"><span class="hs-identifier hs-var">delVarEnv</span></a><span> </span><a href="#local-1627855783"><span class="hs-identifier hs-var">id_subst</span></a><span> </span><a href="#local-1627855786"><span class="hs-identifier hs-var">old_id</span></a><span>
</span><a name="line-1117"></a><span>
</span><a name="line-1118"></a><span class="hs-comment">----------------------</span><span>
</span><a name="line-1119"></a><span class="hs-identifier">subst_opt_bndrs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSubst.html#InVar"><span class="hs-identifier hs-type">InVar</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSubst.html#OutVar"><span class="hs-identifier hs-type">OutVar</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1120"></a><a name="subst_opt_bndrs"><a href="CoreSubst.html#subst_opt_bndrs"><span class="hs-identifier">subst_opt_bndrs</span></a></a><span> </span><a name="local-1627855792"><a href="#local-1627855792"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-1627855793"><a href="#local-1627855793"><span class="hs-identifier">bndrs</span></a></a><span>
</span><a name="line-1121"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapAccumL"><span class="hs-identifier hs-var">mapAccumL</span></a><span> </span><a href="CoreSubst.html#subst_opt_bndr"><span class="hs-identifier hs-var">subst_opt_bndr</span></a><span> </span><a href="#local-1627855792"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855793"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-1122"></a><span>
</span><a name="line-1123"></a><span class="hs-comment">----------------------</span><span>
</span><a name="line-1124"></a><span class="hs-identifier">add_info</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#InVar"><span class="hs-identifier hs-type">InVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#OutVar"><span class="hs-identifier hs-type">OutVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#OutVar"><span class="hs-identifier hs-type">OutVar</span></a><span>
</span><a name="line-1125"></a><a name="add_info"><a href="CoreSubst.html#add_info"><span class="hs-identifier">add_info</span></a></a><span> </span><a name="local-1627855794"><a href="#local-1627855794"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-1627855795"><a href="#local-1627855795"><span class="hs-identifier">old_bndr</span></a></a><span> </span><a name="local-1627855796"><a href="#local-1627855796"><span class="hs-identifier">new_bndr</span></a></a><span>
</span><a name="line-1126"></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-1627855795"><span class="hs-identifier hs-var">old_bndr</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855796"><span class="hs-identifier hs-var">new_bndr</span></a><span>
</span><a name="line-1127"></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#maybeModifyIdInfo"><span class="hs-identifier hs-var">maybeModifyIdInfo</span></a><span> </span><a href="#local-1627855797"><span class="hs-identifier hs-var">mb_new_info</span></a><span> </span><a href="#local-1627855796"><span class="hs-identifier hs-var">new_bndr</span></a><span>
</span><a name="line-1128"></a><span> </span><span class="hs-keyword">where</span><span> </span><a name="local-1627855797"><a href="#local-1627855797"><span class="hs-identifier">mb_new_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substIdInfo"><span class="hs-identifier hs-var">substIdInfo</span></a><span> </span><a href="#local-1627855794"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855796"><span class="hs-identifier hs-var">new_bndr</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#idInfo"><span class="hs-identifier hs-var">idInfo</span></a><span> </span><a href="#local-1627855795"><span class="hs-identifier hs-var">old_bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1129"></a><span>
</span><a name="line-1130"></a><span class="hs-identifier">simpleUnfoldingFun</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#IdUnfoldingFun"><span class="hs-identifier hs-type">IdUnfoldingFun</span></a><span>
</span><a name="line-1131"></a><a name="simpleUnfoldingFun"><a href="CoreSubst.html#simpleUnfoldingFun"><span class="hs-identifier">simpleUnfoldingFun</span></a></a><span> </span><a name="local-1627855798"><a href="#local-1627855798"><span class="hs-identifier">id</span></a></a><span>
</span><a name="line-1132"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="BasicTypes.html#isAlwaysActive"><span class="hs-identifier hs-var">isAlwaysActive</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idInlineActivation"><span class="hs-identifier hs-var">idInlineActivation</span></a><span> </span><a href="#local-1627855798"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#idUnfolding"><span class="hs-identifier hs-var">idUnfolding</span></a><span> </span><a href="#local-1627855798"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-1133"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>                              </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#noUnfolding"><span class="hs-identifier hs-var">noUnfolding</span></a><span>
</span><a name="line-1134"></a><span>
</span><a name="line-1135"></a><span class="hs-comment">{-
Note [Inline prag in simplOpt]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If there's an INLINE/NOINLINE pragma that restricts the phase in
which the binder can be inlined, we don't inline here; after all,
we don't know what phase we're in.  Here's an example

  foo :: Int -&gt; Int -&gt; Int
  {-# INLINE foo #-}
  foo m n = inner m
     where
       {-# INLINE [1] inner #-}
       inner m = m+n

  bar :: Int -&gt; Int
  bar n = foo n 1

When inlining 'foo' in 'bar' we want the let-binding for 'inner'
to remain visible until Phase 1

Note [Unfold compulsory unfoldings in LHSs]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When the user writes `RULES map coerce = coerce` as a rule, the rule
will only ever match if simpleOptExpr replaces coerce by its unfolding
on the LHS, because that is the core that the rule matching engine
will find. So do that for everything that has a compulsory
unfolding. Also see Note [Desugaring coerce as cast] in Desugar.

However, we don't want to inline 'seq', which happens to also have a
compulsory unfolding, so we only do this unfolding only for things
that are always-active.  See Note [User-defined RULES for seq] in MkId.


************************************************************************
*                                                                      *
         exprIsConApp_maybe
*                                                                      *
************************************************************************

Note [exprIsConApp_maybe]
~~~~~~~~~~~~~~~~~~~~~~~~~
exprIsConApp_maybe is a very important function.  There are two principal
uses:
  * case e of { .... }
  * cls_op e, where cls_op is a class operation

In both cases you want to know if e is of form (C e1..en) where C is
a data constructor.

However e might not *look* as if


Note [exprIsConApp_maybe on literal strings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
See #9400.

Conceptually, a string literal &quot;abc&quot; is just ('a':'b':'c':[]), but in Core
they are represented as unpackCString# &quot;abc&quot;# by MkCore.mkStringExprFS, or
unpackCStringUtf8# when the literal contains multi-byte UTF8 characters.

For optimizations we want to be able to treat it as a list, so they can be
decomposed when used in a case-statement. exprIsConApp_maybe detects those
calls to unpackCString# and returns:

Just (':', [Char], ['a', unpackCString# &quot;bc&quot;]).

We need to be careful about UTF8 strings here. &quot;&quot;# contains a ByteString, so
we must parse it back into a FastString to split off the first character.
That way we can treat unpackCString# and unpackCStringUtf8# in the same way.
-}</span><span>
</span><a name="line-1205"></a><span>
</span><a name="line-1206"></a><span class="hs-keyword">data</span><span> </span><a name="ConCont"><a href="CoreSubst.html#ConCont"><span class="hs-identifier">ConCont</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="CC"><a href="CoreSubst.html#CC"><span class="hs-identifier">CC</span></a></a><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">]</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-1207"></a><span>                  </span><span class="hs-comment">-- Substitution already applied</span><span>
</span><a name="line-1208"></a><span>
</span><a name="line-1209"></a><span class="hs-comment">-- | Returns @Just (dc, [t1..tk], [x1..xn])@ if the argument expression is</span><span>
</span><a name="line-1210"></a><span class="hs-comment">-- a *saturated* constructor application of the form @dc t1..tk x1 .. xn@,</span><span>
</span><a name="line-1211"></a><span class="hs-comment">-- where t1..tk are the *universally-qantified* type args of 'dc'</span><span>
</span><a name="line-1212"></a><span class="hs-identifier">exprIsConApp_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#InScopeEnv"><span class="hs-identifier hs-type">InScopeEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1213"></a><a name="exprIsConApp_maybe"><a href="CoreSubst.html#exprIsConApp_maybe"><span class="hs-identifier">exprIsConApp_maybe</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1627855799"><a href="#local-1627855799"><span class="hs-identifier">in_scope</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855800"><a href="#local-1627855800"><span class="hs-identifier">id_unf</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627855801"><a href="#local-1627855801"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-1214"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855802"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Either.html#Left"><span class="hs-identifier hs-var">Left</span></a><span> </span><a href="#local-1627855799"><span class="hs-identifier hs-var">in_scope</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855801"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#CC"><span class="hs-identifier hs-var">CC</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkRepReflCo"><span class="hs-identifier hs-var">mkRepReflCo</span></a><span> </span><span class="hs-special">(</span><a href="CoreUtils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a><span> </span><a href="#local-1627855801"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1215"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1216"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Either.html#Either"><span class="hs-identifier hs-type">Either</span></a><span> </span><a href="VarEnv.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-1217"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#ConCont"><span class="hs-identifier hs-type">ConCont</span></a><span>
</span><a name="line-1218"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1219"></a><span>    </span><a name="local-1627855802"><a href="#local-1627855802"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-1627855806"><a href="#local-1627855806"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-1627855807"><a href="#local-1627855807"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-1627855808"><a href="#local-1627855808"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627855809"><a href="#local-1627855809"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-1220"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#tickishIsCode"><span class="hs-identifier hs-var">tickishIsCode</span></a><span> </span><a href="#local-1627855807"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855802"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627855806"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855808"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-1627855809"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1221"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1627855810"><a href="#local-1627855810"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-1627855811"><a href="#local-1627855811"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-1627855812"><a href="#local-1627855812"><span class="hs-identifier">co1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#CC"><span class="hs-identifier hs-var">CC</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-1627855813"><a href="#local-1627855813"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1222"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855802"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627855810"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855811"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#CC"><span class="hs-identifier hs-var">CC</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><a href="#local-1627855803"><span class="hs-identifier hs-var">subst_co</span></a><span> </span><a href="#local-1627855810"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855812"><span class="hs-identifier hs-var">co1</span></a><span> </span><span class="hs-special">`</span><a href="Coercion.html#mkTransCo"><span class="hs-identifier hs-var">mkTransCo</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627855813"><span class="hs-identifier hs-var">co2</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1223"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1627855814"><a href="#local-1627855814"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-1627855815"><a href="#local-1627855815"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-1627855816"><a href="#local-1627855816"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#CC"><span class="hs-identifier hs-var">CC</span></a><span> </span><a name="local-1627855817"><a href="#local-1627855817"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-1627855818"><a href="#local-1627855818"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1224"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855802"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1627855814"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855815"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#CC"><span class="hs-identifier hs-var">CC</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855804"><span class="hs-identifier hs-var">subst_arg</span></a><span> </span><a href="#local-1627855814"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855816"><span class="hs-identifier hs-var">arg</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-1627855817"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855818"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-1225"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1627855819"><a href="#local-1627855819"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a name="local-1627855820"><a href="#local-1627855820"><span class="hs-identifier">var</span></a></a><span> </span><a name="local-1627855821"><a href="#local-1627855821"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#CC"><span class="hs-identifier hs-var">CC</span></a><span> </span><span class="hs-special">(</span><a name="local-1627855822"><a href="#local-1627855822"><span class="hs-identifier">arg</span></a></a><span class="hs-glyph">:</span><a name="local-1627855823"><a href="#local-1627855823"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627855824"><a href="#local-1627855824"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1226"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="CoreUtils.html#exprIsTrivial"><span class="hs-identifier hs-var">exprIsTrivial</span></a><span> </span><a href="#local-1627855822"><span class="hs-identifier hs-var">arg</span></a><span>          </span><span class="hs-comment">-- Don't duplicate stuff!</span><span>
</span><a name="line-1227"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855802"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855805"><span class="hs-identifier hs-var">extend</span></a><span> </span><a href="#local-1627855819"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855820"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-1627855822"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855821"><span class="hs-identifier hs-var">body</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#CC"><span class="hs-identifier hs-var">CC</span></a><span> </span><a href="#local-1627855823"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-1627855824"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-1228"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Either.html#Right"><span class="hs-identifier hs-var">Right</span></a><span> </span><a name="local-1627855825"><a href="#local-1627855825"><span class="hs-identifier">sub</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-1627855826"><a href="#local-1627855826"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627855827"><a href="#local-1627855827"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-1229"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855802"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Either.html#Left"><span class="hs-identifier hs-var">Left</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substInScope"><span class="hs-identifier hs-var">substInScope</span></a><span> </span><a href="#local-1627855825"><span class="hs-identifier hs-var">sub</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1230"></a><span>            </span><span class="hs-special">(</span><a href="CoreSubst.html#lookupIdSubst"><span class="hs-identifier hs-var">lookupIdSubst</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;exprIsConApp&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1627855801"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855825"><span class="hs-identifier hs-var">sub</span></a><span> </span><a href="#local-1627855826"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-1231"></a><span>            </span><a href="#local-1627855827"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1232"></a><span>
</span><a name="line-1233"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Either.html#Left"><span class="hs-identifier hs-var">Left</span></a><span> </span><a name="local-1627855828"><a href="#local-1627855828"><span class="hs-identifier">in_scope</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-1627855829"><a href="#local-1627855829"><span class="hs-identifier">fun</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627855830"><a href="#local-1627855830"><span class="hs-identifier">cont</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSubst.html#CC"><span class="hs-identifier hs-var">CC</span></a><span> </span><a name="local-1627855831"><a href="#local-1627855831"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-1627855832"><a href="#local-1627855832"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1234"></a><span>
</span><a name="line-1235"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1627855834"><a href="#local-1627855834"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Id.html#isDataConWorkId_maybe"><span class="hs-identifier hs-var">isDataConWorkId_maybe</span></a><span> </span><a href="#local-1627855829"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-1236"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="Util.html#count"><span class="hs-identifier hs-var">count</span></a><span> </span><a href="CoreSyn.html#isValArg"><span class="hs-identifier hs-var">isValArg</span></a><span> </span><a href="#local-1627855831"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a><span> </span><a href="#local-1627855829"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-1237"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#dealWithCoercion"><span class="hs-identifier hs-var">dealWithCoercion</span></a><span> </span><a href="#local-1627855832"><span class="hs-identifier hs-var">co</span></a><span> </span><a href="#local-1627855834"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-1627855831"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1238"></a><span>
</span><a name="line-1239"></a><span>        </span><span class="hs-comment">-- Look through dictionary functions; see Note [Unfolding DFuns]</span><span>
</span><a name="line-1240"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#DFunUnfolding"><span class="hs-identifier hs-var">DFunUnfolding</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">df_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1627855835"><a href="#local-1627855835"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">df_con</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1627855836"><a href="#local-1627855836"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">df_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1627855837"><a href="#local-1627855837"><span class="hs-identifier">dfun_args</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627855833"><span class="hs-identifier hs-var">unfolding</span></a><span>
</span><a name="line-1241"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="#local-1627855835"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><span class="hs-special">`</span><a href="Util.html#equalLength"><span class="hs-identifier hs-var">equalLength</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627855831"><span class="hs-identifier hs-var">args</span></a><span>    </span><span class="hs-comment">-- See Note [DFun arity check]</span><span>
</span><a name="line-1242"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1627855838"><a href="#local-1627855838"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#mkOpenSubst"><span class="hs-identifier hs-var">mkOpenSubst</span></a><span> </span><a href="#local-1627855828"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855835"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><span class="hs-special">`</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zip"><span class="hs-identifier hs-var">zip</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627855831"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-1243"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#dealWithCoercion"><span class="hs-identifier hs-var">dealWithCoercion</span></a><span> </span><a href="#local-1627855832"><span class="hs-identifier hs-var">co</span></a><span> </span><a href="#local-1627855836"><span class="hs-identifier hs-var">con</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substExpr"><span class="hs-identifier hs-var">substExpr</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;exprIsConApp1&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-1627855838"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855837"><span class="hs-identifier hs-var">dfun_args</span></a><span class="hs-special">)</span><span>
</span><a name="line-1244"></a><span>
</span><a name="line-1245"></a><span>        </span><span class="hs-comment">-- Look through unfoldings, but only arity-zero one;</span><span>
</span><a name="line-1246"></a><span>        </span><span class="hs-comment">-- if arity &gt; 0 we are effectively inlining a function call,</span><span>
</span><a name="line-1247"></a><span>        </span><span class="hs-comment">-- and that is the business of callSiteInline.</span><span>
</span><a name="line-1248"></a><span>        </span><span class="hs-comment">-- In practice, without this test, most of the &quot;hits&quot; were</span><span>
</span><a name="line-1249"></a><span>        </span><span class="hs-comment">-- CPR'd workers getting inlined back into their wrappers,</span><span>
</span><a name="line-1250"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a><span> </span><a href="#local-1627855829"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-1251"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1627855839"><a href="#local-1627855839"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreSyn.html#expandUnfolding_maybe"><span class="hs-identifier hs-var">expandUnfolding_maybe</span></a><span> </span><a href="#local-1627855833"><span class="hs-identifier hs-var">unfolding</span></a><span>
</span><a name="line-1252"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1627855840"><a href="#local-1627855840"><span class="hs-identifier">in_scope'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#extendInScopeSetSet"><span class="hs-identifier hs-var">extendInScopeSetSet</span></a><span> </span><a href="#local-1627855828"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">(</span><a href="CoreFVs.html#exprFreeVars"><span class="hs-identifier hs-var">exprFreeVars</span></a><span> </span><a href="#local-1627855839"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1253"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855802"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Either.html#Left"><span class="hs-identifier hs-var">Left</span></a><span> </span><a href="#local-1627855840"><span class="hs-identifier hs-var">in_scope'</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855839"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-1627855830"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-1254"></a><span>
</span><a name="line-1255"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a href="#local-1627855829"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-special">`</span><a href="Unique.html#hasKey"><span class="hs-identifier hs-var">hasKey</span></a><span class="hs-special">`</span><span> </span><a href="PrelNames.html#unpackCStringIdKey"><span class="hs-identifier hs-var">unpackCStringIdKey</span></a><span class="hs-special">)</span><span>
</span><a name="line-1256"></a><span>         </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-special">(</span><a href="#local-1627855829"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-special">`</span><a href="Unique.html#hasKey"><span class="hs-identifier hs-var">hasKey</span></a><span class="hs-special">`</span><span> </span><a href="PrelNames.html#unpackCStringUtf8IdKey"><span class="hs-identifier hs-var">unpackCStringUtf8IdKey</span></a><span class="hs-special">)</span><span>
</span><a name="line-1257"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><span class="hs-special">(</span><a href="Literal.html#MachStr"><span class="hs-identifier hs-var">MachStr</span></a><span> </span><a name="local-1627855841"><a href="#local-1627855841"><span class="hs-identifier">str</span></a></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627855831"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1258"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#dealWithStringLiteral"><span class="hs-identifier hs-var">dealWithStringLiteral</span></a><span> </span><a href="#local-1627855829"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-1627855841"><span class="hs-identifier hs-var">str</span></a><span> </span><a href="#local-1627855832"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1259"></a><span>        </span><span class="hs-keyword">where</span><span>
</span><a name="line-1260"></a><span>          </span><a name="local-1627855833"><a href="#local-1627855833"><span class="hs-identifier">unfolding</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855800"><span class="hs-identifier hs-var">id_unf</span></a><span> </span><a href="#local-1627855829"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-1261"></a><span>
</span><a name="line-1262"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-1263"></a><span>
</span><a name="line-1264"></a><span>    </span><span class="hs-comment">----------------------------</span><span>
</span><a name="line-1265"></a><span>    </span><span class="hs-comment">-- Operations on the (Either InScopeSet CoreSubst)</span><span>
</span><a name="line-1266"></a><span>    </span><span class="hs-comment">-- The Left case is wildly dominant</span><span>
</span><a name="line-1267"></a><span>    </span><a name="local-1627855803"><a href="#local-1627855803"><span class="hs-identifier">subst_co</span></a></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Either.html#Left"><span class="hs-identifier hs-var">Left</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-1627855842"><a href="#local-1627855842"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855842"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1268"></a><span>    </span><span class="hs-identifier">subst_co</span><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Either.html#Right"><span class="hs-identifier hs-var">Right</span></a><span> </span><a name="local-1627855843"><a href="#local-1627855843"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627855844"><a href="#local-1627855844"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substCo"><span class="hs-identifier hs-var">CoreSubst</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">substCo</span></a><span> </span><a href="#local-1627855843"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-1627855844"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1269"></a><span>
</span><a name="line-1270"></a><span>    </span><a name="local-1627855804"><a href="#local-1627855804"><span class="hs-identifier">subst_arg</span></a></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Either.html#Left"><span class="hs-identifier hs-var">Left</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-1627855845"><a href="#local-1627855845"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855845"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1271"></a><span>    </span><span class="hs-identifier">subst_arg</span><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Either.html#Right"><span class="hs-identifier hs-var">Right</span></a><span> </span><a name="local-1627855846"><a href="#local-1627855846"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627855847"><a href="#local-1627855847"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substExpr"><span class="hs-identifier hs-var">substExpr</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;exprIsConApp2&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-1627855846"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-1627855847"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1272"></a><span>
</span><a name="line-1273"></a><span>    </span><a name="local-1627855805"><a href="#local-1627855805"><span class="hs-identifier">extend</span></a></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Either.html#Left"><span class="hs-identifier hs-var">Left</span></a><span> </span><a name="local-1627855848"><a href="#local-1627855848"><span class="hs-identifier">in_scope</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627855849"><a href="#local-1627855849"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-1627855850"><a href="#local-1627855850"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Either.html#Right"><span class="hs-identifier hs-var">Right</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#extendSubst"><span class="hs-identifier hs-var">extendSubst</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#mkEmptySubst"><span class="hs-identifier hs-var">mkEmptySubst</span></a><span> </span><a href="#local-1627855848"><span class="hs-identifier hs-var">in_scope</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855849"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-1627855850"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-1274"></a><span>    </span><span class="hs-identifier">extend</span><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Either.html#Right"><span class="hs-identifier hs-var">Right</span></a><span> </span><a name="local-1627855851"><a href="#local-1627855851"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span>       </span><a name="local-1627855852"><a href="#local-1627855852"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-1627855853"><a href="#local-1627855853"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Either.html#Right"><span class="hs-identifier hs-var">Right</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#extendSubst"><span class="hs-identifier hs-var">extendSubst</span></a><span> </span><a href="#local-1627855851"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-1627855852"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-1627855853"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-1275"></a><span>
</span><a name="line-1276"></a><span class="hs-comment">-- See Note [exprIsConApp_maybe on literal strings]</span><span>
</span><a name="line-1277"></a><span class="hs-identifier">dealWithStringLiteral</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../bytestring-0.10.7.0/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.Internal.html#ByteString"><span class="hs-identifier hs-type">BS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-1278"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1279"></a><span>
</span><a name="line-1280"></a><span class="hs-comment">-- This is not possible with user-supplied empty literals, MkCore.mkStringExprFS</span><span>
</span><a name="line-1281"></a><span class="hs-comment">-- turns those into [] automatically, but just in case something else in GHC</span><span>
</span><a name="line-1282"></a><span class="hs-comment">-- generates a string literal directly.</span><span>
</span><a name="line-1283"></a><a name="dealWithStringLiteral"><a href="CoreSubst.html#dealWithStringLiteral"><span class="hs-identifier">dealWithStringLiteral</span></a></a><span> </span><span class="hs-identifier">_</span><span>   </span><a name="local-1627855854"><a href="#local-1627855854"><span class="hs-identifier">str</span></a></a><span> </span><a name="local-1627855855"><a href="#local-1627855855"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-1284"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../bytestring-0.10.7.0/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.html#null"><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1627855854"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-1285"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#dealWithCoercion"><span class="hs-identifier hs-var">dealWithCoercion</span></a><span> </span><a href="#local-1627855855"><span class="hs-identifier hs-var">co</span></a><span> </span><a href="TysWiredIn.html#nilDataCon"><span class="hs-identifier hs-var">nilDataCon</span></a><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a href="TysWiredIn.html#charTy"><span class="hs-identifier hs-var">charTy</span></a><span class="hs-special">]</span><span>
</span><a name="line-1286"></a><span>
</span><a name="line-1287"></a><span class="hs-identifier">dealWithStringLiteral</span><span> </span><a name="local-1627855856"><a href="#local-1627855856"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-1627855857"><a href="#local-1627855857"><span class="hs-identifier">str</span></a></a><span> </span><a name="local-1627855858"><a href="#local-1627855858"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-1288"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1627855859"><a href="#local-1627855859"><span class="hs-identifier">strFS</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#mkFastStringByteString"><span class="hs-identifier hs-var">mkFastStringByteString</span></a><span> </span><a href="#local-1627855857"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-1289"></a><span>
</span><a name="line-1290"></a><span>        </span><a name="local-1627855860"><a href="#local-1627855860"><span class="hs-identifier">char</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#mkConApp"><span class="hs-identifier hs-var">mkConApp</span></a><span> </span><a href="TysWiredIn.html#charDataCon"><span class="hs-identifier hs-var">charDataCon</span></a><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#mkCharLit"><span class="hs-identifier hs-var">mkCharLit</span></a><span> </span><span class="hs-special">(</span><a href="FastString.html#headFS"><span class="hs-identifier hs-var">headFS</span></a><span> </span><a href="#local-1627855859"><span class="hs-identifier hs-var">strFS</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1291"></a><span>        </span><a name="local-1627855861"><a href="#local-1627855861"><span class="hs-identifier">charTail</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#fastStringToByteString"><span class="hs-identifier hs-var">fastStringToByteString</span></a><span> </span><span class="hs-special">(</span><a href="FastString.html#tailFS"><span class="hs-identifier hs-var">tailFS</span></a><span> </span><a href="#local-1627855859"><span class="hs-identifier hs-var">strFS</span></a><span class="hs-special">)</span><span>
</span><a name="line-1292"></a><span>
</span><a name="line-1293"></a><span>        </span><span class="hs-comment">-- In singleton strings, just add [] instead of unpackCstring# &quot;&quot;#.</span><span>
</span><a name="line-1294"></a><span>        </span><a name="local-1627855862"><a href="#local-1627855862"><span class="hs-identifier">rest</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="../bytestring-0.10.7.0/src/%{MODULE/./-}.html#%{NAME}/Data.ByteString.html#null"><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1627855861"><span class="hs-identifier hs-var">charTail</span></a><span>
</span><a name="line-1295"></a><span>                 </span><span class="hs-keyword">then</span><span> </span><a href="CoreSyn.html#mkConApp"><span class="hs-identifier hs-var">mkConApp</span></a><span> </span><a href="TysWiredIn.html#nilDataCon"><span class="hs-identifier hs-var">nilDataCon</span></a><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a href="TysWiredIn.html#charTy"><span class="hs-identifier hs-var">charTy</span></a><span class="hs-special">]</span><span>
</span><a name="line-1296"></a><span>                 </span><span class="hs-keyword">else</span><span> </span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a href="#local-1627855856"><span class="hs-identifier hs-var">fun</span></a><span class="hs-special">)</span><span>
</span><a name="line-1297"></a><span>                          </span><span class="hs-special">(</span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><span class="hs-special">(</span><a href="Literal.html#MachStr"><span class="hs-identifier hs-var">MachStr</span></a><span> </span><a href="#local-1627855861"><span class="hs-identifier hs-var">charTail</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1298"></a><span>
</span><a name="line-1299"></a><span>    </span><span class="hs-keyword">in</span><span> </span><a href="CoreSubst.html#dealWithCoercion"><span class="hs-identifier hs-var">dealWithCoercion</span></a><span> </span><a href="#local-1627855858"><span class="hs-identifier hs-var">co</span></a><span> </span><a href="TysWiredIn.html#consDataCon"><span class="hs-identifier hs-var">consDataCon</span></a><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a href="TysWiredIn.html#charTy"><span class="hs-identifier hs-var">charTy</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627855860"><span class="hs-identifier hs-var">char</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627855862"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">]</span><span>
</span><a name="line-1300"></a><span>
</span><a name="line-1301"></a><span class="hs-identifier">dealWithCoercion</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">]</span><span>
</span><a name="line-1302"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1303"></a><a name="dealWithCoercion"><a href="CoreSubst.html#dealWithCoercion"><span class="hs-identifier">dealWithCoercion</span></a></a><span> </span><a name="local-1627855863"><a href="#local-1627855863"><span class="hs-identifier">co</span></a></a><span> </span><a name="local-1627855864"><a href="#local-1627855864"><span class="hs-identifier">dc</span></a></a><span> </span><a name="local-1627855865"><a href="#local-1627855865"><span class="hs-identifier">dc_args</span></a></a><span>
</span><a name="line-1304"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a><span> </span><a href="#local-1627855863"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-1627855866"><span class="hs-identifier hs-var">from_ty</span></a><span> </span><span class="hs-special">`</span><a href="Type.html#eqType"><span class="hs-identifier hs-var">eqType</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627855867"><span class="hs-identifier hs-var">to_ty</span></a><span>  </span><span class="hs-comment">-- try cheap test first</span><span>
</span><a name="line-1305"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-1627855868"><a href="#local-1627855868"><span class="hs-identifier">univ_ty_args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855869"><a href="#local-1627855869"><span class="hs-identifier">rest_args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#splitAtList"><span class="hs-identifier hs-var">splitAtList</span></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#dataConUnivTyVars"><span class="hs-identifier hs-var">dataConUnivTyVars</span></a><span> </span><a href="#local-1627855864"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855865"><span class="hs-identifier hs-var">dc_args</span></a><span>
</span><a name="line-1306"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855864"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="CoreSyn.html#exprToType"><span class="hs-identifier hs-var">exprToType</span></a><span> </span><a href="#local-1627855868"><span class="hs-identifier hs-var">univ_ty_args</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627855869"><span class="hs-identifier hs-var">rest_args</span></a><span class="hs-special">)</span><span>
</span><a name="line-1307"></a><span>
</span><a name="line-1308"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1627855870"><a href="#local-1627855870"><span class="hs-identifier">to_tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855871"><a href="#local-1627855871"><span class="hs-identifier">to_tc_arg_tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-var">splitTyConApp_maybe</span></a><span> </span><a href="#local-1627855867"><span class="hs-identifier hs-var">to_ty</span></a><span>
</span><a name="line-1309"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-1627855870"><span class="hs-identifier hs-var">to_tc</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="DataCon.html#dataConTyCon"><span class="hs-identifier hs-var">dataConTyCon</span></a><span> </span><a href="#local-1627855864"><span class="hs-identifier hs-var">dc</span></a><span>
</span><a name="line-1310"></a><span>        </span><span class="hs-comment">-- These two tests can fail; we might see</span><span>
</span><a name="line-1311"></a><span>        </span><span class="hs-comment">--      (C x y) `cast` (g :: T a ~ S [a]),</span><span>
</span><a name="line-1312"></a><span>        </span><span class="hs-comment">-- where S is a type function.  In fact, exprIsConApp</span><span>
</span><a name="line-1313"></a><span>        </span><span class="hs-comment">-- will probably not be called in such circumstances,</span><span>
</span><a name="line-1314"></a><span>        </span><span class="hs-comment">-- but there't nothing wrong with it</span><span>
</span><a name="line-1315"></a><span>
</span><a name="line-1316"></a><span>  </span><span class="hs-glyph">=</span><span>     </span><span class="hs-comment">-- Here we do the KPush reduction rule as described in &quot;Down with kinds&quot;</span><span>
</span><a name="line-1317"></a><span>        </span><span class="hs-comment">-- The transformation applies iff we have</span><span>
</span><a name="line-1318"></a><span>        </span><span class="hs-comment">--      (C e1 ... en) `cast` co</span><span>
</span><a name="line-1319"></a><span>        </span><span class="hs-comment">-- where co :: (T t1 .. tn) ~ to_ty</span><span>
</span><a name="line-1320"></a><span>        </span><span class="hs-comment">-- The left-hand one must be a T, because exprIsConApp returned True</span><span>
</span><a name="line-1321"></a><span>        </span><span class="hs-comment">-- but the right-hand one might not be.  (Though it usually will.)</span><span>
</span><a name="line-1322"></a><span>    </span><span class="hs-keyword">let</span><span>
</span><a name="line-1323"></a><span>        </span><a name="local-1627855872"><a href="#local-1627855872"><span class="hs-identifier">tc_arity</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConArity</span><span> </span><a href="#local-1627855870"><span class="hs-identifier hs-var">to_tc</span></a><span>
</span><a name="line-1324"></a><span>        </span><a name="local-1627855873"><a href="#local-1627855873"><span class="hs-identifier">dc_univ_tyvars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DataCon.html#dataConUnivTyVars"><span class="hs-identifier hs-var">dataConUnivTyVars</span></a><span> </span><a href="#local-1627855864"><span class="hs-identifier hs-var">dc</span></a><span>
</span><a name="line-1325"></a><span>        </span><a name="local-1627855874"><a href="#local-1627855874"><span class="hs-identifier">dc_ex_tyvars</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="DataCon.html#dataConExTyVars"><span class="hs-identifier hs-var">dataConExTyVars</span></a><span> </span><a href="#local-1627855864"><span class="hs-identifier hs-var">dc</span></a><span>
</span><a name="line-1326"></a><span>        </span><a name="local-1627855875"><a href="#local-1627855875"><span class="hs-identifier">arg_tys</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="DataCon.html#dataConRepArgTys"><span class="hs-identifier hs-var">dataConRepArgTys</span></a><span> </span><a href="#local-1627855864"><span class="hs-identifier hs-var">dc</span></a><span>
</span><a name="line-1327"></a><span>
</span><a name="line-1328"></a><span>        </span><a name="local-1627855876"><a href="#local-1627855876"><span class="hs-identifier">non_univ_args</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#dropList"><span class="hs-identifier hs-var">dropList</span></a><span> </span><a href="#local-1627855873"><span class="hs-identifier hs-var">dc_univ_tyvars</span></a><span> </span><a href="#local-1627855865"><span class="hs-identifier hs-var">dc_args</span></a><span>
</span><a name="line-1329"></a><span>        </span><span class="hs-special">(</span><a name="local-1627855877"><a href="#local-1627855877"><span class="hs-identifier">ex_args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855878"><a href="#local-1627855878"><span class="hs-identifier">val_args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#splitAtList"><span class="hs-identifier hs-var">splitAtList</span></a><span> </span><a href="#local-1627855874"><span class="hs-identifier hs-var">dc_ex_tyvars</span></a><span> </span><a href="#local-1627855876"><span class="hs-identifier hs-var">non_univ_args</span></a><span>
</span><a name="line-1330"></a><span>
</span><a name="line-1331"></a><span>        </span><span class="hs-comment">-- Make the &quot;Psi&quot; from the paper</span><span>
</span><a name="line-1332"></a><span>        </span><a name="local-1627855879"><a href="#local-1627855879"><span class="hs-identifier">omegas</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#decomposeCo"><span class="hs-identifier hs-var">decomposeCo</span></a><span> </span><a href="#local-1627855872"><span class="hs-identifier hs-var">tc_arity</span></a><span> </span><a href="#local-1627855863"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1333"></a><span>        </span><span class="hs-special">(</span><a name="local-1627855880"><a href="#local-1627855880"><span class="hs-identifier">psi_subst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855881"><a href="#local-1627855881"><span class="hs-identifier">to_ex_arg_tys</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1334"></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#liftCoSubstWithEx"><span class="hs-identifier hs-var">liftCoSubstWithEx</span></a><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span>
</span><a name="line-1335"></a><span>                              </span><a href="#local-1627855873"><span class="hs-identifier hs-var">dc_univ_tyvars</span></a><span>
</span><a name="line-1336"></a><span>                              </span><a href="#local-1627855879"><span class="hs-identifier hs-var">omegas</span></a><span>
</span><a name="line-1337"></a><span>                              </span><a href="#local-1627855874"><span class="hs-identifier hs-var">dc_ex_tyvars</span></a><span>
</span><a name="line-1338"></a><span>                              </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="CoreSyn.html#exprToType"><span class="hs-identifier hs-var">exprToType</span></a><span> </span><a href="#local-1627855877"><span class="hs-identifier hs-var">ex_args</span></a><span class="hs-special">)</span><span>
</span><a name="line-1339"></a><span>
</span><a name="line-1340"></a><span>          </span><span class="hs-comment">-- Cast the value arguments (which include dictionaries)</span><span>
</span><a name="line-1341"></a><span>        </span><a name="local-1627855882"><a href="#local-1627855882"><span class="hs-identifier">new_val_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zipWith"><span class="hs-identifier hs-var">zipWith</span></a><span> </span><a href="#local-1627855883"><span class="hs-identifier hs-var">cast_arg</span></a><span> </span><a href="#local-1627855875"><span class="hs-identifier hs-var">arg_tys</span></a><span> </span><a href="#local-1627855878"><span class="hs-identifier hs-var">val_args</span></a><span>
</span><a name="line-1342"></a><span>        </span><a name="local-1627855883"><a href="#local-1627855883"><span class="hs-identifier">cast_arg</span></a></a><span> </span><a name="local-1627855886"><a href="#local-1627855886"><span class="hs-identifier">arg_ty</span></a></a><span> </span><a name="local-1627855887"><a href="#local-1627855887"><span class="hs-identifier">arg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#mkCast"><span class="hs-identifier hs-var">mkCast</span></a><span> </span><a href="#local-1627855887"><span class="hs-identifier hs-var">arg</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855880"><span class="hs-identifier hs-var">psi_subst</span></a><span> </span><a href="#local-1627855886"><span class="hs-identifier hs-var">arg_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1343"></a><span>
</span><a name="line-1344"></a><span>        </span><a name="local-1627855884"><a href="#local-1627855884"><span class="hs-identifier">to_ex_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a href="#local-1627855881"><span class="hs-identifier hs-var">to_ex_arg_tys</span></a><span>
</span><a name="line-1345"></a><span>
</span><a name="line-1346"></a><span>        </span><a name="local-1627855885"><a href="#local-1627855885"><span class="hs-identifier">dump_doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1627855864"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">,</span><span>      </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1627855873"><span class="hs-identifier hs-var">dc_univ_tyvars</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1627855874"><span class="hs-identifier hs-var">dc_ex_tyvars</span></a><span class="hs-special">,</span><span>
</span><a name="line-1347"></a><span>                         </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1627855875"><span class="hs-identifier hs-var">arg_tys</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1627855865"><span class="hs-identifier hs-var">dc_args</span></a><span class="hs-special">,</span><span>
</span><a name="line-1348"></a><span>                         </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1627855877"><span class="hs-identifier hs-var">ex_args</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1627855878"><span class="hs-identifier hs-var">val_args</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1627855863"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1627855866"><span class="hs-identifier hs-var">from_ty</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1627855867"><span class="hs-identifier hs-var">to_ty</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1627855870"><span class="hs-identifier hs-var">to_tc</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1349"></a><span>    </span><span class="hs-keyword">in</span><span>
</span><a name="line-1350"></a><span>    </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">eqType</span><span> </span><span class="hs-identifier">from_ty</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mkTyConApp</span><span> </span><span class="hs-identifier">to_tc</span><span> </span><span class="hs-special">(</span><a href="Type.html#mkTyConApp"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-identifier">exprToType</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-operator hs-var">$</span></a><span> </span><a href="CoreSyn.html#exprToType"><span class="hs-identifier hs-var">takeList</span></a><span> </span><span class="hs-identifier">dc_univ_tyvars</span><span> </span><a href="#local-1627855873"><span class="hs-identifier hs-var">dc_args</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dump_doc</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1351"></a><span>    </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">equalLength</span><span> </span><span class="hs-identifier">val_args</span><span> </span><span class="hs-identifier">arg_tys</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dump_doc</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1352"></a><span>    </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855864"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627855871"><span class="hs-identifier hs-var">to_tc_arg_tys</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627855884"><span class="hs-identifier hs-var">to_ex_args</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-1627855882"><span class="hs-identifier hs-var">new_val_args</span></a><span class="hs-special">)</span><span>
</span><a name="line-1353"></a><span>
</span><a name="line-1354"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1355"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-1356"></a><span>
</span><a name="line-1357"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1358"></a><span>    </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-1627855866"><a href="#local-1627855866"><span class="hs-identifier">from_ty</span></a></a><span> </span><a name="local-1627855867"><a href="#local-1627855867"><span class="hs-identifier">to_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span> </span><a href="#local-1627855863"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1359"></a><span>
</span><a name="line-1360"></a><span>
</span><a name="line-1361"></a><span class="hs-comment">{-
Note [Unfolding DFuns]
~~~~~~~~~~~~~~~~~~~~~~
DFuns look like

  df :: forall a b. (Eq a, Eq b) -&gt; Eq (a,b)
  df a b d_a d_b = MkEqD (a,b) ($c1 a b d_a d_b)
                               ($c2 a b d_a d_b)

So to split it up we just need to apply the ops $c1, $c2 etc
to the very same args as the dfun.  It takes a little more work
to compute the type arguments to the dictionary constructor.

Note [DFun arity check]
~~~~~~~~~~~~~~~~~~~~~~~
Here we check that the total number of supplied arguments (inclding
type args) matches what the dfun is expecting.  This may be *less*
than the ordinary arity of the dfun: see Note [DFun unfoldings] in CoreSyn
-}</span><span>
</span><a name="line-1380"></a><span>
</span><a name="line-1381"></a><span class="hs-identifier">exprIsLiteral_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#InScopeEnv"><span class="hs-identifier hs-type">InScopeEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="Literal.html#Literal"><span class="hs-identifier hs-type">Literal</span></a><span>
</span><a name="line-1382"></a><span class="hs-comment">-- Same deal as exprIsConApp_maybe, but much simpler</span><span>
</span><a name="line-1383"></a><span class="hs-comment">-- Nevertheless we do need to look through unfoldings for</span><span>
</span><a name="line-1384"></a><span class="hs-comment">-- Integer literals, which are vigorously hoisted to top level</span><span>
</span><a name="line-1385"></a><span class="hs-comment">-- and not subsequently inlined</span><span>
</span><a name="line-1386"></a><a name="exprIsLiteral_maybe"><a href="CoreSubst.html#exprIsLiteral_maybe"><span class="hs-identifier">exprIsLiteral_maybe</span></a></a><span> </span><a name="local-1627855888"><a href="#local-1627855888"><span class="hs-identifier">env</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-1627855889"><a href="#local-1627855889"><span class="hs-identifier">id_unf</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627855890"><a href="#local-1627855890"><span class="hs-identifier">e</span></a></a><span>
</span><a name="line-1387"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1627855890"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1388"></a><span>      </span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><a name="local-1627855891"><a href="#local-1627855891"><span class="hs-identifier">l</span></a></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-1627855891"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-1389"></a><span>      </span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627855892"><a href="#local-1627855892"><span class="hs-identifier">e'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#exprIsLiteral_maybe"><span class="hs-identifier hs-var">exprIsLiteral_maybe</span></a><span> </span><a href="#local-1627855888"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627855892"><span class="hs-identifier hs-var">e'</span></a><span> </span><span class="hs-comment">-- dubious?</span><span>
</span><a name="line-1390"></a><span>      </span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-1627855893"><a href="#local-1627855893"><span class="hs-identifier">v</span></a></a><span>     </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1627855894"><a href="#local-1627855894"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreSyn.html#expandUnfolding_maybe"><span class="hs-identifier hs-var">expandUnfolding_maybe</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855889"><span class="hs-identifier hs-var">id_unf</span></a><span> </span><a href="#local-1627855893"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-1391"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#exprIsLiteral_maybe"><span class="hs-identifier hs-var">exprIsLiteral_maybe</span></a><span> </span><a href="#local-1627855888"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627855894"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-1392"></a><span>      </span><span class="hs-identifier">_</span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-1393"></a><span>
</span><a name="line-1394"></a><span class="hs-comment">{-
Note [exprIsLambda_maybe]
~~~~~~~~~~~~~~~~~~~~~~~~~~
exprIsLambda_maybe will, given an expression `e`, try to turn it into the form
`Lam v e'` (returned as `Just (v,e')`). Besides using lambdas, it looks through
casts (using the Push rule), and it unfolds function calls if the unfolding
has a greater arity than arguments are present.

Currently, it is used in Rules.match, and is required to make
&quot;map coerce = coerce&quot; match.
-}</span><span>
</span><a name="line-1405"></a><span>
</span><a name="line-1406"></a><span class="hs-identifier">exprIsLambda_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#InScopeEnv"><span class="hs-identifier hs-type">InScopeEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-1407"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">,</span><span class="hs-special">[</span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1408"></a><span>    </span><span class="hs-comment">-- See Note [exprIsLambda_maybe]</span><span>
</span><a name="line-1409"></a><span>
</span><a name="line-1410"></a><span class="hs-comment">-- The simple case: It is a lambda already</span><span>
</span><a name="line-1411"></a><a name="exprIsLambda_maybe"><a href="CoreSubst.html#exprIsLambda_maybe"><span class="hs-identifier">exprIsLambda_maybe</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a name="local-1627855895"><a href="#local-1627855895"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-1627855896"><a href="#local-1627855896"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1412"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855895"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627855896"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1413"></a><span>
</span><a name="line-1414"></a><span class="hs-comment">-- Still straightforward: Ticks that we can float out of the way</span><span>
</span><a name="line-1415"></a><span class="hs-identifier">exprIsLambda_maybe</span><span> </span><span class="hs-special">(</span><a name="local-1627855897"><a href="#local-1627855897"><span class="hs-identifier">in_scope_set</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855898"><a href="#local-1627855898"><span class="hs-identifier">id_unf</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-1627855899"><a href="#local-1627855899"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-1627855900"><a href="#local-1627855900"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1416"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a><span> </span><a href="#local-1627855899"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-1417"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1627855901"><a href="#local-1627855901"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855902"><a href="#local-1627855902"><span class="hs-identifier">e</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855903"><a href="#local-1627855903"><span class="hs-identifier">ts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreSubst.html#exprIsLambda_maybe"><span class="hs-identifier hs-var">exprIsLambda_maybe</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855897"><span class="hs-identifier hs-var">in_scope_set</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627855898"><span class="hs-identifier hs-var">id_unf</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855900"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1418"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855901"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627855902"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627855899"><span class="hs-identifier hs-var">t</span></a><span class="hs-glyph">:</span><a href="#local-1627855903"><span class="hs-identifier hs-var">ts</span></a><span class="hs-special">)</span><span>
</span><a name="line-1419"></a><span>
</span><a name="line-1420"></a><span class="hs-comment">-- Also possible: A casted lambda. Push the coercion inside</span><span>
</span><a name="line-1421"></a><span class="hs-identifier">exprIsLambda_maybe</span><span> </span><span class="hs-special">(</span><a name="local-1627855904"><a href="#local-1627855904"><span class="hs-identifier">in_scope_set</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855905"><a href="#local-1627855905"><span class="hs-identifier">id_unf</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-1627855906"><a href="#local-1627855906"><span class="hs-identifier">casted_e</span></a></a><span> </span><a name="local-1627855907"><a href="#local-1627855907"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1422"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1627855908"><a href="#local-1627855908"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855909"><a href="#local-1627855909"><span class="hs-identifier">e</span></a></a><span class="hs-special">,</span><a name="local-1627855910"><a href="#local-1627855910"><span class="hs-identifier">ts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreSubst.html#exprIsLambda_maybe"><span class="hs-identifier hs-var">exprIsLambda_maybe</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855904"><span class="hs-identifier hs-var">in_scope_set</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627855905"><span class="hs-identifier hs-var">id_unf</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855906"><span class="hs-identifier hs-var">casted_e</span></a><span>
</span><a name="line-1423"></a><span>    </span><span class="hs-comment">-- Only do value lambdas.</span><span>
</span><a name="line-1424"></a><span>    </span><span class="hs-comment">-- this implies that x is not in scope in gamma (makes this code simpler)</span><span>
</span><a name="line-1425"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-1627855908"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a><span> </span><a href="#local-1627855908"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-1426"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">not</span></a><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier hs-var">x</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">elemVarSet</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">tyCoVarsOfCo</span><span> </span><span class="hs-identifier">co</span><span class="hs-special">)</span><span> </span><a href="TyCoRep.html#tyCoVarsOfCo"><span class="hs-identifier hs-var">True</span></a><span>
</span><a name="line-1427"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1627855911"><a href="#local-1627855911"><span class="hs-identifier">x'</span></a></a><span class="hs-special">,</span><a name="local-1627855912"><a href="#local-1627855912"><span class="hs-identifier">e'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreSubst.html#pushCoercionIntoLambda"><span class="hs-identifier hs-var">pushCoercionIntoLambda</span></a><span> </span><a href="#local-1627855904"><span class="hs-identifier hs-var">in_scope_set</span></a><span> </span><a href="#local-1627855908"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-1627855909"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-1627855907"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1428"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1627855913"><a href="#local-1627855913"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855911"><span class="hs-identifier hs-var">x'</span></a><span class="hs-special">,</span><a href="#local-1627855912"><span class="hs-identifier hs-var">e'</span></a><span class="hs-special">,</span><a href="#local-1627855910"><span class="hs-identifier hs-var">ts</span></a><span class="hs-special">)</span><span>
</span><a name="line-1429"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">--pprTrace &quot;exprIsLambda_maybe:Cast&quot; (vcat [ppr casted_e,ppr co,ppr res)])</span><span>
</span><a name="line-1430"></a><span>      </span><a href="#local-1627855913"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-1431"></a><span>
</span><a name="line-1432"></a><span class="hs-comment">-- Another attempt: See if we find a partial unfolding</span><span>
</span><a name="line-1433"></a><span class="hs-identifier">exprIsLambda_maybe</span><span> </span><span class="hs-special">(</span><a name="local-1627855914"><a href="#local-1627855914"><span class="hs-identifier">in_scope_set</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855915"><a href="#local-1627855915"><span class="hs-identifier">id_unf</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627855916"><a href="#local-1627855916"><span class="hs-identifier">e</span></a></a><span>
</span><a name="line-1434"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-1627855917"><a href="#local-1627855917"><span class="hs-identifier">f</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-keyword">as</span><span class="hs-special">,</span><span> </span><a name="local-1627855919"><a href="#local-1627855919"><span class="hs-identifier">ts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreSyn.html#collectArgsTicks"><span class="hs-identifier hs-var">collectArgsTicks</span></a><span> </span><a href="CoreSyn.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a><span> </span><a href="#local-1627855916"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1435"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a><span> </span><a href="#local-1627855917"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a><span> </span><a href="CoreSyn.html#isValArg"><span class="hs-identifier hs-var">isValArg</span></a><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span>
</span><a name="line-1436"></a><span>    </span><span class="hs-comment">-- Make sure there is hope to get a lambda</span><span>
</span><a name="line-1437"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1627855920"><a href="#local-1627855920"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreSyn.html#expandUnfolding_maybe"><span class="hs-identifier hs-var">expandUnfolding_maybe</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855915"><span class="hs-identifier hs-var">id_unf</span></a><span> </span><a href="#local-1627855917"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span>
</span><a name="line-1438"></a><span>    </span><span class="hs-comment">-- Optimize, for beta-reduction</span><span>
</span><a name="line-1439"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1627855921"><a href="#local-1627855921"><span class="hs-identifier">e'</span></a></a><span> </span><span class="hs-glyph">=</span><span>  </span><a href="CoreSubst.html#simpleOptExprWith"><span class="hs-identifier hs-var">simpleOptExprWith</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#mkEmptySubst"><span class="hs-identifier hs-var">mkEmptySubst</span></a><span> </span><a href="#local-1627855914"><span class="hs-identifier hs-var">in_scope_set</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-1627855920"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-special">`</span><a href="CoreSyn.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a><span class="hs-special">`</span><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span>
</span><a name="line-1440"></a><span>    </span><span class="hs-comment">-- Recurse, because of possible casts</span><span>
</span><a name="line-1441"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1627855922"><a href="#local-1627855922"><span class="hs-identifier">x'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855923"><a href="#local-1627855923"><span class="hs-identifier">e''</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855924"><a href="#local-1627855924"><span class="hs-identifier">ts'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreSubst.html#exprIsLambda_maybe"><span class="hs-identifier hs-var">exprIsLambda_maybe</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855914"><span class="hs-identifier hs-var">in_scope_set</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627855915"><span class="hs-identifier hs-var">id_unf</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855921"><span class="hs-identifier hs-var">e'</span></a><span>
</span><a name="line-1442"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1627855925"><a href="#local-1627855925"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855922"><span class="hs-identifier hs-var">x'</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627855923"><span class="hs-identifier hs-var">e''</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627855919"><span class="hs-identifier hs-var">ts</span></a><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><a href="#local-1627855924"><span class="hs-identifier hs-var">ts'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1443"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;exprIsLambda_maybe:Unfold&quot; (vcat [ppr e, ppr (x',e'')])</span><span>
</span><a name="line-1444"></a><span>      </span><a href="#local-1627855925"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-1445"></a><span>
</span><a name="line-1446"></a><span class="hs-identifier">exprIsLambda_maybe</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627855926"><a href="#local-1627855926"><span class="hs-identifier">_e</span></a></a><span>
</span><a name="line-1447"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;exprIsLambda_maybe:Fail&quot; (vcat [ppr _e])</span><span>
</span><a name="line-1448"></a><span>      </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-1449"></a><span>
</span><a name="line-1450"></a><span>
</span><a name="line-1451"></a><span class="hs-identifier">pushCoercionIntoLambda</span><span>
</span><a name="line-1452"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1453"></a><a name="pushCoercionIntoLambda"><a href="CoreSubst.html#pushCoercionIntoLambda"><span class="hs-identifier">pushCoercionIntoLambda</span></a></a><span> </span><a name="local-1627855927"><a href="#local-1627855927"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-1627855928"><a href="#local-1627855928"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-1627855929"><a href="#local-1627855929"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-1627855930"><a href="#local-1627855930"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-1454"></a><span>    </span><span class="hs-comment">-- This implements the Push rule from the paper on coercions</span><span>
</span><a name="line-1455"></a><span>    </span><span class="hs-comment">-- Compare with simplCast in Simplify</span><span>
</span><a name="line-1456"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">not</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">isTyVar</span><span> </span><span class="hs-identifier">x</span><span class="hs-special">)</span><span> </span><span class="hs-operator">&amp;&amp;</span><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">not</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">isCoVar</span><span> </span><span class="hs-identifier">x</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">True</span><span>
</span><a name="line-1457"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-1627855931"><a href="#local-1627855931"><span class="hs-identifier">s1s2</span></a></a><span> </span><a name="local-1627855932"><a href="#local-1627855932"><span class="hs-identifier">t1t2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span> </span><a href="#local-1627855930"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1458"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1627855933"><a href="#local-1627855933"><span class="hs-identifier">_s1</span></a></a><span class="hs-special">,</span><a name="local-1627855934"><a href="#local-1627855934"><span class="hs-identifier">_s2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitFunTy_maybe"><span class="hs-identifier hs-var">splitFunTy_maybe</span></a><span> </span><a href="#local-1627855931"><span class="hs-identifier hs-var">s1s2</span></a><span>
</span><a name="line-1459"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1627855935"><a href="#local-1627855935"><span class="hs-identifier">t1</span></a></a><span class="hs-special">,</span><a name="local-1627855936"><a href="#local-1627855936"><span class="hs-identifier">_t2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitFunTy_maybe"><span class="hs-identifier hs-var">splitFunTy_maybe</span></a><span> </span><a href="#local-1627855932"><span class="hs-identifier hs-var">t1t2</span></a><span>
</span><a name="line-1460"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">[</span><a name="local-1627855937"><a href="#local-1627855937"><span class="hs-identifier">co1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627855938"><a href="#local-1627855938"><span class="hs-identifier">co2</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#decomposeCo"><span class="hs-identifier hs-var">decomposeCo</span></a><span> </span><span class="hs-number">2</span><span> </span><a href="#local-1627855930"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1461"></a><span>          </span><span class="hs-comment">-- Should we optimize the coercions here?</span><span>
</span><a name="line-1462"></a><span>          </span><span class="hs-comment">-- Otherwise they might not match too well</span><span>
</span><a name="line-1463"></a><span>          </span><a name="local-1627855939"><a href="#local-1627855939"><span class="hs-identifier">x'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855928"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">`</span><a href="Id.html#setIdType"><span class="hs-identifier hs-var">setIdType</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627855935"><span class="hs-identifier hs-var">t1</span></a><span>
</span><a name="line-1464"></a><span>          </span><a name="local-1627855940"><a href="#local-1627855940"><span class="hs-identifier">in_scope'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627855927"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#extendInScopeSet"><span class="hs-identifier hs-var">extendInScopeSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627855939"><span class="hs-identifier hs-var">x'</span></a><span>
</span><a name="line-1465"></a><span>          </span><a name="local-1627855941"><a href="#local-1627855941"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#extendIdSubst"><span class="hs-identifier hs-var">extendIdSubst</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#mkEmptySubst"><span class="hs-identifier hs-var">mkEmptySubst</span></a><span> </span><a href="#local-1627855940"><span class="hs-identifier hs-var">in_scope'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1466"></a><span>                                </span><a href="#local-1627855928"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-1467"></a><span>                                </span><span class="hs-special">(</span><a href="CoreUtils.html#mkCast"><span class="hs-identifier hs-var">mkCast</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a href="#local-1627855939"><span class="hs-identifier hs-var">x'</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627855937"><span class="hs-identifier hs-var">co1</span></a><span class="hs-special">)</span><span>
</span><a name="line-1468"></a><span>      </span><span class="hs-keyword">in</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627855939"><span class="hs-identifier hs-var">x'</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#subst_expr"><span class="hs-identifier hs-var">subst_expr</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;pushCoercionIntoLambda&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-1627855941"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1627855929"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-special">`</span><a href="CoreUtils.html#mkCast"><span class="hs-identifier hs-var">mkCast</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627855938"><span class="hs-identifier hs-var">co2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1469"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1470"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprTrace"><span class="hs-identifier hs-var">pprTrace</span></a><span> </span><span class="hs-string">&quot;exprIsLambda_maybe: Unexpected lambda in case&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a href="#local-1627855928"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-1627855929"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1471"></a><span>      </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-1472"></a></pre></body></html>