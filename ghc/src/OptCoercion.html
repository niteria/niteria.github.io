<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- (c) The University of Glasgow 2006</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-4"></a><span>
</span><a name="line-5"></a><span class="hs-comment">-- The default iteration limit is a bit too low for the definitions</span><span>
</span><a name="line-6"></a><span class="hs-comment">-- in this module.</span><span>
</span><a name="line-7"></a><span class="hs-cpp">#if __GLASGOW_HASKELL__ &gt;= 800</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# OPTIONS_GHC -fmax-pmcheck-iterations=10000000 #-}</span><span>
</span><a name="line-9"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">OptCoercion</span><span> </span><span class="hs-special">(</span><span> </span><a href="OptCoercion.html#optCoercion"><span class="hs-identifier hs-var">optCoercion</span></a><span class="hs-special">,</span><span> </span><a href="OptCoercion.html#checkAxInstCo"><span class="hs-identifier hs-var">checkAxInstCo</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><a href="TyCoRep.html"><span class="hs-identifier">TyCoRep</span></a><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><a href="Coercion.html"><span class="hs-identifier">Coercion</span></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><a href="Type.html"><span class="hs-identifier">Type</span></a><span> </span><span class="hs-keyword">hiding</span><span class="hs-special">(</span><span> </span><a href="TyCoRep.html#substTyVarBndr"><span class="hs-identifier hs-var">substTyVarBndr</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><a href="TcType.html"><span class="hs-identifier">TcType</span></a><span>       </span><span class="hs-special">(</span><span> </span><a href="TcType.html#exactTyCoVarsOfType"><span class="hs-identifier hs-var">exactTyCoVarsOfType</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><a href="TyCon.html"><span class="hs-identifier">TyCon</span></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><a href="CoAxiom.html"><span class="hs-identifier">CoAxiom</span></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="VarSet.html"><span class="hs-identifier">VarSet</span></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="VarEnv.html"><span class="hs-identifier">VarEnv</span></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="StaticFlags.html"><span class="hs-identifier">StaticFlags</span></a><span>      </span><span class="hs-special">(</span><span> </span><a href="StaticFlags.html#opt_NoOptCoercion"><span class="hs-identifier hs-var">opt_NoOptCoercion</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><a href="Outputable.html"><span class="hs-identifier">Outputable</span></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="FamInstEnv.html"><span class="hs-identifier">FamInstEnv</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="FamInstEnv.html#flattenTys"><span class="hs-identifier hs-var">flattenTys</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="Pair.html"><span class="hs-identifier">Pair</span></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="ListSetOps.html"><span class="hs-identifier">ListSetOps</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="ListSetOps.html#getNth"><span class="hs-identifier hs-var">getNth</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="Util.html"><span class="hs-identifier">Util</span></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="Unify.html"><span class="hs-identifier">Unify</span></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="InstEnv.html"><span class="hs-identifier">InstEnv</span></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html"><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span></a><span>   </span><span class="hs-special">(</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html#zipWithM"><span class="hs-identifier hs-var">zipWithM</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span>
</span><a name="line-33"></a><span class="hs-comment">{-
%************************************************************************
%*                                                                      *
                 Optimising coercions
%*                                                                      *
%************************************************************************

Note [Optimising coercion optimisation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Looking up a coercion's role or kind is linear in the size of the
coercion. Thus, doing this repeatedly during the recursive descent
of coercion optimisation is disastrous. We must be careful to avoid
doing this if at all possible.

Because it is generally easy to know a coercion's components' roles
from the role of the outer coercion, we pass down the known role of
the input in the algorithm below. We also keep functions opt_co2
and opt_co3 separate from opt_co4, so that the former two do Phantom
checks that opt_co4 can avoid. This is a big win because Phantom coercions
rarely appear within non-phantom coercions -- only in some TyConAppCos
and some AxiomInstCos. We handle these cases specially by calling
opt_co2.

Note [Optimising InstCo]
~~~~~~~~~~~~~~~~~~~~~~~~
When we have (InstCo (ForAllCo tv h g) g2), we want to optimise.

Let's look at the typing rules.

h : k1 ~ k2
tv:k1 |- g : t1 ~ t2
-----------------------------
ForAllCo tv h g : (all tv:k1.t1) ~ (all tv:k2.t2[tv |-&gt; tv |&gt; sym h])

g1 : (all tv:k1.t1') ~ (all tv:k2.t2')
g2 : s1 ~ s2
--------------------
InstCo g1 g2 : t1'[tv |-&gt; s1] ~ t2'[tv |-&gt; s2]

We thus want some coercion proving this:

  (t1[tv |-&gt; s1]) ~ (t2[tv |-&gt; s2 |&gt; sym h])

If we substitute the *type* tv for the *coercion*
(g2 `mkCoherenceRightCo` sym h) in g, we'll get this result exactly.
This is bizarre,
though, because we're substituting a type variable with a coercion. However,
this operation already exists: it's called *lifting*, and defined in Coercion.
We just need to enhance the lifting operation to be able to deal with
an ambient substitution, which is why a LiftingContext stores a TCvSubst.

-}</span><span>
</span><a name="line-85"></a><span>
</span><a name="line-86"></a><span class="hs-identifier">optCoercion</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-type">TCvSubst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OptCoercion.html#NormalCo"><span class="hs-identifier hs-type">NormalCo</span></a><span>
</span><a name="line-87"></a><span class="hs-comment">-- ^ optCoercion applies a substitution to a coercion,</span><span>
</span><a name="line-88"></a><span class="hs-comment">--   *and* optimises it to reduce its size</span><span>
</span><a name="line-89"></a><a name="optCoercion"><a href="OptCoercion.html#optCoercion"><span class="hs-identifier">optCoercion</span></a></a><span> </span><a name="local-1627853210"><a href="#local-1627853210"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-1627853211"><a href="#local-1627853211"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-90"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="StaticFlags.html#opt_NoOptCoercion"><span class="hs-identifier hs-var">opt_NoOptCoercion</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substCo"><span class="hs-identifier hs-var">substCo</span></a><span> </span><a href="#local-1627853210"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627853211"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-91"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">debugIsOn</span></a><span>
</span><a name="line-92"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1627853213"><a href="#local-1627853213"><span class="hs-identifier">out_co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#opt_co1"><span class="hs-identifier hs-var">opt_co1</span></a><span> </span><a href="#local-1627853212"><span class="hs-identifier hs-var">lc</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-1627853211"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-93"></a><span>        </span><span class="hs-special">(</span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-1627853214"><a href="#local-1627853214"><span class="hs-identifier">in_ty1</span></a></a><span>  </span><a name="local-1627853215"><a href="#local-1627853215"><span class="hs-identifier">in_ty2</span></a></a><span class="hs-special">,</span><span>  </span><a name="local-1627853216"><a href="#local-1627853216"><span class="hs-identifier">in_role</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#coercionKindRole"><span class="hs-identifier hs-var">coercionKindRole</span></a><span> </span><a href="#local-1627853211"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-94"></a><span>        </span><span class="hs-special">(</span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-1627853217"><a href="#local-1627853217"><span class="hs-identifier">out_ty1</span></a></a><span> </span><a name="local-1627853218"><a href="#local-1627853218"><span class="hs-identifier">out_ty2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853219"><a href="#local-1627853219"><span class="hs-identifier">out_role</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#coercionKindRole"><span class="hs-identifier hs-var">coercionKindRole</span></a><span> </span><a href="#local-1627853213"><span class="hs-identifier hs-var">out_co</span></a><span>
</span><a name="line-95"></a><span>    </span><span class="hs-keyword">in</span><span>
</span><a name="line-96"></a><span>    </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">substTyUnchecked</span><span> </span><a href="TyCoRep.html#substTyUnchecked"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="TyCoRep.html#substTyUnchecked"><span class="hs-identifier hs-var">in_ty1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier">eqType</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">out_ty1</span><span> </span><a href="Type.html#eqType"><span class="hs-operator hs-var">&amp;&amp;</span></a><span>
</span><a name="line-97"></a><span>             </span><span class="hs-identifier">substTyUnchecked</span><span> </span><span class="hs-identifier">env</span><span> </span><span class="hs-identifier">in_ty2</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">eqType</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">out_ty2</span><span> </span><span class="hs-operator">&amp;&amp;</span><span>
</span><a name="line-98"></a><span>             </span><span class="hs-identifier">in_role</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">out_role</span><span>
</span><a name="line-99"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;optCoercion changed types!&quot;</span><span>
</span><a name="line-100"></a><span>             </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;in_co:&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">co</span><span class="hs-special">)</span><span>
</span><a name="line-101"></a><span>             </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;in_ty1:&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">in_ty1</span><span class="hs-special">)</span><span>
</span><a name="line-102"></a><span>             </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;in_ty2:&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">in_ty2</span><span class="hs-special">)</span><span>
</span><a name="line-103"></a><span>             </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;out_co:&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">out_co</span><span class="hs-special">)</span><span>
</span><a name="line-104"></a><span>             </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;out_ty1:&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">out_ty1</span><span class="hs-special">)</span><span>
</span><a name="line-105"></a><span>             </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;out_ty2:&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">out_ty2</span><span class="hs-special">)</span><span>
</span><a name="line-106"></a><span>             </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;subst:&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">env</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-107"></a><span>    </span><a href="#local-1627853213"><span class="hs-identifier hs-var">out_co</span></a><span>
</span><a name="line-108"></a><span>
</span><a name="line-109"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#opt_co1"><span class="hs-identifier hs-var">opt_co1</span></a><span> </span><a href="#local-1627853212"><span class="hs-identifier hs-var">lc</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-1627853211"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-110"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-111"></a><span>    </span><a name="local-1627853212"><a href="#local-1627853212"><span class="hs-identifier">lc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkSubstLiftingContext"><span class="hs-identifier hs-var">mkSubstLiftingContext</span></a><span> </span><a href="#local-1627853210"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-112"></a><span>
</span><a name="line-113"></a><span class="hs-keyword">type</span><span> </span><a name="NormalCo"><a href="OptCoercion.html#NormalCo"><span class="hs-identifier">NormalCo</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-114"></a><span>  </span><span class="hs-comment">-- Invariants:</span><span>
</span><a name="line-115"></a><span>  </span><span class="hs-comment">--  * The substitution has been fully applied</span><span>
</span><a name="line-116"></a><span>  </span><span class="hs-comment">--  * For trans coercions (co1 `trans` co2)</span><span>
</span><a name="line-117"></a><span>  </span><span class="hs-comment">--       co1 is not a trans, and neither co1 nor co2 is identity</span><span>
</span><a name="line-118"></a><span>
</span><a name="line-119"></a><span class="hs-keyword">type</span><span> </span><a name="NormalNonIdCo"><a href="OptCoercion.html#NormalNonIdCo"><span class="hs-identifier">NormalNonIdCo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#NormalCo"><span class="hs-identifier hs-type">NormalCo</span></a><span>  </span><span class="hs-comment">-- Extra invariant: not the identity</span><span>
</span><a name="line-120"></a><span>
</span><a name="line-121"></a><span class="hs-comment">-- | Do we apply a @sym@ to the result?</span><span>
</span><a name="line-122"></a><span class="hs-keyword">type</span><span> </span><a name="SymFlag"><a href="OptCoercion.html#SymFlag"><span class="hs-identifier">SymFlag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-123"></a><span>
</span><a name="line-124"></a><span class="hs-comment">-- | Do we force the result to be representational?</span><span>
</span><a name="line-125"></a><span class="hs-keyword">type</span><span> </span><a name="ReprFlag"><a href="OptCoercion.html#ReprFlag"><span class="hs-identifier">ReprFlag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-126"></a><span>
</span><a name="line-127"></a><span class="hs-comment">-- | Optimize a coercion, making no assumptions. All coercions in</span><span>
</span><a name="line-128"></a><span class="hs-comment">-- the lifting context are already optimized (and sym'd if nec'y)</span><span>
</span><a name="line-129"></a><span class="hs-identifier">opt_co1</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span>
</span><a name="line-130"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OptCoercion.html#SymFlag"><span class="hs-identifier hs-type">SymFlag</span></a><span>
</span><a name="line-131"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OptCoercion.html#NormalCo"><span class="hs-identifier hs-type">NormalCo</span></a><span>
</span><a name="line-132"></a><a name="opt_co1"><a href="OptCoercion.html#opt_co1"><span class="hs-identifier">opt_co1</span></a></a><span> </span><a name="local-1627853220"><a href="#local-1627853220"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-1627853221"><a href="#local-1627853221"><span class="hs-identifier">sym</span></a></a><span> </span><a name="local-1627853222"><a href="#local-1627853222"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#opt_co2"><span class="hs-identifier hs-var">opt_co2</span></a><span> </span><a href="#local-1627853220"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627853221"><span class="hs-identifier hs-var">sym</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#coercionRole"><span class="hs-identifier hs-var">coercionRole</span></a><span> </span><a href="#local-1627853222"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627853222"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-133"></a><span>
</span><a name="line-134"></a><span class="hs-comment">-- See Note [Optimising coercion optimisation]</span><span>
</span><a name="line-135"></a><span class="hs-comment">-- | Optimize a coercion, knowing the coercion's role. No other assumptions.</span><span>
</span><a name="line-136"></a><span class="hs-identifier">opt_co2</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span>
</span><a name="line-137"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OptCoercion.html#SymFlag"><span class="hs-identifier hs-type">SymFlag</span></a><span>
</span><a name="line-138"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span>   </span><span class="hs-comment">-- ^ The role of the input coercion</span><span>
</span><a name="line-139"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OptCoercion.html#NormalCo"><span class="hs-identifier hs-type">NormalCo</span></a><span>
</span><a name="line-140"></a><a name="opt_co2"><a href="OptCoercion.html#opt_co2"><span class="hs-identifier">opt_co2</span></a></a><span> </span><a name="local-1627853223"><a href="#local-1627853223"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-1627853224"><a href="#local-1627853224"><span class="hs-identifier">sym</span></a></a><span> </span><a href="CoAxiom.html#Phantom"><span class="hs-identifier hs-var">Phantom</span></a><span> </span><a name="local-1627853225"><a href="#local-1627853225"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#opt_phantom"><span class="hs-identifier hs-var">opt_phantom</span></a><span> </span><a href="#local-1627853223"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627853224"><span class="hs-identifier hs-var">sym</span></a><span> </span><a href="#local-1627853225"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-141"></a><span class="hs-identifier">opt_co2</span><span> </span><a name="local-1627853226"><a href="#local-1627853226"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-1627853227"><a href="#local-1627853227"><span class="hs-identifier">sym</span></a></a><span> </span><a name="local-1627853228"><a href="#local-1627853228"><span class="hs-identifier">r</span></a></a><span>       </span><a name="local-1627853229"><a href="#local-1627853229"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#opt_co3"><span class="hs-identifier hs-var">opt_co3</span></a><span> </span><a href="#local-1627853226"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627853227"><span class="hs-identifier hs-var">sym</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="#local-1627853228"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-1627853229"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-142"></a><span>
</span><a name="line-143"></a><span class="hs-comment">-- See Note [Optimising coercion optimisation]</span><span>
</span><a name="line-144"></a><span class="hs-comment">-- | Optimize a coercion, knowing the coercion's non-Phantom role.</span><span>
</span><a name="line-145"></a><span class="hs-identifier">opt_co3</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OptCoercion.html#SymFlag"><span class="hs-identifier hs-type">SymFlag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OptCoercion.html#NormalCo"><span class="hs-identifier hs-type">NormalCo</span></a><span>
</span><a name="line-146"></a><a name="opt_co3"><a href="OptCoercion.html#opt_co3"><span class="hs-identifier">opt_co3</span></a></a><span> </span><a name="local-1627853230"><a href="#local-1627853230"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-1627853231"><a href="#local-1627853231"><span class="hs-identifier">sym</span></a></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="CoAxiom.html#Phantom"><span class="hs-identifier hs-var">Phantom</span></a><span class="hs-special">)</span><span>          </span><span class="hs-identifier">_</span><span> </span><a name="local-1627853232"><a href="#local-1627853232"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#opt_phantom"><span class="hs-identifier hs-var">opt_phantom</span></a><span> </span><a href="#local-1627853230"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627853231"><span class="hs-identifier hs-var">sym</span></a><span> </span><a href="#local-1627853232"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-147"></a><span class="hs-identifier">opt_co3</span><span> </span><a name="local-1627853233"><a href="#local-1627853233"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-1627853234"><a href="#local-1627853234"><span class="hs-identifier">sym</span></a></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span class="hs-special">)</span><span> </span><a name="local-1627853235"><a href="#local-1627853235"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-1627853236"><a href="#local-1627853236"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#opt_co4_wrap"><span class="hs-identifier hs-var">opt_co4_wrap</span></a><span> </span><a href="#local-1627853233"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627853234"><span class="hs-identifier hs-var">sym</span></a><span> </span><span class="hs-identifier hs-var">True</span><span>  </span><a href="#local-1627853235"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-1627853236"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-148"></a><span>  </span><span class="hs-comment">-- if mrole is Just Nominal, that can't be a downgrade, so we can ignore</span><span>
</span><a name="line-149"></a><span class="hs-identifier">opt_co3</span><span> </span><a name="local-1627853237"><a href="#local-1627853237"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-1627853238"><a href="#local-1627853238"><span class="hs-identifier">sym</span></a></a><span> </span><span class="hs-identifier">_</span><span>                       </span><a name="local-1627853239"><a href="#local-1627853239"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-1627853240"><a href="#local-1627853240"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#opt_co4_wrap"><span class="hs-identifier hs-var">opt_co4_wrap</span></a><span> </span><a href="#local-1627853237"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627853238"><span class="hs-identifier hs-var">sym</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-1627853239"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-1627853240"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-150"></a><span>
</span><a name="line-151"></a><span class="hs-comment">-- See Note [Optimising coercion optimisation]</span><span>
</span><a name="line-152"></a><span class="hs-comment">-- | Optimize a non-phantom coercion.</span><span>
</span><a name="line-153"></a><span class="hs-identifier">opt_co4</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">opt_co4_wrap</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OptCoercion.html#SymFlag"><span class="hs-identifier hs-type">SymFlag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OptCoercion.html#ReprFlag"><span class="hs-identifier hs-type">ReprFlag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OptCoercion.html#NormalCo"><span class="hs-identifier hs-type">NormalCo</span></a><span>
</span><a name="line-154"></a><span>
</span><a name="line-155"></a><a name="opt_co4_wrap"><a href="OptCoercion.html#opt_co4_wrap"><span class="hs-identifier">opt_co4_wrap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#opt_co4"><span class="hs-identifier hs-var">opt_co4</span></a><span>
</span><a name="line-156"></a><span class="hs-comment">{-
opt_co4_wrap env sym rep r co
  = pprTrace &quot;opt_co4_wrap {&quot;
    ( vcat [ text &quot;Sym:&quot; &lt;+&gt; ppr sym
           , text &quot;Rep:&quot; &lt;+&gt; ppr rep
           , text &quot;Role:&quot; &lt;+&gt; ppr r
           , text &quot;Co:&quot; &lt;+&gt; ppr co ]) $
    ASSERT( r == coercionRole co )
    let result = opt_co4 env sym rep r co in
    pprTrace &quot;opt_co4_wrap }&quot; (ppr co $$ text &quot;---&quot; $$ ppr result) $
    result
-}</span><span>
</span><a name="line-168"></a><span>
</span><a name="line-169"></a><a name="opt_co4"><a href="OptCoercion.html#opt_co4"><span class="hs-identifier">opt_co4</span></a></a><span> </span><a name="local-1627853241"><a href="#local-1627853241"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-identifier">_</span><span>   </span><a name="local-1627853242"><a href="#local-1627853242"><span class="hs-identifier">rep</span></a></a><span> </span><a name="local-1627853243"><a href="#local-1627853243"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Refl"><span class="hs-identifier hs-var">Refl</span></a><span> </span><a name="local-1627853244"><a href="#local-1627853244"><span class="hs-identifier">_r</span></a></a><span> </span><a name="local-1627853245"><a href="#local-1627853245"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-170"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">_r</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;Expected role:&quot;</span><span> </span><a href="Outputable.html#assertPprPanic"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#assertPprPanic"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="Outputable.html#assertPprPanic"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-operator">$$</span><span>
</span><a name="line-171"></a><span>                      </span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;Found role:&quot;</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">_r</span><span>   </span><span class="hs-operator">$$</span><span>
</span><a name="line-172"></a><span>                      </span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;Type:&quot;</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">ty</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-173"></a><span>    </span><a href="Coercion.html#liftCoSubst"><span class="hs-identifier hs-var">liftCoSubst</span></a><span> </span><span class="hs-special">(</span><a href="OptCoercion.html#chooseRole"><span class="hs-identifier hs-var">chooseRole</span></a><span> </span><a href="#local-1627853242"><span class="hs-identifier hs-var">rep</span></a><span> </span><a href="#local-1627853243"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627853241"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627853245"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-174"></a><span>
</span><a name="line-175"></a><span class="hs-identifier">opt_co4</span><span> </span><a name="local-1627853246"><a href="#local-1627853246"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-1627853247"><a href="#local-1627853247"><span class="hs-identifier">sym</span></a></a><span> </span><a name="local-1627853248"><a href="#local-1627853248"><span class="hs-identifier">rep</span></a></a><span> </span><a name="local-1627853249"><a href="#local-1627853249"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#SymCo"><span class="hs-identifier hs-var">SymCo</span></a><span> </span><a name="local-1627853250"><a href="#local-1627853250"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#opt_co4_wrap"><span class="hs-identifier hs-var">opt_co4_wrap</span></a><span> </span><a href="#local-1627853246"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-1627853247"><span class="hs-identifier hs-var">sym</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627853248"><span class="hs-identifier hs-var">rep</span></a><span> </span><a href="#local-1627853249"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-1627853250"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-176"></a><span>  </span><span class="hs-comment">-- surprisingly, we don't have to do anything to the env here. This is</span><span>
</span><a name="line-177"></a><span>  </span><span class="hs-comment">-- because any &quot;lifting&quot; substitutions in the env are tied to ForAllCos,</span><span>
</span><a name="line-178"></a><span>  </span><span class="hs-comment">-- which treat their left and right sides differently. We don't want to</span><span>
</span><a name="line-179"></a><span>  </span><span class="hs-comment">-- exchange them.</span><span>
</span><a name="line-180"></a><span>
</span><a name="line-181"></a><span class="hs-identifier">opt_co4</span><span> </span><a name="local-1627853251"><a href="#local-1627853251"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-1627853252"><a href="#local-1627853252"><span class="hs-identifier">sym</span></a></a><span> </span><a name="local-1627853253"><a href="#local-1627853253"><span class="hs-identifier">rep</span></a></a><span> </span><a name="local-1627853254"><a href="#local-1627853254"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-1627853255"><a href="#local-1627853255"><span class="hs-identifier">g</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TyCoRep.html#TyConAppCo"><span class="hs-identifier hs-var">TyConAppCo</span></a><span> </span><a name="local-1627853256"><a href="#local-1627853256"><span class="hs-identifier">_r</span></a></a><span> </span><a name="local-1627853257"><a href="#local-1627853257"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-1627853258"><a href="#local-1627853258"><span class="hs-identifier">cos</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-182"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="Util.html#debugIsOn"><span class="hs-operator hs-var">==</span></a><span> </span><span class="hs-identifier hs-var">_r</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-183"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-1627853253"><span class="hs-identifier hs-var">rep</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627853254"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-184"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-185"></a><span>        </span><a href="Coercion.html#mkTyConAppCo"><span class="hs-identifier hs-var">mkTyConAppCo</span></a><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span> </span><a href="#local-1627853257"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-186"></a><span>                     </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zipWith3"><span class="hs-identifier hs-var">zipWith3</span></a><span> </span><span class="hs-special">(</span><a href="OptCoercion.html#opt_co3"><span class="hs-identifier hs-var">opt_co3</span></a><span> </span><a href="#local-1627853251"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627853252"><span class="hs-identifier hs-var">sym</span></a><span class="hs-special">)</span><span>
</span><a name="line-187"></a><span>                               </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#tyConRolesRepresentational"><span class="hs-identifier hs-var">tyConRolesRepresentational</span></a><span> </span><a href="#local-1627853257"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-188"></a><span>                               </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#repeat"><span class="hs-identifier hs-var">repeat</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span class="hs-special">)</span><span>
</span><a name="line-189"></a><span>                               </span><a href="#local-1627853258"><span class="hs-identifier hs-var">cos</span></a><span class="hs-special">)</span><span>
</span><a name="line-190"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-191"></a><span>        </span><a href="Coercion.html#mkTyConAppCo"><span class="hs-identifier hs-var">mkTyConAppCo</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-1627853257"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><a href="OptCoercion.html#opt_co4_wrap"><span class="hs-identifier hs-var">opt_co4_wrap</span></a><span> </span><a href="#local-1627853251"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627853252"><span class="hs-identifier hs-var">sym</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627853258"><span class="hs-identifier hs-var">cos</span></a><span class="hs-special">)</span><span>
</span><a name="line-192"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-193"></a><span>                      </span><span class="hs-comment">-- must use opt_co2 here, because some roles may be P</span><span>
</span><a name="line-194"></a><span>                      </span><span class="hs-comment">-- See Note [Optimising coercion optimisation]</span><span>
</span><a name="line-195"></a><span>        </span><a href="Coercion.html#mkTyConAppCo"><span class="hs-identifier hs-var">mkTyConAppCo</span></a><span> </span><a href="#local-1627853254"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-1627853257"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zipWith"><span class="hs-identifier hs-var">zipWith</span></a><span> </span><span class="hs-special">(</span><a href="OptCoercion.html#opt_co2"><span class="hs-identifier hs-var">opt_co2</span></a><span> </span><a href="#local-1627853251"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627853252"><span class="hs-identifier hs-var">sym</span></a><span class="hs-special">)</span><span>
</span><a name="line-196"></a><span>                                   </span><span class="hs-special">(</span><a href="Coercion.html#tyConRolesRepresentational"><span class="hs-identifier hs-var">tyConRolesRepresentational</span></a><span> </span><a href="#local-1627853257"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- the current roles</span><span>
</span><a name="line-197"></a><span>                                   </span><a href="#local-1627853258"><span class="hs-identifier hs-var">cos</span></a><span class="hs-special">)</span><span>
</span><a name="line-198"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a href="CoAxiom.html#Phantom"><span class="hs-identifier hs-var">Phantom</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;opt_co4 sees a phantom!&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1627853255"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">)</span><span>
</span><a name="line-199"></a><span>
</span><a name="line-200"></a><span class="hs-identifier">opt_co4</span><span> </span><a name="local-1627853259"><a href="#local-1627853259"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-1627853260"><a href="#local-1627853260"><span class="hs-identifier">sym</span></a></a><span> </span><a name="local-1627853261"><a href="#local-1627853261"><span class="hs-identifier">rep</span></a></a><span> </span><a name="local-1627853262"><a href="#local-1627853262"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AppCo"><span class="hs-identifier hs-var">AppCo</span></a><span> </span><a name="local-1627853263"><a href="#local-1627853263"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-1627853264"><a href="#local-1627853264"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-201"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkAppCo"><span class="hs-identifier hs-var">mkAppCo</span></a><span> </span><span class="hs-special">(</span><a href="OptCoercion.html#opt_co4_wrap"><span class="hs-identifier hs-var">opt_co4_wrap</span></a><span> </span><a href="#local-1627853259"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627853260"><span class="hs-identifier hs-var">sym</span></a><span> </span><a href="#local-1627853261"><span class="hs-identifier hs-var">rep</span></a><span> </span><a href="#local-1627853262"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-1627853263"><span class="hs-identifier hs-var">co1</span></a><span class="hs-special">)</span><span>
</span><a name="line-202"></a><span>            </span><span class="hs-special">(</span><a href="OptCoercion.html#opt_co4_wrap"><span class="hs-identifier hs-var">opt_co4_wrap</span></a><span> </span><a href="#local-1627853259"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627853260"><span class="hs-identifier hs-var">sym</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-1627853264"><span class="hs-identifier hs-var">co2</span></a><span class="hs-special">)</span><span>
</span><a name="line-203"></a><span>
</span><a name="line-204"></a><span class="hs-identifier">opt_co4</span><span> </span><a name="local-1627853265"><a href="#local-1627853265"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-1627853266"><a href="#local-1627853266"><span class="hs-identifier">sym</span></a></a><span> </span><a name="local-1627853267"><a href="#local-1627853267"><span class="hs-identifier">rep</span></a></a><span> </span><a name="local-1627853268"><a href="#local-1627853268"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ForAllCo"><span class="hs-identifier hs-var">ForAllCo</span></a><span> </span><a name="local-1627853269"><a href="#local-1627853269"><span class="hs-identifier">tv</span></a></a><span> </span><a name="local-1627853270"><a href="#local-1627853270"><span class="hs-identifier">k_co</span></a></a><span> </span><a name="local-1627853271"><a href="#local-1627853271"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-205"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="OptCoercion.html#optForAllCoBndr"><span class="hs-identifier hs-var">optForAllCoBndr</span></a><span> </span><a href="#local-1627853265"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627853266"><span class="hs-identifier hs-var">sym</span></a><span> </span><a href="#local-1627853269"><span class="hs-identifier hs-var">tv</span></a><span> </span><a href="#local-1627853270"><span class="hs-identifier hs-var">k_co</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-206"></a><span>      </span><span class="hs-special">(</span><a name="local-1627853272"><a href="#local-1627853272"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853273"><a href="#local-1627853273"><span class="hs-identifier">tv'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853274"><a href="#local-1627853274"><span class="hs-identifier">k_co'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#mkForAllCo"><span class="hs-identifier hs-var">mkForAllCo</span></a><span> </span><a href="#local-1627853273"><span class="hs-identifier hs-var">tv'</span></a><span> </span><a href="#local-1627853274"><span class="hs-identifier hs-var">k_co'</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-207"></a><span>                            </span><a href="OptCoercion.html#opt_co4_wrap"><span class="hs-identifier hs-var">opt_co4_wrap</span></a><span> </span><a href="#local-1627853272"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-1627853266"><span class="hs-identifier hs-var">sym</span></a><span> </span><a href="#local-1627853267"><span class="hs-identifier hs-var">rep</span></a><span> </span><a href="#local-1627853268"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-1627853271"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-208"></a><span>     </span><span class="hs-comment">-- Use the &quot;mk&quot; functions to check for nested Refls</span><span>
</span><a name="line-209"></a><span>
</span><a name="line-210"></a><span class="hs-identifier">opt_co4</span><span> </span><a name="local-1627853275"><a href="#local-1627853275"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-1627853276"><a href="#local-1627853276"><span class="hs-identifier">sym</span></a></a><span> </span><a name="local-1627853277"><a href="#local-1627853277"><span class="hs-identifier">rep</span></a></a><span> </span><a name="local-1627853278"><a href="#local-1627853278"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CoVarCo"><span class="hs-identifier hs-var">CoVarCo</span></a><span> </span><a name="local-1627853279"><a href="#local-1627853279"><span class="hs-identifier">cv</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-211"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1627853280"><a href="#local-1627853280"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TyCoRep.html#lookupCoVar"><span class="hs-identifier hs-var">lookupCoVar</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#lcTCvSubst"><span class="hs-identifier hs-var">lcTCvSubst</span></a><span> </span><a href="#local-1627853275"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627853279"><span class="hs-identifier hs-var">cv</span></a><span>
</span><a name="line-212"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#opt_co4_wrap"><span class="hs-identifier hs-var">opt_co4_wrap</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#zapLiftingContext"><span class="hs-identifier hs-var">zapLiftingContext</span></a><span> </span><a href="#local-1627853275"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627853276"><span class="hs-identifier hs-var">sym</span></a><span> </span><a href="#local-1627853277"><span class="hs-identifier hs-var">rep</span></a><span> </span><a href="#local-1627853278"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-1627853280"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-213"></a><span>
</span><a name="line-214"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1627853281"><a href="#local-1627853281"><span class="hs-identifier">cv1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="VarEnv.html#lookupInScope"><span class="hs-identifier hs-var">lookupInScope</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#lcInScopeSet"><span class="hs-identifier hs-var">lcInScopeSet</span></a><span> </span><a href="#local-1627853275"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627853279"><span class="hs-identifier hs-var">cv</span></a><span>
</span><a name="line-215"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isCoVar</span><span> </span><span class="hs-identifier hs-var">cv1</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier">wrapRole</span><span> </span><span class="hs-identifier">rep</span><span> </span><span class="hs-identifier">r</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">wrapSym</span><span> </span><a href="Panic.html#assertPanic"><span class="hs-identifier hs-var">sym</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">CoVarCo</span><span> </span><span class="hs-identifier">cv1</span><span class="hs-special">)</span><span>
</span><a name="line-216"></a><span>                </span><span class="hs-comment">-- cv1 might have a substituted kind!</span><span>
</span><a name="line-217"></a><span>
</span><a name="line-218"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">WARN</span><span class="hs-special">(</span><span> </span><a href="Outputable.html#warnPprTrace"><span class="hs-identifier hs-var">True</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;opt_co: not in scope:&quot;</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">cv</span><span> </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">env</span><span class="hs-special">)</span><span>
</span><a name="line-219"></a><span>                </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isCoVar</span><span> </span><span class="hs-identifier hs-var">cv</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-220"></a><span>                </span><a href="OptCoercion.html#wrapRole"><span class="hs-identifier hs-var">wrapRole</span></a><span> </span><a href="#local-1627853277"><span class="hs-identifier hs-var">rep</span></a><span> </span><a href="#local-1627853278"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="OptCoercion.html#wrapSym"><span class="hs-identifier hs-var">wrapSym</span></a><span> </span><a href="#local-1627853276"><span class="hs-identifier hs-var">sym</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CoVarCo"><span class="hs-identifier hs-var">CoVarCo</span></a><span> </span><a href="#local-1627853279"><span class="hs-identifier hs-var">cv</span></a><span class="hs-special">)</span><span>
</span><a name="line-221"></a><span>
</span><a name="line-222"></a><span class="hs-identifier">opt_co4</span><span> </span><a name="local-1627853282"><a href="#local-1627853282"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-1627853283"><a href="#local-1627853283"><span class="hs-identifier">sym</span></a></a><span> </span><a name="local-1627853284"><a href="#local-1627853284"><span class="hs-identifier">rep</span></a></a><span> </span><a name="local-1627853285"><a href="#local-1627853285"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AxiomInstCo"><span class="hs-identifier hs-var">AxiomInstCo</span></a><span> </span><a name="local-1627853286"><a href="#local-1627853286"><span class="hs-identifier">con</span></a></a><span> </span><a name="local-1627853287"><a href="#local-1627853287"><span class="hs-identifier">ind</span></a></a><span> </span><a name="local-1627853288"><a href="#local-1627853288"><span class="hs-identifier">cos</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-223"></a><span>    </span><span class="hs-comment">-- Do *not* push sym inside top-level axioms</span><span>
</span><a name="line-224"></a><span>    </span><span class="hs-comment">-- e.g. if g is a top-level axiom</span><span>
</span><a name="line-225"></a><span>    </span><span class="hs-comment">--   g a : f a ~ a</span><span>
</span><a name="line-226"></a><span>    </span><span class="hs-comment">-- then (sym (g ty)) /= g (sym ty) !!</span><span>
</span><a name="line-227"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="Util.html#debugIsOn"><span class="hs-operator hs-var">==</span></a><span> </span><span class="hs-identifier">coAxiomRole</span><span> </span><span class="hs-identifier">con</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-228"></a><span>    </span><a href="OptCoercion.html#wrapRole"><span class="hs-identifier hs-var">wrapRole</span></a><span> </span><a href="#local-1627853284"><span class="hs-identifier hs-var">rep</span></a><span> </span><span class="hs-special">(</span><a href="CoAxiom.html#coAxiomRole"><span class="hs-identifier hs-var">coAxiomRole</span></a><span> </span><a href="#local-1627853286"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-229"></a><span>    </span><a href="OptCoercion.html#wrapSym"><span class="hs-identifier hs-var">wrapSym</span></a><span> </span><a href="#local-1627853283"><span class="hs-identifier hs-var">sym</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-230"></a><span>                       </span><span class="hs-comment">-- some sub-cos might be P: use opt_co2</span><span>
</span><a name="line-231"></a><span>                       </span><span class="hs-comment">-- See Note [Optimising coercion optimisation]</span><span>
</span><a name="line-232"></a><span>    </span><a href="TyCoRep.html#AxiomInstCo"><span class="hs-identifier hs-var">AxiomInstCo</span></a><span> </span><a href="#local-1627853286"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-1627853287"><span class="hs-identifier hs-var">ind</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zipWith"><span class="hs-identifier hs-var">zipWith</span></a><span> </span><span class="hs-special">(</span><a href="OptCoercion.html#opt_co2"><span class="hs-identifier hs-var">opt_co2</span></a><span> </span><a href="#local-1627853282"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span>
</span><a name="line-233"></a><span>                                 </span><span class="hs-special">(</span><a href="CoAxiom.html#coAxBranchRoles"><span class="hs-identifier hs-var">coAxBranchRoles</span></a><span> </span><span class="hs-special">(</span><a href="CoAxiom.html#coAxiomNthBranch"><span class="hs-identifier hs-var">coAxiomNthBranch</span></a><span> </span><a href="#local-1627853286"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-1627853287"><span class="hs-identifier hs-var">ind</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-234"></a><span>                                 </span><a href="#local-1627853288"><span class="hs-identifier hs-var">cos</span></a><span class="hs-special">)</span><span>
</span><a name="line-235"></a><span>      </span><span class="hs-comment">-- Note that the_co does *not* have sym pushed into it</span><span>
</span><a name="line-236"></a><span>
</span><a name="line-237"></a><span class="hs-identifier">opt_co4</span><span> </span><a name="local-1627853289"><a href="#local-1627853289"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-1627853290"><a href="#local-1627853290"><span class="hs-identifier">sym</span></a></a><span> </span><a name="local-1627853291"><a href="#local-1627853291"><span class="hs-identifier">rep</span></a></a><span> </span><a name="local-1627853292"><a href="#local-1627853292"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#UnivCo"><span class="hs-identifier hs-var">UnivCo</span></a><span> </span><a name="local-1627853293"><a href="#local-1627853293"><span class="hs-identifier">prov</span></a></a><span> </span><a name="local-1627853294"><a href="#local-1627853294"><span class="hs-identifier">_r</span></a></a><span> </span><a name="local-1627853295"><a href="#local-1627853295"><span class="hs-identifier">t1</span></a></a><span> </span><a name="local-1627853296"><a href="#local-1627853296"><span class="hs-identifier">t2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-238"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="Util.html#debugIsOn"><span class="hs-operator hs-var">==</span></a><span> </span><span class="hs-identifier hs-var">_r</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-239"></a><span>    </span><a href="OptCoercion.html#opt_univ"><span class="hs-identifier hs-var">opt_univ</span></a><span> </span><a href="#local-1627853289"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627853290"><span class="hs-identifier hs-var">sym</span></a><span> </span><a href="#local-1627853293"><span class="hs-identifier hs-var">prov</span></a><span> </span><span class="hs-special">(</span><a href="OptCoercion.html#chooseRole"><span class="hs-identifier hs-var">chooseRole</span></a><span> </span><a href="#local-1627853291"><span class="hs-identifier hs-var">rep</span></a><span> </span><a href="#local-1627853292"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627853295"><span class="hs-identifier hs-var">t1</span></a><span> </span><a href="#local-1627853296"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-240"></a><span>
</span><a name="line-241"></a><span class="hs-identifier">opt_co4</span><span> </span><a name="local-1627853297"><a href="#local-1627853297"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-1627853298"><a href="#local-1627853298"><span class="hs-identifier">sym</span></a></a><span> </span><a name="local-1627853299"><a href="#local-1627853299"><span class="hs-identifier">rep</span></a></a><span> </span><a name="local-1627853300"><a href="#local-1627853300"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TransCo"><span class="hs-identifier hs-var">TransCo</span></a><span> </span><a name="local-1627853301"><a href="#local-1627853301"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-1627853302"><a href="#local-1627853302"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-242"></a><span>                      </span><span class="hs-comment">-- sym (g `o` h) = sym h `o` sym g</span><span>
</span><a name="line-243"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627853298"><span class="hs-identifier hs-var">sym</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#opt_trans"><span class="hs-identifier hs-var">opt_trans</span></a><span> </span><a href="#local-1627853305"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-1627853304"><span class="hs-identifier hs-var">co2'</span></a><span> </span><a href="#local-1627853303"><span class="hs-identifier hs-var">co1'</span></a><span>
</span><a name="line-244"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#opt_trans"><span class="hs-identifier hs-var">opt_trans</span></a><span> </span><a href="#local-1627853305"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-1627853303"><span class="hs-identifier hs-var">co1'</span></a><span> </span><a href="#local-1627853304"><span class="hs-identifier hs-var">co2'</span></a><span>
</span><a name="line-245"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-246"></a><span>    </span><a name="local-1627853303"><a href="#local-1627853303"><span class="hs-identifier">co1'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#opt_co4_wrap"><span class="hs-identifier hs-var">opt_co4_wrap</span></a><span> </span><a href="#local-1627853297"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627853298"><span class="hs-identifier hs-var">sym</span></a><span> </span><a href="#local-1627853299"><span class="hs-identifier hs-var">rep</span></a><span> </span><a href="#local-1627853300"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-1627853301"><span class="hs-identifier hs-var">co1</span></a><span>
</span><a name="line-247"></a><span>    </span><a name="local-1627853304"><a href="#local-1627853304"><span class="hs-identifier">co2'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#opt_co4_wrap"><span class="hs-identifier hs-var">opt_co4_wrap</span></a><span> </span><a href="#local-1627853297"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627853298"><span class="hs-identifier hs-var">sym</span></a><span> </span><a href="#local-1627853299"><span class="hs-identifier hs-var">rep</span></a><span> </span><a href="#local-1627853300"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-1627853302"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-248"></a><span>    </span><a name="local-1627853305"><a href="#local-1627853305"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#lcInScopeSet"><span class="hs-identifier hs-var">lcInScopeSet</span></a><span> </span><a href="#local-1627853297"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-249"></a><span>
</span><a name="line-250"></a><span>
</span><a name="line-251"></a><span class="hs-identifier">opt_co4</span><span> </span><a name="local-1627853306"><a href="#local-1627853306"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-1627853307"><a href="#local-1627853307"><span class="hs-identifier">sym</span></a></a><span> </span><a name="local-1627853308"><a href="#local-1627853308"><span class="hs-identifier">rep</span></a></a><span> </span><a name="local-1627853309"><a href="#local-1627853309"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-1627853310"><a href="#local-1627853310"><span class="hs-identifier">co</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TyCoRep.html#NthCo"><span class="hs-identifier hs-var">NthCo</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#opt_nth_co"><span class="hs-identifier hs-var">opt_nth_co</span></a><span> </span><a href="#local-1627853306"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627853307"><span class="hs-identifier hs-var">sym</span></a><span> </span><a href="#local-1627853308"><span class="hs-identifier hs-var">rep</span></a><span> </span><a href="#local-1627853309"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-1627853310"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-252"></a><span>
</span><a name="line-253"></a><span class="hs-identifier">opt_co4</span><span> </span><a name="local-1627853311"><a href="#local-1627853311"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-1627853312"><a href="#local-1627853312"><span class="hs-identifier">sym</span></a></a><span> </span><a name="local-1627853313"><a href="#local-1627853313"><span class="hs-identifier">rep</span></a></a><span> </span><a name="local-1627853314"><a href="#local-1627853314"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#LRCo"><span class="hs-identifier hs-var">LRCo</span></a><span> </span><a name="local-1627853315"><a href="#local-1627853315"><span class="hs-identifier">lr</span></a></a><span> </span><a name="local-1627853316"><a href="#local-1627853316"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-254"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1627853321"><a href="#local-1627853321"><span class="hs-identifier">pr_co</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#splitAppCo_maybe"><span class="hs-identifier hs-var">splitAppCo_maybe</span></a><span> </span><a href="#local-1627853316"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-255"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="Util.html#debugIsOn"><span class="hs-operator hs-var">==</span></a><span> </span><span class="hs-identifier">Nominal</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-256"></a><span>    </span><a href="OptCoercion.html#opt_co4_wrap"><span class="hs-identifier hs-var">opt_co4_wrap</span></a><span> </span><a href="#local-1627853311"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627853312"><span class="hs-identifier hs-var">sym</span></a><span> </span><a href="#local-1627853313"><span class="hs-identifier hs-var">rep</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627853318"><span class="hs-identifier hs-var">pick_lr</span></a><span> </span><a href="#local-1627853315"><span class="hs-identifier hs-var">lr</span></a><span> </span><a href="#local-1627853321"><span class="hs-identifier hs-var">pr_co</span></a><span class="hs-special">)</span><span>
</span><a name="line-257"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1627853322"><a href="#local-1627853322"><span class="hs-identifier">pr_co</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#splitAppCo_maybe"><span class="hs-identifier hs-var">splitAppCo_maybe</span></a><span> </span><a href="#local-1627853317"><span class="hs-identifier hs-var">co'</span></a><span>
</span><a name="line-258"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="Util.html#debugIsOn"><span class="hs-operator hs-var">==</span></a><span> </span><span class="hs-identifier">Nominal</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-259"></a><span>    </span><span class="hs-keyword">if</span><span> </span><a href="#local-1627853313"><span class="hs-identifier hs-var">rep</span></a><span>
</span><a name="line-260"></a><span>    </span><span class="hs-keyword">then</span><span> </span><a href="OptCoercion.html#opt_co4_wrap"><span class="hs-identifier hs-var">opt_co4_wrap</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#zapLiftingContext"><span class="hs-identifier hs-var">zapLiftingContext</span></a><span> </span><a href="#local-1627853311"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627853318"><span class="hs-identifier hs-var">pick_lr</span></a><span> </span><a href="#local-1627853315"><span class="hs-identifier hs-var">lr</span></a><span> </span><a href="#local-1627853322"><span class="hs-identifier hs-var">pr_co</span></a><span class="hs-special">)</span><span>
</span><a name="line-261"></a><span>    </span><span class="hs-keyword">else</span><span> </span><a href="#local-1627853318"><span class="hs-identifier hs-var">pick_lr</span></a><span> </span><a href="#local-1627853315"><span class="hs-identifier hs-var">lr</span></a><span> </span><a href="#local-1627853322"><span class="hs-identifier hs-var">pr_co</span></a><span>
</span><a name="line-262"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-263"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#wrapRole"><span class="hs-identifier hs-var">wrapRole</span></a><span> </span><a href="#local-1627853313"><span class="hs-identifier hs-var">rep</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TyCoRep.html#LRCo"><span class="hs-identifier hs-var">LRCo</span></a><span> </span><a href="#local-1627853315"><span class="hs-identifier hs-var">lr</span></a><span> </span><a href="#local-1627853317"><span class="hs-identifier hs-var">co'</span></a><span>
</span><a name="line-264"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-265"></a><span>    </span><a name="local-1627853317"><a href="#local-1627853317"><span class="hs-identifier">co'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#opt_co4_wrap"><span class="hs-identifier hs-var">opt_co4_wrap</span></a><span> </span><a href="#local-1627853311"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627853312"><span class="hs-identifier hs-var">sym</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-1627853316"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-266"></a><span>
</span><a name="line-267"></a><span>    </span><a name="local-1627853318"><a href="#local-1627853318"><span class="hs-identifier">pick_lr</span></a></a><span> </span><a href="TyCoRep.html#CLeft"><span class="hs-identifier hs-var">CLeft</span></a><span>  </span><span class="hs-special">(</span><a name="local-1627853319"><a href="#local-1627853319"><span class="hs-identifier">l</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627853319"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-268"></a><span>    </span><span class="hs-identifier">pick_lr</span><span> </span><a href="TyCoRep.html#CRight"><span class="hs-identifier hs-var">CRight</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-1627853320"><a href="#local-1627853320"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627853320"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-269"></a><span>
</span><a name="line-270"></a><span class="hs-comment">-- See Note [Optimising InstCo]</span><span>
</span><a name="line-271"></a><span class="hs-identifier">opt_co4</span><span> </span><a name="local-1627853323"><a href="#local-1627853323"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-1627853324"><a href="#local-1627853324"><span class="hs-identifier">sym</span></a></a><span> </span><a name="local-1627853325"><a href="#local-1627853325"><span class="hs-identifier">rep</span></a></a><span> </span><a name="local-1627853326"><a href="#local-1627853326"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#InstCo"><span class="hs-identifier hs-var">InstCo</span></a><span> </span><a name="local-1627853327"><a href="#local-1627853327"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-1627853328"><a href="#local-1627853328"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-272"></a><span>    </span><span class="hs-comment">-- forall over type...</span><span>
</span><a name="line-273"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1627853332"><a href="#local-1627853332"><span class="hs-identifier">tv</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853333"><a href="#local-1627853333"><span class="hs-identifier">kind_co</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853334"><a href="#local-1627853334"><span class="hs-identifier">co_body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#splitForAllCo_maybe"><span class="hs-identifier hs-var">splitForAllCo_maybe</span></a><span> </span><a href="#local-1627853327"><span class="hs-identifier hs-var">co1</span></a><span>
</span><a name="line-274"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#opt_co4_wrap"><span class="hs-identifier hs-var">opt_co4_wrap</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#extendLiftingContext"><span class="hs-identifier hs-var">extendLiftingContext</span></a><span> </span><a href="#local-1627853323"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627853332"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-275"></a><span>                    </span><span class="hs-special">(</span><a href="#local-1627853331"><span class="hs-identifier hs-var">arg'</span></a><span> </span><span class="hs-special">`</span><a href="Coercion.html#mkCoherenceRightCo"><span class="hs-identifier hs-var">mkCoherenceRightCo</span></a><span class="hs-special">`</span><span> </span><a href="Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a><span> </span><a href="#local-1627853333"><span class="hs-identifier hs-var">kind_co</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-276"></a><span>                 </span><a href="#local-1627853324"><span class="hs-identifier hs-var">sym</span></a><span> </span><a href="#local-1627853325"><span class="hs-identifier hs-var">rep</span></a><span> </span><a href="#local-1627853326"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-1627853334"><span class="hs-identifier hs-var">co_body</span></a><span>
</span><a name="line-277"></a><span>
</span><a name="line-278"></a><span>    </span><span class="hs-comment">-- See if it is a forall after optimization</span><span>
</span><a name="line-279"></a><span>    </span><span class="hs-comment">-- If so, do an inefficient one-variable substitution, then re-optimize</span><span>
</span><a name="line-280"></a><span>
</span><a name="line-281"></a><span>    </span><span class="hs-comment">-- forall over type...</span><span>
</span><a name="line-282"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1627853335"><a href="#local-1627853335"><span class="hs-identifier">tv'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853336"><a href="#local-1627853336"><span class="hs-identifier">kind_co'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853337"><a href="#local-1627853337"><span class="hs-identifier">co_body'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#splitForAllCo_maybe"><span class="hs-identifier hs-var">splitForAllCo_maybe</span></a><span> </span><a href="#local-1627853329"><span class="hs-identifier hs-var">co1'</span></a><span>
</span><a name="line-283"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#opt_co4_wrap"><span class="hs-identifier hs-var">opt_co4_wrap</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#extendLiftingContext"><span class="hs-identifier hs-var">extendLiftingContext</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#zapLiftingContext"><span class="hs-identifier hs-var">zapLiftingContext</span></a><span> </span><a href="#local-1627853323"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627853335"><span class="hs-identifier hs-var">tv'</span></a><span>
</span><a name="line-284"></a><span>                    </span><span class="hs-special">(</span><a href="#local-1627853331"><span class="hs-identifier hs-var">arg'</span></a><span> </span><span class="hs-special">`</span><a href="Coercion.html#mkCoherenceRightCo"><span class="hs-identifier hs-var">mkCoherenceRightCo</span></a><span class="hs-special">`</span><span> </span><a href="Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a><span> </span><a href="#local-1627853336"><span class="hs-identifier hs-var">kind_co'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-285"></a><span>            </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-1627853330"><span class="hs-identifier hs-var">r'</span></a><span> </span><a href="#local-1627853337"><span class="hs-identifier hs-var">co_body'</span></a><span>
</span><a name="line-286"></a><span>
</span><a name="line-287"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#InstCo"><span class="hs-identifier hs-var">InstCo</span></a><span> </span><a href="#local-1627853329"><span class="hs-identifier hs-var">co1'</span></a><span> </span><a href="#local-1627853331"><span class="hs-identifier hs-var">arg'</span></a><span>
</span><a name="line-288"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-289"></a><span>    </span><a name="local-1627853329"><a href="#local-1627853329"><span class="hs-identifier">co1'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#opt_co4_wrap"><span class="hs-identifier hs-var">opt_co4_wrap</span></a><span> </span><a href="#local-1627853323"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627853324"><span class="hs-identifier hs-var">sym</span></a><span> </span><a href="#local-1627853325"><span class="hs-identifier hs-var">rep</span></a><span> </span><a href="#local-1627853326"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-1627853327"><span class="hs-identifier hs-var">co1</span></a><span>
</span><a name="line-290"></a><span>    </span><a name="local-1627853330"><a href="#local-1627853330"><span class="hs-identifier">r'</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#chooseRole"><span class="hs-identifier hs-var">chooseRole</span></a><span> </span><a href="#local-1627853325"><span class="hs-identifier hs-var">rep</span></a><span> </span><a href="#local-1627853326"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-291"></a><span>    </span><a name="local-1627853331"><a href="#local-1627853331"><span class="hs-identifier">arg'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#opt_co4_wrap"><span class="hs-identifier hs-var">opt_co4_wrap</span></a><span> </span><a href="#local-1627853323"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627853324"><span class="hs-identifier hs-var">sym</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-1627853328"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-292"></a><span>
</span><a name="line-293"></a><span class="hs-identifier">opt_co4</span><span> </span><a name="local-1627853338"><a href="#local-1627853338"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-1627853339"><a href="#local-1627853339"><span class="hs-identifier">sym</span></a></a><span> </span><a name="local-1627853340"><a href="#local-1627853340"><span class="hs-identifier">rep</span></a></a><span> </span><a name="local-1627853341"><a href="#local-1627853341"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CoherenceCo"><span class="hs-identifier hs-var">CoherenceCo</span></a><span> </span><a name="local-1627853342"><a href="#local-1627853342"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-1627853343"><a href="#local-1627853343"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-294"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TyCoRep.html#TransCo"><span class="hs-identifier hs-var">TransCo</span></a><span> </span><a name="local-1627853347"><a href="#local-1627853347"><span class="hs-identifier">col1</span></a></a><span> </span><a name="local-1627853348"><a href="#local-1627853348"><span class="hs-identifier">cor1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627853342"><span class="hs-identifier hs-var">co1</span></a><span>
</span><a name="line-295"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#opt_co4_wrap"><span class="hs-identifier hs-var">opt_co4_wrap</span></a><span> </span><a href="#local-1627853338"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627853339"><span class="hs-identifier hs-var">sym</span></a><span> </span><a href="#local-1627853340"><span class="hs-identifier hs-var">rep</span></a><span> </span><a href="#local-1627853341"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkTransCo"><span class="hs-identifier hs-var">mkTransCo</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkCoherenceCo"><span class="hs-identifier hs-var">mkCoherenceCo</span></a><span> </span><a href="#local-1627853347"><span class="hs-identifier hs-var">col1</span></a><span> </span><a href="#local-1627853343"><span class="hs-identifier hs-var">co2</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627853348"><span class="hs-identifier hs-var">cor1</span></a><span class="hs-special">)</span><span>
</span><a name="line-296"></a><span>
</span><a name="line-297"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TyCoRep.html#TransCo"><span class="hs-identifier hs-var">TransCo</span></a><span> </span><a name="local-1627853349"><a href="#local-1627853349"><span class="hs-identifier">col1'</span></a></a><span> </span><a name="local-1627853350"><a href="#local-1627853350"><span class="hs-identifier">cor1'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627853344"><span class="hs-identifier hs-var">co1'</span></a><span>
</span><a name="line-298"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-1627853339"><span class="hs-identifier hs-var">sym</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="OptCoercion.html#opt_trans"><span class="hs-identifier hs-var">opt_trans</span></a><span> </span><a href="#local-1627853346"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-1627853349"><span class="hs-identifier hs-var">col1'</span></a><span>
</span><a name="line-299"></a><span>                  </span><span class="hs-special">(</span><a href="OptCoercion.html#optCoercion"><span class="hs-identifier hs-var">optCoercion</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#zapTCvSubst"><span class="hs-identifier hs-var">zapTCvSubst</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#lcTCvSubst"><span class="hs-identifier hs-var">lcTCvSubst</span></a><span> </span><a href="#local-1627853338"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-300"></a><span>                               </span><span class="hs-special">(</span><a href="Coercion.html#mkCoherenceRightCo"><span class="hs-identifier hs-var">mkCoherenceRightCo</span></a><span> </span><a href="#local-1627853350"><span class="hs-identifier hs-var">cor1'</span></a><span> </span><a href="#local-1627853345"><span class="hs-identifier hs-var">co2'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-301"></a><span>           </span><span class="hs-keyword">else</span><span> </span><a href="OptCoercion.html#opt_trans"><span class="hs-identifier hs-var">opt_trans</span></a><span> </span><a href="#local-1627853346"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkCoherenceCo"><span class="hs-identifier hs-var">mkCoherenceCo</span></a><span> </span><a href="#local-1627853349"><span class="hs-identifier hs-var">col1'</span></a><span> </span><a href="#local-1627853345"><span class="hs-identifier hs-var">co2'</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627853350"><span class="hs-identifier hs-var">cor1'</span></a><span>
</span><a name="line-302"></a><span>
</span><a name="line-303"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-304"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#wrapSym"><span class="hs-identifier hs-var">wrapSym</span></a><span> </span><a href="#local-1627853339"><span class="hs-identifier hs-var">sym</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TyCoRep.html#CoherenceCo"><span class="hs-identifier hs-var">CoherenceCo</span></a><span> </span><span class="hs-special">(</span><a href="OptCoercion.html#opt_co4_wrap"><span class="hs-identifier hs-var">opt_co4_wrap</span></a><span> </span><a href="#local-1627853338"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-1627853340"><span class="hs-identifier hs-var">rep</span></a><span> </span><a href="#local-1627853341"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-1627853342"><span class="hs-identifier hs-var">co1</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627853345"><span class="hs-identifier hs-var">co2'</span></a><span>
</span><a name="line-305"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-1627853344"><a href="#local-1627853344"><span class="hs-identifier">co1'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#opt_co4_wrap"><span class="hs-identifier hs-var">opt_co4_wrap</span></a><span> </span><a href="#local-1627853338"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627853339"><span class="hs-identifier hs-var">sym</span></a><span>   </span><a href="#local-1627853340"><span class="hs-identifier hs-var">rep</span></a><span>   </span><a href="#local-1627853341"><span class="hs-identifier hs-var">r</span></a><span>       </span><a href="#local-1627853342"><span class="hs-identifier hs-var">co1</span></a><span>
</span><a name="line-306"></a><span>        </span><a name="local-1627853345"><a href="#local-1627853345"><span class="hs-identifier">co2'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#opt_co4_wrap"><span class="hs-identifier hs-var">opt_co4_wrap</span></a><span> </span><a href="#local-1627853338"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-1627853343"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-307"></a><span>        </span><a name="local-1627853346"><a href="#local-1627853346"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#lcInScopeSet"><span class="hs-identifier hs-var">lcInScopeSet</span></a><span> </span><a href="#local-1627853338"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-308"></a><span>
</span><a name="line-309"></a><span class="hs-identifier">opt_co4</span><span> </span><a name="local-1627853351"><a href="#local-1627853351"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-1627853352"><a href="#local-1627853352"><span class="hs-identifier">sym</span></a></a><span> </span><a name="local-1627853353"><a href="#local-1627853353"><span class="hs-identifier">_rep</span></a></a><span> </span><a name="local-1627853354"><a href="#local-1627853354"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#KindCo"><span class="hs-identifier hs-var">KindCo</span></a><span> </span><a name="local-1627853355"><a href="#local-1627853355"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-310"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="Util.html#debugIsOn"><span class="hs-operator hs-var">==</span></a><span> </span><span class="hs-identifier">Nominal</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-311"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-1627853356"><a href="#local-1627853356"><span class="hs-identifier">kco'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#promoteCoercion"><span class="hs-identifier hs-var">promoteCoercion</span></a><span> </span><a href="#local-1627853355"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-312"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-1627853356"><span class="hs-identifier hs-var">kco'</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-313"></a><span>      </span><a href="TyCoRep.html#KindCo"><span class="hs-identifier hs-var">KindCo</span></a><span> </span><a name="local-1627853357"><a href="#local-1627853357"><span class="hs-identifier">co'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#promoteCoercion"><span class="hs-identifier hs-var">promoteCoercion</span></a><span> </span><span class="hs-special">(</span><a href="OptCoercion.html#opt_co1"><span class="hs-identifier hs-var">opt_co1</span></a><span> </span><a href="#local-1627853351"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627853352"><span class="hs-identifier hs-var">sym</span></a><span> </span><a href="#local-1627853357"><span class="hs-identifier hs-var">co'</span></a><span class="hs-special">)</span><span>
</span><a name="line-314"></a><span>      </span><span class="hs-identifier">_</span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OptCoercion.html#opt_co4_wrap"><span class="hs-identifier hs-var">opt_co4_wrap</span></a><span> </span><a href="#local-1627853351"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627853352"><span class="hs-identifier hs-var">sym</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-1627853356"><span class="hs-identifier hs-var">kco'</span></a><span>
</span><a name="line-315"></a><span>  </span><span class="hs-comment">-- This might be able to be optimized more to do the promotion</span><span>
</span><a name="line-316"></a><span>  </span><span class="hs-comment">-- and substitution/optimization at the same time</span><span>
</span><a name="line-317"></a><span>
</span><a name="line-318"></a><span class="hs-identifier">opt_co4</span><span> </span><a name="local-1627853358"><a href="#local-1627853358"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-1627853359"><a href="#local-1627853359"><span class="hs-identifier">sym</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627853360"><a href="#local-1627853360"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#SubCo"><span class="hs-identifier hs-var">SubCo</span></a><span> </span><a name="local-1627853361"><a href="#local-1627853361"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-319"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="Util.html#debugIsOn"><span class="hs-operator hs-var">==</span></a><span> </span><span class="hs-identifier">Representational</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-320"></a><span>    </span><a href="OptCoercion.html#opt_co4_wrap"><span class="hs-identifier hs-var">opt_co4_wrap</span></a><span> </span><a href="#local-1627853358"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627853359"><span class="hs-identifier hs-var">sym</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-1627853361"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-321"></a><span>
</span><a name="line-322"></a><span class="hs-comment">-- This could perhaps be optimized more.</span><span>
</span><a name="line-323"></a><span class="hs-identifier">opt_co4</span><span> </span><a name="local-1627853362"><a href="#local-1627853362"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-1627853363"><a href="#local-1627853363"><span class="hs-identifier">sym</span></a></a><span> </span><a name="local-1627853364"><a href="#local-1627853364"><span class="hs-identifier">rep</span></a></a><span> </span><a name="local-1627853365"><a href="#local-1627853365"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AxiomRuleCo"><span class="hs-identifier hs-var">AxiomRuleCo</span></a><span> </span><a name="local-1627853366"><a href="#local-1627853366"><span class="hs-identifier">co</span></a></a><span> </span><a name="local-1627853367"><a href="#local-1627853367"><span class="hs-identifier">cs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-324"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="Util.html#debugIsOn"><span class="hs-operator hs-var">==</span></a><span> </span><span class="hs-identifier">coaxrRole</span><span> </span><span class="hs-identifier">co</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-325"></a><span>    </span><a href="OptCoercion.html#wrapRole"><span class="hs-identifier hs-var">wrapRole</span></a><span> </span><a href="#local-1627853364"><span class="hs-identifier hs-var">rep</span></a><span> </span><a href="#local-1627853365"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-326"></a><span>    </span><a href="OptCoercion.html#wrapSym"><span class="hs-identifier hs-var">wrapSym</span></a><span> </span><a href="#local-1627853363"><span class="hs-identifier hs-var">sym</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-327"></a><span>    </span><a href="TyCoRep.html#AxiomRuleCo"><span class="hs-identifier hs-var">AxiomRuleCo</span></a><span> </span><a href="#local-1627853366"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zipWith"><span class="hs-identifier hs-var">zipWith</span></a><span> </span><span class="hs-special">(</span><a href="OptCoercion.html#opt_co2"><span class="hs-identifier hs-var">opt_co2</span></a><span> </span><a href="#local-1627853362"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">coaxrAsmpRoles</span><span> </span><a href="#local-1627853366"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627853367"><span class="hs-identifier hs-var">cs</span></a><span class="hs-special">)</span><span>
</span><a name="line-328"></a><span>
</span><a name="line-329"></a><span class="hs-comment">-------------</span><span>
</span><a name="line-330"></a><span class="hs-comment">-- | Optimize a phantom coercion. The input coercion may not necessarily</span><span>
</span><a name="line-331"></a><span class="hs-comment">-- be a phantom, but the output sure will be.</span><span>
</span><a name="line-332"></a><span class="hs-identifier">opt_phantom</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OptCoercion.html#SymFlag"><span class="hs-identifier hs-type">SymFlag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OptCoercion.html#NormalCo"><span class="hs-identifier hs-type">NormalCo</span></a><span>
</span><a name="line-333"></a><a name="opt_phantom"><a href="OptCoercion.html#opt_phantom"><span class="hs-identifier">opt_phantom</span></a></a><span> </span><a name="local-1627853368"><a href="#local-1627853368"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-1627853369"><a href="#local-1627853369"><span class="hs-identifier">sym</span></a></a><span> </span><a name="local-1627853370"><a href="#local-1627853370"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-334"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#opt_univ"><span class="hs-identifier hs-var">opt_univ</span></a><span> </span><a href="#local-1627853368"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627853369"><span class="hs-identifier hs-var">sym</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#PhantomProv"><span class="hs-identifier hs-var">PhantomProv</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkKindCo"><span class="hs-identifier hs-var">mkKindCo</span></a><span> </span><a href="#local-1627853370"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="CoAxiom.html#Phantom"><span class="hs-identifier hs-var">Phantom</span></a><span> </span><a href="#local-1627853371"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-1627853372"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-335"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-336"></a><span>    </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-1627853371"><a href="#local-1627853371"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-1627853372"><a href="#local-1627853372"><span class="hs-identifier">ty2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span> </span><a href="#local-1627853370"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-337"></a><span>
</span><a name="line-338"></a><span class="hs-identifier">opt_univ</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OptCoercion.html#SymFlag"><span class="hs-identifier hs-type">SymFlag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#UnivCoProvenance"><span class="hs-identifier hs-type">UnivCoProvenance</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span>
</span><a name="line-339"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-340"></a><a name="opt_univ"><a href="OptCoercion.html#opt_univ"><span class="hs-identifier">opt_univ</span></a></a><span> </span><a name="local-1627853373"><a href="#local-1627853373"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-1627853374"><a href="#local-1627853374"><span class="hs-identifier">sym</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#PhantomProv"><span class="hs-identifier hs-var">PhantomProv</span></a><span> </span><a name="local-1627853375"><a href="#local-1627853375"><span class="hs-identifier">h</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627853376"><a href="#local-1627853376"><span class="hs-identifier">_r</span></a></a><span> </span><a name="local-1627853377"><a href="#local-1627853377"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-1627853378"><a href="#local-1627853378"><span class="hs-identifier">ty2</span></a></a><span>
</span><a name="line-341"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627853374"><span class="hs-identifier hs-var">sym</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkPhantomCo"><span class="hs-identifier hs-var">mkPhantomCo</span></a><span> </span><a href="#local-1627853379"><span class="hs-identifier hs-var">h'</span></a><span> </span><a href="#local-1627853381"><span class="hs-identifier hs-var">ty2'</span></a><span> </span><a href="#local-1627853380"><span class="hs-identifier hs-var">ty1'</span></a><span>
</span><a name="line-342"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkPhantomCo"><span class="hs-identifier hs-var">mkPhantomCo</span></a><span> </span><a href="#local-1627853379"><span class="hs-identifier hs-var">h'</span></a><span> </span><a href="#local-1627853380"><span class="hs-identifier hs-var">ty1'</span></a><span> </span><a href="#local-1627853381"><span class="hs-identifier hs-var">ty2'</span></a><span>
</span><a name="line-343"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-344"></a><span>    </span><a name="local-1627853379"><a href="#local-1627853379"><span class="hs-identifier">h'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#opt_co4"><span class="hs-identifier hs-var">opt_co4</span></a><span> </span><a href="#local-1627853373"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627853374"><span class="hs-identifier hs-var">sym</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-1627853375"><span class="hs-identifier hs-var">h</span></a><span>
</span><a name="line-345"></a><span>    </span><a name="local-1627853380"><a href="#local-1627853380"><span class="hs-identifier">ty1'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#lcSubstLeft"><span class="hs-identifier hs-var">lcSubstLeft</span></a><span>  </span><a href="#local-1627853373"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627853377"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-346"></a><span>    </span><a name="local-1627853381"><a href="#local-1627853381"><span class="hs-identifier">ty2'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#lcSubstRight"><span class="hs-identifier hs-var">lcSubstRight</span></a><span> </span><a href="#local-1627853373"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627853378"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-347"></a><span>
</span><a name="line-348"></a><span class="hs-identifier">opt_univ</span><span> </span><a name="local-1627853382"><a href="#local-1627853382"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-1627853383"><a href="#local-1627853383"><span class="hs-identifier">sym</span></a></a><span> </span><a name="local-1627853384"><a href="#local-1627853384"><span class="hs-identifier">prov</span></a></a><span> </span><a name="local-1627853385"><a href="#local-1627853385"><span class="hs-identifier">role</span></a></a><span> </span><a name="local-1627853386"><a href="#local-1627853386"><span class="hs-identifier">oty1</span></a></a><span> </span><a name="local-1627853387"><a href="#local-1627853387"><span class="hs-identifier">oty2</span></a></a><span>
</span><a name="line-349"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1627853392"><a href="#local-1627853392"><span class="hs-identifier">tc1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853393"><a href="#local-1627853393"><span class="hs-identifier">tys1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-var">splitTyConApp_maybe</span></a><span> </span><a href="#local-1627853386"><span class="hs-identifier hs-var">oty1</span></a><span>
</span><a name="line-350"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1627853394"><a href="#local-1627853394"><span class="hs-identifier">tc2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853395"><a href="#local-1627853395"><span class="hs-identifier">tys2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-var">splitTyConApp_maybe</span></a><span> </span><a href="#local-1627853387"><span class="hs-identifier hs-var">oty2</span></a><span>
</span><a name="line-351"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-1627853392"><span class="hs-identifier hs-var">tc1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-1627853394"><span class="hs-identifier hs-var">tc2</span></a><span>
</span><a name="line-352"></a><span>      </span><span class="hs-comment">-- NB: prov must not be the two interesting ones (ProofIrrel &amp; Phantom);</span><span>
</span><a name="line-353"></a><span>      </span><span class="hs-comment">-- Phantom is already taken care of, and ProofIrrel doesn't relate tyconapps</span><span>
</span><a name="line-354"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1627853396"><a href="#local-1627853396"><span class="hs-identifier">roles</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#tyConRolesX"><span class="hs-identifier hs-var">tyConRolesX</span></a><span> </span><a href="#local-1627853385"><span class="hs-identifier hs-var">role</span></a><span> </span><a href="#local-1627853392"><span class="hs-identifier hs-var">tc1</span></a><span>
</span><a name="line-355"></a><span>        </span><a name="local-1627853397"><a href="#local-1627853397"><span class="hs-identifier">arg_cos</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zipWith3"><span class="hs-identifier hs-var">zipWith3</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkUnivCo"><span class="hs-identifier hs-var">mkUnivCo</span></a><span> </span><a href="#local-1627853384"><span class="hs-identifier hs-var">prov</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627853396"><span class="hs-identifier hs-var">roles</span></a><span> </span><a href="#local-1627853393"><span class="hs-identifier hs-var">tys1</span></a><span> </span><a href="#local-1627853395"><span class="hs-identifier hs-var">tys2</span></a><span>
</span><a name="line-356"></a><span>        </span><a name="local-1627853398"><a href="#local-1627853398"><span class="hs-identifier">arg_cos'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zipWith"><span class="hs-identifier hs-var">zipWith</span></a><span> </span><span class="hs-special">(</span><a href="OptCoercion.html#opt_co4"><span class="hs-identifier hs-var">opt_co4</span></a><span> </span><a href="#local-1627853382"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627853383"><span class="hs-identifier hs-var">sym</span></a><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span> </span><a href="#local-1627853396"><span class="hs-identifier hs-var">roles</span></a><span> </span><a href="#local-1627853397"><span class="hs-identifier hs-var">arg_cos</span></a><span>
</span><a name="line-357"></a><span>    </span><span class="hs-keyword">in</span><span>
</span><a name="line-358"></a><span>    </span><a href="Coercion.html#mkTyConAppCo"><span class="hs-identifier hs-var">mkTyConAppCo</span></a><span> </span><a href="#local-1627853385"><span class="hs-identifier hs-var">role</span></a><span> </span><a href="#local-1627853392"><span class="hs-identifier hs-var">tc1</span></a><span> </span><a href="#local-1627853398"><span class="hs-identifier hs-var">arg_cos'</span></a><span>
</span><a name="line-359"></a><span>
</span><a name="line-360"></a><span>  </span><span class="hs-comment">-- can't optimize the AppTy case because we can't build the kind coercions.</span><span>
</span><a name="line-361"></a><span>
</span><a name="line-362"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1627853399"><a href="#local-1627853399"><span class="hs-identifier">tv1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853400"><a href="#local-1627853400"><span class="hs-identifier">ty1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitForAllTy_maybe"><span class="hs-identifier hs-var">splitForAllTy_maybe</span></a><span> </span><a href="#local-1627853386"><span class="hs-identifier hs-var">oty1</span></a><span>
</span><a name="line-363"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1627853401"><a href="#local-1627853401"><span class="hs-identifier">tv2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853402"><a href="#local-1627853402"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitForAllTy_maybe"><span class="hs-identifier hs-var">splitForAllTy_maybe</span></a><span> </span><a href="#local-1627853387"><span class="hs-identifier hs-var">oty2</span></a><span>
</span><a name="line-364"></a><span>      </span><span class="hs-comment">-- NB: prov isn't interesting here either</span><span>
</span><a name="line-365"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1627853403"><a href="#local-1627853403"><span class="hs-identifier">k1</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a><span> </span><a href="#local-1627853399"><span class="hs-identifier hs-var">tv1</span></a><span>
</span><a name="line-366"></a><span>        </span><a name="local-1627853404"><a href="#local-1627853404"><span class="hs-identifier">k2</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a><span> </span><a href="#local-1627853401"><span class="hs-identifier hs-var">tv2</span></a><span>
</span><a name="line-367"></a><span>        </span><a name="local-1627853405"><a href="#local-1627853405"><span class="hs-identifier">eta</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkUnivCo"><span class="hs-identifier hs-var">mkUnivCo</span></a><span> </span><a href="#local-1627853384"><span class="hs-identifier hs-var">prov</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-1627853403"><span class="hs-identifier hs-var">k1</span></a><span> </span><a href="#local-1627853404"><span class="hs-identifier hs-var">k2</span></a><span>
</span><a name="line-368"></a><span>          </span><span class="hs-comment">-- eta gets opt'ed soon, but not yet.</span><span>
</span><a name="line-369"></a><span>        </span><a name="local-1627853406"><a href="#local-1627853406"><span class="hs-identifier">ty2'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substTyWith"><span class="hs-identifier hs-var">substTyWith</span></a><span> </span><span class="hs-special">[</span><a href="#local-1627853401"><span class="hs-identifier hs-var">tv2</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#TyVarTy"><span class="hs-identifier hs-var">TyVarTy</span></a><span> </span><a href="#local-1627853399"><span class="hs-identifier hs-var">tv1</span></a><span> </span><span class="hs-special">`</span><a href="Type.html#mkCastTy"><span class="hs-identifier hs-var">mkCastTy</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627853405"><span class="hs-identifier hs-var">eta</span></a><span class="hs-special">]</span><span> </span><a href="#local-1627853402"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-370"></a><span>
</span><a name="line-371"></a><span>        </span><span class="hs-special">(</span><a name="local-1627853407"><a href="#local-1627853407"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853408"><a href="#local-1627853408"><span class="hs-identifier">tv1'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853409"><a href="#local-1627853409"><span class="hs-identifier">eta'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#optForAllCoBndr"><span class="hs-identifier hs-var">optForAllCoBndr</span></a><span> </span><a href="#local-1627853382"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627853383"><span class="hs-identifier hs-var">sym</span></a><span> </span><a href="#local-1627853399"><span class="hs-identifier hs-var">tv1</span></a><span> </span><a href="#local-1627853405"><span class="hs-identifier hs-var">eta</span></a><span>
</span><a name="line-372"></a><span>    </span><span class="hs-keyword">in</span><span>
</span><a name="line-373"></a><span>    </span><a href="Coercion.html#mkForAllCo"><span class="hs-identifier hs-var">mkForAllCo</span></a><span> </span><a href="#local-1627853408"><span class="hs-identifier hs-var">tv1'</span></a><span> </span><a href="#local-1627853409"><span class="hs-identifier hs-var">eta'</span></a><span> </span><span class="hs-special">(</span><a href="OptCoercion.html#opt_univ"><span class="hs-identifier hs-var">opt_univ</span></a><span> </span><a href="#local-1627853407"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-1627853383"><span class="hs-identifier hs-var">sym</span></a><span> </span><a href="#local-1627853384"><span class="hs-identifier hs-var">prov</span></a><span> </span><a href="#local-1627853385"><span class="hs-identifier hs-var">role</span></a><span> </span><a href="#local-1627853400"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-1627853406"><span class="hs-identifier hs-var">ty2'</span></a><span class="hs-special">)</span><span>
</span><a name="line-374"></a><span>
</span><a name="line-375"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-376"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1627853410"><a href="#local-1627853410"><span class="hs-identifier">ty1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substTyUnchecked"><span class="hs-identifier hs-var">substTyUnchecked</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#lcSubstLeft"><span class="hs-identifier hs-var">lcSubstLeft</span></a><span>  </span><a href="#local-1627853382"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627853386"><span class="hs-identifier hs-var">oty1</span></a><span>
</span><a name="line-377"></a><span>        </span><a name="local-1627853411"><a href="#local-1627853411"><span class="hs-identifier">ty2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substTyUnchecked"><span class="hs-identifier hs-var">substTyUnchecked</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#lcSubstRight"><span class="hs-identifier hs-var">lcSubstRight</span></a><span> </span><a href="#local-1627853382"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627853387"><span class="hs-identifier hs-var">oty2</span></a><span>
</span><a name="line-378"></a><span>        </span><span class="hs-special">(</span><a name="local-1627853412"><a href="#local-1627853412"><span class="hs-identifier">a</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853413"><a href="#local-1627853413"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627853383"><span class="hs-identifier hs-var">sym</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-1627853411"><span class="hs-identifier hs-var">ty2</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627853410"><span class="hs-identifier hs-var">ty1</span></a><span class="hs-special">)</span><span>
</span><a name="line-379"></a><span>               </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-1627853410"><span class="hs-identifier hs-var">ty1</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627853411"><span class="hs-identifier hs-var">ty2</span></a><span class="hs-special">)</span><span>
</span><a name="line-380"></a><span>    </span><span class="hs-keyword">in</span><span>
</span><a name="line-381"></a><span>    </span><a href="Coercion.html#mkUnivCo"><span class="hs-identifier hs-var">mkUnivCo</span></a><span> </span><a href="#local-1627853388"><span class="hs-identifier hs-var">prov'</span></a><span> </span><a href="#local-1627853385"><span class="hs-identifier hs-var">role</span></a><span> </span><a href="#local-1627853412"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-1627853413"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-382"></a><span>
</span><a name="line-383"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-384"></a><span>    </span><a name="local-1627853388"><a href="#local-1627853388"><span class="hs-identifier">prov'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1627853384"><span class="hs-identifier hs-var">prov</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-385"></a><span>      </span><a href="TyCoRep.html#UnsafeCoerceProv"><span class="hs-identifier hs-var">UnsafeCoerceProv</span></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627853384"><span class="hs-identifier hs-var">prov</span></a><span>
</span><a name="line-386"></a><span>      </span><a href="TyCoRep.html#PhantomProv"><span class="hs-identifier hs-var">PhantomProv</span></a><span> </span><a name="local-1627853389"><a href="#local-1627853389"><span class="hs-identifier">kco</span></a></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#PhantomProv"><span class="hs-identifier hs-var">PhantomProv</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="OptCoercion.html#opt_co4_wrap"><span class="hs-identifier hs-var">opt_co4_wrap</span></a><span> </span><a href="#local-1627853382"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627853383"><span class="hs-identifier hs-var">sym</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-1627853389"><span class="hs-identifier hs-var">kco</span></a><span>
</span><a name="line-387"></a><span>      </span><a href="TyCoRep.html#ProofIrrelProv"><span class="hs-identifier hs-var">ProofIrrelProv</span></a><span> </span><a name="local-1627853390"><a href="#local-1627853390"><span class="hs-identifier">kco</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#ProofIrrelProv"><span class="hs-identifier hs-var">ProofIrrelProv</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="OptCoercion.html#opt_co4_wrap"><span class="hs-identifier hs-var">opt_co4_wrap</span></a><span> </span><a href="#local-1627853382"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627853383"><span class="hs-identifier hs-var">sym</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-1627853390"><span class="hs-identifier hs-var">kco</span></a><span>
</span><a name="line-388"></a><span>      </span><a href="TyCoRep.html#PluginProv"><span class="hs-identifier hs-var">PluginProv</span></a><span> </span><span class="hs-identifier">_</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627853384"><span class="hs-identifier hs-var">prov</span></a><span>
</span><a name="line-389"></a><span>      </span><a href="TyCoRep.html#HoleProv"><span class="hs-identifier hs-var">HoleProv</span></a><span> </span><a name="local-1627853391"><a href="#local-1627853391"><span class="hs-identifier">h</span></a></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;opt_univ fell into a hole&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1627853391"><span class="hs-identifier hs-var">h</span></a><span class="hs-special">)</span><span>
</span><a name="line-390"></a><span>
</span><a name="line-391"></a><span>
</span><a name="line-392"></a><span class="hs-comment">-------------</span><span>
</span><a name="line-393"></a><span class="hs-comment">-- NthCo must be handled separately, because it's the one case where we can't</span><span>
</span><a name="line-394"></a><span class="hs-comment">-- tell quickly what the component coercion's role is from the containing</span><span>
</span><a name="line-395"></a><span class="hs-comment">-- coercion. To avoid repeated coercionRole calls as opt_co1 calls opt_co2,</span><span>
</span><a name="line-396"></a><span class="hs-comment">-- we just look for nested NthCo's, which can happen in practice.</span><span>
</span><a name="line-397"></a><span class="hs-identifier">opt_nth_co</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OptCoercion.html#SymFlag"><span class="hs-identifier hs-type">SymFlag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OptCoercion.html#ReprFlag"><span class="hs-identifier hs-type">ReprFlag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OptCoercion.html#NormalCo"><span class="hs-identifier hs-type">NormalCo</span></a><span>
</span><a name="line-398"></a><a name="opt_nth_co"><a href="OptCoercion.html#opt_nth_co"><span class="hs-identifier">opt_nth_co</span></a></a><span> </span><a name="local-1627853414"><a href="#local-1627853414"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-1627853415"><a href="#local-1627853415"><span class="hs-identifier">sym</span></a></a><span> </span><a name="local-1627853416"><a href="#local-1627853416"><span class="hs-identifier">rep</span></a></a><span> </span><a name="local-1627853417"><a href="#local-1627853417"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627853418"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-399"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-400"></a><span>    </span><a name="local-1627853418"><a href="#local-1627853418"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-1627853423"><a href="#local-1627853423"><span class="hs-identifier">ns</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#NthCo"><span class="hs-identifier hs-var">NthCo</span></a><span> </span><a name="local-1627853424"><a href="#local-1627853424"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-1627853425"><a href="#local-1627853425"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627853418"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627853424"><span class="hs-identifier hs-var">n</span></a><span class="hs-glyph">:</span><a href="#local-1627853423"><span class="hs-identifier hs-var">ns</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627853425"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-401"></a><span>      </span><span class="hs-comment">-- previous versions checked if the tycon is decomposable. This</span><span>
</span><a name="line-402"></a><span>      </span><span class="hs-comment">-- is redundant, because a non-decomposable tycon under an NthCo</span><span>
</span><a name="line-403"></a><span>      </span><span class="hs-comment">-- is entirely bogus. See docs/core-spec/core-spec.pdf.</span><span>
</span><a name="line-404"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1627853426"><a href="#local-1627853426"><span class="hs-identifier">ns</span></a></a><span> </span><a name="local-1627853427"><a href="#local-1627853427"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-405"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627853420"><span class="hs-identifier hs-var">opt_nths</span></a><span> </span><a href="#local-1627853426"><span class="hs-identifier hs-var">ns</span></a><span> </span><a href="#local-1627853427"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-406"></a><span>
</span><a name="line-407"></a><span>      </span><span class="hs-comment">-- try to resolve 1 Nth</span><span>
</span><a name="line-408"></a><span>    </span><a name="local-1627853419"><a href="#local-1627853419"><span class="hs-identifier">push_nth</span></a></a><span> </span><a name="local-1627853428"><a href="#local-1627853428"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Refl"><span class="hs-identifier hs-var">Refl</span></a><span> </span><a name="local-1627853429"><a href="#local-1627853429"><span class="hs-identifier">r1</span></a></a><span> </span><a name="local-1627853430"><a href="#local-1627853430"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-409"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1627853431"><a href="#local-1627853431"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853432"><a href="#local-1627853432"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-var">splitTyConApp_maybe</span></a><span> </span><a href="#local-1627853430"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-410"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Refl"><span class="hs-identifier hs-var">Refl</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#nthRole"><span class="hs-identifier hs-var">nthRole</span></a><span> </span><a href="#local-1627853429"><span class="hs-identifier hs-var">r1</span></a><span> </span><a href="#local-1627853431"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-1627853428"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-1627853432"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-special">`</span><a href="ListSetOps.html#getNth"><span class="hs-identifier hs-var">getNth</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627853428"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-411"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627853428"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-412"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1627853433"><a href="#local-1627853433"><span class="hs-identifier">tv</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitForAllTy_maybe"><span class="hs-identifier hs-var">splitForAllTy_maybe</span></a><span> </span><a href="#local-1627853430"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-413"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Refl"><span class="hs-identifier hs-var">Refl</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a><span> </span><a href="#local-1627853433"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-414"></a><span>    </span><span class="hs-identifier">push_nth</span><span> </span><a name="local-1627853434"><a href="#local-1627853434"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyConAppCo"><span class="hs-identifier hs-var">TyConAppCo</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627853435"><a href="#local-1627853435"><span class="hs-identifier">cos</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-415"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627853435"><span class="hs-identifier hs-var">cos</span></a><span> </span><span class="hs-special">`</span><a href="ListSetOps.html#getNth"><span class="hs-identifier hs-var">getNth</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627853434"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-416"></a><span>    </span><span class="hs-identifier">push_nth</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ForAllCo"><span class="hs-identifier hs-var">ForAllCo</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627853436"><a href="#local-1627853436"><span class="hs-identifier">eta</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-417"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-1627853436"><span class="hs-identifier hs-var">eta</span></a><span>
</span><a name="line-418"></a><span>    </span><span class="hs-identifier">push_nth</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-419"></a><span>
</span><a name="line-420"></a><span>      </span><span class="hs-comment">-- input coercion is *not* yet sym'd or opt'd</span><span>
</span><a name="line-421"></a><span>    </span><a name="local-1627853420"><a href="#local-1627853420"><span class="hs-identifier">opt_nths</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-1627853437"><a href="#local-1627853437"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#opt_co4_wrap"><span class="hs-identifier hs-var">opt_co4_wrap</span></a><span> </span><a href="#local-1627853414"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627853415"><span class="hs-identifier hs-var">sym</span></a><span> </span><a href="#local-1627853416"><span class="hs-identifier hs-var">rep</span></a><span> </span><a href="#local-1627853417"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-1627853437"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-422"></a><span>    </span><span class="hs-identifier">opt_nths</span><span> </span><span class="hs-special">(</span><a name="local-1627853438"><a href="#local-1627853438"><span class="hs-identifier">n</span></a></a><span class="hs-glyph">:</span><a name="local-1627853439"><a href="#local-1627853439"><span class="hs-identifier">ns</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627853440"><a href="#local-1627853440"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-423"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1627853441"><a href="#local-1627853441"><span class="hs-identifier">co'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627853419"><span class="hs-identifier hs-var">push_nth</span></a><span> </span><a href="#local-1627853438"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-1627853440"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-424"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627853420"><span class="hs-identifier hs-var">opt_nths</span></a><span> </span><a href="#local-1627853439"><span class="hs-identifier hs-var">ns</span></a><span> </span><a href="#local-1627853441"><span class="hs-identifier hs-var">co'</span></a><span>
</span><a name="line-425"></a><span>
</span><a name="line-426"></a><span>      </span><span class="hs-comment">-- here, the co isn't a TyConAppCo, so we opt it, hoping to get</span><span>
</span><a name="line-427"></a><span>      </span><span class="hs-comment">-- a TyConAppCo as output. We don't know the role, so we use</span><span>
</span><a name="line-428"></a><span>      </span><span class="hs-comment">-- opt_co1. This is slightly annoying, because opt_co1 will call</span><span>
</span><a name="line-429"></a><span>      </span><span class="hs-comment">-- coercionRole, but as long as we don't have a long chain of</span><span>
</span><a name="line-430"></a><span>      </span><span class="hs-comment">-- NthCo's interspersed with some other coercion former, we should</span><span>
</span><a name="line-431"></a><span>      </span><span class="hs-comment">-- be OK.</span><span>
</span><a name="line-432"></a><span>    </span><span class="hs-identifier">opt_nths</span><span> </span><a name="local-1627853442"><a href="#local-1627853442"><span class="hs-identifier">ns</span></a></a><span> </span><a name="local-1627853443"><a href="#local-1627853443"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627853421"><span class="hs-identifier hs-var">opt_nths'</span></a><span> </span><a href="#local-1627853442"><span class="hs-identifier hs-var">ns</span></a><span> </span><span class="hs-special">(</span><a href="OptCoercion.html#opt_co1"><span class="hs-identifier hs-var">opt_co1</span></a><span> </span><a href="#local-1627853414"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627853415"><span class="hs-identifier hs-var">sym</span></a><span> </span><a href="#local-1627853443"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-433"></a><span>
</span><a name="line-434"></a><span>      </span><span class="hs-comment">-- input coercion *is* sym'd and opt'd</span><span>
</span><a name="line-435"></a><span>    </span><a name="local-1627853421"><a href="#local-1627853421"><span class="hs-identifier">opt_nths'</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-1627853444"><a href="#local-1627853444"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-436"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-1627853416"><span class="hs-identifier hs-var">rep</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-special">(</span><a href="#local-1627853417"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span class="hs-special">)</span><span>
</span><a name="line-437"></a><span>            </span><span class="hs-comment">-- propagate the SubCo:</span><span>
</span><a name="line-438"></a><span>        </span><span class="hs-keyword">then</span><span> </span><a href="OptCoercion.html#opt_co4_wrap"><span class="hs-identifier hs-var">opt_co4_wrap</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#zapLiftingContext"><span class="hs-identifier hs-var">zapLiftingContext</span></a><span> </span><a href="#local-1627853414"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-1627853417"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-1627853444"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-439"></a><span>        </span><span class="hs-keyword">else</span><span> </span><a href="#local-1627853444"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-440"></a><span>    </span><span class="hs-identifier">opt_nths'</span><span> </span><span class="hs-special">(</span><a name="local-1627853445"><a href="#local-1627853445"><span class="hs-identifier">n</span></a></a><span class="hs-glyph">:</span><a name="local-1627853446"><a href="#local-1627853446"><span class="hs-identifier">ns</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627853447"><a href="#local-1627853447"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-441"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1627853448"><a href="#local-1627853448"><span class="hs-identifier">co'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627853419"><span class="hs-identifier hs-var">push_nth</span></a><span> </span><a href="#local-1627853445"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-1627853447"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-442"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627853421"><span class="hs-identifier hs-var">opt_nths'</span></a><span> </span><a href="#local-1627853446"><span class="hs-identifier hs-var">ns</span></a><span> </span><a href="#local-1627853448"><span class="hs-identifier hs-var">co'</span></a><span>
</span><a name="line-443"></a><span>    </span><span class="hs-identifier">opt_nths'</span><span> </span><a name="local-1627853449"><a href="#local-1627853449"><span class="hs-identifier">ns</span></a></a><span> </span><a name="local-1627853450"><a href="#local-1627853450"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#wrapRole"><span class="hs-identifier hs-var">wrapRole</span></a><span> </span><a href="#local-1627853416"><span class="hs-identifier hs-var">rep</span></a><span> </span><a href="#local-1627853417"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627853422"><span class="hs-identifier hs-var">mk_nths</span></a><span> </span><a href="#local-1627853449"><span class="hs-identifier hs-var">ns</span></a><span> </span><a href="#local-1627853450"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-444"></a><span>
</span><a name="line-445"></a><span>    </span><a name="local-1627853422"><a href="#local-1627853422"><span class="hs-identifier">mk_nths</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-1627853451"><a href="#local-1627853451"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627853451"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-446"></a><span>    </span><span class="hs-identifier">mk_nths</span><span> </span><span class="hs-special">(</span><a name="local-1627853452"><a href="#local-1627853452"><span class="hs-identifier">n</span></a></a><span class="hs-glyph">:</span><a name="local-1627853453"><a href="#local-1627853453"><span class="hs-identifier">ns</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627853454"><a href="#local-1627853454"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627853422"><span class="hs-identifier hs-var">mk_nths</span></a><span> </span><a href="#local-1627853453"><span class="hs-identifier hs-var">ns</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkNthCo"><span class="hs-identifier hs-var">mkNthCo</span></a><span> </span><a href="#local-1627853452"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-1627853454"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-447"></a><span>
</span><a name="line-448"></a><span class="hs-comment">-------------</span><span>
</span><a name="line-449"></a><span class="hs-identifier">opt_transList</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="OptCoercion.html#NormalCo"><span class="hs-identifier hs-type">NormalCo</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="OptCoercion.html#NormalCo"><span class="hs-identifier hs-type">NormalCo</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="OptCoercion.html#NormalCo"><span class="hs-identifier hs-type">NormalCo</span></a><span class="hs-special">]</span><span>
</span><a name="line-450"></a><a name="opt_transList"><a href="OptCoercion.html#opt_transList"><span class="hs-identifier">opt_transList</span></a></a><span> </span><a name="local-1627853455"><a href="#local-1627853455"><span class="hs-identifier">is</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zipWith"><span class="hs-identifier hs-var">zipWith</span></a><span> </span><span class="hs-special">(</span><a href="OptCoercion.html#opt_trans"><span class="hs-identifier hs-var">opt_trans</span></a><span> </span><a href="#local-1627853455"><span class="hs-identifier hs-var">is</span></a><span class="hs-special">)</span><span>
</span><a name="line-451"></a><span>
</span><a name="line-452"></a><span class="hs-identifier">opt_trans</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OptCoercion.html#NormalCo"><span class="hs-identifier hs-type">NormalCo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OptCoercion.html#NormalCo"><span class="hs-identifier hs-type">NormalCo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OptCoercion.html#NormalCo"><span class="hs-identifier hs-type">NormalCo</span></a><span>
</span><a name="line-453"></a><a name="opt_trans"><a href="OptCoercion.html#opt_trans"><span class="hs-identifier">opt_trans</span></a></a><span> </span><a name="local-1627853456"><a href="#local-1627853456"><span class="hs-identifier">is</span></a></a><span> </span><a name="local-1627853457"><a href="#local-1627853457"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-1627853458"><a href="#local-1627853458"><span class="hs-identifier">co2</span></a></a><span>
</span><a name="line-454"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a><span> </span><a href="#local-1627853457"><span class="hs-identifier hs-var">co1</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627853458"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-455"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#opt_trans1"><span class="hs-identifier hs-var">opt_trans1</span></a><span> </span><a href="#local-1627853456"><span class="hs-identifier hs-var">is</span></a><span> </span><a href="#local-1627853457"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-1627853458"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-456"></a><span>
</span><a name="line-457"></a><span class="hs-identifier">opt_trans1</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OptCoercion.html#NormalNonIdCo"><span class="hs-identifier hs-type">NormalNonIdCo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OptCoercion.html#NormalCo"><span class="hs-identifier hs-type">NormalCo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OptCoercion.html#NormalCo"><span class="hs-identifier hs-type">NormalCo</span></a><span>
</span><a name="line-458"></a><span class="hs-comment">-- First arg is not the identity</span><span>
</span><a name="line-459"></a><a name="opt_trans1"><a href="OptCoercion.html#opt_trans1"><span class="hs-identifier">opt_trans1</span></a></a><span> </span><a name="local-1627853459"><a href="#local-1627853459"><span class="hs-identifier">is</span></a></a><span> </span><a name="local-1627853460"><a href="#local-1627853460"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-1627853461"><a href="#local-1627853461"><span class="hs-identifier">co2</span></a></a><span>
</span><a name="line-460"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a><span> </span><a href="#local-1627853461"><span class="hs-identifier hs-var">co2</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627853460"><span class="hs-identifier hs-var">co1</span></a><span>
</span><a name="line-461"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#opt_trans2"><span class="hs-identifier hs-var">opt_trans2</span></a><span> </span><a href="#local-1627853459"><span class="hs-identifier hs-var">is</span></a><span> </span><a href="#local-1627853460"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-1627853461"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-462"></a><span>
</span><a name="line-463"></a><span class="hs-identifier">opt_trans2</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OptCoercion.html#NormalNonIdCo"><span class="hs-identifier hs-type">NormalNonIdCo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OptCoercion.html#NormalNonIdCo"><span class="hs-identifier hs-type">NormalNonIdCo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OptCoercion.html#NormalCo"><span class="hs-identifier hs-type">NormalCo</span></a><span>
</span><a name="line-464"></a><span class="hs-comment">-- Neither arg is the identity</span><span>
</span><a name="line-465"></a><a name="opt_trans2"><a href="OptCoercion.html#opt_trans2"><span class="hs-identifier">opt_trans2</span></a></a><span> </span><a name="local-1627853462"><a href="#local-1627853462"><span class="hs-identifier">is</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TransCo"><span class="hs-identifier hs-var">TransCo</span></a><span> </span><a name="local-1627853463"><a href="#local-1627853463"><span class="hs-identifier">co1a</span></a></a><span> </span><a name="local-1627853464"><a href="#local-1627853464"><span class="hs-identifier">co1b</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627853465"><a href="#local-1627853465"><span class="hs-identifier">co2</span></a></a><span>
</span><a name="line-466"></a><span>    </span><span class="hs-comment">-- Don't know whether the sub-coercions are the identity</span><span>
</span><a name="line-467"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#opt_trans"><span class="hs-identifier hs-var">opt_trans</span></a><span> </span><a href="#local-1627853462"><span class="hs-identifier hs-var">is</span></a><span> </span><a href="#local-1627853463"><span class="hs-identifier hs-var">co1a</span></a><span> </span><span class="hs-special">(</span><a href="OptCoercion.html#opt_trans"><span class="hs-identifier hs-var">opt_trans</span></a><span> </span><a href="#local-1627853462"><span class="hs-identifier hs-var">is</span></a><span> </span><a href="#local-1627853464"><span class="hs-identifier hs-var">co1b</span></a><span> </span><a href="#local-1627853465"><span class="hs-identifier hs-var">co2</span></a><span class="hs-special">)</span><span>
</span><a name="line-468"></a><span>
</span><a name="line-469"></a><span class="hs-identifier">opt_trans2</span><span> </span><a name="local-1627853466"><a href="#local-1627853466"><span class="hs-identifier">is</span></a></a><span> </span><a name="local-1627853467"><a href="#local-1627853467"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-1627853468"><a href="#local-1627853468"><span class="hs-identifier">co2</span></a></a><span>
</span><a name="line-470"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1627853469"><a href="#local-1627853469"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="OptCoercion.html#opt_trans_rule"><span class="hs-identifier hs-var">opt_trans_rule</span></a><span> </span><a href="#local-1627853466"><span class="hs-identifier hs-var">is</span></a><span> </span><a href="#local-1627853467"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-1627853468"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-471"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627853469"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-472"></a><span>
</span><a name="line-473"></a><span class="hs-identifier">opt_trans2</span><span> </span><a name="local-1627853470"><a href="#local-1627853470"><span class="hs-identifier">is</span></a></a><span> </span><a name="local-1627853471"><a href="#local-1627853471"><span class="hs-identifier">co1</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TransCo"><span class="hs-identifier hs-var">TransCo</span></a><span> </span><a name="local-1627853472"><a href="#local-1627853472"><span class="hs-identifier">co2a</span></a></a><span> </span><a name="local-1627853473"><a href="#local-1627853473"><span class="hs-identifier">co2b</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-474"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1627853474"><a href="#local-1627853474"><span class="hs-identifier">co1_2a</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="OptCoercion.html#opt_trans_rule"><span class="hs-identifier hs-var">opt_trans_rule</span></a><span> </span><a href="#local-1627853470"><span class="hs-identifier hs-var">is</span></a><span> </span><a href="#local-1627853471"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-1627853472"><span class="hs-identifier hs-var">co2a</span></a><span>
</span><a name="line-475"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a><span> </span><a href="#local-1627853474"><span class="hs-identifier hs-var">co1_2a</span></a><span>
</span><a name="line-476"></a><span>    </span><span class="hs-keyword">then</span><span> </span><a href="#local-1627853473"><span class="hs-identifier hs-var">co2b</span></a><span>
</span><a name="line-477"></a><span>    </span><span class="hs-keyword">else</span><span> </span><a href="OptCoercion.html#opt_trans1"><span class="hs-identifier hs-var">opt_trans1</span></a><span> </span><a href="#local-1627853470"><span class="hs-identifier hs-var">is</span></a><span> </span><a href="#local-1627853474"><span class="hs-identifier hs-var">co1_2a</span></a><span> </span><a href="#local-1627853473"><span class="hs-identifier hs-var">co2b</span></a><span>
</span><a name="line-478"></a><span>
</span><a name="line-479"></a><span class="hs-identifier">opt_trans2</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627853475"><a href="#local-1627853475"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-1627853476"><a href="#local-1627853476"><span class="hs-identifier">co2</span></a></a><span>
</span><a name="line-480"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkTransCo"><span class="hs-identifier hs-var">mkTransCo</span></a><span> </span><a href="#local-1627853475"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-1627853476"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-481"></a><span>
</span><a name="line-482"></a><span class="hs-comment">------</span><span>
</span><a name="line-483"></a><span class="hs-comment">-- Optimize coercions with a top-level use of transitivity.</span><span>
</span><a name="line-484"></a><span class="hs-identifier">opt_trans_rule</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OptCoercion.html#NormalNonIdCo"><span class="hs-identifier hs-type">NormalNonIdCo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OptCoercion.html#NormalNonIdCo"><span class="hs-identifier hs-type">NormalNonIdCo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="OptCoercion.html#NormalCo"><span class="hs-identifier hs-type">NormalCo</span></a><span>
</span><a name="line-485"></a><span>
</span><a name="line-486"></a><span class="hs-comment">-- Push transitivity through matching destructors</span><span>
</span><a name="line-487"></a><a name="opt_trans_rule"><a href="OptCoercion.html#opt_trans_rule"><span class="hs-identifier">opt_trans_rule</span></a></a><span> </span><a name="local-1627853477"><a href="#local-1627853477"><span class="hs-identifier">is</span></a></a><span> </span><a name="local-1627853478"><a href="#local-1627853478"><span class="hs-identifier">in_co1</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TyCoRep.html#NthCo"><span class="hs-identifier hs-var">NthCo</span></a><span> </span><a name="local-1627853479"><a href="#local-1627853479"><span class="hs-identifier">d1</span></a></a><span> </span><a name="local-1627853480"><a href="#local-1627853480"><span class="hs-identifier">co1</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627853481"><a href="#local-1627853481"><span class="hs-identifier">in_co2</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TyCoRep.html#NthCo"><span class="hs-identifier hs-var">NthCo</span></a><span> </span><a name="local-1627853482"><a href="#local-1627853482"><span class="hs-identifier">d2</span></a></a><span> </span><a name="local-1627853483"><a href="#local-1627853483"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-488"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627853479"><span class="hs-identifier hs-var">d1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-1627853482"><span class="hs-identifier hs-var">d2</span></a><span>
</span><a name="line-489"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-1627853480"><span class="hs-identifier hs-var">co1</span></a><span> </span><span class="hs-special">`</span><a href="OptCoercion.html#compatible_co"><span class="hs-identifier hs-var">compatible_co</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627853483"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-490"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#fireTransRule"><span class="hs-identifier hs-var">fireTransRule</span></a><span> </span><span class="hs-string">&quot;PushNth&quot;</span><span> </span><a href="#local-1627853478"><span class="hs-identifier hs-var">in_co1</span></a><span> </span><a href="#local-1627853481"><span class="hs-identifier hs-var">in_co2</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-491"></a><span>    </span><a href="Coercion.html#mkNthCo"><span class="hs-identifier hs-var">mkNthCo</span></a><span> </span><a href="#local-1627853479"><span class="hs-identifier hs-var">d1</span></a><span> </span><span class="hs-special">(</span><a href="OptCoercion.html#opt_trans"><span class="hs-identifier hs-var">opt_trans</span></a><span> </span><a href="#local-1627853477"><span class="hs-identifier hs-var">is</span></a><span> </span><a href="#local-1627853480"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-1627853483"><span class="hs-identifier hs-var">co2</span></a><span class="hs-special">)</span><span>
</span><a name="line-492"></a><span>
</span><a name="line-493"></a><span class="hs-identifier">opt_trans_rule</span><span> </span><a name="local-1627853484"><a href="#local-1627853484"><span class="hs-identifier">is</span></a></a><span> </span><a name="local-1627853485"><a href="#local-1627853485"><span class="hs-identifier">in_co1</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TyCoRep.html#LRCo"><span class="hs-identifier hs-var">LRCo</span></a><span> </span><a name="local-1627853486"><a href="#local-1627853486"><span class="hs-identifier">d1</span></a></a><span> </span><a name="local-1627853487"><a href="#local-1627853487"><span class="hs-identifier">co1</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627853488"><a href="#local-1627853488"><span class="hs-identifier">in_co2</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TyCoRep.html#LRCo"><span class="hs-identifier hs-var">LRCo</span></a><span> </span><a name="local-1627853489"><a href="#local-1627853489"><span class="hs-identifier">d2</span></a></a><span> </span><a name="local-1627853490"><a href="#local-1627853490"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-494"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627853486"><span class="hs-identifier hs-var">d1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-1627853489"><span class="hs-identifier hs-var">d2</span></a><span>
</span><a name="line-495"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-1627853487"><span class="hs-identifier hs-var">co1</span></a><span> </span><span class="hs-special">`</span><a href="OptCoercion.html#compatible_co"><span class="hs-identifier hs-var">compatible_co</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627853490"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-496"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#fireTransRule"><span class="hs-identifier hs-var">fireTransRule</span></a><span> </span><span class="hs-string">&quot;PushLR&quot;</span><span> </span><a href="#local-1627853485"><span class="hs-identifier hs-var">in_co1</span></a><span> </span><a href="#local-1627853488"><span class="hs-identifier hs-var">in_co2</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-497"></a><span>    </span><a href="Coercion.html#mkLRCo"><span class="hs-identifier hs-var">mkLRCo</span></a><span> </span><a href="#local-1627853486"><span class="hs-identifier hs-var">d1</span></a><span> </span><span class="hs-special">(</span><a href="OptCoercion.html#opt_trans"><span class="hs-identifier hs-var">opt_trans</span></a><span> </span><a href="#local-1627853484"><span class="hs-identifier hs-var">is</span></a><span> </span><a href="#local-1627853487"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-1627853490"><span class="hs-identifier hs-var">co2</span></a><span class="hs-special">)</span><span>
</span><a name="line-498"></a><span>
</span><a name="line-499"></a><span class="hs-comment">-- Push transitivity inside instantiation</span><span>
</span><a name="line-500"></a><span class="hs-identifier">opt_trans_rule</span><span> </span><a name="local-1627853491"><a href="#local-1627853491"><span class="hs-identifier">is</span></a></a><span> </span><a name="local-1627853492"><a href="#local-1627853492"><span class="hs-identifier">in_co1</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TyCoRep.html#InstCo"><span class="hs-identifier hs-var">InstCo</span></a><span> </span><a name="local-1627853493"><a href="#local-1627853493"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-1627853494"><a href="#local-1627853494"><span class="hs-identifier">ty1</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627853495"><a href="#local-1627853495"><span class="hs-identifier">in_co2</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TyCoRep.html#InstCo"><span class="hs-identifier hs-var">InstCo</span></a><span> </span><a name="local-1627853496"><a href="#local-1627853496"><span class="hs-identifier">co2</span></a></a><span> </span><a name="local-1627853497"><a href="#local-1627853497"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-501"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627853494"><span class="hs-identifier hs-var">ty1</span></a><span> </span><span class="hs-special">`</span><a href="Coercion.html#eqCoercion"><span class="hs-identifier hs-var">eqCoercion</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627853497"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-502"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-1627853493"><span class="hs-identifier hs-var">co1</span></a><span> </span><span class="hs-special">`</span><a href="OptCoercion.html#compatible_co"><span class="hs-identifier hs-var">compatible_co</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627853496"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-503"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#fireTransRule"><span class="hs-identifier hs-var">fireTransRule</span></a><span> </span><span class="hs-string">&quot;TrPushInst&quot;</span><span> </span><a href="#local-1627853492"><span class="hs-identifier hs-var">in_co1</span></a><span> </span><a href="#local-1627853495"><span class="hs-identifier hs-var">in_co2</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-504"></a><span>    </span><a href="Coercion.html#mkInstCo"><span class="hs-identifier hs-var">mkInstCo</span></a><span> </span><span class="hs-special">(</span><a href="OptCoercion.html#opt_trans"><span class="hs-identifier hs-var">opt_trans</span></a><span> </span><a href="#local-1627853491"><span class="hs-identifier hs-var">is</span></a><span> </span><a href="#local-1627853493"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-1627853496"><span class="hs-identifier hs-var">co2</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627853494"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-505"></a><span>
</span><a name="line-506"></a><span class="hs-identifier">opt_trans_rule</span><span> </span><a name="local-1627853498"><a href="#local-1627853498"><span class="hs-identifier">is</span></a></a><span> </span><a name="local-1627853499"><a href="#local-1627853499"><span class="hs-identifier">in_co1</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TyCoRep.html#UnivCo"><span class="hs-identifier hs-var">UnivCo</span></a><span> </span><a name="local-1627853500"><a href="#local-1627853500"><span class="hs-identifier">p1</span></a></a><span> </span><a name="local-1627853501"><a href="#local-1627853501"><span class="hs-identifier">r1</span></a></a><span> </span><a name="local-1627853502"><a href="#local-1627853502"><span class="hs-identifier">tyl1</span></a></a><span> </span><a name="local-1627853503"><a href="#local-1627853503"><span class="hs-identifier">_tyr1</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-507"></a><span>                  </span><a name="local-1627853504"><a href="#local-1627853504"><span class="hs-identifier">in_co2</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TyCoRep.html#UnivCo"><span class="hs-identifier hs-var">UnivCo</span></a><span> </span><a name="local-1627853505"><a href="#local-1627853505"><span class="hs-identifier">p2</span></a></a><span> </span><a name="local-1627853506"><a href="#local-1627853506"><span class="hs-identifier">r2</span></a></a><span> </span><a name="local-1627853507"><a href="#local-1627853507"><span class="hs-identifier">_tyl2</span></a></a><span> </span><a name="local-1627853508"><a href="#local-1627853508"><span class="hs-identifier">tyr2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-508"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1627853516"><a href="#local-1627853516"><span class="hs-identifier">prov'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627853509"><span class="hs-identifier hs-var">opt_trans_prov</span></a><span> </span><a href="#local-1627853500"><span class="hs-identifier hs-var">p1</span></a><span> </span><a href="#local-1627853505"><span class="hs-identifier hs-var">p2</span></a><span>
</span><a name="line-509"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">r1</span></a><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">r2</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-510"></a><span>    </span><a href="OptCoercion.html#fireTransRule"><span class="hs-identifier hs-var">fireTransRule</span></a><span> </span><span class="hs-string">&quot;UnivCo&quot;</span><span> </span><a href="#local-1627853499"><span class="hs-identifier hs-var">in_co1</span></a><span> </span><a href="#local-1627853504"><span class="hs-identifier hs-var">in_co2</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-511"></a><span>    </span><a href="Coercion.html#mkUnivCo"><span class="hs-identifier hs-var">mkUnivCo</span></a><span> </span><a href="#local-1627853516"><span class="hs-identifier hs-var">prov'</span></a><span> </span><a href="#local-1627853501"><span class="hs-identifier hs-var">r1</span></a><span> </span><a href="#local-1627853502"><span class="hs-identifier hs-var">tyl1</span></a><span> </span><a href="#local-1627853508"><span class="hs-identifier hs-var">tyr2</span></a><span>
</span><a name="line-512"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-513"></a><span>    </span><span class="hs-comment">-- if the provenances are different, opt'ing will be very confusing</span><span>
</span><a name="line-514"></a><span>    </span><a name="local-1627853509"><a href="#local-1627853509"><span class="hs-identifier">opt_trans_prov</span></a></a><span> </span><a href="TyCoRep.html#UnsafeCoerceProv"><span class="hs-identifier hs-var">UnsafeCoerceProv</span></a><span>      </span><a href="TyCoRep.html#UnsafeCoerceProv"><span class="hs-identifier hs-var">UnsafeCoerceProv</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="TyCoRep.html#UnsafeCoerceProv"><span class="hs-identifier hs-var">UnsafeCoerceProv</span></a><span>
</span><a name="line-515"></a><span>    </span><span class="hs-identifier">opt_trans_prov</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#PhantomProv"><span class="hs-identifier hs-var">PhantomProv</span></a><span> </span><a name="local-1627853510"><a href="#local-1627853510"><span class="hs-identifier">kco1</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-special">(</span><a href="TyCoRep.html#PhantomProv"><span class="hs-identifier hs-var">PhantomProv</span></a><span> </span><a name="local-1627853511"><a href="#local-1627853511"><span class="hs-identifier">kco2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-516"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TyCoRep.html#PhantomProv"><span class="hs-identifier hs-var">PhantomProv</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="OptCoercion.html#opt_trans"><span class="hs-identifier hs-var">opt_trans</span></a><span> </span><a href="#local-1627853498"><span class="hs-identifier hs-var">is</span></a><span> </span><a href="#local-1627853510"><span class="hs-identifier hs-var">kco1</span></a><span> </span><a href="#local-1627853511"><span class="hs-identifier hs-var">kco2</span></a><span>
</span><a name="line-517"></a><span>    </span><span class="hs-identifier">opt_trans_prov</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ProofIrrelProv"><span class="hs-identifier hs-var">ProofIrrelProv</span></a><span> </span><a name="local-1627853512"><a href="#local-1627853512"><span class="hs-identifier">kco1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ProofIrrelProv"><span class="hs-identifier hs-var">ProofIrrelProv</span></a><span> </span><a name="local-1627853513"><a href="#local-1627853513"><span class="hs-identifier">kco2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-518"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TyCoRep.html#ProofIrrelProv"><span class="hs-identifier hs-var">ProofIrrelProv</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="OptCoercion.html#opt_trans"><span class="hs-identifier hs-var">opt_trans</span></a><span> </span><a href="#local-1627853498"><span class="hs-identifier hs-var">is</span></a><span> </span><a href="#local-1627853512"><span class="hs-identifier hs-var">kco1</span></a><span> </span><a href="#local-1627853513"><span class="hs-identifier hs-var">kco2</span></a><span>
</span><a name="line-519"></a><span>    </span><span class="hs-identifier">opt_trans_prov</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#PluginProv"><span class="hs-identifier hs-var">PluginProv</span></a><span> </span><a name="local-1627853514"><a href="#local-1627853514"><span class="hs-identifier">str1</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-special">(</span><a href="TyCoRep.html#PluginProv"><span class="hs-identifier hs-var">PluginProv</span></a><span> </span><a name="local-1627853515"><a href="#local-1627853515"><span class="hs-identifier">str2</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627853514"><span class="hs-identifier hs-var">str1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-1627853515"><span class="hs-identifier hs-var">str2</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-1627853500"><span class="hs-identifier hs-var">p1</span></a><span>
</span><a name="line-520"></a><span>    </span><span class="hs-identifier">opt_trans_prov</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-521"></a><span>
</span><a name="line-522"></a><span class="hs-comment">-- Push transitivity down through matching top-level constructors.</span><span>
</span><a name="line-523"></a><span class="hs-identifier">opt_trans_rule</span><span> </span><a name="local-1627853517"><a href="#local-1627853517"><span class="hs-identifier">is</span></a></a><span> </span><a name="local-1627853518"><a href="#local-1627853518"><span class="hs-identifier">in_co1</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TyCoRep.html#TyConAppCo"><span class="hs-identifier hs-var">TyConAppCo</span></a><span> </span><a name="local-1627853519"><a href="#local-1627853519"><span class="hs-identifier">r1</span></a></a><span> </span><a name="local-1627853520"><a href="#local-1627853520"><span class="hs-identifier">tc1</span></a></a><span> </span><a name="local-1627853521"><a href="#local-1627853521"><span class="hs-identifier">cos1</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627853522"><a href="#local-1627853522"><span class="hs-identifier">in_co2</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TyCoRep.html#TyConAppCo"><span class="hs-identifier hs-var">TyConAppCo</span></a><span> </span><a name="local-1627853523"><a href="#local-1627853523"><span class="hs-identifier">r2</span></a></a><span> </span><a name="local-1627853524"><a href="#local-1627853524"><span class="hs-identifier">tc2</span></a></a><span> </span><a name="local-1627853525"><a href="#local-1627853525"><span class="hs-identifier">cos2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-524"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627853520"><span class="hs-identifier hs-var">tc1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-1627853524"><span class="hs-identifier hs-var">tc2</span></a><span>
</span><a name="line-525"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">r1</span></a><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">r2</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-526"></a><span>    </span><a href="OptCoercion.html#fireTransRule"><span class="hs-identifier hs-var">fireTransRule</span></a><span> </span><span class="hs-string">&quot;PushTyConApp&quot;</span><span> </span><a href="#local-1627853518"><span class="hs-identifier hs-var">in_co1</span></a><span> </span><a href="#local-1627853522"><span class="hs-identifier hs-var">in_co2</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-527"></a><span>    </span><a href="Coercion.html#mkTyConAppCo"><span class="hs-identifier hs-var">mkTyConAppCo</span></a><span> </span><a href="#local-1627853519"><span class="hs-identifier hs-var">r1</span></a><span> </span><a href="#local-1627853520"><span class="hs-identifier hs-var">tc1</span></a><span> </span><span class="hs-special">(</span><a href="OptCoercion.html#opt_transList"><span class="hs-identifier hs-var">opt_transList</span></a><span> </span><a href="#local-1627853517"><span class="hs-identifier hs-var">is</span></a><span> </span><a href="#local-1627853521"><span class="hs-identifier hs-var">cos1</span></a><span> </span><a href="#local-1627853525"><span class="hs-identifier hs-var">cos2</span></a><span class="hs-special">)</span><span>
</span><a name="line-528"></a><span>
</span><a name="line-529"></a><span class="hs-identifier">opt_trans_rule</span><span> </span><a name="local-1627853526"><a href="#local-1627853526"><span class="hs-identifier">is</span></a></a><span> </span><a name="local-1627853527"><a href="#local-1627853527"><span class="hs-identifier">in_co1</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TyCoRep.html#AppCo"><span class="hs-identifier hs-var">AppCo</span></a><span> </span><a name="local-1627853528"><a href="#local-1627853528"><span class="hs-identifier">co1a</span></a></a><span> </span><a name="local-1627853529"><a href="#local-1627853529"><span class="hs-identifier">co1b</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627853530"><a href="#local-1627853530"><span class="hs-identifier">in_co2</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TyCoRep.html#AppCo"><span class="hs-identifier hs-var">AppCo</span></a><span> </span><a name="local-1627853531"><a href="#local-1627853531"><span class="hs-identifier">co2a</span></a></a><span> </span><a name="local-1627853532"><a href="#local-1627853532"><span class="hs-identifier">co2b</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-530"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#fireTransRule"><span class="hs-identifier hs-var">fireTransRule</span></a><span> </span><span class="hs-string">&quot;TrPushApp&quot;</span><span> </span><a href="#local-1627853527"><span class="hs-identifier hs-var">in_co1</span></a><span> </span><a href="#local-1627853530"><span class="hs-identifier hs-var">in_co2</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-531"></a><span>    </span><a href="Coercion.html#mkAppCo"><span class="hs-identifier hs-var">mkAppCo</span></a><span> </span><span class="hs-special">(</span><a href="OptCoercion.html#opt_trans"><span class="hs-identifier hs-var">opt_trans</span></a><span> </span><a href="#local-1627853526"><span class="hs-identifier hs-var">is</span></a><span> </span><a href="#local-1627853528"><span class="hs-identifier hs-var">co1a</span></a><span> </span><a href="#local-1627853531"><span class="hs-identifier hs-var">co2a</span></a><span class="hs-special">)</span><span>
</span><a name="line-532"></a><span>            </span><span class="hs-special">(</span><a href="OptCoercion.html#opt_trans"><span class="hs-identifier hs-var">opt_trans</span></a><span> </span><a href="#local-1627853526"><span class="hs-identifier hs-var">is</span></a><span> </span><a href="#local-1627853529"><span class="hs-identifier hs-var">co1b</span></a><span> </span><a href="#local-1627853532"><span class="hs-identifier hs-var">co2b</span></a><span class="hs-special">)</span><span>
</span><a name="line-533"></a><span>
</span><a name="line-534"></a><span class="hs-comment">-- Eta rules</span><span>
</span><a name="line-535"></a><span class="hs-identifier">opt_trans_rule</span><span> </span><a name="local-1627853533"><a href="#local-1627853533"><span class="hs-identifier">is</span></a></a><span> </span><a name="local-1627853534"><a href="#local-1627853534"><span class="hs-identifier">co1</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TyCoRep.html#TyConAppCo"><span class="hs-identifier hs-var">TyConAppCo</span></a><span> </span><a name="local-1627853535"><a href="#local-1627853535"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-1627853536"><a href="#local-1627853536"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-1627853537"><a href="#local-1627853537"><span class="hs-identifier">cos1</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627853538"><a href="#local-1627853538"><span class="hs-identifier">co2</span></a></a><span>
</span><a name="line-536"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1627853539"><a href="#local-1627853539"><span class="hs-identifier">cos2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="OptCoercion.html#etaTyConAppCo_maybe"><span class="hs-identifier hs-var">etaTyConAppCo_maybe</span></a><span> </span><a href="#local-1627853536"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-1627853538"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-537"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">length</span><span> </span><span class="hs-identifier">cos1</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">length</span><span> </span><span class="hs-identifier">cos2</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-538"></a><span>    </span><a href="OptCoercion.html#fireTransRule"><span class="hs-identifier hs-var">fireTransRule</span></a><span> </span><span class="hs-string">&quot;EtaCompL&quot;</span><span> </span><a href="#local-1627853534"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-1627853538"><span class="hs-identifier hs-var">co2</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-539"></a><span>    </span><a href="Coercion.html#mkTyConAppCo"><span class="hs-identifier hs-var">mkTyConAppCo</span></a><span> </span><a href="#local-1627853535"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-1627853536"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">(</span><a href="OptCoercion.html#opt_transList"><span class="hs-identifier hs-var">opt_transList</span></a><span> </span><a href="#local-1627853533"><span class="hs-identifier hs-var">is</span></a><span> </span><a href="#local-1627853537"><span class="hs-identifier hs-var">cos1</span></a><span> </span><a href="#local-1627853539"><span class="hs-identifier hs-var">cos2</span></a><span class="hs-special">)</span><span>
</span><a name="line-540"></a><span>
</span><a name="line-541"></a><span class="hs-identifier">opt_trans_rule</span><span> </span><a name="local-1627853540"><a href="#local-1627853540"><span class="hs-identifier">is</span></a></a><span> </span><a name="local-1627853541"><a href="#local-1627853541"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-1627853542"><a href="#local-1627853542"><span class="hs-identifier">co2</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TyCoRep.html#TyConAppCo"><span class="hs-identifier hs-var">TyConAppCo</span></a><span> </span><a name="local-1627853543"><a href="#local-1627853543"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-1627853544"><a href="#local-1627853544"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-1627853545"><a href="#local-1627853545"><span class="hs-identifier">cos2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-542"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1627853546"><a href="#local-1627853546"><span class="hs-identifier">cos1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="OptCoercion.html#etaTyConAppCo_maybe"><span class="hs-identifier hs-var">etaTyConAppCo_maybe</span></a><span> </span><a href="#local-1627853544"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-1627853541"><span class="hs-identifier hs-var">co1</span></a><span>
</span><a name="line-543"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">length</span><span> </span><span class="hs-identifier">cos1</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">length</span><span> </span><span class="hs-identifier">cos2</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-544"></a><span>    </span><a href="OptCoercion.html#fireTransRule"><span class="hs-identifier hs-var">fireTransRule</span></a><span> </span><span class="hs-string">&quot;EtaCompR&quot;</span><span> </span><a href="#local-1627853541"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-1627853542"><span class="hs-identifier hs-var">co2</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-545"></a><span>    </span><a href="Coercion.html#mkTyConAppCo"><span class="hs-identifier hs-var">mkTyConAppCo</span></a><span> </span><a href="#local-1627853543"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-1627853544"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">(</span><a href="OptCoercion.html#opt_transList"><span class="hs-identifier hs-var">opt_transList</span></a><span> </span><a href="#local-1627853540"><span class="hs-identifier hs-var">is</span></a><span> </span><a href="#local-1627853546"><span class="hs-identifier hs-var">cos1</span></a><span> </span><a href="#local-1627853545"><span class="hs-identifier hs-var">cos2</span></a><span class="hs-special">)</span><span>
</span><a name="line-546"></a><span>
</span><a name="line-547"></a><span class="hs-identifier">opt_trans_rule</span><span> </span><a name="local-1627853547"><a href="#local-1627853547"><span class="hs-identifier">is</span></a></a><span> </span><a name="local-1627853548"><a href="#local-1627853548"><span class="hs-identifier">co1</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TyCoRep.html#AppCo"><span class="hs-identifier hs-var">AppCo</span></a><span> </span><a name="local-1627853549"><a href="#local-1627853549"><span class="hs-identifier">co1a</span></a></a><span> </span><a name="local-1627853550"><a href="#local-1627853550"><span class="hs-identifier">co1b</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627853551"><a href="#local-1627853551"><span class="hs-identifier">co2</span></a></a><span>
</span><a name="line-548"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1627853552"><a href="#local-1627853552"><span class="hs-identifier">co2a</span></a></a><span class="hs-special">,</span><a name="local-1627853553"><a href="#local-1627853553"><span class="hs-identifier">co2b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="OptCoercion.html#etaAppCo_maybe"><span class="hs-identifier hs-var">etaAppCo_maybe</span></a><span> </span><a href="#local-1627853551"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-549"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#fireTransRule"><span class="hs-identifier hs-var">fireTransRule</span></a><span> </span><span class="hs-string">&quot;EtaAppL&quot;</span><span> </span><a href="#local-1627853548"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-1627853551"><span class="hs-identifier hs-var">co2</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-550"></a><span>    </span><a href="Coercion.html#mkAppCo"><span class="hs-identifier hs-var">mkAppCo</span></a><span> </span><span class="hs-special">(</span><a href="OptCoercion.html#opt_trans"><span class="hs-identifier hs-var">opt_trans</span></a><span> </span><a href="#local-1627853547"><span class="hs-identifier hs-var">is</span></a><span> </span><a href="#local-1627853549"><span class="hs-identifier hs-var">co1a</span></a><span> </span><a href="#local-1627853552"><span class="hs-identifier hs-var">co2a</span></a><span class="hs-special">)</span><span>
</span><a name="line-551"></a><span>            </span><span class="hs-special">(</span><a href="OptCoercion.html#opt_trans"><span class="hs-identifier hs-var">opt_trans</span></a><span> </span><a href="#local-1627853547"><span class="hs-identifier hs-var">is</span></a><span> </span><a href="#local-1627853550"><span class="hs-identifier hs-var">co1b</span></a><span> </span><a href="#local-1627853553"><span class="hs-identifier hs-var">co2b</span></a><span class="hs-special">)</span><span>
</span><a name="line-552"></a><span>
</span><a name="line-553"></a><span class="hs-identifier">opt_trans_rule</span><span> </span><a name="local-1627853554"><a href="#local-1627853554"><span class="hs-identifier">is</span></a></a><span> </span><a name="local-1627853555"><a href="#local-1627853555"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-1627853556"><a href="#local-1627853556"><span class="hs-identifier">co2</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TyCoRep.html#AppCo"><span class="hs-identifier hs-var">AppCo</span></a><span> </span><a name="local-1627853557"><a href="#local-1627853557"><span class="hs-identifier">co2a</span></a></a><span> </span><a name="local-1627853558"><a href="#local-1627853558"><span class="hs-identifier">co2b</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-554"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1627853559"><a href="#local-1627853559"><span class="hs-identifier">co1a</span></a></a><span class="hs-special">,</span><a name="local-1627853560"><a href="#local-1627853560"><span class="hs-identifier">co1b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="OptCoercion.html#etaAppCo_maybe"><span class="hs-identifier hs-var">etaAppCo_maybe</span></a><span> </span><a href="#local-1627853555"><span class="hs-identifier hs-var">co1</span></a><span>
</span><a name="line-555"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#fireTransRule"><span class="hs-identifier hs-var">fireTransRule</span></a><span> </span><span class="hs-string">&quot;EtaAppR&quot;</span><span> </span><a href="#local-1627853555"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-1627853556"><span class="hs-identifier hs-var">co2</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-556"></a><span>    </span><a href="Coercion.html#mkAppCo"><span class="hs-identifier hs-var">mkAppCo</span></a><span> </span><span class="hs-special">(</span><a href="OptCoercion.html#opt_trans"><span class="hs-identifier hs-var">opt_trans</span></a><span> </span><a href="#local-1627853554"><span class="hs-identifier hs-var">is</span></a><span> </span><a href="#local-1627853559"><span class="hs-identifier hs-var">co1a</span></a><span> </span><a href="#local-1627853557"><span class="hs-identifier hs-var">co2a</span></a><span class="hs-special">)</span><span>
</span><a name="line-557"></a><span>            </span><span class="hs-special">(</span><a href="OptCoercion.html#opt_trans"><span class="hs-identifier hs-var">opt_trans</span></a><span> </span><a href="#local-1627853554"><span class="hs-identifier hs-var">is</span></a><span> </span><a href="#local-1627853560"><span class="hs-identifier hs-var">co1b</span></a><span> </span><a href="#local-1627853558"><span class="hs-identifier hs-var">co2b</span></a><span class="hs-special">)</span><span>
</span><a name="line-558"></a><span>
</span><a name="line-559"></a><span class="hs-comment">-- Push transitivity inside forall</span><span>
</span><a name="line-560"></a><span class="hs-identifier">opt_trans_rule</span><span> </span><a name="local-1627853561"><a href="#local-1627853561"><span class="hs-identifier">is</span></a></a><span> </span><a name="local-1627853562"><a href="#local-1627853562"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-1627853563"><a href="#local-1627853563"><span class="hs-identifier">co2</span></a></a><span>
</span><a name="line-561"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TyCoRep.html#ForAllCo"><span class="hs-identifier hs-var">ForAllCo</span></a><span> </span><a name="local-1627853573"><a href="#local-1627853573"><span class="hs-identifier">tv1</span></a></a><span> </span><a name="local-1627853574"><a href="#local-1627853574"><span class="hs-identifier">eta1</span></a></a><span> </span><a name="local-1627853575"><a href="#local-1627853575"><span class="hs-identifier">r1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627853562"><span class="hs-identifier hs-var">co1</span></a><span>
</span><a name="line-562"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1627853576"><a href="#local-1627853576"><span class="hs-identifier">tv2</span></a></a><span class="hs-special">,</span><a name="local-1627853577"><a href="#local-1627853577"><span class="hs-identifier">eta2</span></a></a><span class="hs-special">,</span><a name="local-1627853578"><a href="#local-1627853578"><span class="hs-identifier">r2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="OptCoercion.html#etaForAllCo_maybe"><span class="hs-identifier hs-var">etaForAllCo_maybe</span></a><span> </span><a href="#local-1627853563"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-563"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627853564"><span class="hs-identifier hs-var">push_trans</span></a><span> </span><a href="#local-1627853573"><span class="hs-identifier hs-var">tv1</span></a><span> </span><a href="#local-1627853574"><span class="hs-identifier hs-var">eta1</span></a><span> </span><a href="#local-1627853575"><span class="hs-identifier hs-var">r1</span></a><span> </span><a href="#local-1627853576"><span class="hs-identifier hs-var">tv2</span></a><span> </span><a href="#local-1627853577"><span class="hs-identifier hs-var">eta2</span></a><span> </span><a href="#local-1627853578"><span class="hs-identifier hs-var">r2</span></a><span>
</span><a name="line-564"></a><span>
</span><a name="line-565"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TyCoRep.html#ForAllCo"><span class="hs-identifier hs-var">ForAllCo</span></a><span> </span><a name="local-1627853579"><a href="#local-1627853579"><span class="hs-identifier">tv2</span></a></a><span> </span><a name="local-1627853580"><a href="#local-1627853580"><span class="hs-identifier">eta2</span></a></a><span> </span><a name="local-1627853581"><a href="#local-1627853581"><span class="hs-identifier">r2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627853563"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-566"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1627853582"><a href="#local-1627853582"><span class="hs-identifier">tv1</span></a></a><span class="hs-special">,</span><a name="local-1627853583"><a href="#local-1627853583"><span class="hs-identifier">eta1</span></a></a><span class="hs-special">,</span><a name="local-1627853584"><a href="#local-1627853584"><span class="hs-identifier">r1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="OptCoercion.html#etaForAllCo_maybe"><span class="hs-identifier hs-var">etaForAllCo_maybe</span></a><span> </span><a href="#local-1627853562"><span class="hs-identifier hs-var">co1</span></a><span>
</span><a name="line-567"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627853564"><span class="hs-identifier hs-var">push_trans</span></a><span> </span><a href="#local-1627853582"><span class="hs-identifier hs-var">tv1</span></a><span> </span><a href="#local-1627853583"><span class="hs-identifier hs-var">eta1</span></a><span> </span><a href="#local-1627853584"><span class="hs-identifier hs-var">r1</span></a><span> </span><a href="#local-1627853579"><span class="hs-identifier hs-var">tv2</span></a><span> </span><a href="#local-1627853580"><span class="hs-identifier hs-var">eta2</span></a><span> </span><a href="#local-1627853581"><span class="hs-identifier hs-var">r2</span></a><span>
</span><a name="line-568"></a><span>
</span><a name="line-569"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-570"></a><span>  </span><a name="local-1627853564"><a href="#local-1627853564"><span class="hs-identifier">push_trans</span></a></a><span> </span><a name="local-1627853565"><a href="#local-1627853565"><span class="hs-identifier">tv1</span></a></a><span> </span><a name="local-1627853566"><a href="#local-1627853566"><span class="hs-identifier">eta1</span></a></a><span> </span><a name="local-1627853567"><a href="#local-1627853567"><span class="hs-identifier">r1</span></a></a><span> </span><a name="local-1627853568"><a href="#local-1627853568"><span class="hs-identifier">tv2</span></a></a><span> </span><a name="local-1627853569"><a href="#local-1627853569"><span class="hs-identifier">eta2</span></a></a><span> </span><a name="local-1627853570"><a href="#local-1627853570"><span class="hs-identifier">r2</span></a></a><span>
</span><a name="line-571"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#fireTransRule"><span class="hs-identifier hs-var">fireTransRule</span></a><span> </span><span class="hs-string">&quot;EtaAllTy&quot;</span><span> </span><a href="#local-1627853562"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-1627853563"><span class="hs-identifier hs-var">co2</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-572"></a><span>      </span><a href="Coercion.html#mkForAllCo"><span class="hs-identifier hs-var">mkForAllCo</span></a><span> </span><a href="#local-1627853565"><span class="hs-identifier hs-var">tv1</span></a><span> </span><span class="hs-special">(</span><a href="OptCoercion.html#opt_trans"><span class="hs-identifier hs-var">opt_trans</span></a><span> </span><a href="#local-1627853561"><span class="hs-identifier hs-var">is</span></a><span> </span><a href="#local-1627853566"><span class="hs-identifier hs-var">eta1</span></a><span> </span><a href="#local-1627853569"><span class="hs-identifier hs-var">eta2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="OptCoercion.html#opt_trans"><span class="hs-identifier hs-var">opt_trans</span></a><span> </span><a href="#local-1627853571"><span class="hs-identifier hs-var">is'</span></a><span> </span><a href="#local-1627853567"><span class="hs-identifier hs-var">r1</span></a><span> </span><a href="#local-1627853572"><span class="hs-identifier hs-var">r2'</span></a><span class="hs-special">)</span><span>
</span><a name="line-573"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-574"></a><span>      </span><a name="local-1627853571"><a href="#local-1627853571"><span class="hs-identifier">is'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627853561"><span class="hs-identifier hs-var">is</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#extendInScopeSet"><span class="hs-identifier hs-var">extendInScopeSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627853565"><span class="hs-identifier hs-var">tv1</span></a><span>
</span><a name="line-575"></a><span>      </span><a name="local-1627853572"><a href="#local-1627853572"><span class="hs-identifier">r2'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substCoWithUnchecked"><span class="hs-identifier hs-var">substCoWithUnchecked</span></a><span> </span><span class="hs-special">[</span><a href="#local-1627853568"><span class="hs-identifier hs-var">tv2</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#TyVarTy"><span class="hs-identifier hs-var">TyVarTy</span></a><span> </span><a href="#local-1627853565"><span class="hs-identifier hs-var">tv1</span></a><span class="hs-special">]</span><span> </span><a href="#local-1627853570"><span class="hs-identifier hs-var">r2</span></a><span>
</span><a name="line-576"></a><span>
</span><a name="line-577"></a><span class="hs-comment">-- Push transitivity inside axioms</span><span>
</span><a name="line-578"></a><span class="hs-identifier">opt_trans_rule</span><span> </span><a name="local-1627853585"><a href="#local-1627853585"><span class="hs-identifier">is</span></a></a><span> </span><a name="local-1627853586"><a href="#local-1627853586"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-1627853587"><a href="#local-1627853587"><span class="hs-identifier">co2</span></a></a><span>
</span><a name="line-579"></a><span>
</span><a name="line-580"></a><span>  </span><span class="hs-comment">-- See Note [Why call checkAxInstCo during optimisation]</span><span>
</span><a name="line-581"></a><span>  </span><span class="hs-comment">-- TrPushSymAxR</span><span>
</span><a name="line-582"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1627853591"><a href="#local-1627853591"><span class="hs-identifier">sym</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853592"><a href="#local-1627853592"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853593"><a href="#local-1627853593"><span class="hs-identifier">ind</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853594"><a href="#local-1627853594"><span class="hs-identifier">cos1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627853588"><span class="hs-identifier hs-var">co1_is_axiom_maybe</span></a><span>
</span><a name="line-583"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627853591"><span class="hs-identifier hs-var">sym</span></a><span>
</span><a name="line-584"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1627853595"><a href="#local-1627853595"><span class="hs-identifier">cos2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="OptCoercion.html#matchAxiom"><span class="hs-identifier hs-var">matchAxiom</span></a><span> </span><a href="#local-1627853591"><span class="hs-identifier hs-var">sym</span></a><span> </span><a href="#local-1627853592"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-1627853593"><span class="hs-identifier hs-var">ind</span></a><span> </span><a href="#local-1627853587"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-585"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1627853596"><a href="#local-1627853596"><span class="hs-identifier">newAxInst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#AxiomInstCo"><span class="hs-identifier hs-var">AxiomInstCo</span></a><span> </span><a href="#local-1627853592"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-1627853593"><span class="hs-identifier hs-var">ind</span></a><span> </span><span class="hs-special">(</span><a href="OptCoercion.html#opt_transList"><span class="hs-identifier hs-var">opt_transList</span></a><span> </span><a href="#local-1627853585"><span class="hs-identifier hs-var">is</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a><span> </span><a href="#local-1627853595"><span class="hs-identifier hs-var">cos2</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627853594"><span class="hs-identifier hs-var">cos1</span></a><span class="hs-special">)</span><span>
</span><a name="line-586"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="OptCoercion.html#checkAxInstCo"><span class="hs-identifier hs-var">checkAxInstCo</span></a><span> </span><a href="#local-1627853596"><span class="hs-identifier hs-var">newAxInst</span></a><span>
</span><a name="line-587"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#fireTransRule"><span class="hs-identifier hs-var">fireTransRule</span></a><span> </span><span class="hs-string">&quot;TrPushSymAxR&quot;</span><span> </span><a href="#local-1627853586"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-1627853587"><span class="hs-identifier hs-var">co2</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TyCoRep.html#SymCo"><span class="hs-identifier hs-var">SymCo</span></a><span> </span><a href="#local-1627853596"><span class="hs-identifier hs-var">newAxInst</span></a><span>
</span><a name="line-588"></a><span>
</span><a name="line-589"></a><span>  </span><span class="hs-comment">-- TrPushAxR</span><span>
</span><a name="line-590"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1627853597"><a href="#local-1627853597"><span class="hs-identifier">sym</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853598"><a href="#local-1627853598"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853599"><a href="#local-1627853599"><span class="hs-identifier">ind</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853600"><a href="#local-1627853600"><span class="hs-identifier">cos1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627853588"><span class="hs-identifier hs-var">co1_is_axiom_maybe</span></a><span>
</span><a name="line-591"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627853597"><span class="hs-identifier hs-var">sym</span></a><span>
</span><a name="line-592"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1627853601"><a href="#local-1627853601"><span class="hs-identifier">cos2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="OptCoercion.html#matchAxiom"><span class="hs-identifier hs-var">matchAxiom</span></a><span> </span><a href="#local-1627853597"><span class="hs-identifier hs-var">sym</span></a><span> </span><a href="#local-1627853598"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-1627853599"><span class="hs-identifier hs-var">ind</span></a><span> </span><a href="#local-1627853587"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-593"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1627853602"><a href="#local-1627853602"><span class="hs-identifier">newAxInst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#AxiomInstCo"><span class="hs-identifier hs-var">AxiomInstCo</span></a><span> </span><a href="#local-1627853598"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-1627853599"><span class="hs-identifier hs-var">ind</span></a><span> </span><span class="hs-special">(</span><a href="OptCoercion.html#opt_transList"><span class="hs-identifier hs-var">opt_transList</span></a><span> </span><a href="#local-1627853585"><span class="hs-identifier hs-var">is</span></a><span> </span><a href="#local-1627853600"><span class="hs-identifier hs-var">cos1</span></a><span> </span><a href="#local-1627853601"><span class="hs-identifier hs-var">cos2</span></a><span class="hs-special">)</span><span>
</span><a name="line-594"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="OptCoercion.html#checkAxInstCo"><span class="hs-identifier hs-var">checkAxInstCo</span></a><span> </span><a href="#local-1627853602"><span class="hs-identifier hs-var">newAxInst</span></a><span>
</span><a name="line-595"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#fireTransRule"><span class="hs-identifier hs-var">fireTransRule</span></a><span> </span><span class="hs-string">&quot;TrPushAxR&quot;</span><span> </span><a href="#local-1627853586"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-1627853587"><span class="hs-identifier hs-var">co2</span></a><span> </span><a href="#local-1627853602"><span class="hs-identifier hs-var">newAxInst</span></a><span>
</span><a name="line-596"></a><span>
</span><a name="line-597"></a><span>  </span><span class="hs-comment">-- TrPushSymAxL</span><span>
</span><a name="line-598"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1627853603"><a href="#local-1627853603"><span class="hs-identifier">sym</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853604"><a href="#local-1627853604"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853605"><a href="#local-1627853605"><span class="hs-identifier">ind</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853606"><a href="#local-1627853606"><span class="hs-identifier">cos2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627853589"><span class="hs-identifier hs-var">co2_is_axiom_maybe</span></a><span>
</span><a name="line-599"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627853603"><span class="hs-identifier hs-var">sym</span></a><span>
</span><a name="line-600"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1627853607"><a href="#local-1627853607"><span class="hs-identifier">cos1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="OptCoercion.html#matchAxiom"><span class="hs-identifier hs-var">matchAxiom</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-1627853603"><span class="hs-identifier hs-var">sym</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627853604"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-1627853605"><span class="hs-identifier hs-var">ind</span></a><span> </span><a href="#local-1627853586"><span class="hs-identifier hs-var">co1</span></a><span>
</span><a name="line-601"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1627853608"><a href="#local-1627853608"><span class="hs-identifier">newAxInst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#AxiomInstCo"><span class="hs-identifier hs-var">AxiomInstCo</span></a><span> </span><a href="#local-1627853604"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-1627853605"><span class="hs-identifier hs-var">ind</span></a><span> </span><span class="hs-special">(</span><a href="OptCoercion.html#opt_transList"><span class="hs-identifier hs-var">opt_transList</span></a><span> </span><a href="#local-1627853585"><span class="hs-identifier hs-var">is</span></a><span> </span><a href="#local-1627853606"><span class="hs-identifier hs-var">cos2</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a><span> </span><a href="#local-1627853607"><span class="hs-identifier hs-var">cos1</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-602"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="OptCoercion.html#checkAxInstCo"><span class="hs-identifier hs-var">checkAxInstCo</span></a><span> </span><a href="#local-1627853608"><span class="hs-identifier hs-var">newAxInst</span></a><span>
</span><a name="line-603"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#fireTransRule"><span class="hs-identifier hs-var">fireTransRule</span></a><span> </span><span class="hs-string">&quot;TrPushSymAxL&quot;</span><span> </span><a href="#local-1627853586"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-1627853587"><span class="hs-identifier hs-var">co2</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TyCoRep.html#SymCo"><span class="hs-identifier hs-var">SymCo</span></a><span> </span><a href="#local-1627853608"><span class="hs-identifier hs-var">newAxInst</span></a><span>
</span><a name="line-604"></a><span>
</span><a name="line-605"></a><span>  </span><span class="hs-comment">-- TrPushAxL</span><span>
</span><a name="line-606"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1627853609"><a href="#local-1627853609"><span class="hs-identifier">sym</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853610"><a href="#local-1627853610"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853611"><a href="#local-1627853611"><span class="hs-identifier">ind</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853612"><a href="#local-1627853612"><span class="hs-identifier">cos2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627853589"><span class="hs-identifier hs-var">co2_is_axiom_maybe</span></a><span>
</span><a name="line-607"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627853609"><span class="hs-identifier hs-var">sym</span></a><span>
</span><a name="line-608"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1627853613"><a href="#local-1627853613"><span class="hs-identifier">cos1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="OptCoercion.html#matchAxiom"><span class="hs-identifier hs-var">matchAxiom</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-1627853609"><span class="hs-identifier hs-var">sym</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627853610"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-1627853611"><span class="hs-identifier hs-var">ind</span></a><span> </span><a href="#local-1627853586"><span class="hs-identifier hs-var">co1</span></a><span>
</span><a name="line-609"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1627853614"><a href="#local-1627853614"><span class="hs-identifier">newAxInst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#AxiomInstCo"><span class="hs-identifier hs-var">AxiomInstCo</span></a><span> </span><a href="#local-1627853610"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-1627853611"><span class="hs-identifier hs-var">ind</span></a><span> </span><span class="hs-special">(</span><a href="OptCoercion.html#opt_transList"><span class="hs-identifier hs-var">opt_transList</span></a><span> </span><a href="#local-1627853585"><span class="hs-identifier hs-var">is</span></a><span> </span><a href="#local-1627853613"><span class="hs-identifier hs-var">cos1</span></a><span> </span><a href="#local-1627853612"><span class="hs-identifier hs-var">cos2</span></a><span class="hs-special">)</span><span>
</span><a name="line-610"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="OptCoercion.html#checkAxInstCo"><span class="hs-identifier hs-var">checkAxInstCo</span></a><span> </span><a href="#local-1627853614"><span class="hs-identifier hs-var">newAxInst</span></a><span>
</span><a name="line-611"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#fireTransRule"><span class="hs-identifier hs-var">fireTransRule</span></a><span> </span><span class="hs-string">&quot;TrPushAxL&quot;</span><span> </span><a href="#local-1627853586"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-1627853587"><span class="hs-identifier hs-var">co2</span></a><span> </span><a href="#local-1627853614"><span class="hs-identifier hs-var">newAxInst</span></a><span>
</span><a name="line-612"></a><span>
</span><a name="line-613"></a><span>  </span><span class="hs-comment">-- TrPushAxSym/TrPushSymAx</span><span>
</span><a name="line-614"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1627853615"><a href="#local-1627853615"><span class="hs-identifier">sym1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853616"><a href="#local-1627853616"><span class="hs-identifier">con1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853617"><a href="#local-1627853617"><span class="hs-identifier">ind1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853618"><a href="#local-1627853618"><span class="hs-identifier">cos1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627853588"><span class="hs-identifier hs-var">co1_is_axiom_maybe</span></a><span>
</span><a name="line-615"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1627853619"><a href="#local-1627853619"><span class="hs-identifier">sym2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853620"><a href="#local-1627853620"><span class="hs-identifier">con2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853621"><a href="#local-1627853621"><span class="hs-identifier">ind2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853622"><a href="#local-1627853622"><span class="hs-identifier">cos2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627853589"><span class="hs-identifier hs-var">co2_is_axiom_maybe</span></a><span>
</span><a name="line-616"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-1627853616"><span class="hs-identifier hs-var">con1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-1627853620"><span class="hs-identifier hs-var">con2</span></a><span>
</span><a name="line-617"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-1627853617"><span class="hs-identifier hs-var">ind1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-1627853621"><span class="hs-identifier hs-var">ind2</span></a><span>
</span><a name="line-618"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-1627853615"><span class="hs-identifier hs-var">sym1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-1627853619"><span class="hs-identifier hs-var">sym2</span></a><span>
</span><a name="line-619"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1627853623"><a href="#local-1627853623"><span class="hs-identifier">branch</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#coAxiomNthBranch"><span class="hs-identifier hs-var">coAxiomNthBranch</span></a><span> </span><a href="#local-1627853616"><span class="hs-identifier hs-var">con1</span></a><span> </span><a href="#local-1627853617"><span class="hs-identifier hs-var">ind1</span></a><span>
</span><a name="line-620"></a><span>        </span><a name="local-1627853624"><a href="#local-1627853624"><span class="hs-identifier">qtvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#coAxBranchTyVars"><span class="hs-identifier hs-var">coAxBranchTyVars</span></a><span> </span><a href="#local-1627853623"><span class="hs-identifier hs-var">branch</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="CoAxiom.html#coAxBranchCoVars"><span class="hs-identifier hs-var">coAxBranchCoVars</span></a><span> </span><a href="#local-1627853623"><span class="hs-identifier hs-var">branch</span></a><span>
</span><a name="line-621"></a><span>        </span><a name="local-1627853625"><a href="#local-1627853625"><span class="hs-identifier">lhs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#coAxNthLHS"><span class="hs-identifier hs-var">coAxNthLHS</span></a><span> </span><a href="#local-1627853616"><span class="hs-identifier hs-var">con1</span></a><span> </span><a href="#local-1627853617"><span class="hs-identifier hs-var">ind1</span></a><span>
</span><a name="line-622"></a><span>        </span><a name="local-1627853626"><a href="#local-1627853626"><span class="hs-identifier">rhs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#coAxBranchRHS"><span class="hs-identifier hs-var">coAxBranchRHS</span></a><span> </span><a href="#local-1627853623"><span class="hs-identifier hs-var">branch</span></a><span>
</span><a name="line-623"></a><span>        </span><a name="local-1627853627"><a href="#local-1627853627"><span class="hs-identifier">pivot_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcType.html#exactTyCoVarsOfType"><span class="hs-identifier hs-var">exactTyCoVarsOfType</span></a><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><a href="#local-1627853619"><span class="hs-identifier hs-var">sym2</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-1627853626"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-1627853625"><span class="hs-identifier hs-var">lhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-624"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="VarSet.html#elemVarSet"><span class="hs-identifier hs-var">elemVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627853627"><span class="hs-identifier hs-var">pivot_tvs</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627853624"><span class="hs-identifier hs-var">qtvs</span></a><span>
</span><a name="line-625"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#fireTransRule"><span class="hs-identifier hs-var">fireTransRule</span></a><span> </span><span class="hs-string">&quot;TrPushAxSym&quot;</span><span> </span><a href="#local-1627853586"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-1627853587"><span class="hs-identifier hs-var">co2</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-626"></a><span>    </span><span class="hs-keyword">if</span><span> </span><a href="#local-1627853619"><span class="hs-identifier hs-var">sym2</span></a><span>
</span><a name="line-627"></a><span>       </span><span class="hs-comment">-- TrPushAxSym</span><span>
</span><a name="line-628"></a><span>    </span><span class="hs-keyword">then</span><span> </span><a href="Coercion.html#liftCoSubstWith"><span class="hs-identifier hs-var">liftCoSubstWith</span></a><span> </span><a href="#local-1627853590"><span class="hs-identifier hs-var">role</span></a><span> </span><a href="#local-1627853624"><span class="hs-identifier hs-var">qtvs</span></a><span> </span><span class="hs-special">(</span><a href="OptCoercion.html#opt_transList"><span class="hs-identifier hs-var">opt_transList</span></a><span> </span><a href="#local-1627853585"><span class="hs-identifier hs-var">is</span></a><span> </span><a href="#local-1627853618"><span class="hs-identifier hs-var">cos1</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a><span> </span><a href="#local-1627853622"><span class="hs-identifier hs-var">cos2</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-1627853625"><span class="hs-identifier hs-var">lhs</span></a><span>
</span><a name="line-629"></a><span>       </span><span class="hs-comment">-- TrPushSymAx</span><span>
</span><a name="line-630"></a><span>    </span><span class="hs-keyword">else</span><span> </span><a href="Coercion.html#liftCoSubstWith"><span class="hs-identifier hs-var">liftCoSubstWith</span></a><span> </span><a href="#local-1627853590"><span class="hs-identifier hs-var">role</span></a><span> </span><a href="#local-1627853624"><span class="hs-identifier hs-var">qtvs</span></a><span> </span><span class="hs-special">(</span><a href="OptCoercion.html#opt_transList"><span class="hs-identifier hs-var">opt_transList</span></a><span> </span><a href="#local-1627853585"><span class="hs-identifier hs-var">is</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a><span> </span><a href="#local-1627853618"><span class="hs-identifier hs-var">cos1</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627853622"><span class="hs-identifier hs-var">cos2</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627853626"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-631"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-632"></a><span>    </span><a name="local-1627853588"><a href="#local-1627853588"><span class="hs-identifier">co1_is_axiom_maybe</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#isAxiom_maybe"><span class="hs-identifier hs-var">isAxiom_maybe</span></a><span> </span><a href="#local-1627853586"><span class="hs-identifier hs-var">co1</span></a><span>
</span><a name="line-633"></a><span>    </span><a name="local-1627853589"><a href="#local-1627853589"><span class="hs-identifier">co2_is_axiom_maybe</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#isAxiom_maybe"><span class="hs-identifier hs-var">isAxiom_maybe</span></a><span> </span><a href="#local-1627853587"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-634"></a><span>    </span><a name="local-1627853590"><a href="#local-1627853590"><span class="hs-identifier">role</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#coercionRole"><span class="hs-identifier hs-var">coercionRole</span></a><span> </span><a href="#local-1627853586"><span class="hs-identifier hs-var">co1</span></a><span> </span><span class="hs-comment">-- should be the same as coercionRole co2!</span><span>
</span><a name="line-635"></a><span>
</span><a name="line-636"></a><span class="hs-identifier">opt_trans_rule</span><span> </span><a name="local-1627853628"><a href="#local-1627853628"><span class="hs-identifier">is</span></a></a><span> </span><a name="local-1627853629"><a href="#local-1627853629"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-1627853630"><a href="#local-1627853630"><span class="hs-identifier">co2</span></a></a><span>
</span><a name="line-637"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1627853631"><a href="#local-1627853631"><span class="hs-identifier">lco</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853632"><a href="#local-1627853632"><span class="hs-identifier">lh</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="OptCoercion.html#isCohRight_maybe"><span class="hs-identifier hs-var">isCohRight_maybe</span></a><span> </span><a href="#local-1627853629"><span class="hs-identifier hs-var">co1</span></a><span>
</span><a name="line-638"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1627853633"><a href="#local-1627853633"><span class="hs-identifier">rco</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853634"><a href="#local-1627853634"><span class="hs-identifier">rh</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="OptCoercion.html#isCohLeft_maybe"><span class="hs-identifier hs-var">isCohLeft_maybe</span></a><span> </span><a href="#local-1627853630"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-639"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#coercionType"><span class="hs-identifier hs-var">coercionType</span></a><span> </span><a href="#local-1627853632"><span class="hs-identifier hs-var">lh</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="Type.html#eqType"><span class="hs-identifier hs-var">eqType</span></a><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#coercionType"><span class="hs-identifier hs-var">coercionType</span></a><span> </span><a href="#local-1627853634"><span class="hs-identifier hs-var">rh</span></a><span class="hs-special">)</span><span>
</span><a name="line-640"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#opt_trans_rule"><span class="hs-identifier hs-var">opt_trans_rule</span></a><span> </span><a href="#local-1627853628"><span class="hs-identifier hs-var">is</span></a><span> </span><a href="#local-1627853631"><span class="hs-identifier hs-var">lco</span></a><span> </span><a href="#local-1627853633"><span class="hs-identifier hs-var">rco</span></a><span>
</span><a name="line-641"></a><span>
</span><a name="line-642"></a><span class="hs-identifier">opt_trans_rule</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627853635"><a href="#local-1627853635"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-1627853636"><a href="#local-1627853636"><span class="hs-identifier">co2</span></a></a><span>        </span><span class="hs-comment">-- Identity rule</span><span>
</span><a name="line-643"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-1627853637"><a href="#local-1627853637"><span class="hs-identifier">ty1</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-1627853638"><a href="#local-1627853638"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#coercionKindRole"><span class="hs-identifier hs-var">coercionKindRole</span></a><span> </span><a href="#local-1627853635"><span class="hs-identifier hs-var">co1</span></a><span>
</span><a name="line-644"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627853639"><a href="#local-1627853639"><span class="hs-identifier">ty2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span> </span><a href="#local-1627853636"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-645"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-1627853637"><span class="hs-identifier hs-var">ty1</span></a><span> </span><span class="hs-special">`</span><a href="Type.html#eqType"><span class="hs-identifier hs-var">eqType</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627853639"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-646"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#fireTransRule"><span class="hs-identifier hs-var">fireTransRule</span></a><span> </span><span class="hs-string">&quot;RedTypeDirRefl&quot;</span><span> </span><a href="#local-1627853635"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-1627853636"><span class="hs-identifier hs-var">co2</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-647"></a><span>    </span><a href="TyCoRep.html#Refl"><span class="hs-identifier hs-var">Refl</span></a><span> </span><a href="#local-1627853638"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-1627853639"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-648"></a><span>
</span><a name="line-649"></a><span class="hs-identifier">opt_trans_rule</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-650"></a><span>
</span><a name="line-651"></a><span class="hs-identifier">fireTransRule</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-652"></a><a name="fireTransRule"><a href="OptCoercion.html#fireTransRule"><span class="hs-identifier">fireTransRule</span></a></a><span> </span><a name="local-1627853640"><a href="#local-1627853640"><span class="hs-identifier">_rule</span></a></a><span> </span><a name="local-1627853641"><a href="#local-1627853641"><span class="hs-identifier">_co1</span></a></a><span> </span><a name="local-1627853642"><a href="#local-1627853642"><span class="hs-identifier">_co2</span></a></a><span> </span><a name="local-1627853643"><a href="#local-1627853643"><span class="hs-identifier">res</span></a></a><span>
</span><a name="line-653"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace (&quot;Trans rule fired: &quot; ++ _rule) (vcat [ppr _co1, ppr _co2, ppr res]) $</span><span>
</span><a name="line-654"></a><span>    </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-1627853643"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-655"></a><span>
</span><a name="line-656"></a><span class="hs-comment">{-
Note [Conflict checking with AxiomInstCo]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider the following type family and axiom:

type family Equal (a :: k) (b :: k) :: Bool
type instance where
  Equal a a = True
  Equal a b = False
--
Equal :: forall k::*. k -&gt; k -&gt; Bool
axEqual :: { forall k::*. forall a::k. Equal k a a ~ True
           ; forall k::*. forall a::k. forall b::k. Equal k a b ~ False }

We wish to disallow (axEqual[1] &lt;*&gt; &lt;Int&gt; &lt;Int). (Recall that the index is
0-based, so this is the second branch of the axiom.) The problem is that, on
the surface, it seems that (axEqual[1] &lt;*&gt; &lt;Int&gt; &lt;Int&gt;) :: (Equal * Int Int ~
False) and that all is OK. But, all is not OK: we want to use the first branch
of the axiom in this case, not the second. The problem is that the parameters
of the first branch can unify with the supplied coercions, thus meaning that
the first branch should be taken. See also Note [Apartness] in
types/FamInstEnv.hs.

Note [Why call checkAxInstCo during optimisation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It is possible that otherwise-good-looking optimisations meet with disaster
in the presence of axioms with multiple equations. Consider

type family Equal (a :: *) (b :: *) :: Bool where
  Equal a a = True
  Equal a b = False
type family Id (a :: *) :: * where
  Id a = a

axEq :: { [a::*].       Equal a a ~ True
        ; [a::*, b::*]. Equal a b ~ False }
axId :: [a::*]. Id a ~ a

co1 = Equal (axId[0] Int) (axId[0] Bool)
  :: Equal (Id Int) (Id Bool) ~  Equal Int Bool
co2 = axEq[1] &lt;Int&gt; &lt;Bool&gt;
  :: Equal Int Bool ~ False

We wish to optimise (co1 ; co2). We end up in rule TrPushAxL, noting that
co2 is an axiom and that matchAxiom succeeds when looking at co1. But, what
happens when we push the coercions inside? We get

co3 = axEq[1] (axId[0] Int) (axId[0] Bool)
  :: Equal (Id Int) (Id Bool) ~ False

which is bogus! This is because the type system isn't smart enough to know
that (Id Int) and (Id Bool) are Surely Apart, as they're headed by type
families. At the time of writing, I (Richard Eisenberg) couldn't think of
a way of detecting this any more efficient than just building the optimised
coercion and checking.
-}</span><span>
</span><a name="line-712"></a><span>
</span><a name="line-713"></a><span class="hs-comment">-- | Check to make sure that an AxInstCo is internally consistent.</span><span>
</span><a name="line-714"></a><span class="hs-comment">-- Returns the conflicting branch, if it exists</span><span>
</span><a name="line-715"></a><span class="hs-comment">-- See Note [Conflict checking with AxiomInstCo]</span><span>
</span><a name="line-716"></a><span class="hs-identifier">checkAxInstCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span>
</span><a name="line-717"></a><span class="hs-comment">-- defined here to avoid dependencies in Coercion</span><span>
</span><a name="line-718"></a><span class="hs-comment">-- If you edit this function, you may need to update the GHC formalism</span><span>
</span><a name="line-719"></a><span class="hs-comment">-- See Note [GHC Formalism] in CoreLint</span><span>
</span><a name="line-720"></a><a name="checkAxInstCo"><a href="OptCoercion.html#checkAxInstCo"><span class="hs-identifier">checkAxInstCo</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AxiomInstCo"><span class="hs-identifier hs-var">AxiomInstCo</span></a><span> </span><a name="local-1627853644"><a href="#local-1627853644"><span class="hs-identifier">ax</span></a></a><span> </span><a name="local-1627853645"><a href="#local-1627853645"><span class="hs-identifier">ind</span></a></a><span> </span><a name="local-1627853646"><a href="#local-1627853646"><span class="hs-identifier">cos</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-721"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1627853652"><a href="#local-1627853652"><span class="hs-identifier">branch</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#coAxiomNthBranch"><span class="hs-identifier hs-var">coAxiomNthBranch</span></a><span> </span><a href="#local-1627853644"><span class="hs-identifier hs-var">ax</span></a><span> </span><a href="#local-1627853645"><span class="hs-identifier hs-var">ind</span></a><span>
</span><a name="line-722"></a><span>        </span><a name="local-1627853653"><a href="#local-1627853653"><span class="hs-identifier">tvs</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#coAxBranchTyVars"><span class="hs-identifier hs-var">coAxBranchTyVars</span></a><span> </span><a href="#local-1627853652"><span class="hs-identifier hs-var">branch</span></a><span>
</span><a name="line-723"></a><span>        </span><a name="local-1627853654"><a href="#local-1627853654"><span class="hs-identifier">cvs</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#coAxBranchCoVars"><span class="hs-identifier hs-var">coAxBranchCoVars</span></a><span> </span><a href="#local-1627853652"><span class="hs-identifier hs-var">branch</span></a><span>
</span><a name="line-724"></a><span>        </span><a name="local-1627853655"><a href="#local-1627853655"><span class="hs-identifier">incomps</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#coAxBranchIncomps"><span class="hs-identifier hs-var">coAxBranchIncomps</span></a><span> </span><a href="#local-1627853652"><span class="hs-identifier hs-var">branch</span></a><span>
</span><a name="line-725"></a><span>        </span><span class="hs-special">(</span><a name="local-1627853656"><a href="#local-1627853656"><span class="hs-identifier">tys</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853657"><a href="#local-1627853657"><span class="hs-identifier">cotys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#splitAtList"><span class="hs-identifier hs-var">splitAtList</span></a><span> </span><a href="#local-1627853653"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">pFst</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627853646"><span class="hs-identifier hs-var">cos</span></a><span class="hs-special">)</span><span>
</span><a name="line-726"></a><span>        </span><a name="local-1627853658"><a href="#local-1627853658"><span class="hs-identifier">co_args</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="Type.html#stripCoercionTy"><span class="hs-identifier hs-var">stripCoercionTy</span></a><span> </span><a href="#local-1627853657"><span class="hs-identifier hs-var">cotys</span></a><span>
</span><a name="line-727"></a><span>        </span><a name="local-1627853659"><a href="#local-1627853659"><span class="hs-identifier">subst</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#zipTvSubst"><span class="hs-identifier hs-var">zipTvSubst</span></a><span> </span><a href="#local-1627853653"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-1627853656"><span class="hs-identifier hs-var">tys</span></a><span> </span><span class="hs-special">`</span><a href="TyCoRep.html#composeTCvSubst"><span class="hs-identifier hs-var">composeTCvSubst</span></a><span class="hs-special">`</span><span>
</span><a name="line-728"></a><span>                       </span><a href="TyCoRep.html#zipCvSubst"><span class="hs-identifier hs-var">zipCvSubst</span></a><span> </span><a href="#local-1627853654"><span class="hs-identifier hs-var">cvs</span></a><span> </span><a href="#local-1627853658"><span class="hs-identifier hs-var">co_args</span></a><span>
</span><a name="line-729"></a><span>        </span><a name="local-1627853660"><a href="#local-1627853660"><span class="hs-identifier">target</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substTys"><span class="hs-identifier hs-var">Type</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">substTys</span></a><span> </span><a href="#local-1627853659"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">(</span><a href="CoAxiom.html#coAxBranchLHS"><span class="hs-identifier hs-var">coAxBranchLHS</span></a><span> </span><a href="#local-1627853652"><span class="hs-identifier hs-var">branch</span></a><span class="hs-special">)</span><span>
</span><a name="line-730"></a><span>        </span><a name="local-1627853661"><a href="#local-1627853661"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#mkInScopeSet"><span class="hs-identifier hs-var">mkInScopeSet</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-731"></a><span>                   </span><a href="VarSet.html#unionVarSets"><span class="hs-identifier hs-var">unionVarSets</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#tyCoVarsOfTypes"><span class="hs-identifier hs-var">tyCoVarsOfTypes</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="CoAxiom.html#coAxBranchLHS"><span class="hs-identifier hs-var">coAxBranchLHS</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627853655"><span class="hs-identifier hs-var">incomps</span></a><span class="hs-special">)</span><span>
</span><a name="line-732"></a><span>        </span><a name="local-1627853662"><a href="#local-1627853662"><span class="hs-identifier">flattened_target</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#flattenTys"><span class="hs-identifier hs-var">flattenTys</span></a><span> </span><a href="#local-1627853661"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-1627853660"><span class="hs-identifier hs-var">target</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-733"></a><span>    </span><a href="#local-1627853647"><span class="hs-identifier hs-var">check_no_conflict</span></a><span> </span><a href="#local-1627853662"><span class="hs-identifier hs-var">flattened_target</span></a><span> </span><a href="#local-1627853655"><span class="hs-identifier hs-var">incomps</span></a><span>
</span><a name="line-734"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-735"></a><span>    </span><span class="hs-identifier">check_no_conflict</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span>
</span><a name="line-736"></a><span>    </span><a name="local-1627853647"><a href="#local-1627853647"><span class="hs-identifier">check_no_conflict</span></a></a><span> </span><span class="hs-identifier">_</span><span>    </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-737"></a><span>    </span><span class="hs-identifier">check_no_conflict</span><span> </span><a name="local-1627853648"><a href="#local-1627853648"><span class="hs-identifier">flat</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1627853649"><a href="#local-1627853649"><span class="hs-identifier">b</span></a></a><span class="hs-glyph">@</span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-var">CoAxBranch</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cab_lhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1627853650"><a href="#local-1627853650"><span class="hs-identifier">lhs_incomp</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-1627853651"><a href="#local-1627853651"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-738"></a><span>         </span><span class="hs-comment">-- See Note [Apartness] in FamInstEnv</span><span>
</span><a name="line-739"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="Unify.html#SurelyApart"><span class="hs-identifier hs-var">SurelyApart</span></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Unify.html#tcUnifyTysFG"><span class="hs-identifier hs-var">tcUnifyTysFG</span></a><span> </span><a href="InstEnv.html#instanceBindFun"><span class="hs-identifier hs-var">instanceBindFun</span></a><span> </span><a href="#local-1627853648"><span class="hs-identifier hs-var">flat</span></a><span> </span><a href="#local-1627853650"><span class="hs-identifier hs-var">lhs_incomp</span></a><span>
</span><a name="line-740"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627853647"><span class="hs-identifier hs-var">check_no_conflict</span></a><span> </span><a href="#local-1627853648"><span class="hs-identifier hs-var">flat</span></a><span> </span><a href="#local-1627853651"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-741"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-742"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-1627853649"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-743"></a><span class="hs-identifier">checkAxInstCo</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-744"></a><span>
</span><a name="line-745"></a><span>
</span><a name="line-746"></a><span class="hs-comment">-----------</span><span>
</span><a name="line-747"></a><span class="hs-identifier">wrapSym</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OptCoercion.html#SymFlag"><span class="hs-identifier hs-type">SymFlag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-748"></a><a name="wrapSym"><a href="OptCoercion.html#wrapSym"><span class="hs-identifier">wrapSym</span></a></a><span> </span><a name="local-1627853663"><a href="#local-1627853663"><span class="hs-identifier">sym</span></a></a><span> </span><a name="local-1627853664"><a href="#local-1627853664"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627853663"><span class="hs-identifier hs-var">sym</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#SymCo"><span class="hs-identifier hs-var">SymCo</span></a><span> </span><a href="#local-1627853664"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-749"></a><span>               </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627853664"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-750"></a><span>
</span><a name="line-751"></a><span class="hs-comment">-- | Conditionally set a role to be representational</span><span>
</span><a name="line-752"></a><span class="hs-identifier">wrapRole</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OptCoercion.html#ReprFlag"><span class="hs-identifier hs-type">ReprFlag</span></a><span>
</span><a name="line-753"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span>         </span><span class="hs-comment">-- ^ current role</span><span>
</span><a name="line-754"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-755"></a><a name="wrapRole"><a href="OptCoercion.html#wrapRole"><span class="hs-identifier">wrapRole</span></a></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-identifier">_</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#id"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-756"></a><span class="hs-identifier">wrapRole</span><span> </span><span class="hs-identifier hs-var">True</span><span>  </span><a name="local-1627853665"><a href="#local-1627853665"><span class="hs-identifier">current</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#downgradeRole"><span class="hs-identifier hs-var">downgradeRole</span></a><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span> </span><a href="#local-1627853665"><span class="hs-identifier hs-var">current</span></a><span>
</span><a name="line-757"></a><span>
</span><a name="line-758"></a><span class="hs-comment">-- | If we require a representational role, return that. Otherwise,</span><span>
</span><a name="line-759"></a><span class="hs-comment">-- return the &quot;default&quot; role provided.</span><span>
</span><a name="line-760"></a><span class="hs-identifier">chooseRole</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OptCoercion.html#ReprFlag"><span class="hs-identifier hs-type">ReprFlag</span></a><span>
</span><a name="line-761"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span>    </span><span class="hs-comment">-- ^ &quot;default&quot; role</span><span>
</span><a name="line-762"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span>
</span><a name="line-763"></a><a name="chooseRole"><a href="OptCoercion.html#chooseRole"><span class="hs-identifier">chooseRole</span></a></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span>
</span><a name="line-764"></a><span class="hs-identifier">chooseRole</span><span> </span><span class="hs-identifier">_</span><span>    </span><a name="local-1627853666"><a href="#local-1627853666"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627853666"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-765"></a><span>
</span><a name="line-766"></a><span class="hs-comment">-----------</span><span>
</span><a name="line-767"></a><span class="hs-identifier">isAxiom_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span> </span><a href="CoAxiom.html#CoAxiom"><span class="hs-identifier hs-type">CoAxiom</span></a><span> </span><a href="CoAxiom.html#Branched"><span class="hs-identifier hs-type">Branched</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-768"></a><a name="isAxiom_maybe"><a href="OptCoercion.html#isAxiom_maybe"><span class="hs-identifier">isAxiom_maybe</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#SymCo"><span class="hs-identifier hs-var">SymCo</span></a><span> </span><a name="local-1627853667"><a href="#local-1627853667"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-769"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1627853668"><a href="#local-1627853668"><span class="hs-identifier">sym</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853669"><a href="#local-1627853669"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853670"><a href="#local-1627853670"><span class="hs-identifier">ind</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853671"><a href="#local-1627853671"><span class="hs-identifier">cos</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="OptCoercion.html#isAxiom_maybe"><span class="hs-identifier hs-var">isAxiom_maybe</span></a><span> </span><a href="#local-1627853667"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-770"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-1627853668"><span class="hs-identifier hs-var">sym</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627853669"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627853670"><span class="hs-identifier hs-var">ind</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627853671"><span class="hs-identifier hs-var">cos</span></a><span class="hs-special">)</span><span>
</span><a name="line-771"></a><span class="hs-identifier">isAxiom_maybe</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AxiomInstCo"><span class="hs-identifier hs-var">AxiomInstCo</span></a><span> </span><a name="local-1627853672"><a href="#local-1627853672"><span class="hs-identifier">con</span></a></a><span> </span><a name="local-1627853673"><a href="#local-1627853673"><span class="hs-identifier">ind</span></a></a><span> </span><a name="local-1627853674"><a href="#local-1627853674"><span class="hs-identifier">cos</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-772"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><a href="#local-1627853672"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627853673"><span class="hs-identifier hs-var">ind</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627853674"><span class="hs-identifier hs-var">cos</span></a><span class="hs-special">)</span><span>
</span><a name="line-773"></a><span class="hs-identifier">isAxiom_maybe</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-774"></a><span>
</span><a name="line-775"></a><span class="hs-identifier">matchAxiom</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-comment">-- True = match LHS, False = match RHS</span><span>
</span><a name="line-776"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#CoAxiom"><span class="hs-identifier hs-type">CoAxiom</span></a><span> </span><a href="#local-1627853209"><span class="hs-identifier hs-type">br</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">]</span><span>
</span><a name="line-777"></a><a name="matchAxiom"><a href="OptCoercion.html#matchAxiom"><span class="hs-identifier">matchAxiom</span></a></a><span> </span><a name="local-1627853675"><a href="#local-1627853675"><span class="hs-identifier">sym</span></a></a><span> </span><a name="local-1627853676"><a href="#local-1627853676"><span class="hs-identifier">ax</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoAxiom.html#CoAxiom"><span class="hs-identifier hs-var">CoAxiom</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">co_ax_tc</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1627853677"><a href="#local-1627853677"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-1627853678"><a href="#local-1627853678"><span class="hs-identifier">ind</span></a></a><span> </span><a name="local-1627853679"><a href="#local-1627853679"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-778"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-var">CoAxBranch</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cab_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1627853680"><a href="#local-1627853680"><span class="hs-identifier">qtvs</span></a></a><span>
</span><a name="line-779"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_cvs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- can't infer these, so fail if there are any</span><span>
</span><a name="line-780"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_roles</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1627853681"><a href="#local-1627853681"><span class="hs-identifier">roles</span></a></a><span>
</span><a name="line-781"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_lhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1627853682"><a href="#local-1627853682"><span class="hs-identifier">lhs</span></a></a><span>
</span><a name="line-782"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1627853683"><a href="#local-1627853683"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoAxiom.html#coAxiomNthBranch"><span class="hs-identifier hs-var">coAxiomNthBranch</span></a><span> </span><a href="#local-1627853676"><span class="hs-identifier hs-var">ax</span></a><span> </span><a href="#local-1627853678"><span class="hs-identifier hs-var">ind</span></a><span>
</span><a name="line-783"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1627853684"><a href="#local-1627853684"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Unify.html#liftCoMatch"><span class="hs-identifier hs-var">liftCoMatch</span></a><span> </span><span class="hs-special">(</span><a href="VarSet.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a><span> </span><a href="#local-1627853680"><span class="hs-identifier hs-var">qtvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-784"></a><span>                              </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><a href="#local-1627853675"><span class="hs-identifier hs-var">sym</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><a href="Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a><span> </span><a href="#local-1627853677"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-1627853682"><span class="hs-identifier hs-var">lhs</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-1627853683"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-785"></a><span>                              </span><a href="#local-1627853679"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-786"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="Coercion.html#isMappedByLC"><span class="hs-identifier hs-var">isMappedByLC</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627853684"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627853680"><span class="hs-identifier hs-var">qtvs</span></a><span>
</span><a name="line-787"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html#zipWithM"><span class="hs-identifier hs-var">zipWithM</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#liftCoSubstTyVar"><span class="hs-identifier hs-var">liftCoSubstTyVar</span></a><span> </span><a href="#local-1627853684"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627853681"><span class="hs-identifier hs-var">roles</span></a><span> </span><a href="#local-1627853680"><span class="hs-identifier hs-var">qtvs</span></a><span>
</span><a name="line-788"></a><span>
</span><a name="line-789"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-790"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-791"></a><span>
</span><a name="line-792"></a><span class="hs-comment">-------------</span><span>
</span><a name="line-793"></a><span class="hs-comment">-- destruct a CoherenceCo</span><span>
</span><a name="line-794"></a><span class="hs-identifier">isCohLeft_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">)</span><span>
</span><a name="line-795"></a><a name="isCohLeft_maybe"><a href="OptCoercion.html#isCohLeft_maybe"><span class="hs-identifier">isCohLeft_maybe</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CoherenceCo"><span class="hs-identifier hs-var">CoherenceCo</span></a><span> </span><a name="local-1627853685"><a href="#local-1627853685"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-1627853686"><a href="#local-1627853686"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627853685"><span class="hs-identifier hs-var">co1</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627853686"><span class="hs-identifier hs-var">co2</span></a><span class="hs-special">)</span><span>
</span><a name="line-796"></a><span class="hs-identifier">isCohLeft_maybe</span><span> </span><span class="hs-identifier">_</span><span>                     </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-797"></a><span>
</span><a name="line-798"></a><span class="hs-comment">-- destruct a (sym (co1 |&gt; co2)).</span><span>
</span><a name="line-799"></a><span class="hs-comment">-- if isCohRight_maybe co = Just (co1, co2), then (sym co1) `mkCohRightCo` co2 = co</span><span>
</span><a name="line-800"></a><span class="hs-identifier">isCohRight_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">)</span><span>
</span><a name="line-801"></a><a name="isCohRight_maybe"><a href="OptCoercion.html#isCohRight_maybe"><span class="hs-identifier">isCohRight_maybe</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#SymCo"><span class="hs-identifier hs-var">SymCo</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CoherenceCo"><span class="hs-identifier hs-var">CoherenceCo</span></a><span> </span><a name="local-1627853687"><a href="#local-1627853687"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-1627853688"><a href="#local-1627853688"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a><span> </span><a href="#local-1627853687"><span class="hs-identifier hs-var">co1</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627853688"><span class="hs-identifier hs-var">co2</span></a><span class="hs-special">)</span><span>
</span><a name="line-802"></a><span class="hs-identifier">isCohRight_maybe</span><span> </span><span class="hs-identifier">_</span><span>                             </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-803"></a><span>
</span><a name="line-804"></a><span class="hs-comment">-------------</span><span>
</span><a name="line-805"></a><span class="hs-identifier">compatible_co</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-806"></a><span class="hs-comment">-- Check whether (co1 . co2) will be well-kinded</span><span>
</span><a name="line-807"></a><a name="compatible_co"><a href="OptCoercion.html#compatible_co"><span class="hs-identifier">compatible_co</span></a></a><span> </span><a name="local-1627853689"><a href="#local-1627853689"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-1627853690"><a href="#local-1627853690"><span class="hs-identifier">co2</span></a></a><span>
</span><a name="line-808"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627853691"><span class="hs-identifier hs-var">x1</span></a><span> </span><span class="hs-special">`</span><a href="Type.html#eqType"><span class="hs-identifier hs-var">eqType</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627853692"><span class="hs-identifier hs-var">x2</span></a><span>
</span><a name="line-809"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-810"></a><span>    </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627853691"><a href="#local-1627853691"><span class="hs-identifier">x1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span> </span><a href="#local-1627853689"><span class="hs-identifier hs-var">co1</span></a><span>
</span><a name="line-811"></a><span>    </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-1627853692"><a href="#local-1627853692"><span class="hs-identifier">x2</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span> </span><a href="#local-1627853690"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-812"></a><span>
</span><a name="line-813"></a><span class="hs-comment">-------------</span><span>
</span><a name="line-814"></a><span class="hs-comment">{-
etaForAllCo_maybe
~~~~~~~~~~~~~~~~~
Suppose we have

  g : all a1:k1.t1  ~  all a2:k2.t2

but g is *not* a ForAllCo. We want to eta-expand it. So, we do this:

  g' = all a1:(ForAllKindCo g).(InstCo g (a1 `mkCoherenceRightCo` ForAllKindCo g))

Call the kind coercion h1 and the body coercion h2. We can see that

  h2 : t1 ~ t2[a2 |-&gt; (a1 |&gt; h2)]

According to the typing rule for ForAllCo, we get that

  g' : all a1:k1.t1  ~  all a1:k2.(t2[a2 |-&gt; (a1 |&gt; h2)][a1 |-&gt; a1 |&gt; sym h2])

or

  g' : all a1:k1.t1  ~  all a1:k2.(t2[a2 |-&gt; a1])

as desired.
-}</span><span>
</span><a name="line-839"></a><span class="hs-identifier">etaForAllCo_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">)</span><span>
</span><a name="line-840"></a><span class="hs-comment">-- Try to make the coercion be of form (forall tv:kind_co. co)</span><span>
</span><a name="line-841"></a><a name="etaForAllCo_maybe"><a href="OptCoercion.html#etaForAllCo_maybe"><span class="hs-identifier">etaForAllCo_maybe</span></a></a><span> </span><a name="local-1627853693"><a href="#local-1627853693"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-842"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TyCoRep.html#ForAllCo"><span class="hs-identifier hs-var">ForAllCo</span></a><span> </span><a name="local-1627853694"><a href="#local-1627853694"><span class="hs-identifier">tv</span></a></a><span> </span><a name="local-1627853695"><a href="#local-1627853695"><span class="hs-identifier">kind_co</span></a></a><span> </span><a name="local-1627853696"><a href="#local-1627853696"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627853693"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-843"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627853694"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627853695"><span class="hs-identifier hs-var">kind_co</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627853696"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-844"></a><span>
</span><a name="line-845"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-1627853697"><a href="#local-1627853697"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-1627853698"><a href="#local-1627853698"><span class="hs-identifier">ty2</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span> </span><a href="#local-1627853693"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-846"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1627853699"><a href="#local-1627853699"><span class="hs-identifier">tv1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitForAllTy_maybe"><span class="hs-identifier hs-var">splitForAllTy_maybe</span></a><span> </span><a href="#local-1627853697"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-847"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Type.html#isForAllTy"><span class="hs-identifier hs-var">isForAllTy</span></a><span> </span><a href="#local-1627853698"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-848"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1627853700"><a href="#local-1627853700"><span class="hs-identifier">kind_co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkNthCo"><span class="hs-identifier hs-var">mkNthCo</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-1627853693"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-849"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="#local-1627853699"><span class="hs-identifier hs-var">tv1</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627853700"><span class="hs-identifier hs-var">kind_co</span></a><span>
</span><a name="line-850"></a><span>         </span><span class="hs-special">,</span><span> </span><a href="Coercion.html#mkInstCo"><span class="hs-identifier hs-var">mkInstCo</span></a><span> </span><a href="#local-1627853693"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyVarTy"><span class="hs-identifier hs-var">TyVarTy</span></a><span> </span><a href="#local-1627853699"><span class="hs-identifier hs-var">tv1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="Coercion.html#mkCoherenceRightCo"><span class="hs-identifier hs-var">mkCoherenceRightCo</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627853700"><span class="hs-identifier hs-var">kind_co</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-851"></a><span>
</span><a name="line-852"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-853"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-854"></a><span>
</span><a name="line-855"></a><span class="hs-identifier">etaAppCo_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">,</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">)</span><span>
</span><a name="line-856"></a><span class="hs-comment">-- If possible, split a coercion</span><span>
</span><a name="line-857"></a><span class="hs-comment">--   g :: t1a t1b ~ t2a t2b</span><span>
</span><a name="line-858"></a><span class="hs-comment">-- into a pair of coercions (left g, right g)</span><span>
</span><a name="line-859"></a><a name="etaAppCo_maybe"><a href="OptCoercion.html#etaAppCo_maybe"><span class="hs-identifier">etaAppCo_maybe</span></a></a><span> </span><a name="local-1627853701"><a href="#local-1627853701"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-860"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1627853702"><a href="#local-1627853702"><span class="hs-identifier">co1</span></a></a><span class="hs-special">,</span><a name="local-1627853703"><a href="#local-1627853703"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#splitAppCo_maybe"><span class="hs-identifier hs-var">splitAppCo_maybe</span></a><span> </span><a href="#local-1627853701"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-861"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627853702"><span class="hs-identifier hs-var">co1</span></a><span class="hs-special">,</span><a href="#local-1627853703"><span class="hs-identifier hs-var">co2</span></a><span class="hs-special">)</span><span>
</span><a name="line-862"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-1627853704"><a href="#local-1627853704"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-1627853705"><a href="#local-1627853705"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">,</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#coercionKindRole"><span class="hs-identifier hs-var">coercionKindRole</span></a><span> </span><a href="#local-1627853701"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-863"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-1627853706"><a href="#local-1627853706"><span class="hs-identifier">t1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitAppTy_maybe"><span class="hs-identifier hs-var">splitAppTy_maybe</span></a><span> </span><a href="#local-1627853704"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-864"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-1627853707"><a href="#local-1627853707"><span class="hs-identifier">t2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitAppTy_maybe"><span class="hs-identifier hs-var">splitAppTy_maybe</span></a><span> </span><a href="#local-1627853705"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-865"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1627853708"><a href="#local-1627853708"><span class="hs-identifier">isco1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#isCoercionTy"><span class="hs-identifier hs-var">isCoercionTy</span></a><span> </span><a href="#local-1627853706"><span class="hs-identifier hs-var">t1</span></a><span>
</span><a name="line-866"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1627853709"><a href="#local-1627853709"><span class="hs-identifier">isco2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#isCoercionTy"><span class="hs-identifier hs-var">isCoercionTy</span></a><span> </span><a href="#local-1627853707"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-867"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-1627853708"><span class="hs-identifier hs-var">isco1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-1627853709"><span class="hs-identifier hs-var">isco2</span></a><span>
</span><a name="line-868"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#LRCo"><span class="hs-identifier hs-var">LRCo</span></a><span> </span><a href="TyCoRep.html#CLeft"><span class="hs-identifier hs-var">CLeft</span></a><span> </span><a href="#local-1627853701"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#LRCo"><span class="hs-identifier hs-var">LRCo</span></a><span> </span><a href="TyCoRep.html#CRight"><span class="hs-identifier hs-var">CRight</span></a><span> </span><a href="#local-1627853701"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-869"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-870"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-871"></a><span>
</span><a name="line-872"></a><span class="hs-identifier">etaTyConAppCo_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">]</span><span>
</span><a name="line-873"></a><span class="hs-comment">-- If possible, split a coercion</span><span>
</span><a name="line-874"></a><span class="hs-comment">--       g :: T s1 .. sn ~ T t1 .. tn</span><span>
</span><a name="line-875"></a><span class="hs-comment">-- into [ Nth 0 g :: s1~t1, ..., Nth (n-1) g :: sn~tn ]</span><span>
</span><a name="line-876"></a><a name="etaTyConAppCo_maybe"><a href="OptCoercion.html#etaTyConAppCo_maybe"><span class="hs-identifier">etaTyConAppCo_maybe</span></a></a><span> </span><a name="local-1627853710"><a href="#local-1627853710"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyConAppCo"><span class="hs-identifier hs-var">TyConAppCo</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1627853711"><a href="#local-1627853711"><span class="hs-identifier">tc2</span></a></a><span> </span><a name="local-1627853712"><a href="#local-1627853712"><span class="hs-identifier">cos2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-877"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">tc2</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier">Just</span><span> </span><span class="hs-identifier">cos2</span><span>
</span><a name="line-878"></a><span>
</span><a name="line-879"></a><span class="hs-identifier">etaTyConAppCo_maybe</span><span> </span><a name="local-1627853713"><a href="#local-1627853713"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-1627853714"><a href="#local-1627853714"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-880"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TyCon.html#mightBeUnsaturatedTyCon"><span class="hs-identifier hs-var">mightBeUnsaturatedTyCon</span></a><span> </span><a href="#local-1627853713"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-881"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-1627853715"><a href="#local-1627853715"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-1627853716"><a href="#local-1627853716"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853717"><a href="#local-1627853717"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#coercionKindRole"><span class="hs-identifier hs-var">coercionKindRole</span></a><span> </span><a href="#local-1627853714"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-882"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1627853718"><a href="#local-1627853718"><span class="hs-identifier">tc1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853719"><a href="#local-1627853719"><span class="hs-identifier">tys1</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-var">splitTyConApp_maybe</span></a><span> </span><a href="#local-1627853715"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-883"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1627853720"><a href="#local-1627853720"><span class="hs-identifier">tc2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627853721"><a href="#local-1627853721"><span class="hs-identifier">tys2</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-var">splitTyConApp_maybe</span></a><span> </span><a href="#local-1627853716"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-884"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-1627853718"><span class="hs-identifier hs-var">tc1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-1627853720"><span class="hs-identifier hs-var">tc2</span></a><span>
</span><a name="line-885"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="TyCon.html#isInjectiveTyCon"><span class="hs-identifier hs-var">isInjectiveTyCon</span></a><span> </span><a href="#local-1627853713"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-1627853717"><span class="hs-identifier hs-var">r</span></a><span>  </span><span class="hs-comment">-- See Note [NthCo and newtypes] in TyCoRep</span><span>
</span><a name="line-886"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1627853722"><a href="#local-1627853722"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><a href="#local-1627853719"><span class="hs-identifier hs-var">tys1</span></a><span>
</span><a name="line-887"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">tc1</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-888"></a><span>    </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="Util.html#debugIsOn"><span class="hs-operator hs-var">==</span></a><span> </span><span class="hs-identifier">length</span><span> </span><span class="hs-identifier">tys2</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-889"></a><span>    </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#decomposeCo"><span class="hs-identifier hs-var">decomposeCo</span></a><span> </span><a href="#local-1627853722"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-1627853714"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-890"></a><span>    </span><span class="hs-comment">-- NB: n might be &lt;&gt; tyConArity tc</span><span>
</span><a name="line-891"></a><span>    </span><span class="hs-comment">-- e.g.   data family T a :: * -&gt; *</span><span>
</span><a name="line-892"></a><span>    </span><span class="hs-comment">--        g :: T a b ~ T c d</span><span>
</span><a name="line-893"></a><span>
</span><a name="line-894"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-895"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-896"></a><span>
</span><a name="line-897"></a><span class="hs-comment">{-
Note [Eta for AppCo]
~~~~~~~~~~~~~~~~~~~~
Suppose we have
   g :: s1 t1 ~ s2 t2

Then we can't necessarily make
   left  g :: s1 ~ s2
   right g :: t1 ~ t2
because it's possible that
   s1 :: * -&gt; *         t1 :: *
   s2 :: (*-&gt;*) -&gt; *    t2 :: * -&gt; *
and in that case (left g) does not have the same
kind on either side.

It's enough to check that
  kind t1 = kind t2
because if g is well-kinded then
  kind (s1 t2) = kind (s2 t2)
and these two imply
  kind s1 = kind s2

-}</span><span>
</span><a name="line-920"></a><span>
</span><a name="line-921"></a><span class="hs-identifier">optForAllCoBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-922"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">)</span><span>
</span><a name="line-923"></a><a name="optForAllCoBndr"><a href="OptCoercion.html#optForAllCoBndr"><span class="hs-identifier">optForAllCoBndr</span></a></a><span> </span><a name="local-1627853723"><a href="#local-1627853723"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-1627853724"><a href="#local-1627853724"><span class="hs-identifier">sym</span></a></a><span>
</span><a name="line-924"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#substForAllCoBndrCallbackLC"><span class="hs-identifier hs-var">substForAllCoBndrCallbackLC</span></a><span> </span><a href="#local-1627853724"><span class="hs-identifier hs-var">sym</span></a><span> </span><span class="hs-special">(</span><a href="OptCoercion.html#opt_co4_wrap"><span class="hs-identifier hs-var">opt_co4_wrap</span></a><span> </span><a href="#local-1627853723"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627853724"><span class="hs-identifier hs-var">sym</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627853723"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-925"></a></pre></body></html>