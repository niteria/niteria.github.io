<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">TcInteract</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-4"></a><span>     </span><a href="TcInteract.html#solveSimpleGivens"><span class="hs-identifier hs-var">solveSimpleGivens</span></a><span class="hs-special">,</span><span>   </span><span class="hs-comment">-- Solves [Ct]</span><span>
</span><a name="line-5"></a><span>     </span><a href="TcInteract.html#solveSimpleWanteds"><span class="hs-identifier hs-var">solveSimpleWanteds</span></a><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- Solves Cts</span><span>
</span><a name="line-6"></a><span>
</span><a name="line-7"></a><span>     </span><a href="TcInteract.html#solveCallStack"><span class="hs-identifier hs-var">solveCallStack</span></a><span class="hs-special">,</span><span>      </span><span class="hs-comment">-- for use in TcSimplify</span><span>
</span><a name="line-8"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-9"></a><span>
</span><a name="line-10"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><a href="BasicTypes.html"><span class="hs-identifier">BasicTypes</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="BasicTypes.html#infinity"><span class="hs-identifier hs-var">infinity</span></a><span class="hs-special">,</span><span> </span><a href="BasicTypes.html#IntWithInf"><span class="hs-identifier hs-type">IntWithInf</span></a><span class="hs-special">,</span><span> </span><a href="BasicTypes.html#intGtLimit"><span class="hs-identifier hs-var">intGtLimit</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><a href="HsTypes.html"><span class="hs-identifier">HsTypes</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="HsTypes.html#HsIPName"><span class="hs-identifier hs-type">HsIPName</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><a href="TcCanonical.html"><span class="hs-identifier">TcCanonical</span></a><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><a href="TcFlatten.html"><span class="hs-identifier">TcFlatten</span></a><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><a href="VarSet.html"><span class="hs-identifier">VarSet</span></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><a href="Type.html"><span class="hs-identifier">Type</span></a><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><a href="InstEnv.html"><span class="hs-identifier">InstEnv</span></a><span class="hs-special">(</span><span> </span><a href="InstEnv.html#DFunInstType"><span class="hs-identifier hs-type">DFunInstType</span></a><span class="hs-special">,</span><span> </span><a href="InstEnv.html#lookupInstEnv"><span class="hs-identifier hs-var">lookupInstEnv</span></a><span class="hs-special">,</span><span> </span><a href="InstEnv.html#instanceDFunId"><span class="hs-identifier hs-var">instanceDFunId</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><a href="CoAxiom.html"><span class="hs-identifier">CoAxiom</span></a><span class="hs-special">(</span><span> </span><a href="CoAxiom.html#sfInteractTop"><span class="hs-identifier hs-var">sfInteractTop</span></a><span class="hs-special">,</span><span> </span><a href="CoAxiom.html#sfInteractInert"><span class="hs-identifier hs-var">sfInteractInert</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-20"></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="Var.html"><span class="hs-identifier">Var</span></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="TcType.html"><span class="hs-identifier">TcType</span></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="Name.html"><span class="hs-identifier">Name</span></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><a href="PrelNames.html"><span class="hs-identifier">PrelNames</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="PrelNames.html#knownNatClassName"><span class="hs-identifier hs-var">knownNatClassName</span></a><span class="hs-special">,</span><span> </span><a href="PrelNames.html#knownSymbolClassName"><span class="hs-identifier hs-var">knownSymbolClassName</span></a><span class="hs-special">,</span><span>
</span><a name="line-25"></a><span>                   </span><a href="PrelNames.html#typeableClassName"><span class="hs-identifier hs-var">typeableClassName</span></a><span class="hs-special">,</span><span> </span><a href="PrelNames.html#coercibleTyConKey"><span class="hs-identifier hs-var">coercibleTyConKey</span></a><span class="hs-special">,</span><span>
</span><a name="line-26"></a><span>                   </span><a href="PrelNames.html#heqTyConKey"><span class="hs-identifier hs-var">heqTyConKey</span></a><span class="hs-special">,</span><span> </span><a href="PrelNames.html#ipClassKey"><span class="hs-identifier hs-var">ipClassKey</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="TysWiredIn.html"><span class="hs-identifier">TysWiredIn</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="TysWiredIn.html#typeNatKind"><span class="hs-identifier hs-var">typeNatKind</span></a><span class="hs-special">,</span><span> </span><a href="TysWiredIn.html#typeSymbolKind"><span class="hs-identifier hs-var">typeSymbolKind</span></a><span class="hs-special">,</span><span> </span><a href="TysWiredIn.html#heqDataCon"><span class="hs-identifier hs-var">heqDataCon</span></a><span class="hs-special">,</span><span>
</span><a name="line-28"></a><span>                    </span><a href="TysWiredIn.html#coercibleDataCon"><span class="hs-identifier hs-var">coercibleDataCon</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="TysPrim.html"><span class="hs-identifier">TysPrim</span></a><span>    </span><span class="hs-special">(</span><span> </span><a href="TysPrim.html#eqPrimTyCon"><span class="hs-identifier hs-var">eqPrimTyCon</span></a><span class="hs-special">,</span><span> </span><a href="TysPrim.html#eqReprPrimTyCon"><span class="hs-identifier hs-var">eqReprPrimTyCon</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="Id.html"><span class="hs-identifier">Id</span></a><span class="hs-special">(</span><span> </span><a href="Id.html#idType"><span class="hs-identifier hs-var">idType</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="CoAxiom.html"><span class="hs-identifier">CoAxiom</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="CoAxiom.html#Eqn"><span class="hs-identifier hs-type">Eqn</span></a><span class="hs-special">,</span><span> </span><a href="CoAxiom.html#CoAxiom"><span class="hs-identifier hs-type">CoAxiom</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="CoAxiom.html#fromBranches"><span class="hs-identifier hs-var">fromBranches</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><a href="Class.html"><span class="hs-identifier">Class</span></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="TyCon.html"><span class="hs-identifier">TyCon</span></a><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><a href="DataCon.html"><span class="hs-identifier">DataCon</span></a><span class="hs-special">(</span><span> </span><a href="DataCon.html#dataConWrapId"><span class="hs-identifier hs-var">dataConWrapId</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><a href="FunDeps.html"><span class="hs-identifier">FunDeps</span></a><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><a href="FamInst.html"><span class="hs-identifier">FamInst</span></a><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><a href="FamInstEnv.html"><span class="hs-identifier">FamInstEnv</span></a><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><a href="Unify.html"><span class="hs-identifier">Unify</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="Unify.html#tcUnifyTyWithTFs"><span class="hs-identifier hs-var">tcUnifyTyWithTFs</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><a href="TcEvidence.html"><span class="hs-identifier">TcEvidence</span></a><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><a href="Outputable.html"><span class="hs-identifier">Outputable</span></a><span>
</span><a name="line-42"></a><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnTypes.html"><span class="hs-identifier">TcRnTypes</span></a><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><a href="TcSMonad.html"><span class="hs-identifier">TcSMonad</span></a><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><a href="Bag.html"><span class="hs-identifier">Bag</span></a><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><a href="MonadUtils.html"><span class="hs-identifier">MonadUtils</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="MonadUtils.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.List.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span></a><span class="hs-special">(</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.OldList.html#partition"><span class="hs-identifier hs-var">partition</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#foldl%27"><span class="hs-identifier hs-var">foldl'</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.OldList.html#deleteFirstsBy"><span class="hs-identifier hs-var">deleteFirstsBy</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><a href="SrcLoc.html"><span class="hs-identifier">SrcLoc</span></a><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><a href="VarEnv.html"><span class="hs-identifier">VarEnv</span></a><span>
</span><a name="line-51"></a><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html"><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span></a><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><a href="Maybes.html"><span class="hs-identifier">Maybes</span></a><span class="hs-special">(</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#isJust"><span class="hs-identifier hs-var">isJust</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><a href="Pair.html"><span class="hs-identifier">Pair</span></a><span> </span><span class="hs-special">(</span><a href="Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><a href="Unique.html"><span class="hs-identifier">Unique</span></a><span class="hs-special">(</span><span> </span><a href="Unique.html#hasKey"><span class="hs-identifier hs-var">hasKey</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><a href="DynFlags.html"><span class="hs-identifier">DynFlags</span></a><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><a href="Util.html"><span class="hs-identifier">Util</span></a><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="../ghc-boot-8.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.html"><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">LanguageExtensions</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">LangExt</span><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span class="hs-comment">{-
**********************************************************************
*                                                                    *
*                      Main Interaction Solver                       *
*                                                                    *
**********************************************************************

Note [Basic Simplifier Plan]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
1. Pick an element from the WorkList if there exists one with depth
   less than our context-stack depth.

2. Run it down the 'stage' pipeline. Stages are:
      - canonicalization
      - inert reactions
      - spontaneous reactions
      - top-level intreactions
   Each stage returns a StopOrContinue and may have sideffected
   the inerts or worklist.

   The threading of the stages is as follows:
      - If (Stop) is returned by a stage then we start again from Step 1.
      - If (ContinueWith ct) is returned by a stage, we feed 'ct' on to
        the next stage in the pipeline.
4. If the element has survived (i.e. ContinueWith x) the last stage
   then we add him in the inerts and jump back to Step 1.

If in Step 1 no such element exists, we have exceeded our context-stack
depth and will simply fail.

Note [Unflatten after solving the simple wanteds]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We unflatten after solving the wc_simples of an implication, and before attempting
to float. This means that

 * The fsk/fmv flatten-skolems only survive during solveSimples.  We don't
   need to worry about them across successive passes over the constraint tree.
   (E.g. we don't need the old ic_fsk field of an implication.

 * When floating an equality outwards, we don't need to worry about floating its
   associated flattening constraints.

 * Another tricky case becomes easy: Trac #4935
       type instance F True a b = a
       type instance F False a b = b

       [w] F c a b ~ gamma
       (c ~ True) =&gt; a ~ gamma
       (c ~ False) =&gt; b ~ gamma

   Obviously this is soluble with gamma := F c a b, and unflattening
   will do exactly that after solving the simple constraints and before
   attempting the implications.  Before, when we were not unflattening,
   we had to push Wanted funeqs in as new givens.  Yuk!

   Another example that becomes easy: indexed_types/should_fail/T7786
      [W] BuriedUnder sub k Empty ~ fsk
      [W] Intersect fsk inv ~ s
      [w] xxx[1] ~ s
      [W] forall[2] . (xxx[1] ~ Empty)
                   =&gt; Intersect (BuriedUnder sub k Empty) inv ~ Empty

Note [Running plugins on unflattened wanteds]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
There is an annoying mismatch between solveSimpleGivens and
solveSimpleWanteds, because the latter needs to fiddle with the inert
set, unflatten and zonk the wanteds.  It passes the zonked wanteds
to runTcPluginsWanteds, which produces a replacement set of wanteds,
some additional insolubles and a flag indicating whether to go round
the loop again.  If so, prepareInertsForImplications is used to remove
the previous wanteds (which will still be in the inert set).  Note
that prepareInertsForImplications will discard the insolubles, so we
must keep track of them separately.
-}</span><span>
</span><a name="line-134"></a><span>
</span><a name="line-135"></a><span class="hs-identifier">solveSimpleGivens</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="TcRnTypes.html#Cts"><span class="hs-identifier hs-type">Cts</span></a><span>
</span><a name="line-136"></a><a name="solveSimpleGivens"><a href="TcInteract.html#solveSimpleGivens"><span class="hs-identifier">solveSimpleGivens</span></a></a><span> </span><a name="local-1628066026"><a href="#local-1628066026"><span class="hs-identifier">givens</span></a></a><span>
</span><a name="line-137"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1628066026"><span class="hs-identifier hs-var">givens</span></a><span>  </span><span class="hs-comment">-- Shortcut for common case</span><span>
</span><a name="line-138"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="TcRnTypes.html#emptyCts"><span class="hs-identifier hs-var">emptyCts</span></a><span>
</span><a name="line-139"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-140"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;solveSimpleGivens {&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066026"><span class="hs-identifier hs-var">givens</span></a><span class="hs-special">)</span><span>
</span><a name="line-141"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="#local-1628066027"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1628066026"><span class="hs-identifier hs-var">givens</span></a><span>
</span><a name="line-142"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628066030"><a href="#local-1628066030"><span class="hs-identifier">given_insols</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#takeGivenInsolubles"><span class="hs-identifier hs-var">takeGivenInsolubles</span></a><span>
</span><a name="line-143"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;End solveSimpleGivens }&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Insoluble:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="TcRnTypes.html#pprCts"><span class="hs-identifier hs-var">pprCts</span></a><span> </span><a href="#local-1628066030"><span class="hs-identifier hs-var">given_insols</span></a><span class="hs-special">)</span><span>
</span><a name="line-144"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-1628066030"><span class="hs-identifier hs-var">given_insols</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-145"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-146"></a><span>    </span><a name="local-1628066027"><a href="#local-1628066027"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-1628066028"><a href="#local-1628066028"><span class="hs-identifier">givens</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcInteract.html#solveSimples"><span class="hs-identifier hs-var">solveSimples</span></a><span> </span><span class="hs-special">(</span><a href="Bag.html#listToBag"><span class="hs-identifier hs-var">listToBag</span></a><span> </span><a href="#local-1628066028"><span class="hs-identifier hs-var">givens</span></a><span class="hs-special">)</span><span>
</span><a name="line-147"></a><span>                   </span><span class="hs-special">;</span><span> </span><a name="local-1628066029"><a href="#local-1628066029"><span class="hs-identifier">new_givens</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcInteract.html#runTcPluginsGiven"><span class="hs-identifier hs-var">runTcPluginsGiven</span></a><span>
</span><a name="line-148"></a><span>                   </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><span class="hs-special">(</span><a href="Util.html#notNull"><span class="hs-identifier hs-var">notNull</span></a><span> </span><a href="#local-1628066029"><span class="hs-identifier hs-var">new_givens</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-149"></a><span>                     </span><a href="#local-1628066027"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1628066029"><span class="hs-identifier hs-var">new_givens</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-150"></a><span>
</span><a name="line-151"></a><span class="hs-identifier">solveSimpleWanteds</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#Cts"><span class="hs-identifier hs-type">Cts</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="TcRnTypes.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a><span>
</span><a name="line-152"></a><span class="hs-comment">-- NB: 'simples' may contain /derived/ equalities, floated</span><span>
</span><a name="line-153"></a><span class="hs-comment">--     out from a nested implication. So don't discard deriveds!</span><span>
</span><a name="line-154"></a><a name="solveSimpleWanteds"><a href="TcInteract.html#solveSimpleWanteds"><span class="hs-identifier">solveSimpleWanteds</span></a></a><span> </span><a name="local-1628066031"><a href="#local-1628066031"><span class="hs-identifier">simples</span></a></a><span>
</span><a name="line-155"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;solveSimpleWanteds {&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066031"><span class="hs-identifier hs-var">simples</span></a><span class="hs-special">)</span><span>
</span><a name="line-156"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628066040"><a href="#local-1628066040"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a><span>
</span><a name="line-157"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628066041"><a href="#local-1628066041"><span class="hs-identifier">n</span></a></a><span class="hs-special">,</span><a name="local-1628066042"><a href="#local-1628066042"><span class="hs-identifier">wc</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628066032"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-number">1</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">solverIterations</span><span> </span><a href="#local-1628066040"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#emptyWC"><span class="hs-identifier hs-var">emptyWC</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wc_simple</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628066031"><span class="hs-identifier hs-var">simples</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-158"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;solveSimpleWanteds end }&quot;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-159"></a><span>             </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;iterations =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066041"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-160"></a><span>                  </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;residual =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066042"><span class="hs-identifier hs-var">wc</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-161"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-1628066042"><span class="hs-identifier hs-var">wc</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-162"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-163"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#IntWithInf"><span class="hs-identifier hs-type">IntWithInf</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><a href="TcRnTypes.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a><span class="hs-special">)</span><span>
</span><a name="line-164"></a><span>    </span><a name="local-1628066032"><a href="#local-1628066032"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-1628066033"><a href="#local-1628066033"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-1628066034"><a href="#local-1628066034"><span class="hs-identifier">limit</span></a></a><span> </span><a name="local-1628066035"><a href="#local-1628066035"><span class="hs-identifier">wc</span></a></a><span>
</span><a name="line-165"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628066033"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">`</span><a href="BasicTypes.html#intGtLimit"><span class="hs-identifier hs-var">intGtLimit</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628066034"><span class="hs-identifier hs-var">limit</span></a><span>
</span><a name="line-166"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#failTcS"><span class="hs-identifier hs-var">failTcS</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;solveSimpleWanteds: too many iterations&quot;</span><span>
</span><a name="line-167"></a><span>                       </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;limit =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066034"><span class="hs-identifier hs-var">limit</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-168"></a><span>                    </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Set limit with -fsolver-iterations=n; n=0 for no limit&quot;</span><span>
</span><a name="line-169"></a><span>                            </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Simples =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066031"><span class="hs-identifier hs-var">simples</span></a><span>
</span><a name="line-170"></a><span>                            </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;WC =&quot;</span><span>      </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066035"><span class="hs-identifier hs-var">wc</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-171"></a><span>
</span><a name="line-172"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a href="Bag.html#isEmptyBag"><span class="hs-identifier hs-var">isEmptyBag</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">wc_simple</span><span> </span><a href="#local-1628066035"><span class="hs-identifier hs-var">wc</span></a><span class="hs-special">)</span><span>
</span><a name="line-173"></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628066033"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">,</span><a href="#local-1628066035"><span class="hs-identifier hs-var">wc</span></a><span class="hs-special">)</span><span>
</span><a name="line-174"></a><span>
</span><a name="line-175"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-176"></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Solve</span><span>
</span><a name="line-177"></a><span>            </span><span class="hs-special">(</span><a name="local-1628066036"><a href="#local-1628066036"><span class="hs-identifier">unif_count</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628066037"><a href="#local-1628066037"><span class="hs-identifier">wc1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcInteract.html#solve_simple_wanteds"><span class="hs-identifier hs-var">solve_simple_wanteds</span></a><span> </span><a href="#local-1628066035"><span class="hs-identifier hs-var">wc</span></a><span>
</span><a name="line-178"></a><span>
</span><a name="line-179"></a><span>            </span><span class="hs-comment">-- Run plugins</span><span>
</span><a name="line-180"></a><span>          </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628066038"><a href="#local-1628066038"><span class="hs-identifier">rerun_plugin</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628066039"><a href="#local-1628066039"><span class="hs-identifier">wc2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcInteract.html#runTcPluginsWanted"><span class="hs-identifier hs-var">runTcPluginsWanted</span></a><span> </span><a href="#local-1628066037"><span class="hs-identifier hs-var">wc1</span></a><span>
</span><a name="line-181"></a><span>             </span><span class="hs-comment">-- See Note [Running plugins on unflattened wanteds]</span><span>
</span><a name="line-182"></a><span>
</span><a name="line-183"></a><span>          </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-1628066036"><span class="hs-identifier hs-var">unif_count</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-1628066038"><span class="hs-identifier hs-var">rerun_plugin</span></a><span>
</span><a name="line-184"></a><span>            </span><span class="hs-keyword">then</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628066033"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628066039"><span class="hs-identifier hs-var">wc2</span></a><span class="hs-special">)</span><span>             </span><span class="hs-comment">-- Done</span><span>
</span><a name="line-185"></a><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;solveSimple going round again:&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066038"><span class="hs-identifier hs-var">rerun_plugin</span></a><span class="hs-special">)</span><span>
</span><a name="line-186"></a><span>                    </span><span class="hs-special">;</span><span> </span><a href="#local-1628066032"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628066033"><span class="hs-identifier hs-var">n</span></a><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-1628066034"><span class="hs-identifier hs-var">limit</span></a><span> </span><a href="#local-1628066039"><span class="hs-identifier hs-var">wc2</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>      </span><span class="hs-comment">-- Loop</span><span>
</span><a name="line-187"></a><span>
</span><a name="line-188"></a><span>
</span><a name="line-189"></a><span class="hs-identifier">solve_simple_wanteds</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><a href="TcRnTypes.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a><span class="hs-special">)</span><span>
</span><a name="line-190"></a><span class="hs-comment">-- Try solving these constraints</span><span>
</span><a name="line-191"></a><span class="hs-comment">-- Affects the unification state (of course) but not the inert set</span><span>
</span><a name="line-192"></a><a name="solve_simple_wanteds"><a href="TcInteract.html#solve_simple_wanteds"><span class="hs-identifier">solve_simple_wanteds</span></a></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#WC"><span class="hs-identifier hs-var">WC</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wc_simple</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066043"><a href="#local-1628066043"><span class="hs-identifier">simples1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">wc_insol</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066044"><a href="#local-1628066044"><span class="hs-identifier">insols1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">wc_impl</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066045"><a href="#local-1628066045"><span class="hs-identifier">implics1</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-193"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#nestTcS"><span class="hs-identifier hs-var">nestTcS</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-194"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcInteract.html#solveSimples"><span class="hs-identifier hs-var">solveSimples</span></a><span> </span><a href="#local-1628066043"><span class="hs-identifier hs-var">simples1</span></a><span>
</span><a name="line-195"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628066046"><a href="#local-1628066046"><span class="hs-identifier">implics2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628066047"><a href="#local-1628066047"><span class="hs-identifier">tv_eqs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628066048"><a href="#local-1628066048"><span class="hs-identifier">fun_eqs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628066049"><a href="#local-1628066049"><span class="hs-identifier">insols2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628066050"><a href="#local-1628066050"><span class="hs-identifier">others</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getUnsolvedInerts"><span class="hs-identifier hs-var">getUnsolvedInerts</span></a><span>
</span><a name="line-196"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628066051"><a href="#local-1628066051"><span class="hs-identifier">unif_count</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628066052"><a href="#local-1628066052"><span class="hs-identifier">unflattened_eqs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#reportUnifications"><span class="hs-identifier hs-var">reportUnifications</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-197"></a><span>                                          </span><a href="TcFlatten.html#unflatten"><span class="hs-identifier hs-var">unflatten</span></a><span> </span><a href="#local-1628066047"><span class="hs-identifier hs-var">tv_eqs</span></a><span> </span><a href="#local-1628066048"><span class="hs-identifier hs-var">fun_eqs</span></a><span>
</span><a name="line-198"></a><span>            </span><span class="hs-comment">-- See Note [Unflatten after solving the simple wanteds]</span><span>
</span><a name="line-199"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="#local-1628066051"><span class="hs-identifier hs-var">unif_count</span></a><span>
</span><a name="line-200"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="TcRnTypes.html#WC"><span class="hs-identifier hs-var">WC</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wc_simple</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628066050"><span class="hs-identifier hs-var">others</span></a><span> </span><span class="hs-special">`</span><a href="TcRnTypes.html#andCts"><span class="hs-identifier hs-var">andCts</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628066052"><span class="hs-identifier hs-var">unflattened_eqs</span></a><span>
</span><a name="line-201"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">wc_insol</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628066044"><span class="hs-identifier hs-var">insols1</span></a><span> </span><span class="hs-special">`</span><a href="TcRnTypes.html#andCts"><span class="hs-identifier hs-var">andCts</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628066049"><span class="hs-identifier hs-var">insols2</span></a><span>
</span><a name="line-202"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">wc_impl</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628066045"><span class="hs-identifier hs-var">implics1</span></a><span> </span><span class="hs-special">`</span><a href="Bag.html#unionBags"><span class="hs-identifier hs-var">unionBags</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628066046"><span class="hs-identifier hs-var">implics2</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-203"></a><span>
</span><a name="line-204"></a><span class="hs-comment">{- Note [The solveSimpleWanteds loop]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Solving a bunch of simple constraints is done in a loop,
(the 'go' loop of 'solveSimpleWanteds'):
  1. Try to solve them; unflattening may lead to improvement that
     was not exploitable during solving
  2. Try the plugin
  3. If step 1 did improvement during unflattening; or if the plugin
     wants to run again, go back to step 1

Non-obviously, improvement can also take place during
the unflattening that takes place in step (1). See TcFlatten,
See Note [Unflattening can force the solver to iterate]
-}</span><span>
</span><a name="line-218"></a><span>
</span><a name="line-219"></a><span class="hs-comment">-- The main solver loop implements Note [Basic Simplifier Plan]</span><span>
</span><a name="line-220"></a><span class="hs-comment">---------------------------------------------------------------</span><span>
</span><a name="line-221"></a><span class="hs-identifier">solveSimples</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#Cts"><span class="hs-identifier hs-type">Cts</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-222"></a><span class="hs-comment">-- Returns the final InertSet in TcS</span><span>
</span><a name="line-223"></a><span class="hs-comment">-- Has no effect on work-list or residual-implications</span><span>
</span><a name="line-224"></a><span class="hs-comment">-- The constraints are initially examined in left-to-right order</span><span>
</span><a name="line-225"></a><span>
</span><a name="line-226"></a><a name="solveSimples"><a href="TcInteract.html#solveSimples"><span class="hs-identifier">solveSimples</span></a></a><span> </span><a name="local-1628066053"><a href="#local-1628066053"><span class="hs-identifier">cts</span></a></a><span>
</span><a name="line-227"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC &quot;solveSimples&quot; #-}</span><span>
</span><a name="line-228"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#updWorkListTcS"><span class="hs-identifier hs-var">updWorkListTcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-1628066057"><a href="#local-1628066057"><span class="hs-identifier">wl</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Bag.html#foldrBag"><span class="hs-identifier hs-var">foldrBag</span></a><span> </span><a href="TcSMonad.html#extendWorkListCt"><span class="hs-identifier hs-var">extendWorkListCt</span></a><span> </span><a href="#local-1628066057"><span class="hs-identifier hs-var">wl</span></a><span> </span><a href="#local-1628066053"><span class="hs-identifier hs-var">cts</span></a><span class="hs-special">)</span><span>
</span><a name="line-229"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="#local-1628066054"><span class="hs-identifier hs-var">solve_loop</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-230"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-231"></a><span>    </span><a name="local-1628066054"><a href="#local-1628066054"><span class="hs-identifier">solve_loop</span></a></a><span>
</span><a name="line-232"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC &quot;solve_loop&quot; #-}</span><span>
</span><a name="line-233"></a><span>        </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628066055"><a href="#local-1628066055"><span class="hs-identifier">sel</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#selectNextWorkItem"><span class="hs-identifier hs-var">selectNextWorkItem</span></a><span>
</span><a name="line-234"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628066055"><span class="hs-identifier hs-var">sel</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-235"></a><span>              </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-236"></a><span>              </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628066056"><a href="#local-1628066056"><span class="hs-identifier">ct</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcInteract.html#runSolverPipeline"><span class="hs-identifier hs-var">runSolverPipeline</span></a><span> </span><a href="TcInteract.html#thePipeline"><span class="hs-identifier hs-var">thePipeline</span></a><span> </span><a href="#local-1628066056"><span class="hs-identifier hs-var">ct</span></a><span>
</span><a name="line-237"></a><span>                            </span><span class="hs-special">;</span><span> </span><a href="#local-1628066054"><span class="hs-identifier hs-var">solve_loop</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-238"></a><span>
</span><a name="line-239"></a><span class="hs-comment">-- | Extract the (inert) givens and invoke the plugins on them.</span><span>
</span><a name="line-240"></a><span class="hs-comment">-- Remove solved givens from the inert set and emit insolubles, but</span><span>
</span><a name="line-241"></a><span class="hs-comment">-- return new work produced so that 'solveSimpleGivens' can feed it back</span><span>
</span><a name="line-242"></a><span class="hs-comment">-- into the main solver.</span><span>
</span><a name="line-243"></a><span class="hs-identifier">runTcPluginsGiven</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">[</span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span class="hs-special">]</span><span>
</span><a name="line-244"></a><a name="runTcPluginsGiven"><a href="TcInteract.html#runTcPluginsGiven"><span class="hs-identifier">runTcPluginsGiven</span></a></a><span>
</span><a name="line-245"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628066058"><a href="#local-1628066058"><span class="hs-identifier">plugins</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcInteract.html#getTcPlugins"><span class="hs-identifier hs-var">getTcPlugins</span></a><span>
</span><a name="line-246"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1628066058"><span class="hs-identifier hs-var">plugins</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-keyword">else</span><span>
</span><a name="line-247"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628066059"><a href="#local-1628066059"><span class="hs-identifier">givens</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getInertGivens"><span class="hs-identifier hs-var">getInertGivens</span></a><span>
</span><a name="line-248"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1628066059"><span class="hs-identifier hs-var">givens</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-keyword">else</span><span>
</span><a name="line-249"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628066060"><a href="#local-1628066060"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcInteract.html#runTcPlugins"><span class="hs-identifier hs-var">runTcPlugins</span></a><span> </span><a href="#local-1628066058"><span class="hs-identifier hs-var">plugins</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628066059"><span class="hs-identifier hs-var">givens</span></a><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-250"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-1628066061"><a href="#local-1628066061"><span class="hs-identifier">solved_givens</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">pluginSolvedCts</span><span> </span><a href="#local-1628066060"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-251"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#updInertCans"><span class="hs-identifier hs-var">updInertCans</span></a><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#removeInertCts"><span class="hs-identifier hs-var">removeInertCts</span></a><span> </span><a href="#local-1628066061"><span class="hs-identifier hs-var">solved_givens</span></a><span class="hs-special">)</span><span>
</span><a name="line-252"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><a href="TcSMonad.html#emitInsoluble"><span class="hs-identifier hs-var">emitInsoluble</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">pluginBadCts</span><span> </span><a href="#local-1628066060"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-253"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">pluginNewCts</span><span> </span><a href="#local-1628066060"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-254"></a><span>
</span><a name="line-255"></a><span class="hs-comment">-- | Given a bag of (flattened, zonked) wanteds, invoke the plugins on</span><span>
</span><a name="line-256"></a><span class="hs-comment">-- them and produce an updated bag of wanteds (possibly with some new</span><span>
</span><a name="line-257"></a><span class="hs-comment">-- work) and a bag of insolubles.  The boolean indicates whether</span><span>
</span><a name="line-258"></a><span class="hs-comment">-- 'solveSimpleWanteds' should feed the updated wanteds back into the</span><span>
</span><a name="line-259"></a><span class="hs-comment">-- main solver.</span><span>
</span><a name="line-260"></a><span class="hs-identifier">runTcPluginsWanted</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span> </span><a href="TcRnTypes.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a><span class="hs-special">)</span><span>
</span><a name="line-261"></a><a name="runTcPluginsWanted"><a href="TcInteract.html#runTcPluginsWanted"><span class="hs-identifier">runTcPluginsWanted</span></a></a><span> </span><a name="local-1628066062"><a href="#local-1628066062"><span class="hs-identifier">wc</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TcRnTypes.html#WC"><span class="hs-identifier hs-var">WC</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wc_simple</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066063"><a href="#local-1628066063"><span class="hs-identifier">simples1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">wc_insol</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066064"><a href="#local-1628066064"><span class="hs-identifier">insols1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">wc_impl</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066065"><a href="#local-1628066065"><span class="hs-identifier">implics1</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-262"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Bag.html#isEmptyBag"><span class="hs-identifier hs-var">isEmptyBag</span></a><span> </span><a href="#local-1628066063"><span class="hs-identifier hs-var">simples1</span></a><span>
</span><a name="line-263"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><a href="#local-1628066062"><span class="hs-identifier hs-var">wc</span></a><span class="hs-special">)</span><span>
</span><a name="line-264"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-265"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628066070"><a href="#local-1628066070"><span class="hs-identifier">plugins</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcInteract.html#getTcPlugins"><span class="hs-identifier hs-var">getTcPlugins</span></a><span>
</span><a name="line-266"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1628066070"><span class="hs-identifier hs-var">plugins</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><a href="#local-1628066062"><span class="hs-identifier hs-var">wc</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span>
</span><a name="line-267"></a><span>
</span><a name="line-268"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628066071"><a href="#local-1628066071"><span class="hs-identifier">given</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getInertGivens"><span class="hs-identifier hs-var">getInertGivens</span></a><span>
</span><a name="line-269"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628066072"><a href="#local-1628066072"><span class="hs-identifier">simples1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#zonkSimples"><span class="hs-identifier hs-var">zonkSimples</span></a><span> </span><a href="#local-1628066063"><span class="hs-identifier hs-var">simples1</span></a><span>    </span><span class="hs-comment">-- Plugin requires zonked inputs</span><span>
</span><a name="line-270"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-1628066073"><a href="#local-1628066073"><span class="hs-identifier">wanted</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628066074"><a href="#local-1628066074"><span class="hs-identifier">derived</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.OldList.html#partition"><span class="hs-identifier hs-var">partition</span></a><span> </span><a href="TcRnTypes.html#isWantedCt"><span class="hs-identifier hs-var">isWantedCt</span></a><span> </span><span class="hs-special">(</span><a href="Bag.html#bagToList"><span class="hs-identifier hs-var">bagToList</span></a><span> </span><a href="#local-1628066072"><span class="hs-identifier hs-var">simples1</span></a><span class="hs-special">)</span><span>
</span><a name="line-271"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628066075"><a href="#local-1628066075"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcInteract.html#runTcPlugins"><span class="hs-identifier hs-var">runTcPlugins</span></a><span> </span><a href="#local-1628066070"><span class="hs-identifier hs-var">plugins</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628066071"><span class="hs-identifier hs-var">given</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628066074"><span class="hs-identifier hs-var">derived</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628066073"><span class="hs-identifier hs-var">wanted</span></a><span class="hs-special">)</span><span>
</span><a name="line-272"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span>                </span><a name="local-1628066076"><a href="#local-1628066076"><span class="hs-identifier">solved_wanted</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">pluginSolvedCts</span><span> </span><a href="#local-1628066075"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-273"></a><span>             </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-1628066077"><a href="#local-1628066077"><span class="hs-identifier">unsolved_derived</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628066078"><a href="#local-1628066078"><span class="hs-identifier">unsolved_wanted</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">pluginInputCts</span><span> </span><a href="#local-1628066075"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-274"></a><span>             </span><a name="local-1628066079"><a href="#local-1628066079"><span class="hs-identifier">new_wanted</span></a></a><span>                             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">pluginNewCts</span><span> </span><a href="#local-1628066075"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-275"></a><span>
</span><a name="line-276"></a><span class="hs-comment">-- SLPJ: I'm deeply suspicious of this</span><span>
</span><a name="line-277"></a><span class="hs-comment">--       ; updInertCans (removeInertCts $ solved_givens ++ solved_deriveds)</span><span>
</span><a name="line-278"></a><span>
</span><a name="line-279"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><a href="#local-1628066066"><span class="hs-identifier hs-var">setEv</span></a><span> </span><a href="#local-1628066076"><span class="hs-identifier hs-var">solved_wanted</span></a><span>
</span><a name="line-280"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="Util.html#notNull"><span class="hs-identifier hs-var">notNull</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">pluginNewCts</span><span> </span><a href="#local-1628066075"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-281"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="TcRnTypes.html#WC"><span class="hs-identifier hs-var">WC</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wc_simple</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Bag.html#listToBag"><span class="hs-identifier hs-var">listToBag</span></a><span> </span><a href="#local-1628066079"><span class="hs-identifier hs-var">new_wanted</span></a><span> </span><span class="hs-special">`</span><a href="TcRnTypes.html#andCts"><span class="hs-identifier hs-var">andCts</span></a><span class="hs-special">`</span><span> </span><a href="Bag.html#listToBag"><span class="hs-identifier hs-var">listToBag</span></a><span> </span><a href="#local-1628066078"><span class="hs-identifier hs-var">unsolved_wanted</span></a><span>
</span><a name="line-282"></a><span>                                                        </span><span class="hs-special">`</span><a href="TcRnTypes.html#andCts"><span class="hs-identifier hs-var">andCts</span></a><span class="hs-special">`</span><span> </span><a href="Bag.html#listToBag"><span class="hs-identifier hs-var">listToBag</span></a><span> </span><a href="#local-1628066077"><span class="hs-identifier hs-var">unsolved_derived</span></a><span>
</span><a name="line-283"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">wc_insol</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Bag.html#listToBag"><span class="hs-identifier hs-var">listToBag</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">pluginBadCts</span><span> </span><a href="#local-1628066075"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="TcRnTypes.html#andCts"><span class="hs-identifier hs-var">andCts</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628066064"><span class="hs-identifier hs-var">insols1</span></a><span>
</span><a name="line-284"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">wc_impl</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628066065"><span class="hs-identifier hs-var">implics1</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-285"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-286"></a><span>    </span><span class="hs-identifier">setEv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#EvTerm"><span class="hs-identifier hs-type">EvTerm</span></a><span class="hs-special">,</span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-287"></a><span>    </span><a name="local-1628066066"><a href="#local-1628066066"><span class="hs-identifier">setEv</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1628066067"><a href="#local-1628066067"><span class="hs-identifier">ev</span></a></a><span class="hs-special">,</span><a name="local-1628066068"><a href="#local-1628066068"><span class="hs-identifier">ct</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="TcRnTypes.html#ctEvidence"><span class="hs-identifier hs-var">ctEvidence</span></a><span> </span><a href="#local-1628066068"><span class="hs-identifier hs-var">ct</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-288"></a><span>      </span><a href="TcRnTypes.html#CtWanted"><span class="hs-identifier hs-var">CtWanted</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctev_dest</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066069"><a href="#local-1628066069"><span class="hs-identifier">dest</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#setWantedEvTerm"><span class="hs-identifier hs-var">setWantedEvTerm</span></a><span> </span><a href="#local-1628066069"><span class="hs-identifier hs-var">dest</span></a><span> </span><a href="#local-1628066067"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-289"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Panic.html#panic"><span class="hs-identifier hs-var">panic</span></a><span> </span><span class="hs-string">&quot;runTcPluginsWanted.setEv: attempt to solve non-wanted!&quot;</span><span>
</span><a name="line-290"></a><span>
</span><a name="line-291"></a><span class="hs-comment">-- | A triple of (given, derived, wanted) constraints to pass to plugins</span><span>
</span><a name="line-292"></a><span class="hs-keyword">type</span><span> </span><a name="SplitCts"><a href="TcInteract.html#SplitCts"><span class="hs-identifier">SplitCts</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-293"></a><span>
</span><a name="line-294"></a><span class="hs-comment">-- | A solved triple of constraints, with evidence for wanteds</span><span>
</span><a name="line-295"></a><span class="hs-keyword">type</span><span> </span><a name="SolvedCts"><a href="TcInteract.html#SolvedCts"><span class="hs-identifier">SolvedCts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="TcEvidence.html#EvTerm"><span class="hs-identifier hs-type">EvTerm</span></a><span class="hs-special">,</span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-296"></a><span>
</span><a name="line-297"></a><span class="hs-comment">-- | Represents collections of constraints generated by typechecker</span><span>
</span><a name="line-298"></a><span class="hs-comment">-- plugins</span><span>
</span><a name="line-299"></a><span class="hs-keyword">data</span><span> </span><a name="TcPluginProgress"><a href="TcInteract.html#TcPluginProgress"><span class="hs-identifier">TcPluginProgress</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="TcPluginProgress"><a href="TcInteract.html#TcPluginProgress"><span class="hs-identifier">TcPluginProgress</span></a></a><span>
</span><a name="line-300"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="pluginInputCts"><a href="TcInteract.html#pluginInputCts"><span class="hs-identifier">pluginInputCts</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="TcInteract.html#SplitCts"><span class="hs-identifier hs-type">SplitCts</span></a><span>
</span><a name="line-301"></a><span>      </span><span class="hs-comment">-- ^ Original inputs to the plugins with solved/bad constraints</span><span>
</span><a name="line-302"></a><span>      </span><span class="hs-comment">-- removed, but otherwise unmodified</span><span>
</span><a name="line-303"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="pluginSolvedCts"><a href="TcInteract.html#pluginSolvedCts"><span class="hs-identifier">pluginSolvedCts</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcInteract.html#SolvedCts"><span class="hs-identifier hs-type">SolvedCts</span></a><span>
</span><a name="line-304"></a><span>      </span><span class="hs-comment">-- ^ Constraints solved by plugins</span><span>
</span><a name="line-305"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="pluginBadCts"><a href="TcInteract.html#pluginBadCts"><span class="hs-identifier">pluginBadCts</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span class="hs-special">]</span><span>
</span><a name="line-306"></a><span>      </span><span class="hs-comment">-- ^ Constraints reported as insoluble by plugins</span><span>
</span><a name="line-307"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="pluginNewCts"><a href="TcInteract.html#pluginNewCts"><span class="hs-identifier">pluginNewCts</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span class="hs-special">]</span><span>
</span><a name="line-308"></a><span>      </span><span class="hs-comment">-- ^ New constraints emitted by plugins</span><span>
</span><a name="line-309"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-310"></a><span>
</span><a name="line-311"></a><span class="hs-identifier">getTcPlugins</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">[</span><a href="TcRnTypes.html#TcPluginSolver"><span class="hs-identifier hs-type">TcPluginSolver</span></a><span class="hs-special">]</span><span>
</span><a name="line-312"></a><a name="getTcPlugins"><a href="TcInteract.html#getTcPlugins"><span class="hs-identifier">getTcPlugins</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628066080"><a href="#local-1628066080"><span class="hs-identifier">tcg_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_tc_plugins</span><span> </span><a href="#local-1628066080"><span class="hs-identifier hs-var">tcg_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-313"></a><span>
</span><a name="line-314"></a><span class="hs-comment">-- | Starting from a triple of (given, derived, wanted) constraints,</span><span>
</span><a name="line-315"></a><span class="hs-comment">-- invoke each of the typechecker plugins in turn and return</span><span>
</span><a name="line-316"></a><span class="hs-comment">--</span><span>
</span><a name="line-317"></a><span class="hs-comment">--  * the remaining unmodified constraints,</span><span>
</span><a name="line-318"></a><span class="hs-comment">--  * constraints that have been solved,</span><span>
</span><a name="line-319"></a><span class="hs-comment">--  * constraints that are insoluble, and</span><span>
</span><a name="line-320"></a><span class="hs-comment">--  * new work.</span><span>
</span><a name="line-321"></a><span class="hs-comment">--</span><span>
</span><a name="line-322"></a><span class="hs-comment">-- Note that new work generated by one plugin will not be seen by</span><span>
</span><a name="line-323"></a><span class="hs-comment">-- other plugins on this pass (but the main constraint solver will be</span><span>
</span><a name="line-324"></a><span class="hs-comment">-- re-invoked and they will see it later).  There is no check that new</span><span>
</span><a name="line-325"></a><span class="hs-comment">-- work differs from the original constraints supplied to the plugin:</span><span>
</span><a name="line-326"></a><span class="hs-comment">-- the plugin itself should perform this check if necessary.</span><span>
</span><a name="line-327"></a><span class="hs-identifier">runTcPlugins</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TcRnTypes.html#TcPluginSolver"><span class="hs-identifier hs-type">TcPluginSolver</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcInteract.html#SplitCts"><span class="hs-identifier hs-type">SplitCts</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="TcInteract.html#TcPluginProgress"><span class="hs-identifier hs-type">TcPluginProgress</span></a><span>
</span><a name="line-328"></a><a name="runTcPlugins"><a href="TcInteract.html#runTcPlugins"><span class="hs-identifier">runTcPlugins</span></a></a><span> </span><a name="local-1628066081"><a href="#local-1628066081"><span class="hs-identifier">plugins</span></a></a><span> </span><a name="local-1628066082"><a href="#local-1628066082"><span class="hs-identifier">all_cts</span></a></a><span>
</span><a name="line-329"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html#foldM"><span class="hs-identifier hs-var">foldM</span></a><span> </span><a href="#local-1628066083"><span class="hs-identifier hs-var">do_plugin</span></a><span> </span><a href="#local-1628066085"><span class="hs-identifier hs-var">initialProgress</span></a><span> </span><a href="#local-1628066081"><span class="hs-identifier hs-var">plugins</span></a><span>
</span><a name="line-330"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-331"></a><span>    </span><span class="hs-identifier">do_plugin</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcInteract.html#TcPluginProgress"><span class="hs-identifier hs-type">TcPluginProgress</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcPluginSolver"><span class="hs-identifier hs-type">TcPluginSolver</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="TcInteract.html#TcPluginProgress"><span class="hs-identifier hs-type">TcPluginProgress</span></a><span>
</span><a name="line-332"></a><span>    </span><a name="local-1628066083"><a href="#local-1628066083"><span class="hs-identifier">do_plugin</span></a></a><span> </span><a name="local-1628066091"><a href="#local-1628066091"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-1628066092"><a href="#local-1628066092"><span class="hs-identifier">solver</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-333"></a><span>        </span><a name="local-1628066093"><a href="#local-1628066093"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#runTcPluginTcS"><span class="hs-identifier hs-var">runTcPluginTcS</span></a><span> </span><span class="hs-special">(</span><a href="Util.html#uncurry3"><span class="hs-identifier hs-var">uncurry3</span></a><span> </span><a href="#local-1628066092"><span class="hs-identifier hs-var">solver</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">pluginInputCts</span><span> </span><a href="#local-1628066091"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-334"></a><span>        </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="#local-1628066084"><span class="hs-identifier hs-var">progress</span></a><span> </span><a href="#local-1628066091"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-1628066093"><span class="hs-identifier hs-var">result</span></a><span>
</span><a name="line-335"></a><span>
</span><a name="line-336"></a><span>    </span><span class="hs-identifier">progress</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcInteract.html#TcPluginProgress"><span class="hs-identifier hs-type">TcPluginProgress</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcPluginResult"><span class="hs-identifier hs-type">TcPluginResult</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcInteract.html#TcPluginProgress"><span class="hs-identifier hs-type">TcPluginProgress</span></a><span>
</span><a name="line-337"></a><span>    </span><a name="local-1628066084"><a href="#local-1628066084"><span class="hs-identifier">progress</span></a></a><span> </span><a name="local-1628066094"><a href="#local-1628066094"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#TcPluginContradiction"><span class="hs-identifier hs-var">TcPluginContradiction</span></a><span> </span><a name="local-1628066095"><a href="#local-1628066095"><span class="hs-identifier">bad_cts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-338"></a><span>       </span><a href="#local-1628066094"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pluginInputCts</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628066086"><span class="hs-identifier hs-var">discard</span></a><span> </span><a href="#local-1628066095"><span class="hs-identifier hs-var">bad_cts</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">pluginInputCts</span><span> </span><a href="#local-1628066094"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-339"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pluginBadCts</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628066095"><span class="hs-identifier hs-var">bad_cts</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><span class="hs-identifier">pluginBadCts</span><span> </span><a href="#local-1628066094"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-340"></a><span>         </span><span class="hs-special">}</span><span>
</span><a name="line-341"></a><span>    </span><span class="hs-identifier">progress</span><span> </span><a name="local-1628066096"><a href="#local-1628066096"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#TcPluginOk"><span class="hs-identifier hs-var">TcPluginOk</span></a><span> </span><a name="local-1628066097"><a href="#local-1628066097"><span class="hs-identifier">solved_cts</span></a></a><span> </span><a name="local-1628066098"><a href="#local-1628066098"><span class="hs-identifier">new_cts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-342"></a><span>      </span><a href="#local-1628066096"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pluginInputCts</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628066086"><span class="hs-identifier hs-var">discard</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#snd"><span class="hs-identifier hs-var">snd</span></a><span> </span><a href="#local-1628066097"><span class="hs-identifier hs-var">solved_cts</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">pluginInputCts</span><span> </span><a href="#local-1628066096"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-343"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pluginSolvedCts</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628066089"><span class="hs-identifier hs-var">add</span></a><span> </span><a href="#local-1628066097"><span class="hs-identifier hs-var">solved_cts</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">pluginSolvedCts</span><span> </span><a href="#local-1628066096"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-344"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pluginNewCts</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628066098"><span class="hs-identifier hs-var">new_cts</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><span class="hs-identifier">pluginNewCts</span><span> </span><a href="#local-1628066096"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-345"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-346"></a><span>
</span><a name="line-347"></a><span>    </span><a name="local-1628066085"><a href="#local-1628066085"><span class="hs-identifier">initialProgress</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcInteract.html#TcPluginProgress"><span class="hs-identifier hs-var">TcPluginProgress</span></a><span> </span><a href="#local-1628066082"><span class="hs-identifier hs-var">all_cts</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-348"></a><span>
</span><a name="line-349"></a><span>    </span><span class="hs-identifier">discard</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcInteract.html#SplitCts"><span class="hs-identifier hs-type">SplitCts</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcInteract.html#SplitCts"><span class="hs-identifier hs-type">SplitCts</span></a><span>
</span><a name="line-350"></a><span>    </span><a name="local-1628066086"><a href="#local-1628066086"><span class="hs-identifier">discard</span></a></a><span> </span><a name="local-1628066099"><a href="#local-1628066099"><span class="hs-identifier">cts</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1628066100"><a href="#local-1628066100"><span class="hs-identifier">xs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628066101"><a href="#local-1628066101"><span class="hs-identifier">ys</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628066102"><a href="#local-1628066102"><span class="hs-identifier">zs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-351"></a><span>        </span><span class="hs-special">(</span><a href="#local-1628066100"><span class="hs-identifier hs-var">xs</span></a><span> </span><span class="hs-special">`</span><a href="#local-1628066087"><span class="hs-identifier hs-var">without</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628066099"><span class="hs-identifier hs-var">cts</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628066101"><span class="hs-identifier hs-var">ys</span></a><span> </span><span class="hs-special">`</span><a href="#local-1628066087"><span class="hs-identifier hs-var">without</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628066099"><span class="hs-identifier hs-var">cts</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628066102"><span class="hs-identifier hs-var">zs</span></a><span> </span><span class="hs-special">`</span><a href="#local-1628066087"><span class="hs-identifier hs-var">without</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628066099"><span class="hs-identifier hs-var">cts</span></a><span class="hs-special">)</span><span>
</span><a name="line-352"></a><span>
</span><a name="line-353"></a><span>    </span><span class="hs-identifier">without</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span class="hs-special">]</span><span>
</span><a name="line-354"></a><span>    </span><a name="local-1628066087"><a href="#local-1628066087"><span class="hs-identifier">without</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.OldList.html#deleteFirstsBy"><span class="hs-identifier hs-var">deleteFirstsBy</span></a><span> </span><a href="#local-1628066088"><span class="hs-identifier hs-var">eqCt</span></a><span>
</span><a name="line-355"></a><span>
</span><a name="line-356"></a><span>    </span><span class="hs-identifier">eqCt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-357"></a><span>    </span><a name="local-1628066088"><a href="#local-1628066088"><span class="hs-identifier">eqCt</span></a></a><span> </span><a name="local-1628066103"><a href="#local-1628066103"><span class="hs-identifier">c</span></a></a><span> </span><a name="local-1628066104"><a href="#local-1628066104"><span class="hs-identifier">c'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#ctEvidence"><span class="hs-identifier hs-var">ctEvidence</span></a><span> </span><a href="#local-1628066103"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">,</span><span> </span><a href="TcRnTypes.html#ctEvidence"><span class="hs-identifier hs-var">ctEvidence</span></a><span> </span><a href="#local-1628066104"><span class="hs-identifier hs-var">c'</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-358"></a><span>      </span><span class="hs-special">(</span><a href="TcRnTypes.html#CtGiven"><span class="hs-identifier hs-var">CtGiven</span></a><span>   </span><a name="local-1628066105"><a href="#local-1628066105"><span class="hs-identifier">pred</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a href="TcRnTypes.html#CtGiven"><span class="hs-identifier hs-var">CtGiven</span></a><span>   </span><a name="local-1628066106"><a href="#local-1628066106"><span class="hs-identifier">pred'</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628066105"><span class="hs-identifier hs-var">pred</span></a><span> </span><span class="hs-special">`</span><a href="Type.html#eqType"><span class="hs-identifier hs-var">eqType</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628066106"><span class="hs-identifier hs-var">pred'</span></a><span>
</span><a name="line-359"></a><span>      </span><span class="hs-special">(</span><a href="TcRnTypes.html#CtWanted"><span class="hs-identifier hs-var">CtWanted</span></a><span>  </span><a name="local-1628066107"><a href="#local-1628066107"><span class="hs-identifier">pred</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a href="TcRnTypes.html#CtWanted"><span class="hs-identifier hs-var">CtWanted</span></a><span>  </span><a name="local-1628066108"><a href="#local-1628066108"><span class="hs-identifier">pred'</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628066107"><span class="hs-identifier hs-var">pred</span></a><span> </span><span class="hs-special">`</span><a href="Type.html#eqType"><span class="hs-identifier hs-var">eqType</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628066108"><span class="hs-identifier hs-var">pred'</span></a><span>
</span><a name="line-360"></a><span>      </span><span class="hs-special">(</span><a href="TcRnTypes.html#CtDerived"><span class="hs-identifier hs-var">CtDerived</span></a><span> </span><a name="local-1628066109"><a href="#local-1628066109"><span class="hs-identifier">pred</span></a></a><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-special">,</span><span> </span><a href="TcRnTypes.html#CtDerived"><span class="hs-identifier hs-var">CtDerived</span></a><span> </span><a name="local-1628066110"><a href="#local-1628066110"><span class="hs-identifier">pred'</span></a></a><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628066109"><span class="hs-identifier hs-var">pred</span></a><span> </span><span class="hs-special">`</span><a href="Type.html#eqType"><span class="hs-identifier hs-var">eqType</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628066110"><span class="hs-identifier hs-var">pred'</span></a><span>
</span><a name="line-361"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span>                  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-362"></a><span>
</span><a name="line-363"></a><span>    </span><span class="hs-identifier">add</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="TcEvidence.html#EvTerm"><span class="hs-identifier hs-type">EvTerm</span></a><span class="hs-special">,</span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcInteract.html#SolvedCts"><span class="hs-identifier hs-type">SolvedCts</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcInteract.html#SolvedCts"><span class="hs-identifier hs-type">SolvedCts</span></a><span>
</span><a name="line-364"></a><span>    </span><a name="local-1628066089"><a href="#local-1628066089"><span class="hs-identifier">add</span></a></a><span> </span><a name="local-1628066111"><a href="#local-1628066111"><span class="hs-identifier">xs</span></a></a><span> </span><a name="local-1628066112"><a href="#local-1628066112"><span class="hs-identifier">scs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#foldl%27"><span class="hs-identifier hs-var">foldl'</span></a><span> </span><a href="#local-1628066090"><span class="hs-identifier hs-var">addOne</span></a><span> </span><a href="#local-1628066112"><span class="hs-identifier hs-var">scs</span></a><span> </span><a href="#local-1628066111"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-365"></a><span>
</span><a name="line-366"></a><span>    </span><span class="hs-identifier">addOne</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcInteract.html#SolvedCts"><span class="hs-identifier hs-type">SolvedCts</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#EvTerm"><span class="hs-identifier hs-type">EvTerm</span></a><span class="hs-special">,</span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcInteract.html#SolvedCts"><span class="hs-identifier hs-type">SolvedCts</span></a><span>
</span><a name="line-367"></a><span>    </span><a name="local-1628066090"><a href="#local-1628066090"><span class="hs-identifier">addOne</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1628066113"><a href="#local-1628066113"><span class="hs-identifier">givens</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628066114"><a href="#local-1628066114"><span class="hs-identifier">deriveds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628066115"><a href="#local-1628066115"><span class="hs-identifier">wanteds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-1628066116"><a href="#local-1628066116"><span class="hs-identifier">ev</span></a></a><span class="hs-special">,</span><a name="local-1628066117"><a href="#local-1628066117"><span class="hs-identifier">ct</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="TcRnTypes.html#ctEvidence"><span class="hs-identifier hs-var">ctEvidence</span></a><span> </span><a href="#local-1628066117"><span class="hs-identifier hs-var">ct</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-368"></a><span>      </span><a href="TcRnTypes.html#CtGiven"><span class="hs-identifier hs-var">CtGiven</span></a><span>  </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-1628066117"><span class="hs-identifier hs-var">ct</span></a><span class="hs-glyph">:</span><a href="#local-1628066113"><span class="hs-identifier hs-var">givens</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628066114"><span class="hs-identifier hs-var">deriveds</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628066115"><span class="hs-identifier hs-var">wanteds</span></a><span class="hs-special">)</span><span>
</span><a name="line-369"></a><span>      </span><a href="TcRnTypes.html#CtDerived"><span class="hs-identifier hs-var">CtDerived</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-1628066113"><span class="hs-identifier hs-var">givens</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628066117"><span class="hs-identifier hs-var">ct</span></a><span class="hs-glyph">:</span><a href="#local-1628066114"><span class="hs-identifier hs-var">deriveds</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628066115"><span class="hs-identifier hs-var">wanteds</span></a><span class="hs-special">)</span><span>
</span><a name="line-370"></a><span>      </span><a href="TcRnTypes.html#CtWanted"><span class="hs-identifier hs-var">CtWanted</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-1628066113"><span class="hs-identifier hs-var">givens</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628066114"><span class="hs-identifier hs-var">deriveds</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-1628066116"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">,</span><a href="#local-1628066117"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">)</span><span class="hs-glyph">:</span><a href="#local-1628066115"><span class="hs-identifier hs-var">wanteds</span></a><span class="hs-special">)</span><span>
</span><a name="line-371"></a><span>
</span><a name="line-372"></a><span>
</span><a name="line-373"></a><span class="hs-keyword">type</span><span> </span><a name="WorkItem"><a href="TcInteract.html#WorkItem"><span class="hs-identifier">WorkItem</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span>
</span><a name="line-374"></a><span class="hs-keyword">type</span><span> </span><a name="SimplifierStage"><a href="TcInteract.html#SimplifierStage"><span class="hs-identifier">SimplifierStage</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcInteract.html#WorkItem"><span class="hs-identifier hs-type">WorkItem</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span class="hs-special">)</span><span>
</span><a name="line-375"></a><span>
</span><a name="line-376"></a><span class="hs-identifier">runSolverPipeline</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span class="hs-special">,</span><a href="TcInteract.html#SimplifierStage"><span class="hs-identifier hs-type">SimplifierStage</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- The pipeline</span><span>
</span><a name="line-377"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcInteract.html#WorkItem"><span class="hs-identifier hs-type">WorkItem</span></a><span>                   </span><span class="hs-comment">-- The work item</span><span>
</span><a name="line-378"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-379"></a><span class="hs-comment">-- Run this item down the pipeline, leaving behind new work and inerts</span><span>
</span><a name="line-380"></a><a name="runSolverPipeline"><a href="TcInteract.html#runSolverPipeline"><span class="hs-identifier">runSolverPipeline</span></a></a><span> </span><a name="local-1628066118"><a href="#local-1628066118"><span class="hs-identifier">pipeline</span></a></a><span> </span><a name="local-1628066119"><a href="#local-1628066119"><span class="hs-identifier">workItem</span></a></a><span>
</span><a name="line-381"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628066129"><a href="#local-1628066129"><span class="hs-identifier">wl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getWorkList"><span class="hs-identifier hs-var">getWorkList</span></a><span>
</span><a name="line-382"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;Start solver pipeline {&quot;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-383"></a><span>                  </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;work item =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066119"><span class="hs-identifier hs-var">workItem</span></a><span>
</span><a name="line-384"></a><span>                       </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;rest of worklist =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066129"><span class="hs-identifier hs-var">wl</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-385"></a><span>
</span><a name="line-386"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#bumpStepCountTcS"><span class="hs-identifier hs-var">bumpStepCountTcS</span></a><span>    </span><span class="hs-comment">-- One step for each constraint processed</span><span>
</span><a name="line-387"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628066130"><a href="#local-1628066130"><span class="hs-identifier">final_res</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628066120"><span class="hs-identifier hs-var">run_pipeline</span></a><span> </span><a href="#local-1628066118"><span class="hs-identifier hs-var">pipeline</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#ContinueWith"><span class="hs-identifier hs-var">ContinueWith</span></a><span> </span><a href="#local-1628066119"><span class="hs-identifier hs-var">workItem</span></a><span class="hs-special">)</span><span>
</span><a name="line-388"></a><span>
</span><a name="line-389"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628066131"><a href="#local-1628066131"><span class="hs-identifier">final_is</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getTcSInerts"><span class="hs-identifier hs-var">getTcSInerts</span></a><span>
</span><a name="line-390"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628066130"><span class="hs-identifier hs-var">final_res</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-391"></a><span>           </span><a href="TcCanonical.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><a name="local-1628066132"><a href="#local-1628066132"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-1628066133"><a href="#local-1628066133"><span class="hs-identifier">s</span></a></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceFireTcS"><span class="hs-identifier hs-var">traceFireTcS</span></a><span> </span><a href="#local-1628066132"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-1628066133"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-392"></a><span>                                 </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;End solver pipeline (discharged) }&quot;</span><span>
</span><a name="line-393"></a><span>                                       </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;inerts =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066131"><span class="hs-identifier hs-var">final_is</span></a><span class="hs-special">)</span><span>
</span><a name="line-394"></a><span>                                 </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-395"></a><span>           </span><a href="TcCanonical.html#ContinueWith"><span class="hs-identifier hs-var">ContinueWith</span></a><span> </span><a name="local-1628066134"><a href="#local-1628066134"><span class="hs-identifier">ct</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceFireTcS"><span class="hs-identifier hs-var">traceFireTcS</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#ctEvidence"><span class="hs-identifier hs-var">ctEvidence</span></a><span> </span><a href="#local-1628066134"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Kept as inert&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-396"></a><span>                                 </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;End solver pipeline (kept as inert) }&quot;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-397"></a><span>                                       </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;final_item =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066134"><span class="hs-identifier hs-var">ct</span></a><span>
</span><a name="line-398"></a><span>                                            </span><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#pprTvBndrs"><span class="hs-identifier hs-var">pprTvBndrs</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcRnTypes.html#tyCoVarsOfCtList"><span class="hs-identifier hs-var">tyCoVarsOfCtList</span></a><span> </span><a href="#local-1628066134"><span class="hs-identifier hs-var">ct</span></a><span>
</span><a name="line-399"></a><span>                                            </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;inerts     =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066131"><span class="hs-identifier hs-var">final_is</span></a><span class="hs-special">]</span><span>
</span><a name="line-400"></a><span>                                 </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#addInertCan"><span class="hs-identifier hs-var">addInertCan</span></a><span> </span><a href="#local-1628066134"><span class="hs-identifier hs-var">ct</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-401"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-402"></a><span>  </span><span class="hs-keyword">where</span><span> </span><span class="hs-identifier">run_pipeline</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span class="hs-special">,</span><a href="TcInteract.html#SimplifierStage"><span class="hs-identifier hs-type">SimplifierStage</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span>
</span><a name="line-403"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span class="hs-special">)</span><span>
</span><a name="line-404"></a><span>        </span><a name="local-1628066120"><a href="#local-1628066120"><span class="hs-identifier">run_pipeline</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-1628066121"><a href="#local-1628066121"><span class="hs-identifier">res</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-1628066121"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-405"></a><span>        </span><span class="hs-identifier">run_pipeline</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><a name="local-1628066122"><a href="#local-1628066122"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-1628066123"><a href="#local-1628066123"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><a href="#local-1628066122"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-1628066123"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-406"></a><span>        </span><span class="hs-identifier">run_pipeline</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-1628066124"><a href="#local-1628066124"><span class="hs-identifier">stg_name</span></a></a><span class="hs-special">,</span><a name="local-1628066125"><a href="#local-1628066125"><span class="hs-identifier">stg</span></a></a><span class="hs-special">)</span><span class="hs-glyph">:</span><a name="local-1628066126"><a href="#local-1628066126"><span class="hs-identifier">stgs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#ContinueWith"><span class="hs-identifier hs-var">ContinueWith</span></a><span> </span><a name="local-1628066127"><a href="#local-1628066127"><span class="hs-identifier">ct</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-407"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;runStage &quot;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-1628066124"><span class="hs-identifier hs-var">stg_name</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><span class="hs-string">&quot; {&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-408"></a><span>                          </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;workitem   = &quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066127"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">)</span><span>
</span><a name="line-409"></a><span>               </span><span class="hs-special">;</span><span> </span><a name="local-1628066128"><a href="#local-1628066128"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628066125"><span class="hs-identifier hs-var">stg</span></a><span> </span><a href="#local-1628066127"><span class="hs-identifier hs-var">ct</span></a><span>
</span><a name="line-410"></a><span>               </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;end stage &quot;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-1628066124"><span class="hs-identifier hs-var">stg_name</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><span class="hs-string">&quot; }&quot;</span><span class="hs-special">)</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-411"></a><span>               </span><span class="hs-special">;</span><span> </span><a href="#local-1628066120"><span class="hs-identifier hs-var">run_pipeline</span></a><span> </span><a href="#local-1628066126"><span class="hs-identifier hs-var">stgs</span></a><span> </span><a href="#local-1628066128"><span class="hs-identifier hs-var">res</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-412"></a><span>
</span><a name="line-413"></a><span class="hs-comment">{-
Example 1:
  Inert:   {c ~ d, F a ~ t, b ~ Int, a ~ ty} (all given)
  Reagent: a ~ [b] (given)

React with (c~d)     ==&gt; IR (ContinueWith (a~[b]))  True    []
React with (F a ~ t) ==&gt; IR (ContinueWith (a~[b]))  False   [F [b] ~ t]
React with (b ~ Int) ==&gt; IR (ContinueWith (a~[Int]) True    []

Example 2:
  Inert:  {c ~w d, F a ~g t, b ~w Int, a ~w ty}
  Reagent: a ~w [b]

React with (c ~w d)   ==&gt; IR (ContinueWith (a~[b]))  True    []
React with (F a ~g t) ==&gt; IR (ContinueWith (a~[b]))  True    []    (can't rewrite given with wanted!)
etc.

Example 3:
  Inert:  {a ~ Int, F Int ~ b} (given)
  Reagent: F a ~ b (wanted)

React with (a ~ Int)   ==&gt; IR (ContinueWith (F Int ~ b)) True []
React with (F Int ~ b) ==&gt; IR Stop True []    -- after substituting we re-canonicalize and get nothing
-}</span><span>
</span><a name="line-437"></a><span>
</span><a name="line-438"></a><span class="hs-identifier">thePipeline</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span class="hs-special">,</span><a href="TcInteract.html#SimplifierStage"><span class="hs-identifier hs-type">SimplifierStage</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-439"></a><a name="thePipeline"><a href="TcInteract.html#thePipeline"><span class="hs-identifier">thePipeline</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;canonicalization&quot;</span><span class="hs-special">,</span><span>        </span><a href="TcCanonical.html#canonicalize"><span class="hs-identifier hs-var">TcCanonical</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">canonicalize</span></a><span class="hs-special">)</span><span>
</span><a name="line-440"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;interact with inerts&quot;</span><span class="hs-special">,</span><span>    </span><a href="TcInteract.html#interactWithInertsStage"><span class="hs-identifier hs-var">interactWithInertsStage</span></a><span class="hs-special">)</span><span>
</span><a name="line-441"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;top-level reactions&quot;</span><span class="hs-special">,</span><span>     </span><a href="TcInteract.html#topReactionsStage"><span class="hs-identifier hs-var">topReactionsStage</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-442"></a><span>
</span><a name="line-443"></a><span class="hs-comment">{-
*********************************************************************************
*                                                                               *
                       The interact-with-inert Stage
*                                                                               *
*********************************************************************************

Note [The Solver Invariant]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
We always add Givens first.  So you might think that the solver has
the invariant

   If the work-item is Given,
   then the inert item must Given

But this isn't quite true.  Suppose we have,
    c1: [W] beta ~ [alpha], c2 : [W] blah, c3 :[W] alpha ~ Int
After processing the first two, we get
     c1: [G] beta ~ [alpha], c2 : [W] blah
Now, c3 does not interact with the the given c1, so when we spontaneously
solve c3, we must re-react it with the inert set.  So we can attempt a
reaction between inert c2 [W] and work-item c3 [G].

It *is* true that [Solver Invariant]
   If the work-item is Given,
   AND there is a reaction
   then the inert item must Given
or, equivalently,
   If the work-item is Given,
   and the inert item is Wanted/Derived
   then there is no reaction
-}</span><span>
</span><a name="line-475"></a><span>
</span><a name="line-476"></a><span class="hs-comment">-- Interaction result of  WorkItem &lt;~&gt; Ct</span><span>
</span><a name="line-477"></a><span>
</span><a name="line-478"></a><span class="hs-keyword">type</span><span> </span><a name="StopNowFlag"><a href="TcInteract.html#StopNowFlag"><span class="hs-identifier">StopNowFlag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>    </span><span class="hs-comment">-- True &lt;=&gt; stop after this interaction</span><span>
</span><a name="line-479"></a><span>
</span><a name="line-480"></a><span class="hs-identifier">interactWithInertsStage</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcInteract.html#WorkItem"><span class="hs-identifier hs-type">WorkItem</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span class="hs-special">)</span><span>
</span><a name="line-481"></a><span class="hs-comment">-- Precondition: if the workitem is a CTyEqCan then it will not be able to</span><span>
</span><a name="line-482"></a><span class="hs-comment">-- react with anything at this stage.</span><span>
</span><a name="line-483"></a><span>
</span><a name="line-484"></a><a name="interactWithInertsStage"><a href="TcInteract.html#interactWithInertsStage"><span class="hs-identifier">interactWithInertsStage</span></a></a><span> </span><a name="local-1628066135"><a href="#local-1628066135"><span class="hs-identifier">wi</span></a></a><span>
</span><a name="line-485"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628066136"><a href="#local-1628066136"><span class="hs-identifier">inerts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getTcSInerts"><span class="hs-identifier hs-var">getTcSInerts</span></a><span>
</span><a name="line-486"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628066137"><a href="#local-1628066137"><span class="hs-identifier">ics</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">inert_cans</span><span> </span><a href="#local-1628066136"><span class="hs-identifier hs-var">inerts</span></a><span>
</span><a name="line-487"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628066135"><span class="hs-identifier hs-var">wi</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-488"></a><span>             </span><a href="TcRnTypes.html#CTyEqCan"><span class="hs-identifier hs-var">CTyEqCan</span></a><span>    </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcInteract.html#interactTyVarEq"><span class="hs-identifier hs-var">interactTyVarEq</span></a><span> </span><a href="#local-1628066137"><span class="hs-identifier hs-var">ics</span></a><span> </span><a href="#local-1628066135"><span class="hs-identifier hs-var">wi</span></a><span>
</span><a name="line-489"></a><span>             </span><a href="TcRnTypes.html#CFunEqCan"><span class="hs-identifier hs-var">CFunEqCan</span></a><span>   </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcInteract.html#interactFunEq"><span class="hs-identifier hs-var">interactFunEq</span></a><span>   </span><a href="#local-1628066137"><span class="hs-identifier hs-var">ics</span></a><span> </span><a href="#local-1628066135"><span class="hs-identifier hs-var">wi</span></a><span>
</span><a name="line-490"></a><span>             </span><a href="TcRnTypes.html#CIrredEvCan"><span class="hs-identifier hs-var">CIrredEvCan</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcInteract.html#interactIrred"><span class="hs-identifier hs-var">interactIrred</span></a><span>   </span><a href="#local-1628066137"><span class="hs-identifier hs-var">ics</span></a><span> </span><a href="#local-1628066135"><span class="hs-identifier hs-var">wi</span></a><span>
</span><a name="line-491"></a><span>             </span><a href="TcRnTypes.html#CDictCan"><span class="hs-identifier hs-var">CDictCan</span></a><span>    </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcInteract.html#interactDict"><span class="hs-identifier hs-var">interactDict</span></a><span>    </span><a href="#local-1628066137"><span class="hs-identifier hs-var">ics</span></a><span> </span><a href="#local-1628066135"><span class="hs-identifier hs-var">wi</span></a><span>
</span><a name="line-492"></a><span>             </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;interactWithInerts&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066135"><span class="hs-identifier hs-var">wi</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-493"></a><span>                </span><span class="hs-comment">-- CHoleCan are put straight into inert_frozen, so never get here</span><span>
</span><a name="line-494"></a><span>                </span><span class="hs-comment">-- CNonCanonical have been canonicalised</span><span>
</span><a name="line-495"></a><span>
</span><a name="line-496"></a><span class="hs-keyword">data</span><span> </span><a name="InteractResult"><a href="TcInteract.html#InteractResult"><span class="hs-identifier">InteractResult</span></a></a><span>
</span><a name="line-497"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a name="IRKeep"><a href="TcInteract.html#IRKeep"><span class="hs-identifier">IRKeep</span></a></a><span>      </span><span class="hs-comment">-- Keep the existing inert constraint in the inert set</span><span>
</span><a name="line-498"></a><span>   </span><span class="hs-glyph">|</span><span> </span><a name="IRReplace"><a href="TcInteract.html#IRReplace"><span class="hs-identifier">IRReplace</span></a></a><span>   </span><span class="hs-comment">-- Replace the existing inert constraint with the work item</span><span>
</span><a name="line-499"></a><span>   </span><span class="hs-glyph">|</span><span> </span><a name="IRDelete"><a href="TcInteract.html#IRDelete"><span class="hs-identifier">IRDelete</span></a></a><span>    </span><span class="hs-comment">-- Delete the existing inert constraint from the inert set</span><span>
</span><a name="line-500"></a><span>
</span><a name="line-501"></a><span class="hs-keyword">instance</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="TcInteract.html#InteractResult"><span class="hs-identifier hs-type">InteractResult</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-502"></a><span>  </span><a name="local-1912652361"><a href="Outputable.html#ppr"><span class="hs-identifier">ppr</span></a></a><span> </span><a href="TcInteract.html#IRKeep"><span class="hs-identifier hs-var">IRKeep</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;keep&quot;</span><span>
</span><a name="line-503"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><a href="TcInteract.html#IRReplace"><span class="hs-identifier hs-var">IRReplace</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;replace&quot;</span><span>
</span><a name="line-504"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><a href="TcInteract.html#IRDelete"><span class="hs-identifier hs-var">IRDelete</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;delete&quot;</span><span>
</span><a name="line-505"></a><span>
</span><a name="line-506"></a><span class="hs-identifier">solveOneFromTheOther</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a><span>  </span><span class="hs-comment">-- Inert</span><span>
</span><a name="line-507"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a><span>  </span><span class="hs-comment">-- WorkItem</span><span>
</span><a name="line-508"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcInteract.html#InteractResult"><span class="hs-identifier hs-type">InteractResult</span></a><span class="hs-special">,</span><span> </span><a href="TcInteract.html#StopNowFlag"><span class="hs-identifier hs-type">StopNowFlag</span></a><span class="hs-special">)</span><span>
</span><a name="line-509"></a><span class="hs-comment">-- Preconditions:</span><span>
</span><a name="line-510"></a><span class="hs-comment">-- 1) inert and work item represent evidence for the /same/ predicate</span><span>
</span><a name="line-511"></a><span class="hs-comment">-- 2) ip/class/irred constraints only; not used for equalities</span><span>
</span><a name="line-512"></a><a name="solveOneFromTheOther"><a href="TcInteract.html#solveOneFromTheOther"><span class="hs-identifier">solveOneFromTheOther</span></a></a><span> </span><a name="local-1628066138"><a href="#local-1628066138"><span class="hs-identifier">ev_i</span></a></a><span> </span><a name="local-1628066139"><a href="#local-1628066139"><span class="hs-identifier">ev_w</span></a></a><span>
</span><a name="line-513"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TcRnTypes.html#isDerived"><span class="hs-identifier hs-var">isDerived</span></a><span> </span><a href="#local-1628066139"><span class="hs-identifier hs-var">ev_w</span></a><span>         </span><span class="hs-comment">-- Work item is Derived; just discard it</span><span>
</span><a name="line-514"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="TcInteract.html#IRKeep"><span class="hs-identifier hs-var">IRKeep</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span>
</span><a name="line-515"></a><span>
</span><a name="line-516"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TcRnTypes.html#isDerived"><span class="hs-identifier hs-var">isDerived</span></a><span> </span><a href="#local-1628066138"><span class="hs-identifier hs-var">ev_i</span></a><span>            </span><span class="hs-comment">-- The inert item is Derived, we can just throw it away,</span><span>
</span><a name="line-517"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="TcInteract.html#IRDelete"><span class="hs-identifier hs-var">IRDelete</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- The ev_w is inert wrt earlier inert-set items,</span><span>
</span><a name="line-518"></a><span>                              </span><span class="hs-comment">-- so it's safe to continue on from this point</span><span>
</span><a name="line-519"></a><span>
</span><a name="line-520"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TcRnTypes.html#CtWanted"><span class="hs-identifier hs-var">CtWanted</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctev_loc</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066153"><a href="#local-1628066153"><span class="hs-identifier">loc_w</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628066139"><span class="hs-identifier hs-var">ev_w</span></a><span>
</span><a name="line-521"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#prohibitedSuperClassSolve"><span class="hs-identifier hs-var">prohibitedSuperClassSolve</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a><span> </span><a href="#local-1628066138"><span class="hs-identifier hs-var">ev_i</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628066153"><span class="hs-identifier hs-var">loc_w</span></a><span>
</span><a name="line-522"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="TcInteract.html#IRDelete"><span class="hs-identifier hs-var">IRDelete</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span>
</span><a name="line-523"></a><span>
</span><a name="line-524"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TcRnTypes.html#CtWanted"><span class="hs-identifier hs-var">CtWanted</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctev_dest</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066154"><a href="#local-1628066154"><span class="hs-identifier">dest</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628066139"><span class="hs-identifier hs-var">ev_w</span></a><span>
</span><a name="line-525"></a><span>       </span><span class="hs-comment">-- Inert is Given or Wanted</span><span>
</span><a name="line-526"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#setWantedEvTerm"><span class="hs-identifier hs-var">setWantedEvTerm</span></a><span> </span><a href="#local-1628066154"><span class="hs-identifier hs-var">dest</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#ctEvTerm"><span class="hs-identifier hs-var">ctEvTerm</span></a><span> </span><a href="#local-1628066138"><span class="hs-identifier hs-var">ev_i</span></a><span class="hs-special">)</span><span>
</span><a name="line-527"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="TcInteract.html#IRKeep"><span class="hs-identifier hs-var">IRKeep</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-528"></a><span>
</span><a name="line-529"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TcRnTypes.html#CtWanted"><span class="hs-identifier hs-var">CtWanted</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctev_loc</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066155"><a href="#local-1628066155"><span class="hs-identifier">loc_i</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628066138"><span class="hs-identifier hs-var">ev_i</span></a><span>   </span><span class="hs-comment">-- Work item is Given</span><span>
</span><a name="line-530"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#prohibitedSuperClassSolve"><span class="hs-identifier hs-var">prohibitedSuperClassSolve</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a><span> </span><a href="#local-1628066139"><span class="hs-identifier hs-var">ev_w</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628066155"><span class="hs-identifier hs-var">loc_i</span></a><span>
</span><a name="line-531"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="TcInteract.html#IRKeep"><span class="hs-identifier hs-var">IRKeep</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Just discard the un-usable Given</span><span>
</span><a name="line-532"></a><span>                            </span><span class="hs-comment">-- This never actually happens because</span><span>
</span><a name="line-533"></a><span>                            </span><span class="hs-comment">-- Givens get processed first</span><span>
</span><a name="line-534"></a><span>
</span><a name="line-535"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TcRnTypes.html#CtWanted"><span class="hs-identifier hs-var">CtWanted</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctev_dest</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066156"><a href="#local-1628066156"><span class="hs-identifier">dest</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628066138"><span class="hs-identifier hs-var">ev_i</span></a><span>
</span><a name="line-536"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#setWantedEvTerm"><span class="hs-identifier hs-var">setWantedEvTerm</span></a><span> </span><a href="#local-1628066156"><span class="hs-identifier hs-var">dest</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#ctEvTerm"><span class="hs-identifier hs-var">ctEvTerm</span></a><span> </span><a href="#local-1628066139"><span class="hs-identifier hs-var">ev_w</span></a><span class="hs-special">)</span><span>
</span><a name="line-537"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="TcInteract.html#IRReplace"><span class="hs-identifier hs-var">IRReplace</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-538"></a><span>
</span><a name="line-539"></a><span>  </span><span class="hs-comment">-- So they are both Given</span><span>
</span><a name="line-540"></a><span>  </span><span class="hs-comment">-- See Note [Replacement vs keeping]</span><span>
</span><a name="line-541"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628066143"><span class="hs-identifier hs-var">lvl_i</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-1628066144"><span class="hs-identifier hs-var">lvl_w</span></a><span>
</span><a name="line-542"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628066157"><a href="#local-1628066157"><span class="hs-identifier">binds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getTcEvBindsMap"><span class="hs-identifier hs-var">getTcEvBindsMap</span></a><span>
</span><a name="line-543"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628066146"><span class="hs-identifier hs-var">same_level_strategy</span></a><span> </span><a href="#local-1628066157"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-544"></a><span>
</span><a name="line-545"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>   </span><span class="hs-comment">-- Both are Given, levels differ</span><span>
</span><a name="line-546"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628066145"><span class="hs-identifier hs-var">different_level_strategy</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span>
</span><a name="line-547"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-548"></a><span>     </span><a name="local-1628066140"><a href="#local-1628066140"><span class="hs-identifier">pred</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#ctEvPred"><span class="hs-identifier hs-var">ctEvPred</span></a><span> </span><a href="#local-1628066138"><span class="hs-identifier hs-var">ev_i</span></a><span>
</span><a name="line-549"></a><span>     </span><a name="local-1628066141"><a href="#local-1628066141"><span class="hs-identifier">loc_i</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a><span> </span><a href="#local-1628066138"><span class="hs-identifier hs-var">ev_i</span></a><span>
</span><a name="line-550"></a><span>     </span><a name="local-1628066142"><a href="#local-1628066142"><span class="hs-identifier">loc_w</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a><span> </span><a href="#local-1628066139"><span class="hs-identifier hs-var">ev_w</span></a><span>
</span><a name="line-551"></a><span>     </span><a name="local-1628066143"><a href="#local-1628066143"><span class="hs-identifier">lvl_i</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#ctLocLevel"><span class="hs-identifier hs-var">ctLocLevel</span></a><span> </span><a href="#local-1628066141"><span class="hs-identifier hs-var">loc_i</span></a><span>
</span><a name="line-552"></a><span>     </span><a name="local-1628066144"><a href="#local-1628066144"><span class="hs-identifier">lvl_w</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#ctLocLevel"><span class="hs-identifier hs-var">ctLocLevel</span></a><span> </span><a href="#local-1628066142"><span class="hs-identifier hs-var">loc_w</span></a><span>
</span><a name="line-553"></a><span>
</span><a name="line-554"></a><span>     </span><a name="local-1628066145"><a href="#local-1628066145"><span class="hs-identifier">different_level_strategy</span></a></a><span>
</span><a name="line-555"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="Type.html#isIPPred"><span class="hs-identifier hs-var">isIPPred</span></a><span> </span><a href="#local-1628066140"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628066144"><span class="hs-identifier hs-var">lvl_w</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="#local-1628066143"><span class="hs-identifier hs-var">lvl_i</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcInteract.html#IRReplace"><span class="hs-identifier hs-var">IRReplace</span></a><span>
</span><a name="line-556"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628066144"><span class="hs-identifier hs-var">lvl_w</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-1628066143"><span class="hs-identifier hs-var">lvl_i</span></a><span>                </span><span class="hs-glyph">=</span><span> </span><a href="TcInteract.html#IRReplace"><span class="hs-identifier hs-var">IRReplace</span></a><span>
</span><a name="line-557"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>                    </span><span class="hs-glyph">=</span><span> </span><a href="TcInteract.html#IRKeep"><span class="hs-identifier hs-var">IRKeep</span></a><span>
</span><a name="line-558"></a><span>
</span><a name="line-559"></a><span>     </span><a name="local-1628066146"><a href="#local-1628066146"><span class="hs-identifier">same_level_strategy</span></a></a><span> </span><a name="local-1628066148"><a href="#local-1628066148"><span class="hs-identifier">binds</span></a></a><span>        </span><span class="hs-comment">-- Both Given</span><span>
</span><a name="line-560"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="TcRnTypes.html#GivenOrigin"><span class="hs-identifier hs-var">GivenOrigin</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#InstSC"><span class="hs-identifier hs-var">InstSC</span></a><span> </span><a name="local-1628066149"><a href="#local-1628066149"><span class="hs-identifier">s_i</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnTypes.html#ctLocOrigin"><span class="hs-identifier hs-var">ctLocOrigin</span></a><span> </span><a href="#local-1628066141"><span class="hs-identifier hs-var">loc_i</span></a><span>
</span><a name="line-561"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="TcRnTypes.html#ctLocOrigin"><span class="hs-identifier hs-var">ctLocOrigin</span></a><span> </span><a href="#local-1628066142"><span class="hs-identifier hs-var">loc_w</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-562"></a><span>            </span><a href="TcRnTypes.html#GivenOrigin"><span class="hs-identifier hs-var">GivenOrigin</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#InstSC"><span class="hs-identifier hs-var">InstSC</span></a><span> </span><a name="local-1628066150"><a href="#local-1628066150"><span class="hs-identifier">s_w</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628066150"><span class="hs-identifier hs-var">s_w</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-1628066149"><span class="hs-identifier hs-var">s_i</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcInteract.html#IRReplace"><span class="hs-identifier hs-var">IRReplace</span></a><span>
</span><a name="line-563"></a><span>                                     </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcInteract.html#IRKeep"><span class="hs-identifier hs-var">IRKeep</span></a><span>
</span><a name="line-564"></a><span>            </span><span class="hs-identifier">_</span><span>                                    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcInteract.html#IRReplace"><span class="hs-identifier hs-var">IRReplace</span></a><span>
</span><a name="line-565"></a><span>
</span><a name="line-566"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="TcRnTypes.html#GivenOrigin"><span class="hs-identifier hs-var">GivenOrigin</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#InstSC"><span class="hs-identifier hs-var">InstSC</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnTypes.html#ctLocOrigin"><span class="hs-identifier hs-var">ctLocOrigin</span></a><span> </span><a href="#local-1628066142"><span class="hs-identifier hs-var">loc_w</span></a><span>
</span><a name="line-567"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="TcInteract.html#IRKeep"><span class="hs-identifier hs-var">IRKeep</span></a><span>
</span><a name="line-568"></a><span>
</span><a name="line-569"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628066147"><span class="hs-identifier hs-var">has_binding</span></a><span> </span><a href="#local-1628066148"><span class="hs-identifier hs-var">binds</span></a><span> </span><a href="#local-1628066139"><span class="hs-identifier hs-var">ev_w</span></a><span>
</span><a name="line-570"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-1628066147"><span class="hs-identifier hs-var">has_binding</span></a><span> </span><a href="#local-1628066148"><span class="hs-identifier hs-var">binds</span></a><span> </span><a href="#local-1628066138"><span class="hs-identifier hs-var">ev_i</span></a><span class="hs-special">)</span><span>
</span><a name="line-571"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="TcInteract.html#IRReplace"><span class="hs-identifier hs-var">IRReplace</span></a><span>
</span><a name="line-572"></a><span>
</span><a name="line-573"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcInteract.html#IRKeep"><span class="hs-identifier hs-var">IRKeep</span></a><span>
</span><a name="line-574"></a><span>
</span><a name="line-575"></a><span>     </span><a name="local-1628066147"><a href="#local-1628066147"><span class="hs-identifier">has_binding</span></a></a><span> </span><a name="local-1628066151"><a href="#local-1628066151"><span class="hs-identifier">binds</span></a></a><span> </span><a name="local-1628066152"><a href="#local-1628066152"><span class="hs-identifier">ev</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#isJust"><span class="hs-identifier hs-var">isJust</span></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#lookupEvBind"><span class="hs-identifier hs-var">lookupEvBind</span></a><span> </span><a href="#local-1628066151"><span class="hs-identifier hs-var">binds</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#ctEvId"><span class="hs-identifier hs-var">ctEvId</span></a><span> </span><a href="#local-1628066152"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-576"></a><span>
</span><a name="line-577"></a><span class="hs-comment">{-
Note [Replacement vs keeping]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When we have two Given constraints both of type (C tys), say, which should
we keep?  More subtle than you might think!

  * Constraints come from different levels (different_level_strategy)

      - For implicit parameters we want to keep the innermost (deepest)
        one, so that it overrides the outer one.
        See Note [Shadowing of Implicit Parameters]

      - For everything else, we want to keep the outermost one.  Reason: that
        makes it more likely that the inner one will turn out to be unused,
        and can be reported as redundant.  See Note [Tracking redundant constraints]
        in TcSimplify.

        It transpires that using the outermost one is reponsible for an
        8% performance improvement in nofib cryptarithm2, compared to
        just rolling the dice.  I didn't investigate why.

  * Constraints coming from the same level (i.e. same implication)

       - Always get rid of InstSC ones if possible, since they are less
         useful for solving.  If both are InstSC, choose the one with
         the smallest TypeSize
         See Note [Solving superclass constraints] in TcInstDcls

       - Keep the one that has a non-trivial evidence binding.
            Example:  f :: (Eq a, Ord a) =&gt; blah
            then we may find [G] d3 :: Eq a
                             [G] d2 :: Eq a
              with bindings  d3 = sc_sel (d1::Ord a)
            We want to discard d2 in favour of the superclass selection from
            the Ord dictionary.
         Why? See Note [Tracking redundant constraints] in TcSimplify again.

  * Finally, when there is still a choice, use IRKeep rather than
    IRReplace, to avoid unnecessary munging of the inert set.

Doing the depth-check for implicit parameters, rather than making the work item
always overrride, is important.  Consider

    data T a where { T1 :: (?x::Int) =&gt; T Int; T2 :: T a }

    f :: (?x::a) =&gt; T a -&gt; Int
    f T1 = ?x
    f T2 = 3

We have a [G] (?x::a) in the inert set, and at the pattern match on T1 we add
two new givens in the work-list:  [G] (?x::Int)
                                  [G] (a ~ Int)
Now consider these steps
  - process a~Int, kicking out (?x::a)
  - process (?x::Int), the inner given, adding to inert set
  - process (?x::a), the outer given, overriding the inner given
Wrong!  The depth-check ensures that the inner implicit parameter wins.
(Actually I think that the order in which the work-list is processed means
that this chain of events won't happen, but that's very fragile.)

*********************************************************************************
*                                                                               *
                   interactIrred
*                                                                               *
*********************************************************************************
-}</span><span>
</span><a name="line-643"></a><span>
</span><a name="line-644"></a><span class="hs-comment">-- Two pieces of irreducible evidence: if their types are *exactly identical*</span><span>
</span><a name="line-645"></a><span class="hs-comment">-- we can rewrite them. We can never improve using this:</span><span>
</span><a name="line-646"></a><span class="hs-comment">-- if we want ty1 :: Constraint and have ty2 :: Constraint it clearly does not</span><span>
</span><a name="line-647"></a><span class="hs-comment">-- mean that (ty1 ~ ty2)</span><span>
</span><a name="line-648"></a><span class="hs-identifier">interactIrred</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span class="hs-special">)</span><span>
</span><a name="line-649"></a><span>
</span><a name="line-650"></a><a name="interactIrred"><a href="TcInteract.html#interactIrred"><span class="hs-identifier">interactIrred</span></a></a><span> </span><a name="local-1628066158"><a href="#local-1628066158"><span class="hs-identifier">inerts</span></a></a><span> </span><a name="local-1628066159"><a href="#local-1628066159"><span class="hs-identifier">workItem</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TcRnTypes.html#CIrredEvCan"><span class="hs-identifier hs-var">CIrredEvCan</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066160"><a href="#local-1628066160"><span class="hs-identifier">ev_w</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-651"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628066161"><a href="#local-1628066161"><span class="hs-identifier">pred</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#ctEvPred"><span class="hs-identifier hs-var">ctEvPred</span></a><span> </span><a href="#local-1628066160"><span class="hs-identifier hs-var">ev_w</span></a><span>
</span><a name="line-652"></a><span>        </span><span class="hs-special">(</span><a name="local-1628066162"><a href="#local-1628066162"><span class="hs-identifier">matching_irreds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628066163"><a href="#local-1628066163"><span class="hs-identifier">others</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-653"></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="Bag.html#partitionBag"><span class="hs-identifier hs-var">partitionBag</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-1628066164"><a href="#local-1628066164"><span class="hs-identifier">ct</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#ctPred"><span class="hs-identifier hs-var">ctPred</span></a><span> </span><a href="#local-1628066164"><span class="hs-identifier hs-var">ct</span></a><span> </span><span class="hs-special">`</span><a href="TcType.html#tcEqTypeNoKindCheck"><span class="hs-identifier hs-var">tcEqTypeNoKindCheck</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628066161"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">)</span><span>
</span><a name="line-654"></a><span>                         </span><span class="hs-special">(</span><span class="hs-identifier">inert_irreds</span><span> </span><a href="#local-1628066158"><span class="hs-identifier hs-var">inerts</span></a><span class="hs-special">)</span><span>
</span><a name="line-655"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-1628066165"><a href="#local-1628066165"><span class="hs-identifier">ct_i</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-1628066166"><a href="#local-1628066166"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Bag.html#bagToList"><span class="hs-identifier hs-var">bagToList</span></a><span> </span><a href="#local-1628066162"><span class="hs-identifier hs-var">matching_irreds</span></a><span>
</span><a name="line-656"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628066167"><a href="#local-1628066167"><span class="hs-identifier">ctev_i</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#ctEvidence"><span class="hs-identifier hs-var">ctEvidence</span></a><span> </span><a href="#local-1628066165"><span class="hs-identifier hs-var">ct_i</span></a><span>
</span><a name="line-657"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">null</span></a><span> </span><span class="hs-identifier">rest</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-658"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-1628066168"><a href="#local-1628066168"><span class="hs-identifier">inert_effect</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628066169"><a href="#local-1628066169"><span class="hs-identifier">stop_now</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcInteract.html#solveOneFromTheOther"><span class="hs-identifier hs-var">solveOneFromTheOther</span></a><span> </span><a href="#local-1628066167"><span class="hs-identifier hs-var">ctev_i</span></a><span> </span><a href="#local-1628066160"><span class="hs-identifier hs-var">ev_w</span></a><span>
</span><a name="line-659"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628066168"><span class="hs-identifier hs-var">inert_effect</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-660"></a><span>            </span><a href="TcInteract.html#IRKeep"><span class="hs-identifier hs-var">IRKeep</span></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-661"></a><span>            </span><a href="TcInteract.html#IRDelete"><span class="hs-identifier hs-var">IRDelete</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#updInertIrreds"><span class="hs-identifier hs-var">updInertIrreds</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628066163"><span class="hs-identifier hs-var">others</span></a><span class="hs-special">)</span><span>
</span><a name="line-662"></a><span>            </span><a href="TcInteract.html#IRReplace"><span class="hs-identifier hs-var">IRReplace</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#updInertIrreds"><span class="hs-identifier hs-var">updInertIrreds</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628066163"><span class="hs-identifier hs-var">others</span></a><span> </span><span class="hs-special">`</span><a href="TcRnTypes.html#snocCts"><span class="hs-identifier hs-var">snocCts</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628066159"><span class="hs-identifier hs-var">workItem</span></a><span class="hs-special">)</span><span>
</span><a name="line-663"></a><span>                         </span><span class="hs-comment">-- These const upd's assume that solveOneFromTheOther</span><span>
</span><a name="line-664"></a><span>                         </span><span class="hs-comment">-- has no side effects on InertCans</span><span>
</span><a name="line-665"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-1628066169"><span class="hs-identifier hs-var">stop_now</span></a><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-666"></a><span>            </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><a href="#local-1628066160"><span class="hs-identifier hs-var">ev_w</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Irred equal&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066168"><span class="hs-identifier hs-var">inert_effect</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-667"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">else</span><span>
</span><a name="line-668"></a><span>            </span><a href="TcCanonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a><span> </span><a href="#local-1628066159"><span class="hs-identifier hs-var">workItem</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-669"></a><span>
</span><a name="line-670"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-671"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcCanonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a><span> </span><a href="#local-1628066159"><span class="hs-identifier hs-var">workItem</span></a><span>
</span><a name="line-672"></a><span>
</span><a name="line-673"></a><span class="hs-identifier">interactIrred</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1628066170"><a href="#local-1628066170"><span class="hs-identifier">wi</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;interactIrred&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066170"><span class="hs-identifier hs-var">wi</span></a><span class="hs-special">)</span><span>
</span><a name="line-674"></a><span>
</span><a name="line-675"></a><span class="hs-comment">{-
*********************************************************************************
*                                                                               *
                   interactDict
*                                                                               *
*********************************************************************************
-}</span><span>
</span><a name="line-682"></a><span>
</span><a name="line-683"></a><span class="hs-identifier">interactDict</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span class="hs-special">)</span><span>
</span><a name="line-684"></a><a name="interactDict"><a href="TcInteract.html#interactDict"><span class="hs-identifier">interactDict</span></a></a><span> </span><a name="local-1628066171"><a href="#local-1628066171"><span class="hs-identifier">inerts</span></a></a><span> </span><a name="local-1628066172"><a href="#local-1628066172"><span class="hs-identifier">workItem</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TcRnTypes.html#CDictCan"><span class="hs-identifier hs-var">CDictCan</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066173"><a href="#local-1628066173"><span class="hs-identifier">ev_w</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_class</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066174"><a href="#local-1628066174"><span class="hs-identifier">cls</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_tyargs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066175"><a href="#local-1628066175"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-685"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TcRnTypes.html#isWanted"><span class="hs-identifier hs-var">isWanted</span></a><span> </span><a href="#local-1628066173"><span class="hs-identifier hs-var">ev_w</span></a><span>
</span><a name="line-686"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628066176"><a href="#local-1628066176"><span class="hs-identifier">ip_name</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcType.html#isCallStackPred"><span class="hs-identifier hs-var">isCallStackPred</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#ctPred"><span class="hs-identifier hs-var">ctPred</span></a><span> </span><a href="#local-1628066172"><span class="hs-identifier hs-var">workItem</span></a><span class="hs-special">)</span><span>
</span><a name="line-687"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="TcRnTypes.html#OccurrenceOf"><span class="hs-identifier hs-var">OccurrenceOf</span></a><span> </span><a name="local-1628066177"><a href="#local-1628066177"><span class="hs-identifier">func</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnTypes.html#ctLocOrigin"><span class="hs-identifier hs-var">ctLocOrigin</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a><span> </span><a href="#local-1628066173"><span class="hs-identifier hs-var">ev_w</span></a><span class="hs-special">)</span><span>
</span><a name="line-688"></a><span>  </span><span class="hs-comment">-- If we're given a CallStack constraint that arose from a function</span><span>
</span><a name="line-689"></a><span>  </span><span class="hs-comment">-- call, we need to push the current call-site onto the stack instead</span><span>
</span><a name="line-690"></a><span>  </span><span class="hs-comment">-- of solving it directly from a given.</span><span>
</span><a name="line-691"></a><span>  </span><span class="hs-comment">-- See Note [Overview of implicit CallStacks]</span><span>
</span><a name="line-692"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628066178"><a href="#local-1628066178"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a><span> </span><a href="#local-1628066173"><span class="hs-identifier hs-var">ev_w</span></a><span>
</span><a name="line-693"></a><span>
</span><a name="line-694"></a><span>         </span><span class="hs-comment">-- First we emit a new constraint that will capture the</span><span>
</span><a name="line-695"></a><span>         </span><span class="hs-comment">-- given CallStack.</span><span>
</span><a name="line-696"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628066179"><a href="#local-1628066179"><span class="hs-identifier">new_loc</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#setCtLocOrigin"><span class="hs-identifier hs-var">setCtLocOrigin</span></a><span> </span><a href="#local-1628066178"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#IPOccOrigin"><span class="hs-identifier hs-var">IPOccOrigin</span></a><span> </span><span class="hs-special">(</span><a href="HsTypes.html#HsIPName"><span class="hs-identifier hs-var">HsIPName</span></a><span> </span><a href="#local-1628066176"><span class="hs-identifier hs-var">ip_name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-697"></a><span>                            </span><span class="hs-comment">-- We change the origin to IPOccOrigin so</span><span>
</span><a name="line-698"></a><span>                            </span><span class="hs-comment">-- this rule does not fire again.</span><span>
</span><a name="line-699"></a><span>                            </span><span class="hs-comment">-- See Note [Overview of implicit CallStacks]</span><span>
</span><a name="line-700"></a><span>
</span><a name="line-701"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628066180"><a href="#local-1628066180"><span class="hs-identifier">mb_new</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#newWantedEvVar"><span class="hs-identifier hs-var">newWantedEvVar</span></a><span> </span><a href="#local-1628066179"><span class="hs-identifier hs-var">new_loc</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#ctEvPred"><span class="hs-identifier hs-var">ctEvPred</span></a><span> </span><a href="#local-1628066173"><span class="hs-identifier hs-var">ev_w</span></a><span class="hs-special">)</span><span>
</span><a name="line-702"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#emitWorkNC"><span class="hs-identifier hs-var">emitWorkNC</span></a><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#freshGoals"><span class="hs-identifier hs-var">freshGoals</span></a><span> </span><span class="hs-special">[</span><a href="#local-1628066180"><span class="hs-identifier hs-var">mb_new</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-703"></a><span>
</span><a name="line-704"></a><span>         </span><span class="hs-comment">-- Then we solve the wanted by pushing the call-site onto the</span><span>
</span><a name="line-705"></a><span>         </span><span class="hs-comment">-- newly emitted CallStack.</span><span>
</span><a name="line-706"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628066181"><a href="#local-1628066181"><span class="hs-identifier">ev_cs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcEvidence.html#EvCsPushCall"><span class="hs-identifier hs-var">EvCsPushCall</span></a><span> </span><a href="#local-1628066177"><span class="hs-identifier hs-var">func</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#ctLocSpan"><span class="hs-identifier hs-var">ctLocSpan</span></a><span> </span><a href="#local-1628066178"><span class="hs-identifier hs-var">loc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#getEvTerm"><span class="hs-identifier hs-var">getEvTerm</span></a><span> </span><a href="#local-1628066180"><span class="hs-identifier hs-var">mb_new</span></a><span class="hs-special">)</span><span>
</span><a name="line-707"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcInteract.html#solveCallStack"><span class="hs-identifier hs-var">solveCallStack</span></a><span> </span><a href="#local-1628066173"><span class="hs-identifier hs-var">ev_w</span></a><span> </span><a href="#local-1628066181"><span class="hs-identifier hs-var">ev_cs</span></a><span>
</span><a name="line-708"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#stopWith"><span class="hs-identifier hs-var">stopWith</span></a><span> </span><a href="#local-1628066173"><span class="hs-identifier hs-var">ev_w</span></a><span> </span><span class="hs-string">&quot;Wanted CallStack IP&quot;</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-709"></a><span>
</span><a name="line-710"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628066182"><a href="#local-1628066182"><span class="hs-identifier">ctev_i</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#lookupInertDict"><span class="hs-identifier hs-var">lookupInertDict</span></a><span> </span><a href="#local-1628066171"><span class="hs-identifier hs-var">inerts</span></a><span> </span><a href="#local-1628066174"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-1628066175"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-711"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-1628066183"><a href="#local-1628066183"><span class="hs-identifier">inert_effect</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628066184"><a href="#local-1628066184"><span class="hs-identifier">stop_now</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcInteract.html#solveOneFromTheOther"><span class="hs-identifier hs-var">solveOneFromTheOther</span></a><span> </span><a href="#local-1628066182"><span class="hs-identifier hs-var">ctev_i</span></a><span> </span><a href="#local-1628066173"><span class="hs-identifier hs-var">ev_w</span></a><span>
</span><a name="line-712"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628066183"><span class="hs-identifier hs-var">inert_effect</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-713"></a><span>           </span><a href="TcInteract.html#IRKeep"><span class="hs-identifier hs-var">IRKeep</span></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-714"></a><span>           </span><a href="TcInteract.html#IRDelete"><span class="hs-identifier hs-var">IRDelete</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#updInertDicts"><span class="hs-identifier hs-var">updInertDicts</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-1628066185"><a href="#local-1628066185"><span class="hs-identifier">ds</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#delDict"><span class="hs-identifier hs-var">delDict</span></a><span> </span><a href="#local-1628066185"><span class="hs-identifier hs-var">ds</span></a><span> </span><a href="#local-1628066174"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-1628066175"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-715"></a><span>           </span><a href="TcInteract.html#IRReplace"><span class="hs-identifier hs-var">IRReplace</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#updInertDicts"><span class="hs-identifier hs-var">updInertDicts</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-1628066186"><a href="#local-1628066186"><span class="hs-identifier">ds</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#addDict"><span class="hs-identifier hs-var">addDict</span></a><span> </span><a href="#local-1628066186"><span class="hs-identifier hs-var">ds</span></a><span> </span><a href="#local-1628066174"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-1628066175"><span class="hs-identifier hs-var">tys</span></a><span> </span><a href="#local-1628066172"><span class="hs-identifier hs-var">workItem</span></a><span>
</span><a name="line-716"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-1628066184"><span class="hs-identifier hs-var">stop_now</span></a><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-717"></a><span>            </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><a href="#local-1628066173"><span class="hs-identifier hs-var">ev_w</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Dict equal&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066183"><span class="hs-identifier hs-var">inert_effect</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-718"></a><span>         </span><span class="hs-keyword">else</span><span>
</span><a name="line-719"></a><span>            </span><a href="TcCanonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a><span> </span><a href="#local-1628066172"><span class="hs-identifier hs-var">workItem</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-720"></a><span>
</span><a name="line-721"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628066174"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-special">`</span><a href="Unique.html#hasKey"><span class="hs-identifier hs-var">hasKey</span></a><span class="hs-special">`</span><span> </span><a href="PrelNames.html#ipClassKey"><span class="hs-identifier hs-var">ipClassKey</span></a><span>
</span><a name="line-722"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="TcRnTypes.html#isGiven"><span class="hs-identifier hs-var">isGiven</span></a><span> </span><a href="#local-1628066173"><span class="hs-identifier hs-var">ev_w</span></a><span>
</span><a name="line-723"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcInteract.html#interactGivenIP"><span class="hs-identifier hs-var">interactGivenIP</span></a><span> </span><a href="#local-1628066171"><span class="hs-identifier hs-var">inerts</span></a><span> </span><a href="#local-1628066172"><span class="hs-identifier hs-var">workItem</span></a><span>
</span><a name="line-724"></a><span>
</span><a name="line-725"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-726"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcInteract.html#addFunDepWork"><span class="hs-identifier hs-var">addFunDepWork</span></a><span> </span><a href="#local-1628066171"><span class="hs-identifier hs-var">inerts</span></a><span> </span><a href="#local-1628066173"><span class="hs-identifier hs-var">ev_w</span></a><span> </span><a href="#local-1628066174"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-727"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a><span> </span><a href="#local-1628066172"><span class="hs-identifier hs-var">workItem</span></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-728"></a><span>
</span><a name="line-729"></a><span class="hs-identifier">interactDict</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1628066187"><a href="#local-1628066187"><span class="hs-identifier">wi</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;interactDict&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066187"><span class="hs-identifier hs-var">wi</span></a><span class="hs-special">)</span><span>
</span><a name="line-730"></a><span>
</span><a name="line-731"></a><span class="hs-identifier">addFunDepWork</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-732"></a><span class="hs-comment">-- Add derived constraints from type-class functional dependencies.</span><span>
</span><a name="line-733"></a><a name="addFunDepWork"><a href="TcInteract.html#addFunDepWork"><span class="hs-identifier">addFunDepWork</span></a></a><span> </span><a name="local-1628066188"><a href="#local-1628066188"><span class="hs-identifier">inerts</span></a></a><span> </span><a name="local-1628066189"><a href="#local-1628066189"><span class="hs-identifier">work_ev</span></a></a><span> </span><a name="local-1628066190"><a href="#local-1628066190"><span class="hs-identifier">cls</span></a></a><span>
</span><a name="line-734"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Bag.html#mapBagM_"><span class="hs-identifier hs-var">mapBagM_</span></a><span> </span><a href="#local-1628066193"><span class="hs-identifier hs-var">add_fds</span></a><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#findDictsByClass"><span class="hs-identifier hs-var">findDictsByClass</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">inert_dicts</span><span> </span><a href="#local-1628066188"><span class="hs-identifier hs-var">inerts</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628066190"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span>
</span><a name="line-735"></a><span>               </span><span class="hs-comment">-- No need to check flavour; fundeps work between</span><span>
</span><a name="line-736"></a><span>               </span><span class="hs-comment">-- any pair of constraints, regardless of flavour</span><span>
</span><a name="line-737"></a><span>               </span><span class="hs-comment">-- Importantly we don't throw workitem back in the</span><span>
</span><a name="line-738"></a><span>               </span><span class="hs-comment">-- worklist because this can cause loops (see #5236)</span><span>
</span><a name="line-739"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-740"></a><span>    </span><a name="local-1628066191"><a href="#local-1628066191"><span class="hs-identifier">work_pred</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#ctEvPred"><span class="hs-identifier hs-var">ctEvPred</span></a><span> </span><a href="#local-1628066189"><span class="hs-identifier hs-var">work_ev</span></a><span>
</span><a name="line-741"></a><span>    </span><a name="local-1628066192"><a href="#local-1628066192"><span class="hs-identifier">work_loc</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a><span> </span><a href="#local-1628066189"><span class="hs-identifier hs-var">work_ev</span></a><span>
</span><a name="line-742"></a><span>    </span><a name="local-1628066193"><a href="#local-1628066193"><span class="hs-identifier">add_fds</span></a></a><span> </span><a name="local-1628066194"><a href="#local-1628066194"><span class="hs-identifier">inert_ct</span></a></a><span>
</span><a name="line-743"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcInteract.html#emitFunDepDeriveds"><span class="hs-identifier hs-var">emitFunDepDeriveds</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-744"></a><span>        </span><a href="FunDeps.html#improveFromAnother"><span class="hs-identifier hs-var">improveFromAnother</span></a><span> </span><a href="#local-1628066197"><span class="hs-identifier hs-var">derived_loc</span></a><span> </span><a href="#local-1628066195"><span class="hs-identifier hs-var">inert_pred</span></a><span> </span><a href="#local-1628066191"><span class="hs-identifier hs-var">work_pred</span></a><span>
</span><a name="line-745"></a><span>               </span><span class="hs-comment">-- We don't really rewrite tys2, see below _rewritten_tys2, so that's ok</span><span>
</span><a name="line-746"></a><span>               </span><span class="hs-comment">-- NB: We do create FDs for given to report insoluble equations that arise</span><span>
</span><a name="line-747"></a><span>               </span><span class="hs-comment">-- from pairs of Givens, and also because of floating when we approximate</span><span>
</span><a name="line-748"></a><span>               </span><span class="hs-comment">-- implications. The relevant test is: typecheck/should_fail/FDsFromGivens.hs</span><span>
</span><a name="line-749"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-750"></a><span>        </span><a name="local-1628066195"><a href="#local-1628066195"><span class="hs-identifier">inert_pred</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#ctPred"><span class="hs-identifier hs-var">ctPred</span></a><span> </span><a href="#local-1628066194"><span class="hs-identifier hs-var">inert_ct</span></a><span>
</span><a name="line-751"></a><span>        </span><a name="local-1628066196"><a href="#local-1628066196"><span class="hs-identifier">inert_loc</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#ctLoc"><span class="hs-identifier hs-var">ctLoc</span></a><span> </span><a href="#local-1628066194"><span class="hs-identifier hs-var">inert_ct</span></a><span>
</span><a name="line-752"></a><span>        </span><a name="local-1628066197"><a href="#local-1628066197"><span class="hs-identifier">derived_loc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628066192"><span class="hs-identifier hs-var">work_loc</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctl_origin</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#FunDepOrigin1"><span class="hs-identifier hs-var">FunDepOrigin1</span></a><span> </span><a href="#local-1628066191"><span class="hs-identifier hs-var">work_pred</span></a><span>  </span><a href="#local-1628066192"><span class="hs-identifier hs-var">work_loc</span></a><span>
</span><a name="line-753"></a><span>                                                            </span><a href="#local-1628066195"><span class="hs-identifier hs-var">inert_pred</span></a><span> </span><a href="#local-1628066196"><span class="hs-identifier hs-var">inert_loc</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-754"></a><span>
</span><a name="line-755"></a><span class="hs-comment">{-
**********************************************************************
*                                                                    *
                   Implicit parameters
*                                                                    *
**********************************************************************
-}</span><span>
</span><a name="line-762"></a><span>
</span><a name="line-763"></a><span class="hs-identifier">interactGivenIP</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span class="hs-special">)</span><span>
</span><a name="line-764"></a><span class="hs-comment">-- Work item is Given (?x:ty)</span><span>
</span><a name="line-765"></a><span class="hs-comment">-- See Note [Shadowing of Implicit Parameters]</span><span>
</span><a name="line-766"></a><a name="interactGivenIP"><a href="TcInteract.html#interactGivenIP"><span class="hs-identifier">interactGivenIP</span></a></a><span> </span><a name="local-1628066198"><a href="#local-1628066198"><span class="hs-identifier">inerts</span></a></a><span> </span><a name="local-1628066199"><a href="#local-1628066199"><span class="hs-identifier">workItem</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TcRnTypes.html#CDictCan"><span class="hs-identifier hs-var">CDictCan</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066200"><a href="#local-1628066200"><span class="hs-identifier">ev</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_class</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066201"><a href="#local-1628066201"><span class="hs-identifier">cls</span></a></a><span>
</span><a name="line-767"></a><span>                                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_tyargs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066202"><a href="#local-1628066202"><span class="hs-identifier">tys</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-1628066203"><a href="#local-1628066203"><span class="hs-identifier">ip_str</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-768"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#updInertCans"><span class="hs-identifier hs-var">updInertCans</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><a name="local-1628066211"><a href="#local-1628066211"><span class="hs-identifier">cans</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628066211"><span class="hs-identifier hs-var">cans</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inert_dicts</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#addDict"><span class="hs-identifier hs-var">addDict</span></a><span> </span><a href="#local-1628066207"><span class="hs-identifier hs-var">filtered_dicts</span></a><span> </span><a href="#local-1628066201"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-1628066202"><span class="hs-identifier hs-var">tys</span></a><span> </span><a href="#local-1628066199"><span class="hs-identifier hs-var">workItem</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-769"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#stopWith"><span class="hs-identifier hs-var">stopWith</span></a><span> </span><a href="#local-1628066200"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-string">&quot;Given IP&quot;</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-770"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-771"></a><span>    </span><a name="local-1628066204"><a href="#local-1628066204"><span class="hs-identifier">dicts</span></a></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">inert_dicts</span><span> </span><a href="#local-1628066198"><span class="hs-identifier hs-var">inerts</span></a><span>
</span><a name="line-772"></a><span>    </span><a name="local-1628066205"><a href="#local-1628066205"><span class="hs-identifier">ip_dicts</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#findDictsByClass"><span class="hs-identifier hs-var">findDictsByClass</span></a><span> </span><a href="#local-1628066204"><span class="hs-identifier hs-var">dicts</span></a><span> </span><a href="#local-1628066201"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-773"></a><span>    </span><a name="local-1628066206"><a href="#local-1628066206"><span class="hs-identifier">other_ip_dicts</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Bag.html#filterBag"><span class="hs-identifier hs-var">filterBag</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="#local-1628066208"><span class="hs-identifier hs-var">is_this_ip</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628066205"><span class="hs-identifier hs-var">ip_dicts</span></a><span>
</span><a name="line-774"></a><span>    </span><a name="local-1628066207"><a href="#local-1628066207"><span class="hs-identifier">filtered_dicts</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#addDictsByClass"><span class="hs-identifier hs-var">addDictsByClass</span></a><span> </span><a href="#local-1628066204"><span class="hs-identifier hs-var">dicts</span></a><span> </span><a href="#local-1628066201"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-1628066206"><span class="hs-identifier hs-var">other_ip_dicts</span></a><span>
</span><a name="line-775"></a><span>
</span><a name="line-776"></a><span>    </span><span class="hs-comment">-- Pick out any Given constraints for the same implicit parameter</span><span>
</span><a name="line-777"></a><span>    </span><a name="local-1628066208"><a href="#local-1628066208"><span class="hs-identifier">is_this_ip</span></a></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#CDictCan"><span class="hs-identifier hs-var">CDictCan</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066209"><a href="#local-1628066209"><span class="hs-identifier">ev</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_tyargs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066210"><a href="#local-1628066210"><span class="hs-identifier">ip_str'</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-778"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#isGiven"><span class="hs-identifier hs-var">isGiven</span></a><span> </span><a href="#local-1628066209"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-1628066203"><span class="hs-identifier hs-var">ip_str</span></a><span> </span><span class="hs-special">`</span><a href="TcType.html#tcEqType"><span class="hs-identifier hs-var">tcEqType</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628066210"><span class="hs-identifier hs-var">ip_str'</span></a><span>
</span><a name="line-779"></a><span>    </span><span class="hs-identifier">is_this_ip</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-780"></a><span>
</span><a name="line-781"></a><span class="hs-identifier">interactGivenIP</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1628066212"><a href="#local-1628066212"><span class="hs-identifier">wi</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;interactGivenIP&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066212"><span class="hs-identifier hs-var">wi</span></a><span class="hs-special">)</span><span>
</span><a name="line-782"></a><span>
</span><a name="line-783"></a><span>
</span><a name="line-784"></a><span class="hs-comment">{-
Note [Shadowing of Implicit Parameters]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider the following example:

f :: (?x :: Char) =&gt; Char
f = let ?x = 'a' in ?x

The &quot;let ?x = ...&quot; generates an implication constraint of the form:

?x :: Char =&gt; ?x :: Char

Furthermore, the signature for `f` also generates an implication
constraint, so we end up with the following nested implication:

?x :: Char =&gt; (?x :: Char =&gt; ?x :: Char)

Note that the wanted (?x :: Char) constraint may be solved in
two incompatible ways:  either by using the parameter from the
signature, or by using the local definition.  Our intention is
that the local definition should &quot;shadow&quot; the parameter of the
signature, and we implement this as follows: when we add a new
*given* implicit parameter to the inert set, it replaces any existing
givens for the same implicit parameter.

This works for the normal cases but it has an odd side effect
in some pathological programs like this:

-- This is accepted, the second parameter shadows
f1 :: (?x :: Int, ?x :: Char) =&gt; Char
f1 = ?x

-- This is rejected, the second parameter shadows
f2 :: (?x :: Int, ?x :: Char) =&gt; Int
f2 = ?x

Both of these are actually wrong:  when we try to use either one,
we'll get two incompatible wnated constraints (?x :: Int, ?x :: Char),
which would lead to an error.

I can think of two ways to fix this:

  1. Simply disallow multiple constratits for the same implicit
    parameter---this is never useful, and it can be detected completely
    syntactically.

  2. Move the shadowing machinery to the location where we nest
     implications, and add some code here that will produce an
     error if we get multiple givens for the same implicit parameter.


**********************************************************************
*                                                                    *
                   interactFunEq
*                                                                    *
**********************************************************************
-}</span><span>
</span><a name="line-841"></a><span>
</span><a name="line-842"></a><span class="hs-identifier">interactFunEq</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span class="hs-special">)</span><span>
</span><a name="line-843"></a><span class="hs-comment">-- Try interacting the work item with the inert set</span><span>
</span><a name="line-844"></a><a name="interactFunEq"><a href="TcInteract.html#interactFunEq"><span class="hs-identifier">interactFunEq</span></a></a><span> </span><a name="local-1628066213"><a href="#local-1628066213"><span class="hs-identifier">inerts</span></a></a><span> </span><a name="local-1628066214"><a href="#local-1628066214"><span class="hs-identifier">workItem</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TcRnTypes.html#CFunEqCan"><span class="hs-identifier hs-var">CFunEqCan</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066215"><a href="#local-1628066215"><span class="hs-identifier">ev</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_fun</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066216"><a href="#local-1628066216"><span class="hs-identifier">tc</span></a></a><span>
</span><a name="line-845"></a><span>                                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_tyargs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066217"><a href="#local-1628066217"><span class="hs-identifier">args</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_fsk</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066218"><a href="#local-1628066218"><span class="hs-identifier">fsk</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-846"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#CFunEqCan"><span class="hs-identifier hs-var">CFunEqCan</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066222"><a href="#local-1628066222"><span class="hs-identifier">ev_i</span></a></a><span>
</span><a name="line-847"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_fsk</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066223"><a href="#local-1628066223"><span class="hs-identifier">fsk_i</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628066221"><span class="hs-identifier hs-var">matching_inerts</span></a><span>
</span><a name="line-848"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-1628066222"><span class="hs-identifier hs-var">ev_i</span></a><span> </span><span class="hs-special">`</span><a href="TcRnTypes.html#funEqCanDischarge"><span class="hs-identifier hs-var">funEqCanDischarge</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628066215"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-849"></a><span>    </span><span class="hs-keyword">then</span><span>  </span><span class="hs-comment">-- Rewrite work-item using inert</span><span>
</span><a name="line-850"></a><span>      </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;reactFunEq (discharge work item):&quot;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-851"></a><span>           </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;workItem =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066214"><span class="hs-identifier hs-var">workItem</span></a><span>
</span><a name="line-852"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;inertItem=&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066222"><span class="hs-identifier hs-var">ev_i</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-853"></a><span>         </span><span class="hs-special">;</span><span> </span><a href="TcInteract.html#reactFunEq"><span class="hs-identifier hs-var">reactFunEq</span></a><span> </span><a href="#local-1628066222"><span class="hs-identifier hs-var">ev_i</span></a><span> </span><a href="#local-1628066223"><span class="hs-identifier hs-var">fsk_i</span></a><span> </span><a href="#local-1628066215"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-1628066218"><span class="hs-identifier hs-var">fsk</span></a><span>
</span><a name="line-854"></a><span>         </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#stopWith"><span class="hs-identifier hs-var">stopWith</span></a><span> </span><a href="#local-1628066215"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-string">&quot;Inert rewrites work item&quot;</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-855"></a><span>    </span><span class="hs-keyword">else</span><span>  </span><span class="hs-comment">-- Rewrite inert using work-item</span><span>
</span><a name="line-856"></a><span>      </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier">funEqCanDischarge</span><span class="hs-special">`</span><span> </span><a href="TcRnTypes.html#funEqCanDischarge"><span class="hs-identifier hs-var">ev_i</span></a><span class="hs-special">,</span><span> </span><a href="TcRnTypes.html#funEqCanDischarge"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="TcRnTypes.html#funEqCanDischarge"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-1628066222"><span class="hs-operator hs-var">$$</span></a><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">ev_i</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-857"></a><span>      </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;reactFunEq (rewrite inert item):&quot;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-858"></a><span>           </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;workItem =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066214"><span class="hs-identifier hs-var">workItem</span></a><span>
</span><a name="line-859"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;inertItem=&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066222"><span class="hs-identifier hs-var">ev_i</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-860"></a><span>         </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#updInertFunEqs"><span class="hs-identifier hs-var">updInertFunEqs</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-1628066224"><a href="#local-1628066224"><span class="hs-identifier">feqs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#insertFunEq"><span class="hs-identifier hs-var">insertFunEq</span></a><span> </span><a href="#local-1628066224"><span class="hs-identifier hs-var">feqs</span></a><span> </span><a href="#local-1628066216"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-1628066217"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-1628066214"><span class="hs-identifier hs-var">workItem</span></a><span>
</span><a name="line-861"></a><span>               </span><span class="hs-comment">-- Do the updInertFunEqs before the reactFunEq, so that</span><span>
</span><a name="line-862"></a><span>               </span><span class="hs-comment">-- we don't kick out the inertItem as well as consuming it!</span><span>
</span><a name="line-863"></a><span>         </span><span class="hs-special">;</span><span> </span><a href="TcInteract.html#reactFunEq"><span class="hs-identifier hs-var">reactFunEq</span></a><span> </span><a href="#local-1628066215"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-1628066218"><span class="hs-identifier hs-var">fsk</span></a><span> </span><a href="#local-1628066222"><span class="hs-identifier hs-var">ev_i</span></a><span> </span><a href="#local-1628066223"><span class="hs-identifier hs-var">fsk_i</span></a><span>
</span><a name="line-864"></a><span>         </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#stopWith"><span class="hs-identifier hs-var">stopWith</span></a><span> </span><a href="#local-1628066215"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-string">&quot;Work item rewrites inert&quot;</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-865"></a><span>
</span><a name="line-866"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>   </span><span class="hs-comment">-- Try improvement</span><span>
</span><a name="line-867"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcInteract.html#improveLocalFunEqs"><span class="hs-identifier hs-var">improveLocalFunEqs</span></a><span> </span><a href="#local-1628066219"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-1628066213"><span class="hs-identifier hs-var">inerts</span></a><span> </span><a href="#local-1628066216"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-1628066217"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-1628066218"><span class="hs-identifier hs-var">fsk</span></a><span>
</span><a name="line-868"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a><span> </span><a href="#local-1628066214"><span class="hs-identifier hs-var">workItem</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-869"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-870"></a><span>    </span><a name="local-1628066219"><a href="#local-1628066219"><span class="hs-identifier">loc</span></a></a><span>             </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a><span> </span><a href="#local-1628066215"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-871"></a><span>    </span><a name="local-1628066220"><a href="#local-1628066220"><span class="hs-identifier">funeqs</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">inert_funeqs</span><span> </span><a href="#local-1628066213"><span class="hs-identifier hs-var">inerts</span></a><span>
</span><a name="line-872"></a><span>    </span><a name="local-1628066221"><a href="#local-1628066221"><span class="hs-identifier">matching_inerts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#findFunEq"><span class="hs-identifier hs-var">findFunEq</span></a><span> </span><a href="#local-1628066220"><span class="hs-identifier hs-var">funeqs</span></a><span> </span><a href="#local-1628066216"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-1628066217"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-873"></a><span>
</span><a name="line-874"></a><span class="hs-identifier">interactFunEq</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1628066225"><a href="#local-1628066225"><span class="hs-identifier">workItem</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;interactFunEq&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066225"><span class="hs-identifier hs-var">workItem</span></a><span class="hs-special">)</span><span>
</span><a name="line-875"></a><span>
</span><a name="line-876"></a><span class="hs-identifier">improveLocalFunEqs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#CtLoc"><span class="hs-identifier hs-type">CtLoc</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a><span>
</span><a name="line-877"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-878"></a><span class="hs-comment">-- Generate derived improvement equalities, by comparing</span><span>
</span><a name="line-879"></a><span class="hs-comment">-- the current work item with inert CFunEqs</span><span>
</span><a name="line-880"></a><span class="hs-comment">-- E.g.   x + y ~ z,   x + y' ~ z   =&gt;   [D] y ~ y'</span><span>
</span><a name="line-881"></a><a name="improveLocalFunEqs"><a href="TcInteract.html#improveLocalFunEqs"><span class="hs-identifier">improveLocalFunEqs</span></a></a><span> </span><a name="local-1628066226"><a href="#local-1628066226"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-1628066227"><a href="#local-1628066227"><span class="hs-identifier">inerts</span></a></a><span> </span><a name="local-1628066228"><a href="#local-1628066228"><span class="hs-identifier">fam_tc</span></a></a><span> </span><a name="local-1628066229"><a href="#local-1628066229"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-1628066230"><a href="#local-1628066230"><span class="hs-identifier">fsk</span></a></a><span>
</span><a name="line-882"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1628066235"><span class="hs-identifier hs-var">improvement_eqns</span></a><span class="hs-special">)</span><span>
</span><a name="line-883"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;interactFunEq improvements: &quot;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-884"></a><span>         </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Eqns:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066235"><span class="hs-identifier hs-var">improvement_eqns</span></a><span>
</span><a name="line-885"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Candidates:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066233"><span class="hs-identifier hs-var">funeqs_for_tc</span></a><span>
</span><a name="line-886"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Model:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066231"><span class="hs-identifier hs-var">model</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-887"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#unifyDerived"><span class="hs-identifier hs-var">unifyDerived</span></a><span> </span><a href="#local-1628066226"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628066235"><span class="hs-identifier hs-var">improvement_eqns</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-888"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-889"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-890"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-891"></a><span>    </span><a name="local-1628066231"><a href="#local-1628066231"><span class="hs-identifier">model</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">inert_model</span><span> </span><a href="#local-1628066227"><span class="hs-identifier hs-var">inerts</span></a><span>
</span><a name="line-892"></a><span>    </span><a name="local-1628066232"><a href="#local-1628066232"><span class="hs-identifier">funeqs</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">inert_funeqs</span><span> </span><a href="#local-1628066227"><span class="hs-identifier hs-var">inerts</span></a><span>
</span><a name="line-893"></a><span>    </span><a name="local-1628066233"><a href="#local-1628066233"><span class="hs-identifier">funeqs_for_tc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#findFunEqsByTyCon"><span class="hs-identifier hs-var">findFunEqsByTyCon</span></a><span> </span><a href="#local-1628066232"><span class="hs-identifier hs-var">funeqs</span></a><span> </span><a href="#local-1628066228"><span class="hs-identifier hs-var">fam_tc</span></a><span>
</span><a name="line-894"></a><span>    </span><a name="local-1628066234"><a href="#local-1628066234"><span class="hs-identifier">rhs</span></a></a><span>           </span><span class="hs-glyph">=</span><span> </span><a href="TcInteract.html#lookupFlattenTyVar"><span class="hs-identifier hs-var">lookupFlattenTyVar</span></a><span> </span><a href="#local-1628066231"><span class="hs-identifier hs-var">model</span></a><span> </span><a href="#local-1628066230"><span class="hs-identifier hs-var">fsk</span></a><span>
</span><a name="line-895"></a><span>
</span><a name="line-896"></a><span>    </span><span class="hs-comment">--------------------</span><span>
</span><a name="line-897"></a><span>    </span><a name="local-1628066235"><a href="#local-1628066235"><span class="hs-identifier">improvement_eqns</span></a></a><span>
</span><a name="line-898"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628066238"><a href="#local-1628066238"><span class="hs-identifier">ops</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TyCon.html#isBuiltInSynFamTyCon_maybe"><span class="hs-identifier hs-var">isBuiltInSynFamTyCon_maybe</span></a><span> </span><a href="#local-1628066228"><span class="hs-identifier hs-var">fam_tc</span></a><span>
</span><a name="line-899"></a><span>      </span><span class="hs-glyph">=</span><span>    </span><span class="hs-comment">-- Try built-in families, notably for arithmethic</span><span>
</span><a name="line-900"></a><span>         </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#concatMap"><span class="hs-identifier hs-var">concatMap</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628066236"><span class="hs-identifier hs-var">do_one_built_in</span></a><span> </span><a href="#local-1628066238"><span class="hs-identifier hs-var">ops</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628066233"><span class="hs-identifier hs-var">funeqs_for_tc</span></a><span>
</span><a name="line-901"></a><span>
</span><a name="line-902"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="TyCon.html#Injective"><span class="hs-identifier hs-var">Injective</span></a><span> </span><a name="local-1628066239"><a href="#local-1628066239"><span class="hs-identifier">injective_args</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TyCon.html#familyTyConInjectivityInfo"><span class="hs-identifier hs-var">familyTyConInjectivityInfo</span></a><span> </span><a href="#local-1628066228"><span class="hs-identifier hs-var">fam_tc</span></a><span>
</span><a name="line-903"></a><span>      </span><span class="hs-glyph">=</span><span>    </span><span class="hs-comment">-- Try improvement from type families with injectivity annotations</span><span>
</span><a name="line-904"></a><span>         </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#concatMap"><span class="hs-identifier hs-var">concatMap</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628066237"><span class="hs-identifier hs-var">do_one_injective</span></a><span> </span><a href="#local-1628066239"><span class="hs-identifier hs-var">injective_args</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628066233"><span class="hs-identifier hs-var">funeqs_for_tc</span></a><span>
</span><a name="line-905"></a><span>
</span><a name="line-906"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-907"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-908"></a><span>
</span><a name="line-909"></a><span>    </span><span class="hs-comment">--------------------</span><span>
</span><a name="line-910"></a><span>    </span><a name="local-1628066236"><a href="#local-1628066236"><span class="hs-identifier">do_one_built_in</span></a></a><span> </span><a name="local-1628066240"><a href="#local-1628066240"><span class="hs-identifier">ops</span></a></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#CFunEqCan"><span class="hs-identifier hs-var">CFunEqCan</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_tyargs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066241"><a href="#local-1628066241"><span class="hs-identifier">iargs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_fsk</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066242"><a href="#local-1628066242"><span class="hs-identifier">ifsk</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-911"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">sfInteractInert</span><span> </span><a href="#local-1628066240"><span class="hs-identifier hs-var">ops</span></a><span> </span><a href="#local-1628066229"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-1628066234"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-1628066241"><span class="hs-identifier hs-var">iargs</span></a><span> </span><span class="hs-special">(</span><a href="TcInteract.html#lookupFlattenTyVar"><span class="hs-identifier hs-var">lookupFlattenTyVar</span></a><span> </span><a href="#local-1628066231"><span class="hs-identifier hs-var">model</span></a><span> </span><a href="#local-1628066242"><span class="hs-identifier hs-var">ifsk</span></a><span class="hs-special">)</span><span>
</span><a name="line-912"></a><span>    </span><span class="hs-identifier">do_one_built_in</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;interactFunEq 1&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066228"><span class="hs-identifier hs-var">fam_tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-913"></a><span>
</span><a name="line-914"></a><span>    </span><span class="hs-comment">--------------------</span><span>
</span><a name="line-915"></a><span>    </span><span class="hs-comment">-- See Note [Type inference for type families with injectivity]</span><span>
</span><a name="line-916"></a><span>    </span><a name="local-1628066237"><a href="#local-1628066237"><span class="hs-identifier">do_one_injective</span></a></a><span> </span><a name="local-1628066243"><a href="#local-1628066243"><span class="hs-identifier">injective_args</span></a></a><span>
</span><a name="line-917"></a><span>                    </span><span class="hs-special">(</span><a href="TcRnTypes.html#CFunEqCan"><span class="hs-identifier hs-var">CFunEqCan</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_tyargs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066244"><a href="#local-1628066244"><span class="hs-identifier">iargs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_fsk</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066245"><a href="#local-1628066245"><span class="hs-identifier">ifsk</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-918"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628066234"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-special">`</span><a href="TcType.html#tcEqType"><span class="hs-identifier hs-var">tcEqType</span></a><span class="hs-special">`</span><span> </span><a href="TcInteract.html#lookupFlattenTyVar"><span class="hs-identifier hs-var">lookupFlattenTyVar</span></a><span> </span><a href="#local-1628066231"><span class="hs-identifier hs-var">model</span></a><span> </span><a href="#local-1628066245"><span class="hs-identifier hs-var">ifsk</span></a><span>
</span><a name="line-919"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a href="#local-1628066246"><span class="hs-identifier hs-var">arg</span></a><span> </span><a href="#local-1628066247"><span class="hs-identifier hs-var">iarg</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-1628066246"><a href="#local-1628066246"><span class="hs-identifier">arg</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628066247"><a href="#local-1628066247"><span class="hs-identifier">iarg</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span>
</span><a name="line-920"></a><span>                           </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zip3"><span class="hs-identifier hs-var">zip3</span></a><span> </span><a href="#local-1628066229"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-1628066244"><span class="hs-identifier hs-var">iargs</span></a><span> </span><a href="#local-1628066243"><span class="hs-identifier hs-var">injective_args</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-921"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-922"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-923"></a><span>    </span><span class="hs-identifier">do_one_injective</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;interactFunEq 2&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066228"><span class="hs-identifier hs-var">fam_tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-924"></a><span>
</span><a name="line-925"></a><span class="hs-comment">-------------</span><span>
</span><a name="line-926"></a><span class="hs-identifier">lookupFlattenTyVar</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#InertModel"><span class="hs-identifier hs-type">InertModel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span>
</span><a name="line-927"></a><span class="hs-comment">-- See Note [lookupFlattenTyVar]</span><span>
</span><a name="line-928"></a><a name="lookupFlattenTyVar"><a href="TcInteract.html#lookupFlattenTyVar"><span class="hs-identifier">lookupFlattenTyVar</span></a></a><span> </span><a name="local-1628066248"><a href="#local-1628066248"><span class="hs-identifier">model</span></a></a><span> </span><a name="local-1628066249"><a href="#local-1628066249"><span class="hs-identifier">ftv</span></a></a><span>
</span><a name="line-929"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="VarEnv.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a><span> </span><a href="#local-1628066248"><span class="hs-identifier hs-var">model</span></a><span> </span><a href="#local-1628066249"><span class="hs-identifier hs-var">ftv</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-930"></a><span>      </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#CTyEqCan"><span class="hs-identifier hs-var">CTyEqCan</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066250"><a href="#local-1628066250"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_eq_rel</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#NomEq"><span class="hs-identifier hs-var">NomEq</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628066250"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-931"></a><span>      </span><span class="hs-identifier">_</span><span>                                                   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a><span> </span><a href="#local-1628066249"><span class="hs-identifier hs-var">ftv</span></a><span>
</span><a name="line-932"></a><span>
</span><a name="line-933"></a><span class="hs-identifier">reactFunEq</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a><span>    </span><span class="hs-comment">-- From this  :: F args1 ~ fsk1</span><span>
</span><a name="line-934"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a><span>    </span><span class="hs-comment">-- Solve this :: F args2 ~ fsk2</span><span>
</span><a name="line-935"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-936"></a><a name="reactFunEq"><a href="TcInteract.html#reactFunEq"><span class="hs-identifier">reactFunEq</span></a></a><span> </span><a name="local-1628066251"><a href="#local-1628066251"><span class="hs-identifier">from_this</span></a></a><span> </span><a name="local-1628066252"><a href="#local-1628066252"><span class="hs-identifier">fsk1</span></a></a><span> </span><a name="local-1628066253"><a href="#local-1628066253"><span class="hs-identifier">solve_this</span></a></a><span> </span><a name="local-1628066254"><a href="#local-1628066254"><span class="hs-identifier">fsk2</span></a></a><span>
</span><a name="line-937"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TcRnTypes.html#CtGiven"><span class="hs-identifier hs-var">CtGiven</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctev_evar</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066255"><a href="#local-1628066255"><span class="hs-identifier">evar</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ctev_loc</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066256"><a href="#local-1628066256"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628066253"><span class="hs-identifier hs-var">solve_this</span></a><span>
</span><a name="line-938"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628066257"><a href="#local-1628066257"><span class="hs-identifier">fsk_eq_co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcEvidence.html#mkTcSymCo"><span class="hs-identifier hs-var">mkTcSymCo</span></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#mkTcCoVarCo"><span class="hs-identifier hs-var">mkTcCoVarCo</span></a><span> </span><a href="#local-1628066255"><span class="hs-identifier hs-var">evar</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="TcEvidence.html#mkTcTransCo"><span class="hs-identifier hs-var">mkTcTransCo</span></a><span class="hs-special">`</span><span>
</span><a name="line-939"></a><span>                         </span><a href="TcRnTypes.html#ctEvCoercion"><span class="hs-identifier hs-var">ctEvCoercion</span></a><span> </span><a href="#local-1628066251"><span class="hs-identifier hs-var">from_this</span></a><span>
</span><a name="line-940"></a><span>                         </span><span class="hs-comment">-- :: fsk2 ~ fsk1</span><span>
</span><a name="line-941"></a><span>             </span><a name="local-1628066258"><a href="#local-1628066258"><span class="hs-identifier">fsk_eq_pred</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#mkTcEqPredLikeEv"><span class="hs-identifier hs-var">mkTcEqPredLikeEv</span></a><span> </span><a href="#local-1628066253"><span class="hs-identifier hs-var">solve_this</span></a><span>
</span><a name="line-942"></a><span>                             </span><span class="hs-special">(</span><a href="TyCoRep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a><span> </span><a href="#local-1628066254"><span class="hs-identifier hs-var">fsk2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a><span> </span><a href="#local-1628066252"><span class="hs-identifier hs-var">fsk1</span></a><span class="hs-special">)</span><span>
</span><a name="line-943"></a><span>
</span><a name="line-944"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628066259"><a href="#local-1628066259"><span class="hs-identifier">new_ev</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#newGivenEvVar"><span class="hs-identifier hs-var">newGivenEvVar</span></a><span> </span><a href="#local-1628066256"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628066258"><span class="hs-identifier hs-var">fsk_eq_pred</span></a><span class="hs-special">,</span><span> </span><a href="TcEvidence.html#EvCoercion"><span class="hs-identifier hs-var">EvCoercion</span></a><span> </span><a href="#local-1628066257"><span class="hs-identifier hs-var">fsk_eq_co</span></a><span class="hs-special">)</span><span>
</span><a name="line-945"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#emitWorkNC"><span class="hs-identifier hs-var">emitWorkNC</span></a><span> </span><span class="hs-special">[</span><a href="#local-1628066259"><span class="hs-identifier hs-var">new_ev</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-946"></a><span>
</span><a name="line-947"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-948"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;reactFunEq&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066251"><span class="hs-identifier hs-var">from_this</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066252"><span class="hs-identifier hs-var">fsk1</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>
</span><a name="line-949"></a><span>                                </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066253"><span class="hs-identifier hs-var">solve_this</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066254"><span class="hs-identifier hs-var">fsk2</span></a><span class="hs-special">)</span><span>
</span><a name="line-950"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcInteract.html#dischargeFmv"><span class="hs-identifier hs-var">dischargeFmv</span></a><span> </span><a href="#local-1628066253"><span class="hs-identifier hs-var">solve_this</span></a><span> </span><a href="#local-1628066254"><span class="hs-identifier hs-var">fsk2</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#ctEvCoercion"><span class="hs-identifier hs-var">ctEvCoercion</span></a><span> </span><a href="#local-1628066251"><span class="hs-identifier hs-var">from_this</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a><span> </span><a href="#local-1628066252"><span class="hs-identifier hs-var">fsk1</span></a><span class="hs-special">)</span><span>
</span><a name="line-951"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;reactFunEq done&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066251"><span class="hs-identifier hs-var">from_this</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066252"><span class="hs-identifier hs-var">fsk1</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>
</span><a name="line-952"></a><span>                                     </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066253"><span class="hs-identifier hs-var">solve_this</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066254"><span class="hs-identifier hs-var">fsk2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-953"></a><span>
</span><a name="line-954"></a><span class="hs-comment">{- Note [lookupFlattenTyVar]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Supppose we have an injective function F and
  inert_funeqs:   F t1 ~ fsk1
                  F t2 ~ fsk2
  model           fsk1 ~ fsk2

We never rewrite the RHS (cc_fsk) of a CFunEqCan.  But we /do/ want to
get the [D] t1 ~ t2 from the injectiveness of F.  So we look up the
cc_fsk of CFunEqCans in the model when trying to find derived
equalities arising from injectivity.

Note [Type inference for type families with injectivity]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have a type family with an injectivity annotation:
    type family F a b = r | r -&gt; b

Then if we have two CFunEqCan constraints for F with the same RHS
   F s1 t1 ~ rhs
   F s2 t2 ~ rhs
then we can use the injectivity to get a new Derived constraint on
the injective argument
  [D] t1 ~ t2

That in turn can help GHC solve constraints that would otherwise require
guessing.  For example, consider the ambiguity check for
   f :: F Int b -&gt; Int
We get the constraint
   [W] F Int b ~ F Int beta
where beta is a unification variable.  Injectivity lets us pick beta ~ b.

Injectivity information is also used at the call sites. For example:
   g = f True
gives rise to
   [W] F Int b ~ Bool
from which we can derive b.  This requires looking at the defining equations of
a type family, ie. finding equation with a matching RHS (Bool in this example)
and infering values of type variables (b in this example) from the LHS patterns
of the matching equation.  For closed type families we have to perform
additional apartness check for the selected equation to check that the selected
is guaranteed to fire for given LHS arguments.

These new constraints are simply *Derived* constraints; they have no evidence.
We could go further and offer evidence from decomposing injective type-function
applications, but that would require new evidence forms, and an extension to
FC, so we don't do that right now (Dec 14).

See also Note [Injective type families] in TyCon


Note [Cache-caused loops]
~~~~~~~~~~~~~~~~~~~~~~~~~
It is very dangerous to cache a rewritten wanted family equation as 'solved' in our
solved cache (which is the default behaviour or xCtEvidence), because the interaction
may not be contributing towards a solution. Here is an example:

Initial inert set:
  [W] g1 : F a ~ beta1
Work item:
  [W] g2 : F a ~ beta2
The work item will react with the inert yielding the _same_ inert set plus:
    i)   Will set g2 := g1 `cast` g3
    ii)  Will add to our solved cache that [S] g2 : F a ~ beta2
    iii) Will emit [W] g3 : beta1 ~ beta2
Now, the g3 work item will be spontaneously solved to [G] g3 : beta1 ~ beta2
and then it will react the item in the inert ([W] g1 : F a ~ beta1). So it
will set
      g1 := g ; sym g3
and what is g? Well it would ideally be a new goal of type (F a ~ beta2) but
remember that we have this in our solved cache, and it is ... g2! In short we
created the evidence loop:

        g2 := g1 ; g3
        g3 := refl
        g1 := g2 ; sym g3

To avoid this situation we do not cache as solved any workitems (or inert)
which did not really made a 'step' towards proving some goal. Solved's are
just an optimization so we don't lose anything in terms of completeness of
solving.


Note [Efficient Orientation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we are interacting two FunEqCans with the same LHS:
          (inert)  ci :: (F ty ~ xi_i)
          (work)   cw :: (F ty ~ xi_w)
We prefer to keep the inert (else we pass the work item on down
the pipeline, which is a bit silly).  If we keep the inert, we
will (a) discharge 'cw'
     (b) produce a new equality work-item (xi_w ~ xi_i)
Notice the orientation (xi_w ~ xi_i) NOT (xi_i ~ xi_w):
    new_work :: xi_w ~ xi_i
    cw := ci ; sym new_work
Why?  Consider the simplest case when xi1 is a type variable.  If
we generate xi1~xi2, porcessing that constraint will kick out 'ci'.
If we generate xi2~xi1, there is less chance of that happening.
Of course it can and should still happen if xi1=a, xi1=Int, say.
But we want to avoid it happening needlessly.

Similarly, if we *can't* keep the inert item (because inert is Wanted,
and work is Given, say), we prefer to orient the new equality (xi_i ~
xi_w).

Note [Carefully solve the right CFunEqCan]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   ---- OLD COMMENT, NOW NOT NEEDED
   ---- because we now allow multiple
   ---- wanted FunEqs with the same head
Consider the constraints
  c1 :: F Int ~ a      -- Arising from an application line 5
  c2 :: F Int ~ Bool   -- Arising from an application line 10
Suppose that 'a' is a unification variable, arising only from
flattening.  So there is no error on line 5; it's just a flattening
variable.  But there is (or might be) an error on line 10.

Two ways to combine them, leaving either (Plan A)
  c1 :: F Int ~ a      -- Arising from an application line 5
  c3 :: a ~ Bool       -- Arising from an application line 10
or (Plan B)
  c2 :: F Int ~ Bool   -- Arising from an application line 10
  c4 :: a ~ Bool       -- Arising from an application line 5

Plan A will unify c3, leaving c1 :: F Int ~ Bool as an error
on the *totally innocent* line 5.  An example is test SimpleFail16
where the expected/actual message comes out backwards if we use
the wrong plan.

The second is the right thing to do.  Hence the isMetaTyVarTy
test when solving pairwise CFunEqCan.


**********************************************************************
*                                                                    *
                   interactTyVarEq
*                                                                    *
**********************************************************************
-}</span><span>
</span><a name="line-1092"></a><span>
</span><a name="line-1093"></a><span class="hs-identifier">interactTyVarEq</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span class="hs-special">)</span><span>
</span><a name="line-1094"></a><span class="hs-comment">-- CTyEqCans are always consumed, so always returns Stop</span><span>
</span><a name="line-1095"></a><a name="interactTyVarEq"><a href="TcInteract.html#interactTyVarEq"><span class="hs-identifier">interactTyVarEq</span></a></a><span> </span><a name="local-1628066260"><a href="#local-1628066260"><span class="hs-identifier">inerts</span></a></a><span> </span><a name="local-1628066261"><a href="#local-1628066261"><span class="hs-identifier">workItem</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TcRnTypes.html#CTyEqCan"><span class="hs-identifier hs-var">CTyEqCan</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_tyvar</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066262"><a href="#local-1628066262"><span class="hs-identifier">tv</span></a></a><span>
</span><a name="line-1096"></a><span>                                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066263"><a href="#local-1628066263"><span class="hs-identifier">rhs</span></a></a><span>
</span><a name="line-1097"></a><span>                                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066264"><a href="#local-1628066264"><span class="hs-identifier">ev</span></a></a><span>
</span><a name="line-1098"></a><span>                                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_eq_rel</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066265"><a href="#local-1628066265"><span class="hs-identifier">eq_rel</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1099"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-1628066268"><a href="#local-1628066268"><span class="hs-identifier">ev_i</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-1628066266"><span class="hs-identifier hs-var">ev_i</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="TcRnTypes.html#CTyEqCan"><span class="hs-identifier hs-var">CTyEqCan</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066266"><a href="#local-1628066266"><span class="hs-identifier">ev_i</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066267"><a href="#local-1628066267"><span class="hs-identifier">rhs_i</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1100"></a><span>                             </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#findTyEqs"><span class="hs-identifier hs-var">findTyEqs</span></a><span> </span><a href="#local-1628066260"><span class="hs-identifier hs-var">inerts</span></a><span> </span><a href="#local-1628066262"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-1101"></a><span>                         </span><span class="hs-special">,</span><span> </span><a href="#local-1628066266"><span class="hs-identifier hs-var">ev_i</span></a><span> </span><span class="hs-special">`</span><a href="TcRnTypes.html#eqCanDischarge"><span class="hs-identifier hs-var">eqCanDischarge</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628066264"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-1102"></a><span>                         </span><span class="hs-special">,</span><span> </span><a href="#local-1628066267"><span class="hs-identifier hs-var">rhs_i</span></a><span> </span><span class="hs-special">`</span><a href="TcType.html#tcEqType"><span class="hs-identifier hs-var">tcEqType</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628066263"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1103"></a><span>  </span><span class="hs-glyph">=</span><span>  </span><span class="hs-comment">-- Inert:     a ~ ty</span><span>
</span><a name="line-1104"></a><span>     </span><span class="hs-comment">-- Work item: a ~ ty</span><span>
</span><a name="line-1105"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#setEvBindIfWanted"><span class="hs-identifier hs-var">setEvBindIfWanted</span></a><span> </span><a href="#local-1628066264"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1106"></a><span>          </span><a href="TcEvidence.html#EvCoercion"><span class="hs-identifier hs-var">EvCoercion</span></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#tcDowngradeRole"><span class="hs-identifier hs-var">tcDowngradeRole</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#eqRelRole"><span class="hs-identifier hs-var">eqRelRole</span></a><span> </span><a href="#local-1628066265"><span class="hs-identifier hs-var">eq_rel</span></a><span class="hs-special">)</span><span>
</span><a name="line-1107"></a><span>                                      </span><span class="hs-special">(</span><a href="TcRnTypes.html#ctEvRole"><span class="hs-identifier hs-var">ctEvRole</span></a><span> </span><a href="#local-1628066268"><span class="hs-identifier hs-var">ev_i</span></a><span class="hs-special">)</span><span>
</span><a name="line-1108"></a><span>                                      </span><span class="hs-special">(</span><a href="TcRnTypes.html#ctEvCoercion"><span class="hs-identifier hs-var">ctEvCoercion</span></a><span> </span><a href="#local-1628066268"><span class="hs-identifier hs-var">ev_i</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1109"></a><span>
</span><a name="line-1110"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#stopWith"><span class="hs-identifier hs-var">stopWith</span></a><span> </span><a href="#local-1628066264"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-string">&quot;Solved from inert&quot;</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1111"></a><span>
</span><a name="line-1112"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628066269"><a href="#local-1628066269"><span class="hs-identifier">tv_rhs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#getTyVar_maybe"><span class="hs-identifier hs-var">getTyVar_maybe</span></a><span> </span><a href="#local-1628066263"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-1113"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-1628066272"><a href="#local-1628066272"><span class="hs-identifier">ev_i</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-1628066270"><span class="hs-identifier hs-var">ev_i</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="TcRnTypes.html#CTyEqCan"><span class="hs-identifier hs-var">CTyEqCan</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066270"><a href="#local-1628066270"><span class="hs-identifier">ev_i</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066271"><a href="#local-1628066271"><span class="hs-identifier">rhs_i</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1114"></a><span>                             </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#findTyEqs"><span class="hs-identifier hs-var">findTyEqs</span></a><span> </span><a href="#local-1628066260"><span class="hs-identifier hs-var">inerts</span></a><span> </span><a href="#local-1628066269"><span class="hs-identifier hs-var">tv_rhs</span></a><span>
</span><a name="line-1115"></a><span>                         </span><span class="hs-special">,</span><span> </span><a href="#local-1628066270"><span class="hs-identifier hs-var">ev_i</span></a><span> </span><span class="hs-special">`</span><a href="TcRnTypes.html#eqCanDischarge"><span class="hs-identifier hs-var">eqCanDischarge</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628066264"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-1116"></a><span>                         </span><span class="hs-special">,</span><span> </span><a href="#local-1628066271"><span class="hs-identifier hs-var">rhs_i</span></a><span> </span><span class="hs-special">`</span><a href="TcType.html#tcEqType"><span class="hs-identifier hs-var">tcEqType</span></a><span class="hs-special">`</span><span> </span><a href="TyCoRep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a><span> </span><a href="#local-1628066262"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1117"></a><span>  </span><span class="hs-glyph">=</span><span>  </span><span class="hs-comment">-- Inert:     a ~ b</span><span>
</span><a name="line-1118"></a><span>     </span><span class="hs-comment">-- Work item: b ~ a</span><span>
</span><a name="line-1119"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#setEvBindIfWanted"><span class="hs-identifier hs-var">setEvBindIfWanted</span></a><span> </span><a href="#local-1628066264"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1120"></a><span>           </span><a href="TcEvidence.html#EvCoercion"><span class="hs-identifier hs-var">EvCoercion</span></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#mkTcSymCo"><span class="hs-identifier hs-var">mkTcSymCo</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1121"></a><span>                       </span><a href="TcEvidence.html#tcDowngradeRole"><span class="hs-identifier hs-var">tcDowngradeRole</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#eqRelRole"><span class="hs-identifier hs-var">eqRelRole</span></a><span> </span><a href="#local-1628066265"><span class="hs-identifier hs-var">eq_rel</span></a><span class="hs-special">)</span><span>
</span><a name="line-1122"></a><span>                                       </span><span class="hs-special">(</span><a href="TcRnTypes.html#ctEvRole"><span class="hs-identifier hs-var">ctEvRole</span></a><span> </span><a href="#local-1628066272"><span class="hs-identifier hs-var">ev_i</span></a><span class="hs-special">)</span><span>
</span><a name="line-1123"></a><span>                                       </span><span class="hs-special">(</span><a href="TcRnTypes.html#ctEvCoercion"><span class="hs-identifier hs-var">ctEvCoercion</span></a><span> </span><a href="#local-1628066272"><span class="hs-identifier hs-var">ev_i</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1124"></a><span>
</span><a name="line-1125"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#stopWith"><span class="hs-identifier hs-var">stopWith</span></a><span> </span><a href="#local-1628066264"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-string">&quot;Solved from inert (r)&quot;</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1126"></a><span>
</span><a name="line-1127"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1128"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628066273"><a href="#local-1628066273"><span class="hs-identifier">tclvl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getTcLevel"><span class="hs-identifier hs-var">getTcLevel</span></a><span>
</span><a name="line-1129"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="TcInteract.html#canSolveByUnification"><span class="hs-identifier hs-var">canSolveByUnification</span></a><span> </span><a href="#local-1628066273"><span class="hs-identifier hs-var">tclvl</span></a><span> </span><a href="#local-1628066264"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-1628066265"><span class="hs-identifier hs-var">eq_rel</span></a><span> </span><a href="#local-1628066262"><span class="hs-identifier hs-var">tv</span></a><span> </span><a href="#local-1628066263"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-1130"></a><span>         </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcInteract.html#solveByUnification"><span class="hs-identifier hs-var">solveByUnification</span></a><span> </span><a href="#local-1628066264"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-1628066262"><span class="hs-identifier hs-var">tv</span></a><span> </span><a href="#local-1628066263"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-1131"></a><span>                 </span><span class="hs-special">;</span><span> </span><a name="local-1628066274"><a href="#local-1628066274"><span class="hs-identifier">n_kicked</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#kickOutAfterUnification"><span class="hs-identifier hs-var">kickOutAfterUnification</span></a><span> </span><a href="#local-1628066262"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-1132"></a><span>                 </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><a href="#local-1628066264"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Solved by unification&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="TcInteract.html#ppr_kicked"><span class="hs-identifier hs-var">ppr_kicked</span></a><span> </span><a href="#local-1628066274"><span class="hs-identifier hs-var">n_kicked</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1133"></a><span>
</span><a name="line-1134"></a><span>         </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;Can't solve tyvar equality&quot;</span><span>
</span><a name="line-1135"></a><span>                       </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;LHS:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066262"><span class="hs-identifier hs-var">tv</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#dcolon"><span class="hs-identifier hs-var">dcolon</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a><span> </span><a href="#local-1628066262"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span>
</span><a name="line-1136"></a><span>                             </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppWhen"><span class="hs-identifier hs-var">ppWhen</span></a><span> </span><span class="hs-special">(</span><a href="TcType.html#isMetaTyVar"><span class="hs-identifier hs-var">isMetaTyVar</span></a><span> </span><a href="#local-1628066262"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1137"></a><span>                               </span><a href="Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a><span> </span><span class="hs-number">4</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;TcLevel of&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066262"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-1138"></a><span>                                       </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;is&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="TcType.html#metaTyVarTcLevel"><span class="hs-identifier hs-var">metaTyVarTcLevel</span></a><span> </span><a href="#local-1628066262"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1139"></a><span>                             </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;RHS:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066263"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#dcolon"><span class="hs-identifier hs-var">dcolon</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a><span> </span><a href="#local-1628066263"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1140"></a><span>                             </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;TcLevel =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066273"><span class="hs-identifier hs-var">tclvl</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1141"></a><span>                 </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#addInertEq"><span class="hs-identifier hs-var">addInertEq</span></a><span> </span><a href="#local-1628066261"><span class="hs-identifier hs-var">workItem</span></a><span>
</span><a name="line-1142"></a><span>                 </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><a href="#local-1628066264"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Kept as inert&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1143"></a><span>
</span><a name="line-1144"></a><span class="hs-identifier">interactTyVarEq</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1628066275"><a href="#local-1628066275"><span class="hs-identifier">wi</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;interactTyVarEq&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066275"><span class="hs-identifier hs-var">wi</span></a><span class="hs-special">)</span><span>
</span><a name="line-1145"></a><span>
</span><a name="line-1146"></a><span class="hs-comment">-- @trySpontaneousSolve wi@ solves equalities where one side is a</span><span>
</span><a name="line-1147"></a><span class="hs-comment">-- touchable unification variable.</span><span>
</span><a name="line-1148"></a><span class="hs-comment">-- Returns True &lt;=&gt; spontaneous solve happened</span><span>
</span><a name="line-1149"></a><span class="hs-identifier">canSolveByUnification</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#TcLevel"><span class="hs-identifier hs-type">TcLevel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Type.html#EqRel"><span class="hs-identifier hs-type">EqRel</span></a><span>
</span><a name="line-1150"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#Xi"><span class="hs-identifier hs-type">Xi</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1151"></a><a name="canSolveByUnification"><a href="TcInteract.html#canSolveByUnification"><span class="hs-identifier">canSolveByUnification</span></a></a><span> </span><a name="local-1628066276"><a href="#local-1628066276"><span class="hs-identifier">tclvl</span></a></a><span> </span><a name="local-1628066277"><a href="#local-1628066277"><span class="hs-identifier">gw</span></a></a><span> </span><a name="local-1628066278"><a href="#local-1628066278"><span class="hs-identifier">eq_rel</span></a></a><span> </span><a name="local-1628066279"><a href="#local-1628066279"><span class="hs-identifier">tv</span></a></a><span> </span><a name="local-1628066280"><a href="#local-1628066280"><span class="hs-identifier">xi</span></a></a><span>
</span><a name="line-1152"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Type.html#ReprEq"><span class="hs-identifier hs-var">ReprEq</span></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628066278"><span class="hs-identifier hs-var">eq_rel</span></a><span>   </span><span class="hs-comment">-- we never solve representational equalities this way.</span><span>
</span><a name="line-1153"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1154"></a><span>
</span><a name="line-1155"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TcRnTypes.html#isGiven"><span class="hs-identifier hs-var">isGiven</span></a><span> </span><a href="#local-1628066277"><span class="hs-identifier hs-var">gw</span></a><span>   </span><span class="hs-comment">-- See Note [Touchables and givens]</span><span>
</span><a name="line-1156"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1157"></a><span>
</span><a name="line-1158"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TcType.html#isTouchableMetaTyVar"><span class="hs-identifier hs-var">isTouchableMetaTyVar</span></a><span> </span><a href="#local-1628066276"><span class="hs-identifier hs-var">tclvl</span></a><span> </span><a href="#local-1628066279"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-1159"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="TcType.html#metaTyVarInfo"><span class="hs-identifier hs-var">metaTyVarInfo</span></a><span> </span><a href="#local-1628066279"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1160"></a><span>      </span><a href="TcType.html#SigTv"><span class="hs-identifier hs-var">SigTv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628066281"><span class="hs-identifier hs-var">is_tyvar</span></a><span> </span><a href="#local-1628066280"><span class="hs-identifier hs-var">xi</span></a><span>
</span><a name="line-1161"></a><span>      </span><span class="hs-identifier">_</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1162"></a><span>
</span><a name="line-1163"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>    </span><span class="hs-comment">-- Untouchable</span><span>
</span><a name="line-1164"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1165"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1166"></a><span>    </span><a name="local-1628066281"><a href="#local-1628066281"><span class="hs-identifier">is_tyvar</span></a></a><span> </span><a name="local-1628066282"><a href="#local-1628066282"><span class="hs-identifier">xi</span></a></a><span>
</span><a name="line-1167"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="TcType.html#tcGetTyVar_maybe"><span class="hs-identifier hs-var">tcGetTyVar_maybe</span></a><span> </span><a href="#local-1628066282"><span class="hs-identifier hs-var">xi</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1168"></a><span>          </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1169"></a><span>          </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628066283"><a href="#local-1628066283"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Var.html#tcTyVarDetails"><span class="hs-identifier hs-var">tcTyVarDetails</span></a><span> </span><a href="#local-1628066283"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1170"></a><span>                       </span><a href="TcType.html#MetaTv"><span class="hs-identifier hs-var">MetaTv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mtv_info</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066284"><a href="#local-1628066284"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1171"></a><span>                                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628066284"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1172"></a><span>                                        </span><a href="TcType.html#SigTv"><span class="hs-identifier hs-var">SigTv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1173"></a><span>                                        </span><span class="hs-identifier">_</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1174"></a><span>                       </span><a href="TcType.html#SkolemTv"><span class="hs-identifier hs-var">SkolemTv</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1175"></a><span>                       </span><a href="TcType.html#FlatSkol"><span class="hs-identifier hs-var">FlatSkol</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1176"></a><span>                       </span><a href="TcType.html#RuntimeUnk"><span class="hs-identifier hs-var">RuntimeUnk</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1177"></a><span>
</span><a name="line-1178"></a><span class="hs-identifier">solveByUnification</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#Xi"><span class="hs-identifier hs-type">Xi</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1179"></a><span class="hs-comment">-- Solve with the identity coercion</span><span>
</span><a name="line-1180"></a><span class="hs-comment">-- Precondition: kind(xi) equals kind(tv)</span><span>
</span><a name="line-1181"></a><span class="hs-comment">-- Precondition: CtEvidence is Wanted or Derived</span><span>
</span><a name="line-1182"></a><span class="hs-comment">-- Precondition: CtEvidence is nominal</span><span>
</span><a name="line-1183"></a><span class="hs-comment">-- Returns: workItem where</span><span>
</span><a name="line-1184"></a><span class="hs-comment">--        workItem = the new Given constraint</span><span>
</span><a name="line-1185"></a><span class="hs-comment">--</span><span>
</span><a name="line-1186"></a><span class="hs-comment">-- NB: No need for an occurs check here, because solveByUnification always</span><span>
</span><a name="line-1187"></a><span class="hs-comment">--     arises from a CTyEqCan, a *canonical* constraint.  Its invariants</span><span>
</span><a name="line-1188"></a><span class="hs-comment">--     say that in (a ~ xi), the type variable a does not appear in xi.</span><span>
</span><a name="line-1189"></a><span class="hs-comment">--     See TcRnTypes.Ct invariants.</span><span>
</span><a name="line-1190"></a><span class="hs-comment">--</span><span>
</span><a name="line-1191"></a><span class="hs-comment">-- Post: tv is unified (by side effect) with xi;</span><span>
</span><a name="line-1192"></a><span class="hs-comment">--       we often write tv := xi</span><span>
</span><a name="line-1193"></a><a name="solveByUnification"><a href="TcInteract.html#solveByUnification"><span class="hs-identifier">solveByUnification</span></a></a><span> </span><a name="local-1628066285"><a href="#local-1628066285"><span class="hs-identifier">wd</span></a></a><span> </span><a name="local-1628066286"><a href="#local-1628066286"><span class="hs-identifier">tv</span></a></a><span> </span><a name="local-1628066287"><a href="#local-1628066287"><span class="hs-identifier">xi</span></a></a><span>
</span><a name="line-1194"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628066288"><a href="#local-1628066288"><span class="hs-identifier">tv_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a><span> </span><a href="#local-1628066286"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-1195"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;Sneaky unification:&quot;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1196"></a><span>                       </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Unifies:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066286"><span class="hs-identifier hs-var">tv</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;:=&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066287"><span class="hs-identifier hs-var">xi</span></a><span class="hs-special">,</span><span>
</span><a name="line-1197"></a><span>                             </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Coercion:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="TcSMonad.html#pprEq"><span class="hs-identifier hs-var">pprEq</span></a><span> </span><a href="#local-1628066288"><span class="hs-identifier hs-var">tv_ty</span></a><span> </span><a href="#local-1628066287"><span class="hs-identifier hs-var">xi</span></a><span class="hs-special">,</span><span>
</span><a name="line-1198"></a><span>                             </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Left Kind is:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a><span> </span><a href="#local-1628066288"><span class="hs-identifier hs-var">tv_ty</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1199"></a><span>                             </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Right Kind is:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a><span> </span><a href="#local-1628066287"><span class="hs-identifier hs-var">xi</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1200"></a><span>
</span><a name="line-1201"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#unifyTyVar"><span class="hs-identifier hs-var">unifyTyVar</span></a><span> </span><a href="#local-1628066286"><span class="hs-identifier hs-var">tv</span></a><span> </span><a href="#local-1628066287"><span class="hs-identifier hs-var">xi</span></a><span>
</span><a name="line-1202"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#setEvBindIfWanted"><span class="hs-identifier hs-var">setEvBindIfWanted</span></a><span> </span><a href="#local-1628066285"><span class="hs-identifier hs-var">wd</span></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#EvCoercion"><span class="hs-identifier hs-var">EvCoercion</span></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#mkTcNomReflCo"><span class="hs-identifier hs-var">mkTcNomReflCo</span></a><span> </span><a href="#local-1628066287"><span class="hs-identifier hs-var">xi</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1203"></a><span>
</span><a name="line-1204"></a><span class="hs-identifier">ppr_kicked</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-1205"></a><a name="ppr_kicked"><a href="TcInteract.html#ppr_kicked"><span class="hs-identifier">ppr_kicked</span></a></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-1206"></a><span class="hs-identifier">ppr_kicked</span><span> </span><a name="local-1628066289"><a href="#local-1628066289"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#int"><span class="hs-identifier hs-var">int</span></a><span> </span><a href="#local-1628066289"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;kicked out&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1207"></a><span>
</span><a name="line-1208"></a><span class="hs-comment">{- Note [Avoid double unifications]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The spontaneous solver has to return a given which mentions the unified unification
variable *on the left* of the equality. Here is what happens if not:
  Original wanted:  (a ~ alpha),  (alpha ~ Int)
We spontaneously solve the first wanted, without changing the order!
      given : a ~ alpha      [having unified alpha := a]
Now the second wanted comes along, but he cannot rewrite the given, so we simply continue.
At the end we spontaneously solve that guy, *reunifying*  [alpha := Int]

We avoid this problem by orienting the resulting given so that the unification
variable is on the left.  [Note that alternatively we could attempt to
enforce this at canonicalization]

See also Note [No touchables as FunEq RHS] in TcSMonad; avoiding
double unifications is the main reason we disallow touchable
unification variables as RHS of type family equations: F xis ~ alpha.


************************************************************************
*                                                                      *
*          Functional dependencies, instantiation of equations
*                                                                      *
************************************************************************

When we spot an equality arising from a functional dependency,
we now use that equality (a &quot;wanted&quot;) to rewrite the work-item
constraint right away.  This avoids two dangers

 Danger 1: If we send the original constraint on down the pipeline
           it may react with an instance declaration, and in delicate
           situations (when a Given overlaps with an instance) that
           may produce new insoluble goals: see Trac #4952

 Danger 2: If we don't rewrite the constraint, it may re-react
           with the same thing later, and produce the same equality
           again --&gt; termination worries.

To achieve this required some refactoring of FunDeps.hs (nicer
now!).
-}</span><span>
</span><a name="line-1249"></a><span>
</span><a name="line-1250"></a><span class="hs-identifier">emitFunDepDeriveds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="FunDeps.html#FunDepEqn"><span class="hs-identifier hs-type">FunDepEqn</span></a><span> </span><a href="TcRnTypes.html#CtLoc"><span class="hs-identifier hs-type">CtLoc</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1251"></a><a name="emitFunDepDeriveds"><a href="TcInteract.html#emitFunDepDeriveds"><span class="hs-identifier">emitFunDepDeriveds</span></a></a><span> </span><a name="local-1628066290"><a href="#local-1628066290"><span class="hs-identifier">fd_eqns</span></a></a><span>
</span><a name="line-1252"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><a href="#local-1628066291"><span class="hs-identifier hs-var">do_one_FDEqn</span></a><span> </span><a href="#local-1628066290"><span class="hs-identifier hs-var">fd_eqns</span></a><span>
</span><a name="line-1253"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1254"></a><span>    </span><a name="local-1628066291"><a href="#local-1628066291"><span class="hs-identifier">do_one_FDEqn</span></a></a><span> </span><span class="hs-special">(</span><a href="FunDeps.html#FDEqn"><span class="hs-identifier hs-var">FDEqn</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fd_qtvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066293"><a href="#local-1628066293"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">fd_eqs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066294"><a href="#local-1628066294"><span class="hs-identifier">eqs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">fd_loc</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066295"><a href="#local-1628066295"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1255"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1628066293"><span class="hs-identifier hs-var">tvs</span></a><span>  </span><span class="hs-comment">-- Common shortcut</span><span>
</span><a name="line-1256"></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#unifyDerived"><span class="hs-identifier hs-var">unifyDerived</span></a><span> </span><a href="#local-1628066295"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628066294"><span class="hs-identifier hs-var">eqs</span></a><span>
</span><a name="line-1257"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1258"></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-1628066296"><a href="#local-1628066296"><span class="hs-identifier">subst</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#instFlexiTcS"><span class="hs-identifier hs-var">instFlexiTcS</span></a><span> </span><a href="#local-1628066293"><span class="hs-identifier hs-var">tvs</span></a><span>  </span><span class="hs-comment">-- Takes account of kind substitution</span><span>
</span><a name="line-1259"></a><span>          </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628066292"><span class="hs-identifier hs-var">do_one_eq</span></a><span> </span><a href="#local-1628066295"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-1628066296"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628066294"><span class="hs-identifier hs-var">eqs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1260"></a><span>
</span><a name="line-1261"></a><span>    </span><a name="local-1628066292"><a href="#local-1628066292"><span class="hs-identifier">do_one_eq</span></a></a><span> </span><a name="local-1628066297"><a href="#local-1628066297"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-1628066298"><a href="#local-1628066298"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-1628066299"><a href="#local-1628066299"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-1628066300"><a href="#local-1628066300"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1262"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="TcCanonical.html#unifyDerived"><span class="hs-identifier hs-var">unifyDerived</span></a><span> </span><a href="#local-1628066297"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1263"></a><span>         </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#substTyUnchecked"><span class="hs-identifier hs-var">Type</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">substTyUnchecked</span></a><span> </span><a href="#local-1628066298"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1628066299"><span class="hs-identifier hs-var">ty1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#substTyUnchecked"><span class="hs-identifier hs-var">Type</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">substTyUnchecked</span></a><span> </span><a href="#local-1628066298"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1628066300"><span class="hs-identifier hs-var">ty2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1264"></a><span>
</span><a name="line-1265"></a><span class="hs-comment">{-
**********************************************************************
*                                                                    *
                       The top-reaction Stage
*                                                                    *
**********************************************************************
-}</span><span>
</span><a name="line-1272"></a><span>
</span><a name="line-1273"></a><span class="hs-identifier">topReactionsStage</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcInteract.html#WorkItem"><span class="hs-identifier hs-type">WorkItem</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span class="hs-special">)</span><span>
</span><a name="line-1274"></a><a name="topReactionsStage"><a href="TcInteract.html#topReactionsStage"><span class="hs-identifier">topReactionsStage</span></a></a><span> </span><a name="local-1628066301"><a href="#local-1628066301"><span class="hs-identifier">wi</span></a></a><span>
</span><a name="line-1275"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628066302"><a href="#local-1628066302"><span class="hs-identifier">tir</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcInteract.html#doTopReact"><span class="hs-identifier hs-var">doTopReact</span></a><span> </span><a href="#local-1628066301"><span class="hs-identifier hs-var">wi</span></a><span>
</span><a name="line-1276"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628066302"><span class="hs-identifier hs-var">tir</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1277"></a><span>          </span><a href="TcCanonical.html#ContinueWith"><span class="hs-identifier hs-var">ContinueWith</span></a><span> </span><a name="local-1628066303"><a href="#local-1628066303"><span class="hs-identifier">wi</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcCanonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a><span> </span><a href="#local-1628066303"><span class="hs-identifier hs-var">wi</span></a><span>
</span><a name="line-1278"></a><span>          </span><a href="TcCanonical.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><a name="local-1628066304"><a href="#local-1628066304"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-1628066305"><a href="#local-1628066305"><span class="hs-identifier">s</span></a></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><a href="#local-1628066304"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Top react:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="#local-1628066305"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1279"></a><span>
</span><a name="line-1280"></a><span class="hs-identifier">doTopReact</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcInteract.html#WorkItem"><span class="hs-identifier hs-type">WorkItem</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span class="hs-special">)</span><span>
</span><a name="line-1281"></a><span class="hs-comment">-- The work item does not react with the inert set, so try interaction with top-level</span><span>
</span><a name="line-1282"></a><span class="hs-comment">-- instances. Note:</span><span>
</span><a name="line-1283"></a><span class="hs-comment">--</span><span>
</span><a name="line-1284"></a><span class="hs-comment">--   (a) The place to add superclasses in not here in doTopReact stage.</span><span>
</span><a name="line-1285"></a><span class="hs-comment">--       Instead superclasses are added in the worklist as part of the</span><span>
</span><a name="line-1286"></a><span class="hs-comment">--       canonicalization process. See Note [Adding superclasses].</span><span>
</span><a name="line-1287"></a><span>
</span><a name="line-1288"></a><a name="doTopReact"><a href="TcInteract.html#doTopReact"><span class="hs-identifier">doTopReact</span></a></a><span> </span><a name="local-1628066306"><a href="#local-1628066306"><span class="hs-identifier">work_item</span></a></a><span>
</span><a name="line-1289"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;doTopReact&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066306"><span class="hs-identifier hs-var">work_item</span></a><span class="hs-special">)</span><span>
</span><a name="line-1290"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628066306"><span class="hs-identifier hs-var">work_item</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1291"></a><span>           </span><a href="TcRnTypes.html#CDictCan"><span class="hs-identifier hs-var">CDictCan</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628066307"><a href="#local-1628066307"><span class="hs-identifier">inerts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getTcSInerts"><span class="hs-identifier hs-var">getTcSInerts</span></a><span>
</span><a name="line-1292"></a><span>                              </span><span class="hs-special">;</span><span> </span><a href="TcInteract.html#doTopReactDict"><span class="hs-identifier hs-var">doTopReactDict</span></a><span> </span><a href="#local-1628066307"><span class="hs-identifier hs-var">inerts</span></a><span> </span><a href="#local-1628066306"><span class="hs-identifier hs-var">work_item</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1293"></a><span>           </span><a href="TcRnTypes.html#CFunEqCan"><span class="hs-identifier hs-var">CFunEqCan</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcInteract.html#doTopReactFunEq"><span class="hs-identifier hs-var">doTopReactFunEq</span></a><span> </span><a href="#local-1628066306"><span class="hs-identifier hs-var">work_item</span></a><span>
</span><a name="line-1294"></a><span>           </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">-- Any other work item does not react with any top-level equations</span><span>
</span><a name="line-1295"></a><span>                 </span><a href="TcCanonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a><span> </span><a href="#local-1628066306"><span class="hs-identifier hs-var">work_item</span></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-1296"></a><span>
</span><a name="line-1297"></a><span class="hs-comment">--------------------</span><span>
</span><a name="line-1298"></a><span class="hs-identifier">doTopReactDict</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#InertSet"><span class="hs-identifier hs-type">InertSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span class="hs-special">)</span><span>
</span><a name="line-1299"></a><span class="hs-comment">-- Try to use type-class instance declarations to simplify the constraint</span><span>
</span><a name="line-1300"></a><a name="doTopReactDict"><a href="TcInteract.html#doTopReactDict"><span class="hs-identifier">doTopReactDict</span></a></a><span> </span><a name="local-1628066308"><a href="#local-1628066308"><span class="hs-identifier">inerts</span></a></a><span> </span><a name="local-1628066309"><a href="#local-1628066309"><span class="hs-identifier">work_item</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TcRnTypes.html#CDictCan"><span class="hs-identifier hs-var">CDictCan</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066310"><a href="#local-1628066310"><span class="hs-identifier">fl</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_class</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066311"><a href="#local-1628066311"><span class="hs-identifier">cls</span></a></a><span>
</span><a name="line-1301"></a><span>                                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_tyargs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066312"><a href="#local-1628066312"><span class="hs-identifier">xis</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1302"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TcRnTypes.html#isGiven"><span class="hs-identifier hs-var">isGiven</span></a><span> </span><a href="#local-1628066310"><span class="hs-identifier hs-var">fl</span></a><span>   </span><span class="hs-comment">-- Never use instances for Given constraints</span><span>
</span><a name="line-1303"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="#local-1628066319"><span class="hs-identifier hs-var">try_fundep_improvement</span></a><span>
</span><a name="line-1304"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a><span> </span><a href="#local-1628066309"><span class="hs-identifier hs-var">work_item</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1305"></a><span>
</span><a name="line-1306"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628066328"><a href="#local-1628066328"><span class="hs-identifier">ev</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#lookupSolvedDict"><span class="hs-identifier hs-var">lookupSolvedDict</span></a><span> </span><a href="#local-1628066308"><span class="hs-identifier hs-var">inerts</span></a><span> </span><a href="#local-1628066311"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-1628066312"><span class="hs-identifier hs-var">xis</span></a><span>   </span><span class="hs-comment">-- Cached</span><span>
</span><a name="line-1307"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#setEvBindIfWanted"><span class="hs-identifier hs-var">setEvBindIfWanted</span></a><span> </span><a href="#local-1628066310"><span class="hs-identifier hs-var">fl</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#ctEvTerm"><span class="hs-identifier hs-var">ctEvTerm</span></a><span> </span><a href="#local-1628066328"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">)</span><span>
</span><a name="line-1308"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#stopWith"><span class="hs-identifier hs-var">stopWith</span></a><span> </span><a href="#local-1628066310"><span class="hs-identifier hs-var">fl</span></a><span> </span><span class="hs-string">&quot;Dict/Top (cached)&quot;</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1309"></a><span>
</span><a name="line-1310"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TcRnTypes.html#isDerived"><span class="hs-identifier hs-var">isDerived</span></a><span> </span><a href="#local-1628066310"><span class="hs-identifier hs-var">fl</span></a><span>  </span><span class="hs-comment">-- Use type-class instances for Deriveds, in the hope</span><span>
</span><a name="line-1311"></a><span>                  </span><span class="hs-comment">-- of generating some improvements</span><span>
</span><a name="line-1312"></a><span>                  </span><span class="hs-comment">-- C.f. Example 3 of Note [The improvement story]</span><span>
</span><a name="line-1313"></a><span>                  </span><span class="hs-comment">-- It's easy because no evidence is involved</span><span>
</span><a name="line-1314"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628066329"><a href="#local-1628066329"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a><span>
</span><a name="line-1315"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-1628066330"><a href="#local-1628066330"><span class="hs-identifier">lkup_inst_res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcInteract.html#matchClassInst"><span class="hs-identifier hs-var">matchClassInst</span></a><span> </span><a href="#local-1628066329"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-1628066308"><span class="hs-identifier hs-var">inerts</span></a><span> </span><a href="#local-1628066311"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-1628066312"><span class="hs-identifier hs-var">xis</span></a><span> </span><a href="#local-1628066314"><span class="hs-identifier hs-var">dict_loc</span></a><span>
</span><a name="line-1316"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628066330"><span class="hs-identifier hs-var">lkup_inst_res</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1317"></a><span>               </span><a href="TcInteract.html#GenInst"><span class="hs-identifier hs-var">GenInst</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">lir_new_theta</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066331"><a href="#local-1628066331"><span class="hs-identifier">preds</span></a></a><span>
</span><a name="line-1318"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">lir_safe_over</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066332"><a href="#local-1628066332"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1319"></a><span>                 </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#emitNewDeriveds"><span class="hs-identifier hs-var">emitNewDeriveds</span></a><span> </span><a href="#local-1628066314"><span class="hs-identifier hs-var">dict_loc</span></a><span> </span><a href="#local-1628066331"><span class="hs-identifier hs-var">preds</span></a><span>
</span><a name="line-1320"></a><span>                    </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a><span> </span><a href="#local-1628066332"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcSMonad.html#insertSafeOverlapFailureTcS"><span class="hs-identifier hs-var">insertSafeOverlapFailureTcS</span></a><span> </span><a href="#local-1628066309"><span class="hs-identifier hs-var">work_item</span></a><span>
</span><a name="line-1321"></a><span>                    </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#stopWith"><span class="hs-identifier hs-var">stopWith</span></a><span> </span><a href="#local-1628066310"><span class="hs-identifier hs-var">fl</span></a><span> </span><span class="hs-string">&quot;Dict/Top (solved)&quot;</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1322"></a><span>
</span><a name="line-1323"></a><span>               </span><a href="TcInteract.html#NoInstance"><span class="hs-identifier hs-var">NoInstance</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1324"></a><span>                 </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- If there is no instance, try improvement</span><span>
</span><a name="line-1325"></a><span>                      </span><a href="#local-1628066319"><span class="hs-identifier hs-var">try_fundep_improvement</span></a><span>
</span><a name="line-1326"></a><span>                    </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a><span> </span><a href="#local-1628066309"><span class="hs-identifier hs-var">work_item</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1327"></a><span>
</span><a name="line-1328"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>  </span><span class="hs-comment">-- Wanted, but not cached</span><span>
</span><a name="line-1329"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628066333"><a href="#local-1628066333"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a><span>
</span><a name="line-1330"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-1628066334"><a href="#local-1628066334"><span class="hs-identifier">lkup_inst_res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcInteract.html#matchClassInst"><span class="hs-identifier hs-var">matchClassInst</span></a><span> </span><a href="#local-1628066333"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-1628066308"><span class="hs-identifier hs-var">inerts</span></a><span> </span><a href="#local-1628066311"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-1628066312"><span class="hs-identifier hs-var">xis</span></a><span> </span><a href="#local-1628066314"><span class="hs-identifier hs-var">dict_loc</span></a><span>
</span><a name="line-1331"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628066334"><span class="hs-identifier hs-var">lkup_inst_res</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1332"></a><span>               </span><a href="TcInteract.html#GenInst"><span class="hs-identifier hs-var">GenInst</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">lir_new_theta</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066335"><a href="#local-1628066335"><span class="hs-identifier">theta</span></a></a><span>
</span><a name="line-1333"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">lir_mk_ev</span><span>     </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066336"><a href="#local-1628066336"><span class="hs-identifier">mk_ev</span></a></a><span>
</span><a name="line-1334"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">lir_safe_over</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066337"><a href="#local-1628066337"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1335"></a><span>                 </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#addSolvedDict"><span class="hs-identifier hs-var">addSolvedDict</span></a><span> </span><a href="#local-1628066310"><span class="hs-identifier hs-var">fl</span></a><span> </span><a href="#local-1628066311"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-1628066312"><span class="hs-identifier hs-var">xis</span></a><span>
</span><a name="line-1336"></a><span>                    </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a><span> </span><a href="#local-1628066337"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcSMonad.html#insertSafeOverlapFailureTcS"><span class="hs-identifier hs-var">insertSafeOverlapFailureTcS</span></a><span> </span><a href="#local-1628066309"><span class="hs-identifier hs-var">work_item</span></a><span>
</span><a name="line-1337"></a><span>                    </span><span class="hs-special">;</span><span> </span><a href="#local-1628066318"><span class="hs-identifier hs-var">solve_from_instance</span></a><span> </span><a href="#local-1628066335"><span class="hs-identifier hs-var">theta</span></a><span> </span><a href="#local-1628066336"><span class="hs-identifier hs-var">mk_ev</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1338"></a><span>               </span><a href="TcInteract.html#NoInstance"><span class="hs-identifier hs-var">NoInstance</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1339"></a><span>                 </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="#local-1628066319"><span class="hs-identifier hs-var">try_fundep_improvement</span></a><span>
</span><a name="line-1340"></a><span>                    </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a><span> </span><a href="#local-1628066309"><span class="hs-identifier hs-var">work_item</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1341"></a><span>   </span><span class="hs-keyword">where</span><span>
</span><a name="line-1342"></a><span>     </span><a name="local-1628066313"><a href="#local-1628066313"><span class="hs-identifier">dict_pred</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#mkClassPred"><span class="hs-identifier hs-var">mkClassPred</span></a><span> </span><a href="#local-1628066311"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-1628066312"><span class="hs-identifier hs-var">xis</span></a><span>
</span><a name="line-1343"></a><span>     </span><a name="local-1628066314"><a href="#local-1628066314"><span class="hs-identifier">dict_loc</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a><span> </span><a href="#local-1628066310"><span class="hs-identifier hs-var">fl</span></a><span>
</span><a name="line-1344"></a><span>     </span><a name="local-1628066315"><a href="#local-1628066315"><span class="hs-identifier">dict_origin</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#ctLocOrigin"><span class="hs-identifier hs-var">ctLocOrigin</span></a><span> </span><a href="#local-1628066314"><span class="hs-identifier hs-var">dict_loc</span></a><span>
</span><a name="line-1345"></a><span>     </span><a name="local-1628066316"><a href="#local-1628066316"><span class="hs-identifier">deeper_loc</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628066317"><span class="hs-identifier hs-var">zap_origin</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#bumpCtLocDepth"><span class="hs-identifier hs-var">bumpCtLocDepth</span></a><span> </span><a href="#local-1628066314"><span class="hs-identifier hs-var">dict_loc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1346"></a><span>
</span><a name="line-1347"></a><span>     </span><a name="local-1628066317"><a href="#local-1628066317"><span class="hs-identifier">zap_origin</span></a></a><span> </span><a name="local-1628066321"><a href="#local-1628066321"><span class="hs-identifier">loc</span></a></a><span>  </span><span class="hs-comment">-- After applying an instance we can set ScOrigin to</span><span>
</span><a name="line-1348"></a><span>                     </span><span class="hs-comment">-- infinity, so that prohibitedSuperClassSolve never fires</span><span>
</span><a name="line-1349"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="TcRnTypes.html#ScOrigin"><span class="hs-identifier hs-var">ScOrigin</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628066315"><span class="hs-identifier hs-var">dict_origin</span></a><span>
</span><a name="line-1350"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#setCtLocOrigin"><span class="hs-identifier hs-var">setCtLocOrigin</span></a><span> </span><a href="#local-1628066321"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#ScOrigin"><span class="hs-identifier hs-var">ScOrigin</span></a><span> </span><a href="BasicTypes.html#infinity"><span class="hs-identifier hs-var">infinity</span></a><span class="hs-special">)</span><span>
</span><a name="line-1351"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1352"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628066321"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-1353"></a><span>
</span><a name="line-1354"></a><span>     </span><span class="hs-identifier">solve_from_instance</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TcType.html#TcPredType"><span class="hs-identifier hs-type">TcPredType</span></a><span class="hs-special">]</span><span>
</span><a name="line-1355"></a><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="TcEvidence.html#EvTerm"><span class="hs-identifier hs-type">EvTerm</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcEvidence.html#EvTerm"><span class="hs-identifier hs-type">EvTerm</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span class="hs-special">)</span><span>
</span><a name="line-1356"></a><span>      </span><span class="hs-comment">-- Precondition: evidence term matches the predicate workItem</span><span>
</span><a name="line-1357"></a><span>     </span><a name="local-1628066318"><a href="#local-1628066318"><span class="hs-identifier">solve_from_instance</span></a></a><span> </span><a name="local-1628066322"><a href="#local-1628066322"><span class="hs-identifier">theta</span></a></a><span> </span><a name="local-1628066323"><a href="#local-1628066323"><span class="hs-identifier">mk_ev</span></a></a><span>
</span><a name="line-1358"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1628066322"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-1359"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;doTopReact/found nullary instance for&quot;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066310"><span class="hs-identifier hs-var">fl</span></a><span>
</span><a name="line-1360"></a><span>             </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#setWantedEvBind"><span class="hs-identifier hs-var">setWantedEvBind</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#ctEvId"><span class="hs-identifier hs-var">ctEvId</span></a><span> </span><a href="#local-1628066310"><span class="hs-identifier hs-var">fl</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-1628066323"><span class="hs-identifier hs-var">mk_ev</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1361"></a><span>             </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#stopWith"><span class="hs-identifier hs-var">stopWith</span></a><span> </span><a href="#local-1628066310"><span class="hs-identifier hs-var">fl</span></a><span> </span><span class="hs-string">&quot;Dict/Top (solved, no new work)&quot;</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1362"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1363"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#checkReductionDepth"><span class="hs-identifier hs-var">checkReductionDepth</span></a><span> </span><a href="#local-1628066316"><span class="hs-identifier hs-var">deeper_loc</span></a><span> </span><a href="#local-1628066313"><span class="hs-identifier hs-var">dict_pred</span></a><span>
</span><a name="line-1364"></a><span>             </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;doTopReact/found non-nullary instance for&quot;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066310"><span class="hs-identifier hs-var">fl</span></a><span>
</span><a name="line-1365"></a><span>             </span><span class="hs-special">;</span><span> </span><a name="local-1628066324"><a href="#local-1628066324"><span class="hs-identifier">evc_vars</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#newWanted"><span class="hs-identifier hs-var">newWanted</span></a><span> </span><a href="#local-1628066316"><span class="hs-identifier hs-var">deeper_loc</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628066322"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-1366"></a><span>             </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#setWantedEvBind"><span class="hs-identifier hs-var">setWantedEvBind</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#ctEvId"><span class="hs-identifier hs-var">ctEvId</span></a><span> </span><a href="#local-1628066310"><span class="hs-identifier hs-var">fl</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-1628066323"><span class="hs-identifier hs-var">mk_ev</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="TcSMonad.html#getEvTerm"><span class="hs-identifier hs-var">getEvTerm</span></a><span> </span><a href="#local-1628066324"><span class="hs-identifier hs-var">evc_vars</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1367"></a><span>             </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#emitWorkNC"><span class="hs-identifier hs-var">emitWorkNC</span></a><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#freshGoals"><span class="hs-identifier hs-var">freshGoals</span></a><span> </span><a href="#local-1628066324"><span class="hs-identifier hs-var">evc_vars</span></a><span class="hs-special">)</span><span>
</span><a name="line-1368"></a><span>             </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#stopWith"><span class="hs-identifier hs-var">stopWith</span></a><span> </span><a href="#local-1628066310"><span class="hs-identifier hs-var">fl</span></a><span> </span><span class="hs-string">&quot;Dict/Top (solved, more work)&quot;</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1369"></a><span>
</span><a name="line-1370"></a><span>     </span><span class="hs-comment">-- We didn't solve it; so try functional dependencies with</span><span>
</span><a name="line-1371"></a><span>     </span><span class="hs-comment">-- the instance environment, and return</span><span>
</span><a name="line-1372"></a><span>     </span><span class="hs-comment">-- See also Note [Weird fundeps]</span><span>
</span><a name="line-1373"></a><span>     </span><a name="local-1628066319"><a href="#local-1628066319"><span class="hs-identifier">try_fundep_improvement</span></a></a><span>
</span><a name="line-1374"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;try_fundeps&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066309"><span class="hs-identifier hs-var">work_item</span></a><span class="hs-special">)</span><span>
</span><a name="line-1375"></a><span>             </span><span class="hs-special">;</span><span> </span><a name="local-1628066325"><a href="#local-1628066325"><span class="hs-identifier">instEnvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getInstEnvs"><span class="hs-identifier hs-var">getInstEnvs</span></a><span>
</span><a name="line-1376"></a><span>             </span><span class="hs-special">;</span><span> </span><a href="TcInteract.html#emitFunDepDeriveds"><span class="hs-identifier hs-var">emitFunDepDeriveds</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1377"></a><span>               </span><a href="FunDeps.html#improveFromInstEnv"><span class="hs-identifier hs-var">improveFromInstEnv</span></a><span> </span><a href="#local-1628066325"><span class="hs-identifier hs-var">instEnvs</span></a><span> </span><a href="#local-1628066320"><span class="hs-identifier hs-var">mk_ct_loc</span></a><span> </span><a href="#local-1628066313"><span class="hs-identifier hs-var">dict_pred</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1378"></a><span>
</span><a name="line-1379"></a><span>     </span><span class="hs-identifier">mk_ct_loc</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a><span>   </span><span class="hs-comment">-- From instance decl</span><span>
</span><a name="line-1380"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SrcLoc.html#SrcSpan"><span class="hs-identifier hs-type">SrcSpan</span></a><span>    </span><span class="hs-comment">-- also from instance deol</span><span>
</span><a name="line-1381"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#CtLoc"><span class="hs-identifier hs-type">CtLoc</span></a><span>
</span><a name="line-1382"></a><span>     </span><a name="local-1628066320"><a href="#local-1628066320"><span class="hs-identifier">mk_ct_loc</span></a></a><span> </span><a name="local-1628066326"><a href="#local-1628066326"><span class="hs-identifier">inst_pred</span></a></a><span> </span><a name="local-1628066327"><a href="#local-1628066327"><span class="hs-identifier">inst_loc</span></a></a><span>
</span><a name="line-1383"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628066314"><span class="hs-identifier hs-var">dict_loc</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctl_origin</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#FunDepOrigin2"><span class="hs-identifier hs-var">FunDepOrigin2</span></a><span> </span><a href="#local-1628066313"><span class="hs-identifier hs-var">dict_pred</span></a><span> </span><a href="#local-1628066315"><span class="hs-identifier hs-var">dict_origin</span></a><span>
</span><a name="line-1384"></a><span>                                               </span><a href="#local-1628066326"><span class="hs-identifier hs-var">inst_pred</span></a><span> </span><a href="#local-1628066327"><span class="hs-identifier hs-var">inst_loc</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1385"></a><span>
</span><a name="line-1386"></a><span class="hs-identifier">doTopReactDict</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1628066338"><a href="#local-1628066338"><span class="hs-identifier">w</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;doTopReactDict&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066338"><span class="hs-identifier hs-var">w</span></a><span class="hs-special">)</span><span>
</span><a name="line-1387"></a><span>
</span><a name="line-1388"></a><span class="hs-comment">--------------------</span><span>
</span><a name="line-1389"></a><span class="hs-identifier">doTopReactFunEq</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span class="hs-special">)</span><span>
</span><a name="line-1390"></a><a name="doTopReactFunEq"><a href="TcInteract.html#doTopReactFunEq"><span class="hs-identifier">doTopReactFunEq</span></a></a><span> </span><a name="local-1628066339"><a href="#local-1628066339"><span class="hs-identifier">work_item</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TcRnTypes.html#CFunEqCan"><span class="hs-identifier hs-var">CFunEqCan</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066340"><a href="#local-1628066340"><span class="hs-identifier">old_ev</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_fun</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066341"><a href="#local-1628066341"><span class="hs-identifier">fam_tc</span></a></a><span>
</span><a name="line-1391"></a><span>                                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_tyargs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066342"><a href="#local-1628066342"><span class="hs-identifier">args</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_fsk</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066343"><a href="#local-1628066343"><span class="hs-identifier">fsk</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1392"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628066344"><a href="#local-1628066344"><span class="hs-identifier">match_res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#matchFam"><span class="hs-identifier hs-var">matchFam</span></a><span> </span><a href="#local-1628066341"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><a href="#local-1628066342"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1393"></a><span>                           </span><span class="hs-comment">-- Look up in top-level instances, or built-in axiom</span><span>
</span><a name="line-1394"></a><span>                           </span><span class="hs-comment">-- See Note [MATCHING-SYNONYMS]</span><span>
</span><a name="line-1395"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628066344"><span class="hs-identifier hs-var">match_res</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1396"></a><span>           </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcInteract.html#improveTopFunEqs"><span class="hs-identifier hs-var">improveTopFunEqs</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a><span> </span><a href="#local-1628066340"><span class="hs-identifier hs-var">old_ev</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628066341"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><a href="#local-1628066342"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-1628066343"><span class="hs-identifier hs-var">fsk</span></a><span>
</span><a name="line-1397"></a><span>                         </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a><span> </span><a href="#local-1628066339"><span class="hs-identifier hs-var">work_item</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1398"></a><span>           </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1628066345"><a href="#local-1628066345"><span class="hs-identifier">ax_co</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628066346"><a href="#local-1628066346"><span class="hs-identifier">rhs_ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1399"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcInteract.html#reduce_top_fun_eq"><span class="hs-identifier hs-var">reduce_top_fun_eq</span></a><span> </span><a href="#local-1628066340"><span class="hs-identifier hs-var">old_ev</span></a><span> </span><a href="#local-1628066343"><span class="hs-identifier hs-var">fsk</span></a><span> </span><a href="#local-1628066345"><span class="hs-identifier hs-var">ax_co</span></a><span> </span><a href="#local-1628066346"><span class="hs-identifier hs-var">rhs_ty</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1400"></a><span>
</span><a name="line-1401"></a><span class="hs-identifier">doTopReactFunEq</span><span> </span><a name="local-1628066347"><a href="#local-1628066347"><span class="hs-identifier">w</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;doTopReactFunEq&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066347"><span class="hs-identifier hs-var">w</span></a><span class="hs-special">)</span><span>
</span><a name="line-1402"></a><span>
</span><a name="line-1403"></a><span class="hs-identifier">reduce_top_fun_eq</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcEvidence.html#TcCoercion"><span class="hs-identifier hs-type">TcCoercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span>
</span><a name="line-1404"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span class="hs-special">)</span><span>
</span><a name="line-1405"></a><span class="hs-comment">-- Found an applicable top-level axiom: use it to reduce</span><span>
</span><a name="line-1406"></a><a name="reduce_top_fun_eq"><a href="TcInteract.html#reduce_top_fun_eq"><span class="hs-identifier">reduce_top_fun_eq</span></a></a><span> </span><a name="local-1628066348"><a href="#local-1628066348"><span class="hs-identifier">old_ev</span></a></a><span> </span><a name="local-1628066349"><a href="#local-1628066349"><span class="hs-identifier">fsk</span></a></a><span> </span><a name="local-1628066350"><a href="#local-1628066350"><span class="hs-identifier">ax_co</span></a></a><span> </span><a name="local-1628066351"><a href="#local-1628066351"><span class="hs-identifier">rhs_ty</span></a></a><span>
</span><a name="line-1407"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1628066354"><a href="#local-1628066354"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628066355"><a href="#local-1628066355"><span class="hs-identifier">tc_args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcType.html#tcSplitTyConApp_maybe"><span class="hs-identifier hs-var">tcSplitTyConApp_maybe</span></a><span> </span><a href="#local-1628066351"><span class="hs-identifier hs-var">rhs_ty</span></a><span>
</span><a name="line-1408"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="TyCon.html#isTypeFamilyTyCon"><span class="hs-identifier hs-var">isTypeFamilyTyCon</span></a><span> </span><a href="#local-1628066354"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1409"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-1628066355"><span class="hs-identifier hs-var">tc_args</span></a><span> </span><span class="hs-special">`</span><a href="Util.html#lengthIs"><span class="hs-identifier hs-var">lengthIs</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier">tyConArity</span><span> </span><a href="#local-1628066354"><span class="hs-identifier hs-var">tc</span></a><span>    </span><span class="hs-comment">-- Short-cut</span><span>
</span><a name="line-1410"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcInteract.html#shortCutReduction"><span class="hs-identifier hs-var">shortCutReduction</span></a><span> </span><a href="#local-1628066348"><span class="hs-identifier hs-var">old_ev</span></a><span> </span><a href="#local-1628066349"><span class="hs-identifier hs-var">fsk</span></a><span> </span><a href="#local-1628066350"><span class="hs-identifier hs-var">ax_co</span></a><span> </span><a href="#local-1628066354"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-1628066355"><span class="hs-identifier hs-var">tc_args</span></a><span>
</span><a name="line-1411"></a><span>       </span><span class="hs-comment">-- Try shortcut; see Note [Short cut for top-level reaction]</span><span>
</span><a name="line-1412"></a><span>
</span><a name="line-1413"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TcRnTypes.html#isGiven"><span class="hs-identifier hs-var">isGiven</span></a><span> </span><a href="#local-1628066348"><span class="hs-identifier hs-var">old_ev</span></a><span>  </span><span class="hs-comment">-- Not shortcut</span><span>
</span><a name="line-1414"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628066356"><a href="#local-1628066356"><span class="hs-identifier">final_co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcEvidence.html#mkTcSymCo"><span class="hs-identifier hs-var">mkTcSymCo</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#ctEvCoercion"><span class="hs-identifier hs-var">ctEvCoercion</span></a><span> </span><a href="#local-1628066348"><span class="hs-identifier hs-var">old_ev</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="TcEvidence.html#mkTcTransCo"><span class="hs-identifier hs-var">mkTcTransCo</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628066350"><span class="hs-identifier hs-var">ax_co</span></a><span>
</span><a name="line-1415"></a><span>              </span><span class="hs-comment">-- final_co :: fsk ~ rhs_ty</span><span>
</span><a name="line-1416"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628066357"><a href="#local-1628066357"><span class="hs-identifier">new_ev</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#newGivenEvVar"><span class="hs-identifier hs-var">newGivenEvVar</span></a><span> </span><a href="#local-1628066353"><span class="hs-identifier hs-var">deeper_loc</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#mkPrimEqPred"><span class="hs-identifier hs-var">mkPrimEqPred</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a><span> </span><a href="#local-1628066349"><span class="hs-identifier hs-var">fsk</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628066351"><span class="hs-identifier hs-var">rhs_ty</span></a><span class="hs-special">,</span><span>
</span><a name="line-1417"></a><span>                                             </span><a href="TcEvidence.html#EvCoercion"><span class="hs-identifier hs-var">EvCoercion</span></a><span> </span><a href="#local-1628066356"><span class="hs-identifier hs-var">final_co</span></a><span class="hs-special">)</span><span>
</span><a name="line-1418"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#emitWorkNC"><span class="hs-identifier hs-var">emitWorkNC</span></a><span> </span><span class="hs-special">[</span><a href="#local-1628066357"><span class="hs-identifier hs-var">new_ev</span></a><span class="hs-special">]</span><span> </span><span class="hs-comment">-- Non-cannonical; that will mean we flatten rhs_ty</span><span>
</span><a name="line-1419"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#stopWith"><span class="hs-identifier hs-var">stopWith</span></a><span> </span><a href="#local-1628066348"><span class="hs-identifier hs-var">old_ev</span></a><span> </span><span class="hs-string">&quot;Fun/Top (given)&quot;</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1420"></a><span>
</span><a name="line-1421"></a><span>  </span><span class="hs-comment">-- So old_ev is Wanted or Derived</span><span>
</span><a name="line-1422"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-1628066349"><span class="hs-identifier hs-var">fsk</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#elemVarSet"><span class="hs-identifier hs-var">elemVarSet</span></a><span class="hs-special">`</span><span> </span><a href="TyCoRep.html#tyCoVarsOfType"><span class="hs-identifier hs-var">tyCoVarsOfType</span></a><span> </span><a href="#local-1628066351"><span class="hs-identifier hs-var">rhs_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1423"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcInteract.html#dischargeFmv"><span class="hs-identifier hs-var">dischargeFmv</span></a><span> </span><a href="#local-1628066348"><span class="hs-identifier hs-var">old_ev</span></a><span> </span><a href="#local-1628066349"><span class="hs-identifier hs-var">fsk</span></a><span> </span><a href="#local-1628066350"><span class="hs-identifier hs-var">ax_co</span></a><span> </span><a href="#local-1628066351"><span class="hs-identifier hs-var">rhs_ty</span></a><span>
</span><a name="line-1424"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;doTopReactFunEq&quot;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1425"></a><span>         </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;old_ev:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066348"><span class="hs-identifier hs-var">old_ev</span></a><span>
</span><a name="line-1426"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;:=&quot;</span><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066350"><span class="hs-identifier hs-var">ax_co</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1427"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#stopWith"><span class="hs-identifier hs-var">stopWith</span></a><span> </span><a href="#local-1628066348"><span class="hs-identifier hs-var">old_ev</span></a><span> </span><span class="hs-string">&quot;Fun/Top (wanted)&quot;</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1428"></a><span>
</span><a name="line-1429"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-comment">-- We must not assign ufsk := ...ufsk...!</span><span>
</span><a name="line-1430"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628066358"><a href="#local-1628066358"><span class="hs-identifier">alpha_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#newFlexiTcSTy"><span class="hs-identifier hs-var">newFlexiTcSTy</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a><span> </span><a href="#local-1628066349"><span class="hs-identifier hs-var">fsk</span></a><span class="hs-special">)</span><span>
</span><a name="line-1431"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628066362"><a href="#local-1628066362"><span class="hs-identifier">new_ev</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628066348"><span class="hs-identifier hs-var">old_ev</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1432"></a><span>           </span><a href="TcRnTypes.html#CtWanted"><span class="hs-identifier hs-var">CtWanted</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-1628066359"><a href="#local-1628066359"><span class="hs-identifier">ev</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#newWantedEq"><span class="hs-identifier hs-var">newWantedEq</span></a><span> </span><a href="#local-1628066352"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-1628066358"><span class="hs-identifier hs-var">alpha_ty</span></a><span> </span><a href="#local-1628066351"><span class="hs-identifier hs-var">rhs_ty</span></a><span>
</span><a name="line-1433"></a><span>                              </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#updWorkListTcS"><span class="hs-identifier hs-var">updWorkListTcS</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1434"></a><span>                                  </span><a href="TcSMonad.html#extendWorkListEq"><span class="hs-identifier hs-var">extendWorkListEq</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#mkNonCanonical"><span class="hs-identifier hs-var">mkNonCanonical</span></a><span> </span><a href="#local-1628066359"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">)</span><span>
</span><a name="line-1435"></a><span>                              </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-1628066359"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1436"></a><span>           </span><a href="TcRnTypes.html#CtDerived"><span class="hs-identifier hs-var">CtDerived</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628066361"><a href="#local-1628066361"><span class="hs-identifier">ev</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#newDerivedNC"><span class="hs-identifier hs-var">newDerivedNC</span></a><span> </span><a href="#local-1628066352"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-1628066360"><span class="hs-identifier hs-var">pred</span></a><span>
</span><a name="line-1437"></a><span>                              </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#updWorkListTcS"><span class="hs-identifier hs-var">updWorkListTcS</span></a><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#extendWorkListDerived"><span class="hs-identifier hs-var">extendWorkListDerived</span></a><span> </span><a href="#local-1628066352"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-1628066361"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">)</span><span>
</span><a name="line-1438"></a><span>                              </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-1628066361"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1439"></a><span>             </span><span class="hs-keyword">where</span><span> </span><a name="local-1628066360"><a href="#local-1628066360"><span class="hs-identifier">pred</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#mkPrimEqPred"><span class="hs-identifier hs-var">mkPrimEqPred</span></a><span> </span><a href="#local-1628066358"><span class="hs-identifier hs-var">alpha_ty</span></a><span> </span><a href="#local-1628066351"><span class="hs-identifier hs-var">rhs_ty</span></a><span>
</span><a name="line-1440"></a><span>           </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;reduce_top_fun_eq&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066348"><span class="hs-identifier hs-var">old_ev</span></a><span class="hs-special">)</span><span>
</span><a name="line-1441"></a><span>
</span><a name="line-1442"></a><span>            </span><span class="hs-comment">-- By emitting this as non-canonical, we deal with all</span><span>
</span><a name="line-1443"></a><span>            </span><span class="hs-comment">-- flattening, occurs-check, and ufsk := ufsk issues</span><span>
</span><a name="line-1444"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628066363"><a href="#local-1628066363"><span class="hs-identifier">final_co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628066350"><span class="hs-identifier hs-var">ax_co</span></a><span> </span><span class="hs-special">`</span><a href="TcEvidence.html#mkTcTransCo"><span class="hs-identifier hs-var">mkTcTransCo</span></a><span class="hs-special">`</span><span> </span><a href="TcEvidence.html#mkTcSymCo"><span class="hs-identifier hs-var">mkTcSymCo</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#ctEvCoercion"><span class="hs-identifier hs-var">ctEvCoercion</span></a><span> </span><a href="#local-1628066362"><span class="hs-identifier hs-var">new_ev</span></a><span class="hs-special">)</span><span>
</span><a name="line-1445"></a><span>            </span><span class="hs-comment">--    ax_co :: fam_tc args ~ rhs_ty</span><span>
</span><a name="line-1446"></a><span>            </span><span class="hs-comment">--       ev :: alpha ~ rhs_ty</span><span>
</span><a name="line-1447"></a><span>            </span><span class="hs-comment">--     ufsk := alpha</span><span>
</span><a name="line-1448"></a><span>            </span><span class="hs-comment">-- final_co :: fam_tc args ~ alpha</span><span>
</span><a name="line-1449"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcInteract.html#dischargeFmv"><span class="hs-identifier hs-var">dischargeFmv</span></a><span> </span><a href="#local-1628066348"><span class="hs-identifier hs-var">old_ev</span></a><span> </span><a href="#local-1628066349"><span class="hs-identifier hs-var">fsk</span></a><span> </span><a href="#local-1628066363"><span class="hs-identifier hs-var">final_co</span></a><span> </span><a href="#local-1628066358"><span class="hs-identifier hs-var">alpha_ty</span></a><span>
</span><a name="line-1450"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;doTopReactFunEq (occurs)&quot;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1451"></a><span>         </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;old_ev:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066348"><span class="hs-identifier hs-var">old_ev</span></a><span>
</span><a name="line-1452"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;:=&quot;</span><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066363"><span class="hs-identifier hs-var">final_co</span></a><span>
</span><a name="line-1453"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;new_ev:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066362"><span class="hs-identifier hs-var">new_ev</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1454"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#stopWith"><span class="hs-identifier hs-var">stopWith</span></a><span> </span><a href="#local-1628066348"><span class="hs-identifier hs-var">old_ev</span></a><span> </span><span class="hs-string">&quot;Fun/Top (wanted)&quot;</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1455"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1456"></a><span>    </span><a name="local-1628066352"><a href="#local-1628066352"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a><span> </span><a href="#local-1628066348"><span class="hs-identifier hs-var">old_ev</span></a><span>
</span><a name="line-1457"></a><span>    </span><a name="local-1628066353"><a href="#local-1628066353"><span class="hs-identifier">deeper_loc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#bumpCtLocDepth"><span class="hs-identifier hs-var">bumpCtLocDepth</span></a><span> </span><a href="#local-1628066352"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-1458"></a><span>
</span><a name="line-1459"></a><span class="hs-identifier">improveTopFunEqs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#CtLoc"><span class="hs-identifier hs-type">CtLoc</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1460"></a><a name="improveTopFunEqs"><a href="TcInteract.html#improveTopFunEqs"><span class="hs-identifier">improveTopFunEqs</span></a></a><span> </span><a name="local-1628066364"><a href="#local-1628066364"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-1628066365"><a href="#local-1628066365"><span class="hs-identifier">fam_tc</span></a></a><span> </span><a name="local-1628066366"><a href="#local-1628066366"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-1628066367"><a href="#local-1628066367"><span class="hs-identifier">fsk</span></a></a><span>
</span><a name="line-1461"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628066368"><a href="#local-1628066368"><span class="hs-identifier">model</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getInertModel"><span class="hs-identifier hs-var">getInertModel</span></a><span>
</span><a name="line-1462"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628066369"><a href="#local-1628066369"><span class="hs-identifier">fam_envs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getFamInstEnvs"><span class="hs-identifier hs-var">getFamInstEnvs</span></a><span>
</span><a name="line-1463"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628066370"><a href="#local-1628066370"><span class="hs-identifier">eqns</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcInteract.html#improve_top_fun_eqs"><span class="hs-identifier hs-var">improve_top_fun_eqs</span></a><span> </span><a href="#local-1628066369"><span class="hs-identifier hs-var">fam_envs</span></a><span> </span><a href="#local-1628066365"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><a href="#local-1628066366"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1464"></a><span>                                    </span><span class="hs-special">(</span><a href="TcInteract.html#lookupFlattenTyVar"><span class="hs-identifier hs-var">lookupFlattenTyVar</span></a><span> </span><a href="#local-1628066368"><span class="hs-identifier hs-var">model</span></a><span> </span><a href="#local-1628066367"><span class="hs-identifier hs-var">fsk</span></a><span class="hs-special">)</span><span>
</span><a name="line-1465"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#unifyDerived"><span class="hs-identifier hs-var">unifyDerived</span></a><span> </span><a href="#local-1628066364"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628066370"><span class="hs-identifier hs-var">eqns</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1466"></a><span>
</span><a name="line-1467"></a><span class="hs-identifier">improve_top_fun_eqs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a><span>
</span><a name="line-1468"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span>
</span><a name="line-1469"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">[</span><a href="CoAxiom.html#Eqn"><span class="hs-identifier hs-type">Eqn</span></a><span class="hs-special">]</span><span>
</span><a name="line-1470"></a><a name="improve_top_fun_eqs"><a href="TcInteract.html#improve_top_fun_eqs"><span class="hs-identifier">improve_top_fun_eqs</span></a></a><span> </span><a name="local-1628066371"><a href="#local-1628066371"><span class="hs-identifier">fam_envs</span></a></a><span> </span><a name="local-1628066372"><a href="#local-1628066372"><span class="hs-identifier">fam_tc</span></a></a><span> </span><a name="local-1628066373"><a href="#local-1628066373"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-1628066374"><a href="#local-1628066374"><span class="hs-identifier">rhs_ty</span></a></a><span>
</span><a name="line-1471"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628066400"><a href="#local-1628066400"><span class="hs-identifier">ops</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TyCon.html#isBuiltInSynFamTyCon_maybe"><span class="hs-identifier hs-var">isBuiltInSynFamTyCon_maybe</span></a><span> </span><a href="#local-1628066372"><span class="hs-identifier hs-var">fam_tc</span></a><span>
</span><a name="line-1472"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">sfInteractTop</span><span> </span><a href="#local-1628066400"><span class="hs-identifier hs-var">ops</span></a><span> </span><a href="#local-1628066373"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-1628066374"><span class="hs-identifier hs-var">rhs_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1473"></a><span>
</span><a name="line-1474"></a><span>  </span><span class="hs-comment">-- see Note [Type inference for type families with injectivity]</span><span>
</span><a name="line-1475"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TyCon.html#isOpenTypeFamilyTyCon"><span class="hs-identifier hs-var">isOpenTypeFamilyTyCon</span></a><span> </span><a href="#local-1628066372"><span class="hs-identifier hs-var">fam_tc</span></a><span>
</span><a name="line-1476"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="TyCon.html#Injective"><span class="hs-identifier hs-var">Injective</span></a><span> </span><a name="local-1628066401"><a href="#local-1628066401"><span class="hs-identifier">injective_args</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TyCon.html#familyTyConInjectivityInfo"><span class="hs-identifier hs-var">familyTyConInjectivityInfo</span></a><span> </span><a href="#local-1628066372"><span class="hs-identifier hs-var">fam_tc</span></a><span>
</span><a name="line-1477"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- it is possible to have several compatible equations in an open type</span><span>
</span><a name="line-1478"></a><span>    </span><span class="hs-comment">-- family but we only want to derive equalities from one such equation.</span><span>
</span><a name="line-1479"></a><span>    </span><a href="MonadUtils.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628066376"><span class="hs-identifier hs-var">injImproveEqns</span></a><span> </span><a href="#local-1628066401"><span class="hs-identifier hs-var">injective_args</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#take"><span class="hs-identifier hs-var">take</span></a><span> </span><span class="hs-number">1</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1480"></a><span>      </span><a href="#local-1628066375"><span class="hs-identifier hs-var">buildImprovementData</span></a><span> </span><span class="hs-special">(</span><a href="FamInstEnv.html#lookupFamInstEnvByTyCon"><span class="hs-identifier hs-var">lookupFamInstEnvByTyCon</span></a><span> </span><a href="#local-1628066371"><span class="hs-identifier hs-var">fam_envs</span></a><span> </span><a href="#local-1628066372"><span class="hs-identifier hs-var">fam_tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1481"></a><span>                           </span><span class="hs-identifier">fi_tys</span><span> </span><span class="hs-identifier">fi_rhs</span><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#const"><span class="hs-identifier hs-var">const</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1482"></a><span>
</span><a name="line-1483"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628066402"><a href="#local-1628066402"><span class="hs-identifier">ax</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TyCon.html#isClosedSynFamilyTyConWithAxiom_maybe"><span class="hs-identifier hs-var">isClosedSynFamilyTyConWithAxiom_maybe</span></a><span> </span><a href="#local-1628066372"><span class="hs-identifier hs-var">fam_tc</span></a><span>
</span><a name="line-1484"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="TyCon.html#Injective"><span class="hs-identifier hs-var">Injective</span></a><span> </span><a name="local-1628066403"><a href="#local-1628066403"><span class="hs-identifier">injective_args</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TyCon.html#familyTyConInjectivityInfo"><span class="hs-identifier hs-var">familyTyConInjectivityInfo</span></a><span> </span><a href="#local-1628066372"><span class="hs-identifier hs-var">fam_tc</span></a><span>
</span><a name="line-1485"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="MonadUtils.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628066376"><span class="hs-identifier hs-var">injImproveEqns</span></a><span> </span><a href="#local-1628066403"><span class="hs-identifier hs-var">injective_args</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1486"></a><span>      </span><a href="#local-1628066375"><span class="hs-identifier hs-var">buildImprovementData</span></a><span> </span><span class="hs-special">(</span><a href="CoAxiom.html#fromBranches"><span class="hs-identifier hs-var">fromBranches</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">co_ax_branches</span><span> </span><a href="#local-1628066402"><span class="hs-identifier hs-var">ax</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1487"></a><span>                           </span><span class="hs-identifier">cab_lhs</span><span> </span><span class="hs-identifier">cab_rhs</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span>
</span><a name="line-1488"></a><span>
</span><a name="line-1489"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1490"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1491"></a><span>     </span><span class="hs-keyword">where</span><span>
</span><a name="line-1492"></a><span>      </span><span class="hs-identifier">buildImprovementData</span><span>
</span><a name="line-1493"></a><span>          </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="#local-1628066377"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span>                     </span><span class="hs-comment">-- axioms for a TF (FamInst or CoAxBranch)</span><span>
</span><a name="line-1494"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-1628066377"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>           </span><span class="hs-comment">-- get LHS of an axiom</span><span>
</span><a name="line-1495"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-1628066377"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">)</span><span>             </span><span class="hs-comment">-- get RHS of an axiom</span><span>
</span><a name="line-1496"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-1628066377"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Just =&gt; apartness check required</span><span>
</span><a name="line-1497"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-type">TCvSubst</span></a><span class="hs-special">,</span><span> </span><a href="VarSet.html#TyVarSet"><span class="hs-identifier hs-type">TyVarSet</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span> </span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1498"></a><span>             </span><span class="hs-comment">-- Result:</span><span>
</span><a name="line-1499"></a><span>             </span><span class="hs-comment">-- ( [arguments of a matching axiom]</span><span>
</span><a name="line-1500"></a><span>             </span><span class="hs-comment">-- , RHS-unifying substitution</span><span>
</span><a name="line-1501"></a><span>             </span><span class="hs-comment">-- , axiom variables without substitution</span><span>
</span><a name="line-1502"></a><span>             </span><span class="hs-comment">-- , Maybe matching axiom [Nothing - open TF, Just - closed TF ] )</span><span>
</span><a name="line-1503"></a><span>      </span><a name="local-1628066375"><a href="#local-1628066375"><span class="hs-identifier">buildImprovementData</span></a></a><span> </span><a name="local-1628066378"><a href="#local-1628066378"><span class="hs-identifier">axioms</span></a></a><span> </span><a name="local-1628066379"><a href="#local-1628066379"><span class="hs-identifier">axiomLHS</span></a></a><span> </span><a name="local-1628066380"><a href="#local-1628066380"><span class="hs-identifier">axiomRHS</span></a></a><span> </span><a name="local-1628066381"><a href="#local-1628066381"><span class="hs-identifier">wrap</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1504"></a><span>          </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-1628066383"><span class="hs-identifier hs-var">ax_args</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628066385"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628066388"><span class="hs-identifier hs-var">unsubstTvs</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628066381"><span class="hs-identifier hs-var">wrap</span></a><span> </span><a href="#local-1628066382"><span class="hs-identifier hs-var">axiom</span></a><span class="hs-special">)</span><span>
</span><a name="line-1505"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a name="local-1628066382"><a href="#local-1628066382"><span class="hs-identifier">axiom</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628066378"><span class="hs-identifier hs-var">axioms</span></a><span>
</span><a name="line-1506"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628066383"><a href="#local-1628066383"><span class="hs-identifier">ax_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628066379"><span class="hs-identifier hs-var">axiomLHS</span></a><span> </span><a href="#local-1628066382"><span class="hs-identifier hs-var">axiom</span></a><span>
</span><a name="line-1507"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628066384"><a href="#local-1628066384"><span class="hs-identifier">ax_rhs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628066380"><span class="hs-identifier hs-var">axiomRHS</span></a><span> </span><a href="#local-1628066382"><span class="hs-identifier hs-var">axiom</span></a><span>
</span><a name="line-1508"></a><span>          </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628066385"><a href="#local-1628066385"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><a href="Unify.html#tcUnifyTyWithTFs"><span class="hs-identifier hs-var">tcUnifyTyWithTFs</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-1628066384"><span class="hs-identifier hs-var">ax_rhs</span></a><span> </span><a href="#local-1628066374"><span class="hs-identifier hs-var">rhs_ty</span></a><span class="hs-special">]</span><span>
</span><a name="line-1509"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628066386"><a href="#local-1628066386"><span class="hs-identifier">tvs</span></a></a><span>           </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#tyCoVarsOfTypes"><span class="hs-identifier hs-var">tyCoVarsOfTypes</span></a><span> </span><a href="#local-1628066383"><span class="hs-identifier hs-var">ax_args</span></a><span>
</span><a name="line-1510"></a><span>                </span><a name="local-1628066387"><a href="#local-1628066387"><span class="hs-identifier">notInSubst</span></a></a><span> </span><a name="local-1628066389"><a href="#local-1628066389"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-1628066389"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#elemVarEnv"><span class="hs-identifier hs-var">elemVarEnv</span></a><span class="hs-special">`</span><span> </span><a href="TyCoRep.html#getTvSubstEnv"><span class="hs-identifier hs-var">getTvSubstEnv</span></a><span> </span><a href="#local-1628066385"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">)</span><span>
</span><a name="line-1511"></a><span>                </span><a name="local-1628066388"><a href="#local-1628066388"><span class="hs-identifier">unsubstTvs</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#filterVarSet"><span class="hs-identifier hs-var">filterVarSet</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628066387"><span class="hs-identifier hs-var">notInSubst</span></a><span> </span><a href="Util.html#%3C%26%26%3E"><span class="hs-operator hs-var">&lt;&amp;&amp;&gt;</span></a><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628066386"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1512"></a><span>
</span><a name="line-1513"></a><span>      </span><span class="hs-identifier">injImproveEqns</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">]</span><span>
</span><a name="line-1514"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-type">TCvSubst</span></a><span class="hs-special">,</span><span> </span><a href="VarSet.html#TyCoVarSet"><span class="hs-identifier hs-type">TyCoVarSet</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span class="hs-special">)</span><span>
</span><a name="line-1515"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">[</span><a href="CoAxiom.html#Eqn"><span class="hs-identifier hs-type">Eqn</span></a><span class="hs-special">]</span><span>
</span><a name="line-1516"></a><span>      </span><a name="local-1628066376"><a href="#local-1628066376"><span class="hs-identifier">injImproveEqns</span></a></a><span> </span><a name="local-1628066390"><a href="#local-1628066390"><span class="hs-identifier">inj_args</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1628066391"><a href="#local-1628066391"><span class="hs-identifier">ax_args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628066392"><a href="#local-1628066392"><span class="hs-identifier">theta</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628066393"><a href="#local-1628066393"><span class="hs-identifier">unsubstTvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628066394"><a href="#local-1628066394"><span class="hs-identifier">cabr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1517"></a><span>        </span><span class="hs-special">(</span><a name="local-1628066395"><a href="#local-1628066395"><span class="hs-identifier">theta'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#instFlexiTcS"><span class="hs-identifier hs-var">instFlexiTcS</span></a><span> </span><span class="hs-special">(</span><a href="VarSet.html#varSetElems"><span class="hs-identifier hs-var">varSetElems</span></a><span> </span><a href="#local-1628066393"><span class="hs-identifier hs-var">unsubstTvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1518"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-1628066396"><a href="#local-1628066396"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628066392"><span class="hs-identifier hs-var">theta</span></a><span> </span><span class="hs-special">`</span><a href="TyCoRep.html#unionTCvSubst"><span class="hs-identifier hs-var">unionTCvSubst</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628066395"><span class="hs-identifier hs-var">theta'</span></a><span>
</span><a name="line-1519"></a><span>        </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a href="#local-1628066398"><span class="hs-identifier hs-var">arg</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#substTyUnchecked"><span class="hs-identifier hs-var">substTyUnchecked</span></a><span> </span><a href="#local-1628066396"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1628066399"><span class="hs-identifier hs-var">ax_arg</span></a><span class="hs-special">)</span><span>
</span><a name="line-1520"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628066394"><span class="hs-identifier hs-var">cabr</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1521"></a><span>                  </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628066397"><a href="#local-1628066397"><span class="hs-identifier">cabr'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FamInstEnv.html#apartnessCheck"><span class="hs-identifier hs-var">apartnessCheck</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#substTys"><span class="hs-identifier hs-var">substTys</span></a><span> </span><a href="#local-1628066396"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1628066391"><span class="hs-identifier hs-var">ax_args</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628066397"><span class="hs-identifier hs-var">cabr'</span></a><span>
</span><a name="line-1522"></a><span>                  </span><span class="hs-identifier">_</span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1523"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-1628066398"><a href="#local-1628066398"><span class="hs-identifier">arg</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628066399"><a href="#local-1628066399"><span class="hs-identifier">ax_arg</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zip3"><span class="hs-identifier hs-var">zip3</span></a><span> </span><a href="#local-1628066373"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-1628066391"><span class="hs-identifier hs-var">ax_args</span></a><span> </span><a href="#local-1628066390"><span class="hs-identifier hs-var">inj_args</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1524"></a><span>
</span><a name="line-1525"></a><span>
</span><a name="line-1526"></a><span class="hs-identifier">shortCutReduction</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcEvidence.html#TcCoercion"><span class="hs-identifier hs-type">TcCoercion</span></a><span>
</span><a name="line-1527"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span class="hs-special">)</span><span>
</span><a name="line-1528"></a><span class="hs-comment">-- See Note [Top-level reductions for type functions]</span><span>
</span><a name="line-1529"></a><a name="shortCutReduction"><a href="TcInteract.html#shortCutReduction"><span class="hs-identifier">shortCutReduction</span></a></a><span> </span><a name="local-1628066404"><a href="#local-1628066404"><span class="hs-identifier">old_ev</span></a></a><span> </span><a name="local-1628066405"><a href="#local-1628066405"><span class="hs-identifier">fsk</span></a></a><span> </span><a name="local-1628066406"><a href="#local-1628066406"><span class="hs-identifier">ax_co</span></a></a><span> </span><a name="local-1628066407"><a href="#local-1628066407"><span class="hs-identifier">fam_tc</span></a></a><span> </span><a name="local-1628066408"><a href="#local-1628066408"><span class="hs-identifier">tc_args</span></a></a><span>
</span><a name="line-1530"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">ctEvEqRel</span><span> </span><span class="hs-identifier">old_ev</span><span> </span><a href="TcRnTypes.html#ctEvEqRel"><span class="hs-operator hs-var">==</span></a><span> </span><span class="hs-identifier">NomEq</span><span class="hs-special">)</span><span>
</span><a name="line-1531"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-1628066410"><a href="#local-1628066410"><span class="hs-identifier">xis</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628066411"><a href="#local-1628066411"><span class="hs-identifier">cos</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcFlatten.html#flattenManyNom"><span class="hs-identifier hs-var">flattenManyNom</span></a><span> </span><a href="#local-1628066404"><span class="hs-identifier hs-var">old_ev</span></a><span> </span><a href="#local-1628066408"><span class="hs-identifier hs-var">tc_args</span></a><span>
</span><a name="line-1532"></a><span>               </span><span class="hs-comment">-- ax_co :: F args ~ G tc_args</span><span>
</span><a name="line-1533"></a><span>               </span><span class="hs-comment">-- cos   :: xis ~ tc_args</span><span>
</span><a name="line-1534"></a><span>               </span><span class="hs-comment">-- old_ev :: F args ~ fsk</span><span>
</span><a name="line-1535"></a><span>               </span><span class="hs-comment">-- G cos ; sym ax_co ; old_ev :: G xis ~ fsk</span><span>
</span><a name="line-1536"></a><span>
</span><a name="line-1537"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628066414"><a href="#local-1628066414"><span class="hs-identifier">new_ev</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="TcRnTypes.html#ctEvFlavour"><span class="hs-identifier hs-var">ctEvFlavour</span></a><span> </span><a href="#local-1628066404"><span class="hs-identifier hs-var">old_ev</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1538"></a><span>           </span><a href="TcRnTypes.html#Given"><span class="hs-identifier hs-var">Given</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#newGivenEvVar"><span class="hs-identifier hs-var">newGivenEvVar</span></a><span> </span><a href="#local-1628066409"><span class="hs-identifier hs-var">deeper_loc</span></a><span>
</span><a name="line-1539"></a><span>                         </span><span class="hs-special">(</span><span> </span><a href="Type.html#mkPrimEqPred"><span class="hs-identifier hs-var">mkPrimEqPred</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a><span> </span><a href="#local-1628066407"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><a href="#local-1628066410"><span class="hs-identifier hs-var">xis</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a><span> </span><a href="#local-1628066405"><span class="hs-identifier hs-var">fsk</span></a><span class="hs-special">)</span><span>
</span><a name="line-1540"></a><span>                         </span><span class="hs-special">,</span><span> </span><a href="TcEvidence.html#EvCoercion"><span class="hs-identifier hs-var">EvCoercion</span></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#mkTcTyConAppCo"><span class="hs-identifier hs-var">mkTcTyConAppCo</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-1628066407"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><a href="#local-1628066411"><span class="hs-identifier hs-var">cos</span></a><span>
</span><a name="line-1541"></a><span>                                        </span><span class="hs-special">`</span><a href="TcEvidence.html#mkTcTransCo"><span class="hs-identifier hs-var">mkTcTransCo</span></a><span class="hs-special">`</span><span> </span><a href="TcEvidence.html#mkTcSymCo"><span class="hs-identifier hs-var">mkTcSymCo</span></a><span> </span><a href="#local-1628066406"><span class="hs-identifier hs-var">ax_co</span></a><span>
</span><a name="line-1542"></a><span>                                        </span><span class="hs-special">`</span><a href="TcEvidence.html#mkTcTransCo"><span class="hs-identifier hs-var">mkTcTransCo</span></a><span class="hs-special">`</span><span> </span><a href="TcRnTypes.html#ctEvCoercion"><span class="hs-identifier hs-var">ctEvCoercion</span></a><span> </span><a href="#local-1628066404"><span class="hs-identifier hs-var">old_ev</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1543"></a><span>
</span><a name="line-1544"></a><span>           </span><a href="TcRnTypes.html#Derived"><span class="hs-identifier hs-var">Derived</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#newDerivedNC"><span class="hs-identifier hs-var">newDerivedNC</span></a><span> </span><a href="#local-1628066409"><span class="hs-identifier hs-var">deeper_loc</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1545"></a><span>                      </span><a href="Type.html#mkPrimEqPred"><span class="hs-identifier hs-var">mkPrimEqPred</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a><span> </span><a href="#local-1628066407"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><a href="#local-1628066410"><span class="hs-identifier hs-var">xis</span></a><span class="hs-special">)</span><span>
</span><a name="line-1546"></a><span>                                   </span><span class="hs-special">(</span><a href="TyCoRep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a><span> </span><a href="#local-1628066405"><span class="hs-identifier hs-var">fsk</span></a><span class="hs-special">)</span><span>
</span><a name="line-1547"></a><span>
</span><a name="line-1548"></a><span>           </span><a href="TcRnTypes.html#Wanted"><span class="hs-identifier hs-var">Wanted</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1549"></a><span>             </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-1628066412"><a href="#local-1628066412"><span class="hs-identifier">new_ev</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628066413"><a href="#local-1628066413"><span class="hs-identifier">new_co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#newWantedEq"><span class="hs-identifier hs-var">newWantedEq</span></a><span> </span><a href="#local-1628066409"><span class="hs-identifier hs-var">deeper_loc</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span>
</span><a name="line-1550"></a><span>                                        </span><span class="hs-special">(</span><a href="Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a><span> </span><a href="#local-1628066407"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><a href="#local-1628066410"><span class="hs-identifier hs-var">xis</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a><span> </span><a href="#local-1628066405"><span class="hs-identifier hs-var">fsk</span></a><span class="hs-special">)</span><span>
</span><a name="line-1551"></a><span>                </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#setWantedEq"><span class="hs-identifier hs-var">setWantedEq</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ctev_dest</span><span> </span><a href="#local-1628066404"><span class="hs-identifier hs-var">old_ev</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1552"></a><span>                     </span><a href="#local-1628066406"><span class="hs-identifier hs-var">ax_co</span></a><span> </span><span class="hs-special">`</span><a href="TcEvidence.html#mkTcTransCo"><span class="hs-identifier hs-var">mkTcTransCo</span></a><span class="hs-special">`</span><span> </span><a href="TcEvidence.html#mkTcSymCo"><span class="hs-identifier hs-var">mkTcSymCo</span></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#mkTcTyConAppCo"><span class="hs-identifier hs-var">mkTcTyConAppCo</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span>
</span><a name="line-1553"></a><span>                                                      </span><a href="#local-1628066407"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><a href="#local-1628066411"><span class="hs-identifier hs-var">cos</span></a><span class="hs-special">)</span><span>
</span><a name="line-1554"></a><span>                           </span><span class="hs-special">`</span><a href="TcEvidence.html#mkTcTransCo"><span class="hs-identifier hs-var">mkTcTransCo</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628066413"><span class="hs-identifier hs-var">new_co</span></a><span>
</span><a name="line-1555"></a><span>                </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-1628066412"><span class="hs-identifier hs-var">new_ev</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1556"></a><span>
</span><a name="line-1557"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628066415"><a href="#local-1628066415"><span class="hs-identifier">new_ct</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#CFunEqCan"><span class="hs-identifier hs-var">CFunEqCan</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628066414"><span class="hs-identifier hs-var">new_ev</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_fun</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628066407"><span class="hs-identifier hs-var">fam_tc</span></a><span>
</span><a name="line-1558"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_tyargs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628066410"><span class="hs-identifier hs-var">xis</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_fsk</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628066405"><span class="hs-identifier hs-var">fsk</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1559"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#updWorkListTcS"><span class="hs-identifier hs-var">updWorkListTcS</span></a><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#extendWorkListFunEq"><span class="hs-identifier hs-var">extendWorkListFunEq</span></a><span> </span><a href="#local-1628066415"><span class="hs-identifier hs-var">new_ct</span></a><span class="hs-special">)</span><span>
</span><a name="line-1560"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#stopWith"><span class="hs-identifier hs-var">stopWith</span></a><span> </span><a href="#local-1628066404"><span class="hs-identifier hs-var">old_ev</span></a><span> </span><span class="hs-string">&quot;Fun/Top (shortcut)&quot;</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1561"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1562"></a><span>    </span><a name="local-1628066409"><a href="#local-1628066409"><span class="hs-identifier">deeper_loc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#bumpCtLocDepth"><span class="hs-identifier hs-var">bumpCtLocDepth</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#ctEvLoc"><span class="hs-identifier hs-var">ctEvLoc</span></a><span> </span><a href="#local-1628066404"><span class="hs-identifier hs-var">old_ev</span></a><span class="hs-special">)</span><span>
</span><a name="line-1563"></a><span>
</span><a name="line-1564"></a><span class="hs-identifier">dischargeFmv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcEvidence.html#TcCoercion"><span class="hs-identifier hs-type">TcCoercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1565"></a><span class="hs-comment">-- (dischargeFmv x fmv co ty)</span><span>
</span><a name="line-1566"></a><span class="hs-comment">--     [W] ev :: F tys ~ fmv</span><span>
</span><a name="line-1567"></a><span class="hs-comment">--         co :: F tys ~ xi</span><span>
</span><a name="line-1568"></a><span class="hs-comment">-- Precondition: fmv is not filled, and fuv `notElem` xi</span><span>
</span><a name="line-1569"></a><span class="hs-comment">--</span><span>
</span><a name="line-1570"></a><span class="hs-comment">-- Then set fmv := xi,</span><span>
</span><a name="line-1571"></a><span class="hs-comment">--      set ev := co</span><span>
</span><a name="line-1572"></a><span class="hs-comment">--      kick out any inert things that are now rewritable</span><span>
</span><a name="line-1573"></a><span class="hs-comment">--</span><span>
</span><a name="line-1574"></a><span class="hs-comment">-- Does not evaluate 'co' if 'ev' is Derived</span><span>
</span><a name="line-1575"></a><a name="dischargeFmv"><a href="TcInteract.html#dischargeFmv"><span class="hs-identifier">dischargeFmv</span></a></a><span> </span><a name="local-1628066416"><a href="#local-1628066416"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-1628066417"><a href="#local-1628066417"><span class="hs-identifier">fmv</span></a></a><span> </span><a name="local-1628066418"><a href="#local-1628066418"><span class="hs-identifier">co</span></a></a><span> </span><a name="local-1628066419"><a href="#local-1628066419"><span class="hs-identifier">xi</span></a></a><span>
</span><a name="line-1576"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">not</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fmv</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">elemVarSet</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">tyCoVarsOfType</span><span> </span><a href="TyCoRep.html#tyCoVarsOfType"><span class="hs-identifier hs-var">xi</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#tyCoVarsOfType"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="TyCoRep.html#tyCoVarsOfType"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">fmv</span><span> </span><span class="hs-operator">$$</span><span> </span><a href="Outputable.html#assertPprPanic"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="Outputable.html#assertPprPanic"><span class="hs-identifier hs-var">xi</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1577"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#setEvBindIfWanted"><span class="hs-identifier hs-var">setEvBindIfWanted</span></a><span> </span><a href="#local-1628066416"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#EvCoercion"><span class="hs-identifier hs-var">EvCoercion</span></a><span> </span><a href="#local-1628066418"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-1578"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#unflattenFmv"><span class="hs-identifier hs-var">unflattenFmv</span></a><span> </span><a href="#local-1628066417"><span class="hs-identifier hs-var">fmv</span></a><span> </span><a href="#local-1628066419"><span class="hs-identifier hs-var">xi</span></a><span>
</span><a name="line-1579"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628066420"><a href="#local-1628066420"><span class="hs-identifier">n_kicked</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#kickOutAfterUnification"><span class="hs-identifier hs-var">kickOutAfterUnification</span></a><span> </span><a href="#local-1628066417"><span class="hs-identifier hs-var">fmv</span></a><span>
</span><a name="line-1580"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;dischargeFmv&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066417"><span class="hs-identifier hs-var">fmv</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#equals"><span class="hs-identifier hs-var">equals</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066419"><span class="hs-identifier hs-var">xi</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="TcInteract.html#ppr_kicked"><span class="hs-identifier hs-var">ppr_kicked</span></a><span> </span><a href="#local-1628066420"><span class="hs-identifier hs-var">n_kicked</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1581"></a><span>
</span><a name="line-1582"></a><span class="hs-comment">{- Note [Top-level reductions for type functions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
c.f. Note [The flattening story] in TcFlatten

Suppose we have a CFunEqCan  F tys ~ fmv/fsk, and a matching axiom.
Here is what we do, in four cases:

* Wanteds: general firing rule
    (work item) [W]        x : F tys ~ fmv
    instantiate axiom: ax_co : F tys ~ rhs

   Then:
      Discharge   fmv := alpha
      Discharge   x := ax_co ; sym x2
      New wanted  [W] x2 : alpha ~ rhs  (Non-canonical)
   This is *the* way that fmv's get unified; even though they are
   &quot;untouchable&quot;.

   NB: it can be the case that fmv appears in the (instantiated) rhs.
   In that case the new Non-canonical wanted will be loopy, but that's
   ok.  But it's good reason NOT to claim that it is canonical!

* Wanteds: short cut firing rule
  Applies when the RHS of the axiom is another type-function application
      (work item)        [W] x : F tys ~ fmv
      instantiate axiom: ax_co : F tys ~ G rhs_tys

  It would be a waste to create yet another fmv for (G rhs_tys).
  Instead (shortCutReduction):
      - Flatten rhs_tys (cos : rhs_tys ~ rhs_xis)
      - Add G rhs_xis ~ fmv to flat cache  (note: the same old fmv)
      - New canonical wanted   [W] x2 : G rhs_xis ~ fmv  (CFunEqCan)
      - Discharge x := ax_co ; G cos ; x2

* Givens: general firing rule
      (work item)        [G] g : F tys ~ fsk
      instantiate axiom: ax_co : F tys ~ rhs

   Now add non-canonical given (since rhs is not flat)
      [G] (sym g ; ax_co) : fsk ~ rhs  (Non-canonical)

* Givens: short cut firing rule
  Applies when the RHS of the axiom is another type-function application
      (work item)        [G] g : F tys ~ fsk
      instantiate axiom: ax_co : F tys ~ G rhs_tys

  It would be a waste to create yet another fsk for (G rhs_tys).
  Instead (shortCutReduction):
     - Flatten rhs_tys: flat_cos : tys ~ flat_tys
     - Add new Canonical given
          [G] (sym (G flat_cos) ; co ; g) : G flat_tys ~ fsk   (CFunEqCan)

Note [Cached solved FunEqs]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
When trying to solve, say (FunExpensive big-type ~ ty), it's important
to see if we have reduced (FunExpensive big-type) before, lest we
simply repeat it.  Hence the lookup in inert_solved_funeqs.  Moreover
we must use `funEqCanDischarge` because both uses might (say) be Wanteds,
and we *still* want to save the re-computation.

Note [MATCHING-SYNONYMS]
~~~~~~~~~~~~~~~~~~~~~~~~
When trying to match a dictionary (D tau) to a top-level instance, or a
type family equation (F taus_1 ~ tau_2) to a top-level family instance,
we do *not* need to expand type synonyms because the matcher will do that for us.


Note [RHS-FAMILY-SYNONYMS]
~~~~~~~~~~~~~~~~~~~~~~~~~~
The RHS of a family instance is represented as yet another constructor which is
like a type synonym for the real RHS the programmer declared. Eg:
    type instance F (a,a) = [a]
Becomes:
    :R32 a = [a]      -- internal type synonym introduced
    F (a,a) ~ :R32 a  -- instance

When we react a family instance with a type family equation in the work list
we keep the synonym-using RHS without expansion.

Note [FunDep and implicit parameter reactions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Currently, our story of interacting two dictionaries (or a dictionary
and top-level instances) for functional dependencies, and implicit
paramters, is that we simply produce new Derived equalities.  So for example

        class D a b | a -&gt; b where ...
    Inert:
        d1 :g D Int Bool
    WorkItem:
        d2 :w D Int alpha

    We generate the extra work item
        cv :d alpha ~ Bool
    where 'cv' is currently unused.  However, this new item can perhaps be
    spontaneously solved to become given and react with d2,
    discharging it in favour of a new constraint d2' thus:
        d2' :w D Int Bool
        d2 := d2' |&gt; D Int cv
    Now d2' can be discharged from d1

We could be more aggressive and try to *immediately* solve the dictionary
using those extra equalities, but that requires those equalities to carry
evidence and derived do not carry evidence.

If that were the case with the same inert set and work item we might dischard
d2 directly:

        cv :w alpha ~ Bool
        d2 := d1 |&gt; D Int cv

But in general it's a bit painful to figure out the necessary coercion,
so we just take the first approach. Here is a better example. Consider:
    class C a b c | a -&gt; b
And:
     [Given]  d1 : C T Int Char
     [Wanted] d2 : C T beta Int
In this case, it's *not even possible* to solve the wanted immediately.
So we should simply output the functional dependency and add this guy
[but NOT its superclasses] back in the worklist. Even worse:
     [Given] d1 : C T Int beta
     [Wanted] d2: C T beta Int
Then it is solvable, but its very hard to detect this on the spot.

It's exactly the same with implicit parameters, except that the
&quot;aggressive&quot; approach would be much easier to implement.


Note [Weird fundeps]
~~~~~~~~~~~~~~~~~~~~
Consider   class Het a b | a -&gt; b where
              het :: m (f c) -&gt; a -&gt; m b

           class GHet (a :: * -&gt; *) (b :: * -&gt; *) | a -&gt; b
           instance            GHet (K a) (K [a])
           instance Het a b =&gt; GHet (K a) (K b)

The two instances don't actually conflict on their fundeps,
although it's pretty strange.  So they are both accepted. Now
try   [W] GHet (K Int) (K Bool)
This triggers fundeps from both instance decls;
      [D] K Bool ~ K [a]
      [D] K Bool ~ K beta
And there's a risk of complaining about Bool ~ [a].  But in fact
the Wanted matches the second instance, so we never get as far
as the fundeps.

Trac #7875 is a case in point.

Note [Overriding implicit parameters]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
   f :: (?x::a) -&gt; Bool -&gt; a

   g v = let ?x::Int = 3
         in (f v, let ?x::Bool = True in f v)

This should probably be well typed, with
   g :: Bool -&gt; (Int, Bool)

So the inner binding for ?x::Bool *overrides* the outer one.
Hence a work-item Given overrides an inert-item Given.
-}</span><span>
</span><a name="line-1744"></a><span>
</span><a name="line-1745"></a><span class="hs-comment">{- *******************************************************************
*                                                                    *
                       Class lookup
*                                                                    *
**********************************************************************-}</span><span>
</span><a name="line-1750"></a><span>
</span><a name="line-1751"></a><span class="hs-comment">-- | Indicates if Instance met the Safe Haskell overlapping instances safety</span><span>
</span><a name="line-1752"></a><span class="hs-comment">-- check.</span><span>
</span><a name="line-1753"></a><span class="hs-comment">--</span><span>
</span><a name="line-1754"></a><span class="hs-comment">-- See Note [Safe Haskell Overlapping Instances] in TcSimplify</span><span>
</span><a name="line-1755"></a><span class="hs-comment">-- See Note [Safe Haskell Overlapping Instances Implementation] in TcSimplify</span><span>
</span><a name="line-1756"></a><span class="hs-keyword">type</span><span> </span><a name="SafeOverlapping"><a href="TcInteract.html#SafeOverlapping"><span class="hs-identifier">SafeOverlapping</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1757"></a><span>
</span><a name="line-1758"></a><span class="hs-keyword">data</span><span> </span><a name="LookupInstResult"><a href="TcInteract.html#LookupInstResult"><span class="hs-identifier">LookupInstResult</span></a></a><span>
</span><a name="line-1759"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="NoInstance"><a href="TcInteract.html#NoInstance"><span class="hs-identifier">NoInstance</span></a></a><span>
</span><a name="line-1760"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="GenInst"><a href="TcInteract.html#GenInst"><span class="hs-identifier">GenInst</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="lir_new_theta"><a href="TcInteract.html#lir_new_theta"><span class="hs-identifier">lir_new_theta</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TcType.html#TcPredType"><span class="hs-identifier hs-type">TcPredType</span></a><span class="hs-special">]</span><span>
</span><a name="line-1761"></a><span>            </span><span class="hs-special">,</span><span> </span><a name="lir_mk_ev"><a href="TcInteract.html#lir_mk_ev"><span class="hs-identifier">lir_mk_ev</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TcEvidence.html#EvTerm"><span class="hs-identifier hs-type">EvTerm</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcEvidence.html#EvTerm"><span class="hs-identifier hs-type">EvTerm</span></a><span>
</span><a name="line-1762"></a><span>            </span><span class="hs-special">,</span><span> </span><a name="lir_safe_over"><a href="TcInteract.html#lir_safe_over"><span class="hs-identifier">lir_safe_over</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcInteract.html#SafeOverlapping"><span class="hs-identifier hs-type">SafeOverlapping</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1763"></a><span>
</span><a name="line-1764"></a><span class="hs-keyword">instance</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="TcInteract.html#LookupInstResult"><span class="hs-identifier hs-type">LookupInstResult</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1765"></a><span>  </span><a name="local-1912652361"><a href="Outputable.html#ppr"><span class="hs-identifier">ppr</span></a></a><span> </span><a href="TcInteract.html#NoInstance"><span class="hs-identifier hs-var">NoInstance</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;NoInstance&quot;</span><span>
</span><a name="line-1766"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="TcInteract.html#GenInst"><span class="hs-identifier hs-var">GenInst</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">lir_new_theta</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066517"><a href="#local-1628066517"><span class="hs-identifier">ev</span></a></a><span>
</span><a name="line-1767"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">lir_safe_over</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628066518"><a href="#local-1628066518"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1768"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;GenInst&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066517"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628066519"><span class="hs-identifier hs-var">ss</span></a><span class="hs-special">]</span><span>
</span><a name="line-1769"></a><span>    </span><span class="hs-keyword">where</span><span> </span><a name="local-1628066519"><a href="#local-1628066519"><span class="hs-identifier">ss</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-1628066518"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-string">&quot;[safe]&quot;</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-string">&quot;[unsafe]&quot;</span><span>
</span><a name="line-1770"></a><span>
</span><a name="line-1771"></a><span>
</span><a name="line-1772"></a><span class="hs-identifier">matchClassInst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#InertSet"><span class="hs-identifier hs-type">InertSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#CtLoc"><span class="hs-identifier hs-type">CtLoc</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="TcInteract.html#LookupInstResult"><span class="hs-identifier hs-type">LookupInstResult</span></a><span>
</span><a name="line-1773"></a><a name="matchClassInst"><a href="TcInteract.html#matchClassInst"><span class="hs-identifier">matchClassInst</span></a></a><span> </span><a name="local-1628066421"><a href="#local-1628066421"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-1628066422"><a href="#local-1628066422"><span class="hs-identifier">inerts</span></a></a><span> </span><a name="local-1628066423"><a href="#local-1628066423"><span class="hs-identifier">clas</span></a></a><span> </span><a name="local-1628066424"><a href="#local-1628066424"><span class="hs-identifier">tys</span></a></a><span> </span><a name="local-1628066425"><a href="#local-1628066425"><span class="hs-identifier">loc</span></a></a><span>
</span><a name="line-1774"></a><span class="hs-comment">-- First check whether there is an in-scope Given that could</span><span>
</span><a name="line-1775"></a><span class="hs-comment">-- match this constraint.  In that case, do not use top-level</span><span>
</span><a name="line-1776"></a><span class="hs-comment">-- instances.  See Note [Instance and Given overlap]</span><span>
</span><a name="line-1777"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="DynFlags.html#xopt"><span class="hs-identifier hs-var">xopt</span></a><span> </span><a href="../ghc-boot-8.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.html#IncoherentInstances"><span class="hs-identifier hs-var">LangExt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">IncoherentInstances</span></a><span> </span><a href="#local-1628066421"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1778"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Class.html#naturallyCoherentClass"><span class="hs-identifier hs-var">naturallyCoherentClass</span></a><span> </span><a href="#local-1628066423"><span class="hs-identifier hs-var">clas</span></a><span class="hs-special">)</span><span>
</span><a name="line-1779"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628066427"><a href="#local-1628066427"><span class="hs-identifier">matchable_givens</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#matchableGivens"><span class="hs-identifier hs-var">matchableGivens</span></a><span> </span><a href="#local-1628066425"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-1628066426"><span class="hs-identifier hs-var">pred</span></a><span> </span><a href="#local-1628066422"><span class="hs-identifier hs-var">inerts</span></a><span>
</span><a name="line-1780"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Bag.html#isEmptyBag"><span class="hs-identifier hs-var">isEmptyBag</span></a><span> </span><a href="#local-1628066427"><span class="hs-identifier hs-var">matchable_givens</span></a><span class="hs-special">)</span><span>
</span><a name="line-1781"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;Delaying instance application&quot;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1782"></a><span>           </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Work item=&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="TyCoRep.html#pprClassPred"><span class="hs-identifier hs-var">pprClassPred</span></a><span> </span><a href="#local-1628066423"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-1628066424"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1783"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Potential matching givens:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066427"><span class="hs-identifier hs-var">matchable_givens</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1784"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="TcInteract.html#NoInstance"><span class="hs-identifier hs-var">NoInstance</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1785"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1786"></a><span>     </span><a name="local-1628066426"><a href="#local-1628066426"><span class="hs-identifier">pred</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#mkClassPred"><span class="hs-identifier hs-var">mkClassPred</span></a><span> </span><a href="#local-1628066423"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-1628066424"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1787"></a><span>
</span><a name="line-1788"></a><span class="hs-identifier">matchClassInst</span><span> </span><a name="local-1628066428"><a href="#local-1628066428"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1628066429"><a href="#local-1628066429"><span class="hs-identifier">clas</span></a></a><span> </span><a name="local-1628066430"><a href="#local-1628066430"><span class="hs-identifier">tys</span></a></a><span> </span><a name="local-1628066431"><a href="#local-1628066431"><span class="hs-identifier">loc</span></a></a><span>
</span><a name="line-1789"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;matchClassInst&quot;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;pred =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#mkClassPred"><span class="hs-identifier hs-var">mkClassPred</span></a><span> </span><a href="#local-1628066429"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-1628066430"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1790"></a><span>      </span><span class="hs-special">;</span><span> </span><a name="local-1628066432"><a href="#local-1628066432"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcInteract.html#match_class_inst"><span class="hs-identifier hs-var">match_class_inst</span></a><span> </span><a href="#local-1628066428"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-1628066429"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-1628066430"><span class="hs-identifier hs-var">tys</span></a><span> </span><a href="#local-1628066431"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-1791"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;matchClassInst result&quot;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066432"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-1792"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-1628066432"><span class="hs-identifier hs-var">res</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1793"></a><span>
</span><a name="line-1794"></a><span class="hs-identifier">match_class_inst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#CtLoc"><span class="hs-identifier hs-type">CtLoc</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="TcInteract.html#LookupInstResult"><span class="hs-identifier hs-type">LookupInstResult</span></a><span>
</span><a name="line-1795"></a><a name="match_class_inst"><a href="TcInteract.html#match_class_inst"><span class="hs-identifier">match_class_inst</span></a></a><span> </span><a name="local-1628066433"><a href="#local-1628066433"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-1628066434"><a href="#local-1628066434"><span class="hs-identifier">clas</span></a></a><span> </span><a name="local-1628066435"><a href="#local-1628066435"><span class="hs-identifier">tys</span></a></a><span> </span><a name="local-1628066436"><a href="#local-1628066436"><span class="hs-identifier">loc</span></a></a><span>
</span><a name="line-1796"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628066437"><span class="hs-identifier hs-var">cls_name</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="PrelNames.html#knownNatClassName"><span class="hs-identifier hs-var">knownNatClassName</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TcInteract.html#matchKnownNat"><span class="hs-identifier hs-var">matchKnownNat</span></a><span>        </span><a href="#local-1628066434"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-1628066435"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1797"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628066437"><span class="hs-identifier hs-var">cls_name</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="PrelNames.html#knownSymbolClassName"><span class="hs-identifier hs-var">knownSymbolClassName</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcInteract.html#matchKnownSymbol"><span class="hs-identifier hs-var">matchKnownSymbol</span></a><span>     </span><a href="#local-1628066434"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-1628066435"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1798"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Type.html#isCTupleClass"><span class="hs-identifier hs-var">isCTupleClass</span></a><span> </span><a href="#local-1628066434"><span class="hs-identifier hs-var">clas</span></a><span>                </span><span class="hs-glyph">=</span><span> </span><a href="TcInteract.html#matchCTuple"><span class="hs-identifier hs-var">matchCTuple</span></a><span>          </span><a href="#local-1628066434"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-1628066435"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1799"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628066437"><span class="hs-identifier hs-var">cls_name</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="PrelNames.html#typeableClassName"><span class="hs-identifier hs-var">typeableClassName</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TcInteract.html#matchTypeable"><span class="hs-identifier hs-var">matchTypeable</span></a><span>        </span><a href="#local-1628066434"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-1628066435"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1800"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628066434"><span class="hs-identifier hs-var">clas</span></a><span> </span><span class="hs-special">`</span><a href="Unique.html#hasKey"><span class="hs-identifier hs-var">hasKey</span></a><span class="hs-special">`</span><span> </span><a href="PrelNames.html#heqTyConKey"><span class="hs-identifier hs-var">heqTyConKey</span></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="TcInteract.html#matchLiftedEquality"><span class="hs-identifier hs-var">matchLiftedEquality</span></a><span>       </span><a href="#local-1628066435"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1801"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628066434"><span class="hs-identifier hs-var">clas</span></a><span> </span><span class="hs-special">`</span><a href="Unique.html#hasKey"><span class="hs-identifier hs-var">hasKey</span></a><span class="hs-special">`</span><span> </span><a href="PrelNames.html#coercibleTyConKey"><span class="hs-identifier hs-var">coercibleTyConKey</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TcInteract.html#matchLiftedCoercible"><span class="hs-identifier hs-var">matchLiftedCoercible</span></a><span>      </span><a href="#local-1628066435"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1802"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>                         </span><span class="hs-glyph">=</span><span> </span><a href="TcInteract.html#matchInstEnv"><span class="hs-identifier hs-var">matchInstEnv</span></a><span> </span><a href="#local-1628066433"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-1628066434"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-1628066435"><span class="hs-identifier hs-var">tys</span></a><span> </span><a href="#local-1628066436"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-1803"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1804"></a><span>    </span><a name="local-1628066437"><a href="#local-1628066437"><span class="hs-identifier">cls_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">className</span><span> </span><a href="#local-1628066434"><span class="hs-identifier hs-var">clas</span></a><span>
</span><a name="line-1805"></a><span>
</span><a name="line-1806"></a><span class="hs-comment">{- Note [Instance and Given overlap]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Example, from the OutsideIn(X) paper:
       instance P x =&gt; Q [x]
       instance (x ~ y) =&gt; R y [x]

       wob :: forall a b. (Q [b], R b a) =&gt; a -&gt; Int

       g :: forall a. Q [a] =&gt; [a] -&gt; Int
       g x = wob x

This will generate the impliation constraint:
            Q [a] =&gt; (Q [beta], R beta [a])
If we react (Q [beta]) with its top-level axiom, we end up with a
(P beta), which we have no way of discharging. On the other hand,
if we react R beta [a] with the top-level we get  (beta ~ a), which
is solvable and can help us rewrite (Q [beta]) to (Q [a]) which is
now solvable by the given Q [a].

The solution is that:
  In matchClassInst (and thus in topReact), we return a matching
  instance only when there is no Given in the inerts which is
  unifiable to this particular dictionary.

  We treat any meta-tyvar as &quot;unifiable&quot; for this purpose,
  *including* untouchable ones

The end effect is that, much as we do for overlapping instances, we
delay choosing a class instance if there is a possibility of another
instance OR a given to match our constraint later on. This fixes
Trac #4981 and #5002.

Other notes:

* The check is done *first*, so that it also covers classes
  with built-in instance solving, such as
     - constraint tuples
     - natural numbers
     - Typeable

* The given-overlap problem is arguably not easy to appear in practice
  due to our aggressive prioritization of equality solving over other
  constraints, but it is possible. I've added a test case in
  typecheck/should-compile/GivenOverlapping.hs

* Another &quot;live&quot; example is Trac #10195; another is #10177.

* We ignore the overlap problem if -XIncoherentInstances is in force:
  see Trac #6002 for a worked-out example where this makes a
  difference.

* Moreover notice that our goals here are different than the goals of
  the top-level overlapping checks. There we are interested in
  validating the following principle:

      If we inline a function f at a site where the same global
      instance environment is available as the instance environment at
      the definition site of f then we should get the same behaviour.

  But for the Given Overlap check our goal is just related to completeness of
  constraint solving.
-}</span><span>
</span><a name="line-1868"></a><span>
</span><a name="line-1869"></a><span>
</span><a name="line-1870"></a><span class="hs-comment">{- *******************************************************************
*                                                                    *
                Class lookup in the instance environment
*                                                                    *
**********************************************************************-}</span><span>
</span><a name="line-1875"></a><span>
</span><a name="line-1876"></a><span class="hs-identifier">matchInstEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#CtLoc"><span class="hs-identifier hs-type">CtLoc</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="TcInteract.html#LookupInstResult"><span class="hs-identifier hs-type">LookupInstResult</span></a><span>
</span><a name="line-1877"></a><a name="matchInstEnv"><a href="TcInteract.html#matchInstEnv"><span class="hs-identifier">matchInstEnv</span></a></a><span> </span><a name="local-1628066438"><a href="#local-1628066438"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-1628066439"><a href="#local-1628066439"><span class="hs-identifier">clas</span></a></a><span> </span><a name="local-1628066440"><a href="#local-1628066440"><span class="hs-identifier">tys</span></a></a><span> </span><a name="local-1628066441"><a href="#local-1628066441"><span class="hs-identifier">loc</span></a></a><span>
</span><a name="line-1878"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628066449"><a href="#local-1628066449"><span class="hs-identifier">instEnvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getInstEnvs"><span class="hs-identifier hs-var">getInstEnvs</span></a><span>
</span><a name="line-1879"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628066450"><a href="#local-1628066450"><span class="hs-identifier">safeOverlapCheck</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">safeHaskell</span><span> </span><a href="#local-1628066438"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">`</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#elem"><span class="hs-identifier hs-var">elem</span></a><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><a href="DynFlags.html#Sf_Safe"><span class="hs-identifier hs-var">Sf_Safe</span></a><span class="hs-special">,</span><span> </span><a href="DynFlags.html#Sf_Trustworthy"><span class="hs-identifier hs-var">Sf_Trustworthy</span></a><span class="hs-special">]</span><span>
</span><a name="line-1880"></a><span>              </span><span class="hs-special">(</span><a name="local-1628066451"><a href="#local-1628066451"><span class="hs-identifier">matches</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628066452"><a href="#local-1628066452"><span class="hs-identifier">unify</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628066453"><a href="#local-1628066453"><span class="hs-identifier">unsafeOverlaps</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="InstEnv.html#lookupInstEnv"><span class="hs-identifier hs-var">lookupInstEnv</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-1628066449"><span class="hs-identifier hs-var">instEnvs</span></a><span> </span><a href="#local-1628066439"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-1628066440"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1881"></a><span>              </span><a name="local-1628066454"><a href="#local-1628066454"><span class="hs-identifier">safeHaskFail</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628066450"><span class="hs-identifier hs-var">safeOverlapCheck</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1628066453"><span class="hs-identifier hs-var">unsafeOverlaps</span></a><span class="hs-special">)</span><span>
</span><a name="line-1882"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-1628066451"><span class="hs-identifier hs-var">matches</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628066452"><span class="hs-identifier hs-var">unify</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628066454"><span class="hs-identifier hs-var">safeHaskFail</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1883"></a><span>
</span><a name="line-1884"></a><span>            </span><span class="hs-comment">-- Nothing matches</span><span>
</span><a name="line-1885"></a><span>            </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-1886"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;matchClass not matching&quot;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1887"></a><span>                        </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;dict&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066442"><span class="hs-identifier hs-var">pred</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1888"></a><span>                      </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="TcInteract.html#NoInstance"><span class="hs-identifier hs-var">NoInstance</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1889"></a><span>
</span><a name="line-1890"></a><span>            </span><span class="hs-comment">-- A single match (&amp; no safe haskell failure)</span><span>
</span><a name="line-1891"></a><span>            </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><a name="local-1628066455"><a href="#local-1628066455"><span class="hs-identifier">ispec</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628066456"><a href="#local-1628066456"><span class="hs-identifier">inst_tys</span></a></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span>
</span><a name="line-1892"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>   </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628066457"><a href="#local-1628066457"><span class="hs-identifier">dfun_id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="InstEnv.html#instanceDFunId"><span class="hs-identifier hs-var">instanceDFunId</span></a><span> </span><a href="#local-1628066455"><span class="hs-identifier hs-var">ispec</span></a><span>
</span><a name="line-1893"></a><span>                        </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;matchClass success&quot;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1894"></a><span>                          </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;dict&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066442"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">,</span><span>
</span><a name="line-1895"></a><span>                                </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;witness&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066457"><span class="hs-identifier hs-var">dfun_id</span></a><span>
</span><a name="line-1896"></a><span>                                               </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idType"><span class="hs-identifier hs-var">idType</span></a><span> </span><a href="#local-1628066457"><span class="hs-identifier hs-var">dfun_id</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1897"></a><span>                                  </span><span class="hs-comment">-- Record that this dfun is needed</span><span>
</span><a name="line-1898"></a><span>                        </span><span class="hs-special">;</span><span> </span><a href="#local-1628066443"><span class="hs-identifier hs-var">match_one</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1628066453"><span class="hs-identifier hs-var">unsafeOverlaps</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628066457"><span class="hs-identifier hs-var">dfun_id</span></a><span> </span><a href="#local-1628066456"><span class="hs-identifier hs-var">inst_tys</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1899"></a><span>
</span><a name="line-1900"></a><span>            </span><span class="hs-comment">-- More than one matches (or Safe Haskell fail!). Defer any</span><span>
</span><a name="line-1901"></a><span>            </span><span class="hs-comment">-- reactions of a multitude until we learn more about the reagent</span><span>
</span><a name="line-1902"></a><span>            </span><span class="hs-special">(</span><a name="local-1628066458"><a href="#local-1628066458"><span class="hs-identifier">matches</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-1903"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>   </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;matchClass multiple matches, deferring choice&quot;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1904"></a><span>                          </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;dict&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066442"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">,</span><span>
</span><a name="line-1905"></a><span>                                </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;matches&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066458"><span class="hs-identifier hs-var">matches</span></a><span class="hs-special">]</span><span>
</span><a name="line-1906"></a><span>                        </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="TcInteract.html#NoInstance"><span class="hs-identifier hs-var">NoInstance</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1907"></a><span>   </span><span class="hs-keyword">where</span><span>
</span><a name="line-1908"></a><span>     </span><a name="local-1628066442"><a href="#local-1628066442"><span class="hs-identifier">pred</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#mkClassPred"><span class="hs-identifier hs-var">mkClassPred</span></a><span> </span><a href="#local-1628066439"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-1628066440"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1909"></a><span>
</span><a name="line-1910"></a><span>     </span><span class="hs-identifier">match_one</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcInteract.html#SafeOverlapping"><span class="hs-identifier hs-type">SafeOverlapping</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#DFunId"><span class="hs-identifier hs-type">DFunId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="InstEnv.html#DFunInstType"><span class="hs-identifier hs-type">DFunInstType</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="TcInteract.html#LookupInstResult"><span class="hs-identifier hs-type">LookupInstResult</span></a><span>
</span><a name="line-1911"></a><span>                  </span><span class="hs-comment">-- See Note [DFunInstType: instantiating types] in InstEnv</span><span>
</span><a name="line-1912"></a><span>     </span><a name="local-1628066443"><a href="#local-1628066443"><span class="hs-identifier">match_one</span></a></a><span> </span><a name="local-1628066444"><a href="#local-1628066444"><span class="hs-identifier">so</span></a></a><span> </span><a name="local-1628066445"><a href="#local-1628066445"><span class="hs-identifier">dfun_id</span></a></a><span> </span><a name="local-1628066446"><a href="#local-1628066446"><span class="hs-identifier">mb_inst_tys</span></a></a><span>
</span><a name="line-1913"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#checkWellStagedDFun"><span class="hs-identifier hs-var">checkWellStagedDFun</span></a><span> </span><a href="#local-1628066442"><span class="hs-identifier hs-var">pred</span></a><span> </span><a href="#local-1628066445"><span class="hs-identifier hs-var">dfun_id</span></a><span> </span><a href="#local-1628066441"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-1914"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628066447"><a href="#local-1628066447"><span class="hs-identifier">tys</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628066448"><a href="#local-1628066448"><span class="hs-identifier">theta</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#instDFunType"><span class="hs-identifier hs-var">instDFunType</span></a><span> </span><a href="#local-1628066445"><span class="hs-identifier hs-var">dfun_id</span></a><span> </span><a href="#local-1628066446"><span class="hs-identifier hs-var">mb_inst_tys</span></a><span>
</span><a name="line-1915"></a><span>            </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcInteract.html#GenInst"><span class="hs-identifier hs-var">GenInst</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">lir_new_theta</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628066448"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-1916"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">lir_mk_ev</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TcEvidence.html#EvDFunApp"><span class="hs-identifier hs-var">EvDFunApp</span></a><span> </span><a href="#local-1628066445"><span class="hs-identifier hs-var">dfun_id</span></a><span> </span><a href="#local-1628066447"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1917"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">lir_safe_over</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628066444"><span class="hs-identifier hs-var">so</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1918"></a><span>
</span><a name="line-1919"></a><span>
</span><a name="line-1920"></a><span class="hs-comment">{- ********************************************************************
*                                                                     *
                   Class lookup for CTuples
*                                                                     *
***********************************************************************-}</span><span>
</span><a name="line-1925"></a><span>
</span><a name="line-1926"></a><span class="hs-identifier">matchCTuple</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="TcInteract.html#LookupInstResult"><span class="hs-identifier hs-type">LookupInstResult</span></a><span>
</span><a name="line-1927"></a><a name="matchCTuple"><a href="TcInteract.html#matchCTuple"><span class="hs-identifier">matchCTuple</span></a></a><span> </span><a name="local-1628066459"><a href="#local-1628066459"><span class="hs-identifier">clas</span></a></a><span> </span><a name="local-1628066460"><a href="#local-1628066460"><span class="hs-identifier">tys</span></a></a><span>   </span><span class="hs-comment">-- (isCTupleClass clas) holds</span><span>
</span><a name="line-1928"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="TcInteract.html#GenInst"><span class="hs-identifier hs-var">GenInst</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">lir_new_theta</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628066460"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1929"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">lir_mk_ev</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628066462"><span class="hs-identifier hs-var">tuple_ev</span></a><span>
</span><a name="line-1930"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">lir_safe_over</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1931"></a><span>            </span><span class="hs-comment">-- The dfun *is* the data constructor!</span><span>
</span><a name="line-1932"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1933"></a><span>     </span><a name="local-1628066461"><a href="#local-1628066461"><span class="hs-identifier">data_con</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCon.html#tyConSingleDataCon"><span class="hs-identifier hs-var">tyConSingleDataCon</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">classTyCon</span><span> </span><a href="#local-1628066459"><span class="hs-identifier hs-var">clas</span></a><span class="hs-special">)</span><span>
</span><a name="line-1934"></a><span>     </span><a name="local-1628066462"><a href="#local-1628066462"><span class="hs-identifier">tuple_ev</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcEvidence.html#EvDFunApp"><span class="hs-identifier hs-var">EvDFunApp</span></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#dataConWrapId"><span class="hs-identifier hs-var">dataConWrapId</span></a><span> </span><a href="#local-1628066461"><span class="hs-identifier hs-var">data_con</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628066460"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1935"></a><span>
</span><a name="line-1936"></a><span class="hs-comment">{- ********************************************************************
*                                                                     *
                   Class lookup for Literals
*                                                                     *
***********************************************************************-}</span><span>
</span><a name="line-1941"></a><span>
</span><a name="line-1942"></a><span class="hs-identifier">matchKnownNat</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="TcInteract.html#LookupInstResult"><span class="hs-identifier hs-type">LookupInstResult</span></a><span>
</span><a name="line-1943"></a><a name="matchKnownNat"><a href="TcInteract.html#matchKnownNat"><span class="hs-identifier">matchKnownNat</span></a></a><span> </span><a name="local-1628066463"><a href="#local-1628066463"><span class="hs-identifier">clas</span></a></a><span> </span><span class="hs-special">[</span><a name="local-1628066464"><a href="#local-1628066464"><span class="hs-identifier">ty</span></a></a><span class="hs-special">]</span><span>     </span><span class="hs-comment">-- clas = KnownNat</span><span>
</span><a name="line-1944"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628066465"><a href="#local-1628066465"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#isNumLitTy"><span class="hs-identifier hs-var">isNumLitTy</span></a><span> </span><a href="#local-1628066464"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcInteract.html#makeLitDict"><span class="hs-identifier hs-var">makeLitDict</span></a><span> </span><a href="#local-1628066463"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-1628066464"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#EvNum"><span class="hs-identifier hs-var">EvNum</span></a><span> </span><a href="#local-1628066465"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-1945"></a><span class="hs-identifier">matchKnownNat</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="TcInteract.html#NoInstance"><span class="hs-identifier hs-var">NoInstance</span></a><span>
</span><a name="line-1946"></a><span>
</span><a name="line-1947"></a><span class="hs-identifier">matchKnownSymbol</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="TcInteract.html#LookupInstResult"><span class="hs-identifier hs-type">LookupInstResult</span></a><span>
</span><a name="line-1948"></a><a name="matchKnownSymbol"><a href="TcInteract.html#matchKnownSymbol"><span class="hs-identifier">matchKnownSymbol</span></a></a><span> </span><a name="local-1628066466"><a href="#local-1628066466"><span class="hs-identifier">clas</span></a></a><span> </span><span class="hs-special">[</span><a name="local-1628066467"><a href="#local-1628066467"><span class="hs-identifier">ty</span></a></a><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- clas = KnownSymbol</span><span>
</span><a name="line-1949"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628066468"><a href="#local-1628066468"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#isStrLitTy"><span class="hs-identifier hs-var">isStrLitTy</span></a><span> </span><a href="#local-1628066467"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcInteract.html#makeLitDict"><span class="hs-identifier hs-var">makeLitDict</span></a><span> </span><a href="#local-1628066466"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-1628066467"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#EvStr"><span class="hs-identifier hs-var">EvStr</span></a><span> </span><a href="#local-1628066468"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-1950"></a><span class="hs-identifier">matchKnownSymbol</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="TcInteract.html#NoInstance"><span class="hs-identifier hs-var">NoInstance</span></a><span>
</span><a name="line-1951"></a><span>
</span><a name="line-1952"></a><span>
</span><a name="line-1953"></a><span class="hs-identifier">makeLitDict</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcEvidence.html#EvLit"><span class="hs-identifier hs-type">EvLit</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="TcInteract.html#LookupInstResult"><span class="hs-identifier hs-type">LookupInstResult</span></a><span>
</span><a name="line-1954"></a><span class="hs-comment">-- makeLitDict adds a coercion that will convert the literal into a dictionary</span><span>
</span><a name="line-1955"></a><span class="hs-comment">-- of the appropriate type.  See Note [KnownNat &amp; KnownSymbol and EvLit]</span><span>
</span><a name="line-1956"></a><span class="hs-comment">-- in TcEvidence.  The coercion happens in 2 steps:</span><span>
</span><a name="line-1957"></a><span class="hs-comment">--</span><span>
</span><a name="line-1958"></a><span class="hs-comment">--     Integer -&gt; SNat n     -- representation of literal to singleton</span><span>
</span><a name="line-1959"></a><span class="hs-comment">--     SNat n  -&gt; KnownNat n -- singleton to dictionary</span><span>
</span><a name="line-1960"></a><span class="hs-comment">--</span><span>
</span><a name="line-1961"></a><span class="hs-comment">--     The process is mirrored for Symbols:</span><span>
</span><a name="line-1962"></a><span class="hs-comment">--     String    -&gt; SSymbol n</span><span>
</span><a name="line-1963"></a><span class="hs-comment">--     SSymbol n -&gt; KnownSymbol n -}</span><span>
</span><a name="line-1964"></a><a name="makeLitDict"><a href="TcInteract.html#makeLitDict"><span class="hs-identifier">makeLitDict</span></a></a><span> </span><a name="local-1628066469"><a href="#local-1628066469"><span class="hs-identifier">clas</span></a></a><span> </span><a name="local-1628066470"><a href="#local-1628066470"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-1628066471"><a href="#local-1628066471"><span class="hs-identifier">evLit</span></a></a><span>
</span><a name="line-1965"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-1628066472"><a href="#local-1628066472"><span class="hs-identifier">co_dict</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInst.html#tcInstNewTyCon_maybe"><span class="hs-identifier hs-var">tcInstNewTyCon_maybe</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">classTyCon</span><span> </span><a href="#local-1628066469"><span class="hs-identifier hs-var">clas</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="#local-1628066470"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">]</span><span>
</span><a name="line-1966"></a><span>          </span><span class="hs-comment">-- co_dict :: KnownNat n ~ SNat n</span><span>
</span><a name="line-1967"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span> </span><a name="local-1628066473"><a href="#local-1628066473"><span class="hs-identifier">meth</span></a></a><span> </span><span class="hs-special">]</span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Class.html#classMethods"><span class="hs-identifier hs-var">classMethods</span></a><span> </span><a href="#local-1628066469"><span class="hs-identifier hs-var">clas</span></a><span>
</span><a name="line-1968"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628066474"><a href="#local-1628066474"><span class="hs-identifier">tcRep</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#tyConAppTyCon_maybe"><span class="hs-identifier hs-var">tyConAppTyCon_maybe</span></a><span> </span><span class="hs-comment">-- SNat</span><span>
</span><a name="line-1969"></a><span>                      </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Type.html#funResultTy"><span class="hs-identifier hs-var">funResultTy</span></a><span>         </span><span class="hs-comment">-- SNat n</span><span>
</span><a name="line-1970"></a><span>                      </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Type.html#dropForAlls"><span class="hs-identifier hs-var">dropForAlls</span></a><span>         </span><span class="hs-comment">-- KnownNat n =&gt; SNat n</span><span>
</span><a name="line-1971"></a><span>                      </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Id.html#idType"><span class="hs-identifier hs-var">idType</span></a><span> </span><a href="#local-1628066473"><span class="hs-identifier hs-var">meth</span></a><span>         </span><span class="hs-comment">-- forall n. KnownNat n =&gt; SNat n</span><span>
</span><a name="line-1972"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-1628066475"><a href="#local-1628066475"><span class="hs-identifier">co_rep</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInst.html#tcInstNewTyCon_maybe"><span class="hs-identifier hs-var">tcInstNewTyCon_maybe</span></a><span> </span><a href="#local-1628066474"><span class="hs-identifier hs-var">tcRep</span></a><span> </span><span class="hs-special">[</span><a href="#local-1628066470"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">]</span><span>
</span><a name="line-1973"></a><span>          </span><span class="hs-comment">-- SNat n ~ Integer</span><span>
</span><a name="line-1974"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628066476"><a href="#local-1628066476"><span class="hs-identifier">ev_tm</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcEvidence.html#mkEvCast"><span class="hs-identifier hs-var">mkEvCast</span></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#EvLit"><span class="hs-identifier hs-var">EvLit</span></a><span> </span><a href="#local-1628066471"><span class="hs-identifier hs-var">evLit</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#mkTcSymCo"><span class="hs-identifier hs-var">mkTcSymCo</span></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#mkTcTransCo"><span class="hs-identifier hs-var">mkTcTransCo</span></a><span> </span><a href="#local-1628066472"><span class="hs-identifier hs-var">co_dict</span></a><span> </span><a href="#local-1628066475"><span class="hs-identifier hs-var">co_rep</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1975"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcInteract.html#GenInst"><span class="hs-identifier hs-var">GenInst</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">lir_new_theta</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1976"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">lir_mk_ev</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628066476"><span class="hs-identifier hs-var">ev_tm</span></a><span>
</span><a name="line-1977"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">lir_safe_over</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1978"></a><span>
</span><a name="line-1979"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1980"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#panicTcS"><span class="hs-identifier hs-var">panicTcS</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Unexpected evidence for&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">className</span><span> </span><a href="#local-1628066469"><span class="hs-identifier hs-var">clas</span></a><span class="hs-special">)</span><span>
</span><a name="line-1981"></a><span>                     </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="Id.html#idType"><span class="hs-identifier hs-var">idType</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Class.html#classMethods"><span class="hs-identifier hs-var">classMethods</span></a><span> </span><a href="#local-1628066469"><span class="hs-identifier hs-var">clas</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1982"></a><span>
</span><a name="line-1983"></a><span>
</span><a name="line-1984"></a><span class="hs-comment">{- ********************************************************************
*                                                                     *
                   Class lookup for Typeable
*                                                                     *
***********************************************************************-}</span><span>
</span><a name="line-1989"></a><span>
</span><a name="line-1990"></a><span class="hs-comment">-- | Assumes that we've checked that this is the 'Typeable' class,</span><span>
</span><a name="line-1991"></a><span class="hs-comment">-- and it was applied to the correct argument.</span><span>
</span><a name="line-1992"></a><span class="hs-identifier">matchTypeable</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="TcInteract.html#LookupInstResult"><span class="hs-identifier hs-type">LookupInstResult</span></a><span>
</span><a name="line-1993"></a><a name="matchTypeable"><a href="TcInteract.html#matchTypeable"><span class="hs-identifier">matchTypeable</span></a></a><span> </span><a name="local-1628066477"><a href="#local-1628066477"><span class="hs-identifier">clas</span></a></a><span> </span><span class="hs-special">[</span><a name="local-1628066478"><a href="#local-1628066478"><span class="hs-identifier">k</span></a></a><span class="hs-special">,</span><a name="local-1628066479"><a href="#local-1628066479"><span class="hs-identifier">t</span></a></a><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- clas = Typeable</span><span>
</span><a name="line-1994"></a><span>  </span><span class="hs-comment">-- For the first two cases, See Note [No Typeable for polytypes or qualified types]</span><span>
</span><a name="line-1995"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Type.html#isForAllTy"><span class="hs-identifier hs-var">isForAllTy</span></a><span> </span><a href="#local-1628066478"><span class="hs-identifier hs-var">k</span></a><span>                      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="TcInteract.html#NoInstance"><span class="hs-identifier hs-var">NoInstance</span></a><span>   </span><span class="hs-comment">-- Polytype</span><span>
</span><a name="line-1996"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#isJust"><span class="hs-identifier hs-var">isJust</span></a><span> </span><span class="hs-special">(</span><a href="TcType.html#tcSplitPredFunTy_maybe"><span class="hs-identifier hs-var">tcSplitPredFunTy_maybe</span></a><span> </span><a href="#local-1628066479"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="TcInteract.html#NoInstance"><span class="hs-identifier hs-var">NoInstance</span></a><span>   </span><span class="hs-comment">-- Qualified type</span><span>
</span><a name="line-1997"></a><span>
</span><a name="line-1998"></a><span>  </span><span class="hs-comment">-- Now cases that do work</span><span>
</span><a name="line-1999"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628066478"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-special">`</span><a href="Type.html#eqType"><span class="hs-identifier hs-var">eqType</span></a><span class="hs-special">`</span><span> </span><a href="TysWiredIn.html#typeNatKind"><span class="hs-identifier hs-var">typeNatKind</span></a><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="TcInteract.html#doTyLit"><span class="hs-identifier hs-var">doTyLit</span></a><span> </span><a href="PrelNames.html#knownNatClassName"><span class="hs-identifier hs-var">knownNatClassName</span></a><span>    </span><a href="#local-1628066479"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-2000"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628066478"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-special">`</span><a href="Type.html#eqType"><span class="hs-identifier hs-var">eqType</span></a><span class="hs-special">`</span><span> </span><a href="TysWiredIn.html#typeSymbolKind"><span class="hs-identifier hs-var">typeSymbolKind</span></a><span>              </span><span class="hs-glyph">=</span><span> </span><a href="TcInteract.html#doTyLit"><span class="hs-identifier hs-var">doTyLit</span></a><span> </span><a href="PrelNames.html#knownSymbolClassName"><span class="hs-identifier hs-var">knownSymbolClassName</span></a><span> </span><a href="#local-1628066479"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-2001"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1628066480"><a href="#local-1628066480"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628066481"><a href="#local-1628066481"><span class="hs-identifier">ks</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-var">splitTyConApp_maybe</span></a><span> </span><a href="#local-1628066479"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-comment">-- See Note [Typeable (T a b c)]</span><span>
</span><a name="line-2002"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="TcInteract.html#onlyNamedBndrsApplied"><span class="hs-identifier hs-var">onlyNamedBndrsApplied</span></a><span> </span><a href="#local-1628066480"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-1628066481"><span class="hs-identifier hs-var">ks</span></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="TcInteract.html#doTyConApp"><span class="hs-identifier hs-var">doTyConApp</span></a><span> </span><a href="#local-1628066477"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-1628066479"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-1628066481"><span class="hs-identifier hs-var">ks</span></a><span>
</span><a name="line-2003"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1628066482"><a href="#local-1628066482"><span class="hs-identifier">f</span></a></a><span class="hs-special">,</span><a name="local-1628066483"><a href="#local-1628066483"><span class="hs-identifier">kt</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitAppTy_maybe"><span class="hs-identifier hs-var">splitAppTy_maybe</span></a><span> </span><a href="#local-1628066479"><span class="hs-identifier hs-var">t</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="TcInteract.html#doTyApp"><span class="hs-identifier hs-var">doTyApp</span></a><span>    </span><a href="#local-1628066477"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-1628066479"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-1628066482"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-1628066483"><span class="hs-identifier hs-var">kt</span></a><span>
</span><a name="line-2004"></a><span>
</span><a name="line-2005"></a><span class="hs-identifier">matchTypeable</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="TcInteract.html#NoInstance"><span class="hs-identifier hs-var">NoInstance</span></a><span>
</span><a name="line-2006"></a><span>
</span><a name="line-2007"></a><span class="hs-identifier">doTyConApp</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Kind"><span class="hs-identifier hs-type">Kind</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="TcInteract.html#LookupInstResult"><span class="hs-identifier hs-type">LookupInstResult</span></a><span>
</span><a name="line-2008"></a><span class="hs-comment">-- Representation for type constructor applied to some kinds</span><span>
</span><a name="line-2009"></a><a name="doTyConApp"><a href="TcInteract.html#doTyConApp"><span class="hs-identifier">doTyConApp</span></a></a><span> </span><a name="local-1628066484"><a href="#local-1628066484"><span class="hs-identifier">clas</span></a></a><span> </span><a name="local-1628066485"><a href="#local-1628066485"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-1628066486"><a href="#local-1628066486"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-2010"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcInteract.html#GenInst"><span class="hs-identifier hs-var">GenInst</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><a href="TcInteract.html#mk_typeable_pred"><span class="hs-identifier hs-var">mk_typeable_pred</span></a><span> </span><a href="#local-1628066484"><span class="hs-identifier hs-var">clas</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628066486"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-2011"></a><span>                     </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-1628066487"><a href="#local-1628066487"><span class="hs-identifier">tms</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcEvidence.html#EvTypeable"><span class="hs-identifier hs-var">EvTypeable</span></a><span> </span><a href="#local-1628066485"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcEvidence.html#EvTypeableTyCon"><span class="hs-identifier hs-var">EvTypeableTyCon</span></a><span> </span><a href="#local-1628066487"><span class="hs-identifier hs-var">tms</span></a><span class="hs-special">)</span><span>
</span><a name="line-2012"></a><span>                     </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-2013"></a><span>
</span><a name="line-2014"></a><span class="hs-comment">-- Representation for concrete kinds.  We just use the kind itself,</span><span>
</span><a name="line-2015"></a><span class="hs-comment">-- but first we must make sure that we've instantiated all kind-</span><span>
</span><a name="line-2016"></a><span class="hs-comment">-- polymorphism, but no more.</span><span>
</span><a name="line-2017"></a><span class="hs-identifier">onlyNamedBndrsApplied</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#KindOrType"><span class="hs-identifier hs-type">KindOrType</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-2018"></a><a name="onlyNamedBndrsApplied"><a href="TcInteract.html#onlyNamedBndrsApplied"><span class="hs-identifier">onlyNamedBndrsApplied</span></a></a><span> </span><a name="local-1628066488"><a href="#local-1628066488"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-1628066489"><a href="#local-1628066489"><span class="hs-identifier">ks</span></a></a><span>
</span><a name="line-2019"></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a><span> </span><a href="TyCoRep.html#isNamedBinder"><span class="hs-identifier hs-var">isNamedBinder</span></a><span> </span><a href="#local-1628066491"><span class="hs-identifier hs-var">used_bndrs</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-2020"></a><span>   </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#any"><span class="hs-identifier hs-var">any</span></a><span> </span><a href="TyCoRep.html#isNamedBinder"><span class="hs-identifier hs-var">isNamedBinder</span></a><span> </span><a href="#local-1628066492"><span class="hs-identifier hs-var">leftover_bndrs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2021"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-2022"></a><span>   </span><a name="local-1628066490"><a href="#local-1628066490"><span class="hs-identifier">bndrs</span></a></a><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConBinders</span><span> </span><a href="#local-1628066488"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-2023"></a><span>   </span><span class="hs-special">(</span><a name="local-1628066491"><a href="#local-1628066491"><span class="hs-identifier">used_bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628066492"><a href="#local-1628066492"><span class="hs-identifier">leftover_bndrs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#splitAtList"><span class="hs-identifier hs-var">splitAtList</span></a><span> </span><a href="#local-1628066489"><span class="hs-identifier hs-var">ks</span></a><span> </span><a href="#local-1628066490"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-2024"></a><span>
</span><a name="line-2025"></a><span class="hs-identifier">doTyApp</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#KindOrType"><span class="hs-identifier hs-type">KindOrType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="TcInteract.html#LookupInstResult"><span class="hs-identifier hs-type">LookupInstResult</span></a><span>
</span><a name="line-2026"></a><span class="hs-comment">-- Representation for an application of a type to a type-or-kind.</span><span>
</span><a name="line-2027"></a><span class="hs-comment">--  This may happen when the type expression starts with a type variable.</span><span>
</span><a name="line-2028"></a><span class="hs-comment">--  Example (ignoring kind parameter):</span><span>
</span><a name="line-2029"></a><span class="hs-comment">--    Typeable (f Int Char)                      --&gt;</span><span>
</span><a name="line-2030"></a><span class="hs-comment">--    (Typeable (f Int), Typeable Char)          --&gt;</span><span>
</span><a name="line-2031"></a><span class="hs-comment">--    (Typeable f, Typeable Int, Typeable Char)  --&gt; (after some simp. steps)</span><span>
</span><a name="line-2032"></a><span class="hs-comment">--    Typeable f</span><span>
</span><a name="line-2033"></a><a name="doTyApp"><a href="TcInteract.html#doTyApp"><span class="hs-identifier">doTyApp</span></a></a><span> </span><a name="local-1628066493"><a href="#local-1628066493"><span class="hs-identifier">clas</span></a></a><span> </span><a name="local-1628066494"><a href="#local-1628066494"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-1628066495"><a href="#local-1628066495"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-1628066496"><a href="#local-1628066496"><span class="hs-identifier">tk</span></a></a><span>
</span><a name="line-2034"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Type.html#isForAllTy"><span class="hs-identifier hs-var">isForAllTy</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a><span> </span><a href="#local-1628066495"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span>
</span><a name="line-2035"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="TcInteract.html#NoInstance"><span class="hs-identifier hs-var">NoInstance</span></a><span> </span><span class="hs-comment">-- We can't solve until we know the ctr.</span><span>
</span><a name="line-2036"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-2037"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcInteract.html#GenInst"><span class="hs-identifier hs-var">GenInst</span></a><span> </span><span class="hs-special">[</span><a href="TcInteract.html#mk_typeable_pred"><span class="hs-identifier hs-var">mk_typeable_pred</span></a><span> </span><a href="#local-1628066493"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-1628066495"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">,</span><span> </span><a href="TcInteract.html#mk_typeable_pred"><span class="hs-identifier hs-var">mk_typeable_pred</span></a><span> </span><a href="#local-1628066493"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-1628066496"><span class="hs-identifier hs-var">tk</span></a><span class="hs-special">]</span><span>
</span><a name="line-2038"></a><span>                     </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">[</span><a name="local-1628066497"><a href="#local-1628066497"><span class="hs-identifier">t1</span></a></a><span class="hs-special">,</span><a name="local-1628066498"><a href="#local-1628066498"><span class="hs-identifier">t2</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcEvidence.html#EvTypeable"><span class="hs-identifier hs-var">EvTypeable</span></a><span> </span><a href="#local-1628066494"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcEvidence.html#EvTypeableTyApp"><span class="hs-identifier hs-var">EvTypeableTyApp</span></a><span> </span><a href="#local-1628066497"><span class="hs-identifier hs-var">t1</span></a><span> </span><a href="#local-1628066498"><span class="hs-identifier hs-var">t2</span></a><span class="hs-special">)</span><span>
</span><a name="line-2039"></a><span>                     </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-2040"></a><span>
</span><a name="line-2041"></a><span class="hs-comment">-- Emit a `Typeable` constraint for the given type.</span><span>
</span><a name="line-2042"></a><span class="hs-identifier">mk_typeable_pred</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a><span>
</span><a name="line-2043"></a><a name="mk_typeable_pred"><a href="TcInteract.html#mk_typeable_pred"><span class="hs-identifier">mk_typeable_pred</span></a></a><span> </span><a name="local-1628066499"><a href="#local-1628066499"><span class="hs-identifier">clas</span></a></a><span> </span><a name="local-1628066500"><a href="#local-1628066500"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#mkClassPred"><span class="hs-identifier hs-var">mkClassPred</span></a><span> </span><a href="#local-1628066499"><span class="hs-identifier hs-var">clas</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a><span> </span><a href="#local-1628066500"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628066500"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2044"></a><span>
</span><a name="line-2045"></a><span>  </span><span class="hs-comment">-- Typeable is implied by KnownNat/KnownSymbol. In the case of a type literal</span><span>
</span><a name="line-2046"></a><span>  </span><span class="hs-comment">-- we generate a sub-goal for the appropriate class. See #10348 for what</span><span>
</span><a name="line-2047"></a><span>  </span><span class="hs-comment">-- happens when we fail to do this.</span><span>
</span><a name="line-2048"></a><span class="hs-identifier">doTyLit</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="TcInteract.html#LookupInstResult"><span class="hs-identifier hs-type">LookupInstResult</span></a><span>
</span><a name="line-2049"></a><a name="doTyLit"><a href="TcInteract.html#doTyLit"><span class="hs-identifier">doTyLit</span></a></a><span> </span><a name="local-1628066501"><a href="#local-1628066501"><span class="hs-identifier">kc</span></a></a><span> </span><a name="local-1628066502"><a href="#local-1628066502"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628066503"><a href="#local-1628066503"><span class="hs-identifier">kc_clas</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#tcLookupClass"><span class="hs-identifier hs-var">tcLookupClass</span></a><span> </span><a href="#local-1628066501"><span class="hs-identifier hs-var">kc</span></a><span>
</span><a name="line-2050"></a><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628066504"><a href="#local-1628066504"><span class="hs-identifier">kc_pred</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#mkClassPred"><span class="hs-identifier hs-var">mkClassPred</span></a><span> </span><a href="#local-1628066503"><span class="hs-identifier hs-var">kc_clas</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="#local-1628066502"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2051"></a><span>                        </span><a name="local-1628066505"><a href="#local-1628066505"><span class="hs-identifier">mk_ev</span></a></a><span> </span><span class="hs-special">[</span><a name="local-1628066506"><a href="#local-1628066506"><span class="hs-identifier">ev</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcEvidence.html#EvTypeable"><span class="hs-identifier hs-var">EvTypeable</span></a><span> </span><a href="#local-1628066502"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcEvidence.html#EvTypeableTyLit"><span class="hs-identifier hs-var">EvTypeableTyLit</span></a><span> </span><a href="#local-1628066506"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-2052"></a><span>                        </span><span class="hs-identifier">mk_ev</span><span> </span><span class="hs-identifier">_</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Panic.html#panic"><span class="hs-identifier hs-var">panic</span></a><span> </span><span class="hs-string">&quot;doTyLit&quot;</span><span>
</span><a name="line-2053"></a><span>                  </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="TcInteract.html#GenInst"><span class="hs-identifier hs-var">GenInst</span></a><span> </span><span class="hs-special">[</span><a href="#local-1628066504"><span class="hs-identifier hs-var">kc_pred</span></a><span class="hs-special">]</span><span> </span><a href="#local-1628066505"><span class="hs-identifier hs-var">mk_ev</span></a><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2054"></a><span>
</span><a name="line-2055"></a><span class="hs-comment">{- Note [Typeable (T a b c)]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
For type applications we always decompose using binary application,
vai doTyApp, until we get to a *kind* instantiation.  Exmaple
   Proxy :: forall k. k -&gt; *

To solve Typeable (Proxy (* -&gt; *) Maybe) we
  - First decompose with doTyApp,
    to get (Typeable (Proxy (* -&gt; *))) and Typeable Maybe
  - Then sovle (Typeable (Proxy (* -&gt; *))) with doTyConApp

If we attempt to short-cut by solving it all at once, via
doTyCOnAPp


Note [No Typeable for polytypes or qualified types]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We do not support impredicative typeable, such as
   Typeable (forall a. a-&gt;a)
   Typeable (Eq a =&gt; a -&gt; a)
   Typeable (() =&gt; Int)
   Typeable (((),()) =&gt; Int)

See Trac #9858.  For forall's the case is clear: we simply don't have
a TypeRep for them.  For qualified but not polymorphic types, like
(Eq a =&gt; a -&gt; a), things are murkier.  But:

 * We don't need a TypeRep for these things.  TypeReps are for
   monotypes only.

 * Perhaps we could treat `=&gt;` as another type constructor for `Typeable`
   purposes, and thus support things like `Eq Int =&gt; Int`, however,
   at the current state of affairs this would be an odd exception as
   no other class works with impredicative types.
   For now we leave it off, until we have a better story for impredicativity.
-}</span><span>
</span><a name="line-2091"></a><span>
</span><a name="line-2092"></a><span class="hs-identifier">solveCallStack</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcEvidence.html#EvCallStack"><span class="hs-identifier hs-type">EvCallStack</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2093"></a><a name="solveCallStack"><a href="TcInteract.html#solveCallStack"><span class="hs-identifier">solveCallStack</span></a></a><span> </span><a name="local-1628066507"><a href="#local-1628066507"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-1628066508"><a href="#local-1628066508"><span class="hs-identifier">ev_cs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2094"></a><span>  </span><span class="hs-comment">-- We're given ev_cs :: CallStack, but the evidence term should be a</span><span>
</span><a name="line-2095"></a><span>  </span><span class="hs-comment">-- dictionary, so we have to coerce ev_cs to a dictionary for</span><span>
</span><a name="line-2096"></a><span>  </span><span class="hs-comment">-- `IP ip CallStack`. See Note [Overview of implicit CallStacks]</span><span>
</span><a name="line-2097"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-1628066509"><a href="#local-1628066509"><span class="hs-identifier">ev_tm</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcEvidence.html#mkEvCast"><span class="hs-identifier hs-var">mkEvCast</span></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#EvCallStack"><span class="hs-identifier hs-var">EvCallStack</span></a><span> </span><a href="#local-1628066508"><span class="hs-identifier hs-var">ev_cs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#wrapIP"><span class="hs-identifier hs-var">wrapIP</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#ctEvPred"><span class="hs-identifier hs-var">ctEvPred</span></a><span> </span><a href="#local-1628066507"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2098"></a><span>  </span><a href="TcSMonad.html#setWantedEvBind"><span class="hs-identifier hs-var">setWantedEvBind</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#ctEvId"><span class="hs-identifier hs-var">ctEvId</span></a><span> </span><a href="#local-1628066507"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628066509"><span class="hs-identifier hs-var">ev_tm</span></a><span>
</span><a name="line-2099"></a><span>
</span><a name="line-2100"></a><span class="hs-comment">{- ********************************************************************
*                                                                     *
                   Class lookup for lifted equality
*                                                                     *
***********************************************************************-}</span><span>
</span><a name="line-2105"></a><span>
</span><a name="line-2106"></a><span class="hs-comment">-- See also Note [The equality types story] in TysPrim</span><span>
</span><a name="line-2107"></a><span class="hs-identifier">matchLiftedEquality</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="TcInteract.html#LookupInstResult"><span class="hs-identifier hs-type">LookupInstResult</span></a><span>
</span><a name="line-2108"></a><a name="matchLiftedEquality"><a href="TcInteract.html#matchLiftedEquality"><span class="hs-identifier">matchLiftedEquality</span></a></a><span> </span><a name="local-1628066510"><a href="#local-1628066510"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-2109"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="TcInteract.html#GenInst"><span class="hs-identifier hs-var">GenInst</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">lir_new_theta</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a><span> </span><a href="TysPrim.html#eqPrimTyCon"><span class="hs-identifier hs-var">eqPrimTyCon</span></a><span> </span><a href="#local-1628066510"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2110"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">lir_mk_ev</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TcEvidence.html#EvDFunApp"><span class="hs-identifier hs-var">EvDFunApp</span></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#dataConWrapId"><span class="hs-identifier hs-var">dataConWrapId</span></a><span> </span><a href="TysWiredIn.html#heqDataCon"><span class="hs-identifier hs-var">heqDataCon</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628066510"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-2111"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">lir_safe_over</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-2112"></a><span>
</span><a name="line-2113"></a><span class="hs-comment">-- See also Note [The equality types story] in TysPrim</span><span>
</span><a name="line-2114"></a><span class="hs-identifier">matchLiftedCoercible</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="TcInteract.html#LookupInstResult"><span class="hs-identifier hs-type">LookupInstResult</span></a><span>
</span><a name="line-2115"></a><a name="matchLiftedCoercible"><a href="TcInteract.html#matchLiftedCoercible"><span class="hs-identifier">matchLiftedCoercible</span></a></a><span> </span><a name="local-1628066511"><a href="#local-1628066511"><span class="hs-identifier">args</span></a></a><span class="hs-glyph">@</span><span class="hs-special">[</span><a name="local-1628066512"><a href="#local-1628066512"><span class="hs-identifier">k</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628066513"><a href="#local-1628066513"><span class="hs-identifier">t1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628066514"><a href="#local-1628066514"><span class="hs-identifier">t2</span></a></a><span class="hs-special">]</span><span>
</span><a name="line-2116"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="TcInteract.html#GenInst"><span class="hs-identifier hs-var">GenInst</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">lir_new_theta</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a><span> </span><a href="TysPrim.html#eqReprPrimTyCon"><span class="hs-identifier hs-var">eqReprPrimTyCon</span></a><span> </span><a href="#local-1628066515"><span class="hs-identifier hs-var">args'</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2117"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">lir_mk_ev</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TcEvidence.html#EvDFunApp"><span class="hs-identifier hs-var">EvDFunApp</span></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#dataConWrapId"><span class="hs-identifier hs-var">dataConWrapId</span></a><span> </span><a href="TysWiredIn.html#coercibleDataCon"><span class="hs-identifier hs-var">coercibleDataCon</span></a><span class="hs-special">)</span><span>
</span><a name="line-2118"></a><span>                                                </span><a href="#local-1628066511"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-2119"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">lir_safe_over</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-2120"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2121"></a><span>    </span><a name="local-1628066515"><a href="#local-1628066515"><span class="hs-identifier">args'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-1628066512"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628066512"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628066513"><span class="hs-identifier hs-var">t1</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628066514"><span class="hs-identifier hs-var">t2</span></a><span class="hs-special">]</span><span>
</span><a name="line-2122"></a><span class="hs-identifier">matchLiftedCoercible</span><span> </span><a name="local-1628066516"><a href="#local-1628066516"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;matchLiftedCoercible&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628066516"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-2123"></a></pre></body></html>