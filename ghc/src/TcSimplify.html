<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">TcSimplify</span><span class="hs-special">(</span><span>
</span><a name="line-4"></a><span>       </span><a href="TcSimplify.html#simplifyInfer"><span class="hs-identifier hs-var">simplifyInfer</span></a><span class="hs-special">,</span><span>
</span><a name="line-5"></a><span>       </span><a href="TcSimplify.html#growThetaTyVars"><span class="hs-identifier hs-var">growThetaTyVars</span></a><span class="hs-special">,</span><span>
</span><a name="line-6"></a><span>       </span><a href="TcSimplify.html#simplifyAmbiguityCheck"><span class="hs-identifier hs-var">simplifyAmbiguityCheck</span></a><span class="hs-special">,</span><span>
</span><a name="line-7"></a><span>       </span><a href="TcSimplify.html#simplifyDefault"><span class="hs-identifier hs-var">simplifyDefault</span></a><span class="hs-special">,</span><span>
</span><a name="line-8"></a><span>       </span><a href="TcSimplify.html#simplifyTop"><span class="hs-identifier hs-var">simplifyTop</span></a><span class="hs-special">,</span><span> </span><a href="TcSimplify.html#simplifyInteractive"><span class="hs-identifier hs-var">simplifyInteractive</span></a><span class="hs-special">,</span><span> </span><a href="TcSimplify.html#solveEqualities"><span class="hs-identifier hs-var">solveEqualities</span></a><span class="hs-special">,</span><span>
</span><a name="line-9"></a><span>       </span><a href="TcSimplify.html#simplifyWantedsTcM"><span class="hs-identifier hs-var">simplifyWantedsTcM</span></a><span class="hs-special">,</span><span>
</span><a name="line-10"></a><span>       </span><a href="TcSimplify.html#tcCheckSatisfiability"><span class="hs-identifier hs-var">tcCheckSatisfiability</span></a><span class="hs-special">,</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span>       </span><span class="hs-comment">-- For Rules we need these</span><span>
</span><a name="line-13"></a><span>       </span><a href="TcSimplify.html#solveWanteds"><span class="hs-identifier hs-var">solveWanteds</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#runTcSDeriveds"><span class="hs-identifier hs-var">runTcSDeriveds</span></a><span>
</span><a name="line-14"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-15"></a><span>
</span><a name="line-16"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><a href="Bag.html"><span class="hs-identifier">Bag</span></a><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><a href="Class.html"><span class="hs-identifier">Class</span></a><span>         </span><span class="hs-special">(</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span class="hs-special">,</span><span> </span><a href="Class.html#classKey"><span class="hs-identifier hs-var">classKey</span></a><span class="hs-special">,</span><span> </span><a href="Class.html#classTyCon"><span class="hs-identifier hs-var">classTyCon</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><a href="DynFlags.html"><span class="hs-identifier">DynFlags</span></a><span>      </span><span class="hs-special">(</span><span> </span><a href="DynFlags.html#WarningFlag"><span class="hs-identifier hs-type">WarningFlag</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="DynFlags.html#Opt_WarnMonomorphism"><span class="hs-identifier hs-var">Opt_WarnMonomorphism</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-21"></a><span>                     </span><span class="hs-special">,</span><span> </span><a href="DynFlags.html#WarnReason"><span class="hs-identifier hs-type">WarnReason</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="DynFlags.html#Reason"><span class="hs-identifier hs-var">Reason</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-22"></a><span>                     </span><span class="hs-special">,</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span class="hs-special">(</span><span> </span><span class="hs-identifier">solverIterations</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="Inst.html"><span class="hs-identifier">Inst</span></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><a href="ListSetOps.html"><span class="hs-identifier">ListSetOps</span></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="Maybes.html"><span class="hs-identifier">Maybes</span></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="Name.html"><span class="hs-identifier">Name</span></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="Outputable.html"><span class="hs-identifier">Outputable</span></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="Pair.html"><span class="hs-identifier">Pair</span></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="PrelInfo.html"><span class="hs-identifier">PrelInfo</span></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="PrelNames.html"><span class="hs-identifier">PrelNames</span></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="TcErrors.html"><span class="hs-identifier">TcErrors</span></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><a href="TcEvidence.html"><span class="hs-identifier">TcEvidence</span></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="TcInteract.html"><span class="hs-identifier">TcInteract</span></a><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><a href="TcCanonical.html"><span class="hs-identifier">TcCanonical</span></a><span>   </span><span class="hs-special">(</span><span> </span><a href="TcCanonical.html#makeSuperClasses"><span class="hs-identifier hs-var">makeSuperClasses</span></a><span class="hs-special">,</span><span> </span><a href="TcCanonical.html#mkGivensWithSuperClasses"><span class="hs-identifier hs-var">mkGivensWithSuperClasses</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><a href="TcMType.html"><span class="hs-identifier">TcMType</span></a><span>   </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TcM</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TcM</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><a href="TcSMonad.html"><span class="hs-identifier">TcSMonad</span></a><span>  </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TcS</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><a href="TcType.html"><span class="hs-identifier">TcType</span></a><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><a href="TrieMap.html"><span class="hs-identifier">TrieMap</span></a><span>       </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- DV: for now</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><a href="Type.html"><span class="hs-identifier">Type</span></a><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><a href="TysWiredIn.html"><span class="hs-identifier">TysWiredIn</span></a><span>    </span><span class="hs-special">(</span><span> </span><a href="TysWiredIn.html#ptrRepLiftedTy"><span class="hs-identifier hs-var">ptrRepLiftedTy</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><a href="Unify.html"><span class="hs-identifier">Unify</span></a><span>         </span><span class="hs-special">(</span><span> </span><a href="Unify.html#tcMatchTy"><span class="hs-identifier hs-var">tcMatchTy</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><a href="Util.html"><span class="hs-identifier">Util</span></a><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><a href="Var.html"><span class="hs-identifier">Var</span></a><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><a href="VarSet.html"><span class="hs-identifier">VarSet</span></a><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><a href="BasicTypes.html"><span class="hs-identifier">BasicTypes</span></a><span>    </span><span class="hs-special">(</span><span> </span><a href="BasicTypes.html#IntWithInf"><span class="hs-identifier hs-type">IntWithInf</span></a><span class="hs-special">,</span><span> </span><a href="BasicTypes.html#intGtLimit"><span class="hs-identifier hs-var">intGtLimit</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><a href="ErrUtils.html"><span class="hs-identifier">ErrUtils</span></a><span>      </span><span class="hs-special">(</span><span> </span><a href="ErrUtils.html#emptyMessages"><span class="hs-identifier hs-var">emptyMessages</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="../ghc-boot-8.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.html"><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">LanguageExtensions</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">LangExt</span><span>
</span><a name="line-49"></a><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html"><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.List.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span></a><span>     </span><span class="hs-special">(</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.OldList.html#partition"><span class="hs-identifier hs-var">partition</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Foldable</span></a><span>    </span><span class="hs-special">(</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#fold"><span class="hs-identifier hs-var">fold</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-53"></a><span>
</span><a name="line-54"></a><span class="hs-comment">{-
*********************************************************************************
*                                                                               *
*                           External interface                                  *
*                                                                               *
*********************************************************************************
-}</span><span>
</span><a name="line-61"></a><span>
</span><a name="line-62"></a><span class="hs-identifier">simplifyTop</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><a href="Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a><span> </span><a href="TcEvidence.html#EvBind"><span class="hs-identifier hs-type">EvBind</span></a><span class="hs-special">)</span><span>
</span><a name="line-63"></a><span class="hs-comment">-- Simplify top-level constraints</span><span>
</span><a name="line-64"></a><span class="hs-comment">-- Usually these will be implications,</span><span>
</span><a name="line-65"></a><span class="hs-comment">-- but when there is nothing to quantify we don't wrap</span><span>
</span><a name="line-66"></a><span class="hs-comment">-- in a degenerate implication, so we do that here instead</span><span>
</span><a name="line-67"></a><a name="simplifyTop"><a href="TcSimplify.html#simplifyTop"><span class="hs-identifier">simplifyTop</span></a></a><span> </span><a name="local-1628069490"><a href="#local-1628069490"><span class="hs-identifier">wanteds</span></a></a><span>
</span><a name="line-68"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;simplifyTop {&quot;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;wanted = &quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069490"><span class="hs-identifier hs-var">wanteds</span></a><span>
</span><a name="line-69"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-1628069493"><a href="#local-1628069493"><span class="hs-identifier">final_wc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628069494"><a href="#local-1628069494"><span class="hs-identifier">unsafe_ol</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-1628069495"><a href="#local-1628069495"><span class="hs-identifier">binds1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#runTcS"><span class="hs-identifier hs-var">runTcS</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-70"></a><span>            </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628069491"><a href="#local-1628069491"><span class="hs-identifier">final_wc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#simpl_top"><span class="hs-identifier hs-var">simpl_top</span></a><span> </span><a href="#local-1628069490"><span class="hs-identifier hs-var">wanteds</span></a><span>
</span><a name="line-71"></a><span>               </span><span class="hs-special">;</span><span> </span><a name="local-1628069492"><a href="#local-1628069492"><span class="hs-identifier">unsafe_ol</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getSafeOverlapFailures"><span class="hs-identifier hs-var">getSafeOverlapFailures</span></a><span>
</span><a name="line-72"></a><span>               </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628069491"><span class="hs-identifier hs-var">final_wc</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628069492"><span class="hs-identifier hs-var">unsafe_ol</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-73"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;End simplifyTop }&quot;</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-74"></a><span>
</span><a name="line-75"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;reportUnsolved {&quot;</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-76"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628069496"><a href="#local-1628069496"><span class="hs-identifier">binds2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcErrors.html#reportUnsolved"><span class="hs-identifier hs-var">reportUnsolved</span></a><span> </span><a href="#local-1628069493"><span class="hs-identifier hs-var">final_wc</span></a><span>
</span><a name="line-77"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;reportUnsolved }&quot;</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-78"></a><span>
</span><a name="line-79"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;reportUnsolved (unsafe overlapping) {&quot;</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-80"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#isEmptyCts"><span class="hs-identifier hs-var">isEmptyCts</span></a><span> </span><a href="#local-1628069494"><span class="hs-identifier hs-var">unsafe_ol</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-81"></a><span>           </span><span class="hs-comment">-- grab current error messages and clear, warnAllUnsolved will</span><span>
</span><a name="line-82"></a><span>           </span><span class="hs-comment">-- update error messages which we'll grab and then restore saved</span><span>
</span><a name="line-83"></a><span>           </span><span class="hs-comment">-- messages.</span><span>
</span><a name="line-84"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-1628069497"><a href="#local-1628069497"><span class="hs-identifier">errs_var</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getErrsVar"><span class="hs-identifier hs-var">getErrsVar</span></a><span>
</span><a name="line-85"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-1628069498"><a href="#local-1628069498"><span class="hs-identifier">saved_msg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">TcM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">readTcRef</span></a><span> </span><a href="#local-1628069497"><span class="hs-identifier hs-var">errs_var</span></a><span>
</span><a name="line-86"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#writeTcRef"><span class="hs-identifier hs-var">TcM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">writeTcRef</span></a><span> </span><a href="#local-1628069497"><span class="hs-identifier hs-var">errs_var</span></a><span> </span><a href="ErrUtils.html#emptyMessages"><span class="hs-identifier hs-var">emptyMessages</span></a><span>
</span><a name="line-87"></a><span>
</span><a name="line-88"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="TcErrors.html#warnAllUnsolved"><span class="hs-identifier hs-var">warnAllUnsolved</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcRnTypes.html#WC"><span class="hs-identifier hs-var">WC</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wc_simple</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069494"><span class="hs-identifier hs-var">unsafe_ol</span></a><span>
</span><a name="line-89"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">wc_insol</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#emptyCts"><span class="hs-identifier hs-var">emptyCts</span></a><span>
</span><a name="line-90"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">wc_impl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Bag.html#emptyBag"><span class="hs-identifier hs-var">emptyBag</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-91"></a><span>
</span><a name="line-92"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-1628069499"><a href="#local-1628069499"><span class="hs-identifier">whyUnsafe</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">TcM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">readTcRef</span></a><span> </span><a href="#local-1628069497"><span class="hs-identifier hs-var">errs_var</span></a><span>
</span><a name="line-93"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#writeTcRef"><span class="hs-identifier hs-var">TcM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">writeTcRef</span></a><span> </span><a href="#local-1628069497"><span class="hs-identifier hs-var">errs_var</span></a><span> </span><a href="#local-1628069498"><span class="hs-identifier hs-var">saved_msg</span></a><span>
</span><a name="line-94"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#recordUnsafeInfer"><span class="hs-identifier hs-var">recordUnsafeInfer</span></a><span> </span><a href="#local-1628069499"><span class="hs-identifier hs-var">whyUnsafe</span></a><span>
</span><a name="line-95"></a><span>           </span><span class="hs-special">}</span><span>
</span><a name="line-96"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;reportUnsolved (unsafe overlapping) }&quot;</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-97"></a><span>
</span><a name="line-98"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#evBindMapBinds"><span class="hs-identifier hs-var">evBindMapBinds</span></a><span> </span><a href="#local-1628069495"><span class="hs-identifier hs-var">binds1</span></a><span> </span><span class="hs-special">`</span><a href="Bag.html#unionBags"><span class="hs-identifier hs-var">unionBags</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628069496"><span class="hs-identifier hs-var">binds2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-99"></a><span>
</span><a name="line-100"></a><span class="hs-comment">-- | Type-check a thing that emits only equality constraints, then</span><span>
</span><a name="line-101"></a><span class="hs-comment">-- solve those constraints. Fails outright if there is trouble.</span><span>
</span><a name="line-102"></a><span class="hs-identifier">solveEqualities</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="#local-1628069489"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="#local-1628069489"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-103"></a><a name="solveEqualities"><a href="TcSimplify.html#solveEqualities"><span class="hs-identifier">solveEqualities</span></a></a><span> </span><a name="local-1628069500"><a href="#local-1628069500"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-104"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#checkNoErrs"><span class="hs-identifier hs-var">checkNoErrs</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>  </span><span class="hs-comment">-- See Note [Fail fast on kind errors]</span><span>
</span><a name="line-105"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-1628069501"><a href="#local-1628069501"><span class="hs-identifier">result</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628069502"><a href="#local-1628069502"><span class="hs-identifier">wanted</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#captureConstraints"><span class="hs-identifier hs-var">captureConstraints</span></a><span> </span><a href="#local-1628069500"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-106"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;solveEqualities {&quot;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;wanted = &quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069502"><span class="hs-identifier hs-var">wanted</span></a><span>
</span><a name="line-107"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628069503"><a href="#local-1628069503"><span class="hs-identifier">final_wc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#runTcSEqualities"><span class="hs-identifier hs-var">runTcSEqualities</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcSimplify.html#simpl_top"><span class="hs-identifier hs-var">simpl_top</span></a><span> </span><a href="#local-1628069502"><span class="hs-identifier hs-var">wanted</span></a><span>
</span><a name="line-108"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;End solveEqualities }&quot;</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-109"></a><span>
</span><a name="line-110"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;reportAllUnsolved {&quot;</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-111"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcErrors.html#reportAllUnsolved"><span class="hs-identifier hs-var">reportAllUnsolved</span></a><span> </span><a href="#local-1628069503"><span class="hs-identifier hs-var">final_wc</span></a><span>
</span><a name="line-112"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;reportAllUnsolved }&quot;</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-113"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-1628069501"><span class="hs-identifier hs-var">result</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-114"></a><span>
</span><a name="line-115"></a><span class="hs-identifier">simpl_top</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="TcRnTypes.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a><span>
</span><a name="line-116"></a><span>    </span><span class="hs-comment">-- See Note [Top-level Defaulting Plan]</span><span>
</span><a name="line-117"></a><a name="simpl_top"><a href="TcSimplify.html#simpl_top"><span class="hs-identifier">simpl_top</span></a></a><span> </span><a name="local-1628069504"><a href="#local-1628069504"><span class="hs-identifier">wanteds</span></a></a><span>
</span><a name="line-118"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628069517"><a href="#local-1628069517"><span class="hs-identifier">wc_first_go</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#nestTcS"><span class="hs-identifier hs-var">nestTcS</span></a><span> </span><span class="hs-special">(</span><a href="TcSimplify.html#solveWantedsAndDrop"><span class="hs-identifier hs-var">solveWantedsAndDrop</span></a><span> </span><a href="#local-1628069504"><span class="hs-identifier hs-var">wanteds</span></a><span class="hs-special">)</span><span>
</span><a name="line-119"></a><span>                            </span><span class="hs-comment">-- This is where the main work happens</span><span>
</span><a name="line-120"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="#local-1628069505"><span class="hs-identifier hs-var">try_tyvar_defaulting</span></a><span> </span><a href="#local-1628069517"><span class="hs-identifier hs-var">wc_first_go</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-121"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-122"></a><span>    </span><span class="hs-identifier">try_tyvar_defaulting</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="TcRnTypes.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a><span>
</span><a name="line-123"></a><span>    </span><a name="local-1628069505"><a href="#local-1628069505"><span class="hs-identifier">try_tyvar_defaulting</span></a></a><span> </span><a name="local-1628069508"><a href="#local-1628069508"><span class="hs-identifier">wc</span></a></a><span>
</span><a name="line-124"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="TcRnTypes.html#isEmptyWC"><span class="hs-identifier hs-var">isEmptyWC</span></a><span> </span><a href="#local-1628069508"><span class="hs-identifier hs-var">wc</span></a><span>
</span><a name="line-125"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-1628069508"><span class="hs-identifier hs-var">wc</span></a><span>
</span><a name="line-126"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-127"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628069509"><a href="#local-1628069509"><span class="hs-identifier">free_tvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#zonkTyCoVarsAndFV"><span class="hs-identifier hs-var">TcS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">zonkTyCoVarsAndFV</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#tyCoVarsOfWC"><span class="hs-identifier hs-var">tyCoVarsOfWC</span></a><span> </span><a href="#local-1628069508"><span class="hs-identifier hs-var">wc</span></a><span class="hs-special">)</span><span>
</span><a name="line-128"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628069510"><a href="#local-1628069510"><span class="hs-identifier">meta_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#varSetElems"><span class="hs-identifier hs-var">varSetElems</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-129"></a><span>                            </span><a href="VarSet.html#filterVarSet"><span class="hs-identifier hs-var">filterVarSet</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="Util.html#%3C%26%26%3E"><span class="hs-operator hs-var">&lt;&amp;&amp;&gt;</span></a><span> </span><a href="TcType.html#isMetaTyVar"><span class="hs-identifier hs-var">isMetaTyVar</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628069509"><span class="hs-identifier hs-var">free_tvs</span></a><span>
</span><a name="line-130"></a><span>                   </span><span class="hs-comment">-- zonkTyCoVarsAndFV: the wc_first_go is not yet zonked</span><span>
</span><a name="line-131"></a><span>                   </span><span class="hs-comment">-- filter isMetaTyVar: we might have runtime-skolems in GHCi,</span><span>
</span><a name="line-132"></a><span>                   </span><span class="hs-comment">-- and we definitely don't want to try to assign to those!</span><span>
</span><a name="line-133"></a><span>                   </span><span class="hs-comment">-- the isTyVar needs to weed out coercion variables</span><span>
</span><a name="line-134"></a><span>
</span><a name="line-135"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-1628069511"><a href="#local-1628069511"><span class="hs-identifier">defaulted</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><a href="TcSimplify.html#defaultTyVarTcS"><span class="hs-identifier hs-var">defaultTyVarTcS</span></a><span> </span><a href="#local-1628069510"><span class="hs-identifier hs-var">meta_tvs</span></a><span>   </span><span class="hs-comment">-- Has unification side effects</span><span>
</span><a name="line-136"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#or"><span class="hs-identifier hs-var">or</span></a><span> </span><a href="#local-1628069511"><span class="hs-identifier hs-var">defaulted</span></a><span>
</span><a name="line-137"></a><span>             </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628069512"><a href="#local-1628069512"><span class="hs-identifier">wc_residual</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#nestTcS"><span class="hs-identifier hs-var">nestTcS</span></a><span> </span><span class="hs-special">(</span><a href="TcSimplify.html#solveWanteds"><span class="hs-identifier hs-var">solveWanteds</span></a><span> </span><a href="#local-1628069508"><span class="hs-identifier hs-var">wc</span></a><span class="hs-special">)</span><span>
</span><a name="line-138"></a><span>                            </span><span class="hs-comment">-- See Note [Must simplify after defaulting]</span><span>
</span><a name="line-139"></a><span>                     </span><span class="hs-special">;</span><span> </span><a href="#local-1628069506"><span class="hs-identifier hs-var">try_class_defaulting</span></a><span> </span><a href="#local-1628069512"><span class="hs-identifier hs-var">wc_residual</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-140"></a><span>             </span><span class="hs-keyword">else</span><span> </span><a href="#local-1628069506"><span class="hs-identifier hs-var">try_class_defaulting</span></a><span> </span><a href="#local-1628069508"><span class="hs-identifier hs-var">wc</span></a><span> </span><span class="hs-special">}</span><span>     </span><span class="hs-comment">-- No defaulting took place</span><span>
</span><a name="line-141"></a><span>
</span><a name="line-142"></a><span>    </span><span class="hs-identifier">try_class_defaulting</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="TcRnTypes.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a><span>
</span><a name="line-143"></a><span>    </span><a name="local-1628069506"><a href="#local-1628069506"><span class="hs-identifier">try_class_defaulting</span></a></a><span> </span><a name="local-1628069513"><a href="#local-1628069513"><span class="hs-identifier">wc</span></a></a><span>
</span><a name="line-144"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="TcRnTypes.html#isEmptyWC"><span class="hs-identifier hs-var">isEmptyWC</span></a><span> </span><a href="#local-1628069513"><span class="hs-identifier hs-var">wc</span></a><span>
</span><a name="line-145"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-1628069513"><span class="hs-identifier hs-var">wc</span></a><span>
</span><a name="line-146"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>  </span><span class="hs-comment">-- See Note [When to do type-class defaulting]</span><span>
</span><a name="line-147"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628069514"><a href="#local-1628069514"><span class="hs-identifier">something_happened</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#applyDefaultingRules"><span class="hs-identifier hs-var">applyDefaultingRules</span></a><span> </span><a href="#local-1628069513"><span class="hs-identifier hs-var">wc</span></a><span>
</span><a name="line-148"></a><span>                                   </span><span class="hs-comment">-- See Note [Top-level Defaulting Plan]</span><span>
</span><a name="line-149"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-1628069514"><span class="hs-identifier hs-var">something_happened</span></a><span>
</span><a name="line-150"></a><span>             </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628069515"><a href="#local-1628069515"><span class="hs-identifier">wc_residual</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#nestTcS"><span class="hs-identifier hs-var">nestTcS</span></a><span> </span><span class="hs-special">(</span><a href="TcSimplify.html#solveWantedsAndDrop"><span class="hs-identifier hs-var">solveWantedsAndDrop</span></a><span> </span><a href="#local-1628069513"><span class="hs-identifier hs-var">wc</span></a><span class="hs-special">)</span><span>
</span><a name="line-151"></a><span>                     </span><span class="hs-special">;</span><span> </span><a href="#local-1628069506"><span class="hs-identifier hs-var">try_class_defaulting</span></a><span> </span><a href="#local-1628069515"><span class="hs-identifier hs-var">wc_residual</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-152"></a><span>                  </span><span class="hs-comment">-- See Note [Overview of implicit CallStacks] in TcEvidence</span><span>
</span><a name="line-153"></a><span>             </span><span class="hs-keyword">else</span><span> </span><a href="#local-1628069507"><span class="hs-identifier hs-var">try_callstack_defaulting</span></a><span> </span><a href="#local-1628069513"><span class="hs-identifier hs-var">wc</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-154"></a><span>
</span><a name="line-155"></a><span>    </span><span class="hs-identifier">try_callstack_defaulting</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="TcRnTypes.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a><span>
</span><a name="line-156"></a><span>    </span><a name="local-1628069507"><a href="#local-1628069507"><span class="hs-identifier">try_callstack_defaulting</span></a></a><span> </span><a name="local-1628069516"><a href="#local-1628069516"><span class="hs-identifier">wc</span></a></a><span>
</span><a name="line-157"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="TcRnTypes.html#isEmptyWC"><span class="hs-identifier hs-var">isEmptyWC</span></a><span> </span><a href="#local-1628069516"><span class="hs-identifier hs-var">wc</span></a><span>
</span><a name="line-158"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-1628069516"><span class="hs-identifier hs-var">wc</span></a><span>
</span><a name="line-159"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-160"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcSimplify.html#defaultCallStacks"><span class="hs-identifier hs-var">defaultCallStacks</span></a><span> </span><a href="#local-1628069516"><span class="hs-identifier hs-var">wc</span></a><span>
</span><a name="line-161"></a><span>
</span><a name="line-162"></a><span class="hs-comment">-- | Default any remaining @CallStack@ constraints to empty @CallStack@s.</span><span>
</span><a name="line-163"></a><span class="hs-identifier">defaultCallStacks</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="TcRnTypes.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a><span>
</span><a name="line-164"></a><span class="hs-comment">-- See Note [Overview of implicit CallStacks] in TcEvidence</span><span>
</span><a name="line-165"></a><a name="defaultCallStacks"><a href="TcSimplify.html#defaultCallStacks"><span class="hs-identifier">defaultCallStacks</span></a></a><span> </span><a name="local-1628069518"><a href="#local-1628069518"><span class="hs-identifier">wanteds</span></a></a><span>
</span><a name="line-166"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-1628069527"><a href="#local-1628069527"><span class="hs-identifier">simples</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628069519"><span class="hs-identifier hs-var">handle_simples</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">wc_simple</span><span> </span><a href="#local-1628069518"><span class="hs-identifier hs-var">wanteds</span></a><span class="hs-special">)</span><span>
</span><a name="line-167"></a><span>       </span><a name="local-1628069528"><a href="#local-1628069528"><span class="hs-identifier">implics</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Bag.html#mapBagM"><span class="hs-identifier hs-var">mapBagM</span></a><span> </span><a href="#local-1628069520"><span class="hs-identifier hs-var">handle_implic</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">wc_impl</span><span> </span><a href="#local-1628069518"><span class="hs-identifier hs-var">wanteds</span></a><span class="hs-special">)</span><span>
</span><a name="line-168"></a><span>       </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628069518"><span class="hs-identifier hs-var">wanteds</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wc_simple</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069527"><span class="hs-identifier hs-var">simples</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">wc_impl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069528"><span class="hs-identifier hs-var">implics</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-169"></a><span>
</span><a name="line-170"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-171"></a><span>
</span><a name="line-172"></a><span>  </span><a name="local-1628069519"><a href="#local-1628069519"><span class="hs-identifier">handle_simples</span></a></a><span> </span><a name="local-1628069522"><a href="#local-1628069522"><span class="hs-identifier">simples</span></a></a><span>
</span><a name="line-173"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Bag.html#catBagMaybes"><span class="hs-identifier hs-var">catBagMaybes</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a><span> </span><a href="Bag.html#mapBagM"><span class="hs-identifier hs-var">mapBagM</span></a><span> </span><a href="#local-1628069521"><span class="hs-identifier hs-var">defaultCallStack</span></a><span> </span><a href="#local-1628069522"><span class="hs-identifier hs-var">simples</span></a><span>
</span><a name="line-174"></a><span>
</span><a name="line-175"></a><span>  </span><a name="local-1628069520"><a href="#local-1628069520"><span class="hs-identifier">handle_implic</span></a></a><span> </span><a name="local-1628069523"><a href="#local-1628069523"><span class="hs-identifier">implic</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-176"></a><span>    </span><a name="local-1628069524"><a href="#local-1628069524"><span class="hs-identifier">wanteds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#defaultCallStacks"><span class="hs-identifier hs-var">defaultCallStacks</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ic_wanted</span><span> </span><a href="#local-1628069523"><span class="hs-identifier hs-var">implic</span></a><span class="hs-special">)</span><span>
</span><a name="line-177"></a><span>    </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628069523"><span class="hs-identifier hs-var">implic</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ic_wanted</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069524"><span class="hs-identifier hs-var">wanteds</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-178"></a><span>
</span><a name="line-179"></a><span>  </span><a name="local-1628069521"><a href="#local-1628069521"><span class="hs-identifier">defaultCallStack</span></a></a><span> </span><a name="local-1628069525"><a href="#local-1628069525"><span class="hs-identifier">ct</span></a></a><span>
</span><a name="line-180"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcType.html#isCallStackPred"><span class="hs-identifier hs-var">isCallStackPred</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#ctPred"><span class="hs-identifier hs-var">ctPred</span></a><span> </span><a href="#local-1628069525"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">)</span><span>
</span><a name="line-181"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcInteract.html#solveCallStack"><span class="hs-identifier hs-var">solveCallStack</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">cc_ev</span><span> </span><a href="#local-1628069525"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">)</span><span> </span><a href="TcEvidence.html#EvCsEmpty"><span class="hs-identifier hs-var">EvCsEmpty</span></a><span>
</span><a name="line-182"></a><span>         </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-183"></a><span>
</span><a name="line-184"></a><span>  </span><span class="hs-identifier">defaultCallStack</span><span> </span><a name="local-1628069526"><a href="#local-1628069526"><span class="hs-identifier">ct</span></a></a><span>
</span><a name="line-185"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-1628069526"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">)</span><span>
</span><a name="line-186"></a><span>
</span><a name="line-187"></a><span>
</span><a name="line-188"></a><span class="hs-comment">{- Note [Fail fast on kind errors]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
solveEqualities is used to solve kind equalities when kind-checking
user-written types. If solving fails we should fail outright, rather
than just accumulate an error message, for two reasons:

  * A kind-bogus type signature may cause a cascade of knock-on
    errors if we let it pass

  * More seriously, we don't have a convenient term-level place to add
    deferred bindings for unsolved kind-equality constraints, so we
    don't build evidence bindings (by usine reportAllUnsolved). That
    means that we'll be left with with a type that has coercion holes
    in it, something like
           &lt;type&gt; |&gt; co-hole
    where co-hole is not filled in.  Eeek!  That un-filled-in
    hole actually causes GHC to crash with &quot;fvProv falls into a hole&quot;
    See Trac #11563, #11520, #11516, #11399

So it's important to use 'checkNoErrs' here!

Note [When to do type-class defaulting]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In GHC 7.6 and 7.8.2, we did type-class defaulting only if insolubleWC
was false, on the grounds that defaulting can't help solve insoluble
constraints.  But if we *don't* do defaulting we may report a whole
lot of errors that would be solved by defaulting; these errors are
quite spurious because fixing the single insoluble error means that
defaulting happens again, which makes all the other errors go away.
This is jolly confusing: Trac #9033.

So it seems better to always do type-class defaulting.

However, always doing defaulting does mean that we'll do it in
situations like this (Trac #5934):
   run :: (forall s. GenST s) -&gt; Int
   run = fromInteger 0
We don't unify the return type of fromInteger with the given function
type, because the latter involves foralls.  So we're left with
    (Num alpha, alpha ~ (forall s. GenST s) -&gt; Int)
Now we do defaulting, get alpha := Integer, and report that we can't
match Integer with (forall s. GenST s) -&gt; Int.  That's not totally
stupid, but perhaps a little strange.

Another potential alternative would be to suppress *all* non-insoluble
errors if there are *any* insoluble errors, anywhere, but that seems
too drastic.

Note [Must simplify after defaulting]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We may have a deeply buried constraint
    (t:*) ~ (a:Open)
which we couldn't solve because of the kind incompatibility, and 'a' is free.
Then when we default 'a' we can solve the constraint.  And we want to do
that before starting in on type classes.  We MUST do it before reporting
errors, because it isn't an error!  Trac #7967 was due to this.

Note [Top-level Defaulting Plan]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We have considered two design choices for where/when to apply defaulting.
   (i) Do it in SimplCheck mode only /whenever/ you try to solve some
       simple constraints, maybe deep inside the context of implications.
       This used to be the case in GHC 7.4.1.
   (ii) Do it in a tight loop at simplifyTop, once all other constraints have
        finished. This is the current story.

Option (i) had many disadvantages:
   a) Firstly, it was deep inside the actual solver.
   b) Secondly, it was dependent on the context (Infer a type signature,
      or Check a type signature, or Interactive) since we did not want
      to always start defaulting when inferring (though there is an exception to
      this, see Note [Default while Inferring]).
   c) It plainly did not work. Consider typecheck/should_compile/DfltProb2.hs:
          f :: Int -&gt; Bool
          f x = const True (\y -&gt; let w :: a -&gt; a
                                      w a = const a (y+1)
                                  in w y)
      We will get an implication constraint (for beta the type of y):
               [untch=beta] forall a. 0 =&gt; Num beta
      which we really cannot default /while solving/ the implication, since beta is
      untouchable.

Instead our new defaulting story is to pull defaulting out of the solver loop and
go with option (ii), implemented at SimplifyTop. Namely:
     - First, have a go at solving the residual constraint of the whole
       program
     - Try to approximate it with a simple constraint
     - Figure out derived defaulting equations for that simple constraint
     - Go round the loop again if you did manage to get some equations

Now, that has to do with class defaulting. However there exists type variable /kind/
defaulting. Again this is done at the top-level and the plan is:
     - At the top-level, once you had a go at solving the constraint, do
       figure out /all/ the touchable unification variables of the wanted constraints.
     - Apply defaulting to their kinds

More details in Note [DefaultTyVar].

Note [Safe Haskell Overlapping Instances]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In Safe Haskell, we apply an extra restriction to overlapping instances. The
motive is to prevent untrusted code provided by a third-party, changing the
behavior of trusted code through type-classes. This is due to the global and
implicit nature of type-classes that can hide the source of the dictionary.

Another way to state this is: if a module M compiles without importing another
module N, changing M to import N shouldn't change the behavior of M.

Overlapping instances with type-classes can violate this principle. However,
overlapping instances aren't always unsafe. They are just unsafe when the most
selected dictionary comes from untrusted code (code compiled with -XSafe) and
overlaps instances provided by other modules.

In particular, in Safe Haskell at a call site with overlapping instances, we
apply the following rule to determine if it is a 'unsafe' overlap:

 1) Most specific instance, I1, defined in an `-XSafe` compiled module.
 2) I1 is an orphan instance or a MPTC.
 3) At least one overlapped instance, Ix, is both:
    A) from a different module than I1
    B) Ix is not marked `OVERLAPPABLE`

This is a slightly involved heuristic, but captures the situation of an
imported module N changing the behavior of existing code. For example, if
condition (2) isn't violated, then the module author M must depend either on a
type-class or type defined in N.

Secondly, when should these heuristics be enforced? We enforced them when the
type-class method call site is in a module marked `-XSafe` or `-XTrustworthy`.
This allows `-XUnsafe` modules to operate without restriction, and for Safe
Haskell inferrence to infer modules with unsafe overlaps as unsafe.

One alternative design would be to also consider if an instance was imported as
a `safe` import or not and only apply the restriction to instances imported
safely. However, since instances are global and can be imported through more
than one path, this alternative doesn't work.

Note [Safe Haskell Overlapping Instances Implementation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

How is this implemented? It's complicated! So we'll step through it all:

 1) `InstEnv.lookupInstEnv` -- Performs instance resolution, so this is where
    we check if a particular type-class method call is safe or unsafe. We do this
    through the return type, `ClsInstLookupResult`, where the last parameter is a
    list of instances that are unsafe to overlap. When the method call is safe,
    the list is null.

 2) `TcInteract.matchClassInst` -- This module drives the instance resolution
    / dictionary generation. The return type is `LookupInstResult`, which either
    says no instance matched, or one found, and if it was a safe or unsafe
    overlap.

 3) `TcInteract.doTopReactDict` -- Takes a dictionary / class constraint and
     tries to resolve it by calling (in part) `matchClassInst`. The resolving
     mechanism has a work list (of constraints) that it process one at a time. If
     the constraint can't be resolved, it's added to an inert set. When compiling
     an `-XSafe` or `-XTrustworthy` module, we follow this approach as we know
     compilation should fail. These are handled as normal constraint resolution
     failures from here-on (see step 6).

     Otherwise, we may be inferring safety (or using `-Wunsafe`), and
     compilation should succeed, but print warnings and/or mark the compiled module
     as `-XUnsafe`. In this case, we call `insertSafeOverlapFailureTcS` which adds
     the unsafe (but resolved!) constraint to the `inert_safehask` field of
     `InertCans`.

 4) `TcSimplify.simplifyTop`:
       * Call simpl_top, the top-level function for driving the simplifier for
         constraint resolution.

       * Once finished, call `getSafeOverlapFailures` to retrieve the
         list of overlapping instances that were successfully resolved,
         but unsafe. Remember, this is only applicable for generating warnings
         (`-Wunsafe`) or inferring a module unsafe. `-XSafe` and `-XTrustworthy`
         cause compilation failure by not resolving the unsafe constraint at all.

       * For unresolved constraints (all types), call `TcErrors.reportUnsolved`,
         while for resolved but unsafe overlapping dictionary constraints, call
         `TcErrors.warnAllUnsolved`. Both functions convert constraints into a
         warning message for the user.

       * In the case of `warnAllUnsolved` for resolved, but unsafe
         dictionary constraints, we collect the generated warning
         message (pop it) and call `TcRnMonad.recordUnsafeInfer` to
         mark the module we are compiling as unsafe, passing the
         warning message along as the reason.

 5) `TcErrors.*Unsolved` -- Generates error messages for constraints by
    actually calling `InstEnv.lookupInstEnv` again! Yes, confusing, but all we
    know is the constraint that is unresolved or unsafe. For dictionary, all we
    know is that we need a dictionary of type C, but not what instances are
    available and how they overlap. So we once again call `lookupInstEnv` to
    figure that out so we can generate a helpful error message.

 6) `TcRnMonad.recordUnsafeInfer` -- Save the unsafe result and reason in an
      IORef called `tcg_safeInfer`.

 7) `HscMain.tcRnModule'` -- Reads `tcg_safeInfer` after type-checking, calling
    `HscMain.markUnsafeInfer` (passing the reason along) when safe-inferrence
    failed.
-}</span><span>
</span><a name="line-390"></a><span>
</span><a name="line-391"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-392"></a><span class="hs-identifier">simplifyAmbiguityCheck</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-393"></a><a name="simplifyAmbiguityCheck"><a href="TcSimplify.html#simplifyAmbiguityCheck"><span class="hs-identifier">simplifyAmbiguityCheck</span></a></a><span> </span><a name="local-1628069529"><a href="#local-1628069529"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-1628069530"><a href="#local-1628069530"><span class="hs-identifier">wanteds</span></a></a><span>
</span><a name="line-394"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;simplifyAmbiguityCheck {&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;type = &quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069529"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;wanted = &quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069530"><span class="hs-identifier hs-var">wanteds</span></a><span class="hs-special">)</span><span>
</span><a name="line-395"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628069531"><a href="#local-1628069531"><span class="hs-identifier">final_wc</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#runTcS"><span class="hs-identifier hs-var">runTcS</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcSimplify.html#simpl_top"><span class="hs-identifier hs-var">simpl_top</span></a><span> </span><a href="#local-1628069530"><span class="hs-identifier hs-var">wanteds</span></a><span>
</span><a name="line-396"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;End simplifyAmbiguityCheck }&quot;</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-397"></a><span>
</span><a name="line-398"></a><span>       </span><span class="hs-comment">-- Normally report all errors; but with -XAllowAmbiguousTypes</span><span>
</span><a name="line-399"></a><span>       </span><span class="hs-comment">-- report only insoluble ones, since they represent genuinely</span><span>
</span><a name="line-400"></a><span>       </span><span class="hs-comment">-- inaccessible code</span><span>
</span><a name="line-401"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628069532"><a href="#local-1628069532"><span class="hs-identifier">allow_ambiguous</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><a href="../ghc-boot-8.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.html#AllowAmbiguousTypes"><span class="hs-identifier hs-var">LangExt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">AllowAmbiguousTypes</span></a><span>
</span><a name="line-402"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;reportUnsolved(ambig) {&quot;</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-403"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628069533"><a href="#local-1628069533"><span class="hs-identifier">tc_lvl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getTcLevel"><span class="hs-identifier hs-var">TcM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">getTcLevel</span></a><span>
</span><a name="line-404"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628069532"><span class="hs-identifier hs-var">allow_ambiguous</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#insolubleWC"><span class="hs-identifier hs-var">insolubleWC</span></a><span> </span><a href="#local-1628069533"><span class="hs-identifier hs-var">tc_lvl</span></a><span> </span><a href="#local-1628069531"><span class="hs-identifier hs-var">final_wc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-405"></a><span>                </span><span class="hs-special">(</span><a href="TcRnMonad.html#discardResult"><span class="hs-identifier hs-var">discardResult</span></a><span> </span><span class="hs-special">(</span><a href="TcErrors.html#reportUnsolved"><span class="hs-identifier hs-var">reportUnsolved</span></a><span> </span><a href="#local-1628069531"><span class="hs-identifier hs-var">final_wc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-406"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;reportUnsolved(ambig) }&quot;</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-407"></a><span>
</span><a name="line-408"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-409"></a><span>
</span><a name="line-410"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-411"></a><span class="hs-identifier">simplifyInteractive</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><a href="Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a><span> </span><a href="TcEvidence.html#EvBind"><span class="hs-identifier hs-type">EvBind</span></a><span class="hs-special">)</span><span>
</span><a name="line-412"></a><a name="simplifyInteractive"><a href="TcSimplify.html#simplifyInteractive"><span class="hs-identifier">simplifyInteractive</span></a></a><span> </span><a name="local-1628069534"><a href="#local-1628069534"><span class="hs-identifier">wanteds</span></a></a><span>
</span><a name="line-413"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;simplifyInteractive&quot;</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%3E%3E"><span class="hs-operator hs-var">&gt;&gt;</span></a><span>
</span><a name="line-414"></a><span>    </span><a href="TcSimplify.html#simplifyTop"><span class="hs-identifier hs-var">simplifyTop</span></a><span> </span><a href="#local-1628069534"><span class="hs-identifier hs-var">wanteds</span></a><span>
</span><a name="line-415"></a><span>
</span><a name="line-416"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-417"></a><span class="hs-identifier">simplifyDefault</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#ThetaType"><span class="hs-identifier hs-type">ThetaType</span></a><span>    </span><span class="hs-comment">-- Wanted; has no type variables in it</span><span>
</span><a name="line-418"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>       </span><span class="hs-comment">-- Succeeds if the constraint is soluble</span><span>
</span><a name="line-419"></a><a name="simplifyDefault"><a href="TcSimplify.html#simplifyDefault"><span class="hs-identifier">simplifyDefault</span></a></a><span> </span><a name="local-1628069535"><a href="#local-1628069535"><span class="hs-identifier">theta</span></a></a><span>
</span><a name="line-420"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;simplifyInteractive&quot;</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-421"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628069536"><a href="#local-1628069536"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getCtLocM"><span class="hs-identifier hs-var">getCtLocM</span></a><span> </span><a href="TcRnTypes.html#DefaultOrigin"><span class="hs-identifier hs-var">DefaultOrigin</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-422"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628069537"><a href="#local-1628069537"><span class="hs-identifier">wanted</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="TcRnTypes.html#CtDerived"><span class="hs-identifier hs-var">CtDerived</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctev_pred</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069538"><span class="hs-identifier hs-var">pred</span></a><span>
</span><a name="line-423"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ctev_loc</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069536"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-424"></a><span>                      </span><span class="hs-glyph">|</span><span> </span><a name="local-1628069538"><a href="#local-1628069538"><span class="hs-identifier">pred</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628069535"><span class="hs-identifier hs-var">theta</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-425"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628069539"><a href="#local-1628069539"><span class="hs-identifier">unsolved</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#runTcSDeriveds"><span class="hs-identifier hs-var">runTcSDeriveds</span></a><span> </span><span class="hs-special">(</span><a href="TcSimplify.html#solveWanteds"><span class="hs-identifier hs-var">solveWanteds</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#mkSimpleWC"><span class="hs-identifier hs-var">mkSimpleWC</span></a><span> </span><a href="#local-1628069537"><span class="hs-identifier hs-var">wanted</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-426"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;reportUnsolved {&quot;</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-427"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcErrors.html#reportAllUnsolved"><span class="hs-identifier hs-var">reportAllUnsolved</span></a><span> </span><a href="#local-1628069539"><span class="hs-identifier hs-var">unsolved</span></a><span>
</span><a name="line-428"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;reportUnsolved }&quot;</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-429"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-430"></a><span>
</span><a name="line-431"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-432"></a><span class="hs-identifier">tcCheckSatisfiability</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a><span> </span><a href="Var.html#EvVar"><span class="hs-identifier hs-type">EvVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-433"></a><span class="hs-comment">-- Return True if satisfiable, False if definitely contradictory</span><span>
</span><a name="line-434"></a><a name="tcCheckSatisfiability"><a href="TcSimplify.html#tcCheckSatisfiability"><span class="hs-identifier">tcCheckSatisfiability</span></a></a><span> </span><a name="local-1628069540"><a href="#local-1628069540"><span class="hs-identifier">given_ids</span></a></a><span>
</span><a name="line-435"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628069545"><a href="#local-1628069545"><span class="hs-identifier">lcl_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLclEnv"><span class="hs-identifier hs-var">TcM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">getLclEnv</span></a><span>
</span><a name="line-436"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628069546"><a href="#local-1628069546"><span class="hs-identifier">given_loc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#mkGivenLoc"><span class="hs-identifier hs-var">mkGivenLoc</span></a><span> </span><a href="TcType.html#topTcLevel"><span class="hs-identifier hs-var">topTcLevel</span></a><span> </span><a href="TcRnTypes.html#UnkSkol"><span class="hs-identifier hs-var">UnkSkol</span></a><span> </span><a href="#local-1628069545"><span class="hs-identifier hs-var">lcl_env</span></a><span>
</span><a name="line-437"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628069550"><a href="#local-1628069550"><span class="hs-identifier">res</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628069551"><a href="#local-1628069551"><span class="hs-identifier">_ev_binds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#runTcS"><span class="hs-identifier hs-var">runTcS</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-438"></a><span>             </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;checkSatisfiability {&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069540"><span class="hs-identifier hs-var">given_ids</span></a><span class="hs-special">)</span><span>
</span><a name="line-439"></a><span>                </span><span class="hs-special">;</span><span> </span><a name="local-1628069547"><a href="#local-1628069547"><span class="hs-identifier">given_cts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcCanonical.html#mkGivensWithSuperClasses"><span class="hs-identifier hs-var">mkGivensWithSuperClasses</span></a><span> </span><a href="#local-1628069546"><span class="hs-identifier hs-var">given_loc</span></a><span> </span><span class="hs-special">(</span><a href="Bag.html#bagToList"><span class="hs-identifier hs-var">bagToList</span></a><span> </span><a href="#local-1628069540"><span class="hs-identifier hs-var">given_ids</span></a><span class="hs-special">)</span><span>
</span><a name="line-440"></a><span>                     </span><span class="hs-comment">-- See Note [Superclases and satisfiability]</span><span>
</span><a name="line-441"></a><span>                </span><span class="hs-special">;</span><span> </span><a name="local-1628069548"><a href="#local-1628069548"><span class="hs-identifier">insols</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcInteract.html#solveSimpleGivens"><span class="hs-identifier hs-var">solveSimpleGivens</span></a><span> </span><a href="#local-1628069547"><span class="hs-identifier hs-var">given_cts</span></a><span>
</span><a name="line-442"></a><span>                </span><span class="hs-special">;</span><span> </span><a name="local-1628069549"><a href="#local-1628069549"><span class="hs-identifier">insols</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628069541"><span class="hs-identifier hs-var">try_harder</span></a><span> </span><a href="#local-1628069548"><span class="hs-identifier hs-var">insols</span></a><span>
</span><a name="line-443"></a><span>                </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;checkSatisfiability }&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069549"><span class="hs-identifier hs-var">insols</span></a><span class="hs-special">)</span><span>
</span><a name="line-444"></a><span>                </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="Bag.html#isEmptyBag"><span class="hs-identifier hs-var">isEmptyBag</span></a><span> </span><a href="#local-1628069549"><span class="hs-identifier hs-var">insols</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-445"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-1628069550"><span class="hs-identifier hs-var">res</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-446"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-447"></a><span>    </span><span class="hs-identifier">try_harder</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#Cts"><span class="hs-identifier hs-type">Cts</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="TcRnTypes.html#Cts"><span class="hs-identifier hs-type">Cts</span></a><span>
</span><a name="line-448"></a><span>    </span><span class="hs-comment">-- Maybe we have to search up the superclass chain to find</span><span>
</span><a name="line-449"></a><span>    </span><span class="hs-comment">-- an unsatisfiable constraint.  Example: pmcheck/T3927b.</span><span>
</span><a name="line-450"></a><span>    </span><span class="hs-comment">-- At the moment we try just once</span><span>
</span><a name="line-451"></a><span>    </span><a name="local-1628069541"><a href="#local-1628069541"><span class="hs-identifier">try_harder</span></a></a><span> </span><a name="local-1628069542"><a href="#local-1628069542"><span class="hs-identifier">insols</span></a></a><span>
</span><a name="line-452"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Bag.html#isEmptyBag"><span class="hs-identifier hs-var">isEmptyBag</span></a><span> </span><a href="#local-1628069542"><span class="hs-identifier hs-var">insols</span></a><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- We've found that it's definitely unsatisfiable</span><span>
</span><a name="line-453"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-1628069542"><span class="hs-identifier hs-var">insols</span></a><span>             </span><span class="hs-comment">-- Hurrah -- stop now.</span><span>
</span><a name="line-454"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-455"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628069543"><a href="#local-1628069543"><span class="hs-identifier">pending_given</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getPendingScDicts"><span class="hs-identifier hs-var">getPendingScDicts</span></a><span>
</span><a name="line-456"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-1628069544"><a href="#local-1628069544"><span class="hs-identifier">new_given</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcCanonical.html#makeSuperClasses"><span class="hs-identifier hs-var">makeSuperClasses</span></a><span> </span><a href="#local-1628069543"><span class="hs-identifier hs-var">pending_given</span></a><span>
</span><a name="line-457"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="TcInteract.html#solveSimpleGivens"><span class="hs-identifier hs-var">solveSimpleGivens</span></a><span> </span><a href="#local-1628069544"><span class="hs-identifier hs-var">new_given</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-458"></a><span>
</span><a name="line-459"></a><span class="hs-comment">{- Note [Superclases and satisfiability]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Expand superclasses before starting, because (Int ~ Bool), has
(Int ~~ Bool) as a superclass, which in turn has (Int ~N# Bool)
as a superclass, and it's the latter that is insoluble.  See
Note [The equality types story] in TysPrim.

If we fail to prove unsatisfiability we (arbitrarily) try just once to
find superclasses, using try_harder.  Reason: we might have a type
signature
   f :: F op (Implements push) =&gt; ..
where F is a type function.  This happened in Trac #3972.

We could do more than once but we'd have to have /some/ limit: in the
the recurisve case, we would go on forever in the common case where
the constraints /are/ satisfiable (Trac #10592 comment:12!).

For stratightforard situations without type functions the try_harder
step does nothing.


***********************************************************************************
*                                                                                 *
*                            Inference
*                                                                                 *
***********************************************************************************

Note [Inferring the type of a let-bound variable]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
   f x = rhs

To infer f's type we do the following:
 * Gather the constraints for the RHS with ambient level *one more than*
   the current one.  This is done by the call
        pushLevelAndCaptureConstraints (tcMonoBinds...)
   in TcBinds.tcPolyInfer

 * Call simplifyInfer to simplify the constraints and decide what to
   quantify over. We pass in the level used for the RHS constraints,
   here called rhs_tclvl.

This ensures that the implication constraint we generate, if any,
has a strictly-increased level compared to the ambient level outside
the let binding.

-}</span><span>
</span><a name="line-506"></a><span>
</span><a name="line-507"></a><span class="hs-identifier">simplifyInfer</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#TcLevel"><span class="hs-identifier hs-type">TcLevel</span></a><span>               </span><span class="hs-comment">-- Used when generating the constraints</span><span>
</span><a name="line-508"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>                  </span><span class="hs-comment">-- Apply monomorphism restriction</span><span>
</span><a name="line-509"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcRnTypes.html#TcIdSigInfo"><span class="hs-identifier hs-type">TcIdSigInfo</span></a><span class="hs-special">]</span><span>         </span><span class="hs-comment">-- Any signatures (possibly partial)</span><span>
</span><a name="line-510"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span class="hs-special">,</span><span> </span><a href="TcType.html#TcTauType"><span class="hs-identifier hs-type">TcTauType</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- Variables to be generalised,</span><span>
</span><a name="line-511"></a><span>                                       </span><span class="hs-comment">-- and their tau-types</span><span>
</span><a name="line-512"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a><span>
</span><a name="line-513"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="TcType.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>    </span><span class="hs-comment">-- Quantify over these type variables</span><span>
</span><a name="line-514"></a><span>                      </span><span class="hs-special">[</span><a href="Var.html#EvVar"><span class="hs-identifier hs-type">EvVar</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>      </span><span class="hs-comment">-- ... and these constraints (fully zonked)</span><span>
</span><a name="line-515"></a><span>                      </span><a href="TcEvidence.html#TcEvBinds"><span class="hs-identifier hs-type">TcEvBinds</span></a><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- ... binding these evidence variables</span><span>
</span><a name="line-516"></a><a name="simplifyInfer"><a href="TcSimplify.html#simplifyInfer"><span class="hs-identifier">simplifyInfer</span></a></a><span> </span><a name="local-1628069552"><a href="#local-1628069552"><span class="hs-identifier">rhs_tclvl</span></a></a><span> </span><a name="local-1628069553"><a href="#local-1628069553"><span class="hs-identifier">apply_mr</span></a></a><span> </span><a name="local-1628069554"><a href="#local-1628069554"><span class="hs-identifier">sigs</span></a></a><span> </span><a name="local-1628069555"><a href="#local-1628069555"><span class="hs-identifier">name_taus</span></a></a><span> </span><a name="local-1628069556"><a href="#local-1628069556"><span class="hs-identifier">wanteds</span></a></a><span>
</span><a name="line-517"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TcRnTypes.html#isEmptyWC"><span class="hs-identifier hs-var">isEmptyWC</span></a><span> </span><a href="#local-1628069556"><span class="hs-identifier hs-var">wanteds</span></a><span>
</span><a name="line-518"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628069557"><a href="#local-1628069557"><span class="hs-identifier">gbl_tvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#tcGetGlobalTyCoVars"><span class="hs-identifier hs-var">tcGetGlobalTyCoVars</span></a><span>
</span><a name="line-519"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628069558"><a href="#local-1628069558"><span class="hs-identifier">dep_vars</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTcTypesAndSplitDepVars"><span class="hs-identifier hs-var">zonkTcTypesAndSplitDepVars</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#snd"><span class="hs-identifier hs-var">snd</span></a><span> </span><a href="#local-1628069555"><span class="hs-identifier hs-var">name_taus</span></a><span class="hs-special">)</span><span>
</span><a name="line-520"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628069559"><a href="#local-1628069559"><span class="hs-identifier">qtkvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#quantify_tvs"><span class="hs-identifier hs-var">quantify_tvs</span></a><span> </span><a href="#local-1628069554"><span class="hs-identifier hs-var">sigs</span></a><span> </span><a href="#local-1628069557"><span class="hs-identifier hs-var">gbl_tvs</span></a><span> </span><a href="#local-1628069558"><span class="hs-identifier hs-var">dep_vars</span></a><span>
</span><a name="line-521"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;simplifyInfer: empty WC&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069555"><span class="hs-identifier hs-var">name_taus</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069559"><span class="hs-identifier hs-var">qtkvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-522"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628069559"><span class="hs-identifier hs-var">qtkvs</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="TcEvidence.html#emptyTcEvBinds"><span class="hs-identifier hs-var">emptyTcEvBinds</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-523"></a><span>
</span><a name="line-524"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-525"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;simplifyInfer {&quot;</span><span>  </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span>
</span><a name="line-526"></a><span>             </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;sigs =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069554"><span class="hs-identifier hs-var">sigs</span></a><span>
</span><a name="line-527"></a><span>             </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;binds =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069555"><span class="hs-identifier hs-var">name_taus</span></a><span>
</span><a name="line-528"></a><span>             </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;rhs_tclvl =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069552"><span class="hs-identifier hs-var">rhs_tclvl</span></a><span>
</span><a name="line-529"></a><span>             </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;apply_mr =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069553"><span class="hs-identifier hs-var">apply_mr</span></a><span>
</span><a name="line-530"></a><span>             </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;(unzonked) wanted =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069556"><span class="hs-identifier hs-var">wanteds</span></a><span>
</span><a name="line-531"></a><span>             </span><span class="hs-special">]</span><span>
</span><a name="line-532"></a><span>
</span><a name="line-533"></a><span>       </span><span class="hs-comment">-- First do full-blown solving</span><span>
</span><a name="line-534"></a><span>       </span><span class="hs-comment">-- NB: we must gather up all the bindings from doing</span><span>
</span><a name="line-535"></a><span>       </span><span class="hs-comment">-- this solving; hence (runTcSWithEvBinds ev_binds_var).</span><span>
</span><a name="line-536"></a><span>       </span><span class="hs-comment">-- And note that since there are nested implications,</span><span>
</span><a name="line-537"></a><span>       </span><span class="hs-comment">-- calling solveWanteds will side-effect their evidence</span><span>
</span><a name="line-538"></a><span>       </span><span class="hs-comment">-- bindings, so we can't just revert to the input</span><span>
</span><a name="line-539"></a><span>       </span><span class="hs-comment">-- constraint.</span><span>
</span><a name="line-540"></a><span>
</span><a name="line-541"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628069560"><a href="#local-1628069560"><span class="hs-identifier">ev_binds_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newTcEvBinds"><span class="hs-identifier hs-var">TcM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">newTcEvBinds</span></a><span>
</span><a name="line-542"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628069562"><a href="#local-1628069562"><span class="hs-identifier">wanted_transformed_incl_derivs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#setTcLevel"><span class="hs-identifier hs-var">setTcLevel</span></a><span> </span><a href="#local-1628069552"><span class="hs-identifier hs-var">rhs_tclvl</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-543"></a><span>           </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628069561"><a href="#local-1628069561"><span class="hs-identifier">sig_derived</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="MonadUtils.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><a href="TcSimplify.html#mkSigDerivedWanteds"><span class="hs-identifier hs-var">mkSigDerivedWanteds</span></a><span> </span><a href="#local-1628069554"><span class="hs-identifier hs-var">sigs</span></a><span>
</span><a name="line-544"></a><span>                  </span><span class="hs-comment">-- the False says we don't really need to solve all Deriveds</span><span>
</span><a name="line-545"></a><span>              </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#runTcSWithEvBinds"><span class="hs-identifier hs-var">runTcSWithEvBinds</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-1628069560"><span class="hs-identifier hs-var">ev_binds_var</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-546"></a><span>                </span><a href="TcSimplify.html#solveWanteds"><span class="hs-identifier hs-var">solveWanteds</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628069556"><span class="hs-identifier hs-var">wanteds</span></a><span> </span><span class="hs-special">`</span><a href="TcRnTypes.html#addSimples"><span class="hs-identifier hs-var">addSimples</span></a><span class="hs-special">`</span><span> </span><a href="Bag.html#listToBag"><span class="hs-identifier hs-var">listToBag</span></a><span> </span><a href="#local-1628069561"><span class="hs-identifier hs-var">sig_derived</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-547"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628069563"><a href="#local-1628069563"><span class="hs-identifier">wanted_transformed_incl_derivs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkWC"><span class="hs-identifier hs-var">TcM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">zonkWC</span></a><span> </span><a href="#local-1628069562"><span class="hs-identifier hs-var">wanted_transformed_incl_derivs</span></a><span>
</span><a name="line-548"></a><span>
</span><a name="line-549"></a><span>       </span><span class="hs-comment">-- Find quant_pred_candidates, the predicates that</span><span>
</span><a name="line-550"></a><span>       </span><span class="hs-comment">-- we'll consider quantifying over</span><span>
</span><a name="line-551"></a><span>       </span><span class="hs-comment">-- NB: We do not do any defaulting when inferring a type, this can lead</span><span>
</span><a name="line-552"></a><span>       </span><span class="hs-comment">-- to less polymorphic types, see Note [Default while Inferring]</span><span>
</span><a name="line-553"></a><span>
</span><a name="line-554"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628069564"><a href="#local-1628069564"><span class="hs-identifier">tc_lcl_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLclEnv"><span class="hs-identifier hs-var">TcM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">getLclEnv</span></a><span>
</span><a name="line-555"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628069565"><a href="#local-1628069565"><span class="hs-identifier">wanted_transformed</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#dropDerivedWC"><span class="hs-identifier hs-var">dropDerivedWC</span></a><span> </span><a href="#local-1628069563"><span class="hs-identifier hs-var">wanted_transformed_incl_derivs</span></a><span>
</span><a name="line-556"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628069575"><a href="#local-1628069575"><span class="hs-identifier">quant_pred_candidates</span></a></a><span>   </span><span class="hs-comment">-- Fully zonked</span><span>
</span><a name="line-557"></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="TcRnTypes.html#insolubleWC"><span class="hs-identifier hs-var">insolubleWC</span></a><span> </span><a href="#local-1628069552"><span class="hs-identifier hs-var">rhs_tclvl</span></a><span> </span><a href="#local-1628069563"><span class="hs-identifier hs-var">wanted_transformed_incl_derivs</span></a><span>
</span><a name="line-558"></a><span>              </span><span class="hs-keyword">then</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- See Note [Quantification with errors]</span><span>
</span><a name="line-559"></a><span>                               </span><span class="hs-comment">-- NB: must include derived errors in this test,</span><span>
</span><a name="line-560"></a><span>                               </span><span class="hs-comment">--     hence &quot;incl_derivs&quot;</span><span>
</span><a name="line-561"></a><span>
</span><a name="line-562"></a><span>              </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628069566"><a href="#local-1628069566"><span class="hs-identifier">quant_cand</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSimplify.html#approximateWC"><span class="hs-identifier hs-var">approximateWC</span></a><span> </span><a href="#local-1628069565"><span class="hs-identifier hs-var">wanted_transformed</span></a><span>
</span><a name="line-563"></a><span>                            </span><a name="local-1628069567"><a href="#local-1628069567"><span class="hs-identifier">meta_tvs</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a><span> </span><a href="TcType.html#isMetaTyVar"><span class="hs-identifier hs-var">isMetaTyVar</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-564"></a><span>                                         </span><a href="TcRnTypes.html#tyCoVarsOfCtsList"><span class="hs-identifier hs-var">tyCoVarsOfCtsList</span></a><span> </span><a href="#local-1628069566"><span class="hs-identifier hs-var">quant_cand</span></a><span>
</span><a name="line-565"></a><span>
</span><a name="line-566"></a><span>                      </span><span class="hs-special">;</span><span> </span><a name="local-1628069568"><a href="#local-1628069568"><span class="hs-identifier">gbl_tvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#tcGetGlobalTyCoVars"><span class="hs-identifier hs-var">tcGetGlobalTyCoVars</span></a><span>
</span><a name="line-567"></a><span>                            </span><span class="hs-comment">-- Miminise quant_cand.  We are not interested in any evidence</span><span>
</span><a name="line-568"></a><span>                            </span><span class="hs-comment">-- produced, because we are going to simplify wanted_transformed</span><span>
</span><a name="line-569"></a><span>                            </span><span class="hs-comment">-- again later. All we want here are the predicates over which to</span><span>
</span><a name="line-570"></a><span>                            </span><span class="hs-comment">-- quantify.</span><span>
</span><a name="line-571"></a><span>                            </span><span class="hs-comment">--</span><span>
</span><a name="line-572"></a><span>                            </span><span class="hs-comment">-- If any meta-tyvar unifications take place (unlikely),</span><span>
</span><a name="line-573"></a><span>                            </span><span class="hs-comment">-- we'll pick that up later.</span><span>
</span><a name="line-574"></a><span>
</span><a name="line-575"></a><span>                      </span><span class="hs-comment">-- See Note [Promote _and_ default when inferring]</span><span>
</span><a name="line-576"></a><span>                      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628069569"><a href="#local-1628069569"><span class="hs-identifier">def_tyvar</span></a></a><span> </span><a name="local-1628069570"><a href="#local-1628069570"><span class="hs-identifier">tv</span></a></a><span>
</span><a name="line-577"></a><span>                              </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="#local-1628069570"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#elemVarSet"><span class="hs-identifier hs-var">elemVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628069568"><span class="hs-identifier hs-var">gbl_tvs</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-578"></a><span>                                </span><a href="TcSimplify.html#defaultTyVar"><span class="hs-identifier hs-var">defaultTyVar</span></a><span> </span><a href="#local-1628069570"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-579"></a><span>                      </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><a href="#local-1628069569"><span class="hs-identifier hs-var">def_tyvar</span></a><span> </span><a href="#local-1628069567"><span class="hs-identifier hs-var">meta_tvs</span></a><span>
</span><a name="line-580"></a><span>                      </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><span class="hs-special">(</span><a href="TcSimplify.html#promoteTyVar"><span class="hs-identifier hs-var">promoteTyVar</span></a><span> </span><a href="#local-1628069552"><span class="hs-identifier hs-var">rhs_tclvl</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628069567"><span class="hs-identifier hs-var">meta_tvs</span></a><span>
</span><a name="line-581"></a><span>
</span><a name="line-582"></a><span>                      </span><span class="hs-special">;</span><span> </span><a href="TcRnTypes.html#WC"><span class="hs-identifier hs-var">WC</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wc_simple</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069571"><a href="#local-1628069571"><span class="hs-identifier">simples</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-583"></a><span>                           </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#setTcLevel"><span class="hs-identifier hs-var">setTcLevel</span></a><span> </span><a href="#local-1628069552"><span class="hs-identifier hs-var">rhs_tclvl</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-584"></a><span>                              </span><a href="TcSMonad.html#runTcSDeriveds"><span class="hs-identifier hs-var">runTcSDeriveds</span></a><span>       </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-585"></a><span>                              </span><a href="TcInteract.html#solveSimpleWanteds"><span class="hs-identifier hs-var">solveSimpleWanteds</span></a><span>   </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-586"></a><span>                              </span><a href="Bag.html#mapBag"><span class="hs-identifier hs-var">mapBag</span></a><span> </span><a href="TcRnTypes.html#toDerivedCt"><span class="hs-identifier hs-var">toDerivedCt</span></a><span> </span><a href="#local-1628069566"><span class="hs-identifier hs-var">quant_cand</span></a><span>
</span><a name="line-587"></a><span>                                </span><span class="hs-comment">-- NB: we don't want evidence,</span><span>
</span><a name="line-588"></a><span>                                </span><span class="hs-comment">-- so use Derived constraints</span><span>
</span><a name="line-589"></a><span>
</span><a name="line-590"></a><span>                      </span><span class="hs-special">;</span><span> </span><a name="local-1628069572"><a href="#local-1628069572"><span class="hs-identifier">simples</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkSimples"><span class="hs-identifier hs-var">TcM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">zonkSimples</span></a><span> </span><a href="#local-1628069571"><span class="hs-identifier hs-var">simples</span></a><span>
</span><a name="line-591"></a><span>
</span><a name="line-592"></a><span>                      </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="TcRnTypes.html#ctEvPred"><span class="hs-identifier hs-var">ctEvPred</span></a><span> </span><a href="#local-1628069574"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-1628069573"><a href="#local-1628069573"><span class="hs-identifier">ct</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Bag.html#bagToList"><span class="hs-identifier hs-var">bagToList</span></a><span> </span><a href="#local-1628069572"><span class="hs-identifier hs-var">simples</span></a><span>
</span><a name="line-593"></a><span>                                             </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628069574"><a href="#local-1628069574"><span class="hs-identifier">ev</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#ctEvidence"><span class="hs-identifier hs-var">ctEvidence</span></a><span> </span><a href="#local-1628069573"><span class="hs-identifier hs-var">ct</span></a><span> </span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-594"></a><span>
</span><a name="line-595"></a><span>       </span><span class="hs-comment">-- NB: quant_pred_candidates is already fully zonked</span><span>
</span><a name="line-596"></a><span>
</span><a name="line-597"></a><span>       </span><span class="hs-comment">-- Decide what type variables and constraints to quantify</span><span>
</span><a name="line-598"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628069576"><a href="#local-1628069576"><span class="hs-identifier">zonked_taus</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><span class="hs-special">(</span><a href="TcMType.html#zonkTcType"><span class="hs-identifier hs-var">TcM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">zonkTcType</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#snd"><span class="hs-identifier hs-var">snd</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628069555"><span class="hs-identifier hs-var">name_taus</span></a><span>
</span><a name="line-599"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628069577"><a href="#local-1628069577"><span class="hs-identifier">zonked_tau_tkvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#splitDepVarsOfTypes"><span class="hs-identifier hs-var">splitDepVarsOfTypes</span></a><span> </span><a href="#local-1628069576"><span class="hs-identifier hs-var">zonked_taus</span></a><span>
</span><a name="line-600"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628069578"><a href="#local-1628069578"><span class="hs-identifier">qtvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628069579"><a href="#local-1628069579"><span class="hs-identifier">bound_theta</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-601"></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#decideQuantification"><span class="hs-identifier hs-var">decideQuantification</span></a><span> </span><a href="#local-1628069553"><span class="hs-identifier hs-var">apply_mr</span></a><span> </span><a href="#local-1628069554"><span class="hs-identifier hs-var">sigs</span></a><span> </span><a href="#local-1628069555"><span class="hs-identifier hs-var">name_taus</span></a><span>
</span><a name="line-602"></a><span>                                   </span><a href="#local-1628069575"><span class="hs-identifier hs-var">quant_pred_candidates</span></a><span> </span><a href="#local-1628069577"><span class="hs-identifier hs-var">zonked_tau_tkvs</span></a><span>
</span><a name="line-603"></a><span>
</span><a name="line-604"></a><span>         </span><span class="hs-comment">-- Promote any type variables that are free in the inferred type</span><span>
</span><a name="line-605"></a><span>         </span><span class="hs-comment">-- of the function:</span><span>
</span><a name="line-606"></a><span>         </span><span class="hs-comment">--    f :: forall qtvs. bound_theta =&gt; zonked_tau</span><span>
</span><a name="line-607"></a><span>         </span><span class="hs-comment">-- These variables now become free in the envt, and hence will show</span><span>
</span><a name="line-608"></a><span>         </span><span class="hs-comment">-- up whenever 'f' is called.  They may currently at rhs_tclvl, but</span><span>
</span><a name="line-609"></a><span>         </span><span class="hs-comment">-- they had better be unifiable at the outer_tclvl!</span><span>
</span><a name="line-610"></a><span>         </span><span class="hs-comment">-- Example:   envt mentions alpha[1]</span><span>
</span><a name="line-611"></a><span>         </span><span class="hs-comment">--            tau_ty = beta[2] -&gt; beta[2]</span><span>
</span><a name="line-612"></a><span>         </span><span class="hs-comment">--            consraints = alpha ~ [beta]</span><span>
</span><a name="line-613"></a><span>         </span><span class="hs-comment">-- we don't quantify over beta (since it is fixed by envt)</span><span>
</span><a name="line-614"></a><span>         </span><span class="hs-comment">-- so we must promote it!  The inferred type is just</span><span>
</span><a name="line-615"></a><span>         </span><span class="hs-comment">--   f :: beta -&gt; beta</span><span>
</span><a name="line-616"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628069580"><a href="#local-1628069580"><span class="hs-identifier">outer_tclvl</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getTcLevel"><span class="hs-identifier hs-var">TcM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">getTcLevel</span></a><span>
</span><a name="line-617"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628069581"><a href="#local-1628069581"><span class="hs-identifier">zonked_tau_tvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#fold"><span class="hs-identifier hs-var">fold</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a><span>
</span><a name="line-618"></a><span>                           </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#traverse"><span class="hs-identifier hs-var">traverse</span></a><span> </span><a href="TcMType.html#zonkTyCoVarsAndFV"><span class="hs-identifier hs-var">TcM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">zonkTyCoVarsAndFV</span></a><span> </span><a href="#local-1628069577"><span class="hs-identifier hs-var">zonked_tau_tkvs</span></a><span>
</span><a name="line-619"></a><span>              </span><span class="hs-comment">-- decideQuantification turned some meta tyvars into</span><span>
</span><a name="line-620"></a><span>              </span><span class="hs-comment">-- quantified skolems, so we have to zonk again</span><span>
</span><a name="line-621"></a><span>
</span><a name="line-622"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628069582"><a href="#local-1628069582"><span class="hs-identifier">phi_tvs</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#tyCoVarsOfTypes"><span class="hs-identifier hs-var">tyCoVarsOfTypes</span></a><span> </span><a href="#local-1628069579"><span class="hs-identifier hs-var">bound_theta</span></a><span>
</span><a name="line-623"></a><span>                           </span><span class="hs-special">`</span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628069581"><span class="hs-identifier hs-var">zonked_tau_tvs</span></a><span>
</span><a name="line-624"></a><span>
</span><a name="line-625"></a><span>             </span><a name="local-1628069583"><a href="#local-1628069583"><span class="hs-identifier">promote_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#closeOverKinds"><span class="hs-identifier hs-var">closeOverKinds</span></a><span> </span><a href="#local-1628069582"><span class="hs-identifier hs-var">phi_tvs</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#delVarSetList"><span class="hs-identifier hs-var">delVarSetList</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628069578"><span class="hs-identifier hs-var">qtvs</span></a><span>
</span><a name="line-626"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">MASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">closeOverKinds</span><span> </span><a href="TyCoRep.html#closeOverKinds"><span class="hs-identifier hs-var">promote_tvs</span></a><span> </span><span class="hs-special">`</span><a href="#local-1628069583"><span class="hs-identifier hs-var">subVarSet</span></a><span class="hs-special">`</span><span> </span><a href="VarSet.html#subVarSet"><span class="hs-identifier hs-var">promote_tvs</span></a><span>
</span><a name="line-627"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">phi_tvs</span><span> </span><span class="hs-operator">$$</span><span>
</span><a name="line-628"></a><span>                   </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">closeOverKinds</span><span> </span><span class="hs-identifier">phi_tvs</span><span class="hs-special">)</span><span> </span><span class="hs-operator">$$</span><span>
</span><a name="line-629"></a><span>                   </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">promote_tvs</span><span> </span><span class="hs-operator">$$</span><span>
</span><a name="line-630"></a><span>                   </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">closeOverKinds</span><span> </span><span class="hs-identifier">promote_tvs</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-631"></a><span>           </span><span class="hs-comment">-- we really don't want a type to be promoted when its kind isn't!</span><span>
</span><a name="line-632"></a><span>
</span><a name="line-633"></a><span>           </span><span class="hs-comment">-- promoteTyVar ignores coercion variables</span><span>
</span><a name="line-634"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><span class="hs-special">(</span><a href="TcSimplify.html#promoteTyVar"><span class="hs-identifier hs-var">promoteTyVar</span></a><span> </span><a href="#local-1628069580"><span class="hs-identifier hs-var">outer_tclvl</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="VarSet.html#varSetElems"><span class="hs-identifier hs-var">varSetElems</span></a><span> </span><a href="#local-1628069583"><span class="hs-identifier hs-var">promote_tvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-635"></a><span>
</span><a name="line-636"></a><span>           </span><span class="hs-comment">-- Emit an implication constraint for the</span><span>
</span><a name="line-637"></a><span>           </span><span class="hs-comment">-- remaining constraints from the RHS</span><span>
</span><a name="line-638"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628069584"><a href="#local-1628069584"><span class="hs-identifier">bound_theta_vars</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><a href="TcMType.html#newEvVar"><span class="hs-identifier hs-var">TcM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">newEvVar</span></a><span> </span><a href="#local-1628069579"><span class="hs-identifier hs-var">bound_theta</span></a><span>
</span><a name="line-639"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628069585"><a href="#local-1628069585"><span class="hs-identifier">skol_info</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#InferSkol"><span class="hs-identifier hs-var">InferSkol</span></a><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-1628069587"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><a href="TcType.html#mkSigmaTy"><span class="hs-identifier hs-var">mkSigmaTy</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-1628069579"><span class="hs-identifier hs-var">bound_theta</span></a><span> </span><a href="#local-1628069588"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-640"></a><span>                                     </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-1628069587"><a href="#local-1628069587"><span class="hs-identifier">name</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628069588"><a href="#local-1628069588"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628069555"><span class="hs-identifier hs-var">name_taus</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-641"></a><span>                        </span><span class="hs-comment">-- Don't add the quantified variables here, because</span><span>
</span><a name="line-642"></a><span>                        </span><span class="hs-comment">-- they are also bound in ic_skols and we want them</span><span>
</span><a name="line-643"></a><span>                        </span><span class="hs-comment">-- to be tidied uniformly</span><span>
</span><a name="line-644"></a><span>
</span><a name="line-645"></a><span>             </span><a name="local-1628069586"><a href="#local-1628069586"><span class="hs-identifier">implic</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#Implic"><span class="hs-identifier hs-var">Implic</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ic_tclvl</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069552"><span class="hs-identifier hs-var">rhs_tclvl</span></a><span>
</span><a name="line-646"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ic_skols</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069578"><span class="hs-identifier hs-var">qtvs</span></a><span>
</span><a name="line-647"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ic_no_eqs</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-648"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ic_given</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069584"><span class="hs-identifier hs-var">bound_theta_vars</span></a><span>
</span><a name="line-649"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ic_wanted</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069565"><span class="hs-identifier hs-var">wanted_transformed</span></a><span>
</span><a name="line-650"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ic_status</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#IC_Unsolved"><span class="hs-identifier hs-var">IC_Unsolved</span></a><span>
</span><a name="line-651"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ic_binds</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-1628069560"><span class="hs-identifier hs-var">ev_binds_var</span></a><span>
</span><a name="line-652"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ic_info</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069585"><span class="hs-identifier hs-var">skol_info</span></a><span>
</span><a name="line-653"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ic_env</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069564"><span class="hs-identifier hs-var">tc_lcl_env</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-654"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#emitImplication"><span class="hs-identifier hs-var">emitImplication</span></a><span> </span><a href="#local-1628069586"><span class="hs-identifier hs-var">implic</span></a><span>
</span><a name="line-655"></a><span>
</span><a name="line-656"></a><span>         </span><span class="hs-comment">-- All done!</span><span>
</span><a name="line-657"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;} simplifyInfer/produced residual implication for quantification&quot;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-658"></a><span>         </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;quant_pred_candidates =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069575"><span class="hs-identifier hs-var">quant_pred_candidates</span></a><span>
</span><a name="line-659"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;zonked_taus&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069576"><span class="hs-identifier hs-var">zonked_taus</span></a><span>
</span><a name="line-660"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;zonked_tau_tvs=&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069581"><span class="hs-identifier hs-var">zonked_tau_tvs</span></a><span>
</span><a name="line-661"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;promote_tvs=&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069583"><span class="hs-identifier hs-var">promote_tvs</span></a><span>
</span><a name="line-662"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;bound_theta =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069579"><span class="hs-identifier hs-var">bound_theta</span></a><span>
</span><a name="line-663"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;qtvs =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069578"><span class="hs-identifier hs-var">qtvs</span></a><span>
</span><a name="line-664"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;implic =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069586"><span class="hs-identifier hs-var">implic</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-665"></a><span>
</span><a name="line-666"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="#local-1628069578"><span class="hs-identifier hs-var">qtvs</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628069584"><span class="hs-identifier hs-var">bound_theta_vars</span></a><span class="hs-special">,</span><span> </span><a href="TcEvidence.html#TcEvBinds"><span class="hs-identifier hs-var">TcEvBinds</span></a><span> </span><a href="#local-1628069560"><span class="hs-identifier hs-var">ev_binds_var</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-667"></a><span>
</span><a name="line-668"></a><span class="hs-identifier">mkSigDerivedWanteds</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#TcIdSigInfo"><span class="hs-identifier hs-type">TcIdSigInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">[</span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span class="hs-special">]</span><span>
</span><a name="line-669"></a><span class="hs-comment">-- See Note [Add deriveds for signature contexts]</span><span>
</span><a name="line-670"></a><a name="mkSigDerivedWanteds"><a href="TcSimplify.html#mkSigDerivedWanteds"><span class="hs-identifier">mkSigDerivedWanteds</span></a></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#TISI"><span class="hs-identifier hs-var">TISI</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sig_bndr</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#PartialSig"><span class="hs-identifier hs-var">PartialSig</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sig_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069589"><a href="#local-1628069589"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-671"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sig_theta</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069590"><a href="#local-1628069590"><span class="hs-identifier">theta</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sig_tau</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069591"><a href="#local-1628069591"><span class="hs-identifier">tau</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-672"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628069592"><a href="#local-1628069592"><span class="hs-identifier">skol_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#InferSkol"><span class="hs-identifier hs-var">InferSkol</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-1628069589"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><a href="TcType.html#mkSigmaTy"><span class="hs-identifier hs-var">mkSigmaTy</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-1628069590"><span class="hs-identifier hs-var">theta</span></a><span> </span><a href="#local-1628069591"><span class="hs-identifier hs-var">tau</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-673"></a><span>      </span><span class="hs-special">;</span><span> </span><a name="local-1628069593"><a href="#local-1628069593"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getCtLocM"><span class="hs-identifier hs-var">getCtLocM</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#GivenOrigin"><span class="hs-identifier hs-var">GivenOrigin</span></a><span> </span><a href="#local-1628069592"><span class="hs-identifier hs-var">skol_info</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="TcRnTypes.html#TypeLevel"><span class="hs-identifier hs-var">TypeLevel</span></a><span class="hs-special">)</span><span>
</span><a name="line-674"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="TcRnTypes.html#mkNonCanonical"><span class="hs-identifier hs-var">mkNonCanonical</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#CtDerived"><span class="hs-identifier hs-var">CtDerived</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctev_pred</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069594"><span class="hs-identifier hs-var">pred</span></a><span>
</span><a name="line-675"></a><span>                                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ctev_loc</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069593"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-676"></a><span>               </span><span class="hs-glyph">|</span><span> </span><a name="local-1628069594"><a href="#local-1628069594"><span class="hs-identifier">pred</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628069590"><span class="hs-identifier hs-var">theta</span></a><span> </span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-677"></a><span class="hs-identifier">mkSigDerivedWanteds</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-678"></a><span>
</span><a name="line-679"></a><span class="hs-comment">{- Note [Add deriveds for signature contexts]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this (Trac #11016):
  f2 :: (?x :: Int) =&gt; _
  f2 = ?x
We'll use plan InferGen because there are holes in the type.  But we want
to have the (?x :: Int) constraint floating around so that the functional
dependencies kick in.  Otherwise the occurrence of ?x on the RHS produces
constraint (?x :: alpha), and we wont unify alpha:=Int.

Solution: in simplifyInfer, just before simplifying the constraints
gathered from the RHS, add Derived constraints for the context of any
type signatures.  This is rare; if there is a type signature we'll usually
be doing CheckGen.  But it happens for signatures with holes.

************************************************************************
*                                                                      *
                Quantification
*                                                                      *
************************************************************************

Note [Deciding quantification]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If the monomorphism restriction does not apply, then we quantify as follows:
  * Take the global tyvars, and &quot;grow&quot; them using the equality constraints
    E.g.  if x:alpha is in the environment, and alpha ~ [beta] (which can
          happen because alpha is untouchable here) then do not quantify over
          beta, because alpha fixes beta, and beta is effectively free in
          the environment too
    These are the mono_tvs

  * Take the free vars of the tau-type (zonked_tau_tvs) and &quot;grow&quot; them
    using all the constraints.  These are tau_tvs_plus

  * Use quantifyTyVars to quantify over (tau_tvs_plus - mono_tvs), being
    careful to close over kinds, and to skolemise the quantified tyvars.
    (This actually unifies each quantifies meta-tyvar with a fresh skolem.)
    Result is qtvs.

  * Filter the constraints using pickQuantifiablePreds and the qtvs.
    We have to zonk the constraints first, so they &quot;see&quot; the freshly
    created skolems.

If the MR does apply, mono_tvs includes all the constrained tyvars --
including all covars -- and the quantified constraints are empty/insoluble.

-}</span><span>
</span><a name="line-726"></a><span>
</span><a name="line-727"></a><span class="hs-identifier">decideQuantification</span><span>
</span><a name="line-728"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>                  </span><span class="hs-comment">-- try the MR restriction?</span><span>
</span><a name="line-729"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcRnTypes.html#TcIdSigInfo"><span class="hs-identifier hs-type">TcIdSigInfo</span></a><span class="hs-special">]</span><span>
</span><a name="line-730"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span class="hs-special">,</span><span> </span><a href="TcType.html#TcTauType"><span class="hs-identifier hs-type">TcTauType</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- variables to be generalised (for errors only)</span><span>
</span><a name="line-731"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a><span class="hs-special">]</span><span>            </span><span class="hs-comment">-- candidate theta</span><span>
</span><a name="line-732"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a><span> </span><a href="TcType.html#TcTyCoVarSet"><span class="hs-identifier hs-type">TcTyCoVarSet</span></a><span>     </span><span class="hs-comment">-- dependent (kind) variables &amp; type variables</span><span>
</span><a name="line-733"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><a href="TcType.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a><span class="hs-special">]</span><span>       </span><span class="hs-comment">-- Quantify over these (skolems)</span><span>
</span><a name="line-734"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- and this context (fully zonked)</span><span>
</span><a name="line-735"></a><span class="hs-comment">-- See Note [Deciding quantification]</span><span>
</span><a name="line-736"></a><a name="decideQuantification"><a href="TcSimplify.html#decideQuantification"><span class="hs-identifier">decideQuantification</span></a></a><span> </span><a name="local-1628069595"><a href="#local-1628069595"><span class="hs-identifier">apply_mr</span></a></a><span> </span><a name="local-1628069596"><a href="#local-1628069596"><span class="hs-identifier">sigs</span></a></a><span> </span><a name="local-1628069597"><a href="#local-1628069597"><span class="hs-identifier">name_taus</span></a></a><span> </span><a name="local-1628069598"><a href="#local-1628069598"><span class="hs-identifier">constraints</span></a></a><span>
</span><a name="line-737"></a><span>                     </span><a name="local-1628069599"><a href="#local-1628069599"><span class="hs-identifier">zonked_pair</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-1628069600"><a href="#local-1628069600"><span class="hs-identifier">zonked_tau_kvs</span></a></a><span> </span><a name="local-1628069601"><a href="#local-1628069601"><span class="hs-identifier">zonked_tau_tvs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-738"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628069595"><span class="hs-identifier hs-var">apply_mr</span></a><span>     </span><span class="hs-comment">-- Apply the Monomorphism restriction</span><span>
</span><a name="line-739"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628069606"><a href="#local-1628069606"><span class="hs-identifier">gbl_tvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#tcGetGlobalTyCoVars"><span class="hs-identifier hs-var">tcGetGlobalTyCoVars</span></a><span>
</span><a name="line-740"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628069607"><a href="#local-1628069607"><span class="hs-identifier">constrained_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#tyCoVarsOfTypes"><span class="hs-identifier hs-var">tyCoVarsOfTypes</span></a><span> </span><a href="#local-1628069598"><span class="hs-identifier hs-var">constraints</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span class="hs-special">`</span><span>
</span><a name="line-741"></a><span>                               </span><a href="VarSet.html#filterVarSet"><span class="hs-identifier hs-var">filterVarSet</span></a><span> </span><a href="Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a><span> </span><a href="#local-1628069602"><span class="hs-identifier hs-var">zonked_tkvs</span></a><span>
</span><a name="line-742"></a><span>             </span><a name="local-1628069608"><a href="#local-1628069608"><span class="hs-identifier">mono_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069606"><span class="hs-identifier hs-var">gbl_tvs</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628069607"><span class="hs-identifier hs-var">constrained_tvs</span></a><span>
</span><a name="line-743"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628069609"><a href="#local-1628069609"><span class="hs-identifier">qtvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#quantify_tvs"><span class="hs-identifier hs-var">quantify_tvs</span></a><span> </span><a href="#local-1628069596"><span class="hs-identifier hs-var">sigs</span></a><span> </span><a href="#local-1628069608"><span class="hs-identifier hs-var">mono_tvs</span></a><span> </span><a href="#local-1628069599"><span class="hs-identifier hs-var">zonked_pair</span></a><span>
</span><a name="line-744"></a><span>
</span><a name="line-745"></a><span>           </span><span class="hs-comment">-- Warn about the monomorphism restriction</span><span>
</span><a name="line-746"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628069610"><a href="#local-1628069610"><span class="hs-identifier">warn_mono</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#woptM"><span class="hs-identifier hs-var">woptM</span></a><span> </span><a href="DynFlags.html#Opt_WarnMonomorphism"><span class="hs-identifier hs-var">Opt_WarnMonomorphism</span></a><span>
</span><a name="line-747"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628069611"><a href="#local-1628069611"><span class="hs-identifier">mr_bites</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069607"><span class="hs-identifier hs-var">constrained_tvs</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#intersectsVarSet"><span class="hs-identifier hs-var">intersectsVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628069602"><span class="hs-identifier hs-var">zonked_tkvs</span></a><span>
</span><a name="line-748"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#warnTc"><span class="hs-identifier hs-var">warnTc</span></a><span> </span><span class="hs-special">(</span><a href="DynFlags.html#Reason"><span class="hs-identifier hs-var">Reason</span></a><span> </span><a href="DynFlags.html#Opt_WarnMonomorphism"><span class="hs-identifier hs-var">Opt_WarnMonomorphism</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-1628069610"><span class="hs-identifier hs-var">warn_mono</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-1628069611"><span class="hs-identifier hs-var">mr_bites</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-749"></a><span>         </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;The Monomorphism Restriction applies to the binding&quot;</span><span>
</span><a name="line-750"></a><span>               </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#plural"><span class="hs-identifier hs-var">plural</span></a><span> </span><a href="#local-1628069603"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;for&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="#local-1628069604"><span class="hs-identifier hs-var">pp_bndrs</span></a><span class="hs-special">)</span><span>
</span><a name="line-751"></a><span>             </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Consider giving a type signature for&quot;</span><span>
</span><a name="line-752"></a><span>                </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><span class="hs-keyword">if</span><span> </span><a href="Util.html#isSingleton"><span class="hs-identifier hs-var">isSingleton</span></a><span> </span><a href="#local-1628069603"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-1628069604"><span class="hs-identifier hs-var">pp_bndrs</span></a><span>
</span><a name="line-753"></a><span>                                         </span><span class="hs-keyword">else</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;these binders&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-754"></a><span>
</span><a name="line-755"></a><span>       </span><span class="hs-comment">-- All done</span><span>
</span><a name="line-756"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;decideQuantification 1&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069598"><span class="hs-identifier hs-var">constraints</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069606"><span class="hs-identifier hs-var">gbl_tvs</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069608"><span class="hs-identifier hs-var">mono_tvs</span></a><span>
</span><a name="line-757"></a><span>                                                </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069609"><span class="hs-identifier hs-var">qtvs</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069611"><span class="hs-identifier hs-var">mr_bites</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-758"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628069609"><span class="hs-identifier hs-var">qtvs</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-759"></a><span>
</span><a name="line-760"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-761"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628069612"><a href="#local-1628069612"><span class="hs-identifier">gbl_tvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#tcGetGlobalTyCoVars"><span class="hs-identifier hs-var">tcGetGlobalTyCoVars</span></a><span>
</span><a name="line-762"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628069613"><a href="#local-1628069613"><span class="hs-identifier">mono_tvs</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TcSimplify.html#growThetaTyVars"><span class="hs-identifier hs-var">growThetaTyVars</span></a><span> </span><a href="#local-1628069605"><span class="hs-identifier hs-var">equality_constraints</span></a><span> </span><a href="#local-1628069612"><span class="hs-identifier hs-var">gbl_tvs</span></a><span>
</span><a name="line-763"></a><span>             </span><a name="local-1628069614"><a href="#local-1628069614"><span class="hs-identifier">tau_tvs_plus</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSimplify.html#growThetaTyVars"><span class="hs-identifier hs-var">growThetaTyVars</span></a><span> </span><a href="#local-1628069598"><span class="hs-identifier hs-var">constraints</span></a><span> </span><a href="#local-1628069601"><span class="hs-identifier hs-var">zonked_tau_tvs</span></a><span>
</span><a name="line-764"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628069615"><a href="#local-1628069615"><span class="hs-identifier">qtvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#quantify_tvs"><span class="hs-identifier hs-var">quantify_tvs</span></a><span> </span><a href="#local-1628069596"><span class="hs-identifier hs-var">sigs</span></a><span> </span><a href="#local-1628069613"><span class="hs-identifier hs-var">mono_tvs</span></a><span> </span><span class="hs-special">(</span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a href="#local-1628069600"><span class="hs-identifier hs-var">zonked_tau_kvs</span></a><span> </span><a href="#local-1628069614"><span class="hs-identifier hs-var">tau_tvs_plus</span></a><span class="hs-special">)</span><span>
</span><a name="line-765"></a><span>          </span><span class="hs-comment">-- We don't grow the kvs, as there's no real need to. Recall</span><span>
</span><a name="line-766"></a><span>          </span><span class="hs-comment">-- that quantifyTyVars uses the separation between kvs and tvs</span><span>
</span><a name="line-767"></a><span>          </span><span class="hs-comment">-- only for defaulting, and we don't want (ever) to default a tv</span><span>
</span><a name="line-768"></a><span>          </span><span class="hs-comment">-- to *. So, don't grow the kvs.</span><span>
</span><a name="line-769"></a><span>
</span><a name="line-770"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628069616"><a href="#local-1628069616"><span class="hs-identifier">constraints</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTcTypes"><span class="hs-identifier hs-var">TcM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">zonkTcTypes</span></a><span> </span><a href="#local-1628069598"><span class="hs-identifier hs-var">constraints</span></a><span>
</span><a name="line-771"></a><span>                 </span><span class="hs-comment">-- quantifyTyVars turned some meta tyvars into</span><span>
</span><a name="line-772"></a><span>                 </span><span class="hs-comment">-- quantified skolems, so we have to zonk again</span><span>
</span><a name="line-773"></a><span>
</span><a name="line-774"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628069617"><a href="#local-1628069617"><span class="hs-identifier">theta</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TcType.html#pickQuantifiablePreds"><span class="hs-identifier hs-var">pickQuantifiablePreds</span></a><span>
</span><a name="line-775"></a><span>                           </span><span class="hs-special">(</span><a href="VarSet.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a><span> </span><a href="#local-1628069615"><span class="hs-identifier hs-var">qtvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#concatMap"><span class="hs-identifier hs-var">concatMap</span></a><span> </span><span class="hs-identifier">sig_theta</span><span> </span><a href="#local-1628069596"><span class="hs-identifier hs-var">sigs</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628069616"><span class="hs-identifier hs-var">constraints</span></a><span>
</span><a name="line-776"></a><span>             </span><a name="local-1628069618"><a href="#local-1628069618"><span class="hs-identifier">min_theta</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcType.html#mkMinimalBySCs"><span class="hs-identifier hs-var">mkMinimalBySCs</span></a><span> </span><a href="#local-1628069617"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-777"></a><span>               </span><span class="hs-comment">-- See Note [Minimize by Superclasses]</span><span>
</span><a name="line-778"></a><span>
</span><a name="line-779"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;decideQuantification 2&quot;</span><span>
</span><a name="line-780"></a><span>           </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;constraints:&quot;</span><span>  </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069616"><span class="hs-identifier hs-var">constraints</span></a><span>
</span><a name="line-781"></a><span>                 </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;gbl_tvs:&quot;</span><span>      </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069612"><span class="hs-identifier hs-var">gbl_tvs</span></a><span>
</span><a name="line-782"></a><span>                 </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;mono_tvs:&quot;</span><span>     </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069613"><span class="hs-identifier hs-var">mono_tvs</span></a><span>
</span><a name="line-783"></a><span>                 </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;zonked_kvs:&quot;</span><span>   </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069600"><span class="hs-identifier hs-var">zonked_tau_kvs</span></a><span>
</span><a name="line-784"></a><span>                 </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;tau_tvs_plus:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069614"><span class="hs-identifier hs-var">tau_tvs_plus</span></a><span>
</span><a name="line-785"></a><span>                 </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;qtvs:&quot;</span><span>         </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069615"><span class="hs-identifier hs-var">qtvs</span></a><span>
</span><a name="line-786"></a><span>                 </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;min_theta:&quot;</span><span>    </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069618"><span class="hs-identifier hs-var">min_theta</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-787"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628069615"><span class="hs-identifier hs-var">qtvs</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628069618"><span class="hs-identifier hs-var">min_theta</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-788"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-789"></a><span>    </span><a name="local-1628069602"><a href="#local-1628069602"><span class="hs-identifier">zonked_tkvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069600"><span class="hs-identifier hs-var">zonked_tau_kvs</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628069601"><span class="hs-identifier hs-var">zonked_tau_tvs</span></a><span>
</span><a name="line-790"></a><span>    </span><a name="local-1628069603"><a href="#local-1628069603"><span class="hs-identifier">bndrs</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a><span> </span><a href="#local-1628069597"><span class="hs-identifier hs-var">name_taus</span></a><span>
</span><a name="line-791"></a><span>    </span><a name="local-1628069604"><a href="#local-1628069604"><span class="hs-identifier">pp_bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprWithCommas"><span class="hs-identifier hs-var">pprWithCommas</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628069603"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-792"></a><span>    </span><a name="local-1628069605"><a href="#local-1628069605"><span class="hs-identifier">equality_constraints</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a><span> </span><a href="Type.html#isEqPred"><span class="hs-identifier hs-var">isEqPred</span></a><span> </span><a href="#local-1628069598"><span class="hs-identifier hs-var">constraints</span></a><span>
</span><a name="line-793"></a><span>
</span><a name="line-794"></a><span class="hs-identifier">quantify_tvs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TcRnTypes.html#TcIdSigInfo"><span class="hs-identifier hs-type">TcIdSigInfo</span></a><span class="hs-special">]</span><span>
</span><a name="line-795"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcTyVarSet"><span class="hs-identifier hs-type">TcTyVarSet</span></a><span>   </span><span class="hs-comment">-- the monomorphic tvs</span><span>
</span><a name="line-796"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a><span> </span><a href="TcType.html#TcTyVarSet"><span class="hs-identifier hs-type">TcTyVarSet</span></a><span>   </span><span class="hs-comment">-- kvs, tvs to quantify</span><span>
</span><a name="line-797"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">[</span><a href="TcType.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a><span class="hs-special">]</span><span>
</span><a name="line-798"></a><span class="hs-comment">-- See Note [Which type variables to quantify]</span><span>
</span><a name="line-799"></a><a name="quantify_tvs"><a href="TcSimplify.html#quantify_tvs"><span class="hs-identifier">quantify_tvs</span></a></a><span> </span><a name="local-1628069619"><a href="#local-1628069619"><span class="hs-identifier">sigs</span></a></a><span> </span><a name="local-1628069620"><a href="#local-1628069620"><span class="hs-identifier">mono_tvs</span></a></a><span> </span><span class="hs-special">(</span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-1628069621"><a href="#local-1628069621"><span class="hs-identifier">tau_kvs</span></a></a><span> </span><a name="local-1628069622"><a href="#local-1628069622"><span class="hs-identifier">tau_tvs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-800"></a><span>   </span><span class="hs-comment">-- NB: don't use quantifyZonkedTyVars because the sig stuff might</span><span>
</span><a name="line-801"></a><span>   </span><span class="hs-comment">-- be unzonked</span><span>
</span><a name="line-802"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcMType.html#quantifyTyVars"><span class="hs-identifier hs-var">quantifyTyVars</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628069620"><span class="hs-identifier hs-var">mono_tvs</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#delVarSetList"><span class="hs-identifier hs-var">delVarSetList</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628069623"><span class="hs-identifier hs-var">sig_qtvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-803"></a><span>                   </span><span class="hs-special">(</span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a href="#local-1628069621"><span class="hs-identifier hs-var">tau_kvs</span></a><span>
</span><a name="line-804"></a><span>                         </span><span class="hs-special">(</span><a href="#local-1628069622"><span class="hs-identifier hs-var">tau_tvs</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#extendVarSetList"><span class="hs-identifier hs-var">extendVarSetList</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628069623"><span class="hs-identifier hs-var">sig_qtvs</span></a><span>
</span><a name="line-805"></a><span>                                  </span><span class="hs-special">`</span><a href="VarSet.html#extendVarSetList"><span class="hs-identifier hs-var">extendVarSetList</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628069624"><span class="hs-identifier hs-var">sig_wcs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-806"></a><span>                   </span><span class="hs-comment">-- NB: quantifyTyVars zonks its arguments</span><span>
</span><a name="line-807"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-808"></a><span>    </span><a name="local-1628069623"><a href="#local-1628069623"><span class="hs-identifier">sig_qtvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-1628069626"><span class="hs-identifier hs-var">skol</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-1628069625"><a href="#local-1628069625"><span class="hs-identifier">sig</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628069619"><span class="hs-identifier hs-var">sigs</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-1628069626"><a href="#local-1628069626"><span class="hs-identifier">skol</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">sig_skols</span><span> </span><a href="#local-1628069625"><span class="hs-identifier hs-var">sig</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-809"></a><span>    </span><a name="local-1628069624"><a href="#local-1628069624"><span class="hs-identifier">sig_wcs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-1628069628"><span class="hs-identifier hs-var">wc</span></a><span>   </span><span class="hs-glyph">|</span><span> </span><a href="TcRnTypes.html#TISI"><span class="hs-identifier hs-var">TISI</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sig_bndr</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#PartialSig"><span class="hs-identifier hs-var">PartialSig</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sig_wcs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069627"><a href="#local-1628069627"><span class="hs-identifier">wcs</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628069619"><span class="hs-identifier hs-var">sigs</span></a><span>
</span><a name="line-810"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-1628069628"><a href="#local-1628069628"><span class="hs-identifier">wc</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628069627"><span class="hs-identifier hs-var">wcs</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-811"></a><span>
</span><a name="line-812"></a><span>
</span><a name="line-813"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-814"></a><span class="hs-identifier">growThetaTyVars</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#ThetaType"><span class="hs-identifier hs-type">ThetaType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#TyCoVarSet"><span class="hs-identifier hs-type">TyCoVarSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#TyVarSet"><span class="hs-identifier hs-type">TyVarSet</span></a><span>
</span><a name="line-815"></a><span class="hs-comment">-- See Note [Growing the tau-tvs using constraints]</span><span>
</span><a name="line-816"></a><span class="hs-comment">-- NB: only returns tyvars, never covars</span><span>
</span><a name="line-817"></a><a name="growThetaTyVars"><a href="TcSimplify.html#growThetaTyVars"><span class="hs-identifier">growThetaTyVars</span></a></a><span> </span><a name="local-1628069629"><a href="#local-1628069629"><span class="hs-identifier">theta</span></a></a><span> </span><a name="local-1628069630"><a href="#local-1628069630"><span class="hs-identifier">tvs</span></a></a><span>
</span><a name="line-818"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1628069629"><span class="hs-identifier hs-var">theta</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069631"><span class="hs-identifier hs-var">tvs_only</span></a><span>
</span><a name="line-819"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#filterVarSet"><span class="hs-identifier hs-var">filterVarSet</span></a><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-820"></a><span>                 </span><a href="VarSet.html#transCloVarSet"><span class="hs-identifier hs-var">transCloVarSet</span></a><span> </span><a href="#local-1628069635"><span class="hs-identifier hs-var">mk_next</span></a><span> </span><a href="#local-1628069632"><span class="hs-identifier hs-var">seed_tvs</span></a><span>
</span><a name="line-821"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-822"></a><span>    </span><a name="local-1628069631"><a href="#local-1628069631"><span class="hs-identifier">tvs_only</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#filterVarSet"><span class="hs-identifier hs-var">filterVarSet</span></a><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-1628069630"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-823"></a><span>    </span><a name="local-1628069632"><a href="#local-1628069632"><span class="hs-identifier">seed_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069630"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span class="hs-special">`</span><span> </span><a href="TyCoRep.html#tyCoVarsOfTypes"><span class="hs-identifier hs-var">tyCoVarsOfTypes</span></a><span> </span><a href="#local-1628069633"><span class="hs-identifier hs-var">ips</span></a><span>
</span><a name="line-824"></a><span>    </span><span class="hs-special">(</span><a name="local-1628069633"><a href="#local-1628069633"><span class="hs-identifier">ips</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628069634"><a href="#local-1628069634"><span class="hs-identifier">non_ips</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.OldList.html#partition"><span class="hs-identifier hs-var">partition</span></a><span> </span><a href="Type.html#isIPPred"><span class="hs-identifier hs-var">isIPPred</span></a><span> </span><a href="#local-1628069629"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-825"></a><span>                         </span><span class="hs-comment">-- See Note [Inheriting implicit parameters] in TcType</span><span>
</span><a name="line-826"></a><span>
</span><a name="line-827"></a><span>    </span><span class="hs-identifier">mk_next</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span> </span><span class="hs-comment">-- Maps current set to newly-grown ones</span><span>
</span><a name="line-828"></a><span>    </span><a name="local-1628069635"><a href="#local-1628069635"><span class="hs-identifier">mk_next</span></a></a><span> </span><a name="local-1628069637"><a href="#local-1628069637"><span class="hs-identifier">so_far</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#foldr"><span class="hs-identifier hs-var">foldr</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628069636"><span class="hs-identifier hs-var">grow_one</span></a><span> </span><a href="#local-1628069637"><span class="hs-identifier hs-var">so_far</span></a><span class="hs-special">)</span><span> </span><a href="VarSet.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a><span> </span><a href="#local-1628069634"><span class="hs-identifier hs-var">non_ips</span></a><span>
</span><a name="line-829"></a><span>    </span><a name="local-1628069636"><a href="#local-1628069636"><span class="hs-identifier">grow_one</span></a></a><span> </span><a name="local-1628069638"><a href="#local-1628069638"><span class="hs-identifier">so_far</span></a></a><span> </span><a name="local-1628069639"><a href="#local-1628069639"><span class="hs-identifier">pred</span></a></a><span> </span><a name="local-1628069640"><a href="#local-1628069640"><span class="hs-identifier">tvs</span></a></a><span>
</span><a name="line-830"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628069641"><span class="hs-identifier hs-var">pred_tvs</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#intersectsVarSet"><span class="hs-identifier hs-var">intersectsVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628069638"><span class="hs-identifier hs-var">so_far</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069640"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628069641"><span class="hs-identifier hs-var">pred_tvs</span></a><span>
</span><a name="line-831"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>                          </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069640"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-832"></a><span>       </span><span class="hs-keyword">where</span><span>
</span><a name="line-833"></a><span>         </span><a name="local-1628069641"><a href="#local-1628069641"><span class="hs-identifier">pred_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#tyCoVarsOfType"><span class="hs-identifier hs-var">tyCoVarsOfType</span></a><span> </span><a href="#local-1628069639"><span class="hs-identifier hs-var">pred</span></a><span>
</span><a name="line-834"></a><span>
</span><a name="line-835"></a><span class="hs-comment">{- Note [Which type variables to quantify]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When choosing type variables to quantify, the basic plan is to
quantify over all type variables that are
 * free in the tau_tvs, and
 * not forced to be monomorphic (mono_tvs),
   for example by being free in the environment.

However, for a pattern binding, or with wildcards, we might
be doing inference *in the presence of a type signature*.
Mostly, if there is a signature we use CheckGen, not InferGen,
but with pattern bindings or wildcards we might do InferGen
and still have a type signature.  For example:
   f :: _ -&gt; a
   f x = ...
or
   g :: (Eq _a) =&gt; _b -&gt; _b
or
   p :: a -&gt; a
   (p,q) = e
In all these cases we use plan InferGen, and hence call simplifyInfer.
But those 'a' variables are skolems, and we should be sure to quantify
over them, regardless of the monomorphism restriction etc.  If we
don't, when reporting a type error we panic when we find that a
skolem isn't bound by any enclosing implication.

Moreover we must quantify over all wildcards that are not free in
the environment.  In the case of 'g' for example, silly though it is,
we want to get the inferred type
   g :: forall t. Eq t =&gt; Int -&gt; Int
and then report ambiguity, rather than *not* quantifying over 't'
and getting some much more mysterious error later.  A similar case
is
  h :: F _a -&gt; Int

That's why we pass sigs to simplifyInfer, and make sure (in
quantify_tvs) that we do quantify over them.  Trac #10615 is
a case in point.

Note [Quantifying over equality constraints]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Should we quantify over an equality constraint (s ~ t)?  In general, we don't.
Doing so may simply postpone a type error from the function definition site to
its call site.  (At worst, imagine (Int ~ Bool)).

However, consider this
         forall a. (F [a] ~ Int) =&gt; blah
Should we quantify over the (F [a] ~ Int)?  Perhaps yes, because at the call
site we will know 'a', and perhaps we have instance  F [Bool] = Int.
So we *do* quantify over a type-family equality where the arguments mention
the quantified variables.

Note [Growing the tau-tvs using constraints]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
(growThetaTyVars insts tvs) is the result of extending the set
    of tyvars, tvs, using all conceivable links from pred

E.g. tvs = {a}, preds = {H [a] b, K (b,Int) c, Eq e}
Then growThetaTyVars preds tvs = {a,b,c}

Notice that
   growThetaTyVars is conservative       if v might be fixed by vs
                                         =&gt; v `elem` grow(vs,C)

Note [Quantification with errors]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we find that the RHS of the definition has some absolutely-insoluble
constraints, we abandon all attempts to find a context to quantify
over, and instead make the function fully-polymorphic in whatever
type we have found.  For two reasons
  a) Minimise downstream errors
  b) Avoid spurious errors from this function

But NB that we must include *derived* errors in the check. Example:
    (a::*) ~ Int#
We get an insoluble derived error *~#, and we don't want to discard
it before doing the isInsolubleWC test!  (Trac #8262)

Note [Default while Inferring]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Our current plan is that defaulting only happens at simplifyTop and
not simplifyInfer.  This may lead to some insoluble deferred constraints.
Example:

instance D g =&gt; C g Int b

constraint inferred = (forall b. 0 =&gt; C gamma alpha b) /\ Num alpha
type inferred       = gamma -&gt; gamma

Now, if we try to default (alpha := Int) we will be able to refine the implication to
  (forall b. 0 =&gt; C gamma Int b)
which can then be simplified further to
  (forall b. 0 =&gt; D gamma)
Finally, we /can/ approximate this implication with (D gamma) and infer the quantified
type:  forall g. D g =&gt; g -&gt; g

Instead what will currently happen is that we will get a quantified type
(forall g. g -&gt; g) and an implication:
       forall g. 0 =&gt; (forall b. 0 =&gt; C g alpha b) /\ Num alpha

Which, even if the simplifyTop defaults (alpha := Int) we will still be left with an
unsolvable implication:
       forall g. 0 =&gt; (forall b. 0 =&gt; D g)

The concrete example would be:
       h :: C g a s =&gt; g -&gt; a -&gt; ST s a
       f (x::gamma) = (\_ -&gt; x) (runST (h x (undefined::alpha)) + 1)

But it is quite tedious to do defaulting and resolve the implication constraints, and
we have not observed code breaking because of the lack of defaulting in inference, so
we don't do it for now.



Note [Minimize by Superclasses]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When we quantify over a constraint, in simplifyInfer we need to
quantify over a constraint that is minimal in some sense: For
instance, if the final wanted constraint is (Eq alpha, Ord alpha),
we'd like to quantify over Ord alpha, because we can just get Eq alpha
from superclass selection from Ord alpha. This minimization is what
mkMinimalBySCs does. Then, simplifyInfer uses the minimal constraint
to check the original wanted.


Note [Avoid unnecessary constraint simplification]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    -------- NB NB NB (Jun 12) -------------
    This note not longer applies; see the notes with Trac #4361.
    But I'm leaving it in here so we remember the issue.)
    ----------------------------------------
When inferring the type of a let-binding, with simplifyInfer,
try to avoid unnecessarily simplifying class constraints.
Doing so aids sharing, but it also helps with delicate
situations like

   instance C t =&gt; C [t] where ..

   f :: C [t] =&gt; ....
   f x = let g y = ...(constraint C [t])...
         in ...
When inferring a type for 'g', we don't want to apply the
instance decl, because then we can't satisfy (C t).  So we
just notice that g isn't quantified over 't' and partition
the constraints before simplifying.

This only half-works, but then let-generalisation only half-works.

*********************************************************************************
*                                                                                 *
*                                 Main Simplifier                                 *
*                                                                                 *
***********************************************************************************

-}</span><span>
</span><a name="line-990"></a><span>
</span><a name="line-991"></a><span class="hs-identifier">simplifyWantedsTcM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TcRnTypes.html#CtEvidence"><span class="hs-identifier hs-type">CtEvidence</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TcRnTypes.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a><span>
</span><a name="line-992"></a><span class="hs-comment">-- Solve the specified Wanted constraints</span><span>
</span><a name="line-993"></a><span class="hs-comment">-- Discard the evidence binds</span><span>
</span><a name="line-994"></a><span class="hs-comment">-- Discards all Derived stuff in result</span><span>
</span><a name="line-995"></a><span class="hs-comment">-- Postcondition: fully zonked and unflattened constraints</span><span>
</span><a name="line-996"></a><a name="simplifyWantedsTcM"><a href="TcSimplify.html#simplifyWantedsTcM"><span class="hs-identifier">simplifyWantedsTcM</span></a></a><span> </span><a name="local-1628069642"><a href="#local-1628069642"><span class="hs-identifier">wanted</span></a></a><span>
</span><a name="line-997"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;simplifyWantedsTcM {&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069642"><span class="hs-identifier hs-var">wanted</span></a><span class="hs-special">)</span><span>
</span><a name="line-998"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628069643"><a href="#local-1628069643"><span class="hs-identifier">result</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#runTcS"><span class="hs-identifier hs-var">runTcS</span></a><span> </span><span class="hs-special">(</span><a href="TcSimplify.html#solveWantedsAndDrop"><span class="hs-identifier hs-var">solveWantedsAndDrop</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcRnTypes.html#mkSimpleWC"><span class="hs-identifier hs-var">mkSimpleWC</span></a><span> </span><a href="#local-1628069642"><span class="hs-identifier hs-var">wanted</span></a><span class="hs-special">)</span><span>
</span><a name="line-999"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628069644"><a href="#local-1628069644"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkWC"><span class="hs-identifier hs-var">TcM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">zonkWC</span></a><span> </span><a href="#local-1628069643"><span class="hs-identifier hs-var">result</span></a><span>
</span><a name="line-1000"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;simplifyWantedsTcM }&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069644"><span class="hs-identifier hs-var">result</span></a><span class="hs-special">)</span><span>
</span><a name="line-1001"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-1628069644"><span class="hs-identifier hs-var">result</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1002"></a><span>
</span><a name="line-1003"></a><span class="hs-identifier">solveWantedsAndDrop</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="TcRnTypes.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a><span>
</span><a name="line-1004"></a><span class="hs-comment">-- Since solveWanteds returns the residual WantedConstraints,</span><span>
</span><a name="line-1005"></a><span class="hs-comment">-- it should always be called within a runTcS or something similar,</span><span>
</span><a name="line-1006"></a><span class="hs-comment">-- Result is not zonked</span><span>
</span><a name="line-1007"></a><a name="solveWantedsAndDrop"><a href="TcSimplify.html#solveWantedsAndDrop"><span class="hs-identifier">solveWantedsAndDrop</span></a></a><span> </span><a name="local-1628069645"><a href="#local-1628069645"><span class="hs-identifier">wanted</span></a></a><span>
</span><a name="line-1008"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628069646"><a href="#local-1628069646"><span class="hs-identifier">wc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#solveWanteds"><span class="hs-identifier hs-var">solveWanteds</span></a><span> </span><a href="#local-1628069645"><span class="hs-identifier hs-var">wanted</span></a><span>
</span><a name="line-1009"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#dropDerivedWC"><span class="hs-identifier hs-var">dropDerivedWC</span></a><span> </span><a href="#local-1628069646"><span class="hs-identifier hs-var">wc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1010"></a><span>
</span><a name="line-1011"></a><span class="hs-identifier">solveWanteds</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="TcRnTypes.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a><span>
</span><a name="line-1012"></a><span class="hs-comment">-- so that the inert set doesn't mindlessly propagate.</span><span>
</span><a name="line-1013"></a><span class="hs-comment">-- NB: wc_simples may be wanted /or/ derived now</span><span>
</span><a name="line-1014"></a><a name="solveWanteds"><a href="TcSimplify.html#solveWanteds"><span class="hs-identifier">solveWanteds</span></a></a><span> </span><a name="local-1628069647"><a href="#local-1628069647"><span class="hs-identifier">wc</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TcRnTypes.html#WC"><span class="hs-identifier hs-var">WC</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wc_simple</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069648"><a href="#local-1628069648"><span class="hs-identifier">simples</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">wc_insol</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069649"><a href="#local-1628069649"><span class="hs-identifier">insols</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">wc_impl</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069650"><a href="#local-1628069650"><span class="hs-identifier">implics</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1015"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;solveWanteds {&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069647"><span class="hs-identifier hs-var">wc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1016"></a><span>
</span><a name="line-1017"></a><span>         </span><span class="hs-comment">-- Try the simple bit, including insolubles. Solving insolubles a</span><span>
</span><a name="line-1018"></a><span>         </span><span class="hs-comment">-- second time round is a bit of a waste; but the code is simple</span><span>
</span><a name="line-1019"></a><span>         </span><span class="hs-comment">-- and the program is wrong anyway, and we don't run the danger</span><span>
</span><a name="line-1020"></a><span>         </span><span class="hs-comment">-- of adding Derived insolubles twice; see</span><span>
</span><a name="line-1021"></a><span>         </span><span class="hs-comment">-- TcSMonad Note [Do not add duplicate derived insolubles]</span><span>
</span><a name="line-1022"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628069651"><a href="#local-1628069651"><span class="hs-identifier">wc1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcInteract.html#solveSimpleWanteds"><span class="hs-identifier hs-var">solveSimpleWanteds</span></a><span> </span><a href="#local-1628069648"><span class="hs-identifier hs-var">simples</span></a><span>
</span><a name="line-1023"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628069652"><a href="#local-1628069652"><span class="hs-identifier">no_new_scs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628069653"><a href="#local-1628069653"><span class="hs-identifier">wc1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#expandSuperClasses"><span class="hs-identifier hs-var">expandSuperClasses</span></a><span> </span><a href="#local-1628069651"><span class="hs-identifier hs-var">wc1</span></a><span>
</span><a name="line-1024"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a href="TcRnTypes.html#WC"><span class="hs-identifier hs-var">WC</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wc_simple</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069654"><a href="#local-1628069654"><span class="hs-identifier">simples1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">wc_insol</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069655"><a href="#local-1628069655"><span class="hs-identifier">insols1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">wc_impl</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069656"><a href="#local-1628069656"><span class="hs-identifier">implics1</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069653"><span class="hs-identifier hs-var">wc1</span></a><span>
</span><a name="line-1025"></a><span>
</span><a name="line-1026"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628069657"><a href="#local-1628069657"><span class="hs-identifier">floated_eqs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628069658"><a href="#local-1628069658"><span class="hs-identifier">implics2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#solveNestedImplications"><span class="hs-identifier hs-var">solveNestedImplications</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628069650"><span class="hs-identifier hs-var">implics</span></a><span> </span><span class="hs-special">`</span><a href="Bag.html#unionBags"><span class="hs-identifier hs-var">unionBags</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628069656"><span class="hs-identifier hs-var">implics1</span></a><span class="hs-special">)</span><span>
</span><a name="line-1027"></a><span>
</span><a name="line-1028"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628069659"><a href="#local-1628069659"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a><span>
</span><a name="line-1029"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628069660"><a href="#local-1628069660"><span class="hs-identifier">final_wc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#simpl_loop"><span class="hs-identifier hs-var">simpl_loop</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">solverIterations</span><span> </span><a href="#local-1628069659"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628069657"><span class="hs-identifier hs-var">floated_eqs</span></a><span> </span><a href="#local-1628069652"><span class="hs-identifier hs-var">no_new_scs</span></a><span>
</span><a name="line-1030"></a><span>                                </span><span class="hs-special">(</span><a href="TcRnTypes.html#WC"><span class="hs-identifier hs-var">WC</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wc_simple</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069654"><span class="hs-identifier hs-var">simples1</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">wc_impl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069658"><span class="hs-identifier hs-var">implics2</span></a><span>
</span><a name="line-1031"></a><span>                                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">wc_insol</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069649"><span class="hs-identifier hs-var">insols</span></a><span> </span><span class="hs-special">`</span><a href="Bag.html#unionBags"><span class="hs-identifier hs-var">unionBags</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628069655"><span class="hs-identifier hs-var">insols1</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1032"></a><span>
</span><a name="line-1033"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628069661"><a href="#local-1628069661"><span class="hs-identifier">bb</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getTcEvBindsMap"><span class="hs-identifier hs-var">TcS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">getTcEvBindsMap</span></a><span>
</span><a name="line-1034"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;solveWanteds }&quot;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1035"></a><span>                 </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;final wc =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069660"><span class="hs-identifier hs-var">final_wc</span></a><span>
</span><a name="line-1036"></a><span>                      </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;current evbinds  =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#evBindMapBinds"><span class="hs-identifier hs-var">evBindMapBinds</span></a><span> </span><a href="#local-1628069661"><span class="hs-identifier hs-var">bb</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1037"></a><span>
</span><a name="line-1038"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-1628069660"><span class="hs-identifier hs-var">final_wc</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1039"></a><span>
</span><a name="line-1040"></a><span class="hs-identifier">simpl_loop</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#IntWithInf"><span class="hs-identifier hs-type">IntWithInf</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#Cts"><span class="hs-identifier hs-type">Cts</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1041"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a><span>
</span><a name="line-1042"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="TcRnTypes.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a><span>
</span><a name="line-1043"></a><a name="simpl_loop"><a href="TcSimplify.html#simpl_loop"><span class="hs-identifier">simpl_loop</span></a></a><span> </span><a name="local-1628069662"><a href="#local-1628069662"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-1628069663"><a href="#local-1628069663"><span class="hs-identifier">limit</span></a></a><span> </span><a name="local-1628069664"><a href="#local-1628069664"><span class="hs-identifier">floated_eqs</span></a></a><span> </span><a name="local-1628069665"><a href="#local-1628069665"><span class="hs-identifier">no_new_scs</span></a></a><span>
</span><a name="line-1044"></a><span>           </span><a name="local-1628069666"><a href="#local-1628069666"><span class="hs-identifier">wc</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TcRnTypes.html#WC"><span class="hs-identifier hs-var">WC</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wc_simple</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069667"><a href="#local-1628069667"><span class="hs-identifier">simples</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">wc_insol</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069668"><a href="#local-1628069668"><span class="hs-identifier">insols</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">wc_impl</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069669"><a href="#local-1628069669"><span class="hs-identifier">implics</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1045"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Bag.html#isEmptyBag"><span class="hs-identifier hs-var">isEmptyBag</span></a><span> </span><a href="#local-1628069664"><span class="hs-identifier hs-var">floated_eqs</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-1628069665"><span class="hs-identifier hs-var">no_new_scs</span></a><span>
</span><a name="line-1046"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-1628069666"><span class="hs-identifier hs-var">wc</span></a><span>  </span><span class="hs-comment">-- Done!</span><span>
</span><a name="line-1047"></a><span>
</span><a name="line-1048"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628069662"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">`</span><a href="BasicTypes.html#intGtLimit"><span class="hs-identifier hs-var">intGtLimit</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628069663"><span class="hs-identifier hs-var">limit</span></a><span>
</span><a name="line-1049"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Add an error (not a warning) if we blow the limit,</span><span>
</span><a name="line-1050"></a><span>         </span><span class="hs-comment">-- Typically if we blow the limit we are going to report some other error</span><span>
</span><a name="line-1051"></a><span>         </span><span class="hs-comment">-- (an unsolved constraint), and we don't want that error to suppress</span><span>
</span><a name="line-1052"></a><span>         </span><span class="hs-comment">-- the iteration limit warning!</span><span>
</span><a name="line-1053"></a><span>         </span><a href="TcSMonad.html#addErrTcS"><span class="hs-identifier hs-var">addErrTcS</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;solveWanteds: too many iterations&quot;</span><span>
</span><a name="line-1054"></a><span>                   </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;limit =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069663"><span class="hs-identifier hs-var">limit</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1055"></a><span>                </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Unsolved:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069666"><span class="hs-identifier hs-var">wc</span></a><span>
</span><a name="line-1056"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppUnless"><span class="hs-identifier hs-var">ppUnless</span></a><span> </span><span class="hs-special">(</span><a href="Bag.html#isEmptyBag"><span class="hs-identifier hs-var">isEmptyBag</span></a><span> </span><a href="#local-1628069664"><span class="hs-identifier hs-var">floated_eqs</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1057"></a><span>                          </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Floated equalities:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069664"><span class="hs-identifier hs-var">floated_eqs</span></a><span>
</span><a name="line-1058"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppUnless"><span class="hs-identifier hs-var">ppUnless</span></a><span> </span><a href="#local-1628069665"><span class="hs-identifier hs-var">no_new_scs</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1059"></a><span>                          </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;New superclasses found&quot;</span><span>
</span><a name="line-1060"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Set limit with -fconstraint-solver-iterations=n; n=0 for no limit&quot;</span><span>
</span><a name="line-1061"></a><span>                  </span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1062"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-1628069666"><span class="hs-identifier hs-var">wc</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1063"></a><span>
</span><a name="line-1064"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1065"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628069670"><a href="#local-1628069670"><span class="hs-identifier">n_floated</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Bag.html#lengthBag"><span class="hs-identifier hs-var">lengthBag</span></a><span> </span><a href="#local-1628069664"><span class="hs-identifier hs-var">floated_eqs</span></a><span>
</span><a name="line-1066"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#csTraceTcS"><span class="hs-identifier hs-var">csTraceTcS</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1067"></a><span>         </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;simpl_loop iteration=&quot;</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#int"><span class="hs-identifier hs-var">int</span></a><span> </span><a href="#local-1628069662"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1068"></a><span>         </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#hsep"><span class="hs-identifier hs-var">hsep</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;no new scs =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069665"><span class="hs-identifier hs-var">no_new_scs</span></a><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#comma"><span class="hs-identifier hs-var">comma</span></a><span>
</span><a name="line-1069"></a><span>                            </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#int"><span class="hs-identifier hs-var">int</span></a><span> </span><a href="#local-1628069670"><span class="hs-identifier hs-var">n_floated</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;floated eqs&quot;</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#comma"><span class="hs-identifier hs-var">comma</span></a><span>
</span><a name="line-1070"></a><span>                            </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#int"><span class="hs-identifier hs-var">int</span></a><span> </span><span class="hs-special">(</span><a href="Bag.html#lengthBag"><span class="hs-identifier hs-var">lengthBag</span></a><span> </span><a href="#local-1628069667"><span class="hs-identifier hs-var">simples</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;simples to solve&quot;</span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1071"></a><span>
</span><a name="line-1072"></a><span>       </span><span class="hs-comment">-- solveSimples may make progress if either float_eqs hold</span><span>
</span><a name="line-1073"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628069671"><a href="#local-1628069671"><span class="hs-identifier">unifs1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628069672"><a href="#local-1628069672"><span class="hs-identifier">wc1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#reportUnifications"><span class="hs-identifier hs-var">reportUnifications</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1074"></a><span>                          </span><a href="TcInteract.html#solveSimpleWanteds"><span class="hs-identifier hs-var">solveSimpleWanteds</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628069664"><span class="hs-identifier hs-var">floated_eqs</span></a><span> </span><span class="hs-special">`</span><a href="Bag.html#unionBags"><span class="hs-identifier hs-var">unionBags</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628069667"><span class="hs-identifier hs-var">simples</span></a><span class="hs-special">)</span><span>
</span><a name="line-1075"></a><span>                               </span><span class="hs-comment">-- Put floated_eqs first so they get solved first</span><span>
</span><a name="line-1076"></a><span>                               </span><span class="hs-comment">-- NB: the floated_eqs may include /derived/ equalities</span><span>
</span><a name="line-1077"></a><span>                               </span><span class="hs-comment">--     arising from fundeps inside an implication</span><span>
</span><a name="line-1078"></a><span>
</span><a name="line-1079"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628069673"><a href="#local-1628069673"><span class="hs-identifier">no_new_scs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628069674"><a href="#local-1628069674"><span class="hs-identifier">wc1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#expandSuperClasses"><span class="hs-identifier hs-var">expandSuperClasses</span></a><span> </span><a href="#local-1628069672"><span class="hs-identifier hs-var">wc1</span></a><span>
</span><a name="line-1080"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a href="TcRnTypes.html#WC"><span class="hs-identifier hs-var">WC</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wc_simple</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069675"><a href="#local-1628069675"><span class="hs-identifier">simples1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">wc_insol</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069676"><a href="#local-1628069676"><span class="hs-identifier">insols1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">wc_impl</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069677"><a href="#local-1628069677"><span class="hs-identifier">implics1</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069674"><span class="hs-identifier hs-var">wc1</span></a><span>
</span><a name="line-1081"></a><span>
</span><a name="line-1082"></a><span>       </span><span class="hs-comment">-- We have already tried to solve the nested implications once</span><span>
</span><a name="line-1083"></a><span>       </span><span class="hs-comment">-- Try again only if we have unified some meta-variables</span><span>
</span><a name="line-1084"></a><span>       </span><span class="hs-comment">-- (which is a bit like adding more givens</span><span>
</span><a name="line-1085"></a><span>       </span><span class="hs-comment">-- See Note [Cutting off simpl_loop]</span><span>
</span><a name="line-1086"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628069678"><a href="#local-1628069678"><span class="hs-identifier">floated_eqs2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628069679"><a href="#local-1628069679"><span class="hs-identifier">implics2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-1628069671"><span class="hs-identifier hs-var">unifs1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="Bag.html#isEmptyBag"><span class="hs-identifier hs-var">isEmptyBag</span></a><span> </span><a href="#local-1628069677"><span class="hs-identifier hs-var">implics1</span></a><span>
</span><a name="line-1087"></a><span>                                     </span><span class="hs-keyword">then</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="Bag.html#emptyBag"><span class="hs-identifier hs-var">emptyBag</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628069669"><span class="hs-identifier hs-var">implics</span></a><span class="hs-special">)</span><span>
</span><a name="line-1088"></a><span>                                     </span><span class="hs-keyword">else</span><span> </span><a href="TcSimplify.html#solveNestedImplications"><span class="hs-identifier hs-var">solveNestedImplications</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628069669"><span class="hs-identifier hs-var">implics</span></a><span> </span><span class="hs-special">`</span><a href="Bag.html#unionBags"><span class="hs-identifier hs-var">unionBags</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628069677"><span class="hs-identifier hs-var">implics1</span></a><span class="hs-special">)</span><span>
</span><a name="line-1089"></a><span>
</span><a name="line-1090"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSimplify.html#simpl_loop"><span class="hs-identifier hs-var">simpl_loop</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628069662"><span class="hs-identifier hs-var">n</span></a><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-1628069663"><span class="hs-identifier hs-var">limit</span></a><span> </span><a href="#local-1628069678"><span class="hs-identifier hs-var">floated_eqs2</span></a><span> </span><a href="#local-1628069673"><span class="hs-identifier hs-var">no_new_scs</span></a><span>
</span><a name="line-1091"></a><span>                    </span><span class="hs-special">(</span><a href="TcRnTypes.html#WC"><span class="hs-identifier hs-var">WC</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wc_simple</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069675"><span class="hs-identifier hs-var">simples1</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">wc_impl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069679"><span class="hs-identifier hs-var">implics2</span></a><span>
</span><a name="line-1092"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">wc_insol</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069668"><span class="hs-identifier hs-var">insols</span></a><span> </span><span class="hs-special">`</span><a href="Bag.html#unionBags"><span class="hs-identifier hs-var">unionBags</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628069676"><span class="hs-identifier hs-var">insols1</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1093"></a><span>
</span><a name="line-1094"></a><span class="hs-identifier">expandSuperClasses</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span> </span><a href="TcRnTypes.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a><span class="hs-special">)</span><span>
</span><a name="line-1095"></a><span class="hs-comment">-- If there are any unsolved wanteds, expand one step of superclasses for</span><span>
</span><a name="line-1096"></a><span class="hs-comment">-- unsolved wanteds or givens</span><span>
</span><a name="line-1097"></a><span class="hs-comment">-- See Note [The superclass story] in TcCanonical</span><span>
</span><a name="line-1098"></a><a name="expandSuperClasses"><a href="TcSimplify.html#expandSuperClasses"><span class="hs-identifier">expandSuperClasses</span></a></a><span> </span><a name="local-1628069680"><a href="#local-1628069680"><span class="hs-identifier">wc</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TcRnTypes.html#WC"><span class="hs-identifier hs-var">WC</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wc_simple</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069681"><a href="#local-1628069681"><span class="hs-identifier">unsolved</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">wc_insol</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069682"><a href="#local-1628069682"><span class="hs-identifier">insols</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1099"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Bag.html#anyBag"><span class="hs-identifier hs-var">anyBag</span></a><span> </span><a href="TcRnTypes.html#superClassesMightHelp"><span class="hs-identifier hs-var">superClassesMightHelp</span></a><span> </span><a href="#local-1628069681"><span class="hs-identifier hs-var">unsolved</span></a><span class="hs-special">)</span><span>
</span><a name="line-1100"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><a href="#local-1628069680"><span class="hs-identifier hs-var">wc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1101"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1102"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;expandSuperClasses {&quot;</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-1103"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-1628069683"><a href="#local-1628069683"><span class="hs-identifier">pending_wanted</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628069684"><a href="#local-1628069684"><span class="hs-identifier">unsolved'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Bag.html#mapAccumBagL"><span class="hs-identifier hs-var">mapAccumBagL</span></a><span> </span><a href="#local-1628069685"><span class="hs-identifier hs-var">get</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-1628069681"><span class="hs-identifier hs-var">unsolved</span></a><span>
</span><a name="line-1104"></a><span>             </span><a name="local-1628069685"><a href="#local-1628069685"><span class="hs-identifier">get</span></a></a><span> </span><a name="local-1628069686"><a href="#local-1628069686"><span class="hs-identifier">acc</span></a></a><span> </span><a name="local-1628069687"><a href="#local-1628069687"><span class="hs-identifier">ct</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="TcRnTypes.html#isPendingScDict"><span class="hs-identifier hs-var">isPendingScDict</span></a><span> </span><a href="#local-1628069687"><span class="hs-identifier hs-var">ct</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1105"></a><span>                            </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628069688"><a href="#local-1628069688"><span class="hs-identifier">ct'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-1628069688"><span class="hs-identifier hs-var">ct'</span></a><span class="hs-glyph">:</span><a href="#local-1628069686"><span class="hs-identifier hs-var">acc</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628069688"><span class="hs-identifier hs-var">ct'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1106"></a><span>                            </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-1628069686"><span class="hs-identifier hs-var">acc</span></a><span class="hs-special">,</span><span>     </span><a href="#local-1628069687"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">)</span><span>
</span><a name="line-1107"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628069689"><a href="#local-1628069689"><span class="hs-identifier">pending_given</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getPendingScDicts"><span class="hs-identifier hs-var">getPendingScDicts</span></a><span>
</span><a name="line-1108"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1628069689"><span class="hs-identifier hs-var">pending_given</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1628069683"><span class="hs-identifier hs-var">pending_wanted</span></a><span>
</span><a name="line-1109"></a><span>         </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;End expandSuperClasses no-op }&quot;</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-1110"></a><span>                 </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><a href="#local-1628069680"><span class="hs-identifier hs-var">wc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1111"></a><span>         </span><span class="hs-keyword">else</span><span>
</span><a name="line-1112"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628069690"><a href="#local-1628069690"><span class="hs-identifier">new_given</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcCanonical.html#makeSuperClasses"><span class="hs-identifier hs-var">makeSuperClasses</span></a><span> </span><a href="#local-1628069689"><span class="hs-identifier hs-var">pending_given</span></a><span>
</span><a name="line-1113"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628069691"><a href="#local-1628069691"><span class="hs-identifier">new_insols</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcInteract.html#solveSimpleGivens"><span class="hs-identifier hs-var">solveSimpleGivens</span></a><span> </span><a href="#local-1628069690"><span class="hs-identifier hs-var">new_given</span></a><span>
</span><a name="line-1114"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628069692"><a href="#local-1628069692"><span class="hs-identifier">new_wanted</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcCanonical.html#makeSuperClasses"><span class="hs-identifier hs-var">makeSuperClasses</span></a><span> </span><a href="#local-1628069683"><span class="hs-identifier hs-var">pending_wanted</span></a><span>
</span><a name="line-1115"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;End expandSuperClasses }&quot;</span><span>
</span><a name="line-1116"></a><span>                  </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Given:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069689"><span class="hs-identifier hs-var">pending_given</span></a><span>
</span><a name="line-1117"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Insols from given:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069691"><span class="hs-identifier hs-var">new_insols</span></a><span>
</span><a name="line-1118"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Wanted:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069692"><span class="hs-identifier hs-var">new_wanted</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1119"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><a href="#local-1628069680"><span class="hs-identifier hs-var">wc</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wc_simple</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069684"><span class="hs-identifier hs-var">unsolved'</span></a><span> </span><span class="hs-special">`</span><a href="Bag.html#unionBags"><span class="hs-identifier hs-var">unionBags</span></a><span class="hs-special">`</span><span> </span><a href="Bag.html#listToBag"><span class="hs-identifier hs-var">listToBag</span></a><span> </span><a href="#local-1628069692"><span class="hs-identifier hs-var">new_wanted</span></a><span>
</span><a name="line-1120"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">wc_insol</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069682"><span class="hs-identifier hs-var">insols</span></a><span> </span><span class="hs-special">`</span><a href="Bag.html#unionBags"><span class="hs-identifier hs-var">unionBags</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628069691"><span class="hs-identifier hs-var">new_insols</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1121"></a><span>
</span><a name="line-1122"></a><span class="hs-identifier">solveNestedImplications</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a><span> </span><a href="TcRnTypes.html#Implication"><span class="hs-identifier hs-type">Implication</span></a><span>
</span><a name="line-1123"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#Cts"><span class="hs-identifier hs-type">Cts</span></a><span class="hs-special">,</span><span> </span><a href="Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a><span> </span><a href="TcRnTypes.html#Implication"><span class="hs-identifier hs-type">Implication</span></a><span class="hs-special">)</span><span>
</span><a name="line-1124"></a><span class="hs-comment">-- Precondition: the TcS inerts may contain unsolved simples which have</span><span>
</span><a name="line-1125"></a><span class="hs-comment">-- to be converted to givens before we go inside a nested implication.</span><span>
</span><a name="line-1126"></a><a name="solveNestedImplications"><a href="TcSimplify.html#solveNestedImplications"><span class="hs-identifier">solveNestedImplications</span></a></a><span> </span><a name="local-1628069693"><a href="#local-1628069693"><span class="hs-identifier">implics</span></a></a><span>
</span><a name="line-1127"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Bag.html#isEmptyBag"><span class="hs-identifier hs-var">isEmptyBag</span></a><span> </span><a href="#local-1628069693"><span class="hs-identifier hs-var">implics</span></a><span>
</span><a name="line-1128"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="Bag.html#emptyBag"><span class="hs-identifier hs-var">emptyBag</span></a><span class="hs-special">,</span><span> </span><a href="Bag.html#emptyBag"><span class="hs-identifier hs-var">emptyBag</span></a><span class="hs-special">)</span><span>
</span><a name="line-1129"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1130"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;solveNestedImplications starting {&quot;</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-1131"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628069694"><a href="#local-1628069694"><span class="hs-identifier">floated_eqs_s</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628069695"><a href="#local-1628069695"><span class="hs-identifier">unsolved_implics</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Bag.html#mapAndUnzipBagM"><span class="hs-identifier hs-var">mapAndUnzipBagM</span></a><span> </span><a href="TcSimplify.html#solveImplication"><span class="hs-identifier hs-var">solveImplication</span></a><span> </span><a href="#local-1628069693"><span class="hs-identifier hs-var">implics</span></a><span>
</span><a name="line-1132"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628069696"><a href="#local-1628069696"><span class="hs-identifier">floated_eqs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Bag.html#concatBag"><span class="hs-identifier hs-var">concatBag</span></a><span> </span><a href="#local-1628069694"><span class="hs-identifier hs-var">floated_eqs_s</span></a><span>
</span><a name="line-1133"></a><span>
</span><a name="line-1134"></a><span>       </span><span class="hs-comment">-- ... and we are back in the original TcS inerts</span><span>
</span><a name="line-1135"></a><span>       </span><span class="hs-comment">-- Notice that the original includes the _insoluble_simples so it was safe to ignore</span><span>
</span><a name="line-1136"></a><span>       </span><span class="hs-comment">-- them in the beginning of this function.</span><span>
</span><a name="line-1137"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;solveNestedImplications end }&quot;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1138"></a><span>                  </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;all floated_eqs =&quot;</span><span>  </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069696"><span class="hs-identifier hs-var">floated_eqs</span></a><span>
</span><a name="line-1139"></a><span>                       </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;unsolved_implics =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069695"><span class="hs-identifier hs-var">unsolved_implics</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1140"></a><span>
</span><a name="line-1141"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628069696"><span class="hs-identifier hs-var">floated_eqs</span></a><span class="hs-special">,</span><span> </span><a href="Bag.html#catBagMaybes"><span class="hs-identifier hs-var">catBagMaybes</span></a><span> </span><a href="#local-1628069695"><span class="hs-identifier hs-var">unsolved_implics</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1142"></a><span>
</span><a name="line-1143"></a><span class="hs-identifier">solveImplication</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#Implication"><span class="hs-identifier hs-type">Implication</span></a><span>    </span><span class="hs-comment">-- Wanted</span><span>
</span><a name="line-1144"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#Cts"><span class="hs-identifier hs-type">Cts</span></a><span class="hs-special">,</span><span>      </span><span class="hs-comment">-- All wanted or derived floated equalities: var = type</span><span>
</span><a name="line-1145"></a><span>                         </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="TcRnTypes.html#Implication"><span class="hs-identifier hs-type">Implication</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Simplified implication (empty or singleton)</span><span>
</span><a name="line-1146"></a><span class="hs-comment">-- Precondition: The TcS monad contains an empty worklist and given-only inerts</span><span>
</span><a name="line-1147"></a><span class="hs-comment">-- which after trying to solve this implication we must restore to their original value</span><span>
</span><a name="line-1148"></a><a name="solveImplication"><a href="TcSimplify.html#solveImplication"><span class="hs-identifier">solveImplication</span></a></a><span> </span><a name="local-1628069697"><a href="#local-1628069697"><span class="hs-identifier">imp</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TcRnTypes.html#Implic"><span class="hs-identifier hs-var">Implic</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ic_tclvl</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069698"><a href="#local-1628069698"><span class="hs-identifier">tclvl</span></a></a><span>
</span><a name="line-1149"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ic_binds</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069699"><a href="#local-1628069699"><span class="hs-identifier">m_ev_binds</span></a></a><span>
</span><a name="line-1150"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ic_skols</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069700"><a href="#local-1628069700"><span class="hs-identifier">skols</span></a></a><span>
</span><a name="line-1151"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ic_given</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069701"><a href="#local-1628069701"><span class="hs-identifier">given_ids</span></a></a><span>
</span><a name="line-1152"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ic_wanted</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069702"><a href="#local-1628069702"><span class="hs-identifier">wanteds</span></a></a><span>
</span><a name="line-1153"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ic_info</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069703"><a href="#local-1628069703"><span class="hs-identifier">info</span></a></a><span>
</span><a name="line-1154"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ic_status</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069704"><a href="#local-1628069704"><span class="hs-identifier">status</span></a></a><span>
</span><a name="line-1155"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ic_env</span><span>    </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069705"><a href="#local-1628069705"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1156"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TcRnTypes.html#IC_Solved"><span class="hs-identifier hs-var">IC_Solved</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628069704"><span class="hs-identifier hs-var">status</span></a><span>
</span><a name="line-1157"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#emptyCts"><span class="hs-identifier hs-var">emptyCts</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-1628069697"><span class="hs-identifier hs-var">imp</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Do nothing</span><span>
</span><a name="line-1158"></a><span>
</span><a name="line-1159"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>  </span><span class="hs-comment">-- Even for IC_Insoluble it is worth doing more work</span><span>
</span><a name="line-1160"></a><span>               </span><span class="hs-comment">-- The insoluble stuff might be in one sub-implication</span><span>
</span><a name="line-1161"></a><span>               </span><span class="hs-comment">-- and other unsolved goals in another; and we want to</span><span>
</span><a name="line-1162"></a><span>               </span><span class="hs-comment">-- solve the latter as much as possible</span><span>
</span><a name="line-1163"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628069706"><a href="#local-1628069706"><span class="hs-identifier">inerts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getTcSInerts"><span class="hs-identifier hs-var">getTcSInerts</span></a><span>
</span><a name="line-1164"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;solveImplication {&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069697"><span class="hs-identifier hs-var">imp</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Inerts&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069706"><span class="hs-identifier hs-var">inerts</span></a><span class="hs-special">)</span><span>
</span><a name="line-1165"></a><span>
</span><a name="line-1166"></a><span>         </span><span class="hs-comment">-- Solve the nested constraints</span><span>
</span><a name="line-1167"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-1628069712"><a href="#local-1628069712"><span class="hs-identifier">no_given_eqs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628069713"><a href="#local-1628069713"><span class="hs-identifier">given_insols</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628069714"><a href="#local-1628069714"><span class="hs-identifier">residual_wanted</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-1628069715"><a href="#local-1628069715"><span class="hs-identifier">used_tcvs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1168"></a><span>             </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#nestImplicTcS"><span class="hs-identifier hs-var">nestImplicTcS</span></a><span> </span><a href="#local-1628069699"><span class="hs-identifier hs-var">m_ev_binds</span></a><span> </span><span class="hs-special">(</span><a href="VarSet.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628069700"><span class="hs-identifier hs-var">skols</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-1628069701"><span class="hs-identifier hs-var">given_ids</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-1628069698"><span class="hs-identifier hs-var">tclvl</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1169"></a><span>               </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628069707"><a href="#local-1628069707"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#mkGivenLoc"><span class="hs-identifier hs-var">mkGivenLoc</span></a><span> </span><a href="#local-1628069698"><span class="hs-identifier hs-var">tclvl</span></a><span> </span><a href="#local-1628069703"><span class="hs-identifier hs-var">info</span></a><span> </span><a href="#local-1628069705"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-1170"></a><span>                  </span><span class="hs-special">;</span><span> </span><a name="local-1628069708"><a href="#local-1628069708"><span class="hs-identifier">givens_w_scs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcCanonical.html#mkGivensWithSuperClasses"><span class="hs-identifier hs-var">mkGivensWithSuperClasses</span></a><span> </span><a href="#local-1628069707"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-1628069701"><span class="hs-identifier hs-var">given_ids</span></a><span>
</span><a name="line-1171"></a><span>                  </span><span class="hs-special">;</span><span> </span><a name="local-1628069709"><a href="#local-1628069709"><span class="hs-identifier">given_insols</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcInteract.html#solveSimpleGivens"><span class="hs-identifier hs-var">solveSimpleGivens</span></a><span> </span><a href="#local-1628069708"><span class="hs-identifier hs-var">givens_w_scs</span></a><span>
</span><a name="line-1172"></a><span>
</span><a name="line-1173"></a><span>                  </span><span class="hs-special">;</span><span> </span><a name="local-1628069710"><a href="#local-1628069710"><span class="hs-identifier">residual_wanted</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#solveWanteds"><span class="hs-identifier hs-var">solveWanteds</span></a><span> </span><a href="#local-1628069702"><span class="hs-identifier hs-var">wanteds</span></a><span>
</span><a name="line-1174"></a><span>                        </span><span class="hs-comment">-- solveWanteds, *not* solveWantedsAndDrop, because</span><span>
</span><a name="line-1175"></a><span>                        </span><span class="hs-comment">-- we want to retain derived equalities so we can float</span><span>
</span><a name="line-1176"></a><span>                        </span><span class="hs-comment">-- them out in floatEqualities</span><span>
</span><a name="line-1177"></a><span>
</span><a name="line-1178"></a><span>                  </span><span class="hs-special">;</span><span> </span><a name="local-1628069711"><a href="#local-1628069711"><span class="hs-identifier">no_eqs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getNoGivenEqs"><span class="hs-identifier hs-var">getNoGivenEqs</span></a><span> </span><a href="#local-1628069698"><span class="hs-identifier hs-var">tclvl</span></a><span> </span><a href="#local-1628069700"><span class="hs-identifier hs-var">skols</span></a><span>
</span><a name="line-1179"></a><span>                        </span><span class="hs-comment">-- Call getNoGivenEqs /after/ solveWanteds, because</span><span>
</span><a name="line-1180"></a><span>                        </span><span class="hs-comment">-- solveWanteds can augment the givens, via expandSuperClasses,</span><span>
</span><a name="line-1181"></a><span>                        </span><span class="hs-comment">-- to reveal given superclass equalities</span><span>
</span><a name="line-1182"></a><span>
</span><a name="line-1183"></a><span>                  </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628069711"><span class="hs-identifier hs-var">no_eqs</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628069709"><span class="hs-identifier hs-var">given_insols</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628069710"><span class="hs-identifier hs-var">residual_wanted</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1184"></a><span>
</span><a name="line-1185"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628069716"><a href="#local-1628069716"><span class="hs-identifier">floated_eqs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628069717"><a href="#local-1628069717"><span class="hs-identifier">residual_wanted</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1186"></a><span>             </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#floatEqualities"><span class="hs-identifier hs-var">floatEqualities</span></a><span> </span><a href="#local-1628069700"><span class="hs-identifier hs-var">skols</span></a><span> </span><a href="#local-1628069712"><span class="hs-identifier hs-var">no_given_eqs</span></a><span> </span><a href="#local-1628069714"><span class="hs-identifier hs-var">residual_wanted</span></a><span>
</span><a name="line-1187"></a><span>
</span><a name="line-1188"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;solveImplication 2&quot;</span><span>
</span><a name="line-1189"></a><span>           </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069713"><span class="hs-identifier hs-var">given_insols</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069717"><span class="hs-identifier hs-var">residual_wanted</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069715"><span class="hs-identifier hs-var">used_tcvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1190"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628069718"><a href="#local-1628069718"><span class="hs-identifier">final_wanted</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069717"><span class="hs-identifier hs-var">residual_wanted</span></a><span> </span><span class="hs-special">`</span><a href="TcRnTypes.html#addInsols"><span class="hs-identifier hs-var">addInsols</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628069713"><span class="hs-identifier hs-var">given_insols</span></a><span>
</span><a name="line-1191"></a><span>
</span><a name="line-1192"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628069719"><a href="#local-1628069719"><span class="hs-identifier">res_implic</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#setImplicationStatus"><span class="hs-identifier hs-var">setImplicationStatus</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628069697"><span class="hs-identifier hs-var">imp</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ic_no_eqs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069712"><span class="hs-identifier hs-var">no_given_eqs</span></a><span>
</span><a name="line-1193"></a><span>                                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ic_wanted</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069718"><span class="hs-identifier hs-var">final_wanted</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1194"></a><span>                                            </span><a href="#local-1628069715"><span class="hs-identifier hs-var">used_tcvs</span></a><span>
</span><a name="line-1195"></a><span>
</span><a name="line-1196"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628069720"><a href="#local-1628069720"><span class="hs-identifier">evbinds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getTcEvBindsMap"><span class="hs-identifier hs-var">TcS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">getTcEvBindsMap</span></a><span>
</span><a name="line-1197"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;solveImplication end }&quot;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span>
</span><a name="line-1198"></a><span>             </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;no_given_eqs =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069712"><span class="hs-identifier hs-var">no_given_eqs</span></a><span>
</span><a name="line-1199"></a><span>             </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;floated_eqs =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069716"><span class="hs-identifier hs-var">floated_eqs</span></a><span>
</span><a name="line-1200"></a><span>             </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;res_implic =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069719"><span class="hs-identifier hs-var">res_implic</span></a><span>
</span><a name="line-1201"></a><span>             </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;implication evbinds = &quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#evBindMapBinds"><span class="hs-identifier hs-var">evBindMapBinds</span></a><span> </span><a href="#local-1628069720"><span class="hs-identifier hs-var">evbinds</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1202"></a><span>
</span><a name="line-1203"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628069716"><span class="hs-identifier hs-var">floated_eqs</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628069719"><span class="hs-identifier hs-var">res_implic</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1204"></a><span>
</span><a name="line-1205"></a><span class="hs-comment">----------------------</span><span>
</span><a name="line-1206"></a><span class="hs-identifier">setImplicationStatus</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#Implication"><span class="hs-identifier hs-type">Implication</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#TyCoVarSet"><span class="hs-identifier hs-type">TyCoVarSet</span></a><span>  </span><span class="hs-comment">-- needed variables</span><span>
</span><a name="line-1207"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="TcRnTypes.html#Implication"><span class="hs-identifier hs-type">Implication</span></a><span class="hs-special">)</span><span>
</span><a name="line-1208"></a><span class="hs-comment">-- Finalise the implication returned from solveImplication:</span><span>
</span><a name="line-1209"></a><span class="hs-comment">--    * Set the ic_status field</span><span>
</span><a name="line-1210"></a><span class="hs-comment">--    * Trim the ic_wanted field to remove Derived constraints</span><span>
</span><a name="line-1211"></a><span class="hs-comment">-- Return Nothing if we can discard the implication altogether</span><span>
</span><a name="line-1212"></a><a name="setImplicationStatus"><a href="TcSimplify.html#setImplicationStatus"><span class="hs-identifier">setImplicationStatus</span></a></a><span> </span><a name="local-1628069721"><a href="#local-1628069721"><span class="hs-identifier">implic</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TcRnTypes.html#Implic"><span class="hs-identifier hs-var">Implic</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ic_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069722"><a href="#local-1628069722"><span class="hs-identifier">m_ev_binds_var</span></a></a><span>
</span><a name="line-1213"></a><span>                                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ic_info</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069723"><a href="#local-1628069723"><span class="hs-identifier">info</span></a></a><span>
</span><a name="line-1214"></a><span>                                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ic_tclvl</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069724"><a href="#local-1628069724"><span class="hs-identifier">tc_lvl</span></a></a><span>
</span><a name="line-1215"></a><span>                                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ic_wanted</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069725"><a href="#local-1628069725"><span class="hs-identifier">wc</span></a></a><span>
</span><a name="line-1216"></a><span>                                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ic_given</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069726"><a href="#local-1628069726"><span class="hs-identifier">givens</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1217"></a><span>                     </span><a name="local-1628069727"><a href="#local-1628069727"><span class="hs-identifier">used_tcvs</span></a></a><span>
</span><a name="line-1218"></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628069731"><span class="hs-identifier hs-var">some_insoluble</span></a><span>
</span><a name="line-1219"></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1220"></a><span>   </span><a href="#local-1628069721"><span class="hs-identifier hs-var">implic</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ic_status</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#IC_Insoluble"><span class="hs-identifier hs-var">IC_Insoluble</span></a><span>
</span><a name="line-1221"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ic_wanted</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069725"><span class="hs-identifier hs-var">wc</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wc_simple</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069733"><span class="hs-identifier hs-var">pruned_simples</span></a><span>
</span><a name="line-1222"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">wc_insol</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069734"><span class="hs-identifier hs-var">pruned_insols</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1223"></a><span>
</span><a name="line-1224"></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628069732"><span class="hs-identifier hs-var">some_unsolved</span></a><span>
</span><a name="line-1225"></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1226"></a><span>   </span><a href="#local-1628069721"><span class="hs-identifier hs-var">implic</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ic_status</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#IC_Unsolved"><span class="hs-identifier hs-var">IC_Unsolved</span></a><span>
</span><a name="line-1227"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ic_wanted</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069725"><span class="hs-identifier hs-var">wc</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wc_simple</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069733"><span class="hs-identifier hs-var">pruned_simples</span></a><span>
</span><a name="line-1228"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">wc_insol</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069734"><span class="hs-identifier hs-var">pruned_insols</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1229"></a><span>
</span><a name="line-1230"></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>  </span><span class="hs-comment">-- Everything is solved; look at the implications</span><span>
</span><a name="line-1231"></a><span>              </span><span class="hs-comment">-- See Note [Tracking redundant constraints]</span><span>
</span><a name="line-1232"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628069746"><a href="#local-1628069746"><span class="hs-identifier">ev_binds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628069722"><span class="hs-identifier hs-var">m_ev_binds_var</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1233"></a><span>                      </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#EvBindsVar"><span class="hs-identifier hs-var">EvBindsVar</span></a><span> </span><a name="local-1628069745"><a href="#local-1628069745"><span class="hs-identifier">ref</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#readTcRef"><span class="hs-identifier hs-var">TcS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">readTcRef</span></a><span> </span><a href="#local-1628069745"><span class="hs-identifier hs-var">ref</span></a><span>
</span><a name="line-1234"></a><span>                      </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="TcEvidence.html#emptyEvBindMap"><span class="hs-identifier hs-var">emptyEvBindMap</span></a><span>
</span><a name="line-1235"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628069747"><a href="#local-1628069747"><span class="hs-identifier">all_needs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSimplify.html#neededEvVars"><span class="hs-identifier hs-var">neededEvVars</span></a><span> </span><a href="#local-1628069746"><span class="hs-identifier hs-var">ev_binds</span></a><span>
</span><a name="line-1236"></a><span>                                     </span><span class="hs-special">(</span><a href="#local-1628069727"><span class="hs-identifier hs-var">used_tcvs</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628069737"><span class="hs-identifier hs-var">implic_needs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1237"></a><span>
</span><a name="line-1238"></a><span>            </span><a name="local-1628069748"><a href="#local-1628069748"><span class="hs-identifier">dead_givens</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="TcSimplify.html#warnRedundantGivens"><span class="hs-identifier hs-var">warnRedundantGivens</span></a><span> </span><a href="#local-1628069723"><span class="hs-identifier hs-var">info</span></a><span>
</span><a name="line-1239"></a><span>                        </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#filterOut"><span class="hs-identifier hs-var">filterOut</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="VarSet.html#elemVarSet"><span class="hs-identifier hs-var">elemVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628069747"><span class="hs-identifier hs-var">all_needs</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628069726"><span class="hs-identifier hs-var">givens</span></a><span>
</span><a name="line-1240"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- None to report</span><span>
</span><a name="line-1241"></a><span>
</span><a name="line-1242"></a><span>            </span><a name="local-1628069749"><a href="#local-1628069749"><span class="hs-identifier">final_needs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069747"><span class="hs-identifier hs-var">all_needs</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#delVarSetList"><span class="hs-identifier hs-var">delVarSetList</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628069726"><span class="hs-identifier hs-var">givens</span></a><span>
</span><a name="line-1243"></a><span>
</span><a name="line-1244"></a><span>            </span><a name="local-1628069750"><a href="#local-1628069750"><span class="hs-identifier">discard_entire_implication</span></a></a><span>  </span><span class="hs-comment">-- Can we discard the entire implication?</span><span>
</span><a name="line-1245"></a><span>              </span><span class="hs-glyph">=</span><span>  </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1628069748"><span class="hs-identifier hs-var">dead_givens</span></a><span>           </span><span class="hs-comment">-- No warning from this implication</span><span>
</span><a name="line-1246"></a><span>              </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="Bag.html#isEmptyBag"><span class="hs-identifier hs-var">isEmptyBag</span></a><span> </span><a href="#local-1628069735"><span class="hs-identifier hs-var">pruned_implics</span></a><span>  </span><span class="hs-comment">-- No live children</span><span>
</span><a name="line-1247"></a><span>              </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="VarSet.html#isEmptyVarSet"><span class="hs-identifier hs-var">isEmptyVarSet</span></a><span> </span><a href="#local-1628069749"><span class="hs-identifier hs-var">final_needs</span></a><span>  </span><span class="hs-comment">-- No needed vars to pass up to parent</span><span>
</span><a name="line-1248"></a><span>
</span><a name="line-1249"></a><span>            </span><a name="local-1628069751"><a href="#local-1628069751"><span class="hs-identifier">final_status</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#IC_Solved"><span class="hs-identifier hs-var">IC_Solved</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ics_need</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069749"><span class="hs-identifier hs-var">final_needs</span></a><span>
</span><a name="line-1250"></a><span>                                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ics_dead</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069748"><span class="hs-identifier hs-var">dead_givens</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1251"></a><span>            </span><a name="local-1628069752"><a href="#local-1628069752"><span class="hs-identifier">final_implic</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069721"><span class="hs-identifier hs-var">implic</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ic_status</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069751"><span class="hs-identifier hs-var">final_status</span></a><span>
</span><a name="line-1252"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ic_wanted</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069725"><span class="hs-identifier hs-var">wc</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wc_simple</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069733"><span class="hs-identifier hs-var">pruned_simples</span></a><span>
</span><a name="line-1253"></a><span>                                                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">wc_insol</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069734"><span class="hs-identifier hs-var">pruned_insols</span></a><span>
</span><a name="line-1254"></a><span>                                                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">wc_impl</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069735"><span class="hs-identifier hs-var">pruned_implics</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1255"></a><span>               </span><span class="hs-comment">-- We can only prune the child implications (pruned_implics)</span><span>
</span><a name="line-1256"></a><span>               </span><span class="hs-comment">-- in the IC_Solved status case, because only then we can</span><span>
</span><a name="line-1257"></a><span>               </span><span class="hs-comment">-- accumulate their needed evidence variales into the</span><span>
</span><a name="line-1258"></a><span>               </span><span class="hs-comment">-- IC_Solved final_status field of the parent implication.</span><span>
</span><a name="line-1259"></a><span>
</span><a name="line-1260"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-1628069750"><span class="hs-identifier hs-var">discard_entire_implication</span></a><span>
</span><a name="line-1261"></a><span>                 </span><span class="hs-keyword">then</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-1262"></a><span>                 </span><span class="hs-keyword">else</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-1628069752"><span class="hs-identifier hs-var">final_implic</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1263"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1264"></a><span>   </span><a href="TcRnTypes.html#WC"><span class="hs-identifier hs-var">WC</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wc_simple</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069728"><a href="#local-1628069728"><span class="hs-identifier">simples</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">wc_impl</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069729"><a href="#local-1628069729"><span class="hs-identifier">implics</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">wc_insol</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069730"><a href="#local-1628069730"><span class="hs-identifier">insols</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069725"><span class="hs-identifier hs-var">wc</span></a><span>
</span><a name="line-1265"></a><span>
</span><a name="line-1266"></a><span>   </span><a name="local-1628069731"><a href="#local-1628069731"><span class="hs-identifier">some_insoluble</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#insolubleWC"><span class="hs-identifier hs-var">insolubleWC</span></a><span> </span><a href="#local-1628069724"><span class="hs-identifier hs-var">tc_lvl</span></a><span> </span><a href="#local-1628069725"><span class="hs-identifier hs-var">wc</span></a><span>
</span><a name="line-1267"></a><span>   </span><a name="local-1628069732"><a href="#local-1628069732"><span class="hs-identifier">some_unsolved</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Bag.html#isEmptyBag"><span class="hs-identifier hs-var">isEmptyBag</span></a><span> </span><a href="#local-1628069728"><span class="hs-identifier hs-var">simples</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="Bag.html#isEmptyBag"><span class="hs-identifier hs-var">isEmptyBag</span></a><span> </span><a href="#local-1628069730"><span class="hs-identifier hs-var">insols</span></a><span class="hs-special">)</span><span>
</span><a name="line-1268"></a><span>                 </span><span class="hs-operator hs-var">||</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#isNothing"><span class="hs-identifier hs-var">isNothing</span></a><span> </span><a href="#local-1628069736"><span class="hs-identifier hs-var">mb_implic_needs</span></a><span>
</span><a name="line-1269"></a><span>
</span><a name="line-1270"></a><span>   </span><a name="local-1628069733"><a href="#local-1628069733"><span class="hs-identifier">pruned_simples</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#dropDerivedSimples"><span class="hs-identifier hs-var">dropDerivedSimples</span></a><span> </span><a href="#local-1628069728"><span class="hs-identifier hs-var">simples</span></a><span>
</span><a name="line-1271"></a><span>   </span><a name="local-1628069734"><a href="#local-1628069734"><span class="hs-identifier">pruned_insols</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#dropDerivedInsols"><span class="hs-identifier hs-var">dropDerivedInsols</span></a><span> </span><a href="#local-1628069730"><span class="hs-identifier hs-var">insols</span></a><span>
</span><a name="line-1272"></a><span>   </span><a name="local-1628069735"><a href="#local-1628069735"><span class="hs-identifier">pruned_implics</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Bag.html#filterBag"><span class="hs-identifier hs-var">filterBag</span></a><span> </span><a href="#local-1628069739"><span class="hs-identifier hs-var">need_to_keep_implic</span></a><span> </span><a href="#local-1628069729"><span class="hs-identifier hs-var">implics</span></a><span>
</span><a name="line-1273"></a><span>
</span><a name="line-1274"></a><span>   </span><span class="hs-identifier">mb_implic_needs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span>
</span><a name="line-1275"></a><span>        </span><span class="hs-comment">-- Just vs =&gt; all implics are IC_Solved, with 'vs' needed</span><span>
</span><a name="line-1276"></a><span>        </span><span class="hs-comment">-- Nothing =&gt; at least one implic is not IC_Solved</span><span>
</span><a name="line-1277"></a><span>   </span><a name="local-1628069736"><a href="#local-1628069736"><span class="hs-identifier">mb_implic_needs</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Bag.html#foldrBag"><span class="hs-identifier hs-var">foldrBag</span></a><span> </span><a href="#local-1628069738"><span class="hs-identifier hs-var">add_implic</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="VarSet.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628069729"><span class="hs-identifier hs-var">implics</span></a><span>
</span><a name="line-1278"></a><span>   </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628069737"><a href="#local-1628069737"><span class="hs-identifier">implic_needs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069736"><span class="hs-identifier hs-var">mb_implic_needs</span></a><span>
</span><a name="line-1279"></a><span>
</span><a name="line-1280"></a><span>   </span><a name="local-1628069738"><a href="#local-1628069738"><span class="hs-identifier">add_implic</span></a></a><span> </span><a name="local-1628069740"><a href="#local-1628069740"><span class="hs-identifier">implic</span></a></a><span> </span><a name="local-1628069741"><a href="#local-1628069741"><span class="hs-identifier">acc</span></a></a><span>
</span><a name="line-1281"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628069742"><a href="#local-1628069742"><span class="hs-identifier">vs_acc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628069741"><span class="hs-identifier hs-var">acc</span></a><span>
</span><a name="line-1282"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="TcRnTypes.html#IC_Solved"><span class="hs-identifier hs-var">IC_Solved</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ics_need</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069743"><a href="#local-1628069743"><span class="hs-identifier">vs</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">ic_status</span><span> </span><a href="#local-1628069740"><span class="hs-identifier hs-var">implic</span></a><span>
</span><a name="line-1283"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628069743"><span class="hs-identifier hs-var">vs</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628069742"><span class="hs-identifier hs-var">vs_acc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1284"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-1285"></a><span>
</span><a name="line-1286"></a><span>   </span><a name="local-1628069739"><a href="#local-1628069739"><span class="hs-identifier">need_to_keep_implic</span></a></a><span> </span><a name="local-1628069744"><a href="#local-1628069744"><span class="hs-identifier">ic</span></a></a><span>
</span><a name="line-1287"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a href="TcRnTypes.html#IC_Solved"><span class="hs-identifier hs-var">IC_Solved</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ics_dead</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">ic_status</span><span> </span><a href="#local-1628069744"><span class="hs-identifier hs-var">ic</span></a><span>
</span><a name="line-1288"></a><span>           </span><span class="hs-comment">-- Fully solved, and no redundant givens to report</span><span>
</span><a name="line-1289"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Bag.html#isEmptyBag"><span class="hs-identifier hs-var">isEmptyBag</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">wc_impl</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ic_wanted</span><span> </span><a href="#local-1628069744"><span class="hs-identifier hs-var">ic</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1290"></a><span>           </span><span class="hs-comment">-- And no children that might have things to report</span><span>
</span><a name="line-1291"></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1292"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1293"></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1294"></a><span>
</span><a name="line-1295"></a><span class="hs-identifier">warnRedundantGivens</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#SkolemInfo"><span class="hs-identifier hs-type">SkolemInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1296"></a><a name="warnRedundantGivens"><a href="TcSimplify.html#warnRedundantGivens"><span class="hs-identifier">warnRedundantGivens</span></a></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#SigSkol"><span class="hs-identifier hs-var">SigSkol</span></a><span> </span><a name="local-1628069753"><a href="#local-1628069753"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-1297"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628069753"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1298"></a><span>       </span><a href="TcType.html#FunSigCtxt"><span class="hs-identifier hs-var">FunSigCtxt</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1628069754"><a href="#local-1628069754"><span class="hs-identifier">warn_redundant</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628069754"><span class="hs-identifier hs-var">warn_redundant</span></a><span>
</span><a name="line-1299"></a><span>       </span><a href="TcType.html#ExprSigCtxt"><span class="hs-identifier hs-var">ExprSigCtxt</span></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1300"></a><span>       </span><span class="hs-identifier">_</span><span>                           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1301"></a><span>
</span><a name="line-1302"></a><span>  </span><span class="hs-comment">-- To think about: do we want to report redundant givens for</span><span>
</span><a name="line-1303"></a><span>  </span><span class="hs-comment">-- pattern synonyms, PatSynSigSkol? c.f Trac #9953, comment:21.</span><span>
</span><a name="line-1304"></a><span class="hs-identifier">warnRedundantGivens</span><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#InstSkol"><span class="hs-identifier hs-var">InstSkol</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1305"></a><span class="hs-identifier">warnRedundantGivens</span><span> </span><span class="hs-identifier">_</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1306"></a><span>
</span><a name="line-1307"></a><span class="hs-identifier">neededEvVars</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcEvidence.html#EvBindMap"><span class="hs-identifier hs-type">EvBindMap</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span>
</span><a name="line-1308"></a><span class="hs-comment">-- Find all the evidence variables that are &quot;needed&quot;,</span><span>
</span><a name="line-1309"></a><span class="hs-comment">--    and then delete all those bound by the evidence bindings</span><span>
</span><a name="line-1310"></a><span class="hs-comment">-- See note [Tracking redundant constraints]</span><span>
</span><a name="line-1311"></a><a name="neededEvVars"><a href="TcSimplify.html#neededEvVars"><span class="hs-identifier">neededEvVars</span></a></a><span> </span><a name="local-1628069755"><a href="#local-1628069755"><span class="hs-identifier">ev_binds</span></a></a><span> </span><a name="local-1628069756"><a href="#local-1628069756"><span class="hs-identifier">initial_seeds</span></a></a><span>
</span><a name="line-1312"></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069758"><span class="hs-identifier hs-var">needed</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#minusVarSet"><span class="hs-identifier hs-var">minusVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628069759"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-1313"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1314"></a><span>   </span><a name="local-1628069757"><a href="#local-1628069757"><span class="hs-identifier">seeds</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcEvidence.html#foldEvBindMap"><span class="hs-identifier hs-var">foldEvBindMap</span></a><span> </span><a href="#local-1628069760"><span class="hs-identifier hs-var">add_wanted</span></a><span> </span><a href="#local-1628069756"><span class="hs-identifier hs-var">initial_seeds</span></a><span> </span><a href="#local-1628069755"><span class="hs-identifier hs-var">ev_binds</span></a><span>
</span><a name="line-1315"></a><span>   </span><a name="local-1628069758"><a href="#local-1628069758"><span class="hs-identifier">needed</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#transCloVarSet"><span class="hs-identifier hs-var">transCloVarSet</span></a><span> </span><a href="#local-1628069761"><span class="hs-identifier hs-var">also_needs</span></a><span> </span><a href="#local-1628069757"><span class="hs-identifier hs-var">seeds</span></a><span>
</span><a name="line-1316"></a><span>   </span><a name="local-1628069759"><a href="#local-1628069759"><span class="hs-identifier">bndrs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcEvidence.html#foldEvBindMap"><span class="hs-identifier hs-var">foldEvBindMap</span></a><span> </span><a href="#local-1628069762"><span class="hs-identifier hs-var">add_bndr</span></a><span> </span><a href="VarSet.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a><span> </span><a href="#local-1628069755"><span class="hs-identifier hs-var">ev_binds</span></a><span>
</span><a name="line-1317"></a><span>
</span><a name="line-1318"></a><span>   </span><span class="hs-identifier">add_wanted</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcEvidence.html#EvBind"><span class="hs-identifier hs-type">EvBind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span>
</span><a name="line-1319"></a><span>   </span><a name="local-1628069760"><a href="#local-1628069760"><span class="hs-identifier">add_wanted</span></a></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#EvBind"><span class="hs-identifier hs-var">EvBind</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">eb_is_given</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069763"><a href="#local-1628069763"><span class="hs-identifier">is_given</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">eb_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069764"><a href="#local-1628069764"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-1628069765"><a href="#local-1628069765"><span class="hs-identifier">needs</span></a></a><span>
</span><a name="line-1320"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628069763"><span class="hs-identifier hs-var">is_given</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069765"><span class="hs-identifier hs-var">needs</span></a><span>  </span><span class="hs-comment">-- Add the rhs vars of the Wanted bindings only</span><span>
</span><a name="line-1321"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcEvidence.html#evVarsOfTerm"><span class="hs-identifier hs-var">evVarsOfTerm</span></a><span> </span><a href="#local-1628069764"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628069765"><span class="hs-identifier hs-var">needs</span></a><span>
</span><a name="line-1322"></a><span>
</span><a name="line-1323"></a><span>   </span><span class="hs-identifier">also_needs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span>
</span><a name="line-1324"></a><span>   </span><a name="local-1628069761"><a href="#local-1628069761"><span class="hs-identifier">also_needs</span></a></a><span> </span><a name="local-1628069766"><a href="#local-1628069766"><span class="hs-identifier">needs</span></a></a><span>
</span><a name="line-1325"></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#foldVarSet"><span class="hs-identifier hs-var">foldVarSet</span></a><span> </span><a href="#local-1628069767"><span class="hs-identifier hs-var">add</span></a><span> </span><a href="VarSet.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a><span> </span><a href="#local-1628069766"><span class="hs-identifier hs-var">needs</span></a><span>
</span><a name="line-1326"></a><span>     </span><span class="hs-keyword">where</span><span>
</span><a name="line-1327"></a><span>       </span><a name="local-1628069767"><a href="#local-1628069767"><span class="hs-identifier">add</span></a></a><span> </span><a name="local-1628069768"><a href="#local-1628069768"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-1628069769"><a href="#local-1628069769"><span class="hs-identifier">needs</span></a></a><span>
</span><a name="line-1328"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628069770"><a href="#local-1628069770"><span class="hs-identifier">ev_bind</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEvidence.html#lookupEvBind"><span class="hs-identifier hs-var">lookupEvBind</span></a><span> </span><a href="#local-1628069755"><span class="hs-identifier hs-var">ev_binds</span></a><span> </span><a href="#local-1628069768"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-1329"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="TcEvidence.html#EvBind"><span class="hs-identifier hs-var">EvBind</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">eb_is_given</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069771"><a href="#local-1628069771"><span class="hs-identifier">is_given</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">eb_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069772"><a href="#local-1628069772"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628069770"><span class="hs-identifier hs-var">ev_bind</span></a><span>
</span><a name="line-1330"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="#local-1628069771"><span class="hs-identifier hs-var">is_given</span></a><span>
</span><a name="line-1331"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="TcEvidence.html#evVarsOfTerm"><span class="hs-identifier hs-var">evVarsOfTerm</span></a><span> </span><a href="#local-1628069772"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628069769"><span class="hs-identifier hs-var">needs</span></a><span>
</span><a name="line-1332"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1333"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069769"><span class="hs-identifier hs-var">needs</span></a><span>
</span><a name="line-1334"></a><span>
</span><a name="line-1335"></a><span>   </span><span class="hs-identifier">add_bndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcEvidence.html#EvBind"><span class="hs-identifier hs-type">EvBind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span>
</span><a name="line-1336"></a><span>   </span><a name="local-1628069762"><a href="#local-1628069762"><span class="hs-identifier">add_bndr</span></a></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#EvBind"><span class="hs-identifier hs-var">EvBind</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">eb_lhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069773"><a href="#local-1628069773"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-1628069774"><a href="#local-1628069774"><span class="hs-identifier">vs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#extendVarSet"><span class="hs-identifier hs-var">extendVarSet</span></a><span> </span><a href="#local-1628069774"><span class="hs-identifier hs-var">vs</span></a><span> </span><a href="#local-1628069773"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-1337"></a><span>
</span><a name="line-1338"></a><span>
</span><a name="line-1339"></a><span class="hs-comment">{-
Note [Tracking redundant constraints]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
With Opt_WarnRedundantConstraints, GHC can report which
constraints of a type signature (or instance declaration) are
redundant, and can be omitted.  Here is an overview of how it
works:

----- What is a redundant constraint?

* The things that can be redundant are precisely the Given
  constraints of an implication.

* A constraint can be redundant in two different ways:
  a) It is implied by other givens.  E.g.
       f :: (Eq a, Ord a)     =&gt; blah   -- Eq a unnecessary
       g :: (Eq a, a~b, Eq b) =&gt; blah   -- Either Eq a or Eq b unnecessary
  b) It is not needed by the Wanted constraints covered by the
     implication E.g.
       f :: Eq a =&gt; a -&gt; Bool
       f x = True  -- Equality not used

*  To find (a), when we have two Given constraints,
   we must be careful to drop the one that is a naked variable (if poss).
   So if we have
       f :: (Eq a, Ord a) =&gt; blah
   then we may find [G] sc_sel (d1::Ord a) :: Eq a
                    [G] d2 :: Eq a
   We want to discard d2 in favour of the superclass selection from
   the Ord dictionary.  This is done by TcInteract.solveOneFromTheOther
   See Note [Replacement vs keeping].

* To find (b) we need to know which evidence bindings are 'wanted';
  hence the eb_is_given field on an EvBind.

----- How tracking works

* When the constraint solver finishes solving all the wanteds in
  an implication, it sets its status to IC_Solved

  - The ics_dead field, of IC_Solved, records the subset of this implication's
    ic_given that are redundant (not needed).

  - The ics_need field of IC_Solved then records all the
    in-scope (given) evidence variables bound by the context, that
    were needed to solve this implication, including all its nested
    implications.  (We remove the ic_given of this implication from
    the set, of course.)

* We compute which evidence variables are needed by an implication
  in setImplicationStatus.  A variable is needed if
    a) it is free in the RHS of a Wanted EvBind,
    b) it is free in the RHS of an EvBind whose LHS is needed,
    c) it is in the ics_need of a nested implication.
    d) it is listed in the tcs_used_tcvs field of the nested TcSEnv

* We need to be careful not to discard an implication
  prematurely, even one that is fully solved, because we might
  thereby forget which variables it needs, and hence wrongly
  report a constraint as redundant.  But we can discard it once
  its free vars have been incorporated into its parent; or if it
  simply has no free vars. This careful discarding is also
  handled in setImplicationStatus.

----- Reporting redundant constraints

* TcErrors does the actual warning, in warnRedundantConstraints.

* We don't report redundant givens for *every* implication; only
  for those which reply True to TcSimplify.warnRedundantGivens:

   - For example, in a class declaration, the default method *can*
     use the class constraint, but it certainly doesn't *have* to,
     and we don't want to report an error there.

   - More subtly, in a function definition
       f :: (Ord a, Ord a, Ix a) =&gt; a -&gt; a
       f x = rhs
     we do an ambiguity check on the type (which would find that one
     of the Ord a constraints was redundant), and then we check that
     the definition has that type (which might find that both are
     redundant).  We don't want to report the same error twice, so we
     disable it for the ambiguity check.  Hence using two different
     FunSigCtxts, one with the warn-redundant field set True, and the
     other set False in
        - TcBinds.tcSpecPrag
        - TcBinds.tcTySig

  This decision is taken in setImplicationStatus, rather than TcErrors
  so that we can discard implication constraints that we don't need.
  So ics_dead consists only of the *reportable* redundant givens.

----- Shortcomings

Consider (see Trac #9939)
    f2 :: (Eq a, Ord a) =&gt; a -&gt; a -&gt; Bool
    -- Ord a redundant, but Eq a is reported
    f2 x y = (x == y)

We report (Eq a) as redundant, whereas actually (Ord a) is.  But it's
really not easy to detect that!


Note [Cutting off simpl_loop]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It is very important not to iterate in simpl_loop unless there is a chance
of progress.  Trac #8474 is a classic example:

  * There's a deeply-nested chain of implication constraints.
       ?x:alpha =&gt; ?y1:beta1 =&gt; ... ?yn:betan =&gt; [W] ?x:Int

  * From the innermost one we get a [D] alpha ~ Int,
    but alpha is untouchable until we get out to the outermost one

  * We float [D] alpha~Int out (it is in floated_eqs), but since alpha
    is untouchable, the solveInteract in simpl_loop makes no progress

  * So there is no point in attempting to re-solve
       ?yn:betan =&gt; [W] ?x:Int
    via solveNestedImplications, because we'll just get the
    same [D] again

  * If we *do* re-solve, we'll get an ininite loop. It is cut off by
    the fixed bound of 10, but solving the next takes 10*10*...*10 (ie
    exponentially many) iterations!

Conclusion: we should call solveNestedImplications only if we did
some unifiction in solveSimpleWanteds; because that's the only way
we'll get more Givens (a unificaiton is like adding a Given) to
allow the implication to make progress.
-}</span><span>
</span><a name="line-1470"></a><span>
</span><a name="line-1471"></a><span class="hs-identifier">promoteTyVar</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#TcLevel"><span class="hs-identifier hs-type">TcLevel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1472"></a><span class="hs-comment">-- When we float a constraint out of an implication we must restore</span><span>
</span><a name="line-1473"></a><span class="hs-comment">-- invariant (MetaTvInv) in Note [TcLevel and untouchable type variables] in TcType</span><span>
</span><a name="line-1474"></a><span class="hs-comment">-- See Note [Promoting unification variables]</span><span>
</span><a name="line-1475"></a><a name="promoteTyVar"><a href="TcSimplify.html#promoteTyVar"><span class="hs-identifier">promoteTyVar</span></a></a><span> </span><a name="local-1628069775"><a href="#local-1628069775"><span class="hs-identifier">tclvl</span></a></a><span> </span><a name="local-1628069776"><a href="#local-1628069776"><span class="hs-identifier">tv</span></a></a><span>
</span><a name="line-1476"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TcType.html#isFloatedTouchableMetaTyVar"><span class="hs-identifier hs-var">isFloatedTouchableMetaTyVar</span></a><span> </span><a href="#local-1628069775"><span class="hs-identifier hs-var">tclvl</span></a><span> </span><a href="#local-1628069776"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-1477"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628069777"><a href="#local-1628069777"><span class="hs-identifier">cloned_tv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#cloneMetaTyVar"><span class="hs-identifier hs-var">TcM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">cloneMetaTyVar</span></a><span> </span><a href="#local-1628069776"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-1478"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628069778"><a href="#local-1628069778"><span class="hs-identifier">rhs_tv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcType.html#setMetaTyVarTcLevel"><span class="hs-identifier hs-var">setMetaTyVarTcLevel</span></a><span> </span><a href="#local-1628069777"><span class="hs-identifier hs-var">cloned_tv</span></a><span> </span><a href="#local-1628069775"><span class="hs-identifier hs-var">tclvl</span></a><span>
</span><a name="line-1479"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcMType.html#writeMetaTyVar"><span class="hs-identifier hs-var">TcM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">writeMetaTyVar</span></a><span> </span><a href="#local-1628069776"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a><span> </span><a href="#local-1628069778"><span class="hs-identifier hs-var">rhs_tv</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1480"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1481"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1482"></a><span>
</span><a name="line-1483"></a><span class="hs-identifier">promoteTyVarTcS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#TcLevel"><span class="hs-identifier hs-type">TcLevel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1484"></a><span class="hs-comment">-- When we float a constraint out of an implication we must restore</span><span>
</span><a name="line-1485"></a><span class="hs-comment">-- invariant (MetaTvInv) in Note [TcLevel and untouchable type variables] in TcType</span><span>
</span><a name="line-1486"></a><span class="hs-comment">-- See Note [Promoting unification variables]</span><span>
</span><a name="line-1487"></a><span class="hs-comment">-- We don't just call promoteTyVar because we want to use unifyTyVar,</span><span>
</span><a name="line-1488"></a><span class="hs-comment">-- not writeMetaTyVar</span><span>
</span><a name="line-1489"></a><a name="promoteTyVarTcS"><a href="TcSimplify.html#promoteTyVarTcS"><span class="hs-identifier">promoteTyVarTcS</span></a></a><span> </span><a name="local-1628069779"><a href="#local-1628069779"><span class="hs-identifier">tclvl</span></a></a><span> </span><a name="local-1628069780"><a href="#local-1628069780"><span class="hs-identifier">tv</span></a></a><span>
</span><a name="line-1490"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TcType.html#isFloatedTouchableMetaTyVar"><span class="hs-identifier hs-var">isFloatedTouchableMetaTyVar</span></a><span> </span><a href="#local-1628069779"><span class="hs-identifier hs-var">tclvl</span></a><span> </span><a href="#local-1628069780"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-1491"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628069781"><a href="#local-1628069781"><span class="hs-identifier">cloned_tv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#cloneMetaTyVar"><span class="hs-identifier hs-var">TcS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">cloneMetaTyVar</span></a><span> </span><a href="#local-1628069780"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-1492"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628069782"><a href="#local-1628069782"><span class="hs-identifier">rhs_tv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcType.html#setMetaTyVarTcLevel"><span class="hs-identifier hs-var">setMetaTyVarTcLevel</span></a><span> </span><a href="#local-1628069781"><span class="hs-identifier hs-var">cloned_tv</span></a><span> </span><a href="#local-1628069779"><span class="hs-identifier hs-var">tclvl</span></a><span>
</span><a name="line-1493"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#unifyTyVar"><span class="hs-identifier hs-var">unifyTyVar</span></a><span> </span><a href="#local-1628069780"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a><span> </span><a href="#local-1628069782"><span class="hs-identifier hs-var">rhs_tv</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1494"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1495"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1496"></a><span>
</span><a name="line-1497"></a><span class="hs-comment">-- | If the tyvar is a RuntimeRep var, set it to PtrRepLifted. Returns whether or</span><span>
</span><a name="line-1498"></a><span class="hs-comment">-- not this happened.</span><span>
</span><a name="line-1499"></a><span class="hs-identifier">defaultTyVar</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1500"></a><span class="hs-comment">-- Precondition: MetaTyVars only</span><span>
</span><a name="line-1501"></a><span class="hs-comment">-- See Note [DefaultTyVar]</span><span>
</span><a name="line-1502"></a><a name="defaultTyVar"><a href="TcSimplify.html#defaultTyVar"><span class="hs-identifier">defaultTyVar</span></a></a><span> </span><a name="local-1628069783"><a href="#local-1628069783"><span class="hs-identifier">the_tv</span></a></a><span>
</span><a name="line-1503"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TyCoRep.html#isRuntimeRepVar"><span class="hs-identifier hs-var">isRuntimeRepVar</span></a><span> </span><a href="#local-1628069783"><span class="hs-identifier hs-var">the_tv</span></a><span>
</span><a name="line-1504"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;defaultTyVar RuntimeRep&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069783"><span class="hs-identifier hs-var">the_tv</span></a><span class="hs-special">)</span><span>
</span><a name="line-1505"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcMType.html#writeMetaTyVar"><span class="hs-identifier hs-var">writeMetaTyVar</span></a><span> </span><a href="#local-1628069783"><span class="hs-identifier hs-var">the_tv</span></a><span> </span><a href="TysWiredIn.html#ptrRepLiftedTy"><span class="hs-identifier hs-var">ptrRepLiftedTy</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1506"></a><span>
</span><a name="line-1507"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- The common case</span><span>
</span><a name="line-1508"></a><span>
</span><a name="line-1509"></a><span class="hs-comment">-- | Like 'defaultTyVar', but in the TcS monad.</span><span>
</span><a name="line-1510"></a><span class="hs-identifier">defaultTyVarTcS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1511"></a><a name="defaultTyVarTcS"><a href="TcSimplify.html#defaultTyVarTcS"><span class="hs-identifier">defaultTyVarTcS</span></a></a><span> </span><a name="local-1628069784"><a href="#local-1628069784"><span class="hs-identifier">the_tv</span></a></a><span>
</span><a name="line-1512"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TyCoRep.html#isRuntimeRepVar"><span class="hs-identifier hs-var">isRuntimeRepVar</span></a><span> </span><a href="#local-1628069784"><span class="hs-identifier hs-var">the_tv</span></a><span>
</span><a name="line-1513"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;defaultTyVarTcS RuntimeRep&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069784"><span class="hs-identifier hs-var">the_tv</span></a><span class="hs-special">)</span><span>
</span><a name="line-1514"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#unifyTyVar"><span class="hs-identifier hs-var">unifyTyVar</span></a><span> </span><a href="#local-1628069784"><span class="hs-identifier hs-var">the_tv</span></a><span> </span><a href="TysWiredIn.html#ptrRepLiftedTy"><span class="hs-identifier hs-var">ptrRepLiftedTy</span></a><span>
</span><a name="line-1515"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1516"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1517"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-identifier hs-var">False</span><span>  </span><span class="hs-comment">-- the common case</span><span>
</span><a name="line-1518"></a><span>
</span><a name="line-1519"></a><span class="hs-identifier">approximateWC</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#Cts"><span class="hs-identifier hs-type">Cts</span></a><span>
</span><a name="line-1520"></a><span class="hs-comment">-- Postcondition: Wanted or Derived Cts</span><span>
</span><a name="line-1521"></a><span class="hs-comment">-- See Note [ApproximateWC]</span><span>
</span><a name="line-1522"></a><a name="approximateWC"><a href="TcSimplify.html#approximateWC"><span class="hs-identifier">approximateWC</span></a></a><span> </span><a name="local-1628069785"><a href="#local-1628069785"><span class="hs-identifier">wc</span></a></a><span>
</span><a name="line-1523"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069786"><span class="hs-identifier hs-var">float_wc</span></a><span> </span><a href="VarSet.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a><span> </span><a href="#local-1628069785"><span class="hs-identifier hs-var">wc</span></a><span>
</span><a name="line-1524"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1525"></a><span>    </span><span class="hs-identifier">float_wc</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#TcTyCoVarSet"><span class="hs-identifier hs-type">TcTyCoVarSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#Cts"><span class="hs-identifier hs-type">Cts</span></a><span>
</span><a name="line-1526"></a><span>    </span><a name="local-1628069786"><a href="#local-1628069786"><span class="hs-identifier">float_wc</span></a></a><span> </span><a name="local-1628069791"><a href="#local-1628069791"><span class="hs-identifier">trapping_tvs</span></a></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#WC"><span class="hs-identifier hs-var">WC</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wc_simple</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069792"><a href="#local-1628069792"><span class="hs-identifier">simples</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">wc_impl</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069793"><a href="#local-1628069793"><span class="hs-identifier">implics</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1527"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Bag.html#filterBag"><span class="hs-identifier hs-var">filterBag</span></a><span> </span><a href="#local-1628069794"><span class="hs-identifier hs-var">is_floatable</span></a><span> </span><a href="#local-1628069792"><span class="hs-identifier hs-var">simples</span></a><span> </span><span class="hs-special">`</span><a href="Bag.html#unionBags"><span class="hs-identifier hs-var">unionBags</span></a><span class="hs-special">`</span><span>
</span><a name="line-1528"></a><span>        </span><a href="#local-1628069788"><span class="hs-identifier hs-var">do_bag</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628069787"><span class="hs-identifier hs-var">float_implic</span></a><span> </span><a href="#local-1628069795"><span class="hs-identifier hs-var">new_trapping_tvs</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628069793"><span class="hs-identifier hs-var">implics</span></a><span>
</span><a name="line-1529"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1530"></a><span>        </span><a name="local-1628069794"><a href="#local-1628069794"><span class="hs-identifier">is_floatable</span></a></a><span> </span><a name="local-1628069798"><a href="#local-1628069798"><span class="hs-identifier">ct</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#tyCoVarsOfCt"><span class="hs-identifier hs-var">tyCoVarsOfCt</span></a><span> </span><a href="#local-1628069798"><span class="hs-identifier hs-var">ct</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#disjointVarSet"><span class="hs-identifier hs-var">disjointVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628069795"><span class="hs-identifier hs-var">new_trapping_tvs</span></a><span>
</span><a name="line-1531"></a><span>        </span><a name="local-1628069795"><a href="#local-1628069795"><span class="hs-identifier">new_trapping_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#transCloVarSet"><span class="hs-identifier hs-var">transCloVarSet</span></a><span> </span><a href="#local-1628069796"><span class="hs-identifier hs-var">grow</span></a><span> </span><a href="#local-1628069791"><span class="hs-identifier hs-var">trapping_tvs</span></a><span>
</span><a name="line-1532"></a><span>
</span><a name="line-1533"></a><span>        </span><span class="hs-identifier">grow</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span>  </span><span class="hs-comment">-- Maps current trapped tyvars to newly-trapped ones</span><span>
</span><a name="line-1534"></a><span>        </span><a name="local-1628069796"><a href="#local-1628069796"><span class="hs-identifier">grow</span></a></a><span> </span><a name="local-1628069799"><a href="#local-1628069799"><span class="hs-identifier">so_far</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Bag.html#foldrBag"><span class="hs-identifier hs-var">foldrBag</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628069797"><span class="hs-identifier hs-var">grow_one</span></a><span> </span><a href="#local-1628069799"><span class="hs-identifier hs-var">so_far</span></a><span class="hs-special">)</span><span> </span><a href="VarSet.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a><span> </span><a href="#local-1628069792"><span class="hs-identifier hs-var">simples</span></a><span>
</span><a name="line-1535"></a><span>        </span><a name="local-1628069797"><a href="#local-1628069797"><span class="hs-identifier">grow_one</span></a></a><span> </span><a name="local-1628069800"><a href="#local-1628069800"><span class="hs-identifier">so_far</span></a></a><span> </span><a name="local-1628069801"><a href="#local-1628069801"><span class="hs-identifier">ct</span></a></a><span> </span><a name="local-1628069802"><a href="#local-1628069802"><span class="hs-identifier">tvs</span></a></a><span>
</span><a name="line-1536"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628069803"><span class="hs-identifier hs-var">ct_tvs</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#intersectsVarSet"><span class="hs-identifier hs-var">intersectsVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628069800"><span class="hs-identifier hs-var">so_far</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069802"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628069803"><span class="hs-identifier hs-var">ct_tvs</span></a><span>
</span><a name="line-1537"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>                        </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069802"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-1538"></a><span>          </span><span class="hs-keyword">where</span><span>
</span><a name="line-1539"></a><span>            </span><a name="local-1628069803"><a href="#local-1628069803"><span class="hs-identifier">ct_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#tyCoVarsOfCt"><span class="hs-identifier hs-var">tyCoVarsOfCt</span></a><span> </span><a href="#local-1628069801"><span class="hs-identifier hs-var">ct</span></a><span>
</span><a name="line-1540"></a><span>
</span><a name="line-1541"></a><span>    </span><span class="hs-identifier">float_implic</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#TcTyCoVarSet"><span class="hs-identifier hs-type">TcTyCoVarSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#Implication"><span class="hs-identifier hs-type">Implication</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#Cts"><span class="hs-identifier hs-type">Cts</span></a><span>
</span><a name="line-1542"></a><span>    </span><a name="local-1628069787"><a href="#local-1628069787"><span class="hs-identifier">float_implic</span></a></a><span> </span><a name="local-1628069804"><a href="#local-1628069804"><span class="hs-identifier">trapping_tvs</span></a></a><span> </span><a name="local-1628069805"><a href="#local-1628069805"><span class="hs-identifier">imp</span></a></a><span>
</span><a name="line-1543"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">ic_no_eqs</span><span> </span><a href="#local-1628069805"><span class="hs-identifier hs-var">imp</span></a><span>                 </span><span class="hs-comment">-- No equalities, so float</span><span>
</span><a name="line-1544"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069786"><span class="hs-identifier hs-var">float_wc</span></a><span> </span><a href="#local-1628069806"><span class="hs-identifier hs-var">new_trapping_tvs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ic_wanted</span><span> </span><a href="#local-1628069805"><span class="hs-identifier hs-var">imp</span></a><span class="hs-special">)</span><span>
</span><a name="line-1545"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>                     </span><span class="hs-comment">-- Don't float out of equalities</span><span>
</span><a name="line-1546"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#emptyCts"><span class="hs-identifier hs-var">emptyCts</span></a><span>                      </span><span class="hs-comment">-- See Note [ApproximateWC]</span><span>
</span><a name="line-1547"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1548"></a><span>        </span><a name="local-1628069806"><a href="#local-1628069806"><span class="hs-identifier">new_trapping_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069804"><span class="hs-identifier hs-var">trapping_tvs</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#extendVarSetList"><span class="hs-identifier hs-var">extendVarSetList</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier">ic_skols</span><span> </span><a href="#local-1628069805"><span class="hs-identifier hs-var">imp</span></a><span>
</span><a name="line-1549"></a><span>    </span><span class="hs-identifier">do_bag</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-1628069789"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a><span> </span><a href="#local-1628069790"><span class="hs-identifier hs-type">c</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a><span> </span><a href="#local-1628069789"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a><span> </span><a href="#local-1628069790"><span class="hs-identifier hs-type">c</span></a><span>
</span><a name="line-1550"></a><span>    </span><a name="local-1628069788"><a href="#local-1628069788"><span class="hs-identifier">do_bag</span></a></a><span> </span><a name="local-1628069807"><a href="#local-1628069807"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Bag.html#foldrBag"><span class="hs-identifier hs-var">foldrBag</span></a><span> </span><span class="hs-special">(</span><a href="Bag.html#unionBags"><span class="hs-identifier hs-var">unionBags</span></a><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><a href="#local-1628069807"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span> </span><a href="Bag.html#emptyBag"><span class="hs-identifier hs-var">emptyBag</span></a><span>
</span><a name="line-1551"></a><span>
</span><a name="line-1552"></a><span class="hs-comment">{-
Note [ApproximateWC]
~~~~~~~~~~~~~~~~~~~~
approximateWC takes a constraint, typically arising from the RHS of a
let-binding whose type we are *inferring*, and extracts from it some
*simple* constraints that we might plausibly abstract over.  Of course
the top-level simple constraints are plausible, but we also float constraints
out from inside, if they are not captured by skolems.

The same function is used when doing type-class defaulting (see the call
to applyDefaultingRules) to extract constraints that that might be defaulted.

There are two caveats:

1.  We do *not* float anything out if the implication binds equality
    constraints, because that defeats the OutsideIn story.  Consider
       data T a where
         TInt :: T Int
         MkT :: T a

       f TInt = 3::Int

    We get the implication (a ~ Int =&gt; res ~ Int), where so far we've decided
      f :: T a -&gt; res
    We don't want to float (res~Int) out because then we'll infer
      f :: T a -&gt; Int
    which is only on of the possible types. (GHC 7.6 accidentally *did*
    float out of such implications, which meant it would happily infer
    non-principal types.)

2. We do not float out an inner constraint that shares a type variable
   (transitively) with one that is trapped by a skolem.  Eg
       forall a.  F a ~ beta, Integral beta
   We don't want to float out (Integral beta).  Doing so would be bad
   when defaulting, because then we'll default beta:=Integer, and that
   makes the error message much worse; we'd get
       Can't solve  F a ~ Integer
   rather than
       Can't solve  Integral (F a)

   Moreover, floating out these &quot;contaminated&quot; constraints doesn't help
   when generalising either. If we generalise over (Integral b), we still
   can't solve the retained implication (forall a. F a ~ b).  Indeed,
   arguably that too would be a harder error to understand.

Note [DefaultTyVar]
~~~~~~~~~~~~~~~~~~~
defaultTyVar is used on any un-instantiated meta type variables to
default any RuntimeRep variables to PtrRepLifted.  This is important
to ensure that instance declarations match.  For example consider

     instance Show (a-&gt;b)
     foo x = show (\_ -&gt; True)

Then we'll get a constraint (Show (p -&gt;q)) where p has kind (TYPE r),
and that won't match the typeKind (*) in the instance decl.  See tests
tc217 and tc175.

We look only at touchable type variables. No further constraints
are going to affect these type variables, so it's time to do it by
hand.  However we aren't ready to default them fully to () or
whatever, because the type-class defaulting rules have yet to run.

An alternate implementation would be to emit a derived constraint setting
the RuntimeRep variable to PtrRepLifted, but this seems unnecessarily indirect.

Note [Promote _and_ default when inferring]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When we are inferring a type, we simplify the constraint, and then use
approximateWC to produce a list of candidate constraints.  Then we MUST

  a) Promote any meta-tyvars that have been floated out by
     approximateWC, to restore invariant (MetaTvInv) described in
     Note [TcLevel and untouchable type variables] in TcType.

  b) Default the kind of any meta-tyyvars that are not mentioned in
     in the environment.

To see (b), suppose the constraint is (C ((a :: OpenKind) -&gt; Int)), and we
have an instance (C ((x:*) -&gt; Int)).  The instance doesn't match -- but it
should!  If we don't solve the constraint, we'll stupidly quantify over
(C (a-&gt;Int)) and, worse, in doing so zonkQuantifiedTyVar will quantify over
(b:*) instead of (a:OpenKind), which can lead to disaster; see Trac #7332.
Trac #7641 is a simpler example.

Note [Promoting unification variables]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When we float an equality out of an implication we must &quot;promote&quot; free
unification variables of the equality, in order to maintain Invariant
(MetaTvInv) from Note [TcLevel and untouchable type variables] in TcType.  for the
leftover implication.

This is absolutely necessary. Consider the following example. We start
with two implications and a class with a functional dependency.

    class C x y | x -&gt; y
    instance C [a] [a]

    (I1)      [untch=beta]forall b. 0 =&gt; F Int ~ [beta]
    (I2)      [untch=beta]forall c. 0 =&gt; F Int ~ [[alpha]] /\ C beta [c]

We float (F Int ~ [beta]) out of I1, and we float (F Int ~ [[alpha]]) out of I2.
They may react to yield that (beta := [alpha]) which can then be pushed inwards
the leftover of I2 to get (C [alpha] [a]) which, using the FunDep, will mean that
(alpha := a). In the end we will have the skolem 'b' escaping in the untouchable
beta! Concrete example is in indexed_types/should_fail/ExtraTcsUntch.hs:

    class C x y | x -&gt; y where
     op :: x -&gt; y -&gt; ()

    instance C [a] [a]

    type family F a :: *

    h :: F Int -&gt; ()
    h = undefined

    data TEx where
      TEx :: a -&gt; TEx

    f (x::beta) =
        let g1 :: forall b. b -&gt; ()
            g1 _ = h [x]
            g2 z = case z of TEx y -&gt; (h [[undefined]], op x [y])
        in (g1 '3', g2 undefined)


Note [Solving Family Equations]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
After we are done with simplification we may be left with constraints of the form:
     [Wanted] F xis ~ beta
If 'beta' is a touchable unification variable not already bound in the TyBinds
then we'd like to create a binding for it, effectively &quot;defaulting&quot; it to be 'F xis'.

When is it ok to do so?
    1) 'beta' must not already be defaulted to something. Example:

           [Wanted] F Int  ~ beta   &lt;~ Will default [beta := F Int]
           [Wanted] F Char ~ beta   &lt;~ Already defaulted, can't default again. We
                                       have to report this as unsolved.

    2) However, we must still do an occurs check when defaulting (F xis ~ beta), to
       set [beta := F xis] only if beta is not among the free variables of xis.

    3) Notice that 'beta' can't be bound in ty binds already because we rewrite RHS
       of type family equations. See Inert Set invariants in TcInteract.

This solving is now happening during zonking, see Note [Unflattening while zonking]
in TcMType.


*********************************************************************************
*                                                                               *
*                          Floating equalities                                  *
*                                                                               *
*********************************************************************************

Note [Float Equalities out of Implications]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
For ordinary pattern matches (including existentials) we float
equalities out of implications, for instance:
     data T where
       MkT :: Eq a =&gt; a -&gt; T
     f x y = case x of MkT _ -&gt; (y::Int)
We get the implication constraint (x::T) (y::alpha):
     forall a. [untouchable=alpha] Eq a =&gt; alpha ~ Int
We want to float out the equality into a scope where alpha is no
longer untouchable, to solve the implication!

But we cannot float equalities out of implications whose givens may
yield or contain equalities:

      data T a where
        T1 :: T Int
        T2 :: T Bool
        T3 :: T a

      h :: T a -&gt; a -&gt; Int

      f x y = case x of
                T1 -&gt; y::Int
                T2 -&gt; y::Bool
                T3 -&gt; h x y

We generate constraint, for (x::T alpha) and (y :: beta):
   [untouchables = beta] (alpha ~ Int =&gt; beta ~ Int)   -- From 1st branch
   [untouchables = beta] (alpha ~ Bool =&gt; beta ~ Bool) -- From 2nd branch
   (alpha ~ beta)                                      -- From 3rd branch

If we float the equality (beta ~ Int) outside of the first implication and
the equality (beta ~ Bool) out of the second we get an insoluble constraint.
But if we just leave them inside the implications, we unify alpha := beta and
solve everything.

Principle:
    We do not want to float equalities out which may
    need the given *evidence* to become soluble.

Consequence: classes with functional dependencies don't matter (since there is
no evidence for a fundep equality), but equality superclasses do matter (since
they carry evidence).
-}</span><span>
</span><a name="line-1754"></a><span>
</span><a name="line-1755"></a><span class="hs-identifier">floatEqualities</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TcType.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1756"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a><span>
</span><a name="line-1757"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#Cts"><span class="hs-identifier hs-type">Cts</span></a><span class="hs-special">,</span><span> </span><a href="TcRnTypes.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a><span class="hs-special">)</span><span>
</span><a name="line-1758"></a><span class="hs-comment">-- Main idea: see Note [Float Equalities out of Implications]</span><span>
</span><a name="line-1759"></a><span class="hs-comment">--</span><span>
</span><a name="line-1760"></a><span class="hs-comment">-- Precondition: the wc_simple of the incoming WantedConstraints are</span><span>
</span><a name="line-1761"></a><span class="hs-comment">--               fully zonked, so that we can see their free variables</span><span>
</span><a name="line-1762"></a><span class="hs-comment">--</span><span>
</span><a name="line-1763"></a><span class="hs-comment">-- Postcondition: The returned floated constraints (Cts) are only</span><span>
</span><a name="line-1764"></a><span class="hs-comment">--                Wanted or Derived</span><span>
</span><a name="line-1765"></a><span class="hs-comment">--</span><span>
</span><a name="line-1766"></a><span class="hs-comment">-- Also performs some unifications (via promoteTyVar), adding to</span><span>
</span><a name="line-1767"></a><span class="hs-comment">-- monadically-carried ty_binds. These will be used when processing</span><span>
</span><a name="line-1768"></a><span class="hs-comment">-- floated_eqs later</span><span>
</span><a name="line-1769"></a><span class="hs-comment">--</span><span>
</span><a name="line-1770"></a><span class="hs-comment">-- Subtleties: Note [Float equalities from under a skolem binding]</span><span>
</span><a name="line-1771"></a><span class="hs-comment">--             Note [Skolem escape]</span><span>
</span><a name="line-1772"></a><a name="floatEqualities"><a href="TcSimplify.html#floatEqualities"><span class="hs-identifier">floatEqualities</span></a></a><span> </span><a name="local-1628069808"><a href="#local-1628069808"><span class="hs-identifier">skols</span></a></a><span> </span><a name="local-1628069809"><a href="#local-1628069809"><span class="hs-identifier">no_given_eqs</span></a></a><span>
</span><a name="line-1773"></a><span>                </span><a name="local-1628069810"><a href="#local-1628069810"><span class="hs-identifier">wanteds</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TcRnTypes.html#WC"><span class="hs-identifier hs-var">WC</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wc_simple</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628069811"><a href="#local-1628069811"><span class="hs-identifier">simples</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1774"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-1628069809"><span class="hs-identifier hs-var">no_given_eqs</span></a><span>  </span><span class="hs-comment">-- There are some given equalities, so don't float</span><span>
</span><a name="line-1775"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="Bag.html#emptyBag"><span class="hs-identifier hs-var">emptyBag</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628069810"><span class="hs-identifier hs-var">wanteds</span></a><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- Note [Float Equalities out of Implications]</span><span>
</span><a name="line-1776"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1777"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628069815"><a href="#local-1628069815"><span class="hs-identifier">outer_tclvl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getTcLevel"><span class="hs-identifier hs-var">TcS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">getTcLevel</span></a><span>
</span><a name="line-1778"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><span class="hs-special">(</span><a href="TcSimplify.html#promoteTyVarTcS"><span class="hs-identifier hs-var">promoteTyVarTcS</span></a><span> </span><a href="#local-1628069815"><span class="hs-identifier hs-var">outer_tclvl</span></a><span class="hs-special">)</span><span>
</span><a name="line-1779"></a><span>               </span><span class="hs-special">(</span><a href="TcRnTypes.html#tyCoVarsOfCtsList"><span class="hs-identifier hs-var">tyCoVarsOfCtsList</span></a><span> </span><a href="#local-1628069813"><span class="hs-identifier hs-var">float_eqs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1780"></a><span>           </span><span class="hs-comment">-- See Note [Promoting unification variables]</span><span>
</span><a name="line-1781"></a><span>
</span><a name="line-1782"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;floatEqualities&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Skols =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069808"><span class="hs-identifier hs-var">skols</span></a><span>
</span><a name="line-1783"></a><span>                                          </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Simples =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069811"><span class="hs-identifier hs-var">simples</span></a><span>
</span><a name="line-1784"></a><span>                                          </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Floated eqs =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069813"><span class="hs-identifier hs-var">float_eqs</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1785"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="#local-1628069813"><span class="hs-identifier hs-var">float_eqs</span></a><span>
</span><a name="line-1786"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="#local-1628069810"><span class="hs-identifier hs-var">wanteds</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wc_simple</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069814"><span class="hs-identifier hs-var">remaining_simples</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1787"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1788"></a><span>    </span><a name="local-1628069812"><a href="#local-1628069812"><span class="hs-identifier">skol_set</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a><span> </span><a href="#local-1628069808"><span class="hs-identifier hs-var">skols</span></a><span>
</span><a name="line-1789"></a><span>    </span><span class="hs-special">(</span><a name="local-1628069813"><a href="#local-1628069813"><span class="hs-identifier">float_eqs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628069814"><a href="#local-1628069814"><span class="hs-identifier">remaining_simples</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Bag.html#partitionBag"><span class="hs-identifier hs-var">partitionBag</span></a><span> </span><span class="hs-special">(</span><a href="TcSimplify.html#usefulToFloat"><span class="hs-identifier hs-var">usefulToFloat</span></a><span> </span><a href="#local-1628069812"><span class="hs-identifier hs-var">skol_set</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628069811"><span class="hs-identifier hs-var">simples</span></a><span>
</span><a name="line-1790"></a><span>
</span><a name="line-1791"></a><span class="hs-identifier">usefulToFloat</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1792"></a><a name="usefulToFloat"><a href="TcSimplify.html#usefulToFloat"><span class="hs-identifier">usefulToFloat</span></a></a><span> </span><a name="local-1628069816"><a href="#local-1628069816"><span class="hs-identifier">skol_set</span></a></a><span> </span><a name="local-1628069817"><a href="#local-1628069817"><span class="hs-identifier">ct</span></a></a><span>   </span><span class="hs-comment">-- The constraint is un-flattened and de-canonicalised</span><span>
</span><a name="line-1793"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069819"><span class="hs-identifier hs-var">is_meta_var_eq</span></a><span> </span><a href="#local-1628069818"><span class="hs-identifier hs-var">pred</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-1794"></a><span>    </span><span class="hs-special">(</span><a href="TyCoRep.html#tyCoVarsOfType"><span class="hs-identifier hs-var">tyCoVarsOfType</span></a><span> </span><a href="#local-1628069818"><span class="hs-identifier hs-var">pred</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#disjointVarSet"><span class="hs-identifier hs-var">disjointVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628069816"><span class="hs-identifier hs-var">skol_set</span></a><span class="hs-special">)</span><span>
</span><a name="line-1795"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1796"></a><span>    </span><a name="local-1628069818"><a href="#local-1628069818"><span class="hs-identifier">pred</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#ctPred"><span class="hs-identifier hs-var">ctPred</span></a><span> </span><a href="#local-1628069817"><span class="hs-identifier hs-var">ct</span></a><span>
</span><a name="line-1797"></a><span>
</span><a name="line-1798"></a><span>      </span><span class="hs-comment">-- Float out alpha ~ ty, or ty ~ alpha</span><span>
</span><a name="line-1799"></a><span>      </span><span class="hs-comment">-- which might be unified outside</span><span>
</span><a name="line-1800"></a><span>      </span><span class="hs-comment">-- See Note [Which equalities to float]</span><span>
</span><a name="line-1801"></a><span>    </span><a name="local-1628069819"><a href="#local-1628069819"><span class="hs-identifier">is_meta_var_eq</span></a></a><span> </span><a name="local-1628069821"><a href="#local-1628069821"><span class="hs-identifier">pred</span></a></a><span>
</span><a name="line-1802"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="Type.html#EqPred"><span class="hs-identifier hs-var">EqPred</span></a><span> </span><a href="Type.html#NomEq"><span class="hs-identifier hs-var">NomEq</span></a><span> </span><a name="local-1628069822"><a href="#local-1628069822"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-1628069823"><a href="#local-1628069823"><span class="hs-identifier">ty2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#classifyPredType"><span class="hs-identifier hs-var">classifyPredType</span></a><span> </span><a href="#local-1628069821"><span class="hs-identifier hs-var">pred</span></a><span>
</span><a name="line-1803"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="TcType.html#tcGetTyVar_maybe"><span class="hs-identifier hs-var">tcGetTyVar_maybe</span></a><span> </span><a href="#local-1628069822"><span class="hs-identifier hs-var">ty1</span></a><span class="hs-special">,</span><span> </span><a href="TcType.html#tcGetTyVar_maybe"><span class="hs-identifier hs-var">tcGetTyVar_maybe</span></a><span> </span><a href="#local-1628069823"><span class="hs-identifier hs-var">ty2</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1804"></a><span>          </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628069824"><a href="#local-1628069824"><span class="hs-identifier">tv1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628069820"><span class="hs-identifier hs-var">float_tv_eq</span></a><span> </span><a href="#local-1628069824"><span class="hs-identifier hs-var">tv1</span></a><span> </span><a href="#local-1628069823"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1805"></a><span>          </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628069825"><a href="#local-1628069825"><span class="hs-identifier">tv2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628069820"><span class="hs-identifier hs-var">float_tv_eq</span></a><span> </span><a href="#local-1628069825"><span class="hs-identifier hs-var">tv2</span></a><span> </span><a href="#local-1628069822"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-1806"></a><span>          </span><span class="hs-identifier">_</span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1807"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1808"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1809"></a><span>
</span><a name="line-1810"></a><span>    </span><a name="local-1628069820"><a href="#local-1628069820"><span class="hs-identifier">float_tv_eq</span></a></a><span> </span><a name="local-1628069826"><a href="#local-1628069826"><span class="hs-identifier">tv1</span></a></a><span> </span><a name="local-1628069827"><a href="#local-1628069827"><span class="hs-identifier">ty2</span></a></a><span>  </span><span class="hs-comment">-- See Note [Which equalities to float]</span><span>
</span><a name="line-1811"></a><span>      </span><span class="hs-glyph">=</span><span>  </span><a href="TcType.html#isMetaTyVar"><span class="hs-identifier hs-var">isMetaTyVar</span></a><span> </span><a href="#local-1628069826"><span class="hs-identifier hs-var">tv1</span></a><span>
</span><a name="line-1812"></a><span>      </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="TcType.html#isSigTyVar"><span class="hs-identifier hs-var">isSigTyVar</span></a><span> </span><a href="#local-1628069826"><span class="hs-identifier hs-var">tv1</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="Type.html#isTyVarTy"><span class="hs-identifier hs-var">isTyVarTy</span></a><span> </span><a href="#local-1628069827"><span class="hs-identifier hs-var">ty2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1813"></a><span>
</span><a name="line-1814"></a><span class="hs-comment">{- Note [Float equalities from under a skolem binding]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Which of the simple equalities can we float out?  Obviously, only
ones that don't mention the skolem-bound variables.  But that is
over-eager. Consider
   [2] forall a. F a beta[1] ~ gamma[2], G beta[1] gamma[2] ~ Int
The second constraint doesn't mention 'a'.  But if we float it,
we'll promote gamma[2] to gamma'[1].  Now suppose that we learn that
beta := Bool, and F a Bool = a, and G Bool _ = Int.  Then we'll
we left with the constraint
   [2] forall a. a ~ gamma'[1]
which is insoluble because gamma became untouchable.

Solution: float only constraints that stand a jolly good chance of
being soluble simply by being floated, namely ones of form
      a ~ ty
where 'a' is a currently-untouchable unification variable, but may
become touchable by being floated (perhaps by more than one level).

We had a very complicated rule previously, but this is nice and
simple.  (To see the notes, look at this Note in a version of
TcSimplify prior to Oct 2014).

Note [Which equalities to float]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Which equalities should we float?  We want to float ones where there
is a decent chance that floating outwards will allow unification to
happen.  In particular:

   Float out equalities of form (alpaha ~ ty) or (ty ~ alpha), where

   * alpha is a meta-tyvar.

   * And 'alpha' is not a SigTv with 'ty' being a non-tyvar.  In that
     case, floating out won't help either, and it may affect grouping
     of error messages.

Note [Skolem escape]
~~~~~~~~~~~~~~~~~~~~
You might worry about skolem escape with all this floating.
For example, consider
    [2] forall a. (a ~ F beta[2] delta,
                   Maybe beta[2] ~ gamma[1])

The (Maybe beta ~ gamma) doesn't mention 'a', so we float it, and
solve with gamma := beta. But what if later delta:=Int, and
  F b Int = b.
Then we'd get a ~ beta[2], and solve to get beta:=a, and now the
skolem has escaped!

But it's ok: when we float (Maybe beta[2] ~ gamma[1]), we promote beta[2]
to beta[1], and that means the (a ~ beta[1]) will be stuck, as it should be.


*********************************************************************************
*                                                                               *
*                          Defaulting and disamgiguation                        *
*                                                                               *
*********************************************************************************
-}</span><span>
</span><a name="line-1874"></a><span>
</span><a name="line-1875"></a><span class="hs-identifier">applyDefaultingRules</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1876"></a><span class="hs-comment">-- True &lt;=&gt; I did some defaulting, by unifying a meta-tyvar</span><span>
</span><a name="line-1877"></a><span class="hs-comment">-- Imput WantedConstraints are not necessarily zonked</span><span>
</span><a name="line-1878"></a><span>
</span><a name="line-1879"></a><a name="applyDefaultingRules"><a href="TcSimplify.html#applyDefaultingRules"><span class="hs-identifier">applyDefaultingRules</span></a></a><span> </span><a name="local-1628069828"><a href="#local-1628069828"><span class="hs-identifier">wanteds</span></a></a><span>
</span><a name="line-1880"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TcRnTypes.html#isEmptyWC"><span class="hs-identifier hs-var">isEmptyWC</span></a><span> </span><a href="#local-1628069828"><span class="hs-identifier hs-var">wanteds</span></a><span>
</span><a name="line-1881"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1882"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1883"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628069829"><a href="#local-1628069829"><span class="hs-identifier">info</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-1628069830"><a href="#local-1628069830"><span class="hs-identifier">default_tys</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getDefaultInfo"><span class="hs-identifier hs-var">getDefaultInfo</span></a><span>
</span><a name="line-1884"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628069831"><a href="#local-1628069831"><span class="hs-identifier">wanteds</span></a></a><span>               </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#zonkWC"><span class="hs-identifier hs-var">TcS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">zonkWC</span></a><span> </span><a href="#local-1628069828"><span class="hs-identifier hs-var">wanteds</span></a><span>
</span><a name="line-1885"></a><span>
</span><a name="line-1886"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628069832"><a href="#local-1628069832"><span class="hs-identifier">groups</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSimplify.html#findDefaultableGroups"><span class="hs-identifier hs-var">findDefaultableGroups</span></a><span> </span><a href="#local-1628069829"><span class="hs-identifier hs-var">info</span></a><span> </span><a href="#local-1628069831"><span class="hs-identifier hs-var">wanteds</span></a><span>
</span><a name="line-1887"></a><span>
</span><a name="line-1888"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;applyDefaultingRules {&quot;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1889"></a><span>                  </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;wanteds =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069831"><span class="hs-identifier hs-var">wanteds</span></a><span>
</span><a name="line-1890"></a><span>                       </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;groups  =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069832"><span class="hs-identifier hs-var">groups</span></a><span>
</span><a name="line-1891"></a><span>                       </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;info    =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069829"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1892"></a><span>
</span><a name="line-1893"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628069833"><a href="#local-1628069833"><span class="hs-identifier">something_happeneds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><span class="hs-special">(</span><a href="TcSimplify.html#disambigGroup"><span class="hs-identifier hs-var">disambigGroup</span></a><span> </span><a href="#local-1628069830"><span class="hs-identifier hs-var">default_tys</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628069832"><span class="hs-identifier hs-var">groups</span></a><span>
</span><a name="line-1894"></a><span>
</span><a name="line-1895"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;applyDefaultingRules }&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069833"><span class="hs-identifier hs-var">something_happeneds</span></a><span class="hs-special">)</span><span>
</span><a name="line-1896"></a><span>
</span><a name="line-1897"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#or"><span class="hs-identifier hs-var">or</span></a><span> </span><a href="#local-1628069833"><span class="hs-identifier hs-var">something_happeneds</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1898"></a><span>
</span><a name="line-1899"></a><span class="hs-identifier">findDefaultableGroups</span><span>
</span><a name="line-1900"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>
</span><a name="line-1901"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>     </span><span class="hs-comment">-- (Overloaded strings, extended default rules)</span><span>
</span><a name="line-1902"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a><span>   </span><span class="hs-comment">-- Unsolved (wanted or derived)</span><span>
</span><a name="line-1903"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1904"></a><a name="findDefaultableGroups"><a href="TcSimplify.html#findDefaultableGroups"><span class="hs-identifier">findDefaultableGroups</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1628069834"><a href="#local-1628069834"><span class="hs-identifier">default_tys</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-1628069835"><a href="#local-1628069835"><span class="hs-identifier">ovl_strings</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628069836"><a href="#local-1628069836"><span class="hs-identifier">extended_defaults</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-1628069837"><a href="#local-1628069837"><span class="hs-identifier">wanteds</span></a></a><span>
</span><a name="line-1905"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1628069834"><span class="hs-identifier hs-var">default_tys</span></a><span>
</span><a name="line-1906"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1907"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1908"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-1628069866"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="Util.html#fstOf3"><span class="hs-identifier hs-var">fstOf3</span></a><span> </span><a href="#local-1628069865"><span class="hs-identifier hs-var">group</span></a><span class="hs-special">)</span><span>
</span><a name="line-1909"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="local-1628069865"><a href="#local-1628069865"><span class="hs-identifier">group</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-1628069866"><a href="#local-1628069866"><span class="hs-identifier">tv</span></a></a><span class="hs-special">)</span><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628069841"><span class="hs-identifier hs-var">unary_groups</span></a><span>
</span><a name="line-1910"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="#local-1628069845"><span class="hs-identifier hs-var">defaultable_tyvar</span></a><span> </span><a href="#local-1628069866"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-1911"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="#local-1628069846"><span class="hs-identifier hs-var">defaultable_classes</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="Util.html#sndOf3"><span class="hs-identifier hs-var">sndOf3</span></a><span> </span><a href="#local-1628069865"><span class="hs-identifier hs-var">group</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1912"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1913"></a><span>    </span><a name="local-1628069838"><a href="#local-1628069838"><span class="hs-identifier">simples</span></a></a><span>                </span><span class="hs-glyph">=</span><span> </span><a href="TcSimplify.html#approximateWC"><span class="hs-identifier hs-var">approximateWC</span></a><span> </span><a href="#local-1628069837"><span class="hs-identifier hs-var">wanteds</span></a><span>
</span><a name="line-1914"></a><span>    </span><span class="hs-special">(</span><a name="local-1628069839"><a href="#local-1628069839"><span class="hs-identifier">unaries</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628069840"><a href="#local-1628069840"><span class="hs-identifier">non_unaries</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#partitionWith"><span class="hs-identifier hs-var">partitionWith</span></a><span> </span><a href="#local-1628069842"><span class="hs-identifier hs-var">find_unary</span></a><span> </span><span class="hs-special">(</span><a href="Bag.html#bagToList"><span class="hs-identifier hs-var">bagToList</span></a><span> </span><a href="#local-1628069838"><span class="hs-identifier hs-var">simples</span></a><span class="hs-special">)</span><span>
</span><a name="line-1915"></a><span>    </span><a name="local-1628069841"><a href="#local-1628069841"><span class="hs-identifier">unary_groups</span></a></a><span>           </span><span class="hs-glyph">=</span><span> </span><a href="ListSetOps.html#equivClasses"><span class="hs-identifier hs-var">equivClasses</span></a><span> </span><a href="#local-1628069844"><span class="hs-identifier hs-var">cmp_tv</span></a><span> </span><a href="#local-1628069839"><span class="hs-identifier hs-var">unaries</span></a><span>
</span><a name="line-1916"></a><span>
</span><a name="line-1917"></a><span>    </span><span class="hs-identifier">unary_groups</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-special">(</span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span class="hs-special">,</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span class="hs-special">,</span><span> </span><a href="TcType.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- (C tv) constraints</span><span>
</span><a name="line-1918"></a><span>    </span><span class="hs-identifier">unaries</span><span>      </span><span class="hs-glyph">::</span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span class="hs-special">,</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span class="hs-special">,</span><span> </span><a href="TcType.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- (C tv) constraints</span><span>
</span><a name="line-1919"></a><span>    </span><span class="hs-identifier">non_unaries</span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span class="hs-special">]</span><span>                      </span><span class="hs-comment">-- and *other* constraints</span><span>
</span><a name="line-1920"></a><span>
</span><a name="line-1921"></a><span>        </span><span class="hs-comment">-- Finds unary type-class constraints</span><span>
</span><a name="line-1922"></a><span>        </span><span class="hs-comment">-- But take account of polykinded classes like Typeable,</span><span>
</span><a name="line-1923"></a><span>        </span><span class="hs-comment">-- which may look like (Typeable * (a:*))   (Trac #8931)</span><span>
</span><a name="line-1924"></a><span>    </span><a name="local-1628069842"><a href="#local-1628069842"><span class="hs-identifier">find_unary</span></a></a><span> </span><a name="local-1628069850"><a href="#local-1628069850"><span class="hs-identifier">cc</span></a></a><span>
</span><a name="line-1925"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1628069851"><a href="#local-1628069851"><span class="hs-identifier">cls</span></a></a><span class="hs-special">,</span><a name="local-1628069852"><a href="#local-1628069852"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#getClassPredTys_maybe"><span class="hs-identifier hs-var">getClassPredTys_maybe</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#ctPred"><span class="hs-identifier hs-var">ctPred</span></a><span> </span><a href="#local-1628069850"><span class="hs-identifier hs-var">cc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1926"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a name="local-1628069853"><a href="#local-1628069853"><span class="hs-identifier">ty</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#filterOutInvisibleTypes"><span class="hs-identifier hs-var">filterOutInvisibleTypes</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">classTyCon</span><span> </span><a href="#local-1628069851"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628069852"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1927"></a><span>              </span><span class="hs-comment">-- Ignore invisible arguments for this purpose</span><span>
</span><a name="line-1928"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628069854"><a href="#local-1628069854"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcType.html#tcGetTyVar_maybe"><span class="hs-identifier hs-var">tcGetTyVar_maybe</span></a><span> </span><a href="#local-1628069853"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1929"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="TcType.html#isMetaTyVar"><span class="hs-identifier hs-var">isMetaTyVar</span></a><span> </span><a href="#local-1628069854"><span class="hs-identifier hs-var">tv</span></a><span>  </span><span class="hs-comment">-- We might have runtime-skolems in GHCi, and</span><span>
</span><a name="line-1930"></a><span>                          </span><span class="hs-comment">-- we definitely don't want to try to assign to those!</span><span>
</span><a name="line-1931"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Either.html#Left"><span class="hs-identifier hs-var">Left</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628069850"><span class="hs-identifier hs-var">cc</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628069851"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628069854"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span>
</span><a name="line-1932"></a><span>    </span><span class="hs-identifier">find_unary</span><span> </span><a name="local-1628069855"><a href="#local-1628069855"><span class="hs-identifier">cc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Either.html#Right"><span class="hs-identifier hs-var">Right</span></a><span> </span><a href="#local-1628069855"><span class="hs-identifier hs-var">cc</span></a><span>  </span><span class="hs-comment">-- Non unary or non dictionary</span><span>
</span><a name="line-1933"></a><span>
</span><a name="line-1934"></a><span>    </span><span class="hs-identifier">bad_tvs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#TcTyCoVarSet"><span class="hs-identifier hs-type">TcTyCoVarSet</span></a><span>  </span><span class="hs-comment">-- TyVars mentioned by non-unaries</span><span>
</span><a name="line-1935"></a><span>    </span><a name="local-1628069843"><a href="#local-1628069843"><span class="hs-identifier">bad_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#mapUnionVarSet"><span class="hs-identifier hs-var">mapUnionVarSet</span></a><span> </span><a href="TcRnTypes.html#tyCoVarsOfCt"><span class="hs-identifier hs-var">tyCoVarsOfCt</span></a><span> </span><a href="#local-1628069840"><span class="hs-identifier hs-var">non_unaries</span></a><span>
</span><a name="line-1936"></a><span>
</span><a name="line-1937"></a><span>    </span><a name="local-1628069844"><a href="#local-1628069844"><span class="hs-identifier">cmp_tv</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-1628069856"><a href="#local-1628069856"><span class="hs-identifier">tv1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-1628069857"><a href="#local-1628069857"><span class="hs-identifier">tv2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069856"><span class="hs-identifier hs-var">tv1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">compare</span><span class="hs-special">`</span><span> </span><a href="#local-1628069857"><span class="hs-identifier hs-var">tv2</span></a><span>
</span><a name="line-1938"></a><span>
</span><a name="line-1939"></a><span>    </span><a name="local-1628069845"><a href="#local-1628069845"><span class="hs-identifier">defaultable_tyvar</span></a></a><span> </span><a name="local-1628069858"><a href="#local-1628069858"><span class="hs-identifier">tv</span></a></a><span>
</span><a name="line-1940"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628069859"><a href="#local-1628069859"><span class="hs-identifier">b1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcType.html#isTyConableTyVar"><span class="hs-identifier hs-var">isTyConableTyVar</span></a><span> </span><a href="#local-1628069858"><span class="hs-identifier hs-var">tv</span></a><span>  </span><span class="hs-comment">-- Note [Avoiding spurious errors]</span><span>
</span><a name="line-1941"></a><span>              </span><a name="local-1628069860"><a href="#local-1628069860"><span class="hs-identifier">b2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-1628069858"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#elemVarSet"><span class="hs-identifier hs-var">elemVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628069843"><span class="hs-identifier hs-var">bad_tvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1942"></a><span>          </span><span class="hs-keyword">in</span><span> </span><a href="#local-1628069859"><span class="hs-identifier hs-var">b1</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-1628069860"><span class="hs-identifier hs-var">b2</span></a><span>
</span><a name="line-1943"></a><span>
</span><a name="line-1944"></a><span>    </span><a name="local-1628069846"><a href="#local-1628069846"><span class="hs-identifier">defaultable_classes</span></a></a><span> </span><a name="local-1628069861"><a href="#local-1628069861"><span class="hs-identifier">clss</span></a></a><span>
</span><a name="line-1945"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628069836"><span class="hs-identifier hs-var">extended_defaults</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#any"><span class="hs-identifier hs-var">any</span></a><span> </span><a href="#local-1628069847"><span class="hs-identifier hs-var">isInteractiveClass</span></a><span> </span><a href="#local-1628069861"><span class="hs-identifier hs-var">clss</span></a><span>
</span><a name="line-1946"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a><span> </span><a href="#local-1628069849"><span class="hs-identifier hs-var">is_std_class</span></a><span> </span><a href="#local-1628069861"><span class="hs-identifier hs-var">clss</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#any"><span class="hs-identifier hs-var">any</span></a><span> </span><a href="#local-1628069848"><span class="hs-identifier hs-var">is_num_class</span></a><span> </span><a href="#local-1628069861"><span class="hs-identifier hs-var">clss</span></a><span class="hs-special">)</span><span>
</span><a name="line-1947"></a><span>
</span><a name="line-1948"></a><span>    </span><span class="hs-comment">-- In interactive mode, or with -XExtendedDefaultRules,</span><span>
</span><a name="line-1949"></a><span>    </span><span class="hs-comment">-- we default Show a to Show () to avoid graututious errors on &quot;show []&quot;</span><span>
</span><a name="line-1950"></a><span>    </span><a name="local-1628069847"><a href="#local-1628069847"><span class="hs-identifier">isInteractiveClass</span></a></a><span> </span><a name="local-1628069862"><a href="#local-1628069862"><span class="hs-identifier">cls</span></a></a><span>
</span><a name="line-1951"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069848"><span class="hs-identifier hs-var">is_num_class</span></a><span> </span><a href="#local-1628069862"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">classKey</span><span> </span><a href="#local-1628069862"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-special">`</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#elem"><span class="hs-identifier hs-var">elem</span></a><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><a href="PrelNames.html#showClassKey"><span class="hs-identifier hs-var">showClassKey</span></a><span class="hs-special">,</span><span> </span><a href="PrelNames.html#eqClassKey"><span class="hs-identifier hs-var">eqClassKey</span></a><span>
</span><a name="line-1952"></a><span>                                                   </span><span class="hs-special">,</span><span> </span><a href="PrelNames.html#ordClassKey"><span class="hs-identifier hs-var">ordClassKey</span></a><span class="hs-special">,</span><span> </span><a href="PrelNames.html#foldableClassKey"><span class="hs-identifier hs-var">foldableClassKey</span></a><span>
</span><a name="line-1953"></a><span>                                                   </span><span class="hs-special">,</span><span> </span><a href="PrelNames.html#traversableClassKey"><span class="hs-identifier hs-var">traversableClassKey</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1954"></a><span>
</span><a name="line-1955"></a><span>    </span><a name="local-1628069848"><a href="#local-1628069848"><span class="hs-identifier">is_num_class</span></a></a><span> </span><a name="local-1628069863"><a href="#local-1628069863"><span class="hs-identifier">cls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="PrelInfo.html#isNumericClass"><span class="hs-identifier hs-var">isNumericClass</span></a><span> </span><a href="#local-1628069863"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-special">(</span><a href="#local-1628069835"><span class="hs-identifier hs-var">ovl_strings</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-special">(</span><a href="#local-1628069863"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-special">`</span><a href="Unique.html#hasKey"><span class="hs-identifier hs-var">hasKey</span></a><span class="hs-special">`</span><span> </span><a href="PrelNames.html#isStringClassKey"><span class="hs-identifier hs-var">isStringClassKey</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1956"></a><span>    </span><span class="hs-comment">-- is_num_class adds IsString to the standard numeric classes,</span><span>
</span><a name="line-1957"></a><span>    </span><span class="hs-comment">-- when -foverloaded-strings is enabled</span><span>
</span><a name="line-1958"></a><span>
</span><a name="line-1959"></a><span>    </span><a name="local-1628069849"><a href="#local-1628069849"><span class="hs-identifier">is_std_class</span></a></a><span> </span><a name="local-1628069864"><a href="#local-1628069864"><span class="hs-identifier">cls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="PrelInfo.html#isStandardClass"><span class="hs-identifier hs-var">isStandardClass</span></a><span> </span><a href="#local-1628069864"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-special">(</span><a href="#local-1628069835"><span class="hs-identifier hs-var">ovl_strings</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-special">(</span><a href="#local-1628069864"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-special">`</span><a href="Unique.html#hasKey"><span class="hs-identifier hs-var">hasKey</span></a><span class="hs-special">`</span><span> </span><a href="PrelNames.html#isStringClassKey"><span class="hs-identifier hs-var">isStringClassKey</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1960"></a><span>    </span><span class="hs-comment">-- Similarly is_std_class</span><span>
</span><a name="line-1961"></a><span>
</span><a name="line-1962"></a><span class="hs-comment">------------------------------</span><span>
</span><a name="line-1963"></a><span class="hs-identifier">disambigGroup</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>            </span><span class="hs-comment">-- The default types</span><span>
</span><a name="line-1964"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="TcType.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- All classes of the form (C a)</span><span>
</span><a name="line-1965"></a><span>                                   </span><span class="hs-comment">--  sharing same type variable</span><span>
</span><a name="line-1966"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>   </span><span class="hs-comment">-- True &lt;=&gt; something happened, reflected in ty_binds</span><span>
</span><a name="line-1967"></a><span>
</span><a name="line-1968"></a><a name="disambigGroup"><a href="TcSimplify.html#disambigGroup"><span class="hs-identifier">disambigGroup</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-1969"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1970"></a><span class="hs-identifier">disambigGroup</span><span> </span><span class="hs-special">(</span><a name="local-1628069867"><a href="#local-1628069867"><span class="hs-identifier">default_ty</span></a></a><span class="hs-glyph">:</span><a name="local-1628069868"><a href="#local-1628069868"><span class="hs-identifier">default_tys</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1628069869"><a href="#local-1628069869"><span class="hs-identifier">group</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-1628069870"><a href="#local-1628069870"><span class="hs-identifier">the_tv</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628069871"><a href="#local-1628069871"><span class="hs-identifier">wanteds</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1971"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;disambigGroup {&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069867"><span class="hs-identifier hs-var">default_ty</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069870"><span class="hs-identifier hs-var">the_tv</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069871"><span class="hs-identifier hs-var">wanteds</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1972"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628069879"><a href="#local-1628069879"><span class="hs-identifier">fake_ev_binds_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#newTcEvBinds"><span class="hs-identifier hs-var">TcS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">newTcEvBinds</span></a><span>
</span><a name="line-1973"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628069880"><a href="#local-1628069880"><span class="hs-identifier">tclvl</span></a></a><span>             </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getTcLevel"><span class="hs-identifier hs-var">TcS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">getTcLevel</span></a><span>
</span><a name="line-1974"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628069881"><a href="#local-1628069881"><span class="hs-identifier">success</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#nestImplicTcS"><span class="hs-identifier hs-var">nestImplicTcS</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-1628069879"><span class="hs-identifier hs-var">fake_ev_binds_var</span></a><span class="hs-special">)</span><span> </span><a href="VarSet.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a><span>
</span><a name="line-1975"></a><span>                                       </span><span class="hs-special">(</span><a href="TcType.html#pushTcLevel"><span class="hs-identifier hs-var">pushTcLevel</span></a><span> </span><a href="#local-1628069880"><span class="hs-identifier hs-var">tclvl</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628069872"><span class="hs-identifier hs-var">try_group</span></a><span>
</span><a name="line-1976"></a><span>
</span><a name="line-1977"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-1628069881"><span class="hs-identifier hs-var">success</span></a><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-1978"></a><span>             </span><span class="hs-comment">-- Success: record the type variable binding, and return</span><span>
</span><a name="line-1979"></a><span>             </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#unifyTyVar"><span class="hs-identifier hs-var">unifyTyVar</span></a><span> </span><a href="#local-1628069870"><span class="hs-identifier hs-var">the_tv</span></a><span> </span><a href="#local-1628069867"><span class="hs-identifier hs-var">default_ty</span></a><span>
</span><a name="line-1980"></a><span>                </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#wrapWarnTcS"><span class="hs-identifier hs-var">wrapWarnTcS</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcErrors.html#warnDefaulting"><span class="hs-identifier hs-var">warnDefaulting</span></a><span> </span><a href="#local-1628069871"><span class="hs-identifier hs-var">wanteds</span></a><span> </span><a href="#local-1628069867"><span class="hs-identifier hs-var">default_ty</span></a><span>
</span><a name="line-1981"></a><span>                </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;disambigGroup succeeded }&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069867"><span class="hs-identifier hs-var">default_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1982"></a><span>                </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1983"></a><span>         </span><span class="hs-keyword">else</span><span>
</span><a name="line-1984"></a><span>             </span><span class="hs-comment">-- Failure: try with the next type</span><span>
</span><a name="line-1985"></a><span>             </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;disambigGroup failed, will try other default types }&quot;</span><span>
</span><a name="line-1986"></a><span>                           </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628069867"><span class="hs-identifier hs-var">default_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1987"></a><span>                </span><span class="hs-special">;</span><span> </span><a href="TcSimplify.html#disambigGroup"><span class="hs-identifier hs-var">disambigGroup</span></a><span> </span><a href="#local-1628069868"><span class="hs-identifier hs-var">default_tys</span></a><span> </span><a href="#local-1628069869"><span class="hs-identifier hs-var">group</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1988"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1989"></a><span>    </span><a name="local-1628069872"><a href="#local-1628069872"><span class="hs-identifier">try_group</span></a></a><span>
</span><a name="line-1990"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628069875"><a href="#local-1628069875"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628069874"><span class="hs-identifier hs-var">mb_subst</span></a><span>
</span><a name="line-1991"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628069876"><a href="#local-1628069876"><span class="hs-identifier">lcl_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getLclEnv"><span class="hs-identifier hs-var">TcS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">getLclEnv</span></a><span>
</span><a name="line-1992"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628069877"><a href="#local-1628069877"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#CtLoc"><span class="hs-identifier hs-var">CtLoc</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctl_origin</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#GivenOrigin"><span class="hs-identifier hs-var">GivenOrigin</span></a><span> </span><a href="TcRnTypes.html#UnkSkol"><span class="hs-identifier hs-var">UnkSkol</span></a><span>
</span><a name="line-1993"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ctl_env</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628069876"><span class="hs-identifier hs-var">lcl_env</span></a><span>
</span><a name="line-1994"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ctl_t_or_k</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-1995"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ctl_depth</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#initialSubGoalDepth"><span class="hs-identifier hs-var">initialSubGoalDepth</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1996"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-1628069878"><a href="#local-1628069878"><span class="hs-identifier">wanted_evs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#newWantedEvVarNC"><span class="hs-identifier hs-var">newWantedEvVarNC</span></a><span> </span><a href="#local-1628069877"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="TyCoRep.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><a href="#local-1628069875"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="TcRnTypes.html#ctPred"><span class="hs-identifier hs-var">ctPred</span></a><span class="hs-special">)</span><span>
</span><a name="line-1997"></a><span>                                </span><a href="#local-1628069871"><span class="hs-identifier hs-var">wanteds</span></a><span>
</span><a name="line-1998"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a><span> </span><a href="TcRnTypes.html#isEmptyWC"><span class="hs-identifier hs-var">isEmptyWC</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1999"></a><span>             </span><a href="TcInteract.html#solveSimpleWanteds"><span class="hs-identifier hs-var">solveSimpleWanteds</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Bag.html#listToBag"><span class="hs-identifier hs-var">listToBag</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-2000"></a><span>             </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="TcRnTypes.html#mkNonCanonical"><span class="hs-identifier hs-var">mkNonCanonical</span></a><span> </span><a href="#local-1628069878"><span class="hs-identifier hs-var">wanted_evs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2001"></a><span>
</span><a name="line-2002"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-2003"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-2004"></a><span>
</span><a name="line-2005"></a><span>    </span><a name="local-1628069873"><a href="#local-1628069873"><span class="hs-identifier">the_ty</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a><span> </span><a href="#local-1628069870"><span class="hs-identifier hs-var">the_tv</span></a><span>
</span><a name="line-2006"></a><span>    </span><a name="local-1628069874"><a href="#local-1628069874"><span class="hs-identifier">mb_subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Unify.html#tcMatchTy"><span class="hs-identifier hs-var">tcMatchTy</span></a><span> </span><a href="#local-1628069873"><span class="hs-identifier hs-var">the_ty</span></a><span> </span><a href="#local-1628069867"><span class="hs-identifier hs-var">default_ty</span></a><span>
</span><a name="line-2007"></a><span>      </span><span class="hs-comment">-- Make sure the kinds match too; hence this call to tcMatchTy</span><span>
</span><a name="line-2008"></a><span>      </span><span class="hs-comment">-- E.g. suppose the only constraint was (Typeable k (a::k))</span><span>
</span><a name="line-2009"></a><span>      </span><span class="hs-comment">-- With the addition of polykinded defaulting we also want to reject</span><span>
</span><a name="line-2010"></a><span>      </span><span class="hs-comment">-- ill-kinded defaulting attempts like (Eq []) or (Foldable Int) here.</span><span>
</span><a name="line-2011"></a><span>
</span><a name="line-2012"></a><span>
</span><a name="line-2013"></a><span class="hs-comment">{-
Note [Avoiding spurious errors]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When doing the unification for defaulting, we check for skolem
type variables, and simply don't default them.  For example:
   f = (*)      -- Monomorphic
   g :: Num a =&gt; a -&gt; a
   g x = f x x
Here, we get a complaint when checking the type signature for g,
that g isn't polymorphic enough; but then we get another one when
dealing with the (Num a) context arising from f's definition;
we try to unify a with Int (to default it), but find that it's
already been unified with the rigid variable from g's type sig.
-}</span><span>
</span><a name="line-2027"></a></pre></body></html>